<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Enigma-game-svn] r926 - in trunk: data data/gfx32 data/gfx40	data/gfx48 src src/lev src/stones
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/enigma-game-svn/2007-November/index.html" >
   <LINK REL="made" HREF="mailto:enigma-game-svn%40lists.berlios.de?Subject=Re%3A%20%5BEnigma-game-svn%5D%20r926%20-%20in%20trunk%3A%20data%20data/gfx32%20data/gfx40%0A%09data/gfx48%20src%20src/lev%20src/stones&In-Reply-To=%3C200711181645.lAIGjEAv015711%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000357.html">
   <LINK REL="Next"  HREF="000359.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Enigma-game-svn] r926 - in trunk: data data/gfx32 data/gfx40	data/gfx48 src src/lev src/stones</H1>
    <B>ral at BerliOS</B> 
    <A HREF="mailto:enigma-game-svn%40lists.berlios.de?Subject=Re%3A%20%5BEnigma-game-svn%5D%20r926%20-%20in%20trunk%3A%20data%20data/gfx32%20data/gfx40%0A%09data/gfx48%20src%20src/lev%20src/stones&In-Reply-To=%3C200711181645.lAIGjEAv015711%40sheep.berlios.de%3E"
       TITLE="[Enigma-game-svn] r926 - in trunk: data data/gfx32 data/gfx40	data/gfx48 src src/lev src/stones">ral at mail.berlios.de
       </A><BR>
    <I>Sun Nov 18 17:45:14 CET 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000357.html">[Enigma-game-svn] r925 - in trunk: data/levels/enigma_cross	data/levels/enigma_v doc/reference src
</A></li>
        <LI>Next message: <A HREF="000359.html">[Enigma-game-svn] r927 - in homepage: . input input/news
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#358">[ date ]</a>
              <a href="thread.html#358">[ thread ]</a>
              <a href="subject.html#358">[ subject ]</a>
              <a href="author.html#358">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: ral
Date: 2007-11-18 17:45:12 +0100 (Sun, 18 Nov 2007)
New Revision: 926

Added:
   trunk/data/gfx32/st-oxydbtempl_0096.png
   trunk/data/gfx32/st-oxydbtempl_0097.png
   trunk/data/gfx32/st-oxydbtempl_0101.png
   trunk/data/gfx32/st-oxydbtempl_0102.png
   trunk/data/gfx32/st-oxydbtempl_0103.png
   trunk/data/gfx32/st-oxydbtempl_0104.png
   trunk/data/gfx32/st-oxydbtempl_0111.png
   trunk/data/gfx32/st-oxydbtempl_0112.png
   trunk/data/gfx32/st-oxydbtempl_0113.png
   trunk/data/gfx32/st-oxydbtempl_0114.png
   trunk/data/gfx32/st-oxydbtempl_0115.png
   trunk/data/gfx32/st-oxydbtempl_0116.png
   trunk/data/gfx32/st-oxydbtempl_0117.png
   trunk/data/gfx32/st-oxydbtempl_0118.png
   trunk/data/gfx40/st-oxydbtempl_0096.png
   trunk/data/gfx40/st-oxydbtempl_0097.png
   trunk/data/gfx40/st-oxydbtempl_0101.png
   trunk/data/gfx40/st-oxydbtempl_0102.png
   trunk/data/gfx40/st-oxydbtempl_0103.png
   trunk/data/gfx40/st-oxydbtempl_0104.png
   trunk/data/gfx40/st-oxydbtempl_0111.png
   trunk/data/gfx40/st-oxydbtempl_0112.png
   trunk/data/gfx40/st-oxydbtempl_0113.png
   trunk/data/gfx40/st-oxydbtempl_0114.png
   trunk/data/gfx40/st-oxydbtempl_0115.png
   trunk/data/gfx40/st-oxydbtempl_0116.png
   trunk/data/gfx40/st-oxydbtempl_0117.png
   trunk/data/gfx40/st-oxydbtempl_0118.png
   trunk/data/gfx48/st-oxydbtempl_0096.png
   trunk/data/gfx48/st-oxydbtempl_0097.png
   trunk/data/gfx48/st-oxydbtempl_0101.png
   trunk/data/gfx48/st-oxydbtempl_0102.png
   trunk/data/gfx48/st-oxydbtempl_0103.png
   trunk/data/gfx48/st-oxydbtempl_0104.png
   trunk/data/gfx48/st-oxydbtempl_0111.png
   trunk/data/gfx48/st-oxydbtempl_0112.png
   trunk/data/gfx48/st-oxydbtempl_0113.png
   trunk/data/gfx48/st-oxydbtempl_0114.png
   trunk/data/gfx48/st-oxydbtempl_0115.png
   trunk/data/gfx48/st-oxydbtempl_0116.png
   trunk/data/gfx48/st-oxydbtempl_0117.png
   trunk/data/gfx48/st-oxydbtempl_0118.png
Modified:
   trunk/data/models-2d.lua
   trunk/data/models.lua
   trunk/src/lev/Proxy.cc
   trunk/src/server.cc
   trunk/src/server.hh
   trunk/src/stones/OxydStone.cc
   trunk/src/stones/OxydStone.hh
Log:
Trunk 1.1: Fair Oxyd Distribution
- full support of pseudo oxyds (fair and simple shuffle)
- full support of noshuffle attribute (fair and simple shuffle)
- log limited to test and experimental levels


Added: trunk/data/gfx32/st-oxydbtempl_0096.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx32/st-oxydbtempl_0096.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx32/st-oxydbtempl_0097.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx32/st-oxydbtempl_0097.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx32/st-oxydbtempl_0101.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx32/st-oxydbtempl_0101.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx32/st-oxydbtempl_0102.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx32/st-oxydbtempl_0102.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx32/st-oxydbtempl_0103.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx32/st-oxydbtempl_0103.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx32/st-oxydbtempl_0104.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx32/st-oxydbtempl_0104.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx32/st-oxydbtempl_0111.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx32/st-oxydbtempl_0111.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx32/st-oxydbtempl_0112.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx32/st-oxydbtempl_0112.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx32/st-oxydbtempl_0113.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx32/st-oxydbtempl_0113.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx32/st-oxydbtempl_0114.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx32/st-oxydbtempl_0114.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx32/st-oxydbtempl_0115.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx32/st-oxydbtempl_0115.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx32/st-oxydbtempl_0116.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx32/st-oxydbtempl_0116.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx32/st-oxydbtempl_0117.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx32/st-oxydbtempl_0117.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx32/st-oxydbtempl_0118.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx32/st-oxydbtempl_0118.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx40/st-oxydbtempl_0096.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx40/st-oxydbtempl_0096.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx40/st-oxydbtempl_0097.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx40/st-oxydbtempl_0097.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx40/st-oxydbtempl_0101.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx40/st-oxydbtempl_0101.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx40/st-oxydbtempl_0102.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx40/st-oxydbtempl_0102.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx40/st-oxydbtempl_0103.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx40/st-oxydbtempl_0103.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx40/st-oxydbtempl_0104.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx40/st-oxydbtempl_0104.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx40/st-oxydbtempl_0111.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx40/st-oxydbtempl_0111.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx40/st-oxydbtempl_0112.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx40/st-oxydbtempl_0112.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx40/st-oxydbtempl_0113.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx40/st-oxydbtempl_0113.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx40/st-oxydbtempl_0114.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx40/st-oxydbtempl_0114.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx40/st-oxydbtempl_0115.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx40/st-oxydbtempl_0115.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx40/st-oxydbtempl_0116.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx40/st-oxydbtempl_0116.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx40/st-oxydbtempl_0117.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx40/st-oxydbtempl_0117.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx40/st-oxydbtempl_0118.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx40/st-oxydbtempl_0118.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx48/st-oxydbtempl_0096.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx48/st-oxydbtempl_0096.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx48/st-oxydbtempl_0097.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx48/st-oxydbtempl_0097.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx48/st-oxydbtempl_0101.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx48/st-oxydbtempl_0101.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx48/st-oxydbtempl_0102.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx48/st-oxydbtempl_0102.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx48/st-oxydbtempl_0103.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx48/st-oxydbtempl_0103.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx48/st-oxydbtempl_0104.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx48/st-oxydbtempl_0104.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx48/st-oxydbtempl_0111.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx48/st-oxydbtempl_0111.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx48/st-oxydbtempl_0112.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx48/st-oxydbtempl_0112.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx48/st-oxydbtempl_0113.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx48/st-oxydbtempl_0113.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx48/st-oxydbtempl_0114.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx48/st-oxydbtempl_0114.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx48/st-oxydbtempl_0115.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx48/st-oxydbtempl_0115.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx48/st-oxydbtempl_0116.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx48/st-oxydbtempl_0116.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx48/st-oxydbtempl_0117.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx48/st-oxydbtempl_0117.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx48/st-oxydbtempl_0118.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx48/st-oxydbtempl_0118.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Modified: trunk/data/models-2d.lua
===================================================================
--- trunk/data/models-2d.lua	2007-11-15 20:42:53 UTC (rev 925)
+++ trunk/data/models-2d.lua	2007-11-18 16:45:12 UTC (rev 926)
@@ -890,8 +890,8 @@
         -- activated laser
         names = {}
         for i=1,table.getn(laseron) do
-	        names[i] = &quot;st-laseron&quot;..dir .. format(&quot;_%04d&quot;, i)
-	        DefOverlay (names[i], {&quot;st-laser-base&quot;, laseron[i]})
+                names[i] = &quot;st-laseron&quot;..dir .. format(&quot;_%04d&quot;, i)
+                DefOverlay (names[i], {&quot;st-laser-base&quot;, laseron[i]})
         end
         frames = BuildFrames(names, 100)
         DefAnim(&quot;st-laseron-anim&quot;..dir, frames, 1)
@@ -1066,14 +1066,14 @@
 -- st-switch, st-switch_black, st-switch_white --
 do
     function mkswitch(modelname, basename)
-    	local n = DefSubimages(modelname, {h=3, modelname=basename..&quot;-fg&quot;})
-    	local f = BuildFrames(n, 60)
-    	DefRoundStone(modelname..&quot;-off&quot;, n[1])
-    	DefRoundStone(modelname..&quot;-on&quot;, n[3])
-      	DefAnim(basename..&quot;-turnon&quot;, f)
-	    DefAnim(basename..&quot;-turnoff&quot;, ReverseFrames(f))
-	    DefRoundStone(modelname..&quot;-turnon&quot;, basename..&quot;-turnon&quot;)
-	    DefRoundStone(modelname..&quot;-turnoff&quot;, basename..&quot;-turnoff&quot;)
+        local n = DefSubimages(modelname, {h=3, modelname=basename..&quot;-fg&quot;})
+        local f = BuildFrames(n, 60)
+        DefRoundStone(modelname..&quot;-off&quot;, n[1])
+        DefRoundStone(modelname..&quot;-on&quot;, n[3])
+        DefAnim(basename..&quot;-turnon&quot;, f)
+            DefAnim(basename..&quot;-turnoff&quot;, ReverseFrames(f))
+            DefRoundStone(modelname..&quot;-turnon&quot;, basename..&quot;-turnon&quot;)
+            DefRoundStone(modelname..&quot;-turnoff&quot;, basename..&quot;-turnoff&quot;)
     end
     mkswitch(&quot;st-switch&quot;, &quot;switch&quot;)
     mkswitch(&quot;st-switch_black&quot;, &quot;switch_black&quot;)
@@ -1220,8 +1220,13 @@
 
 do
     local colorspots = FrameNames(&quot;st-oxydbtempl&quot;, 2,9)
+    AddFrameNames(colorspots, &quot;st-oxydbtempl&quot;, 96,97)
     local openovls = FrameNames(&quot;st-oxydbtempl&quot;, 10,14)
+    local pseudospots = {}
+    pseudospots[-3] = FrameNames(&quot;st-oxydbtempl&quot;, 101,104)
+    pseudospots[-4] = FrameNames(&quot;st-oxydbtempl&quot;, 111,118)
 
+
 -- Define &quot;fading in&quot; and &quot;fading out&quot; animations for oxyd stones.
 -- These two animations are combined with the stone images to
 -- produce the opening and closing animations for oxyd stones.
@@ -1255,8 +1260,15 @@
         local n = &quot;st-oxyd&quot; .. flavor .. color
         local fadein = &quot;oxyd&quot;..flavor..&quot;-fadein&quot;
         local fadeout= &quot;oxyd&quot;..flavor..&quot;-fadeout&quot;
+        local spotcolor = color
+        
+        if (color &gt;= 0) then
+            spotcolor = color + 1   -- oxyd color 0..7, file 2..9, frames 1..8
+        else
+            spotcolor = 100 + color -- pseudo colors
+        end
 
-        DefOverlay(n..&quot;-base&quot;, {baseimg[flavor], colorspots[color+1]})
+        DefOverlay(n..&quot;-base&quot;, {baseimg[flavor], colorspots[spotcolor]})
         display.DefineComposite(n..&quot;-opening-fg&quot;, n..&quot;-base&quot;, fadein)
         display.DefineComposite(n..&quot;-closing-fg&quot;, n..&quot;-base&quot;, fadeout)
         DefShModel (n..&quot;-opening&quot;, n..&quot;-opening-fg&quot;, shadow[flavor])
@@ -1290,6 +1302,28 @@
         DefShModel(n, n..&quot;-anim&quot;, shadow[flavor])
     end
 
+    function mkpseudo(flavor, color)
+        local n = &quot;st-oxyd&quot; .. flavor .. &quot;-pseudo&quot; .. color
+        local names = {}
+
+        for i=1, table.getn(pseudospots[color]) do
+            local images={baseimg[flavor],pseudospots[color][i]}
+            names[i] = n .. format(&quot;_%04d&quot;, i)
+            DefOverlay(names[i], images)
+        end
+
+        -- compose these images into an animation
+        if (color == -3) then
+            frames = RepeatAnim(PingPong(BuildFrames(names, 50)),2)
+        elseif (color == -4) then
+            frames = RepeatAnim(BuildFrames(names, 100),2)
+        end
+        DefAnim(n..&quot;-anim&quot;, frames, false)
+
+        -- and finally add a shadow to make the model complete
+        DefShModel(n, n..&quot;-anim&quot;, shadow[flavor])
+    end
+
     function mkoxyd(flavor)
         DefStone(&quot;st-oxyd&quot;..flavor, shadow[flavor])
         DefShModel(&quot;st-likeoxyd&quot;..flavor, &quot;st-oxyd&quot;..flavor, shadow[flavor])
@@ -1307,6 +1341,10 @@
             mkblink(flavor, color)
             mkopened(flavor, color)
         end
+        mkopenclose(flavor, -3)
+        mkpseudo(flavor, -3)
+        mkopenclose(flavor, -4)
+        mkpseudo(flavor, -4)
     end
     mkoxyd(&quot;a&quot;)
     mkoxyd(&quot;b&quot;)
@@ -1480,7 +1518,7 @@
 --
 -- naming scheme for mirror models:
 --
---	st-{3mirror,pmirror}-{m,s}{o,t}[1234]
+--      st-{3mirror,pmirror}-{m,s}{o,t}[1234]
 --
 -- {m,s} -&gt; movable or static
 -- {o,t} -&gt; opaque or transparent
@@ -1488,16 +1526,16 @@
 -- The numbers map to actual orientations as follows:
 --
 --   NUMBER    TRIANG.M.   PLANE M.
---	1	south	  &quot;v&quot;        &quot;-&quot;
---	2	west	  &quot;&lt;&quot;        &quot;\&quot;
---	3	north	  &quot;^&quot;        &quot;|&quot;
---	4	east	  &quot;&gt;&quot;        &quot;/&quot;
+--      1       south     &quot;v&quot;        &quot;-&quot;
+--      2       west      &quot;&lt;&quot;        &quot;\&quot;
+--      3       north     &quot;^&quot;        &quot;|&quot;
+--      4       east      &quot;&gt;&quot;        &quot;/&quot;
 do
     function make_mirror(basename, baseimg, overlays)
         for i=1,4 do
-	        mname = basename .. i
-	        DefOverlay (mname .. &quot;-ovl&quot;, {baseimg, overlays[i]})
-	        DefShModel(mname, mname .. &quot;-ovl&quot;, &quot;sh-round2&quot;)
+                mname = basename .. i
+                DefOverlay (mname .. &quot;-ovl&quot;, {baseimg, overlays[i]})
+                DefShModel(mname, mname .. &quot;-ovl&quot;, &quot;sh-round2&quot;)
         end
     end
 

Modified: trunk/data/models.lua
===================================================================
--- trunk/data/models.lua	2007-11-15 20:42:53 UTC (rev 925)
+++ trunk/data/models.lua	2007-11-18 16:45:12 UTC (rev 926)
@@ -177,6 +177,12 @@
     return fn
 end
 
+function AddFrameNames(fn, prefix, first, last)
+    for i=first,last do
+	    table.insert(fn, i, prefix .. format(&quot;_%04d&quot;, i))
+    end
+end
+
 -- Build a list of frames from a list of model names and a constant
 -- duration.
 function BuildFrames(names, msec)

Modified: trunk/src/lev/Proxy.cc
===================================================================
--- trunk/src/lev/Proxy.cc	2007-11-15 20:42:53 UTC (rev 925)
+++ trunk/src/lev/Proxy.cc	2007-11-18 16:45:12 UTC (rev 926)
@@ -617,6 +617,7 @@
         if (this == currentLevel) {    // just level - no libs
             server::SetCompatibility(this);
             server::EnigmaCompatibility = getEnigmaCompatibility();
+            server::LevelStatus = getLevelStatus();
         }
         processDependencies();
         loadLuaCode();

Modified: trunk/src/server.cc
===================================================================
--- trunk/src/server.cc	2007-11-15 20:42:53 UTC (rev 925)
+++ trunk/src/server.cc	2007-11-18 16:45:12 UTC (rev 926)
@@ -95,6 +95,7 @@
 double   server::FrictionFactor;
 double   server::HoleForce;
 double   server::IceFriction;
+lev::levelStatusType   server::LevelStatus; // no Lua access
 double   server::MagnetForce;
 double   server::MagnetRange;
 double   server::SlopeForce;

Modified: trunk/src/server.hh
===================================================================
--- trunk/src/server.hh	2007-11-15 20:42:53 UTC (rev 925)
+++ trunk/src/server.hh	2007-11-18 16:45:12 UTC (rev 926)
@@ -74,6 +74,9 @@
     // level compatibility
     extern double   EnigmaCompatibility;
    
+    // level compatibility
+    extern lev::levelStatusType   LevelStatus;
+   
     // Default brittleness of the floor: 0 = stable..1=unstable.
     // Really: probability that a floor tile will crack when an actor
     // enters or leaves it.

Modified: trunk/src/stones/OxydStone.cc
===================================================================
--- trunk/src/stones/OxydStone.cc	2007-11-15 20:42:53 UTC (rev 925)
+++ trunk/src/stones/OxydStone.cc	2007-11-18 16:45:12 UTC (rev 926)
@@ -23,10 +23,12 @@
 #include &quot;main.hh&quot;
 #include &quot;server.hh&quot;
 #include &quot;world.hh&quot;
+#include &quot;lev/Proxy.hh&quot;
 
 namespace enigma {
  
     OxydStone::InstanceVector OxydStone::levelOxyds;
+    bool OxydStone::isInit = false;
     std::vector&lt;unsigned short&gt; OxydStone::colorsUsageCount;
     unsigned short OxydStone::shuffledFakeCount;
     unsigned short OxydStone::shuffledFartCount;
@@ -61,6 +63,8 @@
         
         base.rulesLimit.push_back(limit);
         
+        ASSERT(groupsMembers[r.groupId1] != 0, XLevelRuntime, &quot;Oxyd shuffle rule for an empty group&quot;);
+        
         switch (type) {
             case RULE_SINGLE_MIN:
                 singleRulesMin.push_back(r);
@@ -69,9 +73,11 @@
                 singleRulesMax.push_back(r);
                 break;
             case RULE_PAIR_MIN:
+                ASSERT(groupsMembers[r.groupId2] != 0, XLevelRuntime, &quot;Oxyd shuffle rule for an empty group&quot;);
                 pairRulesMin.push_back(r);
                 break;
             case RULE_PAIR_MAX:
+                ASSERT(groupsMembers[r.groupId2] != 0, XLevelRuntime, &quot;Oxyd shuffle rule for an empty group&quot;);
                 pairRulesMax.push_back(r);
                 break;
         }
@@ -102,7 +108,7 @@
     }
     
     void OxydStone::initColors() {
-        if (colorsUsageCount.size() != 0)
+        if (isInit)
             return;  // we are already initialized!
             
         unsigned short numColors = numColorsAvailable();
@@ -118,7 +124,7 @@
         // count color usage
         for (size_t i=0; i&lt;isize; ++i) {
             int color = levelOxyds[i]-&gt;getAttr(&quot;color&quot;);
-            bool declineShuffle = levelOxyds[i]-&gt;getAttr(&quot;noshuffle&quot;);
+            bool declineShuffle = to_bool(levelOxyds[i]-&gt;getAttr(&quot;noshuffle&quot;));
             if (color &gt;= 0 &amp;&amp; color &lt; numColors) {
                 colorsUsageCount[color]++;
                 if (declineShuffle) colorsUsageCountNoShuffle[color]++;
@@ -148,9 +154,11 @@
                     autocoloredOxyds.back()-&gt;set_attrib(&quot;color&quot;, i);
                     autocoloredOxyds.pop_back();
                     colorsUsageCount[i]++;
-                } else {
+                } else if (onlyPairs) {
                     onlyPairs = false;
                     break;
+                } else {
+                    ASSERT(false, XLevelRuntime, &quot;Oxyd init colors - too many unpaired oxyds with given color&quot;);
                 }
             }
             if (colorsUsageCountNoShuffle[i] % 2 == 1) {
@@ -179,7 +187,11 @@
             lastObject-&gt;set_attrib(&quot;color&quot;, FAKE);
             colorsUsageCount[lastColor]--;
             shuffledFakeCount++;
+        } else {
+            ASSERT(onlyPairs, XLevelRuntime, &quot;Oxyd init colors - too many unpaired oxyds with given color&quot;);
         }
+        
+        isInit = true;
     }
     
     void OxydStone::shuffleColors(LogType logFlag) {
@@ -201,24 +213,24 @@
     }
     
     void OxydStone::simpleShuffleColors() {
-        // TODO support for noshuffle and pseudo
         
-        std::vector&lt;size_t&gt; closed_oxyds;
+        std::vector&lt;size_t&gt; closedOxyds;
         size_t  isize = levelOxyds.size();
         for (size_t i=0; i&lt;isize; ++i) {
-            if (levelOxyds[i]-&gt;animState == CLOSED) {
-                closed_oxyds.push_back(i);
+            OxydStone *candidate = levelOxyds[i];
+            if (candidate-&gt;iState == CLOSED &amp;&amp; !to_bool(candidate-&gt;getAttr(&quot;noshuffle&quot;))) {
+                closedOxyds.push_back(i);
             }
         }
     
-        unsigned size = closed_oxyds.size();
+        unsigned size = closedOxyds.size();
         if (size&gt;1) {
             for (unsigned i = 0; i&lt;size; ++i) {
                 unsigned a = IntegerRand(0, static_cast&lt;int&gt; (size-2));
                 if (a &gt;= i) ++a;        // make a always different from j
     
-                OxydStone *o1 = levelOxyds[closed_oxyds[i]];
-                OxydStone *o2 = levelOxyds[closed_oxyds[a]];
+                OxydStone *o1 = levelOxyds[closedOxyds[i]];
+                OxydStone *o2 = levelOxyds[closedOxyds[a]];
     
                 Value icolor = o1-&gt;getAttr(&quot;color&quot;); 
     
@@ -229,8 +241,11 @@
     }
     
     void OxydStone::fairShuffleColors(LogType logFlag) {        
+        unsigned short numOxyds = levelOxyds.size();
+        
         // generate sequence of oxyds for randomness of distribution
-        // TODO exclude noshuffle pseudo oxyds
+        // the sequence contains even noshuffle pseudo oxyds as they are masked out
+        // by the freeOxydMask prior being selected anywhere
         randomOxydIds = std::vector&lt;unsigned short&gt;(levelOxyds.size());
         for (int i = 0; i &lt; randomOxydIds.size(); i++)
             randomOxydIds[i] = i;
@@ -241,12 +256,18 @@
             randomOxydIds[j] = t;
         }
         
-//        log_shuffle_basis();
-        
         if (groupsSharedMembers.size() == 0) {
             // first shuffle call for given rules - initialize base frame
-            // TODO exclude noshuffle pseudo oxyds
             
+            // prepare exclusion of noshuffle pseudo oxyds
+            uint32_t noshufflePseudoMask = 0; 
+            for (int i = 0; i &lt; numOxyds; i++) {
+                OxydStone *candidate = levelOxyds[i];
+                if ((int)candidate-&gt;getAttr(&quot;color&quot;) &lt; AUTO &amp;&amp; 
+                        to_bool(candidate-&gt;getAttr(&quot;noshuffle&quot;)))
+                    noshufflePseudoMask |= 1 &lt;&lt; i;
+            }
+            
             // evaluate all group members that are shared with another group
             for (int i = 0; i &lt; groupsMembers.size(); i++) {
                 uint32_t shared = 0;
@@ -254,16 +275,17 @@
                     if (i != j)
                         shared |= (groupsMembers[i] &amp; groupsMembers[j]);
                 }
-                groupsSharedMembers.push_back(shared);
+                groupsSharedMembers.push_back(shared &amp; ~noshufflePseudoMask);
             }
             
             // init oxyd pair candidates
-            uint32_t all = (1 &lt;&lt; (levelOxyds.size())) - 1;  // a 1 for every oxyd
-            unsigned short numOxyds = levelOxyds.size();
+            uint32_t all = (((uint32_t)1 &lt;&lt; (levelOxyds.size())) - 1)   // a 1 for every oxyd
+                                &amp; ~noshufflePseudoMask;
             ShuffleFrame &amp;base = shuffleStack.front();
             for (int i = 0; i &lt; numOxyds; i++) {
-                base.oxydsCandidatesCount.push_back(numOxyds - 1); // all but itself
-                base.oxydsCandidatesMask.push_back(all &amp; ~(1 &lt;&lt; i));   // all but itself
+                uint32_t candidates = all &amp; ~(1 &lt;&lt; i);   // exclude itself
+                base.oxydsCandidatesMask.push_back(candidates);   
+                base.oxydsCandidatesCount.push_back(countOxyds(candidates));
             }
             base.freeOxydsMask = all;
             base.freePseudoCount = shuffledFakeCount + shuffledFartCount + shuffledBoldCount;
@@ -271,40 +293,68 @@
             for (int i = 0; i &lt; numColorsAvailable(); i++) {
                 base.freePairsCount += colorsUsageCount[i];
             }
+            base.freePairsCount /= 2;
             base.selOxyd1Mask = 0;  // no oxyd assigned in this frame
             base.selOxyd2Mask = 0;
             base.openedOxydIndex = 0;
+            base.fixedcolorOxydIndex = 0;
         }
-        log_shuffle_basis();
-        log_shuffle_stack();
+        
+        // make a copy of the base frame as the base frame should not be modified
+        ShuffleFrame &amp;top = shuffleStack.back();
+        ShuffleFrame second = top;
+                
+        // remove not CLOSED pseudo oxyds
+        uint32_t notClosedPseudoMask = 0; 
+        for (int i = 0; i &lt; numOxyds; i++) {
+            OxydStone *candidate = levelOxyds[i];
+            if ((int)candidate-&gt;getAttr(&quot;color&quot;) &lt; AUTO &amp;&amp; candidate-&gt;iState != CLOSED)
+                notClosedPseudoMask |= 1 &lt;&lt; i;
+        }
+        second.freeOxydsMask &amp;= ~notClosedPseudoMask;
+        for (int i = 0; i &lt; numOxyds; i++) {
+            second.oxydsCandidatesMask[i] &amp;= ~notClosedPseudoMask;   
+            second.oxydsCandidatesCount[i] = countOxyds(second.oxydsCandidatesMask[i]);
+        }
+        
+        shuffleStack.push_back(second);
+        
+//        log_shuffle_basis();
+//        log_shuffle_stack();
         logBadFrameCount = 0;
         
         if (logFlag == NOTHING) logFlag = SOLUTION;
         
         int result = evaluateTopFrame(logFlag);
+        shuffleStack.pop_back();         // remove the copy
+                
+        if (server::LevelStatus &gt;= lev::STATUS_TEST) {
+            if (logFlag &gt;= COUNT)
+                Log &lt;&lt; &quot;Fair Shuffle found &quot; &lt;&lt; result &lt;&lt; &quot; distributions -  bad frames &quot; &lt;&lt; logBadFrameCount &lt;&lt; &quot;\n&quot;;
+            else if (logFlag == SOLUTION)
+                Log &lt;&lt; &quot;Fair Shuffle bad frames &quot; &lt;&lt; logBadFrameCount &lt;&lt; &quot;\n&quot;;
+        }
         
-        if (logFlag &gt;= COUNT)
-            Log &lt;&lt; &quot;Fair Shuffle found &quot; &lt;&lt; result &lt;&lt; &quot; solutions -  bad frames &quot; &lt;&lt; logBadFrameCount &lt;&lt; &quot;\n&quot;;
-        else if (logFlag == SOLUTION)
-            Log &lt;&lt; &quot;Fair Shuffle bad frames &quot; &lt;&lt; logBadFrameCount &lt;&lt; &quot;\n&quot;;
-        
+        ASSERT(result &gt; 0, XLevelRuntime, &quot;Oxyd shuffle colors - no fair solution exists for given rules&quot;);
     }
     
     int OxydStone::evaluateTopFrame(LogType logFlag) {
         unsigned short numOxyds = levelOxyds.size();
         ShuffleFrame &amp;top = shuffleStack.back();
         int solutionsCount = 0;
+//        log_shuffle_stack();
                 
         // postprocess frame for chosen oxyds
         if (top.selOxyd1Mask != 0) {   // skip for base frame
             
-            // check that a chosen oxyd pair with both oxyds of given fixed color do 
-            // not mismatch in color - refuse on mismatch.
+            // check that a chosen oxyd pair with both oxyds of given unchangeable color do 
+            // not mismatch in color - refuse on mismatch. Note that any iState beside
+            // CLOSED shows the color and thus makes a color change impossible
             if (top.selOxyd2Mask != 0) {
                 OxydStone *o1 = levelOxyds[oxydId(top.selOxyd1Mask)];
                 OxydStone *o2 = levelOxyds[oxydId(top.selOxyd2Mask)];
-                if ((to_bool(o1-&gt;getAttr(&quot;noshuffle&quot;)) || blinking_or_opening(o1)) &amp;&amp;
-                        (to_bool(o2-&gt;getAttr(&quot;noshuffle&quot;)) || blinking_or_opening(o2)) &amp;&amp;
+                if ((to_bool(o1-&gt;getAttr(&quot;noshuffle&quot;)) || o1-&gt;iState != CLOSED) &amp;&amp;
+                        (to_bool(o2-&gt;getAttr(&quot;noshuffle&quot;)) || o2-&gt;iState != CLOSED) &amp;&amp;
                         (int)(o1-&gt;getAttr(&quot;color&quot;)) &gt;= 0 &amp;&amp;  (int)(o2-&gt;getAttr(&quot;color&quot;)) &gt;= 0 &amp;&amp;
                         o1-&gt;getAttr(&quot;color&quot;) != o2-&gt;getAttr(&quot;color&quot;)) {
                     logBadFrameCount++;
@@ -470,7 +520,7 @@
 
         // opened oxyd pairs first
         for (;next.openedOxydIndex &lt; numOxyds; next.openedOxydIndex++) {
-            if (levelOxyds[next.openedOxydIndex]-&gt;animState == OPEN) {
+            if (levelOxyds[next.openedOxydIndex]-&gt;iState == OPEN_PAIR) {
                 int c = levelOxyds[next.openedOxydIndex]-&gt;getAttr(&quot;color&quot;);
                 for (int i = next.openedOxydIndex+1; i &lt; numOxyds; i++) {
                     if (levelOxyds[i]-&gt;getAttr(&quot;color&quot;) == c) {
@@ -486,8 +536,32 @@
             }
         }
         
-        // pairs of noshuffle standard oxyds including a possible blinking oxyd
-        // TODO - not essential but a speedup to select known pairs first
+        // pairs of noshuffle standard oxyds and other not closed oxyds including a possible blinking oxyd
+        // it is essential to select known pairs first
+        for (;next.fixedcolorOxydIndex &lt; numOxyds; next.fixedcolorOxydIndex++) {
+            OxydStone *candidate1 = levelOxyds[next.fixedcolorOxydIndex];
+            int color1 = candidate1-&gt;getAttr(&quot;color&quot;);
+            if ((int)candidate1-&gt;getAttr(&quot;color&quot;) &gt; AUTO &amp;&amp; (
+                    to_bool(candidate1-&gt;getAttr(&quot;noshuffle&quot;)) || candidate1-&gt;iState == OPENING ||
+                    candidate1-&gt;iState == CLOSING || candidate1-&gt;iState == OPEN_SINGLE )) {
+                for (int i = next.fixedcolorOxydIndex+1; i &lt; numOxyds; i++) {
+                    OxydStone *candidate2 = levelOxyds[i];
+                    if (candidate2-&gt;getAttr(&quot;color&quot;) == color1 &amp;&amp; (
+                            to_bool(candidate2-&gt;getAttr(&quot;noshuffle&quot;)) || candidate2-&gt;iState == OPENING ||
+                            candidate2-&gt;iState == CLOSING || candidate2-&gt;iState == OPEN_SINGLE)) {
+                        next.selOxyd1Mask = 1 &lt;&lt; next.fixedcolorOxydIndex;
+                        next.selOxyd2Mask = 1 &lt;&lt; i;
+                        if ((next.selOxyd2Mask &amp; next.oxydsCandidatesMask[next.fixedcolorOxydIndex]) == 0)
+                            return 0;   // Oops - a rule contradiction
+                        next.fixedcolorOxydIndex++;
+                        shuffleStack.push_back(next);    // add copy of next frame
+                        int result = evaluateTopFrame(logFlag);
+                        shuffleStack.pop_back();         // remove the copy
+                        return result;
+                    }
+                }
+            }
+        }
         
         
         // fast handling of oxyd pairs mandatory due to min rules 
@@ -541,7 +615,7 @@
             }
         }
         // try to assign all pair candidates to this oxyd 
-        if (next.oxydsCandidatesCount[minFreeOxydId] &gt; 0) {
+        if (next.freePairsCount &gt; 0 &amp;&amp; next.oxydsCandidatesCount[minFreeOxydId] &gt; 0) {
             next.selOxyd1Mask = 1 &lt;&lt; minFreeOxydId;
             uint32_t candidates = next.oxydsCandidatesMask[minFreeOxydId];
             // check all candidates in random sequence
@@ -561,7 +635,22 @@
         }
         
         // try to assign a single pseudo oxyd
-        // TODO
+        // check that minFreeOxydId is not a noshuffle standard oxyd that can not
+        // be recolored to a pseudo!
+        OxydStone *pseudocandidate = levelOxyds[minFreeOxydId];
+        if (next.freePseudoCount &gt; 0 &amp;&amp; ((int)pseudocandidate-&gt;getAttr(&quot;color&quot;) &lt; AUTO || 
+                (!(to_bool(pseudocandidate-&gt;getAttr(&quot;noshuffle&quot;))) &amp;&amp;
+                pseudocandidate-&gt;iState == CLOSED))) {
+            next.selOxyd1Mask = 1 &lt;&lt; minFreeOxydId;
+            next.selOxyd2Mask = 0;
+            shuffleStack.push_back(next);    // add copy of next frame
+            int result = evaluateTopFrame(logFlag);
+            shuffleStack.pop_back();         // remove the copy
+            if (result &gt; 0 &amp;&amp; logFlag &lt; COUNT)  // found solution - finish
+                return result;
+            // sum solutions
+            solutionsCount += result;
+        }
         
         return solutionsCount;
     }
@@ -583,17 +672,16 @@
                 if ((*itr).selOxyd2Mask == 0) {
                     // a single oxyd -- it must be a pseudo
                     OxydStone *oxyd = levelOxyds[oxydId((*itr).selOxyd1Mask)];
-                    ASSERT((int)oxyd-&gt;getAttr(&quot;color&quot;) &lt; AUTO, XLevelRuntime, &quot;Oxyd shuffle - pseudo coloring error&quot;);
-                    ASSERT(shuffledFakeCount + shuffledFartCount + shuffledBoldCount &gt; 0, XLevelRuntime, &quot;Oxyd shuffle - to few pseudo colors&quot;);
-                    int i = IntegerRand(1, shuffledFakeCount + shuffledFartCount + shuffledBoldCount);  // use enigma's internal rand!
-                    if (i &lt;= shuffledFakeCount) {
-                        shuffledFakeCount--;
+                    ASSERT(remainFakeCount + remainFartCount + remainBoldCount &gt; 0, XLevelRuntime, &quot;Oxyd shuffle - to few pseudo colors&quot;);
+                    int i = IntegerRand(1, remainFakeCount + remainFartCount + remainBoldCount);  // use enigma's internal rand!
+                    if (i &lt;= remainFakeCount) {
+                        remainFakeCount--;
                         oxyd-&gt;set_attrib(&quot;color&quot;, FAKE);
-                    } else if ( i &lt;= shuffledFakeCount + shuffledFartCount) {
-                        shuffledFartCount--;
+                    } else if ( i &lt;= remainFakeCount + remainFartCount) {
+                        remainFartCount--;
                         oxyd-&gt;set_attrib(&quot;color&quot;, FART);
                     } else {
-                        shuffledBoldCount--;
+                        remainBoldCount--;
                         oxyd-&gt;set_attrib(&quot;color&quot;, BOLD);
                     }
                     (*itr).isColored = true;
@@ -602,20 +690,21 @@
                     OxydStone *oxyd1 = levelOxyds[oxydId((*itr).selOxyd1Mask)];
                     OxydStone *oxyd2 = levelOxyds[oxydId((*itr).selOxyd2Mask)];
                     int c = AUTO;
-                    if (oxyd1-&gt;animState == OPEN) {
+                    if (oxyd1-&gt;iState == OPEN_PAIR) {
                         // a pair of opened oxyds - we need not to recolor
                         // but we need to register the used color
                         c = oxyd1-&gt;getAttr(&quot;color&quot;);
                         colorsRemainCount[c] -= 2;                        
                         (*itr).isColored = true;
                     }
-                    else if (to_bool(oxyd1-&gt;getAttr(&quot;noshuffle&quot;)) || blinking_or_opening(oxyd1)) {
+                    else if (to_bool(oxyd1-&gt;getAttr(&quot;noshuffle&quot;)) || oxyd1-&gt;iState != CLOSED) {
+                        // a standard oxyd (pseudo is impossible) that requires a color
                         c = oxyd1-&gt;getAttr(&quot;color&quot;);
                         oxyd2-&gt;set_attrib(&quot;color&quot;, c);
                         colorsRemainCount[c] -= 2;
                         (*itr).isColored = true;
                     }
-                    else if (to_bool(oxyd2-&gt;getAttr(&quot;noshuffle&quot;)) || blinking_or_opening(oxyd2)) {
+                    else if (to_bool(oxyd2-&gt;getAttr(&quot;noshuffle&quot;)) || oxyd2-&gt;iState != CLOSED) {
                         c = oxyd2-&gt;getAttr(&quot;color&quot;);
                         oxyd1-&gt;set_attrib(&quot;color&quot;, c);
                         colorsRemainCount[c] -= 2;
@@ -651,7 +740,7 @@
         }
          
         
-        if (logFlag &gt; NOTHING) {
+        if (logFlag &gt; NOTHING &amp;&amp;  server::LevelStatus &gt;= lev::STATUS_TEST) {
             Log &lt;&lt; &quot;Shuffle solution found: &quot;;
             int depth = 0;
             for (std::list&lt;ShuffleFrame&gt;::iterator itr = shuffleStack.begin(); itr != shuffleStack.end(); ++itr, depth++) {
@@ -724,7 +813,7 @@
     void OxydStone::log_shuffle_stack() {
         int depth = 0;
         for (std::list&lt;ShuffleFrame&gt;::iterator itr = shuffleStack.begin(); itr != shuffleStack.end(); ++itr, depth++) {
-            Log &lt;&lt; ecl::strf(&quot;Stack frame %d -- freeOxydsMask %X\n&quot;, depth, (*itr).freeOxydsMask);
+            Log &lt;&lt; ecl::strf(&quot;Stack frame %d -- freeOxydsMask %X - %X %X - pseudo %d - pair %d\n&quot;, depth, (*itr).freeOxydsMask, (*itr).selOxyd1Mask, (*itr).selOxyd2Mask, (*itr).freePseudoCount, (*itr).freePairsCount);
             for (int i=0; i &lt; (*itr).oxydsCandidatesMask.size(); i++)
                  Log &lt;&lt; ecl::strf(&quot;Oxyd %d - candidates %X - num %d\n&quot;, i, 
                         (*itr).oxydsCandidatesMask[i], (*itr).oxydsCandidatesCount[i]);
@@ -742,9 +831,12 @@
         pairRulesMin.clear();
         pairRulesMax.clear();
         colorsUsageCount.clear();
+        isInit = false;
     }
     
-    OxydStone::OxydStone() : PhotoStone(&quot;st-oxyd&quot;), animState (CLOSED) {
+    // Instance Methods
+    
+    OxydStone::OxydStone() : PhotoStone(&quot;st-oxyd&quot;), iState (CLOSED) {
         set_attrib(&quot;flavor&quot;, &quot;b&quot;);
         set_attrib(&quot;color&quot;, AUTO);
     }
@@ -764,17 +856,16 @@
     
     Value OxydStone::message(const string &amp;m, const Value &amp;val) {
         if (m==&quot;closeall&quot;) {
-            for (unsigned i=0; i&lt;levelOxyds.size(); ++i)
-                levelOxyds[i]-&gt;change_state(CLOSING);
+            closeAllStandardOxyds();
         }
         else if (m==&quot;shuffle&quot;) {
             shuffleColors();
         }
         else if (m==&quot;trigger&quot; || m==&quot;spitter&quot;) {
-            maybe_open_stone();
+            tryOpen();
         }
         else if (m==&quot;signal&quot; &amp;&amp; to_int(val) != 0) {
-            maybe_open_stone();
+            tryOpen();
         }
         else if (m==&quot;init&quot;) {
             initColors();
@@ -782,84 +873,90 @@
         return Value();
     }
     
-    void OxydStone::change_state(State newstate) {
-        string flavor(getAttr(&quot;flavor&quot;,&quot;a&quot;));
-        string color(getAttr(&quot;color&quot;, 0));
+    void OxydStone::set_attrib(const string&amp; key, const Value &amp;val) {
+        if (key == &quot;color&quot;) 
+            ASSERT(iState == CLOSED, XLevelRuntime, &quot;OxydStone error - recoloring of an not closed stone&quot;);
+        else if (key == &quot;flavor&quot;) {
+            ASSERT(iState == CLOSED, XLevelRuntime, &quot;OxydStone error - reflavoring of an not closed stone&quot;);
+        }
+        
+        Object::set_attrib(key, val);   // do value checking
+        
+        if (key == &quot;flavor&quot; &amp;&amp; IsInsideLevel(get_pos()))
+            set_model(string(&quot;st-oxyd&quot;)+(std::string)val);
+    }
     
-        string modelname = string(&quot;st-oxyd&quot;) + flavor + color;
+//    Value OxydStone::getAttr(const string &amp;key) const {
+//        // TODO &quot;state&quot; 0=CLOSE || CLOSING; 1 = other iState values
+//        return Object::getAttr(key);
+//    }
     
-        State oldstate = animState;
-        animState = newstate;
+    void OxydStone::actor_hit(const StoneContact &amp;/*sc*/) {
+        tryOpen();
+    }
     
-        switch (newstate) {
-        case CLOSED:
-            set_model(string(&quot;st-oxyd&quot;)+flavor);
-            break;
+    bool OxydStone::is_removable() const {
+        return !getAttr(&quot;static&quot;).to_bool();
+    }
     
-        case BLINKING:
-            set_model(modelname + &quot;-blink&quot;);
-            break;
+    void OxydStone::animcb() {
+        if (iState == CLOSING)
+            set_iState(CLOSED);
+        else if (iState == OPENING)
+            set_iState(OPEN_SINGLE);
+        else if (iState == OPEN_PAIR)     // end of opening anim for second oxyd in a pair
+            set_iState(OPEN_PAIR);      // set the right model
+        else if (iState == OPEN_SINGLE)   // pseudo animation
+            set_iState(CLOSING);
+    }
     
-        case OPEN:
-            if (oldstate == CLOSED) {
-                sound_event(&quot;oxydopen&quot;);
-                sound_event(&quot;oxydopened&quot;);
-                set_anim(modelname+&quot;-opening&quot;);
-            } else {
-                set_model(modelname + &quot;-open&quot;);
-            }
-            /* If this was the last closed oxyd stone, finish the
-               level */
-            if (find_if(levelOxyds.begin(),levelOxyds.end(),not_open)
-                    == levelOxyds.end()) {
-                server::FinishLevel();
-            }
-            break;
+    void OxydStone::on_creation (GridPos) {
+        string flavor(getAttr(&quot;flavor&quot;, &quot;a&quot;));
+        set_model(string(&quot;st-oxyd&quot;) + flavor);
+        photo_activate();
+    }
     
-        case OPENING:
-            sound_event(&quot;oxydopen&quot;);
-            if (oldstate == CLOSED)
-                set_anim(modelname + &quot;-opening&quot;);
-            else if (oldstate == CLOSING)
-                get_model()-&gt;reverse();
+    void OxydStone::on_removal(GridPos p) {
+        photo_deactivate();
+        kill_model (p);
+    }
     
-            break;
-    
-        case CLOSING:
-            if (oldstate == CLOSED || oldstate==CLOSING) {
-                animState = oldstate;
+    void OxydStone::tryOpen() {
+        bool isSingleOpened = false;
+        OxydStone *pairCandidate = NULL;
+        
+        initColors();
+        
+        // check for a blocking pseudo
+        for (InstanceVector::iterator itr = levelOxyds.begin(); itr != levelOxyds.end(); ++itr) {
+            if ((*itr)-&gt;iState != CLOSED &amp;&amp; (int)((*itr)-&gt;getAttr(&quot;color&quot;)) &lt; AUTO) {
+                // a pseudo is blocking any opening of other oxyds
+                // this is necessary as the bold reshuffle can take place only after
+                // finishing its closing animation!
                 return;
             }
-    
-            sound_event(&quot;oxydclose&quot;);
-            if (oldstate == OPENING)
-                get_model()-&gt;reverse();
-            else if (oldstate == BLINKING || oldstate == OPEN) {
-                set_anim(modelname + &quot;-closing&quot;);
+            if ((*itr)-&gt;iState == OPEN_SINGLE || (*itr)-&gt;iState == OPENING) {
+                // remember a standard colored pair candidate
+                isSingleOpened = true;
+                pairCandidate = *itr;
             }
-            break;
         }
-    }
-    
-    void OxydStone::animcb() {
-        if (animState == CLOSING)
-            change_state(CLOSED);
-        else if (animState == OPENING)
-            change_state(BLINKING);
-        else if (animState == OPEN)
-            change_state(OPEN); // set the right model
-    }
-    
-    void OxydStone::maybe_open_stone() {
-        if (animState == CLOSED || animState == CLOSING) {
-            Value mycolor = getAttr(&quot;color&quot;);
-    
-            // Is another oxyd stone currently blinking?
-            InstanceVector::iterator i;
-            i=find_if(levelOxyds.begin(), levelOxyds.end(), blinking_or_opening);
-    
-            if (i != levelOxyds.end()) {
-    
+        
+        Value mycolor = getAttr(&quot;color&quot;);    
+        if ((int)mycolor &lt; AUTO) {
+            // pseudo open
+            if (isSingleOpened) {
+                // a standard single oxyd is open - close it
+                pairCandidate-&gt;set_iState(CLOSING);
+            }
+            // open FART and BOLD, keep FAKE closed
+            if ((int)mycolor &lt;= FART)
+                set_iState(OPENING);
+        }
+        else if (iState == CLOSED || iState == CLOSING) {
+            // standard colored oxyd open
+            
+            if (isSingleOpened) {
                 bool can_open;
     
                 if (server::GameCompatibility != GAMET_ENIGMA) {
@@ -867,44 +964,100 @@
                     // open both stones. Close one of them otherwise.
                     // (This is the Oxyd behaviour; it doesn't work with
                     // some Enigma levels.)
-                    can_open = (mycolor == (*i)-&gt;getAttr(&quot;color&quot;) &amp;&amp; (*i)-&gt;animState==BLINKING);
+                    can_open = (mycolor == pairCandidate-&gt;getAttr(&quot;color&quot;) &amp;&amp; pairCandidate-&gt;iState==OPEN_SINGLE);
                 }
                 else 
-                    can_open = (mycolor == (*i)-&gt;getAttr(&quot;color&quot;));
+                    can_open = (mycolor == pairCandidate-&gt;getAttr(&quot;color&quot;));
     
                 if (can_open) {
-                    change_state(OPEN);
-                    (*i)-&gt;change_state(OPEN);
+                    set_iState(OPEN_PAIR);
+                    pairCandidate-&gt;set_iState(OPEN_PAIR);
                 } else {
-                    (*i)-&gt;change_state(CLOSING);
-                    change_state(OPENING);
+                    pairCandidate-&gt;set_iState(CLOSING);
+                    set_iState(OPENING);
                 }
             }
             else {
                 // no blinking stone? -&gt; make this one blink
-                change_state(OPENING);
+                set_iState(OPENING);
             }
         }
     }
     
-    void OxydStone::actor_hit(const StoneContact &amp;/*sc*/) {
-        maybe_open_stone();
+    void OxydStone::closeAllStandardOxyds() {
+        for (unsigned i=0; i&lt;levelOxyds.size(); ++i)
+            if ((int)(levelOxyds[i]-&gt;getAttr(&quot;color&quot;)) &gt;= AUTO)
+                levelOxyds[i]-&gt;set_iState(CLOSING);
     }
     
-    void OxydStone::on_creation (GridPos) {
-        string flavor(getAttr(&quot;flavor&quot;, &quot;a&quot;));
-        set_model(string(&quot;st-oxyd&quot;) + flavor);
-        photo_activate();
-    }
+    void OxydStone::set_iState(State newState) {
+        string flavor(getAttr(&quot;flavor&quot;,&quot;a&quot;));
+        string color(getAttr(&quot;color&quot;, 0));
     
-    bool OxydStone::is_removable() const {
-        return !getAttr(&quot;static&quot;).to_bool();
+        string basemodelname = string(&quot;st-oxyd&quot;) + flavor;
+        string modelname = basemodelname + color;
+    
+        State oldState = iState;
+        iState = newState;
+    
+        switch (newState) {
+            case CLOSED:
+                if ((int)getAttr(&quot;color&quot;) == BOLD)
+                    shuffleColors();    // shuffle all closed oxyds including itself
+                    
+                set_model(string(&quot;st-oxyd&quot;)+flavor);
+                break;
+        
+            case OPEN_SINGLE:
+                if ((int)getAttr(&quot;color&quot;) &lt;= FART) {
+                    set_anim(basemodelname + &quot;-pseudo&quot; + color);
+                    if ((int)getAttr(&quot;color&quot;) == FART) {
+                        closeAllStandardOxyds();
+                    }
+                } else
+                    set_model(modelname + &quot;-blink&quot;);
+                break;
+        
+            case OPEN_PAIR:
+                if (oldState == CLOSED) {
+                    sound_event(&quot;oxydopen&quot;);
+                    sound_event(&quot;oxydopened&quot;);
+                    set_anim(modelname+&quot;-opening&quot;);
+                } else {
+                    set_model(modelname + &quot;-open&quot;);
+                }
+                // If this was the last closed oxyd stone, finish the level
+                if (find_if(levelOxyds.begin(),levelOxyds.end(),not_open)
+                        == levelOxyds.end()) {
+                    server::FinishLevel();
+                }
+                break;
+        
+            case OPENING:
+                sound_event(&quot;oxydopen&quot;);
+                if (oldState == CLOSED)
+                    set_anim(modelname + &quot;-opening&quot;);
+                else if (oldState == CLOSING)
+                    get_model()-&gt;reverse();
+        
+                break;
+        
+            case CLOSING:
+                if (oldState == CLOSED || oldState==CLOSING) {
+                    iState = oldState;
+                    return;
+                }
+        
+                sound_event(&quot;oxydclose&quot;);
+                if (oldState == OPENING)
+                    get_model()-&gt;reverse();
+                else if (oldState == OPEN_SINGLE || oldState == OPEN_PAIR) {
+                    set_anim(modelname + &quot;-closing&quot;);
+                }
+                break;
+        }
     }
     
-    void OxydStone::on_removal(GridPos p) {
-        photo_deactivate();
-        kill_model (p);
-    }
 
     BOOT_REGISTER_START
         BootRegister(new OxydStone);

Modified: trunk/src/stones/OxydStone.hh
===================================================================
--- trunk/src/stones/OxydStone.hh	2007-11-15 20:42:53 UTC (rev 925)
+++ trunk/src/stones/OxydStone.hh	2007-11-18 16:45:12 UTC (rev 926)
@@ -84,6 +84,8 @@
         virtual OxydStone * clone();
         virtual void dispose();
         virtual Value message(const string &amp;m, const Value &amp;);
+        virtual void set_attrib(const string&amp; key, const Value &amp;val);
+//        virtual Value getAttr(const string &amp;key) const;
 
         // Stone interface
         virtual void actor_hit(const StoneContact &amp;sc);
@@ -91,7 +93,7 @@
         virtual bool is_removable() const;
         
         // PhotoStone interface
-        virtual void notify_laseron() { maybe_open_stone(); }
+        virtual void notify_laseron() { tryOpen(); }
         virtual void notify_laseroff() {}
 
         // ModelCallback interface  - Animation callback
@@ -103,27 +105,44 @@
         void on_removal (GridPos p);
             
     private:
-        enum State { CLOSED, OPEN, OPENING, CLOSING, BLINKING };
+        enum State { CLOSED, OPEN_PAIR, OPENING, CLOSING, OPEN_SINGLE };
+        
         typedef std::vector&lt;OxydStone *&gt; InstanceVector;
+        
         typedef struct {
             unsigned short ruleId;
             unsigned short groupId1;
             unsigned short groupId2;
         } Rule;
+        
+        /**
+         * The data frame of the fair shuffle algorithm that describe the remaining limitations
+         * and degrees of freedom for the distribution of the remaining oxyds. For every oxyd
+         * pair and every pseudo oxyd a new frame is generated which lists the oxyds and the
+         * remaining constraints.
+         */
         typedef struct {
-                uint32_t freeOxydsMask;
-                unsigned short freePseudoCount;
-                unsigned short freePairsCount;
-                std::vector&lt;unsigned short&gt; oxydsCandidatesCount;
-                std::vector&lt;uint32_t&gt; oxydsCandidatesMask;
-                std::vector&lt;short&gt; rulesLimit;  // -1 means rule is fulfilled
-                uint32_t selOxyd1Mask;
-                uint32_t selOxyd2Mask;
-                unsigned short openedOxydIndex;
-                bool isColored;
+            uint32_t freeOxydsMask;              ///&lt; a 1 for every oxyd that needs to be distributed
+            unsigned short freePseudoCount;      ///&lt; number of pseudo oxyds that need to be distributed
+            unsigned short freePairsCount;       ///&lt; number of oxyd pairs that need to be distributed
+            std::vector&lt;unsigned short&gt; oxydsCandidatesCount; ///&lt; number of possible pair partners per oxyd
+            std::vector&lt;uint32_t&gt; oxydsCandidatesMask;        ///&lt; mask of possible pair partners per oxyd
+            std::vector&lt;short&gt; rulesLimit;       ///&lt; remaining number of pairs to reach limit per rule.
+                                                 ///&lt; -1 means rule is fulfilled and needs no further checks
+            uint32_t selOxyd1Mask;               ///&lt; selected first oxyd for this frame coded as bitmask, 
+                                                 ///&lt; 0 = no selection
+            uint32_t selOxyd2Mask;               ///&lt; selected second oxyd for this frame coded as bitmask, 
+                                                 ///&lt; 0 = no selection
+            unsigned short openedOxydIndex;      ///&lt; levelOxyds index for next oxyd that needs to be checked
+                                                 ///&lt; for being a standard colored opened pair oxyd
+            unsigned short fixedcolorOxydIndex;  ///&lt; levelOxyds index for next oxyd that needs to be checked
+                                                 ///&lt; for being a part of a unopend pair with a fixed color 
+            bool isColored;                      ///&lt; flag set and used by the final coloring to mark frames
+                                                 ///&lt; with already colored oxyds
         } ShuffleFrame;
 
         static InstanceVector levelOxyds;
+        static bool isInit;
         static std::vector&lt;unsigned short&gt; colorsUsageCount;
         static unsigned short shuffledFakeCount;
         static unsigned short shuffledFartCount;
@@ -155,21 +174,16 @@
         static void log_shuffle_basis();
         static void log_shuffle_stack();
         
-        static bool blinking(OxydStone *a) {
-            return (a-&gt;animState == BLINKING);
-        }
-        static bool blinking_or_opening(OxydStone *a) {
-            return (a-&gt;animState == BLINKING || a-&gt;animState == OPENING);
-        }
         static bool not_open(OxydStone *a) {
-            return !(a-&gt;animState == OPEN || a-&gt;animState == OPENING);
+            return !(a-&gt;iState == OPEN_PAIR || (int)a-&gt;getAttr(&quot;color&quot;) &lt; AUTO);
         }
 
-        State animState;
+        State iState;
 
         // Private methods
-        void maybe_open_stone();
-        void change_state(State newstate);
+        void tryOpen();
+        void closeAllStandardOxyds();
+        void set_iState(State newState);
     };
 } // namespace enigma
 


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000357.html">[Enigma-game-svn] r925 - in trunk: data/levels/enigma_cross	data/levels/enigma_v doc/reference src
</A></li>
	<LI>Next message: <A HREF="000359.html">[Enigma-game-svn] r927 - in homepage: . input input/news
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#358">[ date ]</a>
              <a href="thread.html#358">[ thread ]</a>
              <a href="subject.html#358">[ subject ]</a>
              <a href="author.html#358">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/enigma-game-svn">More information about the Enigma-game-svn
mailing list</a><br>
</body></html>
