<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Enigma-game-svn] r924 - trunk/data/levels/lib
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/enigma-game-svn/2007-November/index.html" >
   <LINK REL="made" HREF="mailto:enigma-game-svn%40lists.berlios.de?Subject=Re%3A%20%5BEnigma-game-svn%5D%20r924%20-%20trunk/data/levels/lib&In-Reply-To=%3C200711110159.lAB1x9Y9018174%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000355.html">
   <LINK REL="Next"  HREF="000357.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Enigma-game-svn] r924 - trunk/data/levels/lib</H1>
    <B>andreasl at BerliOS</B> 
    <A HREF="mailto:enigma-game-svn%40lists.berlios.de?Subject=Re%3A%20%5BEnigma-game-svn%5D%20r924%20-%20trunk/data/levels/lib&In-Reply-To=%3C200711110159.lAB1x9Y9018174%40sheep.berlios.de%3E"
       TITLE="[Enigma-game-svn] r924 - trunk/data/levels/lib">andreasl at mail.berlios.de
       </A><BR>
    <I>Sun Nov 11 02:59:09 CET 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000355.html">[Enigma-game-svn] r923 - in trunk/src: . stones
</A></li>
        <LI>Next message: <A HREF="000357.html">[Enigma-game-svn] r925 - in trunk: data/levels/enigma_cross	data/levels/enigma_v doc/reference src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#356">[ date ]</a>
              <a href="thread.html#356">[ thread ]</a>
              <a href="subject.html#356">[ subject ]</a>
              <a href="author.html#356">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: andreasl
Date: 2007-11-11 02:59:08 +0100 (Sun, 11 Nov 2007)
New Revision: 924

Modified:
   trunk/data/levels/lib/libsoko-designlist.xml
   trunk/data/levels/lib/libsoko-endphase.xml
   trunk/data/levels/lib/libsoko.xml
Log:
Sokoban:
 - Completed design list with endphase entries
 - Completed endphases &quot;ralf&quot;, &quot;vortex&quot;, &quot;allcrack&quot;
 - Added endphase &quot;knock&quot;
 - Added st-door-handling (correct v/h-adjustment)
 - Enhanced design element syntax
   - Added &quot;fire&quot; (only one design currently uses it)
   - Added &quot;rubberball&quot; (no design currently uses it)
   - Added &quot;open_door&quot; (many designs use this)
   - Added multiplicators to ease randomization
   - Added fl-bridge-handling (&quot;fl-bridge_x&quot;, &quot;fl-bridge_y&quot;)
 - Some bugfixes and beautifications
Todo:
 - Fix &quot;places&quot;-bug and always use &quot;set_oxyd&quot; for multiple sokoareas
 - Finetuning of all designs
 - Section in reference manual
 - Remove debug-messages
 - Testlevels
 - Testplaying
 - Maybe add endphases &quot;jumpyoxyds&quot;, &quot;ralfcrack&quot;
Note:
 - With this commit, libsoko is in principle ready.
   But there's still some cleanup and finetuning neccessary.
 - There are some relatively evil designs, which might
   need to be disarmed.


Modified: trunk/data/levels/lib/libsoko-designlist.xml
===================================================================
--- trunk/data/levels/lib/libsoko-designlist.xml	2007-11-10 20:10:07 UTC (rev 923)
+++ trunk/data/levels/lib/libsoko-designlist.xml	2007-11-11 01:59:08 UTC (rev 924)
@@ -86,7 +86,8 @@
 --   ralf           : arrange oxyds with doors
 --     vortex       : like ralf, create vortices between way-clusters
 --     allcrack     : like ralf, create cracks everywhere
---     jumpyoxyds   : like ralf, oxyds are movable by knocking on the door
+--     jumpyoxyds   : like ralf, oxyds are movable by knocking on the door (defunc)
+--     knock        : like ralf, open doors on knocking on other doors
 --   block:X        : create oxyds with blocking object X
 --   outside:X      : create X oxyd-pairs in the outside and outer walls
   
@@ -111,7 +112,7 @@
 design_list = {
 
 -- endp-algs: circle, ralf, hide, outside, allcrack, block, fourswitch
---            vortex, gradients, magnets, jumpyoxyds
+--            vortex, gradients, magnets
 
 -- Ralf's designs
 [1]={box=&quot;st-brownie&quot;, wall=&quot;st-bluegray&quot;, inf=&quot;fl-bluegray&quot;,
@@ -187,7 +188,7 @@
       endp={goal=&quot;st-none&quot;, give=&quot;it-sword&quot;, alg=&quot;block:st-knight&quot;}},
 [23]={box=&quot;st-block&quot;, wall={&quot;st-glass&quot;, &quot;fl-wood&quot;, &quot;fl-abyss&quot;},
       inf=&quot;fl-wood&quot;, outf=&quot;fl-abyss&quot;, door=&quot;st-blocker&quot;, oxyd=&quot;d&quot;,
-      endp={goal={&quot;st-none&quot;, &quot;it-none&quot;}, alg=&quot;allcrack&quot;}},
+      endp={goal={&quot;st-none&quot;, &quot;it-none&quot;}, alg=&quot;allcrack:1&quot;}},
 [24]={box=&quot;st-brownie&quot;, wall={&quot;st-glass&quot;, &quot;fl-wood&quot;, &quot;fl-sahara&quot;},
       inf=&quot;fl-wood&quot;, outf=&quot;fl-sahara&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;c&quot;,
       endp={goal=&quot;st-none&quot;, give=&quot;ac-bug&quot;, alg=&quot;block:st-bug&quot;}},
@@ -332,7 +333,7 @@
       endp={alg=&quot;circle&quot;}},
 [68]={box=&quot;st-brownie&quot;, wall=&quot;st-rock5&quot;, inf=&quot;fl-samba&quot;,
       outf=&quot;fl-space&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;a&quot;,
-      endp={goal=&quot;st-none&quot;, alg=&quot;allcrack&quot;}},
+      endp={goal=&quot;st-none&quot;, alg=&quot;allcrack:1&quot;}},
 [69]={box=&quot;st-block&quot;, wall=&quot;st-rock5&quot;, inf=&quot;fl-samba&quot;,
       outf=&quot;fl-space&quot;, door=&quot;st-blocker&quot;, oxyd=&quot;d&quot;,
       endp={goal={&quot;fl-swamp&quot;, &quot;it-none&quot;}, alg=&quot;ralf&quot;}},
@@ -360,109 +361,271 @@
 [76]={box=&quot;st-glass1_move&quot;, wall=&quot;st-glass2&quot;, inf=&quot;fl-lightgray&quot;,
       outf=&quot;fl-abyss&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;b&quot;,
       endp={goal=&quot;st-pull&quot;, alg=&quot;hide&quot;}},
-[77]={box=&quot;st-rock3_move&quot;, wall=&quot;st-brick&quot;, inf=&quot;fl-darkgray&quot;, outf=&quot;fl-leavesb&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;a&quot;},
-[78]={box=&quot;st-rock3_move&quot;, wall=&quot;st-bumps&quot;, inf=&quot;fl-dunes&quot;, outf=&quot;fl-sand&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;d&quot;},
-[79]={box=&quot;st-flrock&quot;, wall=&quot;st-camouflage&quot;, inf=&quot;fl-gravel&quot;, outf={&quot;fl-gravel&quot;, &quot;st-disco-medium&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;d&quot;},
-[80]={box=&quot;st-flhay&quot;, wall=&quot;st-camouflage&quot;, inf=&quot;fl-leaves&quot;, outf=&quot;fl-water&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;d&quot;},
-[81]={box=&quot;st-glass2_move&quot;, wall={&quot;st-glass1&quot;, &quot;fl-lightgray&quot;}, inf=&quot;fl-black&quot;, outf=&quot;fl-white&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;c&quot;},
-[82]={box=&quot;st-wood&quot;, wall={&quot;st-glass1&quot;, &quot;fl-water&quot;}, inf=&quot;fl-sand&quot;, outf=&quot;fl-water&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;c&quot;},
-[83]={box=&quot;st-camouflage_move&quot;, wall=&quot;st-glass2&quot;, inf=&quot;fl-lightgray&quot;, outf={&quot;fl-leavesb&quot;, &quot;st-disco-medium&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;b&quot;},
-[84]={box=&quot;st-flrock&quot;, wall=&quot;st-glass2&quot;, inf=&quot;fl-sand&quot;, outf={&quot;fl-water&quot;, &quot;st-disco-medium&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;b&quot;},
-[85]={box=&quot;st-flrock&quot;, wall=&quot;st-brick&quot;, inf=&quot;fl-sand&quot;, outf={&quot;fl-water&quot;, &quot;st-disco-medium&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;a&quot;},
-[86]={box=&quot;st-glass1_move&quot;, wall={&quot;st-glass3&quot;, &quot;fl-abyss_fake&quot;}, inf=&quot;fl-red&quot;, outf=&quot;fl-space&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;a&quot;},
-[87]={box=&quot;st-rock3_move&quot;, wall={&quot;st-glass3&quot;, &quot;fl-rough-blue&quot;}, inf=&quot;fl-plank&quot;, outf=&quot;fl-water&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;a&quot;},
-[88]={box=&quot;st-glass1_move&quot;, wall=&quot;st-likeoxyda&quot;, inf=&quot;fl-black&quot;, outf=&quot;fl-abyss&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;a&quot;},
-[89]={box=&quot;st-greenbrown_move&quot;, wall=&quot;st-likeoxyda-open&quot;, inf=&quot;fl-brick&quot;, outf={&quot;fl-mortar&quot;, &quot;st-disco-medium&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;a&quot;},
-[90]={box=&quot;st-rock3_move&quot;, wall=&quot;st-likeoxydb&quot;, inf=&quot;fl-rough-red&quot;, outf=&quot;fl-space&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;b&quot;},
-[91]={box=&quot;st-flhay&quot;, wall=&quot;st-likeoxydb-open&quot;, inf=&quot;fl-rough-blue&quot;, outf={&quot;fl-swamp&quot;, &quot;st-disco-light&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;b&quot;},
-[92]={box=&quot;st-glass2_move&quot;, wall=&quot;st-likeoxydc&quot;, inf=&quot;fl-sahara&quot;, outf={&quot;fl-water&quot;, &quot;st-disco-light&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;c&quot;},
-[93]={box=&quot;st-glass_move&quot;, wall=&quot;st-likeoxydc-open&quot;, inf=&quot;fl-red&quot;, outf={&quot;st-blackballs&quot;, &quot;fl-abyss&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;c&quot;},
-[94]={box=&quot;st-glass2_move&quot;, wall=&quot;st-likeoxydd&quot;, inf=&quot;fl-concrete&quot;, outf=&quot;fl-sand&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;d&quot;},
-[95]={box=&quot;st-flrock&quot;, wall=&quot;st-likeoxydd-open&quot;, inf=&quot;fl-marble&quot;, outf=&quot;fl-water&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;d&quot;},
-[96]={box=&quot;st-flrock&quot;, wall=&quot;st-marble&quot;, inf=&quot;fl-marble&quot;, outf={&quot;fl-leavesc3&quot;, &quot;fl-leavesd3&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;a&quot;},
-[97]={box=&quot;st-camouflage_move&quot;, wall=&quot;st-marble&quot;, inf=&quot;fl-leaves&quot;, outf={&quot;fl-leaves&quot;, &quot;st-marble&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;a&quot;},
-[98]={box=&quot;st-rock1_move&quot;, wall=&quot;st-redrock&quot;, inf=&quot;fl-acblack&quot;, outf={&quot;fl-acblack&quot;, &quot;st-redrock&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;b&quot;},
-[99]={box=&quot;st-glass1_move&quot;, wall=&quot;st-redrock&quot;, inf=&quot;fl-mortar&quot;, outf=&quot;fl-brick&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;b&quot;},
-[100]={box=&quot;st-block&quot;, wall=&quot;st-redrock&quot;, inf=&quot;fl-mortar&quot;, outf=&quot;fl-water&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;b&quot;},
-[101]={box=&quot;st-glass2_move&quot;, wall=&quot;st-redrock&quot;, inf=&quot;fl-leavesb&quot;, outf={&quot;fl-leavesc3&quot;, &quot;fl-leavesd4&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;a&quot;},
-[102]={box=&quot;st-camouflage_move&quot;, wall=&quot;st-rock2&quot;, inf=&quot;fl-rock&quot;, outf={&quot;fl-rock&quot;, &quot;st-disco-medium&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;b&quot;},
-[103]={box=&quot;st-glass2_move&quot;, wall=&quot;st-rock2&quot;, inf=&quot;fl-stone&quot;, outf={&quot;fl-water&quot;, &quot;st-disco-medium&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;b&quot;},
-[104]={box=&quot;st-wood&quot;, wall=&quot;st-rock2&quot;, inf=&quot;fl-lightgray&quot;, outf=&quot;fl-space&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;b&quot;},
-[105]={box=&quot;st-camouflage_move&quot;, wall=&quot;st-rock7&quot;, inf=&quot;fl-woven&quot;, outf=&quot;fl-gravel&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;a&quot;},
-[106]={box=&quot;st-brownie&quot;, wall=&quot;st-rock7&quot;, inf=&quot;fl-black&quot;, outf=&quot;fl-abyss&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;b&quot;},
-[107]={box=&quot;st-glass_move&quot;, wall=&quot;st-rock8&quot;, inf=&quot;fl-plank&quot;, outf={&quot;fl-plank&quot;, &quot;st-rock8&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;d&quot;},
-[108]={box=&quot;st-glass2_move&quot;, wall={&quot;st-rock8&quot;, &quot;fl-water&quot;}, inf=&quot;fl-leaves&quot;, outf=&quot;fl-water&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;c&quot;},
-[109]={box=&quot;st-marble_move&quot;, wall={&quot;st-rock8&quot;, &quot;fl-abyss_fake&quot;}, inf=&quot;fl-stone&quot;, outf=&quot;fl-space&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;c&quot;},
-[110]={box=&quot;st-greenbrown_move&quot;, wall=&quot;st-rock9&quot;, inf=&quot;fl-rock&quot;, outf={&quot;fl-rock&quot;, &quot;st-rock9&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;a&quot;},
-[111]={box=&quot;st-glass_move&quot;, wall=&quot;st-rock9&quot;, inf=&quot;fl-sand&quot;, outf=&quot;fl-water&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;c&quot;},
-[112]={box=&quot;st-camouflage_move&quot;, wall=&quot;st-rock9&quot;, inf=&quot;fl-stone&quot;, outf=&quot;fl-swamp&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;d&quot;},
-[113]={box=&quot;st-block&quot;, wall=&quot;st-rock10&quot;, inf=&quot;fl-bluegreen&quot;, outf=&quot;fl-abyss&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;a&quot;},
-[114]={box=&quot;st-wood&quot;, wall=&quot;st-rock10&quot;, inf=&quot;fl-sand&quot;, outf={&quot;fl-sand&quot;, &quot;st-rock10&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;b&quot;},
-[115]={box=&quot;st-glass2_move&quot;, wall=&quot;st-stone1&quot;, inf={&quot;fl-lightgray&quot;, &quot;fl-white&quot;}, outf={&quot;fl-space&quot;, &quot;fl-abyss&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;d&quot;},
-[116]={box=&quot;st-rock1_move&quot;, wall=&quot;st-stone1&quot;, inf=&quot;fl-stwood&quot;, outf=&quot;fl-water&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;d&quot;},
-[117]={box=&quot;st-glass_move&quot;, wall=&quot;st-stone1&quot;, inf=&quot;fl-black&quot;, outf=&quot;st-stone1&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;d&quot;},
-[118]={box=&quot;st-glass_move&quot;, wall=&quot;st-stone2&quot;, inf=&quot;fl-black&quot;, outf=&quot;fl-gravel&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;b&quot;},
-[119]={box=&quot;st-block&quot;, wall=&quot;st-stone2&quot;, inf=&quot;fl-rough-red&quot;, outf={&quot;fl-rough-blue&quot;, &quot;st-disco-light&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;d&quot;},
-[120]={box=&quot;st-rock3_move&quot;, wall={&quot;st-marble&quot;, &quot;st-stone2&quot;}, inf=&quot;fl-black&quot;, outf={&quot;st-marble&quot;, &quot;st-stone2&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;b&quot;},
-[121]={box=&quot;st-wood&quot;, wall=&quot;st-panel&quot;, inf=&quot;fl-wood&quot;, outf={&quot;fl-leavesd3&quot;, &quot;fl-leavesd2&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;a&quot;},
-[122]={box=&quot;st-block&quot;, wall=&quot;st-panel&quot;, inf=&quot;fl-leaves&quot;, outf=&quot;fl-leavesb&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;a&quot;},
-[123]={box=&quot;st-glass1_move&quot;, wall=&quot;st-woven&quot;, inf=&quot;fl-dunes&quot;, outf=&quot;fl-bluegreen&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;a&quot;},
-[124]={box=&quot;st-marble_move&quot;, wall=&quot;st-woven&quot;, inf=&quot;fl-hay&quot;, outf=&quot;fl-water&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;a&quot;},
-[125]={box=&quot;st-rock3_move&quot;, wall=&quot;st-yellow&quot;, inf=&quot;fl-leavesb&quot;, outf=&quot;fl-leaves&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;a&quot;},
-[126]={box=&quot;st-glass_move&quot;, wall=&quot;st-yellow&quot;, inf=&quot;fl-rough-blue&quot;, outf=&quot;fl-abyss&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;d&quot;},
-[127]={box=&quot;st-block&quot;, wall=&quot;st-yellow&quot;, inf=&quot;fl-lightgray&quot;, outf=&quot;fl-space&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;d&quot;},
-[128]={box=&quot;st-glass1_move&quot;, wall=&quot;st-rock7&quot;, inf=&quot;fl-himalaya&quot;, outf={&quot;fl-himalaya&quot;, &quot;st-rock8&quot;, &quot;st-rock7&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;d&quot;},
+[77]={box=&quot;st-rock3_move&quot;, wall=&quot;st-brick&quot;, inf=&quot;fl-darkgray&quot;,
+      outf=&quot;fl-leavesb&quot;, door=&quot;st-door&quot;, oxyd=&quot;a&quot;,
+      endp={goal=&quot;st-plain_cracked&quot;, give=&quot;it-hammer&quot;, alg=&quot;knock&quot;}},
+[78]={box=&quot;st-rock3_move&quot;, wall=&quot;st-bumps&quot;, inf=&quot;fl-dunes&quot;,
+      outf=&quot;fl-sand&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;a&quot;,
+      endp={goal=&quot;st-plain_break&quot;, give=&quot;it-hammer&quot;, alg=&quot;block:st-plain_cracked&quot;}},
+[79]={box=&quot;st-flrock&quot;, wall=&quot;st-camouflage&quot;, inf=&quot;fl-gravel&quot;,
+      outf={&quot;fl-gravel&quot;, &quot;st-disco-medium&quot;}, door=&quot;st-camouflage&quot;, oxyd=&quot;b&quot;,
+      endp={goal=&quot;st-camouflage&quot;, open_door={&quot;st-none&quot;, &quot;fl-leavesb&quot;}, alg=&quot;vortex&quot;}},
+[80]={box=&quot;st-flhay&quot;, wall=&quot;st-camouflage&quot;, inf=&quot;fl-leaves&quot;,
+      outf={&quot;fl-water:5&quot;, &quot;fl-swamp&quot;, &quot;al:random&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;d&quot;,
+      endp={goal={&quot;fl-swamp&quot;, &quot;it-none&quot;},
+            wall={&quot;st-camouflage_hole&quot;, &quot;st-none:2&quot;, &quot;fl-swamp&quot;, &quot;al:random&quot;},
+            give=&quot;it-umbrella&quot;, alg=&quot;outside:1&quot;}},
+[81]={box=&quot;st-glass2_move&quot;, wall={&quot;st-glass1&quot;, &quot;fl-lightgray&quot;}, inf=&quot;fl-black&quot;,
+      outf=&quot;fl-white&quot;, door=&quot;st-black4&quot;, oxyd=&quot;c&quot;, white=true,
+      endp={goal=&quot;st-yinyang2&quot;, open_door=&quot;st-white4&quot;, alg=&quot;ralf&quot;}},
+[82]={box=&quot;st-wood&quot;, wall={&quot;st-glass1&quot;, &quot;fl-water&quot;}, inf=&quot;fl-sand&quot;,
+      outf=&quot;fl-water&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;c&quot;,
+      endp={goal={&quot;fl-water&quot;, &quot;it-none&quot;}, alg=&quot;fourswitch&quot;}},
+[83]={box=&quot;st-camouflage_move&quot;, wall=&quot;st-glass2&quot;, inf=&quot;fl-lightgray&quot;,
+      outf={&quot;fl-leavesb&quot;, &quot;st-disco-medium&quot;}, door=&quot;st-glass2&quot;, oxyd=&quot;b&quot;,
+      endp={goal=&quot;st-camouflage_hole&quot;, open_door=&quot;st-glass1_hole&quot;,
+            outf=&quot;st-none&quot;, alg=&quot;ralf&quot;}},
+[84]={box=&quot;st-flrock&quot;, wall=&quot;st-glass2&quot;, inf=&quot;fl-sand&quot;,
+      outf={&quot;fl-water&quot;, &quot;st-disco-medium&quot;}, door=&quot;st-door&quot;, oxyd=&quot;b&quot;,
+      endp={goal={&quot;fl-swamp&quot;, &quot;it-none&quot;}, alg=&quot;knock&quot;}},
+[85]={box=&quot;st-flrock&quot;, wall=&quot;st-brick&quot;, inf=&quot;fl-sand&quot;,
+      outf={&quot;fl-water&quot;, &quot;st-disco-medium&quot;}, door=&quot;st-door&quot;, oxyd=&quot;a&quot;,
+      endp={goal=&quot;st-black4&quot;, alg=&quot;ralf&quot;}},
+[86]={box=&quot;st-glass1_move&quot;, wall={&quot;st-glass3&quot;, &quot;fl-abyss_fake&quot;}, inf=&quot;fl-red&quot;,
+      outf=&quot;fl-space&quot;, door={&quot;st-none&quot;, &quot;fire&quot;}, oxyd=&quot;a&quot;,
+      endp={goal=&quot;st-explosion&quot;, open_door=&quot;nofire&quot;, alg=&quot;ralf&quot;}},
+[87]={box=&quot;st-rock3_move&quot;, wall={&quot;st-glass3&quot;, &quot;fl-rough-blue&quot;}, inf=&quot;fl-plank&quot;,
+      outf=&quot;fl-water&quot;, door=&quot;st-glass3&quot;, oxyd=&quot;a&quot;,
+      endp={goal=&quot;st-rock7&quot;, open_door=&quot;st-glass1_hole&quot;, alg=&quot;vortex&quot;}},
+[88]={box=&quot;st-glass1_move&quot;, wall=&quot;st-likeoxyda&quot;, inf=&quot;fl-black&quot;,
+      outf=&quot;fl-abyss&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;a&quot;,
+      endp={goal=&quot;st-glass1_hole&quot;, alg=&quot;hide&quot;}},
+[89]={box=&quot;st-greenbrown_move&quot;, wall=&quot;st-likeoxyda-open&quot;, inf=&quot;fl-brick&quot;,
+      outf={&quot;fl-mortar&quot;, &quot;st-disco-medium&quot;}, door=&quot;st-door&quot;, oxyd=&quot;a&quot;,
+      endp={goal=&quot;st-grate2&quot;, alg=&quot;knock&quot;}},
+[90]={box=&quot;st-rock3_move&quot;, wall=&quot;st-likeoxydb&quot;, inf=&quot;fl-rough-red&quot;,
+      outf=&quot;fl-space&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;b&quot;,
+      endp={goal=&quot;st-plain_breaking&quot;, alg=&quot;hide&quot;}},
+[91]={box=&quot;st-flhay&quot;, wall=&quot;st-likeoxydb-open&quot;, inf=&quot;fl-rough-blue&quot;,
+      outf={&quot;fl-swamp&quot;, &quot;st-disco-light&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;b&quot;,
+      endp={goal=&quot;st-break_gray&quot;, give=&quot;it-hammer&quot;, alg=&quot;block:st-break_gray&quot;}},
+[92]={box=&quot;st-glass2_move&quot;, wall=&quot;st-likeoxydc&quot;, inf=&quot;fl-sahara&quot;,
+      outf={&quot;fl-water&quot;, &quot;st-disco-light&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;c&quot;,
+      endp={goal=&quot;st-glass1_hole&quot;, alg=&quot;hide&quot;}},
+[93]={box=&quot;st-glass_move&quot;, wall=&quot;st-likeoxydc-open&quot;, inf=&quot;fl-red&quot;,
+      outf={&quot;st-blackballs&quot;, &quot;st-whiteballs&quot;, &quot;fl-abyss&quot;, &quot;al:random&quot;},
+      door=&quot;st-door_a&quot;, oxyd=&quot;c&quot;,
+      endp={goal=&quot;st-black4&quot;, alg=&quot;fourswitch&quot;}},
+[94]={box=&quot;st-glass2_move&quot;, wall=&quot;st-likeoxydd&quot;, inf=&quot;fl-concrete&quot;,
+      outf=&quot;fl-sand&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;d&quot;,
+      endp={goal=&quot;st-glass1_hole&quot;, alg=&quot;hide&quot;}},
+[95]={box=&quot;st-flrock&quot;, wall=&quot;st-likeoxydd-open&quot;, inf=&quot;fl-marble&quot;,
+      outf=&quot;fl-water&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;b&quot;,
+      endp={goal={&quot;fl-swamp&quot;, &quot;it-none&quot;}, outf=&quot;fl-swamp&quot;,
+            give=&quot;it-hammer&quot;, wall=&quot;st-break_gray&quot;, alg=&quot;outside&quot;}},
+[96]={box=&quot;st-flrock&quot;, wall=&quot;st-marble&quot;, inf=&quot;fl-marble&quot;,
+      outf={&quot;fl-leavesc3&quot;, &quot;fl-leavesd3&quot;}, door=&quot;st-door&quot;, oxyd=&quot;a&quot;,
+      endp={goal={&quot;st-grate2&quot;, &quot;it-none&quot;}, alg=&quot;knock&quot;}},
+[97]={box=&quot;st-camouflage_move&quot;, wall=&quot;st-marble&quot;, inf=&quot;fl-leaves&quot;,
+      outf={&quot;fl-leaves&quot;, &quot;st-marble&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;a&quot;,
+      endp={goal=&quot;st-camouflage_hole&quot;, wall=&quot;st-marble_hole&quot;,
+            outf=&quot;st-marble_hole&quot;, alg=&quot;outside&quot;}},
+[98]={box=&quot;st-rock1_move&quot;, wall=&quot;st-redrock&quot;, inf=&quot;fl-acblack&quot;,
+      outf={&quot;fl-acblack&quot;, &quot;st-redrock&quot;}, door=&quot;st-rock6&quot;, oxyd=&quot;b&quot;,
+      endp={goal=&quot;st-rock6&quot;, open_door=&quot;st-none&quot;, alg=&quot;vortex&quot;}},
+[99]={box=&quot;st-glass1_move&quot;, wall=&quot;st-redrock&quot;, inf=&quot;fl-mortar&quot;,
+      outf=&quot;fl-brick&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;b&quot;,
+      endp={goal=&quot;st-glass1_hole&quot;, wall={&quot;st-glass1_hole&quot;, &quot;fl-tigris&quot;}, alg=&quot;outside&quot;}},
+[100]={box=&quot;st-block&quot;, wall=&quot;st-redrock&quot;, inf=&quot;fl-mortar&quot;,
+       outf=&quot;fl-water&quot;, door=&quot;st-door&quot;, oxyd=&quot;b&quot;,
+       endp={goal={&quot;fl-swamp&quot;, &quot;it-none&quot;}, alg=&quot;ralf&quot;}},
+[101]={box=&quot;st-glass2_move&quot;, wall=&quot;st-redrock&quot;, inf=&quot;fl-leavesb&quot;,
+       outf={&quot;fl-leavesc3&quot;, &quot;fl-leavesd4&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;a&quot;,
+       endp={goal=&quot;st-glass1_hole&quot;, alg=&quot;hide&quot;}},
+[102]={box=&quot;st-camouflage_move&quot;, wall=&quot;st-rock2&quot;, inf=&quot;fl-rock&quot;,
+       outf={&quot;fl-rock&quot;, &quot;st-disco-medium&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;b&quot;,
+       endp={goal={&quot;it-none&quot;, &quot;st-disco-light&quot;, &quot;fl-leavesb&quot;},
+             wall={&quot;st-disco-light&quot;, &quot;fl-gray&quot;}, alg=&quot;outside:3&quot;}},
+[103]={box=&quot;st-glass2_move&quot;, wall=&quot;st-rock2&quot;, inf=&quot;fl-stone&quot;,
+       outf={&quot;fl-water&quot;, &quot;st-disco-medium&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;b&quot;,
+       endp={goal={&quot;st-pull&quot;, &quot;it-none&quot;, &quot;fl-black&quot;}, alg=&quot;fourswitch&quot;}},
+[104]={box=&quot;st-wood&quot;, wall=&quot;st-rock2&quot;, inf=&quot;fl-lightgray&quot;,
+       outf=&quot;fl-space&quot;, door=&quot;st-door&quot;, oxyd=&quot;b&quot;,
+       endp={goal={&quot;st-none&quot;, &quot;fl-marble&quot;, &quot;it-none&quot;}, alg=&quot;knock&quot;}},
+[105]={box=&quot;st-camouflage_move&quot;, wall=&quot;st-rock7&quot;, inf=&quot;fl-woven&quot;,
+       outf=&quot;fl-gravel&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;a&quot;,
+       endp={goal={&quot;fl-bluegreenx&quot;, &quot;it-none&quot;, &quot;st-none&quot;}, alg=&quot;magnets&quot;}},
+[106]={box=&quot;st-brownie&quot;, wall=&quot;st-rock7&quot;, inf=&quot;fl-black&quot;,
+       outf=&quot;fl-abyss&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;b&quot;,
+       endp={goal=&quot;st-bug&quot;, give={&quot;ac-bug&quot;, &quot;it-hammer&quot;}, alg=&quot;block:st-plain_cracked&quot;}},
+[107]={box=&quot;st-glass_move&quot;, wall=&quot;st-rock8&quot;, inf=&quot;fl-plank&quot;,
+       outf={&quot;fl-plank&quot;, &quot;st-rock8&quot;}, door=&quot;st-door&quot;, oxyd=&quot;d&quot;,
+       endp={goal=&quot;st-explosion&quot;, alg=&quot;knock&quot;}},
+[108]={box=&quot;st-glass2_move&quot;, wall={&quot;st-rock8&quot;, &quot;fl-water&quot;}, inf=&quot;fl-leaves&quot;,
+       outf=&quot;fl-water&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;c&quot;,
+       endp={goal=&quot;st-pull&quot;, give=&quot;it-hammer&quot;, alg=&quot;block:st-break_gray&quot;}},
+[109]={box=&quot;st-marble_move&quot;, wall={&quot;st-rock8&quot;, &quot;fl-abyss_fake&quot;}, inf=&quot;fl-stone&quot;,
+       outf=&quot;fl-space&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;c&quot;,
+       endp={goal={&quot;st-none&quot;, &quot;it-none&quot;, &quot;fl-hay&quot;}, wall={&quot;st-none&quot;, &quot;fl-darkgray&quot;},
+             alg=&quot;outside:3&quot;}},
+[110]={box=&quot;st-greenbrown_move&quot;, wall=&quot;st-rock9&quot;, inf=&quot;fl-rock&quot;,
+       outf={&quot;fl-rock&quot;, &quot;st-rock9&quot;}, door=&quot;st-rock9&quot;, oxyd=&quot;b&quot;,
+       endp={goal=&quot;st-rock9&quot;, open_door=&quot;st-none&quot;, alg=&quot;vortex&quot;}},
+[111]={box=&quot;st-glass_move&quot;, wall=&quot;st-rock9&quot;, inf=&quot;fl-sand&quot;,
+       outf=&quot;fl-water&quot;, door=&quot;st-door_c&quot;, oxyd=&quot;c&quot;,
+       endp={goal=&quot;st-grate2&quot;, alg=&quot;ralf&quot;}},
+[112]={box=&quot;st-camouflage_move&quot;, wall=&quot;st-rock9&quot;, inf=&quot;fl-stone&quot;,
+       outf=&quot;fl-swamp&quot;, door=&quot;st-door&quot;, oxyd=&quot;a&quot;,
+       endp={goal=&quot;st-camouflage_hole&quot;, alg=&quot;knock&quot;}},
+[113]={box=&quot;st-block&quot;, wall=&quot;st-rock10&quot;, inf=&quot;fl-bluegreen&quot;,
+       outf=&quot;fl-abyss&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;a&quot;,
+       endp={goal={&quot;st-explosion&quot;, &quot;it-none&quot;, &quot;fl-bluegreenx&quot;},
+             wall={&quot;st-explosion&quot;, &quot;fl-marble&quot;}, give=&quot;it-umbrella&quot;, alg=&quot;outside:1&quot;}},
+[114]={box=&quot;st-wood&quot;, wall=&quot;st-rock10&quot;, inf=&quot;fl-sand&quot;,
+       outf={&quot;fl-sand&quot;, &quot;st-rock10&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;b&quot;,
+       endp={goal={&quot;fl-swamp&quot;, &quot;it-none&quot;}, give=&quot;it-sword&quot;, alg=&quot;block:st-knight&quot;}},
+[115]={box=&quot;st-glass2_move&quot;, wall=&quot;st-stone1&quot;, inf={&quot;fl-lightgray&quot;, &quot;fl-white&quot;},
+       outf={&quot;fl-space&quot;, &quot;fl-abyss&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;a&quot;,
+       endp={goal=&quot;st-glass1_hole&quot;, wall=&quot;st-grate1&quot;, give=&quot;it-umbrella&quot;,
+             open_door=&quot;st-grate1&quot;, alg=&quot;block:st-stone1&quot;}},
+[116]={box=&quot;st-rock1_move&quot;, wall=&quot;st-stone1&quot;, inf=&quot;fl-stwood&quot;,
+       outf=&quot;fl-water&quot;, door=&quot;st-stone1&quot;, oxyd=&quot;b&quot;,
+       endp={goal=&quot;st-rock1_hole&quot;, open_door=&quot;st-grate1&quot;, alg=&quot;ralf&quot;}},
+[117]={box=&quot;st-glass_move&quot;, wall=&quot;st-stone1&quot;, inf=&quot;fl-black&quot;,
+       outf=&quot;st-stone1&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;d&quot;,
+       endp={outf=&quot;st-likeoxydd&quot;, wall=&quot;st-likeoxydd&quot;, inf=&quot;fl-ice&quot;,
+             goal={&quot;st-none&quot;, &quot;it-none&quot;, &quot;fl-ice&quot;}, alg=&quot;hide:1&quot;}},
+[118]={box=&quot;st-glass_move&quot;, wall=&quot;st-stone2&quot;, inf=&quot;fl-black&quot;,
+       outf=&quot;fl-gravel&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;b&quot;,
+       endp={goal=&quot;st-glass&quot;, alg=&quot;vortex&quot;}},
+[119]={box=&quot;st-block&quot;, wall=&quot;st-stone2&quot;, inf=&quot;fl-rough-red&quot;,
+       outf={&quot;fl-rough-blue&quot;, &quot;st-disco-light&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;d&quot;,
+       endp={goal=&quot;st-none&quot;, alg=&quot;allcrack:1&quot;}},
+[120]={box=&quot;st-rock3_move&quot;, wall={&quot;st-marble&quot;, &quot;st-stone2&quot;}, inf=&quot;fl-black&quot;,
+       outf={&quot;st-marble&quot;, &quot;st-stone2&quot;}, oxyd=&quot;b&quot;,
+       endp={goal=&quot;st-plain_cracked&quot;, give=&quot;it-hammer&quot;, open_door=&quot;st-none&quot;,
+             alg=&quot;ralf&quot;}},
+[121]={box=&quot;st-wood&quot;, wall=&quot;st-panel&quot;, inf=&quot;fl-wood&quot;,
+       outf={&quot;fl-leavesd3&quot;, &quot;fl-leavesd2&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;a&quot;,
+       endp={goal={&quot;it-none&quot;, &quot;fl-swamp&quot;}, open_door=&quot;fl-swamp&quot;, alg=&quot;block:st-wood&quot;}},
+[122]={box=&quot;st-block&quot;, wall=&quot;st-panel&quot;, inf=&quot;fl-leaves&quot;,
+       outf=&quot;fl-leavesb&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;a&quot;,
+       endp={goal={&quot;it-none&quot;, &quot;fl-swamp&quot;}, alg=&quot;fourswitch&quot;}},
+[123]={box=&quot;st-glass1_move&quot;, wall=&quot;st-woven&quot;, inf=&quot;fl-dunes&quot;,
+       outf=&quot;fl-bluegreen&quot;, door=&quot;st-glass1&quot;, oxyd=&quot;a&quot;,
+       endp={goal=&quot;st-pull&quot;, open_door=&quot;st-pull&quot;, alg=&quot;ralf&quot;}},
+[124]={box=&quot;st-marble_move&quot;, wall=&quot;st-woven&quot;, inf=&quot;fl-hay&quot;,
+       outf=&quot;fl-water&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;a&quot;,
+       endp={goal=&quot;st-marble_hole&quot;, wall={&quot;st-none&quot;, &quot;fl-woven&quot;},
+       give=&quot;it-umbrella&quot;, alg=&quot;outside:1&quot;}},
+[125]={box=&quot;st-rock3_move&quot;, wall=&quot;st-yellow&quot;, inf=&quot;fl-leavesb&quot;,
+       outf=&quot;fl-leaves&quot;, door=&quot;st-door_c&quot;, oxyd=&quot;a&quot;,
+       endp={goal=&quot;st-grate2&quot;, alg=&quot;ralf&quot;}},
+[126]={box=&quot;st-glass_move&quot;, wall=&quot;st-yellow&quot;, inf=&quot;fl-rough-blue&quot;,
+       outf=&quot;fl-abyss&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;d&quot;,
+       endp={goal={&quot;st-none&quot;, &quot;it-none&quot;, &quot;fl-ice&quot;}, give=&quot;ac-bug&quot;, alg=&quot;block:st-bug&quot;}},
+[127]={box=&quot;st-block&quot;, wall=&quot;st-yellow&quot;, inf=&quot;fl-lightgray&quot;,
+       outf=&quot;fl-space&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;d&quot;,
+       endp={goal={&quot;fl-abyss&quot;, &quot;it-none&quot;}, alg=&quot;vortex&quot;}},
+[128]={box=&quot;st-glass1_move&quot;, wall=&quot;st-rock7&quot;, inf=&quot;fl-himalaya&quot;,
+       outf={&quot;fl-himalaya&quot;, &quot;st-rock8&quot;, &quot;st-rock7&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;d&quot;,
+       endp={goal=&quot;st-explosion&quot;, alg=&quot;magnets&quot;}},
 [129]={box=&quot;st-camouflage_move&quot;, wall={&quot;st-rock9&quot;, &quot;fl-leavesb&quot;}, inf=&quot;fl-dunes&quot;,
-       outf={&quot;fl-leavese1&quot;, &quot;fl-leavese2&quot;, &quot;fl-leavese3&quot;, &quot;fl-leavese4&quot;, &quot;al:waves&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;d&quot;},
+       outf={&quot;fl-leavese1&quot;, &quot;fl-leavese2&quot;, &quot;fl-leavese3&quot;, &quot;fl-leavese4&quot;, &quot;al:waves&quot;},
+       door={&quot;fl-bridge_x&quot;, &quot;fl-bridge_y&quot;, &quot;al:random&quot;, &quot;st-none&quot;}, oxyd=&quot;d&quot;,
+       endp={goal=&quot;st-camouflage_hole&quot;, alg=&quot;ralf&quot;}},
 [130]={box=&quot;st-glass1_move&quot;, wall=&quot;st-redrock&quot;, inf=&quot;fl-darkgray&quot;,
-       outf={&quot;fl-black&quot;, &quot;st-redrock&quot;, &quot;st-invisible&quot;, &quot;st-invisible&quot;, &quot;st-invisible&quot;, &quot;al:waves&quot;},
-       door=&quot;st-door_a&quot;, oxyd=&quot;a&quot;},
-[131]={box=&quot;st-glass1_move&quot;, wall={&quot;st-yellow&quot;, &quot;st-yellow&quot;, &quot;st-redrock&quot;, &quot;st-redrock&quot;, &quot;al:waves&quot;}, inf=&quot;fl-wood&quot;,
-       outf={&quot;fl-wood&quot;, &quot;st-yellow&quot;, &quot;st-yellow&quot;, &quot;st-redrock&quot;, &quot;st-redrock&quot;, &quot;al:waves&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;d&quot;},
-[132]={box=&quot;st-wood&quot;, wall=&quot;st-camouflage&quot;, inf=&quot;fl-leavesb&quot;,
-       outf={&quot;fl-water&quot;, &quot;fl-swamp&quot;, &quot;fl-water&quot;, &quot;fl-water&quot;, &quot;al:random&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;b&quot;},
+       outf={&quot;fl-black&quot;, &quot;st-redrock&quot;, &quot;st-invisible:3&quot;, &quot;al:waves&quot;},
+       door=&quot;st-door_a&quot;, oxyd=&quot;a&quot;,
+       endp={goal=&quot;st-none&quot;, alg=&quot;gradients&quot;}},
+[131]={box=&quot;st-glass1_move&quot;, wall={&quot;st-yellow&quot;, &quot;st-yellow&quot;, &quot;st-redrock&quot;, &quot;st-redrock&quot;, &quot;al:waves&quot;},
+       inf=&quot;fl-wood&quot;,
+       outf={&quot;fl-wood&quot;, &quot;st-yellow&quot;, &quot;st-yellow&quot;, &quot;st-redrock&quot;, &quot;st-redrock&quot;, &quot;al:waves&quot;},
+       door=&quot;st-door_a&quot;, oxyd=&quot;d&quot;,
+       endp={goal={&quot;st-glass1_hole&quot;}, give=&quot;it-hammer&quot;, alg=&quot;block:st-plain_break&quot;}},
+[132]={box=&quot;st-wood&quot;, wall=&quot;st-camouflage&quot;, inf=&quot;fl-leavesb&quot;, oxyd=&quot;d&quot;,
+       outf={&quot;fl-water:3&quot;, &quot;fl-swamp&quot;,&quot;al:random&quot;}, door={&quot;fl-water&quot;, &quot;st-glass1_hole&quot;},
+       endp={goal={&quot;fl-swamp&quot;, &quot;it-none&quot;}, inf={&quot;fl-leavesb&quot;, &quot;fl-swamp&quot;, &quot;al:random&quot;}, 
+             open_door=&quot;fl-swamp&quot;, alg=&quot;ralf&quot;}},
 [133]={box=&quot;st-glass2_move&quot;, wall=&quot;st-metal&quot;, inf=&quot;fl-metal&quot;,
-       outf={&quot;fl-space&quot;, &quot;fl-abyss&quot;, &quot;fl-abyss&quot;, &quot;fl-abyss&quot;, &quot;al:random&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;d&quot;},
+       outf={&quot;fl-space&quot;, &quot;fl-abyss:3&quot;, &quot;al:random&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;d&quot;,
+       endp={goal=&quot;st-glass1_hole&quot;, give=&quot;it-sword&quot;, alg=&quot;block:st-knight&quot;}},
 [134]={box=&quot;st-marble_move&quot;, wall=&quot;st-metal&quot;, inf=&quot;fl-white&quot;,
-       outf={&quot;fl-abyss&quot;, &quot;st-grate1&quot;, &quot;st-invisible&quot;, &quot;st-invisible&quot;, &quot;st-invisible&quot;, &quot;al:waves&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;d&quot;},
+       outf={&quot;fl-abyss&quot;, &quot;st-grate1&quot;, &quot;st-invisible:3&quot;, &quot;al:waves&quot;},
+       door=&quot;st-door_a&quot;, oxyd=&quot;d&quot;,
+       endp={goal=&quot;st-marble_hole&quot;, alg=&quot;fourswitch&quot;}},
 [135]={box=&quot;st-glass_move&quot;, wall=&quot;st-likeoxydc&quot;, inf=&quot;fl-white&quot;,
-       outf={&quot;fl-white&quot;, &quot;st-rock1&quot;, &quot;st-invisible&quot;, &quot;st-invisible&quot;, &quot;st-invisible&quot;, &quot;al:random&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;c&quot;},
-[136]={box=&quot;st-block&quot;, wall={&quot;st-oneway_white-n&quot;, &quot;st-oneway_white-s&quot;, &quot;st-oneway_white-e&quot;, &quot;st-oneway_white-w&quot;, &quot;al:random&quot;}, inf=&quot;fl-rough&quot;,
-       outf={&quot;st-oneway_white-n&quot;, &quot;st-oneway_white-s&quot;, &quot;st-oneway_white-e&quot;, &quot;st-oneway_white-w&quot;, &quot;al:random&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;d&quot;},
+       outf={&quot;fl-white&quot;, &quot;st-rock1&quot;, &quot;st-invisible:3&quot;, &quot;al:random&quot;},
+       door=&quot;st-door_a&quot;, oxyd=&quot;c&quot;,
+       endp={goal={&quot;st-glass1_hole&quot;, &quot;it-none&quot;}, alg=&quot;hide&quot;}},
+[136]={box=&quot;st-block&quot;, wall={&quot;st-oneway_white-n&quot;, &quot;st-oneway_white-s&quot;, &quot;st-oneway_white-e&quot;, &quot;st-oneway_white-w&quot;, &quot;al:random&quot;},
+       inf=&quot;fl-rough&quot;, oxyd=&quot;b&quot;,
+       outf={&quot;st-oneway_white-n&quot;, &quot;st-oneway_white-s&quot;, &quot;st-oneway_white-e&quot;, &quot;st-oneway_white-w&quot;, &quot;al:random&quot;},
+       endp={alg=&quot;circle&quot;}},
 [137]={box={&quot;st-mirror-p-m&quot;, &quot;st-mirror-p/m&quot;, &quot;st-mirror-p\\m&quot;, &quot;st-mirror-p|m&quot;, &quot;al:random&quot;},
-       wall={&quot;st-glass3&quot;, &quot;fl-abyss&quot;}, inf=&quot;fl-metal&quot;,
-       outf={&quot;st-mirror-p-&quot;, &quot;st-mirror-p/&quot;, &quot;st-mirror-p|&quot;, &quot;st-mirror-p\\&quot;, &quot;al:random&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;b&quot;},
-[138]={box=&quot;st-shogun-s&quot;, wall=&quot;st-panel&quot;, inf=&quot;fl-stwood&quot;, outf=&quot;fl-water&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;d&quot;},
-[139]={box=&quot;st-shogun-s&quot;, wall={&quot;st-white4&quot;, &quot;fl-springboard&quot;, &quot;fl-abyss_fake&quot;}, inf={&quot;fl-springboard&quot;, &quot;fl-abyss_fake&quot;},
-       outf={&quot;st-white1&quot;, &quot;st-black1&quot;, &quot;fl-springboard&quot;, &quot;fl-abyss_fake&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;b&quot;},
+       wall={&quot;st-glass3&quot;, &quot;fl-abyss&quot;}, inf=&quot;fl-metal&quot;, oxyd=&quot;b&quot;,
+       outf={&quot;st-mirror-p-&quot;, &quot;st-mirror-p/&quot;, &quot;st-mirror-p|&quot;, &quot;st-mirror-p\\&quot;, &quot;al:random&quot;},
+       door=&quot;st-glass3&quot;,
+       endp={goal={&quot;st-none&quot;, &quot;it-none&quot;, &quot;fl-darkgray&quot;},
+             open_door=&quot;st-glass1_hole&quot;, alg=&quot;ralf&quot;}},
+[138]={box=&quot;st-shogun-s&quot;, wall=&quot;st-panel&quot;, inf=&quot;fl-stwood&quot;, goal=&quot;it-shogun-s&quot;,
+       outf=&quot;fl-water&quot;, oxyd=&quot;a&quot;,
+       endp={goal=&quot;st-none&quot;, alg=&quot;ralf&quot;, open_door=&quot;st-none&quot;}},
+[139]={box=&quot;st-shogun-s&quot;, wall=&quot;st-blocker&quot;, inf=&quot;fl-black&quot;,
+       outf={&quot;st-white1&quot;, &quot;st-black1&quot;, &quot;fl-springboard&quot;, &quot;fl-abyss_fake&quot;},
+       door=&quot;st-blocker&quot;, oxyd=&quot;b&quot;,
+       endp={goal={&quot;st-none&quot;, &quot;it-none&quot;}, inf={&quot;fl-springboard&quot;, &quot;fl-abyss_fake&quot;},
+             alg=&quot;ralf&quot;}},
 [140]={box=&quot;st-brownie&quot;, wall={&quot;st-stone1&quot;, &quot;fl-leavesb&quot;}, inf={&quot;fl-floor_001&quot;, &quot;fr:3.0&quot;},
-       outf={&quot;fl-leavese4&quot;, &quot;fl-leavese2&quot;, &quot;fl-leavese1&quot;, &quot;fl-leavese3&quot;, &quot;al:waves&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;d&quot;},
+       outf={&quot;fl-leavese4&quot;, &quot;fl-leavese2&quot;, &quot;fl-leavese1&quot;, &quot;fl-leavese3&quot;, &quot;al:waves&quot;},
+       door=&quot;st-door_a&quot;, oxyd=&quot;d&quot;,
+       endp={goal={&quot;st-grate1&quot;, &quot;it-none&quot;}, alg=&quot;fourswitch&quot;}},
 [141]={box=&quot;st-brownie&quot;, wall={&quot;st-rock4&quot;, &quot;fl-leavesb&quot;}, inf={&quot;fl-bluegreenx&quot;, &quot;mf:1.0&quot;, &quot;fr:3.0&quot;},
-       outf={&quot;fl-water&quot;, &quot;st-rock10&quot;, &quot;st-invisible&quot;, &quot;st-invisible&quot;, &quot;st-invisible&quot;, &quot;al:waves&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;d&quot;},
+       outf={&quot;fl-water&quot;, &quot;st-rock10&quot;, &quot;st-invisible:3&quot;, &quot;al:waves&quot;},
+       door=&quot;st-door_a&quot;, oxyd=&quot;d&quot;,
+       endp={goal=&quot;st-none&quot;, give=&quot;it-sword&quot;, alg=&quot;block:st-knight&quot;}},
 [142]={box=&quot;st-glass2_move&quot;, wall={&quot;st-glass1&quot;, &quot;fl-leavesb&quot;}, inf=&quot;fl-leavesb&quot;,
-       outf={&quot;fl-leavesc4&quot;, &quot;fl-leavesd2&quot;, &quot;fl-leavesc2&quot;, &quot;fl-leavese3&quot;, &quot;al:waves&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;d&quot;},
+       outf={&quot;fl-leavesc4&quot;, &quot;fl-leavesd2&quot;, &quot;fl-leavesc2&quot;, &quot;fl-leavese3&quot;, &quot;al:waves&quot;},
+       door=&quot;st-door_a&quot;, oxyd=&quot;d&quot;,
+       endp={goal=&quot;st-glass1_hole&quot;, alg=&quot;hide&quot;}},
 [143]={box=&quot;st-block&quot;, wall={&quot;st-rock5&quot;, &quot;fl-stwood&quot;}, inf=&quot;fl-wood&quot;,
-       outf={&quot;st-disco-light&quot;, &quot;fl-wood1&quot;, &quot;fl-wood1&quot;, &quot;fl-wood1&quot;, &quot;fl-wood2&quot;, &quot;al:waves&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;a&quot;},
+       outf={&quot;st-disco-light&quot;, &quot;fl-wood1:3&quot;, &quot;fl-wood2&quot;, &quot;al:waves&quot;},
+       door=&quot;st-door_a&quot;, oxyd=&quot;a&quot;,
+       endp={goal={&quot;fl-abyss&quot;, &quot;it-none&quot;}, alg=&quot;vortex&quot;}},
 [144]={box=&quot;st-wood&quot;, wall=&quot;st-rock6&quot;, inf=&quot;fl-bluegreen&quot;,
-       outf={&quot;fl-space&quot;, &quot;it-squashed&quot;, &quot;it-sensor&quot;, &quot;it-sensor&quot;, &quot;it-sensor&quot;, &quot;al:random&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;d&quot;},
+       outf={&quot;fl-space&quot;, &quot;it-squashed&quot;, &quot;it-none:3&quot;, &quot;al:random&quot;},
+       door=&quot;st-door_a&quot;, oxyd=&quot;d&quot;,
+       endp={goal=&quot;st-glass2_hole&quot;, wall=&quot;st-glass1_hole&quot;, alg=&quot;outside:3&quot;}},
 [145]={box=&quot;st-glass1_move&quot;, wall={&quot;st-greenbrown&quot;, &quot;fl-sand&quot;}, inf=&quot;fl-dunes&quot;,
-       outf={&quot;fl-sand&quot;, &quot;it-landmine&quot;, &quot;it-booze-broken&quot;, &quot;it-none&quot;, &quot;it-none&quot;, &quot;it-none&quot;, &quot;it-none&quot;, &quot;it-none&quot;, &quot;it-none&quot;, &quot;al:random&quot;},
-       door=&quot;st-door_a&quot;, oxyd=&quot;a&quot;},
+       outf={&quot;fl-sand&quot;, &quot;it-landmine:3&quot;, &quot;it-booze-broken&quot;, &quot;it-none:15&quot;, &quot;al:random&quot;},
+       door=&quot;st-door_a&quot;, oxyd=&quot;a&quot;,
+       endp={goal=&quot;st-glass1_hole&quot;, alg=&quot;allcrack:1&quot;}},
 [146]={box=&quot;st-wood&quot;, wall=&quot;st-rock1&quot;, inf=&quot;fl-black&quot;,
-       outf={&quot;fl-abyss&quot;, &quot;st-grate1&quot;, &quot;st-none&quot;, &quot;st-none&quot;, &quot;st-none&quot;, &quot;st-none&quot;, &quot;st-none&quot;, &quot;st-none&quot;,
-       &quot;st-none&quot;, &quot;st-none&quot;, &quot;st-none&quot;, &quot;st-none&quot;, &quot;al:random&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;c&quot;, white = true},
+       outf={&quot;fl-abyss&quot;, &quot;st-grate1&quot;, &quot;st-none:10&quot;, &quot;al:random&quot;},
+       door=&quot;st-door_a&quot;, oxyd=&quot;b&quot;, white = true,
+       endp={goal={&quot;st-grate1&quot;, &quot;it-none&quot;}, alg=&quot;magnets&quot;}},
 [147]={box=&quot;st-wood&quot;, wall=&quot;st-whiteballs&quot;, inf=&quot;fl-gray&quot;, white = true,
        outf={&quot;fl-gradient5&quot;, &quot;fl-gradient6&quot;, &quot;fl-gradient7&quot;, &quot;fl-gradient8&quot;, &quot;al:waves&quot;},
        door=&quot;st-door_a&quot;, oxyd=&quot;a&quot;,
        endp={goal={&quot;st-none&quot;, &quot;it-none&quot;}, alg=&quot;gradients&quot;}},
 [148]={box=&quot;st-shogun-s&quot;, wall=&quot;st-metal&quot;, inf=&quot;fl-rough-blue&quot;, white = true,
-       outf={&quot;fl-rough-red&quot;, &quot;fl-rough-blue&quot;, &quot;st-disco-light&quot;}, door=&quot;st-door_a&quot;, oxyd=&quot;a&quot;},
-[149]={box=&quot;st-shogun-s&quot;, wall=&quot;st-yellow&quot;, inf=&quot;fl-wood&quot;, outf=&quot;fl-swamp&quot;, door=&quot;st-door_a&quot;,
-       oxyd=&quot;c&quot;, goal=&quot;it-shogun-s&quot;, white = true},
+       outf={&quot;fl-rough-red&quot;, &quot;fl-rough-blue&quot;, &quot;st-disco-light&quot;},
+       door=&quot;st-door_a&quot;, oxyd=&quot;a&quot;,
+       endp={goal=&quot;st-break_acblack&quot;, give=&quot;it-hammer&quot;, alg=&quot;block:st-break_acblack&quot;}},
+[149]={box=&quot;st-shogun-s&quot;, wall=&quot;st-yellow&quot;, inf=&quot;fl-samba&quot;,
+       outf=&quot;fl-swamp&quot;, door=&quot;st-door_a&quot;,
+       oxyd=&quot;c&quot;, goal=&quot;it-shogun-s&quot;, white = true,
+       endp={goal=&quot;st-explosion&quot;, wall={&quot;st-explosion&quot;, &quot;fl-tigris&quot;}, alg=&quot;outside&quot;}},
+
 [150]={box=&quot;st-flrock&quot;, wall=&quot;st-redrock&quot;, inf=&quot;fl-brick&quot;,
-       outf=&quot;fl-space&quot;, door=&quot;st-door_a&quot;, oxyd=&quot;c&quot;, white=true},
+       outf=&quot;fl-space&quot;, door=&quot;st-blocker&quot;, oxyd=&quot;a&quot;, white=true,
+       endp={goal={&quot;fl-abyss&quot;, &quot;it-none&quot;}, alg=&quot;ralf&quot;}},
 }
 
+-- endp-algs: circle, ralf, hide, outside, allcrack, block, fourswitch
+--            vortex, gradients, magnets
+
+
 -- The 75 first designs use the following boxes:
 --  st-block  -&gt;  st-black, st-blocker, st-brake, st-laser, fl-swamp
 --  st-brownie  -&gt;  st-coinslot, st-pull

Modified: trunk/data/levels/lib/libsoko-endphase.xml
===================================================================
--- trunk/data/levels/lib/libsoko-endphase.xml	2007-11-10 20:10:07 UTC (rev 923)
+++ trunk/data/levels/lib/libsoko-endphase.xml	2007-11-11 01:59:08 UTC (rev 924)
@@ -47,10 +47,10 @@
     enigma.SetAttrib(sender, &quot;_box&quot;, 0)
     sokoarea[nr].goals_filled = sokoarea[nr].goals_filled - 1
   end
-  
+
   -- Call goal_hook, e.g. for algorithms &quot;ralf&quot; and &quot;allcrack&quot;.
-  if type(goal_hook) == &quot;function&quot; then
-    goal_hook(nr, sender, more_boxes, sokoarea[nr].goals_filled,
+  if type(sokoarea[nr].goal_hook) == &quot;function&quot; then
+    sokoarea[nr].goal_hook(nr, sender, more_boxes, sokoarea[nr].goals_filled,
               sokoarea[nr].number_goals)
   end
   
@@ -66,21 +66,26 @@
 end
 
 function prepare_endphase(sokoarea_number)
+  local nr = sokoarea_number
   -- ensure existence of goals
-  if sokoarea[1].number_goals &lt; 1 then
+  if sokoarea[nr].number_goals &lt; 1 then
     myerror(&quot;No goals defined!\n&quot;)
   end
   -- ensure a correctly set endphase-attribute
-  local endp = sokoarea[sokoarea_number].design.endp
+  local endp = sokoarea[nr].design.endp
   if not endp then
-    endp = {alg = &quot;circle&quot;}
-    sokoarea[sokoarea_number].design.endp = endp
+    endp = default_design.endp
+    sokoarea[nr].design.endp = endp
   end
   if type(endp) ~= &quot;table&quot; then
     myerror(&quot;This design's endphase is given as &quot;..type(endp)
             ..&quot;, should be table.&quot;)
   end
   local alg = endp.alg
+  if alg == nil then
+    alg = default_design.endp.alg
+    sokoarea[nr].design.endp.alg = alg
+  end
   if type(alg) ~= &quot;string&quot; then
     myerror(&quot;This design's endphase algorithm is given as &quot;..type(alg)
             ..&quot;, should be string.&quot;)
@@ -98,21 +103,26 @@
   if     (alg == &quot;circle&quot;)
       or (alg == &quot;hide&quot;)
       or (alg == &quot;fourswitch&quot;)
-      or (alg == &quot;vortex&quot;)
       or (alg == &quot;gradients&quot;)
       or (alg == &quot;magnets&quot;) then
     -- nothing to prepare
   elseif (alg == &quot;ralf&quot;)
-      or (alg == &quot;allcrack&quot;) then
-    endphase_set_block_oxyds(sokoarea_number, sokoarea[sokoarea_number].design.door)
-    goal_hook = endphase_goal_hook_ralf
-  elseif alg == &quot;block&quot; then
-    endphase_set_block_oxyds(sokoarea_number, param)
+      or (alg == &quot;allcrack&quot;)
+      or (alg == &quot;vortex&quot;) then
+    endphase_set_block_oxyds(nr, (sokoarea[nr].design.door or
+        sokoarea[nr].design.wall or &quot;st-none&quot;), param)
+    sokoarea[nr].goal_hook = endphase_goal_hook_ralf
+  elseif (alg == &quot;block&quot;) then
+    endphase_set_block_oxyds(nr, param)
   elseif (alg == &quot;outside&quot;) then
-    endphase_set_outside_oxyds(sokoarea_number, param)
-  elseif alg == &quot;jumpyoxyds&quot; then
-    endphase_set_block_oxyds(sokoarea_number, &quot;jumpy&quot;)
-    goal_hook = endphase_goal_hook_ralf
+    endphase_set_outside_oxyds(nr, param)
+  elseif (alg == &quot;knock&quot;) then
+    endphase_set_block_oxyds(nr, sokoarea[nr].design.door, 3)
+    endphase_set_knock_items(nr, param)
+  -- &quot;Jumpyoxyds&quot; deactivated for once
+  --elseif (alg == &quot;jumpyoxyds&quot;) then
+  --  endphase_set_block_oxyds(nr, &quot;jumpy&quot;)
+  --  goal_hook = endphase_goal_hook_ralf
   else
     mywarning(&quot;Endphase algorithm &quot;..alg..&quot; unknown! Will use 'circle' instead.&quot;)
   end
@@ -146,10 +156,18 @@
   end
   if type(give) == &quot;table&quot; then
     for k, v in pairs(give) do
-      if is_item(v) then
-        set_item(v, px, py)
+      if is_item(v) or is_stone(v) or is_floor(v) then
+        set_element(px, py, sokoarea_number, &quot;&quot;, v)
       elseif is_actor(v) then
         set_actor(v, px + 0.5, py + 0.5)
+      elseif v == &quot;rubberball&quot; then
+        local old_actor = enigma.GetNamedObject(&quot;marble_&quot;..sokoarea_number..&quot;_1&quot;)
+        local actor_kind = &quot;ac-whiteball&quot;
+        if sokoarea[sokoarea_number].design.white then
+          actor_kind = &quot;ac-blackball&quot;
+        end
+        local new_actor = set_actor(actor_kind, px+0.5, py+0.5, {controllers=0})
+        AddRubberBand(old_actor, new_actor, 50, 0)
       else
         myerror(&quot;Can't give &quot;..v..&quot;.&quot;)
       end
@@ -161,24 +179,29 @@
   if alg == &quot;circle&quot; then
     endphase_circle(sokoarea_number)
   elseif alg == &quot;hide&quot; then
-    endphase_set_hide_oxyds(sokoarea_number)  
+    endphase_set_hide_oxyds(sokoarea_number, param)
   elseif    (alg == &quot;ralf&quot;)
          or (alg == &quot;outside&quot;)
-         or (alg == &quot;block&quot;)
-         or (alg == &quot;jumpyoxyds&quot;) then
+         --or (alg == &quot;jumpyoxyds&quot;)
+         or (alg == &quot;block&quot;) then
     endphase_ralf_open_doors(sokoarea_number)
   elseif alg == &quot;allcrack&quot; then
+    endphase_ralf_open_doors(sokoarea_number)
     endphase_allcrack(sokoarea_number)
   elseif alg == &quot;fourswitch&quot; then
     endphase_fourswitch(sokoarea_number)
   elseif alg == &quot;vortex&quot; then
-    -- ?
+    endphase_ralf_open_doors(sokoarea_number)
+    endphase_vortex(sokoarea_number)
   elseif alg == &quot;gradients&quot; then
     endphase_set_hide_oxyds(sokoarea_number)
     endphase_gradients(sokoarea_number, param)
   elseif alg == &quot;magnets&quot; then
     endphase_set_hide_oxyds(sokoarea_number)
     endphase_magnets(sokoarea_number, param)
+  elseif alg == &quot;knock&quot; then
+    -- don't do anything; endphase_call_knock_item
+    -- queries endphase_started.
   else
     -- use default: &quot;circle&quot;
     endphase_circle(sokoarea_number)
@@ -191,24 +214,45 @@
   local dx = sokoarea[nr].offset.x
   local dy = sokoarea[nr].offset.y
 
+  -- small routine to check the walls and outside
+  local function is_oxyd_or_blocker(x,y)
+    if sokoarea[nr].list_oxyd[x..&quot;/&quot;..y] then
+      return true
+    elseif sokoarea[nr].list_blocker[x..&quot;/&quot;..y] then
+      return true
+    end
+    return false
+  end
+  
   -- redraw outside
   for p, v in pairs(sokoarea[nr].list_outside) do
-    set_element(v.lx, v.ly, nr, k, endp.outf)
+    if not is_oxyd_or_blocker(v.lx, v.ly) then
+      set_element(v.lx, v.ly, nr, k, endp.outf)
+    end
   end
-
+  
   -- redraw the rest inside level_array:
   for y = 0, sokoarea[nr].array_height - 1 do
     for x = 0, sokoarea[nr].array_width - 1 do
-      local ch = sokoarea[nr].level_array[y+1][x+1]
-      for k, v in pairs(endp) do
-        if    ((k == &quot;inf&quot;)  and char_is_inf(ch))
-           or ((k == &quot;wall&quot;) and char_is_wall(ch))
-           or ((k == &quot;goal&quot;) and char_is_goal(ch)) then
-          set_element(x+dx, y+dy, nr, k, v)
+      if not is_oxyd_or_blocker(x+dx, y+dy) then
+        local ch = sokoarea[nr].level_array[y+1][x+1]
+        for k, v in pairs(endp) do
+          if    ((k == &quot;inf&quot;)  and char_is_inf(ch))
+             or ((k == &quot;wall&quot;) and char_is_wall(ch))
+             or ((k == &quot;goal&quot;) and char_is_goal(ch)) then
+            set_element(x+dx, y+dy, nr, k, v)
+          end
         end
       end
     end
   end
+  
+  -- if existent, redraw blocker floors
+  if (sokoarea[nr].list_blocker) and (endp.inf) then
+    for p, v in pairs(sokoarea[nr].list_blocker) do
+      set_element(v.lx, v.ly, nr, &quot;inf&quot;, endp.inf)
+    end
+  end 
 end
 
 ------------------------------------------------------------------------
@@ -234,10 +278,10 @@
     y = y - 2
   end
   for j = 0, 2 do
-    oxyd(x+j, y-1, flavor)
-    oxyd(x-1, y+j, flavor)
-    oxyd(x+j, y+3, flavor)
-    oxyd(x+3, y+j, flavor)
+    oxyd(x+j, y-1, flavor, 2*j)
+    oxyd(x-1, y+j, flavor, 2*j)
+    oxyd(x+j, y+3, flavor, 2*j+1)
+    oxyd(x+3, y+j, flavor, 2*j+1)
     for k = 0, 2 do
       kill_stone(x+j, y+k)
       kill_item(x+j, y+k)
@@ -279,14 +323,14 @@
                {lx = dx + mx - 1,  ly = dy},
                {lx = dx,           ly = dy + my - 1},
                {lx = dx + mx - 1,  ly = dy + my - 1} }
-  else
-        if max &lt;  50 then  number_pairs = 3
-    elseif max &lt; 100 then  number_pairs = 4
-    else                   number_pairs = 5  end
+  elseif max &lt;  20 then  number_pairs = 2
+  elseif max &lt;  50 then  number_pairs = 3
+  elseif max &lt; 100 then  number_pairs = 4
+  else                   number_pairs = 5
   end
   if (type(param) ~= &quot;nil&quot;) and (param ~= &quot;&quot;) then
     local max_pairs = tonumber(param)
-    if max_pairs &gt;= 2 then
+    if max_pairs then
       number_pairs = math.min(max_pairs, number_pairs)
     end    
   end
@@ -294,76 +338,115 @@
   shuffle_table(places)
 
   for j = 1, number_pairs do
-    oxyd(places[2*j-1].lx, places[2*j-1].ly, flavor, j - 1)
-    oxyd(places[2*j].lx, places[2*j].ly, flavor, j - 1)
+    set_oxyd(sokoarea_number, places[2*j-1], flavor, j - 1)
+    set_oxyd(sokoarea_number, places[2*j], flavor, j - 1)
   end
   oxyd_shuffle()
 end
 
-function endphase_set_block_oxyds(sokoarea_number, blocker)
-  local places = {}
+function endphase_set_block_oxyds(sokoarea_number, blocker, max_pairs)
+  local oxyds = {}
   local nr = sokoarea_number or 1
   local flavor = sokoarea[nr].design.oxyd or &quot;b&quot;
 
-  -- add all wall_two-elements with their wall_one.count == 1
-  for p, v in pairs(sokoarea[nr].list_wall_two) do
-    local entry = {lx = v.lx, ly = v.ly, ax = v.ax, ay = v.ay, wall_one = {}}
-    for q, w in pairs(v.wall_one) do
-      if w.count == 1 then
-        table.insert(entry.wall_one, w)
+  -- Add all wall_one-elements with exactly one way near as blocker,
+  -- and the opposite position as oxyd, if it is of type wall_two.
+  -- Make sure that each possible oxyd position is assigned at most once,
+  -- and that no other oxyds or blockers are near.
+  local function opposite_as_oxyd(x, y, dx, dy)
+    if     sokoarea[nr].list_way[(x+dx)..&quot;/&quot;..(y+dy)]
+       and sokoarea[nr].list_wall_two[(x-dx)..&quot;/&quot;..(y-dy)] then
+      -- Check that no oxyd has been set on this position before
+      -- and no other oxyd or blocker is near the new oxyd or its
+      -- blocker.
+      for j, w in pairs(oxyds) do
+        if    (manhattan_distance(w.blocker.lx, w.blocker.ly, x, y) &lt;= 1)
+           or (manhattan_distance(w.lx, w.ly, x, y) &lt;= 1)
+           or (manhattan_distance(w.blocker.lx, w.blocker.ly, x-dx, y-dy) &lt;= 1)
+           or (manhattan_distance(w.lx, w.ly, x-dx, y-dy) &lt;= 1) then
+          return false
+        end
       end
+      table.insert(oxyds, {lx = x-dx, ly = y-dy,
+          blocker = {lx = x, ly = y, oxyd = {lx = x-dx, ly = y-dy}}})
+      return true
     end
-    if table.getn(entry.wall_one) ~= 0 then
-      table.insert(places, entry)
+    return false
+  end
+  for p, v in pairs(sokoarea[nr].list_wall_one) do
+    if v.count == 1 then
+      opposite_as_oxyd(v.lx, v.ly, -1,  0)
+      opposite_as_oxyd(v.lx, v.ly,  1,  0)
+      opposite_as_oxyd(v.lx, v.ly,  0, -1)
+      opposite_as_oxyd(v.lx, v.ly,  0,  1)
     end
   end
 
   -- Choose some appropriate subset
-  local max = table.getn(places)
+  local max = table.getn(oxyds)
   local number_pairs = 2
-  if max &lt; 2 then
-    -- Not enough places? Then choose corners of level_array.
-    -- They should always be at least wall_two and far enough
-    -- away from each other.
-    places = { {lx = dx,           ly = dy},
-               {lx = dx + mx - 1,  ly = dy},
-               {lx = dx,           ly = dy + my - 1},
-               {lx = dx + mx - 1,  ly = dy + my - 1} }
-  else
-        if max &lt;  50 then  number_pairs = 3
-    elseif max &lt; 100 then  number_pairs = 4
-    else                   number_pairs = 5  end
+  if max &lt; 4 then
+    -- Not enough places? Choose &quot;circle&quot;-algorithm instead.
+    sokoarea[nr].endp.alg = &quot;circle&quot;
+    return
+  elseif max &lt;  8 then  number_pairs = 2
+  elseif max &lt; 16 then  number_pairs = 3
+  elseif max &lt; 28 then  number_pairs = 4
+  else                  number_pairs = 5
   end
-  if (type(param) ~= &quot;nil&quot;) and (param ~= &quot;&quot;) then
-    local max_pairs = tonumber(param)
-    if max_pairs &gt;= 2 then
-      number_pairs = math.min(max_pairs, number_pairs)
+  if (type(max_pairs) ~= &quot;nil&quot;) and (max_pairs ~= &quot;&quot;) then
+    if tonumber(max_pairs) &gt;= 1 then
+      number_pairs = math.min(tonumber(max_pairs), number_pairs)
     end    
   end
 
-  shuffle_table(places)
-  sokoarea[sokoarea_number].list_oxyds = {}
+  shuffle_table(oxyds)
 
-  function set_block(p)
-    --for q, w in pairs(places[p].wall_one) do
-    local w = places[p].wall_one[1]
-    set_element(w.lx, w.ly, sokoarea_number, &quot;inf&quot;)
-    set_stone(blocker, w.lx, w.ly)
-    --end
+  -- set oxyds and blockers
+  local function set_block(w)
+    local myblocker = blocker
+    -- if there's an entry &quot;st-door&quot;, choose between st-door-h and st-door-v.
+    if type(myblocker) == &quot;string&quot; then
+      myblocker = {myblocker}
+    end
+    for j, v in pairs(myblocker) do
+      if v == &quot;st-door&quot; then
+        if w.lx == w.oxyd.lx then
+          myblocker[j] = &quot;st-door-h&quot;
+        else
+          myblocker[j] = &quot;st-door-v&quot;
+        end        
+      end
+    end
+    -- now set in-floor and blocker, and add to list_blocker.
+    set_element(w.lx, w.ly, nr, &quot;inf&quot;)
+    set_element(w.lx, w.ly, nr, &quot;&quot;, myblocker)
+    sokoarea[nr].list_blocker[(w.lx)..&quot;/&quot;..(w.ly)] = w
   end
   for j = 1, number_pairs do   -- Testlevel: 14
-    oxyd(places[2*j-1].lx, places[2*j-1].ly, flavor, j - 1)
-    oxyd(places[2*j].lx, places[2*j].ly, flavor, j - 1)
-    set_block(2*j-1)
-    set_block(2*j)
-    table.insert(sokoarea[sokoarea_number].list_oxyds, places[2*j-1])
-    table.insert(sokoarea[sokoarea_number].list_oxyds, places[2*j])
+    set_oxyd(nr, oxyds[2*j-1], flavor, j - 1)
+    set_oxyd(nr, oxyds[2*j], flavor, j - 1)
+    set_block(oxyds[2*j-1].blocker)
+    set_block(oxyds[2*j].blocker)
   end
   oxyd_shuffle()
+
+  -- assign goals to blockers
+  -- Note: There might be more goals as blockers, and, vice versa,
+  --       there might be more blockers as goals.
+  local goal_table = {}
+  for p, v in pairs(sokoarea[nr].list_goal) do
+    table.insert(goal_table, v)
+  end
+  shuffle_table(goal_table)
+  for j = 2, math.min(table.getn(goal_table), table.getn(oxyds)) do
+    sokoarea[nr].goal_to_blocker[goal_table[j].goal_number] = oxyds[j].blocker
+  end
 end
 
 -- endphase_set_hide_oxyds distributes oxyds over the wall_one-walls.
-function endphase_set_hide_oxyds(sokoarea_number)
+-- PARAM is a maximal number of oxyd pairs.
+function endphase_set_hide_oxyds(sokoarea_number, param)
   local flavor = sokoarea[sokoarea_number].design.oxyd or &quot;b&quot;
   local places = {}
   
@@ -380,15 +463,22 @@
   if max &lt; 2 then
     -- use circle instead
     endphase_circle(sokoarea)
+    return
   elseif max &lt;  6  then  number_pairs = 2
   elseif max &lt; 10  then  number_pairs = 3
   elseif max &lt; 30  then  number_pairs = 4
   else                   number_pairs = 5 end
+  if (type(param) ~= &quot;nil&quot;) and (param ~= &quot;&quot;) then
+    local max_pairs = tonumber(param)
+    if max_pairs then
+      number_pairs = math.min(max_pairs, number_pairs)
+    end    
+  end
   
   -- set oxyds
   for j = 1, number_pairs do
-    oxyd(places[2*j-1].lx, places[2*j-1].ly, flavor, j - 1)
-    oxyd(places[2*j].lx, places[2*j].ly, flavor, j - 1)
+    set_oxyd(sokoarea_number, places[2*j-1], flavor, j - 1)
+    set_oxyd(sokoarea_number, places[2*j], flavor, j - 1)
   end
   oxyd_shuffle()  
 end
@@ -443,22 +533,33 @@
   if max &lt; 2 then
     -- use circle instead
     endphase_circle(sokoarea)
+    return
   elseif max &lt;  6  then  number_pairs = 2
   elseif max &lt; 10  then  number_pairs = 3
   else                   number_pairs = 4 end
 
   function endphase_call_fourswitch(onoff, sender)
     local j = enigma.GetAttrib(sender, &quot;_number&quot;)
+
+    -- When fourswitch is knocked, count it.
     places[j].current = places[j].current + 1
     if places[j].current == 5 then
       places[j].current = 1
     end
+    
+    -- When count is correct, make it &quot;st-likeoxyda-open&quot;.
     if places[j].current == places[j].solve then
       places[j].correct = true
       set_stone(&quot;st-likeoxyda-open&quot;, places[j].lx, places[j].ly,
           {_number=0})
     end
 
+    -- Now the difficult part: If it's the first fourswitch (the one
+    -- fourswitch that doesn't change any other), check all fourswitchs
+    -- and replace them by oxyds if all are correct. Else, recreate the
+    -- next fourswitch in hierarchy, set it to the old number, then
+    -- set the callback function and call it once by triggering another
+    -- time (making it show the new number). This means: Recursion!
     if j ~= 1 then
       -- Trigger all lower fourswitchs
       local x = places[j-1].lx
@@ -483,8 +584,8 @@
       if correct then
         -- replace fourswitchs by oxyds
         for k = 1, number_pairs do
-          oxyd(places[2*k-1].lx, places[2*k-1].ly, flavor, k - 1)
-          oxyd(places[2*k].lx, places[2*k].ly, flavor, k - 1)
+          set_oxyd(sokoarea_number, places[2*k-1], flavor, k - 1)
+          set_oxyd(sokoarea_number, places[2*k], flavor, k - 1)
         end
         oxyd_shuffle()
       end
@@ -499,7 +600,6 @@
     places[j].solve = random(1,4)
     places[j].correct = false
   end
-  oxyd_shuffle()  
 end
 
 function endphase_allcrack(sokoarea_number)
@@ -512,39 +612,192 @@
 
 function endphase_goal_hook_ralf(sokoarea_number, sender, more_boxes,
     goals_filled, number_goals)
-  -- verify correct sokoarea-number and existence of &quot;list_oxyds&quot;
-  if sokoarea_number ~= enigma.GetAttrib(sender, &quot;_sokoarea&quot;) then
+  local nr = sokoarea_number or 1
+  -- verify correct sokoarea-number and existence of &quot;goal_to_blocker&quot;
+  if nr ~= enigma.GetAttrib(sender, &quot;_sokoarea&quot;) then
     myerror(&quot;libsoko: Inconsistent sokoarea numbers in goal hook!&quot;)
   end
-  if type(sokoarea[sokoarea_number].list_oxyds) ~= &quot;table&quot; then
-    myerror(&quot;libsoko: Oxyd list is missing during goal hook!&quot;)
+  if type(sokoarea[nr].goal_to_blocker) ~= &quot;table&quot; then
+    myerror(&quot;libsoko: Blocker list is missing during goal hook!&quot;)
   end
   -- identify the corresponding door and open it
   local goal_number = enigma.GetAttrib(sender, &quot;_goal_number&quot;)
-  local number_oxyds = table.getn(sokoarea[sokoarea_number].list_oxyds)
-  if (goal_number ~= 1) and (goal_number &lt;= number_oxyds) then  
-    local oxyd_entry = sokoarea[sokoarea_number].list_oxyds[goal_number]
-    local door_x = oxyd_entry.wall_one[1].lx
-    local door_y = oxyd_entry.wall_one[1].ly
-    local st = enigma.GetStone(door_x, door_y)
-    if more_boxes then
-      SendMessage(st, &quot;open&quot;)
+  local blocker = sokoarea[nr].goal_to_blocker[goal_number]
+  if blocker then
+    endphase_ralf_open_door(nr, more_boxes, blocker.lx, blocker.ly)  
+  end
+end
+
+function endphase_ralf_open_doors(sokoarea_number)
+  for p, v in pairs(sokoarea[sokoarea_number].list_blocker) do
+    endphase_ralf_open_door(sokoarea_number, true, v.lx, v.ly)
+  end
+end
+
+-- endphase_ralf_open_door opens or closes a door at position
+-- (X,Y), dependend on the boolean OPEN.
+function endphase_ralf_open_door(sokoarea_number, open, x, y)
+  local door_kind = sokoarea[sokoarea_number].design.endp.open_door
+  if door_kind then
+    if not open then
+      door_kind =    sokoarea[sokoarea_number].design.door
+                  or sokoarea[sokoarea_number].design.wall or &quot;st-none&quot;
+    end
+    set_element(x, y, sokoarea_number, &quot;&quot;, door_kind)
+  else
+    -- use default &quot;open&quot;/&quot;close&quot;-messages instead
+    local st = enigma.GetStone(x, y)
+    local it = enigma.GetItem(x, y)
+    local fl = enigma.GetFloor(x, y)
+    if open then
+      if st then
+        SendMessage(st, &quot;open&quot;)
+      end
+      if it then
+        SendMessage(it, &quot;open&quot;)
+      end
+      if fl then
+        SendMessage(fl, &quot;close&quot;)
+      end
     else
-      SendMessage(st, &quot;close&quot;)
+      if st then
+        SendMessage(st, &quot;close&quot;)
+      end
+      if it then
+        SendMessage(it, &quot;close&quot;)
+      end
+      if fl then
+        SendMessage(fl, &quot;open&quot;)
+      end
+    end      
+  end  
+end
+
+function endphase_vortex(sokoarea_number)
+  local nr = sokoarea_number or 1
+  local list_way = combine_tables({sokoarea[nr].list_way, sokoarea[nr].list_blocker})
+  local components = 0
+  local component = {}
+
+  -- Remove old component-entries, in case there are still some left.
+  for p, v in pairs(list_way) do
+    list_way[p].component = nil
+  end
+  -- Analyse connected components of list_way, separated by goals.
+  local function mark_component(lx, ly)
+    if     (list_way[lx..&quot;/&quot;..ly])
+       and (not list_way[lx..&quot;/&quot;..ly].component)
+       and (not sokoarea[nr].list_goal[lx..&quot;/&quot;..ly]) then
+      list_way[lx..&quot;/&quot;..ly].component = components
+      --set_floor(({&quot;fl-leaves&quot;, &quot;fl-ice&quot;, &quot;fl-red&quot;, &quot;fl-black&quot;, &quot;fl-white&quot;,
+      --    &quot;fl-sahara&quot;, &quot;fl-light&quot;, &quot;fl-gray&quot;, &quot;fl-lightgray&quot;, &quot;fl-rough&quot;,
+      --    &quot;fl-marble&quot;, &quot;fl-tigris&quot;})[components] or &quot;fl-sand&quot;, lx, ly)
+      table.insert(component[components], {lx = lx, ly = ly})
+      mark_component(lx+1, ly)
+      mark_component(lx-1, ly)
+      mark_component(lx, ly+1)
+      mark_component(lx, ly-1)
     end
   end
+  for p, v in pairs(list_way) do
+    --mydebug(v.lx..&quot;/&quot;..v.ly..&quot;: &quot;..(list_way[p].component or &quot;nil&quot;))
+    if (not list_way[p].component) and (not sokoarea[nr].list_goal[p]) then
+      components = components + 1
+      component[components] = {}
+      mark_component(v.lx, v.ly)      
+    end    
+  end
+  -- If only one component, exit, player will find his way alone.
+  if components &lt; 2 then
+    return
+  end
+  -- From each component, choose one tile and save the {lx,ly}-entry
+  local vortex = {}
+  for j = 1, components do
+    table.insert(vortex, component[j][random(1, table.getn(component[j]))])
+  end
+
+  -- Find a cyclic permutation (i.e. with only one cycle) to connect the
+  -- vortices (each vortex shall be reached by starting from any other).
+  local sequence = {}
+  for j = 1, components do
+    sequence[j] = {nr = j}
+  end
+  shuffle_table(sequence)
+  local connect = {}
+  for j = 1, components - 1 do
+    connect[sequence[j].nr] = sequence[j+1].nr
+  end
+  connect[sequence[components].nr] = sequence[1].nr
+
+  -- Now set and connect the vortices
+  for j, v in pairs(vortex) do
+    local w = vortex[connect[j]]
+    -- Remember: We also allow (we need!) vortices at old blocker-positions.
+    -- There could still be a stone over this. This stone might be st-blocker,
+    -- which turns to it-blocker and has therefore to be removed. Better
+    -- we remove all stones:
+    kill_stone(v.lx, v.ly)
+    set_item(&quot;it-vortex-open&quot;, v.lx, v.ly, {targetx = w.lx, targety = w.ly})
+  end  
 end
 
-function endphase_ralf_open_doors(sokoarea_number)
-  for j, v in pairs(sokoarea[sokoarea_number].list_oxyds) do
-    local door_x = v.wall_one[1].lx
-    local door_y = v.wall_one[1].ly
-    SendMessage(enigma.GetStone(door_x, door_y), &quot;open&quot;)
+function endphase_set_knock_items(sokoarea_number, param)
+  local flavor = sokoarea[sokoarea_number].design.oxyd or &quot;b&quot;
+  local places = {}
+  local itemkind = param
+  if (itemkind == nil) or (itemkind == &quot;&quot;) then
+    itemkind = &quot;it-burnable&quot;
   end
+
+  -- add all blockers
+  for p, v in pairs(sokoarea[sokoarea_number].list_blocker) do
+    table.insert(places, v)
+  end
+
+  shuffle_table(places)
+  
+  function endphase_call_knock_item(onoff, sender)
+    local j = enigma.GetAttrib(sender, &quot;_number&quot;)
+    local nr = enigma.GetAttrib(sender, &quot;_sokoarea&quot;)
+    if (not nr) or (not j) then
+      myerror(&quot;libsoko: Knock item has no number or no sokoarea.&quot;)
+    end
+    mydebug(&quot;Knocked on &quot;..j..&quot;/&quot;..sokoarea[nr].number_oxyds)
+    -- Deactivate the first door until endphase has started.
+    if (j == 1) and (not sokoarea[nr].endphase_started) then
+      return
+    end
+    -- Close the next door in the circle ...
+    j = j + 1
+    if j &gt; sokoarea[nr].number_oxyds then
+      j = 1
+    end
+    local mydoor = enigma.GetStone(places[j].lx, places[j].ly)
+    if mydoor then
+      SendMessage(mydoor, &quot;close&quot;)
+    end
+    -- ... and open the door after next.
+    j = j + 1
+    if j &gt; sokoarea[nr].number_oxyds then
+      j = 1
+    end
+    mydoor = enigma.GetStone(places[j].lx, places[j].ly)
+    if mydoor then
+      SendMessage(mydoor, &quot;open&quot;)
+    end
+  end
+
+  -- set items
+  for j, v in pairs(places) do
+    set_item(itemkind, v.lx, v.ly, {action=&quot;callback&quot;,
+        target=&quot;endphase_call_knock_item&quot;, _number=j, _sokoarea=sokoarea_number})
+  end
 end
-    
+
     ]]&gt;&lt;/el:luamain&gt;
     &lt;el:i18n&gt;
     &lt;/el:i18n&gt;
   &lt;/el:protected&gt;
 &lt;/el:level&gt;
+

Modified: trunk/data/levels/lib/libsoko.xml
===================================================================
--- trunk/data/levels/lib/libsoko.xml	2007-11-10 20:10:07 UTC (rev 923)
+++ trunk/data/levels/lib/libsoko.xml	2007-11-11 01:59:08 UTC (rev 924)
@@ -67,11 +67,12 @@
 --      list_wall_one - list of outer walls near ways
 --      list_wall_two - list of outer walls or outf one tile away from
 --                      ways, together with a list of neighboring wall_ones.
+--          list_goal - list of all goals
 --
 -- Each list entry is a table: Entries lx and ly are absolute positions
 -- (&quot;level&quot;), ax and ay are positions in the level_array, if existent
--- (nil else). Some endphases also use list_oxyds as additional data
--- structure.
+-- (nil else). Some endphases also use list_oxyd, list_blocker,
+-- goal_to_blocker and/or number_oxyds as additional data structures.
 
 sokoarea = {}
 
@@ -134,6 +135,12 @@
   table.sort(t, function (a, b) return a.sort_field &lt; b.sort_field end)
 end
 
+-- manhattan_distance calculates the Manhattan-distance between
+-- (X1,Y1) and (X2, Y2), which is |X1 - X2| + |Y1 - Y2|
+function manhattan_distance(x1, y1, x2, y2)
+  return math.abs(x1 - x2) + math.abs(y1 - y2)
+end
+
 -- choose_among_multiples selects a number between 1 and COUNT
 -- based on the coordinates X and Y and the algorithm's name ALG.
 function choose_among_multiples(x, y, count, alg)
@@ -148,61 +155,6 @@
   end
 end
 
--- no_way_near returns a boolean whether (x,y) is not
--- reachable by the marble.
-function no_way_near(x, y, sokoarea_number)
-  local la = sokoarea[sokoarea_number].level_array
-  local char_n = (la[y-1] or {})[x] or &quot;-&quot;
-  local char_s = (la[y+1] or {})[x] or &quot;-&quot;
-  local char_w = (la[y] or {})[x-1] or &quot;-&quot;
-  local char_e = (la[y] or {})[x+1] or &quot;-&quot;
-  return     (char_is_outf(char_n) or char_is_wall(char_n))
-         and (char_is_outf(char_s) or char_is_wall(char_s))
-         and (char_is_outf(char_w) or char_is_wall(char_w))
-         and (char_is_outf(char_e) or char_is_wall(char_e))
-end
-
--- one_tile_far_from_way checks whether (x,y) is reachable
--- by the marble through exactly one stone. If not, it returns
--- nil, else the position of this stone.
-function one_tile_far_from_way(x, y, sokoarea_number)
-  -- first of all, make sure there is no direct way 
-  --if not no_way_near(x, y, sokoarea_number) then
-  --  return nil
-  --end
-  -- now analyse the following positions relative to our
-  -- center C = (x,y), marked by stars:
-  --   *
-  --  *.*
-  -- *.C.*
-  --  *.*
-  --   *
-  local la = sokoarea[sokoarea_number].level_array
-  local neighborhood = {          {x= 0, y=-2},
-                    {x=-1, y=-1},               {x= 1, y=-1},
-      {x=-2, y= 0},                                           {x= 2, y= 0},
-                    {x=-1, y= 1},               {x= 1, y= 1},
-                                  {x= 0, y= 2},                            }
-  local char = {}
-  for j, k in pairs(neighborhood) do
-    char[j] = {ch = (la[y+k.y] or {})[x+k.x] or &quot;&quot;, nr = j}
-  end
-  -- from this list, remove all empty positions, walls and outf
-  local char_backup = char
-  for j, v in pairs(char_backup) do
-    if char_is_outf(v.ch) or char_is_wall(v.ch) or (v.ch == &quot;&quot;) then
-      table.remove(char, j)
-    end
-  end
-  -- return nil or a random element of char
-  if table.getn(char) == 0 then
-    return nil
-  else
-    local n = neighborhood[char[random(1, table.getn(char))].nr]
-    return {x=x+n.x, y=y+n.y}
-  end
-end
-
 -- check_chess returns a boolean whether a chess stone is used
 -- in the sokoarea SOKOAREA_NUMBER.
 function check_chess(sokoarea_number)
@@ -218,6 +170,18 @@
   return false
 end
 
+-- set_oxyd sets an oxyd with given flavor and color and adds
+-- the neccessary entry to list_oxyd.
+function set_oxyd(sokoarea_number, list_entry, flavor, color)
+  local entry = list_entry
+  entry.flavor = flavor
+  entry.color = color
+  oxyd(entry.lx, entry.ly, flavor, color)
+  sokoarea[sokoarea_number].list_oxyd[(entry.lx)..&quot;/&quot;..(entry.ly)] = entry
+  sokoarea[sokoarea_number].number_oxyds =
+      sokoarea[sokoarea_number].number_oxyds + 1
+end
+
 -- create_lists creates the special lists list_outside, list_wall,
 -- list_way, list_wall_one and list_wall_two for SOKOAREA_NUMBER.
 function create_lists(sokoarea_number)
@@ -333,7 +297,12 @@
     list_wall = {},
     list_way = {},
     list_wall_one = {},
-    list_wall_two = {}
+    list_wall_two = {},
+    list_goal = {},
+    list_oxyd = {},
+    list_blocker = {},
+    goal_to_blocker = {},
+    number_oxyds = 0
   }
   return sokoarea_number
 end
@@ -356,7 +325,9 @@
     return
   end
 
-  if type(el) == &quot;string&quot;  then  el = {el}  end
+  if type(el) == &quot;string&quot; then
+    el = {el}
+  end
 
   local fl = {}
   local st = {}
@@ -364,17 +335,43 @@
   local multiple_alg = &quot;checkerboard&quot;
   local friction = nil
   local mousefactor = nil
+  local fire = nil
 
   -- Now analyse EL: Decompose its entries into fl,st,it.
-  for j, s in pairs(el) do
-        if is_floor(s)       then  table.insert(fl, s)
-    elseif is_stone(s)       then  table.insert(st, s)
-    elseif is_item(s)        then  table.insert(it, s)
-    elseif is_algorithm(s)   then  multiple_alg = string.sub(s, 4, -1)
-    elseif is_friction(s)    then  friction = tonumber(string.sub(s, 4, -1))
-    elseif is_mousefactor(s) then  mousefactor = tonumber(string.sub(s, 4, -1))
+  -- Each entry might in turn hold a &quot;:NUMBER&quot;, which multiplicates it.
+  for j, v in pairs(el or {}) do
+    if type(v) == &quot;string&quot; then
+      -- Separate the multiplicator
+      local s = v
+      local nr = 1
+      local sep = string.find(v, &quot;:&quot;)
+      if sep then
+        s = string.sub(v, 1, sep - 1)
+        nr = tonumber(string.sub(v, sep + 1))
+      end
+      if type(nr) ~= &quot;number&quot; then
+        -- Assume it's not a multiplicator, like in &quot;al:ALGORITHM&quot;.
+        s = v
+        nr = 1
+      end
+
+      -- Now sort the entry into tables
+      for j = 1, nr do
+            if is_floor(s)       then  table.insert(fl, s)
+        elseif is_stone(s)       then  table.insert(st, s)
+        elseif is_item(s)        then  table.insert(it, s)
+        elseif is_algorithm(s)   then  multiple_alg = string.sub(s, 4, -1)
+        elseif is_friction(s)    then  friction = tonumber(string.sub(s, 4, -1))
+        elseif is_mousefactor(s) then  mousefactor = tonumber(string.sub(s, 4, -1))
+        elseif s == &quot;fire&quot;       then  fire = true
+        elseif s == &quot;nofire&quot;     then  fire = false
+        else
+          mywarning(&quot;Unknown entry &quot;..j..&quot;=&quot;..s..&quot; in design element.&quot;)
+        end
+      end
     else
-      mywarning(&quot;Unknown entry &quot;..s..&quot; in design element.&quot;)
+      mywarning(&quot;In design element, entry &quot;..j..&quot; is of type &quot;
+                ..type(v)..&quot;, not string.&quot;)      
     end
   end
 
@@ -383,7 +380,16 @@
   ----------- floor --------------
   if table.getn(fl) &gt; 0 then
     local flkind = fl[choose_among_multiples(x, y, table.getn(fl), multiple_alg)]
-    created_objects.fl = set_floor(flkind, x, y)
+    if flkind == &quot;fl-bridge_x&quot; then
+      created_objects.fl = set_floor(&quot;fl-bridge&quot;, x, y,
+          {type = &quot;x&quot;, burnable = false, eternal = true})
+    elseif flkind == &quot;fl-bridge_y&quot; then
+      created_objects.fl = set_floor(&quot;fl-bridge&quot;, x, y,
+          {type = &quot;y&quot;, burnable = false, eternal = true})
+    else
+      created_objects.fl = set_floor(flkind, x, y,
+          {burnable = false, eternal = true})
+    end
     if type(friction) == &quot;number&quot; then
       enigma.SetAttrib(created_objects.fl, &quot;friction&quot;, friction)
     end
@@ -419,6 +425,8 @@
     if (el_str == &quot;goal&quot;) and not in_endphase then
       local gn = sokoarea[sokoarea_number].number_goals + 1
       sokoarea[sokoarea_number].number_goals = gn
+      sokoarea[sokoarea_number].list_goal[x..&quot;/&quot;..y] = 
+          {lx = x, ly = y, goal_number = gn}
       if created_objects.it and not in_endphase then
         enigma.SetAttrib(created_objects.it, &quot;action&quot;, &quot;callback&quot;)
         enigma.SetAttrib(created_objects.it, &quot;target&quot;, &quot;goal_trigger&quot;)
@@ -428,7 +436,23 @@
       end
     end
   end
-  
+
+  ----------- fire ----------------
+  if fire ~= nil then
+    local myfloor = enigma.GetFloor(x,y)
+    if myfloor then
+      if fire then
+        enigma.SetAttrib(myfloor, &quot;burnable&quot;, true)
+        enigma.SetAttrib(myfloor, &quot;eternal&quot;, true)
+        SendMessage(myfloor, &quot;forcefire&quot;)
+      else
+        SendMessage(myfloor, &quot;stopfire&quot;)
+        enigma.SetAttrib(myfloor, &quot;burnable&quot;, false)
+        enigma.SetAttrib(myfloor, &quot;eternal&quot;, true)
+      end
+    end
+  end
+
   return created_objects
 end
 
@@ -447,6 +471,7 @@
   local design = sokoarea[nr].design
   local dx = sokoarea[nr].offset.x
   local dy = sokoarea[nr].offset.y
+  sokoarea[nr].list_goal = {}
 
   -- create level
   for y = 0, sokoarea[nr].array_height - 1 do
@@ -981,12 +1006,18 @@
   sokoarea[nr].number_goals = 0
   sokoarea[nr].goals_filled = 0
   sokoarea[nr].endphase_started = false
-
+  sokoarea[nr].goal_to_blocker = {}
+  sokoarea[nr].goal_hook = nil
+  sokoarea[nr].list_goal = {}
+  sokoarea[nr].list_oxyd = {}
+  sokoarea[nr].list_blocker = {}
+  sokoarea[nr].number_oxyds = 0
+    
   draw_level_array(nr, true, false)
 
   -- prepare oxyds for end phase
   prepare_endphase(nr)
-  mywarning(sokoarea[nr].design.endp.alg)
+  mydebug(&quot;Prepared for endphase &quot;..sokoarea[nr].design.endp.alg..&quot;.&quot;)
 end
 
 -- draw_sokoball draws a sokoball level from argument LEVEL, sublevel
@@ -1039,6 +1070,8 @@
       if alg then
         alglist[alg] = (alglist[alg] or 0) + 1
       end
+    else
+      alglist[&quot;default&quot;] = (alglist[&quot;default&quot;] or 0) + 1
     end
   end
   for k, v in pairs(alglist) do


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000355.html">[Enigma-game-svn] r923 - in trunk/src: . stones
</A></li>
	<LI>Next message: <A HREF="000357.html">[Enigma-game-svn] r925 - in trunk: data/levels/enigma_cross	data/levels/enigma_v doc/reference src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#356">[ date ]</a>
              <a href="thread.html#356">[ thread ]</a>
              <a href="subject.html#356">[ subject ]</a>
              <a href="author.html#356">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/enigma-game-svn">More information about the Enigma-game-svn
mailing list</a><br>
</body></html>
