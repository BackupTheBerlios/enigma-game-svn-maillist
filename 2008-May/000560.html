<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Enigma-game-svn] r1127 - in trunk: data data/gfx32 data/gfx40	data/gfx48 src/stones
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/enigma-game-svn/2008-May/index.html" >
   <LINK REL="made" HREF="mailto:enigma-game-svn%40lists.berlios.de?Subject=Re%3A%20%5BEnigma-game-svn%5D%20r1127%20-%20in%20trunk%3A%20data%20data/gfx32%20data/gfx40%0A%09data/gfx48%20src/stones&In-Reply-To=%3C200805062232.m46MWXiR032638%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000559.html">
   <LINK REL="Next"  HREF="000561.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Enigma-game-svn] r1127 - in trunk: data data/gfx32 data/gfx40	data/gfx48 src/stones</H1>
    <B>ral at BerliOS</B> 
    <A HREF="mailto:enigma-game-svn%40lists.berlios.de?Subject=Re%3A%20%5BEnigma-game-svn%5D%20r1127%20-%20in%20trunk%3A%20data%20data/gfx32%20data/gfx40%0A%09data/gfx48%20src/stones&In-Reply-To=%3C200805062232.m46MWXiR032638%40sheep.berlios.de%3E"
       TITLE="[Enigma-game-svn] r1127 - in trunk: data data/gfx32 data/gfx40	data/gfx48 src/stones">ral at mail.berlios.de
       </A><BR>
    <I>Wed May  7 00:32:33 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000559.html">[Enigma-game-svn] r1126 - in trunk: data data/schemas src src/stones
</A></li>
        <LI>Next message: <A HREF="000561.html">[Enigma-game-svn] r1128 - in feature_branches/hp_lotm: images/lotm	input/lotm
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#560">[ date ]</a>
              <a href="thread.html#560">[ thread ]</a>
              <a href="subject.html#560">[ subject ]</a>
              <a href="author.html#560">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: ral
Date: 2008-05-07 00:32:23 +0200 (Wed, 07 May 2008)
New Revision: 1127

Added:
   trunk/data/gfx32/st_window_blue.png
   trunk/data/gfx32/st_window_blue_break.png
   trunk/data/gfx32/st_window_green.png
   trunk/data/gfx32/st_window_green_break.png
   trunk/data/gfx40/st_window_blue.png
   trunk/data/gfx40/st_window_blue_break.png
   trunk/data/gfx40/st_window_green.png
   trunk/data/gfx40/st_window_green_break.png
   trunk/data/gfx48/st_window_blue.png
   trunk/data/gfx48/st_window_blue_break.png
   trunk/data/gfx48/st_window_green.png
   trunk/data/gfx48/st_window_green_break.png
Removed:
   trunk/data/gfx32/st-window-break.png
   trunk/data/gfx32/st-window.png
   trunk/data/gfx40/st-window-break.png
   trunk/data/gfx40/st-window.png
   trunk/data/gfx48/st-window-break.png
   trunk/data/gfx48/st-window.png
Modified:
   trunk/data/models-2d.lua
   trunk/src/stones/WindowStone.cc
   trunk/src/stones/WindowStone.hh
Log:
Trunk 1.1: Window Stone
- new images for blue and green windows
- added &quot;secure&quot; attribute, secure windows are green
- kill items on break for OXYD1 compatibility
Note:
- secure and other window gaming features are not yet finished


Deleted: trunk/data/gfx32/st-window-break.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx32/st-window.png
===================================================================
(Binary files differ)

Added: trunk/data/gfx32/st_window_blue.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx32/st_window_blue.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx32/st_window_blue_break.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx32/st_window_blue_break.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx32/st_window_green.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx32/st_window_green.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx32/st_window_green_break.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx32/st_window_green_break.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Deleted: trunk/data/gfx40/st-window-break.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx40/st-window.png
===================================================================
(Binary files differ)

Added: trunk/data/gfx40/st_window_blue.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx40/st_window_blue.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx40/st_window_blue_break.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx40/st_window_blue_break.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx40/st_window_green.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx40/st_window_green.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx40/st_window_green_break.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx40/st_window_green_break.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Deleted: trunk/data/gfx48/st-window-break.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx48/st-window.png
===================================================================
(Binary files differ)

Added: trunk/data/gfx48/st_window_blue.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx48/st_window_blue.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx48/st_window_blue_break.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx48/st_window_blue_break.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx48/st_window_green.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx48/st_window_green.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx48/st_window_green_break.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx48/st_window_green_break.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Modified: trunk/data/models-2d.lua
===================================================================
--- trunk/data/models-2d.lua	2008-05-05 21:52:14 UTC (rev 1126)
+++ trunk/data/models-2d.lua	2008-05-06 22:32:23 UTC (rev 1127)
@@ -1182,28 +1182,39 @@
 
 -- st-window --
 do
-    local fg_window = DefSubimages(&quot;st-window&quot;, {modelname=&quot;fg-window&quot;,w=4,h=4})
-    local sh_window = DefSubimages(&quot;sh_window&quot;, {modelname=&quot;sh_window&quot;,w=4,h=4,imgw=ShadowSize,imgh=ShadowSize})
+    local fg_window_blue = DefSubimages(&quot;st_window_blue&quot;, {modelname=&quot;fg-window_blue&quot;,w=4,h=4})
+    local fg_window_green = DefSubimages(&quot;st_window_green&quot;, {modelname=&quot;fg-window_green&quot;,w=4,h=4})
+    local sh_window = DefSubimages(&quot;sh_window&quot;, {modelname=&quot;sh-window&quot;,w=4,h=4,imgw=ShadowSize,imgh=ShadowSize})
 
     for i = 2, 16 do  -- faces + 1
-        DefShModel(&quot;st_window&quot;..(16-i), &quot;fg-window&quot;..i, &quot;sh_window&quot;..i)
+        DefShModel(&quot;st_window_blue&quot;..(16-i), &quot;fg-window_blue&quot;..i, &quot;sh-window&quot;..i)
+        DefShModel(&quot;st_window_green&quot;..(16-i), &quot;fg-window_green&quot;..i, &quot;sh-window&quot;..i)
     end
     -- 4 sided window stone:
-    DefAlias(&quot;st_window&quot;,&quot;st_window0&quot;)
+    DefAlias(&quot;st_window_blue&quot;,&quot;st_window_blue0&quot;)
+    DefAlias(&quot;st_window_green&quot;,&quot;st_window_green0&quot;)
 
     -- Breaking animimation:
-    local breaking_window_names = {}
-    local breaking_images = DefSubimages(&quot;st-window-break&quot;, {h=4})
+    local breaking_window_blue_names = {}
+    local breaking_window_green_names = {}
+    local breaking_images_blue = DefSubimages(&quot;st_window_blue_break&quot;, {h=4})
+    local breaking_images_green = DefSubimages(&quot;st_window_green_break&quot;, {h=4})
 
-    for i=1, table.getn(fg_window) do   -- faces + 1
-        breaking_window_names[i] = {}
-        for j = 1, table.getn(breaking_images) do
-            breaking_window_names[i][j] = &quot;st-window-breaking&quot;..i..&quot;-&quot;..j
-            display.DefineComposite(breaking_window_names[i][j], fg_window[i], breaking_images[j])
+    for i=1, table.getn(fg_window_blue) do   -- faces + 1
+        breaking_window_blue_names[i] = {}
+        breaking_window_green_names[i] = {}
+        for j = 1, table.getn(breaking_images_blue) do
+            breaking_window_blue_names[i][j] = &quot;st-window_blue_breaking&quot;..i..&quot;-&quot;..j
+            breaking_window_green_names[i][j] = &quot;st-window_green_breaking&quot;..i..&quot;-&quot;..j
+            display.DefineComposite(breaking_window_blue_names[i][j], fg_window_blue[i], breaking_images_blue[j])
+            display.DefineComposite(breaking_window_green_names[i][j], fg_window_green[i], breaking_images_green[j])
         end
-        local frames = BuildFrames(breaking_window_names[i], 130)
-        DefAnim(&quot;st_window&quot;..(16-i)..&quot;_anim_fg&quot;, frames)
-        DefShModel(&quot;st_window&quot;..(16-i)..&quot;_anim&quot;, &quot;st_window&quot;..(16-i)..&quot;_anim_fg&quot;, sh_window[i]);
+        local frames_blue = BuildFrames(breaking_window_blue_names[i], 130)
+        local frames_green = BuildFrames(breaking_window_green_names[i], 130)
+        DefAnim(&quot;st-window_blue&quot;..(16-i)..&quot;_anim_fg&quot;, frames_blue)
+        DefAnim(&quot;st-window_green&quot;..(16-i)..&quot;_anim_fg&quot;, frames_green)
+        DefShModel(&quot;st_window_blue&quot;..(16-i)..&quot;_anim&quot;, &quot;st-window_blue&quot;..(16-i)..&quot;_anim_fg&quot;, sh_window[i]);
+        DefShModel(&quot;st_window_green&quot;..(16-i)..&quot;_anim&quot;, &quot;st-window_green&quot;..(16-i)..&quot;_anim_fg&quot;, sh_window[i]);
     end
 end
 

Modified: trunk/src/stones/WindowStone.cc
===================================================================
--- trunk/src/stones/WindowStone.cc	2008-05-05 21:52:14 UTC (rev 1126)
+++ trunk/src/stones/WindowStone.cc	2008-05-06 22:32:23 UTC (rev 1127)
@@ -19,15 +19,38 @@
  */
 
 #include &quot;stones/WindowStone.hh&quot;
-//#include &quot;main.hh&quot;
+#include &quot;main.hh&quot;
 #include &quot;server.hh&quot;
 #include &quot;world.hh&quot;
 
 namespace enigma {
-    WindowStone::WindowStone(std::string faces) : Stone(), breakingFaces(NODIRBIT) {
+    WindowStone::WindowStone(std::string faces) : Stone() {
         setAttr(&quot;faces&quot;, faces);
     }
     
+    void WindowStone::setAttr(const std::string &amp;key, const Value &amp;val) {
+        if (key == &quot;secure&quot;) {
+            if (val.to_bool() != (objFlags &amp; OBJBIT_SECURE)) {
+                if (val.to_bool()) {
+                    objFlags |= OBJBIT_SECURE;
+                } else {
+                    objFlags &amp;= ~OBJBIT_SECURE;
+                }
+                if (isDisplayable())
+                    init_model();
+                return;
+            }
+        }
+        Stone::setAttr(key, val);
+    }
+    
+    Value WindowStone::getAttr(const std::string &amp;key) const {
+        if (key == &quot;secure&quot;) {
+            return (bool)(objFlags &amp; OBJBIT_SECURE);
+        }
+        return Stone::getAttr(key);
+    }
+    
     Value WindowStone::message(const Message &amp;m) {
         if (m.message == &quot;inner_pull&quot; ) {
             return Value(tryInnerPull(to_direction(m.value)));
@@ -35,6 +58,20 @@
         return Stone::message(m);
     }
     
+    int WindowStone::externalState() const {
+        return 0;
+    }
+    
+    void WindowStone::setState(int extState) {
+        // ignore any state access
+    }
+
+    void WindowStone::init_model() {
+        if (state == IDLE) {   // anims will not be cleared 
+            set_model(ecl::strf(&quot;st_window_%s%d&quot;, objFlags &amp; OBJBIT_SECURE ? &quot;green&quot; : &quot;blue&quot; , getConnections()));
+        }
+    }
+
     void WindowStone::animcb() {
         if (state == FINALBREAK)
             KillStone(get_pos());
@@ -46,7 +83,6 @@
     
     void WindowStone::actor_hit(const StoneContact &amp;sc) {
         Actor *a = sc.actor;
-        // TODO do we want to allow breaks while breaking?
         if (state == IDLE) {
             double impulse = -(a-&gt;get_vel() * sc.normal) * get_mass(a);
             if (impulse &gt; 35) {
@@ -58,7 +94,9 @@
                 Object::setAttr(&quot;$connections&quot;, ALL_DIRECTIONS ^ remainigFaces);     // avoid init of model
                 sound_event (&quot;shatter&quot;);
                 state = (remainigFaces == NODIRBIT) ? FINALBREAK : BREAK;
-                set_anim(ecl::strf(&quot;st_window%d_anim&quot;, getConnections()));
+                set_anim(ecl::strf(&quot;st_window_%s%d_anim&quot;,  objFlags &amp; OBJBIT_SECURE ? &quot;green&quot; : &quot;blue&quot;, getConnections()));
+                if (server::GameCompatibility == GAMET_OXYD1)
+                    KillItem(get_pos());
             }
             
             else if (player::WieldedItemIs (sc.actor, &quot;it_wrench&quot;)) {

Modified: trunk/src/stones/WindowStone.hh
===================================================================
--- trunk/src/stones/WindowStone.hh	2008-05-05 21:52:14 UTC (rev 1126)
+++ trunk/src/stones/WindowStone.hh	2008-05-06 22:32:23 UTC (rev 1127)
@@ -30,11 +30,10 @@
 
 /* -------------------- Window -------------------- */
 
-/** \page st_window Breakable Stone
+/**  st_window Breakable Stone
 
 Hit this window heavily with your marble to blast it into smithereens.
 
-\image html st_window.png
 */
 
 namespace enigma {
@@ -44,27 +43,39 @@
         DECL_TRAITS;
     private:
         enum iState { IDLE, BREAK, FINALBREAK };
+
+        enum ObjectPrivatFlagsBits {
+            OBJBIT_SCRATCHDIRS  =   3&lt;&lt;24,   ///&lt; faces that are scratched
+            OBJBIT_SECURE       =   1&lt;&lt;26    ///&lt;  
+        };
         
     public:
         WindowStone(std::string faces);
         
         // Object interface
+        virtual void setAttr(const std::string &amp;key, const Value &amp;val);
+        virtual Value getAttr(const std::string &amp;key) const;
         virtual Value message(const Message &amp;m);
+        
+         // StateObject interface
+        virtual int externalState() const;
+        virtual void setState(int extState);
+       
+        // GridObject interface
+        virtual void init_model();
 
         // ModelCallback interface
-        void animcb();
+        virtual void animcb();
 
         // Stone interface
-        void actor_hit(const StoneContact &amp;sc);
-        StoneResponse collision_response(const StoneContact &amp;sc);
-        const char *collision_sound() {return &quot;glass&quot;;}
-        bool is_transparent (Direction) const { return true; }
-        bool is_floating() const { return state != IDLE; }
+        virtual void actor_hit(const StoneContact &amp;sc);
+        virtual StoneResponse collision_response(const StoneContact &amp;sc);
+        virtual const char *collision_sound() {return &quot;glass&quot;;}
+        virtual bool is_transparent (Direction) const { return true; }
+        virtual bool is_floating() const { return state != IDLE; }
         virtual bool is_sticky(const Actor *a) const;
 
-
     private:
-        DirectionBits breakingFaces;
         bool tryInnerPull(Direction dir);
     };
 


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000559.html">[Enigma-game-svn] r1126 - in trunk: data data/schemas src src/stones
</A></li>
	<LI>Next message: <A HREF="000561.html">[Enigma-game-svn] r1128 - in feature_branches/hp_lotm: images/lotm	input/lotm
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#560">[ date ]</a>
              <a href="thread.html#560">[ thread ]</a>
              <a href="subject.html#560">[ subject ]</a>
              <a href="author.html#560">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/enigma-game-svn">More information about the Enigma-game-svn
mailing list</a><br>
</body></html>
