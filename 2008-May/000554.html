<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Enigma-game-svn] r1121 - in trunk: data data/gfx16 data/gfx32	data/gfx40 data/gfx48 data/gfx64 src src/stones
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/enigma-game-svn/2008-May/index.html" >
   <LINK REL="made" HREF="mailto:enigma-game-svn%40lists.berlios.de?Subject=Re%3A%20%5BEnigma-game-svn%5D%20r1121%20-%20in%20trunk%3A%20data%20data/gfx16%20data/gfx32%0A%09data/gfx40%20data/gfx48%20data/gfx64%20src%20src/stones&In-Reply-To=%3C200805042051.m44Kpw2A030185%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000553.html">
   <LINK REL="Next"  HREF="000555.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Enigma-game-svn] r1121 - in trunk: data data/gfx16 data/gfx32	data/gfx40 data/gfx48 data/gfx64 src src/stones</H1>
    <B>ral at BerliOS</B> 
    <A HREF="mailto:enigma-game-svn%40lists.berlios.de?Subject=Re%3A%20%5BEnigma-game-svn%5D%20r1121%20-%20in%20trunk%3A%20data%20data/gfx16%20data/gfx32%0A%09data/gfx40%20data/gfx48%20data/gfx64%20src%20src/stones&In-Reply-To=%3C200805042051.m44Kpw2A030185%40sheep.berlios.de%3E"
       TITLE="[Enigma-game-svn] r1121 - in trunk: data data/gfx16 data/gfx32	data/gfx40 data/gfx48 data/gfx64 src src/stones">ral at mail.berlios.de
       </A><BR>
    <I>Sun May  4 22:51:58 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000553.html">[Enigma-game-svn] r1120 - in trunk: data data/schemas src src/stones
</A></li>
        <LI>Next message: <A HREF="000555.html">[Enigma-game-svn] r1122 - trunk/data
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#554">[ date ]</a>
              <a href="thread.html#554">[ thread ]</a>
              <a href="subject.html#554">[ subject ]</a>
              <a href="author.html#554">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: ral
Date: 2008-05-04 22:51:56 +0200 (Sun, 04 May 2008)
New Revision: 1121

Added:
   trunk/data/gfx16/sh_window.png
   trunk/data/gfx32/sh_window.png
   trunk/data/gfx40/sh_window.png
   trunk/data/gfx48/sh_window.png
   trunk/data/gfx64/sh_window.png
Removed:
   trunk/data/gfx32/sh-window-e.png
   trunk/data/gfx32/sh-window-n.png
   trunk/data/gfx32/sh-window-s.png
   trunk/data/gfx32/sh-window-w.png
   trunk/data/gfx40/sh-window-e.png
   trunk/data/gfx40/sh-window-n.png
   trunk/data/gfx40/sh-window-s.png
   trunk/data/gfx40/sh-window-w.png
   trunk/data/gfx48/sh-window-e.png
   trunk/data/gfx48/sh-window-n.png
   trunk/data/gfx48/sh-window-s.png
   trunk/data/gfx48/sh-window-w.png
Modified:
   trunk/data/models-2d.lua
   trunk/data/models-64.lua
   trunk/src/d_models.hh
   trunk/src/ox_oxyd1.cc
   trunk/src/stones/LightPassengerStone.cc
   trunk/src/stones/WindowStone.cc
Log:
Trunk 1.1: 
- fix moving Lightpassenger swap behaviour
- Window stone part I:
  - finish shadow
  - fix breaking animation and add shadow
  - fix DAT window
Note:
- new API window is not yet finished


Added: trunk/data/gfx16/sh_window.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx16/sh_window.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Deleted: trunk/data/gfx32/sh-window-e.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx32/sh-window-n.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx32/sh-window-s.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx32/sh-window-w.png
===================================================================
(Binary files differ)

Added: trunk/data/gfx32/sh_window.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx32/sh_window.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Deleted: trunk/data/gfx40/sh-window-e.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx40/sh-window-n.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx40/sh-window-s.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx40/sh-window-w.png
===================================================================
(Binary files differ)

Added: trunk/data/gfx40/sh_window.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx40/sh_window.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Deleted: trunk/data/gfx48/sh-window-e.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx48/sh-window-n.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx48/sh-window-s.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx48/sh-window-w.png
===================================================================
(Binary files differ)

Added: trunk/data/gfx48/sh_window.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx48/sh_window.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx64/sh_window.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx64/sh_window.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Modified: trunk/data/models-2d.lua
===================================================================
--- trunk/data/models-2d.lua	2008-05-02 22:11:15 UTC (rev 1120)
+++ trunk/data/models-2d.lua	2008-05-04 20:51:56 UTC (rev 1121)
@@ -1187,30 +1187,11 @@
 -- st-window --
 do
     local fg_window = DefSubimages(&quot;st-window&quot;, {modelname=&quot;fg-window&quot;,w=4,h=4})
+    local sh_window = DefSubimages(&quot;sh_window&quot;, {modelname=&quot;sh_window&quot;,w=4,h=4,imgw=ShadowSize,imgh=ShadowSize})
 
-    local shadowlist = {{}, -- undefined &quot;windowless&quot; window stone
-                        {&quot;sh-window-w&quot;},
-                        {&quot;sh-window-s&quot;},
-                        {&quot;sh-window-s&quot;,&quot;sh-window-w&quot;},
-                        {&quot;sh-window-e&quot;},
-                        {&quot;sh-window-e&quot;,&quot;sh-window-w&quot;},
-                        {&quot;sh-window-e&quot;,&quot;sh-window-s&quot;},
-                        {&quot;sh-window-e&quot;,&quot;sh-window-s&quot;,&quot;sh-window-w&quot;},
-                        {&quot;sh-window-n&quot;},
-                        {&quot;sh-window-n&quot;,&quot;sh-window-w&quot;},
-                        {&quot;sh-window-n&quot;,&quot;sh-window-s&quot;},
-                        {&quot;sh-window-n&quot;,&quot;sh-window-s&quot;,&quot;sh-window-w&quot;},
-                        {&quot;sh-window-n&quot;,&quot;sh-window-e&quot;},
-                        {&quot;sh-window-n&quot;,&quot;sh-window-e&quot;,&quot;sh-window-w&quot;},
-                        {&quot;sh-window-n&quot;,&quot;sh-window-e&quot;,&quot;sh-window-s&quot;},
-                        {&quot;sh-window-n&quot;,&quot;sh-window-e&quot;,&quot;sh-window-s&quot;,&quot;sh-window-w&quot;}
-                       }
-
-    for i = 2, 16 do
-        DefMultipleComposite(&quot;sh-window&quot;..i, shadowlist[i])
-        DefShModel(&quot;st_window&quot;..(16-i), &quot;fg-window&quot;..i, &quot;sh-window&quot;..i)
+    for i = 2, 16 do  -- faces + 1
+        DefShModel(&quot;st_window&quot;..(16-i), &quot;fg-window&quot;..i, &quot;sh_window&quot;..i)
     end
-
     -- 4 sided window stone:
     DefAlias(&quot;st_window&quot;,&quot;st_window0&quot;)
 
@@ -1218,16 +1199,15 @@
     local breaking_window_names = {}
     local breaking_images = DefSubimages(&quot;st-window-break&quot;, {h=4})
 
-    for i=1, table.getn(fg_window) do
+    for i=1, table.getn(fg_window) do   -- faces + 1
         breaking_window_names[i] = {}
         for j = 1, table.getn(breaking_images) do
-            breaking_window_names[i][j] = &quot;st-window&quot;..i..&quot;-&quot;..j
+            breaking_window_names[i][j] = &quot;st-window-breaking&quot;..i..&quot;-&quot;..j
             display.DefineComposite(breaking_window_names[i][j], fg_window[i], breaking_images[j])
         end
         local frames = BuildFrames(breaking_window_names[i], 130)
-        -- TODO: finish anim names used:
-        DefAnim(&quot;st_window&quot;..i..&quot;_anim&quot;, frames)
-        DefAnim(&quot;st_window_anim&quot;, frames)
+        DefAnim(&quot;st_window&quot;..(16-i)..&quot;_anim_fg&quot;, frames)
+        DefShModel(&quot;st_window&quot;..(16-i)..&quot;_anim&quot;, &quot;st_window&quot;..(16-i)..&quot;_anim_fg&quot;, sh_window[i]);
     end
 end
 

Modified: trunk/data/models-64.lua
===================================================================
--- trunk/data/models-64.lua	2008-05-02 22:11:15 UTC (rev 1120)
+++ trunk/data/models-64.lua	2008-05-04 20:51:56 UTC (rev 1121)
@@ -1,6 +1,6 @@
 TileSize = 64
 SpriteSize = 80
-ShadowSize = 81
+ShadowSize = 82
 
 DefineFont (&quot;timefont&quot;, &quot;vera_sans.ttf&quot;, 40, &quot;timefont&quot;, 180, 180, 180)
 DefineFont (&quot;smallalternative&quot;, &quot;DejaVuSansCondensed.ttf&quot;, 14, &quot;menufont&quot;)

Modified: trunk/src/d_models.hh
===================================================================
--- trunk/src/d_models.hh	2008-05-02 22:11:15 UTC (rev 1120)
+++ trunk/src/d_models.hh	2008-05-04 20:51:56 UTC (rev 1121)
@@ -131,6 +131,7 @@
         }
         void draw_shadow(ecl::GC &amp;gc, int x, int y) {
             bg-&gt;draw_shadow(gc,x,y);
+//            fg-&gt;draw_shadow(gc,x,y);
         }
         Model *clone() {
             return new CompositeModel(bg-&gt;clone(), fg-&gt;clone());

Modified: trunk/src/ox_oxyd1.cc
===================================================================
--- trunk/src/ox_oxyd1.cc	2008-05-02 22:11:15 UTC (rev 1120)
+++ trunk/src/ox_oxyd1.cc	2008-05-04 20:51:56 UTC (rev 1121)
@@ -214,7 +214,7 @@
     &quot;st-oneway_white-e&quot;,        // Oxyd1 stone 0x3b
     &quot;st-oneway_white-n&quot;,        // Oxyd1 stone 0x3c
     &quot;st-oneway_white-s&quot;,        // Oxyd1 stone 0x3d
-    &quot;st-window&quot;,                // Oxyd1 stone 0x3e
+    &quot;st_window&quot;,                // Oxyd1 stone 0x3e
     &quot;&quot;,                         // Oxyd1 stone 0x3f magic stone
     &quot;&quot;,                         // Oxyd1 stone 0x40 magic stone
     &quot;&quot;,                         // Oxyd1 stone 0x41 magic stone

Modified: trunk/src/stones/LightPassengerStone.cc
===================================================================
--- trunk/src/stones/LightPassengerStone.cc	2008-05-02 22:11:15 UTC (rev 1120)
+++ trunk/src/stones/LightPassengerStone.cc	2008-05-04 20:51:56 UTC (rev 1121)
@@ -23,6 +23,7 @@
 #include &quot;laser.hh&quot;
 #include &quot;main.hh&quot;
 #include &quot;player.hh&quot;
+#include &quot;server.hh&quot;
 
 #include &lt;algorithm&gt;
 
@@ -97,6 +98,8 @@
     
     void LightPassengerStone::on_creation(GridPos p) {
         activatePhoto();
+        if (updateCurrentLightDirs() != NODIRBIT)
+            GameTimer.set_alarm(this, calcInterval(), false);
         Stone::on_creation(p);
     }
     
@@ -141,7 +144,8 @@
 
     void LightPassengerStone::on_impulse(const Impulse&amp; impulse) {
         Actor *a = dynamic_cast&lt;Actor*&gt;(impulse.sender);
-        if (a == NULL &amp;&amp; ((objFlags &amp; OBJBIT_LIGHTNEWDIRS) == NODIRBIT || state == OFF))
+        if (a == NULL &amp;&amp; ((objFlags &amp; OBJBIT_LIGHTNEWDIRS) == NODIRBIT || state == OFF 
+                || server::GameCompatibility != GAMET_ENIGMA))
             move_stone(impulse.dir);
     }
     
@@ -207,17 +211,19 @@
             is 50 ms or the interval given in &quot;interval&quot;.
         */
         double base = getAttr(&quot;interval&quot;);
-        if (Value f = getAttr(&quot;friction&quot;))
-            base *= 1.0 + (double)f * GetFloor(get_pos())-&gt;get_friction();
-        if (Value g = getAttr(&quot;gradient&quot;)) {
-            Direction skateDir = (Direction)((int)((objFlags &amp; OBJBIT_SKATEDIR) &gt;&gt; 24) - 1);
-            if (skateDir != NODIR) {
-                V2 vec = V2(0.0,0.0);
-                double quot = 0;
-                GetFloor(get_pos())-&gt;add_force(0, vec);
-                quot = skateDir == NORTH ? -vec[1] : skateDir == SOUTH ? vec[1] :
-                    skateDir == EAST ? vec[0] : skateDir == WEST ? -vec[0] : 0;
-                base /= std::max(1.0 + (double)g * quot, 0.01);                    
+        if (Floor *floor = GetFloor(get_pos())) {
+            if (Value f = getAttr(&quot;friction&quot;))
+                base *= 1.0 + (double)f * floor-&gt;get_friction();
+            if (Value g = getAttr(&quot;gradient&quot;)) {
+                Direction skateDir = (Direction)((int)((objFlags &amp; OBJBIT_SKATEDIR) &gt;&gt; 24) - 1);
+                if (skateDir != NODIR) {
+                    V2 vec = V2(0.0,0.0);
+                    double quot = 0;
+                    floor-&gt;add_force(0, vec);
+                    quot = skateDir == NORTH ? -vec[1] : skateDir == SOUTH ? vec[1] :
+                        skateDir == EAST ? vec[0] : skateDir == WEST ? -vec[0] : 0;
+                    base /= std::max(1.0 + (double)g * quot, 0.01);                    
+                }
             }
         }
         return std::max(base, 0.02);

Modified: trunk/src/stones/WindowStone.cc
===================================================================
--- trunk/src/stones/WindowStone.cc	2008-05-02 22:11:15 UTC (rev 1120)
+++ trunk/src/stones/WindowStone.cc	2008-05-04 20:51:56 UTC (rev 1121)
@@ -58,7 +58,7 @@
                 Object::setAttr(&quot;$connections&quot;, ALL_DIRECTIONS ^ remainigFaces);     // avoid init of model
                 sound_event (&quot;shatter&quot;);
                 state = (remainigFaces == NODIRBIT) ? FINALBREAK : BREAK;
-                set_anim(&quot;st_window_anim&quot;);  // TODO anim with remaining unbroken faces
+                set_anim(ecl::strf(&quot;st_window%d_anim&quot;, getConnections()));
             }
             
             else if (player::WieldedItemIs (sc.actor, &quot;it_wrench&quot;)) {


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000553.html">[Enigma-game-svn] r1120 - in trunk: data data/schemas src src/stones
</A></li>
	<LI>Next message: <A HREF="000555.html">[Enigma-game-svn] r1122 - trunk/data
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#554">[ date ]</a>
              <a href="thread.html#554">[ thread ]</a>
              <a href="subject.html#554">[ subject ]</a>
              <a href="author.html#554">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/enigma-game-svn">More information about the Enigma-game-svn
mailing list</a><br>
</body></html>
