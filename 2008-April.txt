From andreasl at mail.berlios.de  Tue Apr  1 00:06:29 2008
From: andreasl at mail.berlios.de (andreasl at mail.berlios.de)
Date: Tue, 1 Apr 2008 00:06:29 +0200
Subject: [Enigma-game-svn] r1089 - in feature_branches/hp_lotm: images/lotm
	input/lotm
Message-ID: <200803312206.m2VM6TcS014445@sheep.berlios.de>

Author: andreasl
Date: 2008-04-01 00:06:24 +0200 (Tue, 01 Apr 2008)
New Revision: 1089

Added:
   feature_branches/hp_lotm/images/lotm/lotm_200804_d.png
   feature_branches/hp_lotm/images/lotm/lotm_200804_e.png
Modified:
   feature_branches/hp_lotm/input/lotm/lotm_200804.html
   feature_branches/hp_lotm/input/lotm/lotm_200804_de.html
Log:
LotM April 2008:
 - added some captions (English, German)
 - added two images (E,G)
 - added Craven's comment (E,G)
 - English proofread of Ronald's comment (E,G)
Todo:
 - Russian translation
 - Validation


Added: feature_branches/hp_lotm/images/lotm/lotm_200804_d.png
===================================================================
(Binary files differ)


Property changes on: feature_branches/hp_lotm/images/lotm/lotm_200804_d.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: feature_branches/hp_lotm/images/lotm/lotm_200804_e.png
===================================================================
(Binary files differ)


Property changes on: feature_branches/hp_lotm/images/lotm/lotm_200804_e.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Modified: feature_branches/hp_lotm/input/lotm/lotm_200804.html
===================================================================
--- feature_branches/hp_lotm/input/lotm/lotm_200804.html	2008-03-31 19:27:00 UTC (rev 1088)
+++ feature_branches/hp_lotm/input/lotm/lotm_200804.html	2008-03-31 22:06:24 UTC (rev 1089)
@@ -3,9 +3,11 @@
 
   <h3 class="lotm">
     <span class="date">April 2008: </span>
-    &quot;Turnstiles for Two - Rhapsody on Turnstiles in Blue and Green&quot; by Ronald Lamprecht
+    &quot;Turnstiles for Two - Rhapsody on Turnstiles in Blue and Green&quot;
   </h3>
 
+<h4>by Ronald Lamprecht</h4>
+
 <p>
 The world of the &quot;black ball&quot; has lots of facets; races,
 meditating, visiting temples and mazes, deciphering, space adventures, alone or
@@ -112,6 +114,25 @@
 incorrect. The subtitle is quite apt.
 </p>
 
+<h4>&quot;Aside from experience it's a matter of sure instinct&quot;</h4>
+
+<div class="quote">It's quite a while ago since I've been playing &quot;Turnstiles for Two&quot;. But now that I've taken a closer look at the level again, I remembered, that most of all I had problems to stay on the spot after turning down one of the turntiles' arms. Espicially that applies to the complex in the middle of the bottom half, where you don't have much room to maneuver. No wonder the availability of the pins makes such a great difference between easy and difficult mode.</div>
+
+<div class="quote">Additionally foresighted planning is the word! It's not only a question of getting to the oxyds but also of getting back there. It took me quite some time to figure out how to fit these &quot;islands&quot; in the centre of the level into my plannings.</div> 
+
+<div class="quote">But the real difficulty about &quot;Turnstiles for Two&quot; is - once again - to make it to the final oxyd. Aside from experience it's a matter of sure instinct: although you've got the hang of it, it still won't work each time. You'll have to rush to the right place as quickly as possible, to catch the transporter to the island with the last oxyd.</div>
+
+<div class="quote">By the way, there's another level by Ronald Lamprecht (&quot;Cold Meditation&quot;), where you'll have to take a similar action, to be pushed into the final block of ice.</div>
+
+<div class="author">Craven</div>
+
+<div class="lotmpic">
+<img src="$$imagedir$$/lotm/lotm_200804_d.png" alt="Level des Monats 04/2008" border="0">
+<div class="imagetitle">
+Hmm &hellip; and now?
+</div>
+</div>
+
 <p>
 So, let's see and listen to what our two musicians have to offer. The beginning
 is quite relaxed. In the initial chords, one sets the tune, and the other
@@ -125,6 +146,7 @@
 from both sides.
 </p>
 
+<h4>&quot;I appreciate his devotion to fully exploring new elements to the game&quot;</h4>
 
 <div class="quote">I was glad to be asked to comment on &quot;Turnstiles for Two&quot; not only
 because of my life in music, but because it's actually my favorite
@@ -220,6 +242,9 @@
 your duet.
 </p>
 
+<h4>&quot;The green turnstile had proven to be more valuable than I would ever
+had thought it could be&quot;</h4>
+
 <p>
 As a tiny dissonance I mention the vortex; as it's not compulsory to use
 it. But maybe I didn't comprehend the composition in its complete entirety.
@@ -227,14 +252,13 @@
 indulgence.
 </p>
 
-
 <div class="quote">It may sound crazy, but &quot;Turnstiles for Two&quot; is a commissioned work. In 
 the aftermath of release 1.00 we received reports about spurious crash 
 problems with turnstile levels. While debugging the turnstile code the 
 green turnstiles attracted my attention. There had just been one level 
 that made use of it - &quot;Zig Zag&quot;, and it made just indirect usage of it. 
-I questioned the existence of this variation with all the extracode that 
-it caused. But after a short time I found a first direct usage pattern 
+I questioned the existence of this variation with all the extra code that 
+it required. But after a short time I found a first direct usage pattern 
 for a one marble level resulting in the level &quot;Revolver&quot; in mid February 
 2007.</div>
  
@@ -243,7 +267,7 @@
 introductionary level for green turnstiles that should demo some useful 
 patterns. Two days later I tried to write this level. After three hours 
 of work I had finished two new levels, &quot;Cold Meditation&quot; and &quot;Polar 
-Bear's Paradise&quot;. Next day Andreas desperatly asked if &quot;Cold Meditation&quot; 
+Bear's Paradise&quot;. Next day Andreas desperately asked if &quot;Cold Meditation&quot; 
 should be the announced demo level.</div>
 
 <div class="quote">Of course not! I just had collected some patterns and got distracted by 
@@ -251,27 +275,36 @@
 with every pattern that I added to the level I found new green turnstile 
 patterns. Two funny evening sessions later &quot;Turnstiles for Two&quot; was ready 
 for a first shipment on the early hours of March 17th. The green 
-turnstile had prooven to be more valuable than I would ever had thought 
+turnstile had proven to be more valuable than I would ever had thought 
 it could be.</div>
 
+<div class="lotmpic">
+<img src="$$imagedir$$/lotm/lotm_200804_e.png" alt="Level des Monats 04/2008" border="0">
+<div class="imagetitle">
+A seesaw for childs and adults <br>of (nearly) all ages
+</div>
+</div>
+
 <div class="quote">On both evenings I interrupted my work looking for some inspiration. I 
 sat down at the piano and both times I started playing by heart one of 
 my favorite pieces - Gershwin's &quot;Rhapsody In Blue&quot;. It just did fit - 
 the various independent patterns to a common theme bound together by a 
-global frame, black and white, and additionally emotions like desire and indetermination. 
+global framework, black and white, and additional emotions like desire and indetermination. 
 In fact Gershwin did first name his piece &quot;Nocturne in Blue and Green&quot; 
 the colors standing for the emotions. With the green turnstiles being 
 the main subject I just had to subtitle my level &quot;Rhapsody on turnstiles 
-in blue and green&quot;.</div>
+in blue and green&quot;.
+</div>
 
 <div class="quote">Several times users did express their astonishment about the time frame 
 in which I wrote some of my best levels. But that is the very nature of 
 creativity. You spend uncounted hours playing and developing Enigma and 
-suddenly you have the idea for a level. BTW Gershwin did wrote his 
-rhapsody in 24 days and nights! But he finished settling down his own 
+suddenly you have the idea for a level. BTW Gershwin wrote his 
+rhapsody in 24 days and nights! But he finished setting down his own 
 piano solo part months after the world premiere.</div>
 
-<div class="quote">&quot;Turnstiles for Two&quot; had not been finshed after two evenings, too. I 
+<div class="quote">&quot;Turnstiles for Two&quot; had not been finished after
+two evenings, either. I 
 detected one subtle point, that I first did not know how to solve - a 
 fair, solvable oxyd distribution. Just shuffling all 16 oxyds does not 
 work. E.g. if all the upper oxyds build pairs there would be no reason 
@@ -279,7 +312,7 @@
 that you have to return to the upper part after investigation of the 
 lower part. Finally I wrote a small special Lua function that takes 
 appropriate influence on the oxyd distribution. But this problem of fair 
-oxyd distributions had now been set on Enigma's todo list. It has been a 
+oxyd distributions had now been set on Enigma's to-do list. It has been a 
 month of work in October to find and code a general algorithm that
 solves this quite complex problem for all upcoming levels.</div>
 

Modified: feature_branches/hp_lotm/input/lotm/lotm_200804_de.html
===================================================================
--- feature_branches/hp_lotm/input/lotm/lotm_200804_de.html	2008-03-31 19:27:00 UTC (rev 1088)
+++ feature_branches/hp_lotm/input/lotm/lotm_200804_de.html	2008-03-31 22:06:24 UTC (rev 1089)
@@ -3,9 +3,11 @@
 
   <h3 class="lotm">
     <span class="date">April 2008: </span>
-    &quot;Turnstiles for Two - Rhapsody on Turnstiles in Blue and Green&quot; by Ronald Lamprecht
+    &quot;Turnstiles for Two - Rhapsody on Turnstiles in Blue and Green&quot;
   </h3>
 
+<h4>von Ronald Lamprecht</h4>
+
 <p>Die Welt der &quot;schwarzen Kugel&quot; kennt viele Facetten: Meditationen, 
 Besuche von Tempeln und Irrg&auml;rten, Dechiffrieren, Weltraumabenteuer, 
 allein oder zu zweit, sogar mit Albtr&auml;ume sind wir gesegnet, um nur 
@@ -105,6 +107,25 @@
 das Ges&uuml;lze - hat der gar nicht so unrecht. Der Untertitel k&ouml;nnte kaum 
 besser gew&auml;hlt sein.&quot;</p>
 
+<h4>&quot;Neben Erfahrung ist auch ein gewisses Fingerspitzengef&uuml;hl gefragt&quot;</h4>
+
+<div class="quote">Es ist schon eine Weile her, dass ich &quot;Turnstiles for Two&quot; gespielt habe. Nachdem ich mir den Level jetzt noch einmal angesehen habe, ist mir eingefallen, dass ich vor allen Dingen Schwierigkeiten hatte, beim Herumklappen der Dreharme an der richtigen Stelle zu bleiben. Das gilt besonders f&uuml;r den sehr engen Komplex in der Mitte der unteren H&auml;lfte, weil man da kaum Platz zum man&ouml;vrieren hat. Kein Wunder also, dass die Verf&uuml;gbarkeit des Pins einen gewaltigen Unterschied zwischen leichtem und schwerem Modus macht.</div>
+
+<div class="quote">Zus&auml;tzlich dazu ist vorausschauendes Planen gefragt, damit man nicht nur zu den Oxyds hin, sondern auch wieder zur&uuml;ck gelangt. Es hat bei mir da schon eine Weile gebraucht, bis ich wusste, wie ich die &quot;Inseln&quot; in der Mitte des Levels richtig einbaue.</div>
+
+<div class="quote">Die eigentliche Schwierigkeit bei &quot;Turnstiles for Two&quot; liegt aber mal wieder darin, den allerletzten Oxyd zu erwischen. Da ist neben Erfahrung auch ein gewisses Fingerspitzengef&uuml;hl gefragt, denn selbst wenn man den Trick raus hat, klappt es dennoch nicht jedes Mal. Man muss schnell genug an die richtige Stelle flitzen, um auf die Insel mit dem letzten Oxyd transportiert zu werden.</div>
+
+<div class="quote">Es gibt da &uuml;brigens noch einen anderen Level von Ronald Lamprecht (Cold Meditation), bei dem man eine &auml;hnliche Aktion machen muss, um unter den letzten Eisblock geschubst zu werden.</div>
+
+<div class="author">Craven</div>
+
+<div class="lotmpic">
+<img src="$$imagedir$$/lotm/lotm_200804_d.png" alt="Level des Monats 04/2008" border="0">
+<div class="imagetitle">
+Hmm &hellip; und jetzt?
+</div>
+</div>
+
 <p>Also schauen und h&ouml;ren wir uns an, was unsere zwei Musiker zu bieten haben. 
 Der Anfang ist noch ganz entspannt. In den ersten Akkorden gibt einer vor, 
 wo's lang geht und der andere folgt. Doch nun n&auml;hern sich unsere beiden 
@@ -119,6 +140,9 @@
 eine mit Kreuzen gespickte Melodie, die von beiden Seiten h&ouml;chste Konzentration 
 und Pr&auml;zision erfordert.</p> 
 
+<h4>&quot;Ich sch&auml;tze seine Hingabe, mit
+der er neue Spielelemente in ihrem ganzen Funktionsumfang erschlie&szlig;t
+&quot;</h4>
 
 <div class="quote">Ich bin froh, dass man mich gefragt hat, einen Kommentar f&uuml;r 
 &quot;Turnstiles For Two&quot; zu schreiben, nicht nur weil ich in der Welt der 
@@ -216,6 +240,9 @@
 <p>Also Leute, rafft euch auf, stimmt eure &quot;Instrumente&quot; und legt los zur &quot;Session 
 f&uuml;r zwei&quot;.</p>
 
+<h4>&quot;Die gr&uuml;nen Turnstiles hatten sich als weitaus wertvoller
+erwiesen, als ich es jemals zu hoffen gewagt hatte&quot;</h4>
+
 <p>Als einen ganz kleinen Misston empfinde ich den Vortex, denn dieser wird 
 eigentlich nicht zwingend ben&ouml;tigt. Aber vielleicht habe ich die Komposition 
 nur noch nicht in ihrer kompletten G&auml;nze erfasst. Also werde ich einfach nochmal 
@@ -254,6 +281,13 @@
 dann so weit f&uuml;r den ersten Versand. Die gr&uuml;nen Turnstiles hatten sich 
 als weitaus wertvoller erwiesen, als ich es jemals zu hoffen gewagt hatte!</div> 
 
+<div class="lotmpic">
+<img src="$$imagedir$$/lotm/lotm_200804_e.png" alt="Level des Monats 04/2008" border="0">
+<div class="imagetitle">
+Eine Wippe f&uuml;r Kinder und <br> Erwachsene in (fast) jedem Alter
+</div>
+</div>
+
 <div class="quote">Auf der Suche nach Inspirationen unterbrach ich an beiden Abenden meine 
 Arbeit. Beide Male setzte ich mich ans Klavier und begann aus dem Kopf 
 eines meiner Lieblingsst&uuml;cke zu spielen: Gershwins &quot;Rhapsodie In Blue&quot;.



From ral at mail.berlios.de  Tue Apr  1 01:41:45 2008
From: ral at mail.berlios.de (ral at BerliOS)
Date: Tue, 1 Apr 2008 01:41:45 +0200
Subject: [Enigma-game-svn] r1090 - in trunk: data data/schemas src
Message-ID: <200803312341.m2VNfjpl017466@sheep.berlios.de>

Author: ral
Date: 2008-04-01 01:41:44 +0200 (Tue, 01 Apr 2008)
New Revision: 1090

Modified:
   trunk/data/api1init.lua
   trunk/data/schemas/objects.xml
   trunk/data/startup.lua
   trunk/src/ox_extra.cc
   trunk/src/ox_magnum.cc
   trunk/src/ox_oxyd1.cc
   trunk/src/ox_peroxyd.cc
   trunk/src/stones_complex.cc
Log:
Trunk 1.1: new API reengineering big*
- fix mapping st-lasertimeswitch to st_laserflop
- substitute by ClusterStones: all st-big*, st-brick, st-blue-sand,
  st-wood_001
- Clusterstone object declaration


Modified: trunk/data/api1init.lua
===================================================================
--- trunk/data/api1init.lua	2008-03-31 22:06:24 UTC (rev 1089)
+++ trunk/data/api1init.lua	2008-03-31 23:41:44 UTC (rev 1090)
@@ -59,11 +59,43 @@
     it_wormhole_off = "it-wormhole-off",
     st_blocker = "st-blocker",
     st_blocker_new = "st-blocker-growing",
+    st_bluesand = "st-blue-sand",
+    st_bluesand_w = "st-bigbluesand-w",
+    st_bluesand_s = "st-bigbluesand-s",
+    st_bluesand_sw = "st-bigbluesand-sw",
+    st_bluesand_e = "st-bigbluesand-e",
+    st_bluesand_ew = "st-bigbluesand-ew",
+    st_bluesand_es = "st-bigbluesand-es",
+    st_bluesand_esw = "st-bigbluesand-esw",
+    st_bluesand_n = "st-bigbluesand-n",
+    st_bluesand_nw = "st-bigbluesand-nw",
+    st_bluesand_ns = "st-bigbluesand-ns",
+    st_bluesand_nsw = "st-bigbluesand-nsw",
+    st_bluesand_ne = "st-bigbluesand-ne",
+    st_bluesand_new = "st-bigbluesand-new",
+    st_bluesand_nes = "st-bigbluesand-nes",
+    st_bluesand_nesw = "st-bigbluesand-nesw",
     st_boulder = "st-bolder",
     st_boulder_n = "st-bolder-n",
     st_boulder_e = "st-bolder-e",
     st_boulder_s = "st-bolder-s",
     st_boulder_w = "st-bolder-w",
+    st_brick = "st-brick",
+    st_brick_w = "st-bigbrick-w",
+    st_brick_s = "st-bigbrick-s",
+    st_brick_sw = "st-bigbrick-sw",
+    st_brick_e = "st-bigbrick-e",
+    st_brick_ew = "st-bigbrick-ew",
+    st_brick_es = "st-bigbrick-es",
+    st_brick_esw = "st-bigbrick-esw",
+    st_brick_n = "st-bigbrick-n",
+    st_brick_nw = "st-bigbrick-nw",
+    st_brick_ns = "st-bigbrick-ns",
+    st_brick_nsw = "st-bigbrick-nsw",
+    st_brick_ne = "st-bigbrick-ne",
+    st_brick_new = "st-bigbrick-new",
+    st_brick_nes = "st-bigbrick-nes",
+    st_brick_nesw = "st-bigbrick-nesw",
     st_coinslot = "st-coinslot",
     st_floppy = "st-floppy",
     st_fourswitch = "st-fourswitch",
@@ -72,10 +104,11 @@
     st_laser_e = "st-laser-e",
     st_laser_n = "st-laser-n",
     st_laserswitch = "st-laserswitch",
-    st_lasertimeswitch = "st-laserflop",
+    st_laserflop = "st-lasertimeswitch",
     st_monoflop = "st-timeswitch",
+    st_oxyd = "st-oxyd",
+    st_panel = "st-wood_001",
     st_polarswitch = "st-polarswitch",
-    st_oxyd = "st-oxyd",
     st_switch = "st-switch",
     st_switch_black = "st-switch_black",
     st_switch_white = "st-switch_white",
@@ -179,6 +212,25 @@
              _key = "oxydcolor"
 	 end
      end
+     if key == "connections" then
+         if val == 1 then _val = ""
+         elseif  val == 2  then _val = "w"
+         elseif  val == 3  then _val = "s"
+         elseif  val == 4  then _val = "sw"
+         elseif  val == 5  then _val = "e"
+         elseif  val == 6  then _val = "ew"
+         elseif  val == 7  then _val = "es"
+         elseif  val == 8  then _val = "esw"
+         elseif  val == 9  then _val = "n"
+         elseif  val == 10 then _val = "nw"
+         elseif  val == 11 then _val = "ns"
+         elseif  val == 12 then _val = "nsw"
+         elseif  val == 13 then _val = "ne"
+         elseif  val == 14 then _val = "new"
+         elseif  val == 15 then _val = "nes"
+         elseif  val == 16 then _val = "nesw"
+         end
+     end
      if key == "delay" then
          _key = "interval"
      end
@@ -263,6 +315,25 @@
      if key == "whiteball" then
         if val == 1 then val = 1 else val = 0 end
      end
+     if key == "connections" then
+         if val == "" then val = 1
+         elseif  val == "w"    then val = 2
+         elseif  val == "s"    then val = 3
+         elseif  val == "sw"   then val = 4
+         elseif  val == "e"    then val = 5
+         elseif  val == "ew"   then val = 6
+         elseif  val == "es"   then val = 7
+         elseif  val == "esw"  then val = 8
+         elseif  val == "n"    then val = 9
+         elseif  val == "nw"   then val = 10
+         elseif  val == "ns"   then val = 11
+         elseif  val == "nsw"  then val = 12
+         elseif  val == "ne"   then val = 13
+         elseif  val == "new"  then val = 14
+         elseif  val == "nes"  then val = 15
+         elseif  val == "nesw" then val = 16
+         end
+     end
      if _obj_name == "st-oxyd" then
          if key == "color" then
 	     val = "" .. val   -- convert to string

Modified: trunk/data/schemas/objects.xml
===================================================================
--- trunk/data/schemas/objects.xml	2008-03-31 22:06:24 UTC (rev 1089)
+++ trunk/data/schemas/objects.xml	2008-03-31 23:41:44 UTC (rev 1090)
@@ -3,9 +3,12 @@
   <attributes>
     <attr name="action" type="tokens" default="nil" rw="rw"/>
     <attr name="autoclose" type="bool" default="false" rw="rw"/>
+    <attr name="cluster" type="int" default="nil" min="0" max="1" rw="rw"/>
     <attr name="color" type="int" default="nil" min="0" max="1" rw="rw"/>
+    <attr name="connections" type="string" default="nil" rw="rw"/>
     <attr name="counterclock" type="bool" default="false" rw="rw"/>
     <attr name="destination" type="tokens" default="nil" rw="rw"/>
+    <attr name="faces" type="string" default="nil" rw="rw"/>
     <attr name="instant" type="bool" default="false" rw="rw"/>
     <attr name="interval" type="double" default="1" rw="rw"/>
     <attr name="inverse" type="bool" default="false" rw="rw"/>
@@ -112,6 +115,12 @@
       <attr name="state" value="1"/>
     </object>
     <object name="st" abstract="true"/>
+    <object name="st_clusterstone" abstract="true">
+      <attr name="cluster"/>
+      <attr name="connections"/>
+      <attr name="faces"/>
+      <msg name="_model_reanimated"/>
+    </object>
     <object name="st_blocker">
       <attr name="autoclose"/>
       <msg name="close"/>
@@ -122,6 +131,52 @@
     </object>
     <object name="st_blocker_new" init="true">
     </object>
+    <object name="st_bluesand" super="st_clusterstone"/>
+    <object name="st_bluesand_w">
+      <attr name="connections" value="w"/>
+    </object>
+    <object name="st_bluesand_s">
+      <attr name="connections" value="s"/>
+    </object>
+    <object name="st_bluesand_sw">
+      <attr name="connections" value="sw"/>
+    </object>
+    <object name="st_bluesand_e">
+      <attr name="connections" value="e"/>
+    </object>
+    <object name="st_bluesand_ew">
+      <attr name="connections" value="ew"/>
+    </object>
+    <object name="st_bluesand_es">
+      <attr name="connections" value="es"/>
+    </object>
+    <object name="st_bluesand_esw">
+      <attr name="connections" value="esw"/>
+    </object>
+    <object name="st_bluesand_n">
+      <attr name="connections" value="n"/>
+    </object>
+    <object name="st_bluesand_nw">
+      <attr name="connections" value="nw"/>
+    </object>
+    <object name="st_bluesand_ns">
+      <attr name="connections" value="ns"/>
+    </object>
+    <object name="st_bluesand_nsw">
+      <attr name="connections" value="nsw"/>
+    </object>
+    <object name="st_bluesand_ne">
+      <attr name="connections" value="ne"/>
+    </object>
+    <object name="st_bluesand_new">
+      <attr name="connections" value="new"/>
+    </object>
+    <object name="st_bluesand_nes">
+      <attr name="connections" value="nes"/>
+    </object>
+    <object name="st_bluesand_nesw">
+      <attr name="connections" value="nesw"/>
+    </object>
     <object name="st_boulder">
       <attr name="counterclock"/>
       <attr name="orientation"/>
@@ -141,6 +196,52 @@
     <object name="st_boulder_n">
       <attr name="orientation" value="3"/>
     </object>
+    <object name="st_brick" super="st_clusterstone"/>
+    <object name="st_brick_w">
+      <attr name="connections" value="w"/>
+    </object>
+    <object name="st_brick_s">
+      <attr name="connections" value="s"/>
+    </object>
+    <object name="st_brick_sw">
+      <attr name="connections" value="sw"/>
+    </object>
+    <object name="st_brick_e">
+      <attr name="connections" value="e"/>
+    </object>
+    <object name="st_brick_ew">
+      <attr name="connections" value="ew"/>
+    </object>
+    <object name="st_brick_es">
+      <attr name="connections" value="es"/>
+    </object>
+    <object name="st_brick_esw">
+      <attr name="connections" value="esw"/>
+    </object>
+    <object name="st_brick_n">
+      <attr name="connections" value="n"/>
+    </object>
+    <object name="st_brick_nw">
+      <attr name="connections" value="nw"/>
+    </object>
+    <object name="st_brick_ns">
+      <attr name="connections" value="ns"/>
+    </object>
+    <object name="st_brick_nsw">
+      <attr name="connections" value="nsw"/>
+    </object>
+    <object name="st_brick_ne">
+      <attr name="connections" value="ne"/>
+    </object>
+    <object name="st_brick_new">
+      <attr name="connections" value="new"/>
+    </object>
+    <object name="st_brick_nes">
+      <attr name="connections" value="nes"/>
+    </object>
+    <object name="st_brick_nesw">
+      <attr name="connections" value="nesw"/>
+    </object>
     <object name="st_floppy">
       <msg name="on"/>
       <msg name="off"/>
@@ -189,6 +290,52 @@
       <msg name="on"/>
       <msg name="signal"/>
     </object>
+    <object name="st_panel" super="st_clusterstone"/>
+    <object name="st_panel_w">
+      <attr name="connections" value="w"/>
+    </object>
+    <object name="st_panel_s">
+      <attr name="connections" value="s"/>
+    </object>
+    <object name="st_panel_sw">
+      <attr name="connections" value="sw"/>
+    </object>
+    <object name="st_panel_e">
+      <attr name="connections" value="e"/>
+    </object>
+    <object name="st_panel_ew">
+      <attr name="connections" value="ew"/>
+    </object>
+    <object name="st_panel_es">
+      <attr name="connections" value="es"/>
+    </object>
+    <object name="st_panel_esw">
+      <attr name="connections" value="esw"/>
+    </object>
+    <object name="st_panel_n">
+      <attr name="connections" value="n"/>
+    </object>
+    <object name="st_panel_nw">
+      <attr name="connections" value="nw"/>
+    </object>
+    <object name="st_panel_ns">
+      <attr name="connections" value="ns"/>
+    </object>
+    <object name="st_panel_nsw">
+      <attr name="connections" value="nsw"/>
+    </object>
+    <object name="st_panel_ne">
+      <attr name="connections" value="ne"/>
+    </object>
+    <object name="st_panel_new">
+      <attr name="connections" value="new"/>
+    </object>
+    <object name="st_panel_nes">
+      <attr name="connections" value="nes"/>
+    </object>
+    <object name="st_panel_nesw">
+      <attr name="connections" value="nesw"/>
+    </object>
     <object name="st_polarswitch">
       <msg name="on"/>
       <msg name="off"/>

Modified: trunk/data/startup.lua
===================================================================
--- trunk/data/startup.lua	2008-03-31 22:06:24 UTC (rev 1089)
+++ trunk/data/startup.lua	2008-03-31 23:41:44 UTC (rev 1090)
@@ -115,8 +115,6 @@
 def_stone("st-beads")
 def_stone("st-bluegray")
 def_stone_hollow("st-bluegray_hole")
-def_stone("st-blue-sand")
-def_stone("st-brick")
 def_stone_movable("st-brownie", "cloth")
 def_stone("st-bumps")
 def_stone("st-camouflage", "cloth")
@@ -151,7 +149,6 @@
 def_stone("st-stone1")
 def_stone("st-stone2")
 def_stone("st-woven")
-def_stone("st-wood_001")
 def_stone("st-yellow")
 
 def_stone_glass("st-glass")

Modified: trunk/src/ox_extra.cc
===================================================================
--- trunk/src/ox_extra.cc	2008-03-31 22:06:24 UTC (rev 1089)
+++ trunk/src/ox_extra.cc	2008-03-31 23:41:44 UTC (rev 1090)
@@ -260,7 +260,7 @@
     UNUSED,              // OxydExtra stone 0x87
     UNUSED,              // OxydExtra stone 0x88
     UNUSED,              // OxydExtra stone 0x89
-    "st-blue-sand",      // OxydExtra stone 0x8a
+    "st_bluesand",       // OxydExtra stone 0x8a
     "st-bluegray",       // OxydExtra stone 0x8b
     UNUSED,              // OxydExtra stone 0x8c
     UNUSED,              // OxydExtra stone 0x8d

Modified: trunk/src/ox_magnum.cc
===================================================================
--- trunk/src/ox_magnum.cc	2008-03-31 22:06:24 UTC (rev 1089)
+++ trunk/src/ox_magnum.cc	2008-03-31 23:41:44 UTC (rev 1090)
@@ -141,10 +141,10 @@
     0,0,0,0,0,0,0,0,            // 0x09 -- 0x10  Oxyd stones
     "st-likeoxydd",             // OxydMagnum stone 0x11
     "st-plain",                 // OxydMagnum stone 0x12
-    "st-bigbrick-es",           // OxydMagnum stone 0x13
-    "st-bigbrick-sw",           // OxydMagnum stone 0x14
-    "st-bigbrick-ne",           // OxydMagnum stone 0x15
-    "st-bigbrick-nw",           // OxydMagnum stone 0x16
+    "st_brick_es",              // OxydMagnum stone 0x13
+    "st_brick_sw",              // OxydMagnum stone 0x14
+    "st_brick_ne",              // OxydMagnum stone 0x15
+    "st_brick_nw",              // OxydMagnum stone 0x16
     UNUSED,                     // OxydMagnum stone 0x17
     UNUSED,                     // OxydMagnum stone 0x18
     "st-glass1_hole",           // OxydMagnum stone 0x19
@@ -153,7 +153,7 @@
     "st-bug",                   // OxydMagnum stone 0x1c
     UNUSED,                     // OxydMagnum stone 0x1d
     UNUSED,                     // OxydMagnum stone 0x1e
-    "st-brick",                 // OxydMagnum stone 0x1f
+    "st_brick",                 // OxydMagnum stone 0x1f
     "st-rock1",                 // OxydMagnum stone 0x20
     "st-rock1",                 // OxydMagnum stone 0x21 (Level 121 ?)(Oxyd Magnum Gold)
     "st-rock1",                 // OxydMagnum stone 0x22 (common was 'st-glass')(Level 73 only)(looks like st-rock1)(looks like 0x20, but not like 0x87)

Modified: trunk/src/ox_oxyd1.cc
===================================================================
--- trunk/src/ox_oxyd1.cc	2008-03-31 22:06:24 UTC (rev 1089)
+++ trunk/src/ox_oxyd1.cc	2008-03-31 23:41:44 UTC (rev 1090)
@@ -171,10 +171,10 @@
     0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
     "st-fakeoxyd",              // Oxyd1 stone 0x11
     "st-door_c",                // Oxyd1 stone 0x12
-    "st-bigbrick-es",           // Oxyd1 stone 0x13
-    "st-bigbrick-sw",           // Oxyd1 stone 0x14
-    "st-bigbrick-ne",           // Oxyd1 stone 0x15
-    "st-bigbrick-nw",           // Oxyd1 stone 0x16
+    "st_brick_es",              // Oxyd1 stone 0x13
+    "st_brick_sw",              // Oxyd1 stone 0x14
+    "st_brick_ne"  ,            // Oxyd1 stone 0x15
+    "st_brick_nw",              // Oxyd1 stone 0x16
     "st-plain_hole",            // Oxyd1 stone 0x17
     "st-oxyd-0x18",             // Oxyd1 stone 0x18
     "st-door_c-open",           // Oxyd1 stone 0x19
@@ -183,7 +183,7 @@
     "st-bug",                   // Oxyd1 stone 0x1c
     "st-surprise",              // Oxyd1 stone 0x1d
     "st-chameleon",             // Oxyd1 stone 0x1e
-    "st-brick",                 // Oxyd1 stone 0x1f
+    "st_brick",                 // Oxyd1 stone 0x1f
     "st-rock1",                 // Oxyd1 stone 0x20
     "st-rock1",                 // Oxyd1 stone 0x21
     UNUSED,                     // Oxyd1 stone 0x22
@@ -291,7 +291,7 @@
     UNUSED,                     // Oxyd1 stone 0x88
     UNUSED,                     // Oxyd1 stone 0x89
     "st-stone1",                // Oxyd1 stone 0x8a
-    "st-blue-sand",             // Oxyd1 stone 0x8b
+    "st_bluesand",              // Oxyd1 stone 0x8b
     "st-white1",                // Oxyd1 stone 0x8c
     "st-black1",                // Oxyd1 stone 0x8d
     "st-yinyang2",              // Oxyd1 stone 0x8e

Modified: trunk/src/ox_peroxyd.cc
===================================================================
--- trunk/src/ox_peroxyd.cc	2008-03-31 22:06:24 UTC (rev 1089)
+++ trunk/src/ox_peroxyd.cc	2008-03-31 23:41:44 UTC (rev 1090)
@@ -333,7 +333,7 @@
     UNUSED,                     // PerOxyd stone 0x88
     UNUSED,                     // PerOxyd stone 0x89
     "st-rock6",                 // PerOxyd stone 0x8a
-    "st-blue-sand",             // PerOxyd stone 0x8b
+    "st_bluesand",              // PerOxyd stone 0x8b
     "st-rock1",                 // PerOxyd stone 0x8c
     "st-rock2",                 // PerOxyd stone 0x8d (simple border stone, not exactly st-rock2 ...; only link level 92)
     "st-rock2",                 // PerOxyd stone 0x8e

Modified: trunk/src/stones_complex.cc
===================================================================
--- trunk/src/stones_complex.cc	2008-03-31 22:06:24 UTC (rev 1089)
+++ trunk/src/stones_complex.cc	2008-03-31 23:41:44 UTC (rev 1090)
@@ -538,58 +538,8 @@
 }
 
 
-/* -------------------- BigBrick -------------------- */
+///* -------------------- Puzzle stones -------------------- */ 
 
-// BigBricks allow to build stones of any size based on st-brick.
-
-namespace 
-{
-    class BigBrick : public ConnectiveStone {
-        CLONEOBJ(BigBrick);
-    public:
-        BigBrick(int connections)
-        : ConnectiveStone("st-bigbrick", connections)
-        {}
-        bool is_removable() const { return false; }
-   };
-}
-
-/* -------------------- BigBlueSand -------------------- */
-
-// BigBlueSands allow to build stones of any size based on st-blue-sand.
-
-namespace
-{
-    class BigBlueSand : public ConnectiveStone {
-        CLONEOBJ(BigBlueSand);
-    public:
-        BigBlueSand(int connections)
-        : ConnectiveStone("st-bigbluesand", connections)
-        {}
-        bool is_removable() const { return false; }
-    };
-}
-
-/* -------------------- BigPanel -------------------- */
-
-// BigPanels allow to build stones of any size based on st-panel.
-
-namespace
-{
-    class BigPanel : public ConnectiveStone {
-        CLONEOBJ(BigPanel);
-    public:
-        BigPanel(int connections)
-        : ConnectiveStone("st-bigpanel", connections)
-        {}
-        bool is_removable() const { return false; }
-    };
-}
-
-
-
-/* -------------------- Puzzle stones -------------------- */ 
-
 /** \page st-puzzle Puzzle Stone
 
 Puzzle stones can be connected to other stones of the same type.  Any
@@ -3029,56 +2979,6 @@
     Register("st-puzzle2-esw", new PuzzleStone(8, true));
     Register("st-puzzle2-nesw", new PuzzleStone(16, true));
 
-    //Register("st-bigbrick", new BigBrick(1));  // use st-brick instead
-    Register("st-bigbrick-n", new BigBrick(9));
-    Register("st-bigbrick-e", new BigBrick(5));
-    Register("st-bigbrick-s", new BigBrick(3));
-    Register("st-bigbrick-w", new BigBrick(2));
-    Register("st-bigbrick-ne", new BigBrick(13));
-    Register("st-bigbrick-nw", new BigBrick(10));
-    Register("st-bigbrick-es", new BigBrick(7));
-    Register("st-bigbrick-sw", new BigBrick(4));
-    Register("st-bigbrick-ns", new BigBrick(11));
-    Register("st-bigbrick-ew", new BigBrick(6));
-    Register("st-bigbrick-nes", new BigBrick(15));
-    Register("st-bigbrick-new", new BigBrick(14));
-    Register("st-bigbrick-nsw", new BigBrick(12));
-    Register("st-bigbrick-esw", new BigBrick(8));
-    Register("st-bigbrick-nesw", new BigBrick(16));
-    
-    //Register("st-bigbluesand", new BigBlueSand(1));  // use st-blue-sand instead
-    Register("st-bigbluesand-n", new BigBlueSand(9));
-    Register("st-bigbluesand-e", new BigBlueSand(5));
-    Register("st-bigbluesand-s", new BigBlueSand(3));
-    Register("st-bigbluesand-w", new BigBlueSand(2));
-    Register("st-bigbluesand-ne", new BigBlueSand(13));
-    Register("st-bigbluesand-nw", new BigBlueSand(10));
-    Register("st-bigbluesand-es", new BigBlueSand(7));
-    Register("st-bigbluesand-sw", new BigBlueSand(4));
-    Register("st-bigbluesand-ns", new BigBlueSand(11));
-    Register("st-bigbluesand-ew", new BigBlueSand(6));
-    Register("st-bigbluesand-nes", new BigBlueSand(15));
-    Register("st-bigbluesand-new", new BigBlueSand(14));
-    Register("st-bigbluesand-nsw", new BigBlueSand(12));
-    Register("st-bigbluesand-esw", new BigBlueSand(8));
-    Register("st-bigbluesand-nesw", new BigBlueSand(16));
-    
-    //Register("st-bigpanel", new BigPanel(1));  // use st-panel instead was; st-wood_001 before Enigma 1.10
-    Register("st-bigpanel-n", new BigPanel(9));
-    Register("st-bigpanel-e", new BigPanel(5));
-    Register("st-bigpanel-s", new BigPanel(3));
-    Register("st-bigpanel-w", new BigPanel(2));
-    Register("st-bigpanel-ne", new BigPanel(13));
-    Register("st-bigpanel-nw", new BigPanel(10));
-    Register("st-bigpanel-es", new BigPanel(7));
-    Register("st-bigpanel-sw", new BigPanel(4));
-    Register("st-bigpanel-ns", new BigPanel(11));
-    Register("st-bigpanel-ew", new BigPanel(6));
-    Register("st-bigpanel-nes", new BigPanel(15));
-    Register("st-bigpanel-new", new BigPanel(14));
-    Register("st-bigpanel-nsw", new BigPanel(12));
-    Register("st-bigpanel-esw", new BigPanel(8));
-    Register("st-bigpanel-nesw", new BigPanel(16));
 
     Register ("st-rotator-right", new RotatorStone(true, false));
     Register ("st-rotator-left", new RotatorStone(false, false));



From ged at mail.berlios.de  Wed Apr  2 19:36:57 2008
From: ged at mail.berlios.de (ged at mail.berlios.de)
Date: Wed, 2 Apr 2008 19:36:57 +0200
Subject: [Enigma-game-svn] r1091 - feature_branches/hp_lotm/input/lotm
Message-ID: <200804021736.m32HavMX013430@sheep.berlios.de>

Author: ged
Date: 2008-04-02 19:36:56 +0200 (Wed, 02 Apr 2008)
New Revision: 1091

Added:
   feature_branches/hp_lotm/input/lotm/lotm_200804_ru.html
Log:
Homepage: Russian trnaslation of lotm_200804

Added: feature_branches/hp_lotm/input/lotm/lotm_200804_ru.html
===================================================================
--- feature_branches/hp_lotm/input/lotm/lotm_200804_ru.html	2008-03-31 23:41:44 UTC (rev 1090)
+++ feature_branches/hp_lotm/input/lotm/lotm_200804_ru.html	2008-04-02 17:36:56 UTC (rev 1091)
@@ -0,0 +1,287 @@
+<div class="lotm">
+$$lotm_header$$
+
+  <h3 class="lotm">
+    <span class="date">?????? 2008: </span>
+    &quot;Turnstiles for Two - Rhapsody on Turnstiles in Blue and Green&quot;
+  </h3>
+
+<h4>?? Ronald Lamprecht</h4>
+
+<p>
+??? &quot;??????? ??????&quot; ???????????: ?????, ?????????, ????????? ?????? ?
+??????????, ???????????, ??????????? ???????????, ? ???????? ??? ??????, ????????
+?? ???? ?????????? ??????? ?????????. ? ??? ?????? ???? ??????? ????????????? ?????? ???.
+??, ???? ???? ????? ???? ?? ???????? ?????????? ???????, ????? ????????? ????????.
+</p>
+
+<div class="lotmpic">
+<img src="$$imagedir$$/lotm/lotm_200804_a.png" alt="of the Month" border="0">
+<div class="imagetitle">Enigma VI # 77</div>
+</div>
+
+<table cellpadding="0" cellspacing="1" class="statistics">
+<caption class="normalcaption">????????? ???????? ??????? 2008</caption>
+<colgroup>
+   <col width="80">
+   <col width="160">
+</colgroup>
+<tr><td class="num">9:30</td>
+        <td class="left">dev0</td></tr>
+    <tr><td class="num">10:04</td>
+        <td class="left">Taztunes</td></tr>
+    <tr><td class="num">10:43</td>
+        <td class="left">Craven</td></tr>
+    <tr><td class="num">16:03</td>
+        <td class="left">ryujun</td></tr>
+    <tr><td class="num">16:36</td>
+        <td class="left">Ronald</td></tr>
+    <tr><td class="num">16:47</td>
+        <td class="left">Daisy</td></tr>
+    <tr><td class="num">21:19</td>
+        <td class="left">para_doks</td></tr>
+</table>
+
+<p></p>
+
+<table cellpadding="0" cellspacing="1" class="statistics">
+<caption class="normalcaption">?????????? ?????</caption>
+<colgroup>
+   <col width="80">
+   <col width="160">
+</colgroup>
+    <tr><td class="num">8:11</td>
+        <td class="left">dev0</td></tr>
+    <tr><td class="num">10:40</td>
+        <td class="left">Taztunes</td></tr>
+    <tr><td class="num">12:29</td>
+        <td class="left">Ronald</td></tr>
+    <tr><td class="num">13:04</td>
+        <td class="left">ryujun</td></tr>
+    <tr><td class="num">14:46</td>
+        <td class="left">Craven</td></tr>
+    <tr><td class="num">17:47</td>
+        <td class="left">para_doks</td></tr>
+    <tr><td class="num">18:42</td>
+        <td class="left">Daisy</td></tr>
+</table>
+
+
+<p>
+<span class="alter">
+??????: &quot;????&quot;<br>
+??????? <i>(???????, ???????? ?????? ?????)</i>:
+&quot;????? ?? ???????? ???????? ????? ???????&quot;<br>
+?????? </i>(????? ??????? ?????? ? ?????? ?????)</i>: &quot;?????,
+? ?? ????? ??? ?????????.&quot;<br>
+??????? <i>(?????????? (? ??? ?????), ????? ????-????)</i>:
+&quot;????? ??????, ?????? ?????. ???????? - ??? ??????????? ????????????
+? ??????, ??????? ??????????? ?? ??????, ? ????????. ????? ???? ???, ?????????????, ??
+???????? ????? &mdash;? ??????????, ?? ???????? ?????????? <i>(?????? ????? ??????? ?????,
+?????? ??? ??????)</i>&mdash;????? ???? ?????????? ?? ??????????? ?? ????????? ???? ? ??????,
+??? ???? ?????????? ???? ?? ????? 
+&hellip;&quot;<br>
+?????? <i>(???????????? ??????????? ? ???? ??????, ?????? ??? ????)</i>: &quot;???, ???
+???&hellip;&quot;
+</span>
+</p>
+
+<div class="lotmpic">
+<img src="$$imagedir$$/lotm/lotm_200804_b.png" alt="Level des Monats 04/2008" border="0">
+<div class="imagetitle">???? ??????</div>
+</div>
+
+<p>
+<span class="alter">
+? ???! ??????? ?????? ??????? ??? ??????? ????? ? ???????? ? ????? ???????? ?????.
+</span>
+??, ??? ??? ?????. ????? ??????.<br>
+<span class="alter">?? ?&hellip;</span><br>
+??????? &quot;??&quot;.<br>
+&hellip;<br>
+??????, ?? ????.
+</p>
+
+<p>?????, ????????? &hellip; ??? ??????? ???????. ???? ?? ?? ??????
+????????? ????, ?? ?????? ????? ?????. ??????, ????? ???????? ???, ??? ??
+?? ?????? ????????? ??? ???????????? ??????. <br>
+?? ????? ????, ????? ???? ? ????? ??? ?????; ? ????? ??????, ???? ?????? ????????, ??? ????????? ?? ?????.
+????????? ???????? ???????.
+</p>
+
+<h4>&quot;????? ????? ???, ??????????, ? ?????? ?????????&quot;</h4>
+
+<div class="quote">? ??? ???????? ????? ????? ? &quot;Turnstiles for Two&quot;. ?? ??????, ????? ? ??? ??? ????????????
+???????????? ? ??????, ? ????????, ??? ????? ??????? ????????? ??? ???? ???? ?????????? ?? ?????, ????? ??????? ??????
+?? ??????????. ???????? ??? ???????? ? ????????? ??????? ?????? ?????, ??? ? ??? ?? ??????? ???????????? ???
+???????. ??? ?????? ????????????? ? ???, ??? ??????????? ?????? ??? ?????? ???????? ?????????? ? ??????? ??????.</div>
+
+<div class="quote">???????? ?????? ???? ??????????????? ????????????! ?? ??????, ??? ?????? ??????? ? ???????, ?? ? ??? ???????? ?? ???. ??? ???????????? ?? ??? ????? ???????, ????? ?????? ??? ????????? ??? &quot;???????&quot; ? ????? ?????
+????? ????????????.</div> 
+
+<div class="quote">?? ????????? ?????????? ? &quot;Turnstiles for Two&quot; - ????? - ???? ????????? ? ?????????? ??????. ????? ????? ???, ??????????, ? ?????? ?????????: ???? ?? ?????? ??? ??? ???????, ?????? ??? ???-?? ?? ??????????. ???
+????? ???????? ?? ??????????? ????? ??? ????? ???????, ????? ????? ?? ????????? ?? ??????? ? ????????? ???????.</div>
+
+<div class="quote">??????, ???? ??? ???? ??????? ?? Ronald Lamprecht (&quot;Cold Meditation&quot;), ??? ??? ?????
+????????? ????????, ????? ????????? ? ????????? ????? ????.</div>
+
+<div class="author">Craven</div>
+
+<div class="lotmpic">
+<img src="$$imagedir$$/lotm/lotm_200804_d.png" alt="Level des Monats 04/2008" border="0">
+<div class="imagetitle">
+??? &hellip; ? ???????
+</div>
+</div>
+
+<p>
+????, ??????? ????????? ? ?????????, ??? ??? ????? ?????????? ??? ????? ?????????. ?????? ???????? ?????????????.
+? ?????? ?????, ???? ?????? ???????, ? ?????? ???????????. ?? ??? ???? ????????? ??????? ? ???????????? ??????????.
+??????, ??? ????????? ???????, ???????? ???? ??????????? ??????????? ?????. ??? ???????? ??????,
+?? ??????????? ??????????? ???????? ????, ?????? ???????? ???????? ?????????. ??? ????? ?????? ?? ????????? ?????
+???????, ? ??????? ?????????? ???? ?? ????????: ???????? ????, ?????????? ? ??????? ?????????? ? ??????? ?? ?????
+??????????? ??????????? ????? ?? ???????? - ??????? ????????????? ??????? ??????? ?????, ??????? ??????? ???????????? ?
+???????????? ?? ????? ??????.
+</p>
+
+<h4>&quot;? ??????? ??? ??????????? ???????? ??????? ???????????? ????? ????????? ? ????&quot;</h4>
+
+<div class="quote">? ???, ??? ???? ????????? ????????????????? &quot;Turnstiles for Two&quot; ?? ?????? ??????,
+??? ?????? ???????? ???????????? ????? ? ???? ?????, ?? ? ??????, ??? ??? ????????????? ??? ????? ???????
+&quot;????????? ???????&quot; ? Enigma. ? ????, ??? Ronald ??????? ??? ??? ????????
+? ??????????? ??????? ??????????, ?? ???? ??????? ???????? ??? ???-?? ??????? ????? ??????. ???????, ?
+???????????? ???????????? ???????? ???? ? ????? ???????? ? ???, ??? ?????? Ronald.</div>
+
+<div class="quote">? ???? ?????????????? ??????? ???????? ????? ?????? - ?????? ???? ?????????? ????? ??????????,
+???? ? ???? ??? ? ? ?????? ? ??????? ?????? ???? ??????????? ?? ??, ??? ??? ????? ?????? ? ??? ???, ??? ??? ????? 
+??????????, ? ??? ???. ?????? ??? ?????????? ????? ??????? ??????????? ?????????, ?????? ??? ??? ?????????? ???? ?? ????? ???? ?? ?????? ????. ? ???? ?? ??????? ???????? ?? ?????? ??????? ?????????? ?????????????, ?? ???????????? ??????,
+?? ????????? ?????? ??? ????? ????? ????????? ??????? ??????.</div>
+
+<div class="quote">???? ?? ?????, ??????? ? ??????? ? ??????? Ronald'?, ??? ??? ??????????? ???????? ???????
+???????????? ????? ????????? ? ???? ??? ????? ????? ???????? ?? ??????????. ???? ??????? ????????????? ???????????? 
+??????? ??????? ??????????. ????? ?????? ???????? ???????, ????? ??? ?????? ???????? ??????.
+????? Ronald ?????? ??????? ????? ??????? (? ?????????????) ???????? ??????? ???, ??? ?? ??????? ??????? ???????
+???????????? ????? ??????????? ?? ?????  - ???? ????.</div>
+
+<div class="quote">?? ????? ????????, ??? ?? ??????????? ??????; ????? ????????? ??????? ?? ?????? ????????? ??????? ?????? ? ????? ????? ??????????. ????? ??????? ?????????? ??? ???? ???? ?????? ?? 4 ??????? ? ???? ? ?????? ??????
+????? ?????? - ????????????? ?????? ???????? ?????? ???? ??? ????? ?????, ? ????? ????? ?? ?????? ?????? ??? ???????.</div>
+
+<div class="quote">??? ???? ????? ???????????? ?????? &quot;Turnstiles for Two&quot; ??? ??, ??? ?? ??????? ??????? ?????????. ?? ??????, ? ???????, ???????? ? ??????? ?? ???????? ?????? ????????? ?????? ????? ? ????? ??????? ?????.
+??? ???????????? Ronald'? ?? ????? ???????? ???? ? Enigma!</div>
+
+<div class="author">Taztunes</div>
+
+<p>
+??????, ????? ???????????? ??? ??????, ??? ????? ????????? ???? ??????? ????????????? ??????. ??? ????? ????????????
+? ???????????? ??????, ????????? ??? ???????. ?? ??????? ? ?????, ??? ???? ?? ??? ????? ????????????? ??????????
+???? ?? ????? ???????????. ??? ?????? ??? ???????? ?????, ??????? ??????? ???? ????? ?????????? ?????? ????????????? ??????????????. ????? ?????????????? ???!
+</p>
+
+<div class="lotmpic">
+<img src="$$imagedir$$/lotm/lotm_200804_c.png" alt="Level des Monats 04/2008" border="0">
+<div class="imagetitle">
+?????????? ?????: &quot;?? ????&quot;
+</div>
+</div>
+
+<p>
+?? ????? ??????? ??????????? ??????, ????? ????? ??????????????, ?????? ??? ?????? ?????? ????????????:
+????? ???????? ? ?????? ??????. ??????????? (?????? ???????????? ??? ????????) ? ?????? ??????,
+????????? ???????????? ??????, ????????? ??????????? ?????? (Shift-F3).
+</p>
+
+<p>
+<span class="alter">? ?????? ???????,<br> ??? ???????? ??????????????.</span><br>
+&quot;?? ??! ??????! ????????? ???? ?????????? ???????????.&quot;</p>
+
+<p>??? ?? ?? ????. ??? ????? ? ????????????? ???????? ? ???????? ???? ?????? '?????'? ???? ??? ??-?? ?????????????
+???????????? ??? ?????? ??? ? ??????? ????????????? ?? ?????? ????? - ??? ?????. ????: ????????????,
+?????????? ??????????? ? ?? ??????? ???????????? ?????????. ??? ???????? ????? ??? (????? ??? ?) ?????? ?????????????
+??????? ???? ??????????? ????. ? ????? ?????? ????, ????? ???????????? ????? ???????? ???? ;-).
+</p>
+
+<p>
+????? ???? ????? ?????? ????????? ??????????? ????? (?? ????????? ?????, ?????? ??? ?? ?? ????? ????? ??????? ????????).
+??? '????? ???????????' ?????? ???? ?????? ??????????? ? ??????????????????, ???? ?? ?? ?????? ?????????? ???? ????????
+???? ? ??????? ? ?????? ???????. ???? '??????????' ??????????? '????????', ????????? ????????? ?????????? (Shift-F3).
+</p>
+
+<p>
+??????? ????? ??????????????, ????????? ????????????? ?????? ? ??????? ???????. ? ??????? ?? ??? ???? ???????, ??
+????????? ?? ?????, ? ????????? ?????? ??????? ??????, ????? ?????? ? ??? (??? ???????? '????').
+</p>
+
+<p>
+? ??????, ??????, ????????? ???? '???????????' ? ????????????? ? ????????? ?????? ?????.
+</p>
+
+<h4>&quot;???????? ????????? ??????? ???? ????? ???? ????? ????????, ??? ? ??? ????????&quot;</h4>
+
+<p>
+? ???????? ?????????? ?????????? ???????? ?? ????????? ?????????; ?????? ?? ??????????? ??? ????????????.
+?? ????? ???? ? ?? ?? ????? ????? ???? ??? ?????. ??????? ? ? ??????? ????????????? ?????? ??????????? ??????? ? ???
+?????? Enigma.
+</p>
+
+<div class="quote">???????? ??? ?????? ????, ?? &quot;Turnstiles for Two&quot; ??? ??????????? ??????.
+????? ??????? 1.00 ?? ???????? ????????? ? ??????????? ??????? ? ??????? ? ???????????.
+? ???????? ??????? ??? ???????? ??????? ??? ??????? ??????????. ?? ????????????? ?????? ? ????? ??????
+- &quot;Zig Zag&quot; ? ???? ??? ?? ????????????? ?? ????????. ? ????? ?????? ??????? ???? ????????????? ?? ???? ??????????? ????????????? ?????. ? ???? ????? ? ????? ?????? ???????????????? ????????????? ????? ??????? ?
+?????? ??? ?????? ??????, ??????? ? ???????? ??????? 2007-?? ???? ??????????? ? &quot;Revolver&quot;.</div>
+ 
+<div class="quote">?? ? ??????????? ???????? ????????? ???????? ??????? ?????????? ? ??????? ??? ?????????? ???????.
+??????? 13 ????? ? ???????, ??? ?? ?????? ???????? ??????? ??????? ??? ??????? ??????????, ??????? ?????? 
+??????????????? ????????? ???????? ????????. ?????? ??? ??? ? ?????????? ???????? ???? ???????. ????? ???? ?????
+?????? ? ???????? ??? ????? ??????: &quot;Cold Meditation&quot; ? &quot;Polar Bear's Paradise&quot;.
+?? ????????? ???? Andreas ?????????? ??????? ?? &quot;Cold Meditation&quot; ?? ????? ?????????? ???????????????? ???????.</div>
+
+<div class="quote">??????? ???! ? ?????? ?????? ?????? ????????? ????????? ? ???????? ?? ????????? ???? ???????.
+?? ?????? ? ???? ???????? ???? ?????????? ???????? ? ? ?????? ???????? ???????? ?????????, ??????? ? ???????? ?
+??????? ??? ? ?????? ???????? ??? ????. ????? ???? ???????? ??????? &quot;Turnstiles for Two&quot; ??? ?????
+? ?????? ?? ???? ????? 17-?? ?????. ???????? ????????? ??????? ???? ????? ???? ????? ????????, ??? ? ??? ????????.</div>
+
+<div class="lotmpic">
+<img src="$$imagedir$$/lotm/lotm_200804_e.png" alt="Level des Monats 04/2008" border="0">
+<div class="imagetitle">
+?????? ??? ????? ? ???????? <br>(?????) ?????? ????????
+</div>
+</div>
+
+<div class="quote">??? ?????? ? ???????? ???? ?????? ? ??????? ???????????. ?
+??????? ?? ??????? ? ?????? ??? ??????? ?????? ?? ?????? ???? ?? ???? ??????? ????????????
+- &quot;???????? ????????&quot; ????????. ??? ????????? - 
+????????? ??????????? ??????? ???? ??????? ? ??????? ???????? ?????-????? ???? ? ?????????????? ??????, ????? ???
+???????? ? ???????????????. ?? ????? ???? ??????? ??????? ?????? ???? ???????????? &quot;??????? ? ??????? ? ??????? ?????&quot;, ?????????? ??? ??????. ??? ??? ???????? ????? ????? ?????? ???? ??????? ?????????, ?? ? ?????? ?????? ???
+&quot;Rhapsody on turnstiles in blue and green&quot;.
+</div>
+
+<div class="quote">???????????? ???????????? ?????????? ????????, ?? ??????? ? ??????? ????????? ?? ???? ?????? ???????.
+?? ?????? ? ???? ? ??????????? ??????? ??????????. ?? ????????? ????????? ????? ????? ? ???????????? Enigma  ? 
+????? ? ???? ?????????? ??????? ??? ??????. ?????? ??????? ??????? ???? ???????? ?? 24 ??? ? ????!
+?? ???? ??????? ?????? ?? ??????? ?? ????? ?? ???????????? ?????? ?????? ????? ??????? ????????.</div>
+
+<div class="quote">? ????? ?????? &quot;Turnstiles for Two&quot; ?? ??? ???????? ?? ??? ??????. ? ?????????
+???? ?????????? ??????, ??????? ??????? ?? ???? ??? ????????? - ??????? ????????? ????????????? ???????.
+??????? ????????????? ???? 16-?? ??????? ?? ?????????. ????????, ???? ??? ??????? ?????? ???????? ????,
+?? ???????????? ????? ???????????? ? ??????? ?????. ?? ???????? ?????? ?????? ? ???, ????? ?? ?????????
+? ??????? ????? ????? ???????????? ??????. ? ?????, ? ??????? ????????? ??????????? ??????? ??? Lua, ???????
+???????????? ?????? ? ???????????? ???????. ?? ??? ???????? ???????? ?????????? ????????????? ??????? ?????? ???? 
+????????? ? ?????? ????, ??? ???? ??????? ? Enigma. ? ??????? ?? ??, ????? ????????? ? ????????????????? ????????,
+??????? ????? ?? ??? ???????? ??????? ???????? ??? ????????? ???????, ???? ????? ????? ??????.</div>
+
+<div class="quote">?????? ???, ??????????? ????? ? ???????, ??? ??????? ???? ???????, ??? ? ??? ?????????.
+???????? ????? ????????, ??? ?????????? ????? ?????? ??? ???????? ?????, ??????? ?? ?????, ? ??????? ?????
+?????? ??? ????????? ?????? ???????????? ????? ?????? ??????? ? ??????? ?? ??????????? ??????.
+?????? ????? ???????? ? ???????? ?????? ? ???????? ??????????? ????? ? ?????????? ??????. ? ???????, ??? ???
+?????? ??????? ???? ??????????? ?????????????? &quot;Turnstiles for Two&quot;.</div>
+
+<div class="quote">??????? ?? ??????? ?????? ? ???????? ???????????????????!</div>
+
+<div class="author">Ronald Lamprecht</div>
+
+<p>
+??????? ??????? Ronald Lamprecht ?? ???? ??????????? ??????.
+</p>
+
+<p><i>NObby</i><p>
+


Property changes on: feature_branches/hp_lotm/input/lotm/lotm_200804_ru.html
___________________________________________________________________
Name: svn:eol-style
   + native



From ral at mail.berlios.de  Fri Apr  4 23:08:44 2008
From: ral at mail.berlios.de (ral at BerliOS)
Date: Fri, 4 Apr 2008 23:08:44 +0200
Subject: [Enigma-game-svn] r1092 - homepage/input
Message-ID: <200804042108.m34L8inP025970@sheep.berlios.de>

Author: ral
Date: 2008-04-04 23:08:43 +0200 (Fri, 04 Apr 2008)
New Revision: 1092

Modified:
   homepage/input/stat-other.html
   homepage/input/table-hcp.html
   homepage/input/table-rat.html
   homepage/input/table-solved.html
   homepage/input/table-wr.html
   homepage/input/userlist.html
Log:
Homepage:
- statistics March 2008


Modified: homepage/input/stat-other.html
===================================================================
--- homepage/input/stat-other.html	2008-04-02 17:36:56 UTC (rev 1091)
+++ homepage/input/stat-other.html	2008-04-04 21:08:43 UTC (rev 1092)
@@ -1,22 +1,22 @@
   <div class="stat-help">
     <h3>$$Other_Statistics$$</h3>
     <h4>$$Scores$$</h4>
-      73526 $$single_level_scores$$.
+      75496 $$single_level_scores$$.
     <h4>$$Ratings$$</h4>
-      13840 $$single_level_ratings$$ 4.89 $$and_distribution$$: 
+      14014 $$single_level_ratings$$ 4.90 $$and_distribution$$: 
       <table>
         <colgroup><col width="80"><col width="80"></colgroup>
         <tr><th>$$rating$$</th><th>$$count$$</th></tr>
-        <tr><td class="num">0</td><td class="num">57</td></tr>
-        <tr><td class="num">1</td><td class="num">264</td></tr>
-        <tr><td class="num">2</td><td class="num">723</td></tr>
-        <tr><td class="num">3</td><td class="num">2008</td></tr>
-        <tr><td class="num">4</td><td class="num">2657</td></tr>
-        <tr><td class="num">5</td><td class="num">3325</td></tr>
-        <tr><td class="num">6</td><td class="num">2309</td></tr>
-        <tr><td class="num">7</td><td class="num">1580</td></tr>
-        <tr><td class="num">8</td><td class="num">583</td></tr>
-        <tr><td class="num">9</td><td class="num">231</td></tr>
-        <tr><td class="num">10</td><td class="num">103</td></tr>
+        <tr><td class="num">0</td><td class="num">58</td></tr>
+        <tr><td class="num">1</td><td class="num">269</td></tr>
+        <tr><td class="num">2</td><td class="num">731</td></tr>
+        <tr><td class="num">3</td><td class="num">2015</td></tr>
+        <tr><td class="num">4</td><td class="num">2679</td></tr>
+        <tr><td class="num">5</td><td class="num">3347</td></tr>
+        <tr><td class="num">6</td><td class="num">2344</td></tr>
+        <tr><td class="num">7</td><td class="num">1616</td></tr>
+        <tr><td class="num">8</td><td class="num">607</td></tr>
+        <tr><td class="num">9</td><td class="num">238</td></tr>
+        <tr><td class="num">10</td><td class="num">110</td></tr>
       </table>
   </div>

Modified: homepage/input/table-hcp.html
===================================================================
--- homepage/input/table-hcp.html	2008-04-02 17:36:56 UTC (rev 1091)
+++ homepage/input/table-hcp.html	2008-04-04 21:08:43 UTC (rev 1092)
@@ -1,138 +1,143 @@
   <table>
-    <caption>$$Handicap_Statistics$$ $$February$$ 2008</caption>
+    <caption>$$Handicap_Statistics$$ $$March$$ 2008</caption>
     <colgroup><col width="130"><col width="220"></colgroup>
     <tr><th>$$solved_hcp$$</th><th class="left">$$user$$</th></tr>
-     <tr><td class="num">-140.7</td><td class="left">'Moneymaker'</td></tr>
-     <tr><td class="num"> -83.8</td><td class="left">'Johannes'</td></tr>
-     <tr><td class="num"> -83.5</td><td class="left">'Stupid'</td></tr>
-     <tr><td class="num"> -72.0</td><td class="left">'Great Scott'</td></tr>
-     <tr><td class="num"> -61.6</td><td class="left">'Duffy'</td></tr>
-     <tr><td class="num"> -60.7</td><td class="left">'Malla'</td></tr>
-     <tr><td class="num"> -57.6</td><td class="left">'daydreamer'</td></tr>
-     <tr><td class="num"> -50.2</td><td class="left">'Django'</td></tr>
-     <tr><td class="num"> -47.5</td><td class="left">'ryujun'</td></tr>
-     <tr><td class="num"> -44.8</td><td class="left">'Gloop'</td></tr>
-     <tr><td class="num"> -43.6</td><td class="left">'Alexandros'</td></tr>
-     <tr><td class="num"> -41.8</td><td class="left">'Taztunes'</td></tr>
-     <tr><td class="num"> -38.2</td><td class="left">'Safalra'</td></tr>
-     <tr><td class="num"> -34.3</td><td class="left">'dev0'</td></tr>
-     <tr><td class="num"> -29.8</td><td class="left">'B-Huff'</td></tr>
-     <tr><td class="num"> -29.0</td><td class="left">'Ludmian'</td></tr>
-     <tr><td class="num"> -28.1</td><td class="left">'bojster'</td></tr>
-     <tr><td class="num"> -28.0</td><td class="left">'Zekobah'</td></tr>
-     <tr><td class="num"> -24.3</td><td class="left">'hendrik'</td></tr>
-     <tr><td class="num"> -22.6</td><td class="left">'ABS'</td></tr>
-     <tr><td class="num"> -21.7</td><td class="left">'ged'</td></tr>
-     <tr><td class="num"> -20.2</td><td class="left">'Raoul'</td></tr>
-     <tr><td class="num"> -19.9</td><td class="left">'Emmanuel'</td></tr>
-     <tr><td class="num"> -16.6</td><td class="left">'Ghatotkacha'</td></tr>
-     <tr><td class="num"> -16.0</td><td class="left">'Ronald'</td></tr>
-     <tr><td class="num"> -14.7</td><td class="left">'dpl'</td></tr>
-     <tr><td class="num"> -13.0</td><td class="left">'Lukas'</td></tr>
-     <tr><td class="num"> -12.2</td><td class="left">'HuB34'</td></tr>
-     <tr><td class="num">  -9.1</td><td class="left">'joseba'</td></tr>
-     <tr><td class="num">  -8.9</td><td class="left">'Daisy'</td></tr>
-     <tr><td class="num">  -8.8</td><td class="left">'Iceshark7'</td></tr>
-     <tr><td class="num">  -5.0</td><td class="left">'Daniel'</td></tr>
-     <tr><td class="num">  -3.7</td><td class="left">'fabian'</td></tr>
-     <tr><td class="num">  -2.3</td><td class="left">'Craven'</td></tr>
-     <tr><td class="num">  -2.0</td><td class="left">'JuSt'</td></tr>
-     <tr><td class="num">  -1.7</td><td class="left">'Wuzzy'</td></tr>
-     <tr><td class="num">   0.8</td><td class="left">'para_doks'</td></tr>
-     <tr><td class="num">   0.9</td><td class="left">'Tobias'</td></tr>
-     <tr><td class="num">   2.1</td><td class="left">'Guglielmo'</td></tr>
-     <tr><td class="num">   3.0</td><td class="left">'U-Punkt'</td></tr>
-     <tr><td class="num">   3.3</td><td class="left">'Andy'</td></tr>
-     <tr><td class="num">   3.4</td><td class="left">'serpent'</td></tr>
+     <tr><td class="num">-143.6</td><td class="left">'Moneymaker'</td></tr>
+     <tr><td class="num"> -82.6</td><td class="left">'Johannes'</td></tr>
+     <tr><td class="num"> -82.4</td><td class="left">'Stupid'</td></tr>
+     <tr><td class="num"> -71.3</td><td class="left">'daydreamer'</td></tr>
+     <tr><td class="num"> -71.0</td><td class="left">'Great Scott'</td></tr>
+     <tr><td class="num"> -60.9</td><td class="left">'Duffy'</td></tr>
+     <tr><td class="num"> -59.5</td><td class="left">'Malla'</td></tr>
+     <tr><td class="num"> -52.8</td><td class="left">'ryujun'</td></tr>
+     <tr><td class="num"> -49.0</td><td class="left">'Django'</td></tr>
+     <tr><td class="num"> -43.6</td><td class="left">'Gloop'</td></tr>
+     <tr><td class="num"> -42.4</td><td class="left">'Alexandros'</td></tr>
+     <tr><td class="num"> -41.6</td><td class="left">'dev0'</td></tr>
+     <tr><td class="num"> -40.5</td><td class="left">'Taztunes'</td></tr>
+     <tr><td class="num"> -37.1</td><td class="left">'Safalra'</td></tr>
+     <tr><td class="num"> -31.7</td><td class="left">'B-Huff'</td></tr>
+     <tr><td class="num"> -30.8</td><td class="left">'Ludmian'</td></tr>
+     <tr><td class="num"> -27.0</td><td class="left">'Zekobah'</td></tr>
+     <tr><td class="num"> -27.0</td><td class="left">'bojster'</td></tr>
+     <tr><td class="num"> -23.3</td><td class="left">'hendrik'</td></tr>
+     <tr><td class="num"> -21.6</td><td class="left">'ABS'</td></tr>
+     <tr><td class="num"> -20.7</td><td class="left">'ged'</td></tr>
+     <tr><td class="num"> -19.8</td><td class="left">'dpl'</td></tr>
+     <tr><td class="num"> -19.5</td><td class="left">'Raoul'</td></tr>
+     <tr><td class="num"> -18.9</td><td class="left">'Emmanuel'</td></tr>
+     <tr><td class="num"> -16.2</td><td class="left">'Ronald'</td></tr>
+     <tr><td class="num"> -15.7</td><td class="left">'Ghatotkacha'</td></tr>
+     <tr><td class="num"> -12.3</td><td class="left">'Lukas'</td></tr>
+     <tr><td class="num"> -11.5</td><td class="left">'HuB34'</td></tr>
+     <tr><td class="num"> -11.1</td><td class="left">'Daisy'</td></tr>
+     <tr><td class="num">  -8.2</td><td class="left">'joseba'</td></tr>
+     <tr><td class="num">  -8.1</td><td class="left">'Iceshark7'</td></tr>
+     <tr><td class="num">  -4.3</td><td class="left">'Daniel'</td></tr>
+     <tr><td class="num">  -3.0</td><td class="left">'fabian'</td></tr>
+     <tr><td class="num">  -1.5</td><td class="left">'Craven'</td></tr>
+     <tr><td class="num">  -1.2</td><td class="left">'JuSt'</td></tr>
+     <tr><td class="num">  -1.0</td><td class="left">'Wuzzy'</td></tr>
+     <tr><td class="num">   1.5</td><td class="left">'para_doks'</td></tr>
+     <tr><td class="num">   1.7</td><td class="left">'Tobias'</td></tr>
+     <tr><td class="num">   2.6</td><td class="left">'Guglielmo'</td></tr>
      <tr><td class="num">   3.7</td><td class="left">'Kevin'</td></tr>
-     <tr><td class="num">   5.5</td><td class="left">'Austin'</td></tr>
-     <tr><td class="num">   7.7</td><td class="left">'mrduke'</td></tr>
-     <tr><td class="num">  10.3</td><td class="left">'ShadowPhrogg32642342'</td></tr>
-     <tr><td class="num">  11.1</td><td class="left">'Tiza'</td></tr>
-     <tr><td class="num">  12.0</td><td class="left">'Andreas'</td></tr>
-     <tr><td class="num">  12.3</td><td class="left">'alfred69'</td></tr>
-     <tr><td class="num">  12.7</td><td class="left">'Chocolate Zero'</td></tr>
-     <tr><td class="num">  13.8</td><td class="left">'Sim_Ed'</td></tr>
-     <tr><td class="num">  14.1</td><td class="left">'Agnieszka'</td></tr>
-     <tr><td class="num">  14.2</td><td class="left">'shoki'</td></tr>
-     <tr><td class="num">  14.6</td><td class="left">'Mark P.'</td></tr>
-     <tr><td class="num">  18.6</td><td class="left">'Alex'</td></tr>
-     <tr><td class="num">  21.4</td><td class="left">'Klaus'</td></tr>
-     <tr><td class="num">  21.7</td><td class="left">'Marc-Hendrik'</td></tr>
-     <tr><td class="num">  21.9</td><td class="left">'Chris'</td></tr>
-     <tr><td class="num">  22.8</td><td class="left">'Thomas'</td></tr>
-     <tr><td class="num">  22.9</td><td class="left">'Bent'</td></tr>
-     <tr><td class="num">  23.6</td><td class="left">'hdwow'</td></tr>
-     <tr><td class="num">  24.2</td><td class="left">'Gottseinsohn'</td></tr>
-     <tr><td class="num">  24.7</td><td class="left">'Hans-HD'</td></tr>
-     <tr><td class="num">  25.3</td><td class="left">'Ale'</td></tr>
-     <tr><td class="num">  26.6</td><td class="left">'J3FF'</td></tr>
-     <tr><td class="num">  26.6</td><td class="left">'Little_Mole'</td></tr>
-     <tr><td class="num">  27.9</td><td class="left">'biotopa'</td></tr>
-     <tr><td class="num">  28.6</td><td class="left">'oblo'</td></tr>
-     <tr><td class="num">  28.8</td><td class="left">'redsantz'</td></tr>
-     <tr><td class="num">  29.1</td><td class="left">'geembo_90'</td></tr>
-     <tr><td class="num">  30.0</td><td class="left">'Edgar_Flesk'</td></tr>
-     <tr><td class="num">  30.4</td><td class="left">'Melanie'</td></tr>
-     <tr><td class="num">  30.6</td><td class="left">'IChrisI'</td></tr>
-     <tr><td class="num">  30.7</td><td class="left">'Vinksu'</td></tr>
-     <tr><td class="num">  31.0</td><td class="left">'erich'</td></tr>
-     <tr><td class="num">  31.0</td><td class="left">'NorthForty'</td></tr>
-     <tr><td class="num">  31.3</td><td class="left">'Gorn'</td></tr>
-     <tr><td class="num">  31.4</td><td class="left">'Davacardo'</td></tr>
-     <tr><td class="num">  32.5</td><td class="left">'Antonio EE'</td></tr>
-     <tr><td class="num">  34.1</td><td class="left">'niebie'</td></tr>
-     <tr><td class="num">  34.2</td><td class="left">'MicWa'</td></tr>
-     <tr><td class="num">  34.3</td><td class="left">'WP319'</td></tr>
-     <tr><td class="num">  34.6</td><td class="left">'Kosby'</td></tr>
-     <tr><td class="num">  36.4</td><td class="left">'Rugby4ever'</td></tr>
-     <tr><td class="num">  37.8</td><td class="left">'Drotten'</td></tr>
-     <tr><td class="num">  38.3</td><td class="left">'Archcorenth'</td></tr>
-     <tr><td class="num">  38.5</td><td class="left">'Harry Lim'</td></tr>
-     <tr><td class="num">  38.7</td><td class="left">'B-man'</td></tr>
-     <tr><td class="num">  38.9</td><td class="left">'Angolino'</td></tr>
-     <tr><td class="num">  39.4</td><td class="left">'mecke'</td></tr>
-     <tr><td class="num">  39.7</td><td class="left">'Nfol'</td></tr>
-     <tr><td class="num">  40.1</td><td class="left">'Tiger'</td></tr>
-     <tr><td class="num">  40.8</td><td class="left">'Snaily'</td></tr>
-     <tr><td class="num">  41.0</td><td class="left">'Vlad'</td></tr>
-     <tr><td class="num">  42.1</td><td class="left">'Momcat'</td></tr>
-     <tr><td class="num">  42.2</td><td class="left">'Liam Sheehan'</td></tr>
-     <tr><td class="num">  42.6</td><td class="left">'Breezy'</td></tr>
-     <tr><td class="num">  42.7</td><td class="left">'Uli'</td></tr>
-     <tr><td class="num">  44.5</td><td class="left">'Tarim'</td></tr>
-     <tr><td class="num">  45.1</td><td class="left">'IntKecsk'</td></tr>
-     <tr><td class="num">  46.5</td><td class="left">'ntaeijr'</td></tr>
-     <tr><td class="num">  46.8</td><td class="left">'mhatta'</td></tr>
-     <tr><td class="num">  48.3</td><td class="left">'Zak'</td></tr>
-     <tr><td class="num">  48.7</td><td class="left">'Valkyrie2'</td></tr>
-     <tr><td class="num">  49.1</td><td class="left">'Sandra'</td></tr>
-     <tr><td class="num">  50.0</td><td class="left">'jdcampo'</td></tr>
-     <tr><td class="num">  50.6</td><td class="left">'Jeffrey S'</td></tr>
-     <tr><td class="num">  51.4</td><td class="left">'brynn'</td></tr>
-     <tr><td class="num">  51.4</td><td class="left">'Vaily'</td></tr>
-     <tr><td class="num">  52.6</td><td class="left">'Turbogurk'</td></tr>
-     <tr><td class="num">  52.6</td><td class="left">'Neophilus'</td></tr>
-     <tr><td class="num">  52.8</td><td class="left">'Cyphase'</td></tr>
-     <tr><td class="num">  55.0</td><td class="left">'krazy62'</td></tr>
-     <tr><td class="num">  55.8</td><td class="left">'Adonica'</td></tr>
-     <tr><td class="num">  61.3</td><td class="left">'Asbel'</td></tr>
-     <tr><td class="num">  61.5</td><td class="left">'Mecki'</td></tr>
-     <tr><td class="num">  63.1</td><td class="left">'Meeve'</td></tr>
-     <tr><td class="num">  65.7</td><td class="left">'ael'</td></tr>
-     <tr><td class="num">  66.1</td><td class="left">'Samuel'</td></tr>
-     <tr><td class="num">  66.4</td><td class="left">'schmusi20'</td></tr>
-     <tr><td class="num">  67.1</td><td class="left">'Alf'</td></tr>
-     <tr><td class="num">  68.7</td><td class="left">'Magnus and Susi'</td></tr>
-     <tr><td class="num">  69.8</td><td class="left">'xmouse'</td></tr>
-     <tr><td class="num">  71.5</td><td class="left">'Joona'</td></tr>
-     <tr><td class="num">  71.7</td><td class="left">'AQZ'</td></tr>
-     <tr><td class="num">  73.7</td><td class="left">'Dvorhagen'</td></tr>
-     <tr><td class="num">  74.7</td><td class="left">'jojo'</td></tr>
-     <tr><td class="num">  74.8</td><td class="left">'AsuCaga'</td></tr>
-     <tr><td class="num">  79.5</td><td class="left">'AkRa'</td></tr>
-     <tr><td class="num">  80.0</td><td class="left">'Agares'</td></tr>
-     <tr><td class="num">  84.7</td><td class="left">'Miel56'</td></tr>
-     <tr><td class="num">  89.8</td><td class="left">'The red O'</td></tr>
+     <tr><td class="num">   3.7</td><td class="left">'U-Punkt'</td></tr>
+     <tr><td class="num">   4.0</td><td class="left">'Andy'</td></tr>
+     <tr><td class="num">   4.0</td><td class="left">'serpent'</td></tr>
+     <tr><td class="num">   6.3</td><td class="left">'Austin'</td></tr>
+     <tr><td class="num">   8.1</td><td class="left">'shoki'</td></tr>
+     <tr><td class="num">   8.3</td><td class="left">'mrduke'</td></tr>
+     <tr><td class="num">  10.8</td><td class="left">'ShadowPhrogg32642342'</td></tr>
+     <tr><td class="num">  11.9</td><td class="left">'Tiza'</td></tr>
+     <tr><td class="num">  12.2</td><td class="left">'Andreas'</td></tr>
+     <tr><td class="num">  12.2</td><td class="left">'Freshman'</td></tr>
+     <tr><td class="num">  13.1</td><td class="left">'alfred69'</td></tr>
+     <tr><td class="num">  13.4</td><td class="left">'Chocolate Zero'</td></tr>
+     <tr><td class="num">  14.4</td><td class="left">'Sim_Ed'</td></tr>
+     <tr><td class="num">  14.7</td><td class="left">'Agnieszka'</td></tr>
+     <tr><td class="num">  15.0</td><td class="left">'Mark P.'</td></tr>
+     <tr><td class="num">  19.2</td><td class="left">'Alex'</td></tr>
+     <tr><td class="num">  21.1</td><td class="left">'Antonio EE'</td></tr>
+     <tr><td class="num">  22.0</td><td class="left">'Klaus'</td></tr>
+     <tr><td class="num">  22.2</td><td class="left">'Marc-Hendrik'</td></tr>
+     <tr><td class="num">  22.4</td><td class="left">'Chris'</td></tr>
+     <tr><td class="num">  23.3</td><td class="left">'Thomas'</td></tr>
+     <tr><td class="num">  23.4</td><td class="left">'Bent'</td></tr>
+     <tr><td class="num">  24.1</td><td class="left">'hdwow'</td></tr>
+     <tr><td class="num">  24.7</td><td class="left">'Gottseinsohn'</td></tr>
+     <tr><td class="num">  25.2</td><td class="left">'Hans-HD'</td></tr>
+     <tr><td class="num">  25.7</td><td class="left">'Ale'</td></tr>
+     <tr><td class="num">  27.0</td><td class="left">'Little_Mole'</td></tr>
+     <tr><td class="num">  27.1</td><td class="left">'J3FF'</td></tr>
+     <tr><td class="num">  28.3</td><td class="left">'biotopa'</td></tr>
+     <tr><td class="num">  29.0</td><td class="left">'oblo'</td></tr>
+     <tr><td class="num">  29.3</td><td class="left">'redsantz'</td></tr>
+     <tr><td class="num">  29.7</td><td class="left">'geembo_90'</td></tr>
+     <tr><td class="num">  30.4</td><td class="left">'Edgar_Flesk'</td></tr>
+     <tr><td class="num">  30.8</td><td class="left">'Melanie'</td></tr>
+     <tr><td class="num">  31.0</td><td class="left">'IChrisI'</td></tr>
+     <tr><td class="num">  31.2</td><td class="left">'Vinksu'</td></tr>
+     <tr><td class="num">  31.3</td><td class="left">'erich'</td></tr>
+     <tr><td class="num">  31.4</td><td class="left">'NorthForty'</td></tr>
+     <tr><td class="num">  31.6</td><td class="left">'Gorn'</td></tr>
+     <tr><td class="num">  31.8</td><td class="left">'Davacardo'</td></tr>
+     <tr><td class="num">  34.5</td><td class="left">'niebie'</td></tr>
+     <tr><td class="num">  34.5</td><td class="left">'MicWa'</td></tr>
+     <tr><td class="num">  34.7</td><td class="left">'WP319'</td></tr>
+     <tr><td class="num">  35.0</td><td class="left">'Kosby'</td></tr>
+     <tr><td class="num">  36.7</td><td class="left">'Rugby4ever'</td></tr>
+     <tr><td class="num">  38.1</td><td class="left">'mecke'</td></tr>
+     <tr><td class="num">  38.2</td><td class="left">'Drotten'</td></tr>
+     <tr><td class="num">  38.6</td><td class="left">'Archcorenth'</td></tr>
+     <tr><td class="num">  38.9</td><td class="left">'Harry Lim'</td></tr>
+     <tr><td class="num">  39.1</td><td class="left">'B-man'</td></tr>
+     <tr><td class="num">  39.5</td><td class="left">'Angolino'</td></tr>
+     <tr><td class="num">  40.0</td><td class="left">'Nfol'</td></tr>
+     <tr><td class="num">  40.5</td><td class="left">'Tiger'</td></tr>
+     <tr><td class="num">  41.1</td><td class="left">'Snaily'</td></tr>
+     <tr><td class="num">  41.4</td><td class="left">'Vlad'</td></tr>
+     <tr><td class="num">  42.4</td><td class="left">'Momcat'</td></tr>
+     <tr><td class="num">  42.5</td><td class="left">'Liam Sheehan'</td></tr>
+     <tr><td class="num">  42.9</td><td class="left">'Breezy'</td></tr>
+     <tr><td class="num">  43.0</td><td class="left">'Uli'</td></tr>
+     <tr><td class="num">  44.8</td><td class="left">'Tarim'</td></tr>
+     <tr><td class="num">  45.4</td><td class="left">'IntKecsk'</td></tr>
+     <tr><td class="num">  45.7</td><td class="left">'tjRaven'</td></tr>
+     <tr><td class="num">  46.8</td><td class="left">'ntaeijr'</td></tr>
+     <tr><td class="num">  47.0</td><td class="left">'mhatta'</td></tr>
+     <tr><td class="num">  48.6</td><td class="left">'Zak'</td></tr>
+     <tr><td class="num">  49.1</td><td class="left">'Valkyrie2'</td></tr>
+     <tr><td class="num">  49.5</td><td class="left">'Sandra'</td></tr>
+     <tr><td class="num">  50.4</td><td class="left">'jdcampo'</td></tr>
+     <tr><td class="num">  50.9</td><td class="left">'Jeffrey S'</td></tr>
+     <tr><td class="num">  51.2</td><td class="left">'brynn'</td></tr>
+     <tr><td class="num">  51.3</td><td class="left">'Slav'</td></tr>
+     <tr><td class="num">  51.4</td><td class="left">'AkRa'</td></tr>
+     <tr><td class="num">  51.8</td><td class="left">'Vaily'</td></tr>
+     <tr><td class="num">  52.9</td><td class="left">'Turbogurk'</td></tr>
+     <tr><td class="num">  52.9</td><td class="left">'Neophilus'</td></tr>
+     <tr><td class="num">  52.9</td><td class="left">'Cyphase'</td></tr>
+     <tr><td class="num">  55.3</td><td class="left">'krazy62'</td></tr>
+     <tr><td class="num">  56.1</td><td class="left">'Adonica'</td></tr>
+     <tr><td class="num">  58.7</td><td class="left">'Mecki'</td></tr>
+     <tr><td class="num">  61.4</td><td class="left">'Asbel'</td></tr>
+     <tr><td class="num">  63.3</td><td class="left">'Meeve'</td></tr>
+     <tr><td class="num">  65.9</td><td class="left">'ael'</td></tr>
+     <tr><td class="num">  66.3</td><td class="left">'Samuel'</td></tr>
+     <tr><td class="num">  66.6</td><td class="left">'schmusi20'</td></tr>
+     <tr><td class="num">  67.2</td><td class="left">'Alf'</td></tr>
+     <tr><td class="num">  68.9</td><td class="left">'Magnus and Susi'</td></tr>
+     <tr><td class="num">  70.0</td><td class="left">'xmouse'</td></tr>
+     <tr><td class="num">  71.6</td><td class="left">'Joona'</td></tr>
+     <tr><td class="num">  71.8</td><td class="left">'AQZ'</td></tr>
+     <tr><td class="num">  73.3</td><td class="left">'crypto_rsa'</td></tr>
+     <tr><td class="num">  73.8</td><td class="left">'Dvorhagen'</td></tr>
+     <tr><td class="num">  74.8</td><td class="left">'jojo'</td></tr>
+     <tr><td class="num">  74.9</td><td class="left">'AsuCaga'</td></tr>
+     <tr><td class="num">  78.2</td><td class="left">'colonel crayon'</td></tr>
+     <tr><td class="num">  80.1</td><td class="left">'Agares'</td></tr>
+     <tr><td class="num">  84.8</td><td class="left">'Miel56'</td></tr>
+     <tr><td class="num">  89.9</td><td class="left">'The red O'</td></tr>
      <tr><td class="num">  92.2</td><td class="left">'Michael'</td></tr>
   </table>

Modified: homepage/input/table-rat.html
===================================================================
--- homepage/input/table-rat.html	2008-04-02 17:36:56 UTC (rev 1091)
+++ homepage/input/table-rat.html	2008-04-04 21:08:43 UTC (rev 1092)
@@ -1,19 +1,19 @@
   <table>
-    <caption>$$Rating_Statistics$$ $$February$$ 2008</caption>
+    <caption>$$Rating_Statistics$$ $$March$$ 2008</caption>
     <colgroup><col width="80"><col width="80"><col width="220"></colgroup>
     <tr><th>$$count$$</th><th>$$average$$</th><th class="left">$$user$$</th></tr>    <tr><td class="num">1062</td><td class="num"> 5.06</td><td class="left">'ryujun'</td></tr>
     <tr><td class="num">1056</td><td class="num"> 4.83</td><td class="left">'Taztunes'</td></tr>
+    <tr><td class="num">880</td><td class="num"> 5.00</td><td class="left">'dev0'</td></tr>
     <tr><td class="num">871</td><td class="num"> 5.09</td><td class="left">'Stupid'</td></tr>
-    <tr><td class="num">853</td><td class="num"> 4.78</td><td class="left">'daydreamer'</td></tr>
-    <tr><td class="num">821</td><td class="num"> 4.94</td><td class="left">'dev0'</td></tr>
+    <tr><td class="num">864</td><td class="num"> 4.78</td><td class="left">'daydreamer'</td></tr>
     <tr><td class="num">653</td><td class="num"> 5.01</td><td class="left">'Duffy'</td></tr>
-    <tr><td class="num">627</td><td class="num"> 4.99</td><td class="left">'Moneymaker'</td></tr>
-    <tr><td class="num">613</td><td class="num"> 4.20</td><td class="left">'shoki'</td></tr>
+    <tr><td class="num">628</td><td class="num"> 5.00</td><td class="left">'Moneymaker'</td></tr>
+    <tr><td class="num">622</td><td class="num"> 4.22</td><td class="left">'shoki'</td></tr>
     <tr><td class="num">596</td><td class="num"> 4.82</td><td class="left">'U-Punkt'</td></tr>
-    <tr><td class="num">518</td><td class="num"> 5.08</td><td class="left">'dpl'</td></tr>
-    <tr><td class="num">517</td><td class="num"> 4.96</td><td class="left">'B-Huff'</td></tr>
+    <tr><td class="num">539</td><td class="num"> 5.11</td><td class="left">'dpl'</td></tr>
+    <tr><td class="num">534</td><td class="num"> 4.97</td><td class="left">'B-Huff'</td></tr>
     <tr><td class="num">511</td><td class="num"> 5.30</td><td class="left">'Lukas'</td></tr>
-    <tr><td class="num">469</td><td class="num"> 5.03</td><td class="left">'Ronald'</td></tr>
+    <tr><td class="num">487</td><td class="num"> 5.02</td><td class="left">'Ronald'</td></tr>
     <tr><td class="num">448</td><td class="num"> 5.08</td><td class="left">'Johannes'</td></tr>
     <tr><td class="num">433</td><td class="num"> 4.24</td><td class="left">'Alexandros'</td></tr>
     <tr><td class="num">424</td><td class="num"> 4.35</td><td class="left">'ged'</td></tr>
@@ -36,10 +36,11 @@
     <tr><td class="num"> 49</td><td class="num"> 6.02</td><td class="left">'oblo'</td></tr>
     <tr><td class="num"> 49</td><td class="num"> 4.90</td><td class="left">'hendrik'</td></tr>
     <tr><td class="num"> 43</td><td class="num"> 3.74</td><td class="left">'Iceshark7'</td></tr>
+    <tr><td class="num"> 31</td><td class="num"> 7.61</td><td class="left">'AkRa'</td></tr>
     <tr><td class="num"> 30</td><td class="num"> 4.40</td><td class="left">'Archcorenth'</td></tr>
     <tr><td class="num"> 25</td><td class="num"> 6.04</td><td class="left">'mrduke'</td></tr>
     <tr><td class="num"> 25</td><td class="num"> 4.88</td><td class="left">'Drotten'</td></tr>
-    <tr><td class="num"> 22</td><td class="num"> 7.32</td><td class="left">'Mark P.'</td></tr>
+    <tr><td class="num"> 23</td><td class="num"> 7.22</td><td class="left">'Mark P.'</td></tr>
     <tr><td class="num"> 17</td><td class="num"> 5.53</td><td class="left">'Jeffrey S'</td></tr>
     <tr><td class="num"> 16</td><td class="num"> 7.63</td><td class="left">'Ghatotkacha'</td></tr>
     <tr><td class="num"> 16</td><td class="num"> 3.88</td><td class="left">'Mecki'</td></tr>
@@ -48,6 +49,7 @@
     <tr><td class="num"> 11</td><td class="num"> 6.36</td><td class="left">'ShadowPhrogg32642342'</td></tr>
     <tr><td class="num"> 10</td><td class="num"> 7.80</td><td class="left">'hdwow'</td></tr>
     <tr><td class="num">  8</td><td class="num"> 3.25</td><td class="left">'Vlad'</td></tr>
+    <tr><td class="num">  8</td><td class="num"> 7.63</td><td class="left">'Antonio EE'</td></tr>
     <tr><td class="num">  7</td><td class="num"> 4.29</td><td class="left">'Snaily'</td></tr>
     <tr><td class="num">  5</td><td class="num"> 6.80</td><td class="left">'Breezy'</td></tr>
     <tr><td class="num">  5</td><td class="num"> 9.20</td><td class="left">'HuB34'</td></tr>
@@ -55,7 +57,6 @@
     <tr><td class="num">  4</td><td class="num">10.00</td><td class="left">'Kevin'</td></tr>
     <tr><td class="num">  4</td><td class="num"> 5.75</td><td class="left">'joseba'</td></tr>
     <tr><td class="num">  4</td><td class="num"> 1.00</td><td class="left">'Hans-HD'</td></tr>
-    <tr><td class="num">  4</td><td class="num"> 8.75</td><td class="left">'Antonio EE'</td></tr>
     <tr><td class="num">  4</td><td class="num"> 6.50</td><td class="left">'serpent'</td></tr>
     <tr><td class="num">  4</td><td class="num"> 7.00</td><td class="left">'redsantz'</td></tr>
     <tr><td class="num">  3</td><td class="num"> 0.67</td><td class="left">'Turbogurk'</td></tr>
@@ -63,13 +64,14 @@
     <tr><td class="num">  3</td><td class="num"> 7.67</td><td class="left">'Joona'</td></tr>
     <tr><td class="num">  3</td><td class="num"> 3.00</td><td class="left">'Rugby4ever'</td></tr>
     <tr><td class="num">  3</td><td class="num"> 4.33</td><td class="left">'krazy62'</td></tr>
+    <tr><td class="num">  2</td><td class="num"> 6.50</td><td class="left">'tjRaven'</td></tr>
     <tr><td class="num">  2</td><td class="num"> 0.00</td><td class="left">'mhatta'</td></tr>
     <tr><td class="num">  1</td><td class="num"> 5.00</td><td class="left">'ael'</td></tr>
+    <tr><td class="num">  1</td><td class="num"> 6.00</td><td class="left">'Slav'</td></tr>
     <tr><td class="num">  1</td><td class="num"> 4.00</td><td class="left">'Angolino'</td></tr>
     <tr><td class="num">  1</td><td class="num"> 5.00</td><td class="left">'Uli'</td></tr>
     <tr><td class="num">  1</td><td class="num">10.00</td><td class="left">'Cyphase'</td></tr>
     <tr><td class="num">  1</td><td class="num"> 5.00</td><td class="left">'Harry Lim'</td></tr>
-    <tr><td class="num">  1</td><td class="num"> 3.00</td><td class="left">'AkRa'</td></tr>
     <tr><td class="num">  1</td><td class="num"> 6.00</td><td class="left">'Emmanuel'</td></tr>
     <tr><td class="num">  1</td><td class="num"> 4.00</td><td class="left">'jojo'</td></tr>
   </table>

Modified: homepage/input/table-solved.html
===================================================================
--- homepage/input/table-solved.html	2008-04-02 17:36:56 UTC (rev 1091)
+++ homepage/input/table-solved.html	2008-04-04 21:08:43 UTC (rev 1092)
@@ -1,55 +1,56 @@
   <table>
-    <caption>$$Solved_Level_Statistics$$ $$February$$ 2008</caption>
+    <caption>$$Solved_Level_Statistics$$ $$March$$ 2008</caption>
     <colgroup><col width="130"><col width="130"><col width="130"><col width="240"></colgroup>
     <tr><th>$$difficult$$</th><th>$$easy$$</th><th>$$total$$</th><th class="left">$$user$$</th></tr>
     <tr><td class="num">1045/1045</td><td class="num">189/189</td><td class="num">100.00%</td><td class="left">'ryujun'</td></tr>
     <tr><td class="num">1043/1045</td><td class="num">189/189</td><td class="num"> 99.84%</td><td class="left">'Taztunes'</td></tr>
     <tr><td class="num">1029/1045</td><td class="num">183/189</td><td class="num"> 98.22%</td><td class="left">'Craven'</td></tr>
-    <tr><td class="num">1030/1045</td><td class="num">178/189</td><td class="num"> 97.89%</td><td class="left">'Moneymaker'</td></tr>
+    <tr><td class="num">1031/1045</td><td class="num">179/189</td><td class="num"> 98.06%</td><td class="left">'Moneymaker'</td></tr>
+    <tr><td class="num">1016/1045</td><td class="num">182/189</td><td class="num"> 97.08%</td><td class="left">'Ronald'</td></tr>
     <tr><td class="num">1021/1045</td><td class="num">177/189</td><td class="num"> 97.08%</td><td class="left">'Malla'</td></tr>
-    <tr><td class="num">1012/1045</td><td class="num">179/189</td><td class="num"> 96.52%</td><td class="left">'Ronald'</td></tr>
     <tr><td class="num">1014/1045</td><td class="num">175/189</td><td class="num"> 96.35%</td><td class="left">'Stupid'</td></tr>
     <tr><td class="num"> 999/1045</td><td class="num">177/189</td><td class="num"> 95.30%</td><td class="left">'biotopa'</td></tr>
-    <tr><td class="num"> 969/1045</td><td class="num">170/189</td><td class="num"> 92.30%</td><td class="left">'daydreamer'</td></tr>
+    <tr><td class="num"> 984/1045</td><td class="num">173/189</td><td class="num"> 93.76%</td><td class="left">'daydreamer'</td></tr>
     <tr><td class="num"> 970/1045</td><td class="num">166/189</td><td class="num"> 92.06%</td><td class="left">'Andy'</td></tr>
     <tr><td class="num"> 949/1045</td><td class="num">170/189</td><td class="num"> 90.68%</td><td class="left">'para_doks'</td></tr>
-    <tr><td class="num"> 942/1045</td><td class="num">172/189</td><td class="num"> 90.28%</td><td class="left">'Daisy'</td></tr>
+    <tr><td class="num"> 943/1045</td><td class="num">172/189</td><td class="num"> 90.36%</td><td class="left">'Daisy'</td></tr>
+    <tr><td class="num"> 943/1045</td><td class="num">168/189</td><td class="num"> 90.03%</td><td class="left">'mecke'</td></tr>
     <tr><td class="num"> 933/1045</td><td class="num">125/189</td><td class="num"> 85.74%</td><td class="left">'Alex'</td></tr>
     <tr><td class="num"> 914/1045</td><td class="num">135/189</td><td class="num"> 85.01%</td><td class="left">'JuSt'</td></tr>
+    <tr><td class="num"> 879/1045</td><td class="num">163/189</td><td class="num"> 84.44%</td><td class="left">'dev0'</td></tr>
     <tr><td class="num"> 894/1045</td><td class="num">140/189</td><td class="num"> 83.79%</td><td class="left">'Johannes'</td></tr>
     <tr><td class="num"> 887/1045</td><td class="num">143/189</td><td class="num"> 83.47%</td><td class="left">'mrduke'</td></tr>
-    <tr><td class="num"> 891/1045</td><td class="num">133/189</td><td class="num"> 82.98%</td><td class="left">'mecke'</td></tr>
+    <tr><td class="num">1020/1045</td><td class="num">  6/189</td><td class="num"> 83.14%</td><td class="left">'Freshman'</td></tr>
     <tr><td class="num"> 863/1045</td><td class="num">161/189</td><td class="num"> 82.98%</td><td class="left">'Tobias'</td></tr>
     <tr><td class="num"> 917/1045</td><td class="num">106/189</td><td class="num"> 82.90%</td><td class="left">'Django'</td></tr>
     <tr><td class="num"> 863/1045</td><td class="num">150/189</td><td class="num"> 82.09%</td><td class="left">'Gloop'</td></tr>
     <tr><td class="num"> 849/1045</td><td class="num">151/189</td><td class="num"> 81.04%</td><td class="left">'WP319'</td></tr>
     <tr><td class="num"> 867/1045</td><td class="num">124/189</td><td class="num"> 80.31%</td><td class="left">'Lukas'</td></tr>
-    <tr><td class="num"> 841/1045</td><td class="num">144/189</td><td class="num"> 79.82%</td><td class="left">'Gorn'</td></tr>
+    <tr><td class="num"> 846/1045</td><td class="num">144/189</td><td class="num"> 80.23%</td><td class="left">'Gorn'</td></tr>
+    <tr><td class="num"> 854/1045</td><td class="num">131/189</td><td class="num"> 79.82%</td><td class="left">'shoki'</td></tr>
     <tr><td class="num"> 874/1045</td><td class="num">103/189</td><td class="num"> 79.17%</td><td class="left">'Melanie'</td></tr>
-    <tr><td class="num"> 815/1045</td><td class="num">149/189</td><td class="num"> 78.12%</td><td class="left">'dev0'</td></tr>
-    <tr><td class="num"> 841/1045</td><td class="num">123/189</td><td class="num"> 78.12%</td><td class="left">'shoki'</td></tr>
     <tr><td class="num"> 950/1045</td><td class="num">  0/189</td><td class="num"> 76.99%</td><td class="left">'Tarim'</td></tr>
     <tr><td class="num"> 804/1045</td><td class="num">142/189</td><td class="num"> 76.66%</td><td class="left">'Safalra'</td></tr>
     <tr><td class="num"> 938/1045</td><td class="num">  1/189</td><td class="num"> 76.09%</td><td class="left">'Ale'</td></tr>
     <tr><td class="num"> 772/1045</td><td class="num">113/189</td><td class="num"> 71.72%</td><td class="left">'U-Punkt'</td></tr>
     <tr><td class="num"> 739/1045</td><td class="num">131/189</td><td class="num"> 70.50%</td><td class="left">'ABS'</td></tr>
-    <tr><td class="num"> 719/1045</td><td class="num">122/189</td><td class="num"> 68.15%</td><td class="left">'B-Huff'</td></tr>
+    <tr><td class="num"> 728/1045</td><td class="num">126/189</td><td class="num"> 69.21%</td><td class="left">'B-Huff'</td></tr>
+    <tr><td class="num"> 755/1045</td><td class="num"> 96/189</td><td class="num"> 68.96%</td><td class="left">'brynn'</td></tr>
     <tr><td class="num"> 762/1045</td><td class="num"> 73/189</td><td class="num"> 67.67%</td><td class="left">'redsantz'</td></tr>
-    <tr><td class="num"> 745/1045</td><td class="num"> 73/189</td><td class="num"> 66.29%</td><td class="left">'brynn'</td></tr>
     <tr><td class="num"> 734/1045</td><td class="num"> 82/189</td><td class="num"> 66.13%</td><td class="left">'bojster'</td></tr>
     <tr><td class="num"> 782/1045</td><td class="num"> 33/189</td><td class="num"> 66.05%</td><td class="left">'Sim_Ed'</td></tr>
+    <tr><td class="num"> 686/1045</td><td class="num">118/189</td><td class="num"> 65.15%</td><td class="left">'dpl'</td></tr>
     <tr><td class="num"> 766/1045</td><td class="num"> 37/189</td><td class="num"> 65.07%</td><td class="left">'alfred69'</td></tr>
+    <tr><td class="num"> 670/1045</td><td class="num">107/189</td><td class="num"> 62.97%</td><td class="left">'Ludmian'</td></tr>
     <tr><td class="num"> 681/1045</td><td class="num"> 78/189</td><td class="num"> 61.51%</td><td class="left">'HuB34'</td></tr>
     <tr><td class="num"> 659/1045</td><td class="num"> 95/189</td><td class="num"> 61.10%</td><td class="left">'Marc-Hendrik'</td></tr>
-    <tr><td class="num"> 649/1045</td><td class="num">101/189</td><td class="num"> 60.78%</td><td class="left">'Ludmian'</td></tr>
     <tr><td class="num"> 633/1045</td><td class="num">110/189</td><td class="num"> 60.21%</td><td class="left">'Raoul'</td></tr>
     <tr><td class="num"> 643/1045</td><td class="num"> 83/189</td><td class="num"> 58.83%</td><td class="left">'Great Scott'</td></tr>
-    <tr><td class="num"> 633/1045</td><td class="num"> 84/189</td><td class="num"> 58.10%</td><td class="left">'dpl'</td></tr>
     <tr><td class="num"> 714/1045</td><td class="num">  0/189</td><td class="num"> 57.86%</td><td class="left">'Gottseinsohn'</td></tr>
     <tr><td class="num"> 620/1045</td><td class="num"> 72/189</td><td class="num"> 56.08%</td><td class="left">'Breezy'</td></tr>
     <tr><td class="num"> 636/1045</td><td class="num"> 55/189</td><td class="num"> 56.00%</td><td class="left">'fabian'</td></tr>
+    <tr><td class="num"> 569/1045</td><td class="num">113/189</td><td class="num"> 55.27%</td><td class="left">'Mark P.'</td></tr>
     <tr><td class="num"> 588/1045</td><td class="num"> 93/189</td><td class="num"> 55.19%</td><td class="left">'Ghatotkacha'</td></tr>
-    <tr><td class="num"> 568/1045</td><td class="num">112/189</td><td class="num"> 55.11%</td><td class="left">'Mark P.'</td></tr>
     <tr><td class="num"> 599/1045</td><td class="num"> 80/189</td><td class="num"> 55.02%</td><td class="left">'serpent'</td></tr>
     <tr><td class="num"> 634/1045</td><td class="num"> 43/189</td><td class="num"> 54.86%</td><td class="left">'Klaus'</td></tr>
     <tr><td class="num"> 557/1045</td><td class="num">117/189</td><td class="num"> 54.62%</td><td class="left">'Alexandros'</td></tr>
@@ -64,8 +65,8 @@
     <tr><td class="num"> 478/1045</td><td class="num">101/189</td><td class="num"> 46.92%</td><td class="left">'Austin'</td></tr>
     <tr><td class="num"> 504/1045</td><td class="num"> 62/189</td><td class="num"> 45.87%</td><td class="left">'Hans-HD'</td></tr>
     <tr><td class="num"> 519/1045</td><td class="num"> 37/189</td><td class="num"> 45.06%</td><td class="left">'Valkyrie2'</td></tr>
+    <tr><td class="num"> 492/1045</td><td class="num"> 63/189</td><td class="num"> 44.98%</td><td class="left">'Antonio EE'</td></tr>
     <tr><td class="num"> 516/1045</td><td class="num"> 24/189</td><td class="num"> 43.76%</td><td class="left">'niebie'</td></tr>
-    <tr><td class="num"> 467/1045</td><td class="num"> 63/189</td><td class="num"> 42.95%</td><td class="left">'Antonio EE'</td></tr>
     <tr><td class="num"> 494/1045</td><td class="num"> 26/189</td><td class="num"> 42.14%</td><td class="left">'Daniel'</td></tr>
     <tr><td class="num"> 506/1045</td><td class="num"> 12/189</td><td class="num"> 41.98%</td><td class="left">'Duffy'</td></tr>
     <tr><td class="num"> 503/1045</td><td class="num">  7/189</td><td class="num"> 41.33%</td><td class="left">'Edgar_Flesk'</td></tr>
@@ -94,13 +95,13 @@
     <tr><td class="num"> 288/1045</td><td class="num"> 36/189</td><td class="num"> 26.26%</td><td class="left">'Drotten'</td></tr>
     <tr><td class="num"> 261/1045</td><td class="num"> 53/189</td><td class="num"> 25.45%</td><td class="left">'Andreas'</td></tr>
     <tr><td class="num"> 287/1045</td><td class="num"> 18/189</td><td class="num"> 24.72%</td><td class="left">'Nfol'</td></tr>
+    <tr><td class="num"> 269/1045</td><td class="num"> 26/189</td><td class="num"> 23.91%</td><td class="left">'Mecki'</td></tr>
     <tr><td class="num"> 276/1045</td><td class="num"> 15/189</td><td class="num"> 23.58%</td><td class="left">'Thomas'</td></tr>
     <tr><td class="num"> 245/1045</td><td class="num"> 36/189</td><td class="num"> 22.77%</td><td class="left">'B-man'</td></tr>
     <tr><td class="num"> 259/1045</td><td class="num">  7/189</td><td class="num"> 21.56%</td><td class="left">'geembo_90'</td></tr>
     <tr><td class="num"> 243/1045</td><td class="num"> 23/189</td><td class="num"> 21.56%</td><td class="left">'Snaily'</td></tr>
     <tr><td class="num"> 201/1045</td><td class="num"> 54/189</td><td class="num"> 20.66%</td><td class="left">'mhatta'</td></tr>
     <tr><td class="num"> 210/1045</td><td class="num"> 38/189</td><td class="num"> 20.10%</td><td class="left">'Sandra'</td></tr>
-    <tr><td class="num"> 220/1045</td><td class="num"> 25/189</td><td class="num"> 19.85%</td><td class="left">'Mecki'</td></tr>
     <tr><td class="num"> 208/1045</td><td class="num"> 33/189</td><td class="num"> 19.53%</td><td class="left">'Uli'</td></tr>
     <tr><td class="num"> 203/1045</td><td class="num"> 34/189</td><td class="num"> 19.21%</td><td class="left">'ntaeijr'</td></tr>
     <tr><td class="num"> 214/1045</td><td class="num"> 19/189</td><td class="num"> 18.88%</td><td class="left">'Adonica'</td></tr>
@@ -110,7 +111,9 @@
     <tr><td class="num"> 125/1045</td><td class="num"> 55/189</td><td class="num"> 14.59%</td><td class="left">'Vlad'</td></tr>
     <tr><td class="num"> 149/1045</td><td class="num"> 30/189</td><td class="num"> 14.51%</td><td class="left">'Chris'</td></tr>
     <tr><td class="num"> 158/1045</td><td class="num"> 20/189</td><td class="num"> 14.42%</td><td class="left">'Turbogurk'</td></tr>
+    <tr><td class="num"> 160/1045</td><td class="num"> 15/189</td><td class="num"> 14.18%</td><td class="left">'AkRa'</td></tr>
     <tr><td class="num"> 156/1045</td><td class="num"> 17/189</td><td class="num"> 14.02%</td><td class="left">'Zak'</td></tr>
+    <tr><td class="num"> 163/1045</td><td class="num"> 10/189</td><td class="num"> 14.02%</td><td class="left">'tjRaven'</td></tr>
     <tr><td class="num"> 164/1045</td><td class="num">  0/189</td><td class="num"> 13.29%</td><td class="left">'Bent'</td></tr>
     <tr><td class="num"> 124/1045</td><td class="num"> 33/189</td><td class="num"> 12.72%</td><td class="left">'joseba'</td></tr>
     <tr><td class="num"> 127/1045</td><td class="num"> 29/189</td><td class="num"> 12.64%</td><td class="left">'ael'</td></tr>
@@ -124,14 +127,16 @@
     <tr><td class="num">  75/1045</td><td class="num"> 12/189</td><td class="num">  7.05%</td><td class="left">'schmusi20'</td></tr>
     <tr><td class="num">  67/1045</td><td class="num"> 19/189</td><td class="num">  6.97%</td><td class="left">'Dvorhagen'</td></tr>
     <tr><td class="num">  57/1045</td><td class="num"> 26/189</td><td class="num">  6.73%</td><td class="left">'Meeve'</td></tr>
+    <tr><td class="num">  65/1045</td><td class="num"> 16/189</td><td class="num">  6.56%</td><td class="left">'Slav'</td></tr>
     <tr><td class="num">  64/1045</td><td class="num"> 16/189</td><td class="num">  6.48%</td><td class="left">'AQZ'</td></tr>
     <tr><td class="num">  59/1045</td><td class="num"> 21/189</td><td class="num">  6.48%</td><td class="left">'AsuCaga'</td></tr>
     <tr><td class="num">  58/1045</td><td class="num"> 19/189</td><td class="num">  6.24%</td><td class="left">'xmouse'</td></tr>
     <tr><td class="num">  67/1045</td><td class="num">  7/189</td><td class="num">  6.00%</td><td class="left">'Joona'</td></tr>
     <tr><td class="num">  54/1045</td><td class="num"> 12/189</td><td class="num">  5.35%</td><td class="left">'Samuel'</td></tr>
+    <tr><td class="num">  47/1045</td><td class="num"> 17/189</td><td class="num">  5.19%</td><td class="left">'crypto_rsa'</td></tr>
     <tr><td class="num">  44/1045</td><td class="num"> 16/189</td><td class="num">  4.86%</td><td class="left">'Agares'</td></tr>
     <tr><td class="num">  39/1045</td><td class="num"> 14/189</td><td class="num">  4.29%</td><td class="left">'jojo'</td></tr>
-    <tr><td class="num">  50/1045</td><td class="num">  1/189</td><td class="num">  4.13%</td><td class="left">'AkRa'</td></tr>
+    <tr><td class="num">  31/1045</td><td class="num"> 10/189</td><td class="num">  3.32%</td><td class="left">'colonel crayon'</td></tr>
     <tr><td class="num">  27/1045</td><td class="num">  5/189</td><td class="num">  2.59%</td><td class="left">'Miel56'</td></tr>
     <tr><td class="num">  23/1045</td><td class="num">  5/189</td><td class="num">  2.27%</td><td class="left">'The red O'</td></tr>
     <tr><td class="num">   7/1045</td><td class="num"> 12/189</td><td class="num">  1.54%</td><td class="left">'Michael'</td></tr>

Modified: homepage/input/table-wr.html
===================================================================
--- homepage/input/table-wr.html	2008-04-02 17:36:56 UTC (rev 1091)
+++ homepage/input/table-wr.html	2008-04-04 21:08:43 UTC (rev 1092)
@@ -1,52 +1,52 @@
   <table>
-    <caption>$$Worldrecord_Statistics$$ $$February$$ 2008</caption>
+    <caption>$$Worldrecord_Statistics$$ $$March$$ 2008</caption>
     <colgroup><col width="80"><col width="80"><col width="470"></colgroup>
     <tr><th>$$total$$</th><th>$$shared$$</th><th class="left">$$user$$</th></tr>
-    <tr><td class="num">931</td><td class="num">260</td><td class="left">'Moneymaker'</td></tr>
-    <tr><td class="num">202</td><td class="num">112</td><td class="left">'Stupid'</td></tr>
-    <tr><td class="num">145</td><td class="num">128</td><td class="left">'Johannes'</td></tr>
-    <tr><td class="num"> 77</td><td class="num"> 50</td><td class="left">'Duffy'</td></tr>
-    <tr><td class="num"> 61</td><td class="num"> 55</td><td class="left">'daydreamer'</td></tr>
-    <tr><td class="num"> 58</td><td class="num"> 55</td><td class="left">'Great Scott'</td></tr>
-    <tr><td class="num"> 57</td><td class="num"> 33</td><td class="left">'Malla'</td></tr>
-    <tr><td class="num"> 41</td><td class="num"> 38</td><td class="left">'Django'</td></tr>
-    <tr><td class="num"> 38</td><td class="num"> 31</td><td class="left">'Iceshark7'</td></tr>
-    <tr><td class="num"> 36</td><td class="num"> 27</td><td class="left">'Zekobah'</td></tr>
-    <tr><td class="num"> 35</td><td class="num"> 29</td><td class="left">'Alexandros'</td></tr>
-    <tr><td class="num"> 33</td><td class="num"> 31</td><td class="left">'joseba'</td></tr>
-    <tr><td class="num"> 28</td><td class="num"> 27</td><td class="left">'Ghatotkacha'</td></tr>
-    <tr><td class="num"> 23</td><td class="num"> 19</td><td class="left">'Ludmian'</td></tr>
-    <tr><td class="num"> 23</td><td class="num"> 20</td><td class="left">'ged'</td></tr>
-    <tr><td class="num"> 21</td><td class="num"> 15</td><td class="left">'Emmanuel'</td></tr>
-    <tr><td class="num"> 21</td><td class="num"> 19</td><td class="left">'Safalra'</td></tr>
-    <tr><td class="num"> 18</td><td class="num">  8</td><td class="left">'ryujun'</td></tr>
-    <tr><td class="num"> 18</td><td class="num"> 16</td><td class="left">'B-Huff'</td></tr>
-    <tr><td class="num"> 17</td><td class="num"> 14</td><td class="left">'HuB34'</td></tr>
+    <tr><td class="num">977</td><td class="num">240</td><td class="left">'Moneymaker'</td></tr>
+    <tr><td class="num">165</td><td class="num"> 96</td><td class="left">'Stupid'</td></tr>
+    <tr><td class="num">126</td><td class="num">115</td><td class="left">'Johannes'</td></tr>
+    <tr><td class="num"> 73</td><td class="num"> 57</td><td class="left">'daydreamer'</td></tr>
+    <tr><td class="num"> 62</td><td class="num"> 43</td><td class="left">'Duffy'</td></tr>
+    <tr><td class="num"> 48</td><td class="num"> 31</td><td class="left">'Malla'</td></tr>
+    <tr><td class="num"> 47</td><td class="num"> 46</td><td class="left">'Great Scott'</td></tr>
+    <tr><td class="num"> 36</td><td class="num"> 30</td><td class="left">'dev0'</td></tr>
+    <tr><td class="num"> 36</td><td class="num"> 34</td><td class="left">'Django'</td></tr>
+    <tr><td class="num"> 35</td><td class="num"> 27</td><td class="left">'Zekobah'</td></tr>
+    <tr><td class="num"> 34</td><td class="num"> 29</td><td class="left">'Iceshark7'</td></tr>
+    <tr><td class="num"> 32</td><td class="num"> 26</td><td class="left">'Alexandros'</td></tr>
+    <tr><td class="num"> 30</td><td class="num"> 29</td><td class="left">'joseba'</td></tr>
+    <tr><td class="num"> 29</td><td class="num"> 15</td><td class="left">'ryujun'</td></tr>
+    <tr><td class="num"> 27</td><td class="num"> 26</td><td class="left">'Ghatotkacha'</td></tr>
+    <tr><td class="num"> 20</td><td class="num"> 15</td><td class="left">'Emmanuel'</td></tr>
+    <tr><td class="num"> 20</td><td class="num"> 17</td><td class="left">'Ludmian'</td></tr>
+    <tr><td class="num"> 20</td><td class="num"> 18</td><td class="left">'ged'</td></tr>
+    <tr><td class="num"> 20</td><td class="num"> 19</td><td class="left">'Safalra'</td></tr>
+    <tr><td class="num"> 19</td><td class="num"> 17</td><td class="left">'B-Huff'</td></tr>
     <tr><td class="num"> 17</td><td class="num"> 17</td><td class="left">'bojster'</td></tr>
-    <tr><td class="num"> 16</td><td class="num"> 16</td><td class="left">'ABS'</td></tr>
-    <tr><td class="num"> 14</td><td class="num">  7</td><td class="left">'Ronald'</td></tr>
+    <tr><td class="num"> 16</td><td class="num">  8</td><td class="left">'Ronald'</td></tr>
+    <tr><td class="num"> 16</td><td class="num"> 14</td><td class="left">'HuB34'</td></tr>
+    <tr><td class="num"> 15</td><td class="num"> 15</td><td class="left">'ABS'</td></tr>
     <tr><td class="num"> 11</td><td class="num">  8</td><td class="left">'Chocolate Zero'</td></tr>
-    <tr><td class="num"> 11</td><td class="num">  9</td><td class="left">'dev0'</td></tr>
     <tr><td class="num"> 10</td><td class="num">  6</td><td class="left">'Taztunes'</td></tr>
-    <tr><td class="num"> 10</td><td class="num"> 10</td><td class="left">'fabian'</td></tr>
     <tr><td class="num">  9</td><td class="num">  5</td><td class="left">'ShadowPhrogg32642342'</td></tr>
     <tr><td class="num">  9</td><td class="num">  6</td><td class="left">'Gloop'</td></tr>
-    <tr><td class="num">  7</td><td class="num">  2</td><td class="left">'Breezy'</td></tr>
-    <tr><td class="num">  7</td><td class="num">  6</td><td class="left">'dpl' + 'Edgar_Flesk'</td></tr>
+    <tr><td class="num">  9</td><td class="num">  9</td><td class="left">'fabian'</td></tr>
+    <tr><td class="num">  8</td><td class="num">  8</td><td class="left">'dpl'</td></tr>
+    <tr><td class="num">  7</td><td class="num">  6</td><td class="left">'Edgar_Flesk'</td></tr>
+    <tr><td class="num">  6</td><td class="num">  2</td><td class="left">'Breezy'</td></tr>
     <tr><td class="num">  6</td><td class="num">  3</td><td class="left">'para_doks'</td></tr>
     <tr><td class="num">  6</td><td class="num">  4</td><td class="left">'Lukas'</td></tr>
-    <tr><td class="num">  6</td><td class="num">  5</td><td class="left">'Guglielmo' + 'U-Punkt'</td></tr>
+    <tr><td class="num">  6</td><td class="num">  5</td><td class="left">'Guglielmo'</td></tr>
     <tr><td class="num">  6</td><td class="num">  6</td><td class="left">'Tobias' + 'Wuzzy'</td></tr>
     <tr><td class="num">  5</td><td class="num">  4</td><td class="left">'Angolino'</td></tr>
     <tr><td class="num">  5</td><td class="num">  5</td><td class="left">'Raoul' + 'Cyphase' + 'Thomas' + 'Chris' + 'Ralf'</td></tr>
-    <tr><td class="num">  4</td><td class="num">  2</td><td class="left">'Bent' + 'Craven'</td></tr>
-    <tr><td class="num">  4</td><td class="num">  4</td><td class="left">'J3FF'</td></tr>
-    <tr><td class="num">  3</td><td class="num">  2</td><td class="left">'Stephanie' + 'Daisy'</td></tr>
+    <tr><td class="num">  4</td><td class="num">  2</td><td class="left">'Bent'</td></tr>
+    <tr><td class="num">  4</td><td class="num">  4</td><td class="left">'U-Punkt' + 'J3FF'</td></tr>
+    <tr><td class="num">  3</td><td class="num">  2</td><td class="left">'Craven' + 'colonel crayon' + 'Stephanie'</td></tr>
     <tr><td class="num">  3</td><td class="num">  3</td><td class="left">'geembo_90' + 'Neophilus' + 'Andy'</td></tr>
-    <tr><td class="num">  2</td><td class="num">  0</td><td class="left">'Ale'</td></tr>
-    <tr><td class="num">  2</td><td class="num">  1</td><td class="left">'mrduke' + 'Daniel' + 'oblo'</td></tr>
-    <tr><td class="num">  2</td><td class="num">  2</td><td class="left">'Drotten' + 'Sim_Ed' + 'hendrik' + 'Austin' + 'Snaily' + 'Ingo' + 'serpent'</td></tr>
-    <tr><td class="num">  1</td><td class="num">  0</td><td class="left">'Gorn' + 'Nat'</td></tr>
-    <tr><td class="num">  1</td><td class="num">  1</td><td class="left">'alfred69' + 'Agares' + 'ntaeijr' + 'Tiger' + 'Zak' + 'Tiza' + 'niebie' + 'Andreas' + 'Samuel' + 'Mark P.' + 'jdcampo' + 'hdwow' + 'B-man' + 'Asbel' + 'Vlad' + 'Vaily' + 'Hans-HD' + 'krazy62' + 'JuSt'</td></tr>
-    <tr><td class="num">  0</td><td class="num">  0</td><td class="left">'AQZ' + 'Miel56' + 'Alf' + 'Turbogurk' + 'Gottseinsohn' + 'ael' + 'biotopa' + 'brynn' + 'IntKecsk' + 'Davacardo' + 'Adonica' + 'Joona' + 'Sandra' + 'schmusi20' + 'Kosby' + 'Magnus and Susi' + 'WP319' + 'Kevin' + 'xmouse' + 'erich' + 'Vinksu' + 'Uli' + 'Alex' + 'Little_Mole' + 'Harry Lim' + 'AkRa' + 'Momcat' + 'NorthForty' + 'Mecki' + 'The red O' + 'Jeffrey S' + 'Nfol' + 'Marc-Hendrik' + 'shoki' + 'jojo' + 'Klaus' + 'Valkyrie2' + 'MicWa' + 'AsuCaga' + 'Rugby4ever' + 'Archcorenth' + 'Meeve' + 'mhatta' + 'mecke' + 'Dvorhagen' + 'Antonio EE' + 'Holger' + 'Ingo_K' + 'Ant' + 'Melanie' + 'IChrisI' + 'redsantz' + 'Markus' + 'Liam Sheehan' + 'Michael' + 'Tarim' + 'Agnieszka'</td></tr>
+    <tr><td class="num">  2</td><td class="num">  1</td><td class="left">'mrduke' + 'Daniel' + 'Slav' + 'tjRaven'</td></tr>
+    <tr><td class="num">  2</td><td class="num">  2</td><td class="left">'Drotten' + 'Sim_Ed' + 'hendrik' + 'Austin' + 'Snaily' + 'Antonio EE' + 'Ingo' + 'serpent'</td></tr>
+    <tr><td class="num">  1</td><td class="num">  0</td><td class="left">'Ale' + 'Gorn' + 'Nat' + 'Daisy'</td></tr>
+    <tr><td class="num">  1</td><td class="num">  1</td><td class="left">'alfred69' + 'Agares' + 'ntaeijr' + 'Tiger' + 'Zak' + 'Tiza' + 'niebie' + 'Andreas' + 'Samuel' + 'Mark P.' + 'oblo' + 'hdwow' + 'B-man' + 'Asbel' + 'Vlad' + 'Vaily' + 'krazy62' + 'JuSt'</td></tr>
+    <tr><td class="num">  0</td><td class="num">  0</td><td class="left">'AQZ' + 'Miel56' + 'Alf' + 'Turbogurk' + 'Gottseinsohn' + 'ael' + 'biotopa' + 'brynn' + 'IntKecsk' + 'Davacardo' + 'Adonica' + 'Joona' + 'Sandra' + 'schmusi20' + 'Kosby' + 'Magnus and Susi' + 'WP319' + 'Kevin' + 'xmouse' + 'erich' + 'Vinksu' + 'Uli' + 'Alex' + 'jdcampo' + 'Freshman' + 'Little_Mole' + 'crypto_rsa' + 'Harry Lim' + 'AkRa' + 'Momcat' + 'NorthForty' + 'Mecki' + 'The red O' + 'Jeffrey S' + 'Nfol' + 'Marc-Hendrik' + 'shoki' + 'jojo' + 'Klaus' + 'Valkyrie2' + 'MicWa' + 'AsuCaga' + 'Rugby4ever' + 'Archcorenth' + 'Meeve' + 'mhatta' + 'Hans-HD' + 'mecke' + 'Dvorhagen' + 'Holger' + 'Ingo_K' + 'Ant' + 'Melanie' + 'IChrisI' + 'redsantz' + 'Markus' + 'Liam Sheehan' + 'Michael' + 'Tarim' + 'Agnieszka'</td></tr>
   </table>

Modified: homepage/input/userlist.html
===================================================================
--- homepage/input/userlist.html	2008-04-02 17:36:56 UTC (rev 1091)
+++ homepage/input/userlist.html	2008-04-04 21:08:43 UTC (rev 1092)
@@ -31,7 +31,9 @@
     <li>brynn</li>
     <li>Chocolate Zero</li>
     <li>Chris</li>
+    <li>colonel crayon</li>
     <li>Craven</li>
+    <li>crypto_rsa</li>
     <li>Cyphase</li>
     <li>Daisy</li>
     <li>Daniel</li>
@@ -47,6 +49,7 @@
     <li>Emmanuel</li>
     <li>erich</li>
     <li>fabian</li>
+    <li>Freshman</li>
     <li>ged</li>
     <li>geembo_90</li>
     <li>Ghatotkacha</li>
@@ -120,6 +123,7 @@
     <li>ShadowPhrogg32642342</li>
     <li>shoki</li>
     <li>Sim_Ed</li>
+    <li>Slav</li>
     <li>Snaily</li>
     <li>Stephanie</li>
     <li>Stupid</li>
@@ -129,6 +133,7 @@
     <li>Thomas</li>
     <li>Tiger</li>
     <li>Tiza</li>
+    <li>tjRaven</li>
     <li>Tobias</li>
     <li>Turbogurk</li>
     <li>Uli</li>



From andreasl at mail.berlios.de  Sun Apr  6 21:10:28 2008
From: andreasl at mail.berlios.de (andreasl at BerliOS)
Date: Sun, 6 Apr 2008 21:10:28 +0200
Subject: [Enigma-game-svn] r1093 - in homepage: . images/lotm input
	input/lotm
Message-ID: <200804061910.m36JAS4Y010668@sheep.berlios.de>

Author: andreasl
Date: 2008-04-06 21:10:27 +0200 (Sun, 06 Apr 2008)
New Revision: 1093

Added:
   homepage/images/lotm/lotm_200804.png
   homepage/images/lotm/lotm_200804_a.png
   homepage/images/lotm/lotm_200804_b.png
   homepage/images/lotm/lotm_200804_c.png
   homepage/images/lotm/lotm_200804_d.png
   homepage/images/lotm/lotm_200804_e.png
   homepage/input/lotm/lotm_200804.html
   homepage/input/lotm/lotm_200804_de.html
   homepage/input/lotm/lotm_200804_ru.html
Modified:
   homepage/enigma.css
   homepage/input/infobox.html
   homepage/input/infobox_de.html
   homepage/input/infobox_ru.html
   homepage/input/lotm/lotm_archive_data.lua
Log:
Homepage:
 - Merged LotM-feature branch to homepage
 - Updated Infobox: "End of Year Awards 2007" replaced by
   "April Fool's Day '08"
 - Validated: Main page, Lotm 04/2008, "The Three Clouds"
Todo:
 - Russian translation of infobox title ("April Fool's Day",
   if such a thing exists ...)
 - Maybe Russian translation of "The Three Clouds" article
 - Add a page with a list of all extraordinary articles, currently:
    - End of Year Awards '07
    - End of Year Awards '07 - Statistics
    - April Fool's Day '08 - "The Three Clouds"


Modified: homepage/enigma.css
===================================================================
--- homepage/enigma.css	2008-04-04 21:08:43 UTC (rev 1092)
+++ homepage/enigma.css	2008-04-06 19:10:27 UTC (rev 1093)
@@ -455,6 +455,13 @@
     font-size: 90%;
 }
 
+.lotm .alter {
+    color: #eeeeee;
+    font-weight: bold;
+    font-style: italic;
+    background-color: #aaaaaa;
+}
+
 .credits table td {
     padding-right: 1em;
 }

Copied: homepage/images/lotm/lotm_200804.png (from rev 1092, feature_branches/hp_lotm/images/lotm/lotm_200804.png)

Copied: homepage/images/lotm/lotm_200804_a.png (from rev 1092, feature_branches/hp_lotm/images/lotm/lotm_200804_a.png)

Copied: homepage/images/lotm/lotm_200804_b.png (from rev 1092, feature_branches/hp_lotm/images/lotm/lotm_200804_b.png)

Copied: homepage/images/lotm/lotm_200804_c.png (from rev 1092, feature_branches/hp_lotm/images/lotm/lotm_200804_c.png)

Copied: homepage/images/lotm/lotm_200804_d.png (from rev 1092, feature_branches/hp_lotm/images/lotm/lotm_200804_d.png)

Copied: homepage/images/lotm/lotm_200804_e.png (from rev 1092, feature_branches/hp_lotm/images/lotm/lotm_200804_e.png)

Modified: homepage/input/infobox.html
===================================================================
--- homepage/input/infobox.html	2008-04-04 21:08:43 UTC (rev 1092)
+++ homepage/input/infobox.html	2008-04-06 19:10:27 UTC (rev 1093)
@@ -6,19 +6,20 @@
          Thanks to all players who made this possible!
          
          <h3>Level of the Month</h3>
-         <!-- Temporarily redirected
          <a href="$$lotm_current$$"><img src="$$lotm_current_image$$"
          alt="$$lotm_expansion$$" border="0"></a>
          <div class="imagetitle">
            <a href="$$lotm_current$$">&quot;$$lotm_current_name$$&quot;</a>
          </div>
-         -->
+
+         <h3>April Fool's Day '08</h3>
          <a href="$$april_2008$$"><img src="$$imagedir$$/articles/april_2008.png"
          alt="$$lotm_expansion$$" border="0"></a>
          <div class="imagetitle">
            <a href="$$april_2008$$">&quot;The Three Clouds&quot;</a>
          </div>
          
+         <!--
          <h3>End-of-Year Awards</h3>
          <a href="$$eoya_2007$$"><img src="images/articles/eoya_2007.png"
          alt="Which might be the Level of the Year?" border="0"></a>
@@ -27,6 +28,7 @@
            has been determined - find out who got the awards
            <a href="$$eoya_2007$$">here</a>!
          </div>
+         -->
          
          <h3>PAR and Hcp Recalibration</h3>
 	 Due to the increasing number of score submitters we are now able to

Modified: homepage/input/infobox_de.html
===================================================================
--- homepage/input/infobox_de.html	2008-04-04 21:08:43 UTC (rev 1092)
+++ homepage/input/infobox_de.html	2008-04-06 19:10:27 UTC (rev 1093)
@@ -7,19 +7,20 @@
          die dies m&ouml;glich gemacht haben!
 
          <h3>Level des Monats</h3>
-         <!-- Temporarily redirected
          <a href="$$lotm_current$$"><img src="$$lotm_current_image$$"
          alt="$$lotm_expansion$$" border="0"></a>
          <div class="imagetitle">
            <a href="$$lotm_current$$">&quot;$$lotm_current_name$$&quot;</a>
          </div>
-         -->
+
+         <h3>Aprilscherz '08</h3>
          <a href="$$april_2008$$"><img src="$$imagedir$$/articles/april_2008.png"
          alt="$$lotm_expansion$$" border="0"></a>
          <div class="imagetitle">
            <a href="$$april_2008$$">&quot;The Three Clouds&quot;</a>
          </div>
          
+         <!--
          <h3>Jahresend-<br>auszeichnungen</h3>
          <a href="$$eoya_2007$$"><img src="images/articles/eoya_2007.png"
          alt="Welches mag der Level des Jahres sein?" border="0"></a>
@@ -28,6 +29,7 @@
            Jahres 2007 steht fest - finden Sie <a href="$$eoya_2007$$">hier</a>
            raus, wer die Preise gewonnen hat!
          </div>
+         -->
 
          <h3>PAR und Hcp Recalibration</h3>
 	 Aufgrund der gestiegenen Anzahl an Einsendungen von Ergebnissen

Modified: homepage/input/infobox_ru.html
===================================================================
--- homepage/input/infobox_ru.html	2008-04-04 21:08:43 UTC (rev 1092)
+++ homepage/input/infobox_ru.html	2008-04-06 19:10:27 UTC (rev 1093)
@@ -6,25 +6,27 @@
          ??????? ???? ???????, ??????? ??????? ??? ?????????!
 
          <h3>??????? ??????</h3>
-         <!-- Temporarily redirected
          <a href="$$lotm_current$$"><img src="$$lotm_current_image$$"
          alt="$$lotm_expansion$$" border="0"></a>
          <div class="imagetitle">
            <a href="$$lotm_current$$">&quot;$$lotm_current_name$$&quot;</a>
          </div>
-         -->
+
+         <h3>April Fool's Day '08</h3>
          <a href="$$april_2008$$"><img src="$$imagedir$$/articles/april_2008.png"
          alt="$$lotm_expansion$$" border="0"></a>
          <div class="imagetitle">
            <a href="$$april_2008$$">&quot;The Three Clouds&quot;</a>
          </div>
          
+         <!--
          <h3>??????? ????? ????</h3>
          <a href="$$eoya_2007$$"><img src="images/articles/eoya_2007.png"
          alt="????? ????? ???? ??????? ?????" border="0"></a>
          <div class="imagetitle">
            ?????? ?????? 2007 ???????, ? ??????? ???? 2007 ????????? - ??????? ??? ??????? ??????? <a href="$$eoya_2007$$">?????</a>!
          </div>
+         -->
 
          <h3>???????????? PAR ? Hcp</h3>
 	 ?? ????????? ????????? ????? ??????????? ???????????, ?? ??????

Copied: homepage/input/lotm/lotm_200804.html (from rev 1092, feature_branches/hp_lotm/input/lotm/lotm_200804.html)
===================================================================
--- feature_branches/hp_lotm/input/lotm/lotm_200804.html	2008-04-04 21:08:43 UTC (rev 1092)
+++ homepage/input/lotm/lotm_200804.html	2008-04-06 19:10:27 UTC (rev 1093)
@@ -0,0 +1,337 @@
+<div class="lotm">
+$$lotm_header$$
+
+  <h3 class="lotm">
+    <span class="date">April 2008: </span>
+    &quot;Turnstiles for Two - Rhapsody on Turnstiles in Blue and Green&quot;
+  </h3>
+
+<h4>by Ronald Lamprecht</h4>
+
+<p>
+The world of the &quot;black ball&quot; has lots of facets; races,
+meditating, visiting temples and mazes, deciphering, space adventures, alone or
+as a twosome, we're even blessed with nightmares, to name a few. But
+what's about the world of music? Not that much? Not at all. But even if no
+catchy tune reveals itself easily to us we can come up with a
+rhapsody.
+</p>
+
+<div class="lotmpic">
+<img src="$$imagedir$$/lotm/lotm_200804_a.png" alt="of the Month" border="0">
+<div class="imagetitle">Enigma VI # 77</div>
+</div>
+
+<table cellpadding="0" cellspacing="1" class="statistics">
+<caption class="normalcaption">Some records of February 2008</caption>
+<colgroup>
+   <col width="80">
+   <col width="160">
+</colgroup>
+<tr><td class="num">9:30</td>
+        <td class="left">dev0</td></tr>
+    <tr><td class="num">10:04</td>
+        <td class="left">Taztunes</td></tr>
+    <tr><td class="num">10:43</td>
+        <td class="left">Craven</td></tr>
+    <tr><td class="num">16:03</td>
+        <td class="left">ryujun</td></tr>
+    <tr><td class="num">16:36</td>
+        <td class="left">Ronald</td></tr>
+    <tr><td class="num">16:47</td>
+        <td class="left">Daisy</td></tr>
+    <tr><td class="num">21:19</td>
+        <td class="left">para_doks</td></tr>
+</table>
+
+<p></p>
+
+<table cellpadding="0" cellspacing="1" class="statistics">
+<caption class="normalcaption">Easy Mode</caption>
+<colgroup>
+   <col width="80">
+   <col width="160">
+</colgroup>
+    <tr><td class="num">8:11</td>
+        <td class="left">dev0</td></tr>
+    <tr><td class="num">10:40</td>
+        <td class="left">Taztunes</td></tr>
+    <tr><td class="num">12:29</td>
+        <td class="left">Ronald</td></tr>
+    <tr><td class="num">13:04</td>
+        <td class="left">ryujun</td></tr>
+    <tr><td class="num">14:46</td>
+        <td class="left">Craven</td></tr>
+    <tr><td class="num">17:47</td>
+        <td class="left">para_doks</td></tr>
+    <tr><td class="num">18:42</td>
+        <td class="left">Daisy</td></tr>
+</table>
+
+
+<p>
+<span class="alter">
+Pupil: &quot;A what?&quot;<br>
+Schoolmaster <i>(speaking demurely while raising his finger)</i>:
+&quot;Once again, not paying attention during music class?&quot;<br>
+Pupil <i>(sheepishly with lowered head, but rolliing his eyes)</i>: &quot;I'm
+afraid, I don't remember this.&quot;<br>
+Schoolmaster <i>(patronizingly (what else), pacing up and down)</i>:
+&quot;Very
+well then, again. A rhapsody is a piece of music, with themes that are not
+rigidly, but loosley associated. Furthermore, they need not, but
+rather can&mdash;a small, but subtle difference <i>(pupil rolls
+with eyes again, getting bored more and more)</i>&mdash;be composed of motifs
+which are not linked to each other, or even based on each other 
+&hellip;&quot;<br>
+Pupil <i>(finally switching off, muttering to himself)</i>: &quot;Blah, blah,
+blah&hellip;&quot;
+</span>
+</p>
+
+<div class="lotmpic">
+<img src="$$imagedir$$/lotm/lotm_200804_b.png" alt="Level des Monats 04/2008" border="0">
+<div class="imagetitle">A solo in a duet</div>
+</div>
+
+<p>
+<span class="alter">
+Oh no! Let's swiftly leave this horrible place and return to much more
+pleasant things.
+</span>
+Hey, that's my text. Get out.<br>
+<span class="alter">But, I&hellip;</span><br>
+No &quot;but&quot;.<br>
+&hellip;<br>
+Okay, he's gone.
+</p>
+
+<p>Well, turnstiles &hellip; it's a difficult story. You can not
+only transport yourself over water, but the other marble as well. However, it
+may happen that the other one can't return without some help. <br>
+Actually, maybe I'll bring
+him back later; after all, if you remove the blather, what he said is not
+incorrect. The subtitle is quite apt.
+</p>
+
+<h4>&quot;Aside from experience it's a matter of sure instinct&quot;</h4>
+
+<div class="quote">It's quite a while ago since I've been playing &quot;Turnstiles for Two&quot;. But now that I've taken a closer look at the level again, I remembered, that most of all I had problems to stay on the spot after turning down one of the turntiles' arms. Espicially that applies to the complex in the middle of the bottom half, where you don't have much room to maneuver. No wonder the availability of the pins makes such a great difference between easy and difficult mode.</div>
+
+<div class="quote">Additionally foresighted planning is the word! It's not only a question of getting to the oxyds but also of getting back there. It took me quite some time to figure out how to fit these &quot;islands&quot; in the centre of the level into my plannings.</div> 
+
+<div class="quote">But the real difficulty about &quot;Turnstiles for Two&quot; is - once again - to make it to the final oxyd. Aside from experience it's a matter of sure instinct: although you've got the hang of it, it still won't work each time. You'll have to rush to the right place as quickly as possible, to catch the transporter to the island with the last oxyd.</div>
+
+<div class="quote">By the way, there's another level by Ronald Lamprecht (&quot;Cold Meditation&quot;), where you'll have to take a similar action, to be pushed into the final block of ice.</div>
+
+<div class="author">Craven</div>
+
+<div class="lotmpic">
+<img src="$$imagedir$$/lotm/lotm_200804_d.png" alt="Level des Monats 04/2008" border="0">
+<div class="imagetitle">
+Hmm &hellip; and now?
+</div>
+</div>
+
+<p>
+So, let's see and listen to what our two musicians have to offer. The beginning
+is quite relaxed. In the initial chords, one sets the tune, and the other
+one follows. But now our two musicians approach the central motif. Each one
+chooses his own musical way, supported by the other. Two threads of suspension,
+individually enriched with smaller soli, reach toward the central motif. Our two
+marbles don't stay there for long, but introduce the remaining themes of their
+rhapsody: a short solo, an interesting and tasty intermezzo and last but not
+least the technically most ambitious part of their recital, a melody peppered
+with lots of sharps, which requires the most concentration and precision
+from both sides.
+</p>
+
+<h4>&quot;I appreciate his devotion to fully exploring new elements to the game&quot;</h4>
+
+<div class="quote">I was glad to be asked to comment on &quot;Turnstiles for Two&quot; not only
+because of my life in music, but because it's actually my favorite
+&quot;Teamplay Level&quot; in Enigma. I know that Ronald intended it as a
+Rhapsody, and the description seems apt, but this level brings to
+my mind something quite a bit older. Lately, I've been rediscovering
+Bach's 2-part Inventions, and these make a fine analogy to what Ronald
+has created.</div>
+
+<div class="quote">In Bach, the two hands play interrelated, contrapuntal melodies - each
+hand is limited by its range, just as the white and black marble here
+have limits on what they can and can't do - where they can and can't go.
+Together the two melodic lines create a harmonic progression as they
+wend their way independently through the piece. And if you manage to
+make it through some technically treacherous, but gorgeous music,
+there's more often than not a very satisfying major chord awaiting you
+in the final bar.</div>
+
+<div class="quote">One thing I appreciate about Ronald's levels is his devotion to fully
+exploring new elements to the game or finding new uses for these. This
+level is a wonderful exploration of the attributes of the green
+turnstile. Almost every action requires both marbles to work together.
+Ronald has also made the level more challenging (and also more fun)
+by setting it up so that the maximum number of corresponding oxyds
+among the top four is one pair.</div>
+
+<div class="quote">No matter what, you're going to have to negotiate your way back to the
+top and then down again to finish up. The biggest challenge for me is
+the cluster of 4 oxyds in the middle of the water in the center of the
+bottom part of the level - it's really tricky to avoid knocking one or
+the other of the marbles in, and then, you have to start over again.</div>
+
+<div class="quote">One other very appealing aspect to &quot;Turnstiles for Two&quot; is that the
+level is gorgeous to look at. You might as well be vacationing in the
+Greek isles with all the aqua and white. Congratulations to Ronald for
+such an enjoyable Enigma experience!</div>
+
+<div class="author">Taztunes</div>
+
+<p>
+Now, after all motifs are presented, our two musicians will resolve them
+stylistically with confidence. They often return to the
+central motif, skillfully varying it. We approach the finale, in which one of
+them once again presents mastery of his instrument. The audience acknowledges
+our two musicians with well-earned applause as they leave the stage. What
+a fantastic show!
+</p>
+
+<div class="lotmpic">
+<img src="$$imagedir$$/lotm/lotm_200804_c.png" alt="Level des Monats 04/2008" border="0">
+<div class="imagetitle">
+Life in Concert: &quot;The Be Sharps&quot;
+</div>
+</div>
+
+<p>
+But to reach concert level, lots of practice is needed; because mistakes will be
+unforgivingly punished: One starts anew at the beginning. Carelessness
+(declining concentration or missing anticipation) at strategic positions like
+the central motif, has disastrous effects (Shift-F3).
+</p>
+
+<p>
+<span class="alter">As I always say,<br>practice makes
+perfect.</span><br>
+&quot;Hey you! Keep it down! Save your bathetic platitudes.&quot;</p>
+
+<p>Yet, he's right. How often
+did I involuntarily jump into the cold water at the 'sharp'? Be it from a lack
+in precision or from forgetting to switch to the other marble&mdash;who knows
+why. Hence: Relax, keep calm and don't act rashly. All caffeine junkies
+among us (like myself) should prepare by reducing their coffee consumption. And
+to get a steady hand, maybe have a glass vin rouge ;-).
+</p>
+
+<p>
+The central motif costs some more nerves as well (no picture here, as we don't
+want to spoil too much). Your 'orchestration' of the 'instruments' has to be planned well
+and with foresight, if you don't want to spoil your way back to the the upper
+and lower motifs. If an 'instrument' isn't 'tuned' right, the traditional
+consequences (Shift-F3) inevitably arise.
+</p>
+
+<p>
+The level is very appealing, thanks to the use of a white and a black
+marble. Each of them has areas, which are mutually inaccessible,
+but require the other marble's cooperation to reach them (like
+e.g. the 'sharp').
+</p>
+
+<p>
+Well now, gamers, tune your 'instruments' and get ready for the downbeat of
+your duet.
+</p>
+
+<h4>&quot;The green turnstile had proven to be more valuable than I would ever
+had thought it could be&quot;</h4>
+
+<p>
+As a tiny dissonance I mention the vortex; as it's not compulsory to use
+it. But maybe I didn't comprehend the composition in its complete entirety.
+So I'll simply reemerge back into the world of Enigma's sounds with greatest
+indulgence.
+</p>
+
+<div class="quote">It may sound crazy, but &quot;Turnstiles for Two&quot; is a commissioned work. In 
+the aftermath of release 1.00 we received reports about spurious crash 
+problems with turnstile levels. While debugging the turnstile code the 
+green turnstiles attracted my attention. There had just been one level 
+that made use of it - &quot;Zig Zag&quot;, and it made just indirect usage of it. 
+I questioned the existence of this variation with all the extra code that 
+it required. But after a short time I found a first direct usage pattern 
+for a one marble level resulting in the level &quot;Revolver&quot; in mid February 
+2007.</div>
+ 
+<div class="quote">But I expected the real value of the green turnstile to show up in multi 
+marble levels. Thus I claimed on March 13th that we should write an 
+introductionary level for green turnstiles that should demo some useful 
+patterns. Two days later I tried to write this level. After three hours 
+of work I had finished two new levels, &quot;Cold Meditation&quot; and &quot;Polar 
+Bear's Paradise&quot;. Next day Andreas desperately asked if &quot;Cold Meditation&quot; 
+should be the announced demo level.</div>
+
+<div class="quote">Of course not! I just had collected some patterns and got distracted by 
+other level ideas. But now I got the idea of a pattern arrangement and 
+with every pattern that I added to the level I found new green turnstile 
+patterns. Two funny evening sessions later &quot;Turnstiles for Two&quot; was ready 
+for a first shipment on the early hours of March 17th. The green 
+turnstile had proven to be more valuable than I would ever had thought 
+it could be.</div>
+
+<div class="lotmpic">
+<img src="$$imagedir$$/lotm/lotm_200804_e.png" alt="Level des Monats 04/2008" border="0">
+<div class="imagetitle">
+A seesaw for childs and adults <br>of (nearly) all ages
+</div>
+</div>
+
+<div class="quote">On both evenings I interrupted my work looking for some inspiration. I 
+sat down at the piano and both times I started playing by heart one of 
+my favorite pieces - Gershwin's &quot;Rhapsody In Blue&quot;. It just did fit - 
+the various independent patterns to a common theme bound together by a 
+global framework, black and white, and additional emotions like desire and indetermination. 
+In fact Gershwin did first name his piece &quot;Nocturne in Blue and Green&quot; 
+the colors standing for the emotions. With the green turnstiles being 
+the main subject I just had to subtitle my level &quot;Rhapsody on turnstiles 
+in blue and green&quot;.
+</div>
+
+<div class="quote">Several times users did express their astonishment about the time frame 
+in which I wrote some of my best levels. But that is the very nature of 
+creativity. You spend uncounted hours playing and developing Enigma and 
+suddenly you have the idea for a level. BTW Gershwin wrote his 
+rhapsody in 24 days and nights! But he finished setting down his own 
+piano solo part months after the world premiere.</div>
+
+<div class="quote">&quot;Turnstiles for Two&quot; had not been finished after
+two evenings, either. I 
+detected one subtle point, that I first did not know how to solve - a 
+fair, solvable oxyd distribution. Just shuffling all 16 oxyds does not 
+work. E.g. if all the upper oxyds build pairs there would be no reason 
+to return to the upper part later on. But it is a key point of the level 
+that you have to return to the upper part after investigation of the 
+lower part. Finally I wrote a small special Lua function that takes 
+appropriate influence on the oxyd distribution. But this problem of fair 
+oxyd distributions had now been set on Enigma's to-do list. It has been a 
+month of work in October to find and code a general algorithm that
+solves this quite complex problem for all upcoming levels.</div>
+
+<div class="quote">Looking back after a year has gone I notice that the level became more 
+difficult than I planned it to be. Especially the easy mode should be 
+easier to solve, the vortex is unnecessary and the difficult mode should 
+force the player to use all different patterns instead of using the easy 
+mode ones. I increased the friction within the critical southern rosette 
+and simplified the central part for the easy mode. I hope that will give 
+more players a chance to enjoy the versatility of &quot;Turnstiles for Two&quot;.</div>
+
+<div class="quote">Thanks for the good ratings, and have fun!</div>
+
+<div class="author">Ronald Lamprecht</div>
+
+<p>
+Many thanks to Ronald Lamprecht for this musical masterpiece.
+</p>
+
+<p><i>NObby</i><p>
+
+</div>

Copied: homepage/input/lotm/lotm_200804_de.html (from rev 1092, feature_branches/hp_lotm/input/lotm/lotm_200804_de.html)
===================================================================
--- feature_branches/hp_lotm/input/lotm/lotm_200804_de.html	2008-04-04 21:08:43 UTC (rev 1092)
+++ homepage/input/lotm/lotm_200804_de.html	2008-04-06 19:10:27 UTC (rev 1093)
@@ -0,0 +1,346 @@
+<div class="lotm">
+$$lotm_header$$
+
+  <h3 class="lotm">
+    <span class="date">April 2008: </span>
+    &quot;Turnstiles for Two - Rhapsody on Turnstiles in Blue and Green&quot;
+  </h3>
+
+<h4>von Ronald Lamprecht</h4>
+
+<p>Die Welt der &quot;schwarzen Kugel&quot; kennt viele Facetten: Meditationen, 
+Besuche von Tempeln und Irrg&auml;rten, Dechiffrieren, Weltraumabenteuer, 
+allein oder zu zweit, sogar mit Albtr&auml;ume sind wir gesegnet, um nur 
+einiges zu nennen. Doch wie sieht es im Bereich der Musik aus? Nicht
+so toll? Mitnichten. Zwar gibt es keinen Ohrwurm, der sich einem einfach
+erschlie&szlig;t, daf&uuml;r k&ouml;nnen wir mit einer Rhapsodie aufwarten.</p>
+
+<div class="lotmpic">
+<img src="$$imagedir$$/lotm/lotm_200804_a.png" alt="Level des Monats" border="0">
+<div class="imagetitle">Enigma VI # 77</div>
+</div>
+
+<table cellpadding="0" cellspacing="1" class="statistics">
+<caption class="normalcaption">Einige Rekorde vom Februar 2008</caption>
+<colgroup>
+   <col width="80">
+   <col width="160">
+</colgroup>
+<tr><td class="num">9:30</td>
+        <td class="left">dev0</td></tr>
+    <tr><td class="num">10:04</td>
+        <td class="left">Taztunes</td></tr>
+    <tr><td class="num">10:43</td>
+        <td class="left">Craven</td></tr>
+    <tr><td class="num">16:03</td>
+        <td class="left">ryujun</td></tr>
+    <tr><td class="num">16:36</td>
+        <td class="left">Ronald</td></tr>
+    <tr><td class="num">16:47</td>
+        <td class="left">Daisy</td></tr>
+    <tr><td class="num">21:19</td>
+        <td class="left">para_doks</td></tr>
+</table>
+
+<p></p>
+
+<table cellpadding="0" cellspacing="1" class="statistics">
+<caption class="normalcaption">Einfacher Modus</caption>
+<colgroup>
+   <col width="80">
+   <col width="160">
+</colgroup>
+    <tr><td class="num">8:11</td>
+        <td class="left">dev0</td></tr>
+    <tr><td class="num">10:40</td>
+        <td class="left">Taztunes</td></tr>
+    <tr><td class="num">12:29</td>
+        <td class="left">Ronald</td></tr>
+    <tr><td class="num">13:04</td>
+        <td class="left">ryujun</td></tr>
+    <tr><td class="num">14:46</td>
+        <td class="left">Craven</td></tr>
+    <tr><td class="num">17:47</td>
+        <td class="left">para_doks</td></tr>
+    <tr><td class="num">18:42</td>
+        <td class="left">Daisy</td></tr>
+</table>
+
+<p>
+<span class="alter">
+Sch&uuml;ler: &quot;Einer was?&quot;<br>
+Oberlehrer (<i>mit erhobenem Zeigefinger und ernster Stimme</i>): 
+&quot;Mal wieder im Musikunterricht nicht aufgepasst?&quot;<br>
+Sch&uuml;ler (<i>kleinlaut mit geneigtem Kopf, aber Augen verdrehend</i>): 
+&quot;Muss ich wohl leider vergessen haben.&quot;<br>
+Oberlehrer (<i>g&ouml;nnerhaft (wie auch sonst?), auf- und abschreitend</i>): 
+&quot;Also nochmal. Eine Rhapsodie ist ein Musikst&uuml;ck, 
+dessen Themen zueinander in einem nicht festen - somit losen - 
+Zusammenhang stehen. Des Weiteren <i>m&uuml;ssen</i> diese nicht, sondern <i>k&ouml;nnen</i> 
+vielmehr - man beachte den kleinen, aber feinen Unterschied
+(<i>Sch&uuml;ler verdreht zunehmend gelangweilt erneut die Augen</i>) - 
+aus Motiven bestehen, die wiederum nicht zueinander in Verbindung stehen 
+bzw. aufeinander basieren oder gar &hellip; &quot;.<br>
+Sch&uuml;ler (<i>hat endg&uuml;ltig abgeschaltet und murmelt vor sich hin</i>): 
+&quot;Bla, bla, bla &hellip;&quot;
+</span>
+</p>
+
+<div class="lotmpic">
+<img src="$$imagedir$$/lotm/lotm_200804_b.png" alt="Level des Monats 04/2008" border="0">
+<div class="imagetitle">Ein Solo im Duett</div>
+</div>
+
+<p><span class="alter">&quot;Oh nein. Lasst uns geschwinden Schrittes diesen Ort des 
+Grauens verlassen und uns weit angenehmeren Dingen zuwenden.&quot;</span><br>
+&quot;He, das ist mein Text! Weg hier!&quot;<br>
+<span class="alter">Aber, mir &hellip;</span><br>
+&quot;Nix aber!&quot;<br>
+&hellip;<br>
+&quot;Geschafft! Der ist weg.&quot;</p> 
+
+<p>Tja, mit den Turnstiles ist das so eine Sache. Man 
+kann sich nicht nur selbst &uuml;bers Wasser transportieren sondern auch den 
+anderen. Allerdings kann es dann passieren, dass der andere ohne Hilfe 
+nicht mehr zur&uuml;ckkommen kann.<br> 
+&quot;Naja, vielleicht hole ich ihn sp&auml;ter wieder zur&uuml;ck; denn - streicht man
+das Ges&uuml;lze - hat der gar nicht so unrecht. Der Untertitel k&ouml;nnte kaum 
+besser gew&auml;hlt sein.&quot;</p>
+
+<h4>&quot;Neben Erfahrung ist auch ein gewisses Fingerspitzengef&uuml;hl gefragt&quot;</h4>
+
+<div class="quote">Es ist schon eine Weile her, dass ich &quot;Turnstiles for Two&quot; gespielt habe. Nachdem ich mir den Level jetzt noch einmal angesehen habe, ist mir eingefallen, dass ich vor allen Dingen Schwierigkeiten hatte, beim Herumklappen der Dreharme an der richtigen Stelle zu bleiben. Das gilt besonders f&uuml;r den sehr engen Komplex in der Mitte der unteren H&auml;lfte, weil man da kaum Platz zum man&ouml;vrieren hat. Kein Wunder also, dass die Verf&uuml;gbarkeit des Pins einen gewaltigen Unterschied zwischen leichtem und schwerem Modus macht.</div>
+
+<div class="quote">Zus&auml;tzlich dazu ist vorausschauendes Planen gefragt, damit man nicht nur zu den Oxyds hin, sondern auch wieder zur&uuml;ck gelangt. Es hat bei mir da schon eine Weile gebraucht, bis ich wusste, wie ich die &quot;Inseln&quot; in der Mitte des Levels richtig einbaue.</div>
+
+<div class="quote">Die eigentliche Schwierigkeit bei &quot;Turnstiles for Two&quot; liegt aber mal wieder darin, den allerletzten Oxyd zu erwischen. Da ist neben Erfahrung auch ein gewisses Fingerspitzengef&uuml;hl gefragt, denn selbst wenn man den Trick raus hat, klappt es dennoch nicht jedes Mal. Man muss schnell genug an die richtige Stelle flitzen, um auf die Insel mit dem letzten Oxyd transportiert zu werden.</div>
+
+<div class="quote">Es gibt da &uuml;brigens noch einen anderen Level von Ronald Lamprecht (Cold Meditation), bei dem man eine &auml;hnliche Aktion machen muss, um unter den letzten Eisblock geschubst zu werden.</div>
+
+<div class="author">Craven</div>
+
+<div class="lotmpic">
+<img src="$$imagedir$$/lotm/lotm_200804_d.png" alt="Level des Monats 04/2008" border="0">
+<div class="imagetitle">
+Hmm &hellip; und jetzt?
+</div>
+</div>
+
+<p>Also schauen und h&ouml;ren wir uns an, was unsere zwei Musiker zu bieten haben. 
+Der Anfang ist noch ganz entspannt. In den ersten Akkorden gibt einer vor, 
+wo's lang geht und der andere folgt. Doch nun n&auml;hern sich unsere beiden 
+Musiker dem zentralen Motiv. Jeder w&auml;hlt dazu, mit Unterst&uuml;tzung des anderen, 
+seinen eigenen musikalischen Weg.</p> 
+
+<p>Zwei Spannungsb&ouml;gen, jeder individuell durch 
+kleinere Soli angereichert, ziehen sich hin zum zentralen Motiv. Unsere 
+beiden halten sich dort nicht lange auf, sondern stellen die anderen Motive 
+ihrer Rhapsodie vor: ein kleines Solo, ein interessantes, schmackhaftes 
+Intermezzo und nicht zuletzt der technisch schwierigste Teil ihres Vortrags, 
+eine mit Kreuzen gespickte Melodie, die von beiden Seiten h&ouml;chste Konzentration 
+und Pr&auml;zision erfordert.</p> 
+
+<h4>&quot;Ich sch&auml;tze seine Hingabe, mit
+der er neue Spielelemente in ihrem ganzen Funktionsumfang erschlie&szlig;t
+&quot;</h4>
+
+<div class="quote">Ich bin froh, dass man mich gefragt hat, einen Kommentar f&uuml;r 
+&quot;Turnstiles For Two&quot; zu schreiben, nicht nur weil ich in der Welt der 
+Musik zu Hause bin, sondern besonders weil dies unter den 
+&quot;Yin-Yang-Leveln&quot; in Enigma mein Lieblingslevel ist. Ich wei&szlig;, dass es
+Ronalds Absicht war, den Level als eine Rhapsodie anzulegen, und die
+Beschreibung hierf&uuml;r scheint passend zu sein, aber dieser Level l&auml;sst 
+etwas anderes vor meinem geistigen Auge auftauchen, das schon ein 
+gutes St&uuml;ck &auml;lter ist. Vor kurzem habe ich Bachs zweistimmige Inventionen
+wiederentdeckt, und diese stellen eine ausgezeichnete Analogie zu 
+Ronalds Sch&ouml;pfung dar.</div>
+
+<div class="quote">Bei Bach spielen beide H&auml;nde, in Wechselbeziehung zueinander stehend, 
+kontrapunktische Melodien. Jede Hand hat einen begrenzten Spielraum,
+genauso wie die wei&szlig;e und die schwarze Murmel hier strikte Beschr&auml;nkungen
+haben, was sie tun k&ouml;nnen und was nicht, und wohin sie gehen k&ouml;nnen und
+wohin nicht. Zusammen bilden die beiden Melodielinien eine harmonische
+Sequenz, w&auml;hrend sie sich unabh&auml;ngig voneinander ihren Weg durch das
+St&uuml;ck bahnen. Und wenn man es schafft, ein technisch ziemlich t&uuml;ckisches
+aber musikalisch wunderbares St&uuml;ck durchzuspielen, dann wird man im
+Schlusstakt sehr h&auml;ufig mit einem ausgesprochen zufriedenstellenden 
+Dur-Akkord belohnt.</div>
+
+<div class="quote">Ein Sache, die ich an Ronalds Leveln sehr sch&auml;tze, ist die Hingabe, mit
+der er neue Spielelemente in ihrem ganzen Funktionsumfang erschlie&szlig;t, 
+oder neue Anwendungsm&ouml;glichkeiten f&uuml;r bereits vorhandene aufzeigt.
+Dieser Level ist eine wundervolle Erkundundungsreise durch eine 
+Landschaft, in der man die verschiedenen Eigenarten der gr&uuml;nen 
+Turnstiles kennenlernt. Beinahe jede Aktion erfordert das Zusammenspiel
+der beiden Murmeln. Ronald hat au&szlig;erdem den Level dadurch schwieriger
+(aber auch unterhaltsamer) gemacht, dass er ihn so aufgebaut hat, dass
+die maximale Anzahl gleichfarbiger Oxyds bei den oberen vier ein Paar ist.</div>
+
+<div class="quote">Wie auch immer, der Spieler ist gezwungen, den R&uuml;ckweg nach oben zu
+meistern, und dann wieder nach unten zu gelangen, um das Spiel 
+erfolgreich zu beenden. Die gr&ouml;&szlig;te Schwierigkeit ist meiner Ansicht
+nach die Gruppierung von vier Oxyds mitten im Wasser im Zentrum des
+untersten Levelabschnitts - es ist hier wirklich schwierig zu vermeiden, 
+dass eine der beiden Murmeln ins Wasser f&auml;llt, und dann, kann man wieder
+ganz von vorne anfangen.</div>
+
+<div class="quote">Ein anderer, &auml;usserst reizvoller Aspekt an &quot;Turnstiles For Two&quot; ist, 
+dass der Level einfach einen prachtvollen Anblick bietet. Mit all dem 
+Wasser und den hellen T&ouml;nen hat man das Gef&uuml;hl, als sei man auf einer 
+Urlaubsreise auf den griechischen Inseln unterwegs. Gl&uuml;ckwunsch an 
+Ronald f&uuml;r solch eine erfreuliche Enigma Erfahrung!</div>
+
+<div class="author">Taztunes</div>
+
+<p>Nun da alle Motive vorgestellt sind, werden diese 
+von unseren beiden Musikern stilsicher und in bester Spiellaune aufgel&ouml;st, 
+wobei sie immer wieder zum zentralen Motiv, das sie gekonnt variieren, 
+zur&uuml;ckkehren. Wir n&auml;hern uns dem Finale, in dem einer der beiden noch einmal 
+sein K&ouml;nnen an einem seiner Instrumente zeigt. Unter dem geb&uuml;hrenden Applaus 
+des Publikums verlassen unsere beiden Musiker die B&uuml;hne. Was f&uuml;r eine tolle
+Darbietung!</p>
+
+<div class="lotmpic">
+<img src="$$imagedir$$/lotm/lotm_200804_c.png" alt="Level des Monats 04/2008" border="0">
+<div class="imagetitle">
+Endlich, das Lifekonzert: <br>&quot;The Be Sharps&quot;
+</div>
+</div>
+
+<p>Doch um die Konzertreife zu erreichen, ist einiges an &Uuml;bung n&ouml;tig, denn 
+Fehler werden unnachsichtig bestraft: Man f&auml;ngt wieder am Anfang an. 
+Unachtsamkeiten (nachlassende Konzentration oder fehlende Antizipation) an 
+strategischen Stellen wie dem zentralen Motiv wirken sich dann sp&auml;ter 
+verheerend (Shift-F3) aus.</p>
+
+<p><span class="alter">Sage ich doch immerfort:<br> Nur &Uuml;bung macht
+den Meister.</span><br>
+&quot;Ruhe da dr&uuml;ben! Und spar' dir deine abgedroschenen
+Alltagsweisheiten!&quot;</p>
+
+<p>Aber recht hat er schon. Wie oft bin ich am &quot;Kreuz&quot; unabsichtlich ins kalte Wasser 
+gesprungen? Sei's wegen mangelnder Pr&auml;zision oder weil ich - warum auch 
+immer - vergessen hatte, auf die andere Murmel umzuschalten. Also durchatmen, 
+Ruhe bewahren und nicht zu hektisch vorgehen. Die Koffeins&uuml;chtigen (so wie 
+ich) sollten zur Vorbereitung ihren Kaffeekonsum reduzieren und, um eine 
+ruhige Hand zu haben, vielleicht besser ein Glas Vin Rouge zu sich nehmen ;-).</p>
+
+<p>Einiges an Nerven kostet auch das zentrale Motiv (hier gibt's kein Bild - 
+denn zu viel soll hier nicht verraten werden). Der Einsatz der &quot;Instrumente&quot; 
+muss gut und vorausschauend geplant sein, will man sich nicht den R&uuml;ckweg 
+zu den oberen und unteren Motiven versperren. Ist ein &quot;Instrument&quot; nicht 
+richtig &quot;gestimmt&quot;, stellen sich die &uuml;blichen Konsequenzen (Shift-F3) 
+unumg&auml;nglich ein.</p>
+
+<p>Besonderen Reiz bekommt dieser Level auch durch den Einsatz einer wei&szlig;en 
+und schwarzen Murmel. So hat jede Bereiche, die nur ihr zug&auml;nglich sind, 
+aber ohne die aktive Zusammenarbeit der beiden sind diese nicht 
+erreichbar (wie z.B. beim &quot;Kreuz&quot;).</p>
+
+<p>Also Leute, rafft euch auf, stimmt eure &quot;Instrumente&quot; und legt los zur &quot;Session 
+f&uuml;r zwei&quot;.</p>
+
+<h4>&quot;Die gr&uuml;nen Turnstiles hatten sich als weitaus wertvoller
+erwiesen, als ich es jemals zu hoffen gewagt hatte&quot;</h4>
+
+<p>Als einen ganz kleinen Misston empfinde ich den Vortex, denn dieser wird 
+eigentlich nicht zwingend ben&ouml;tigt. Aber vielleicht habe ich die Komposition 
+nur noch nicht in ihrer kompletten G&auml;nze erfasst. Also werde ich einfach nochmal 
+voller Genuss in die Welt der Enigma-Kl&auml;nge eintauchen.</p>
+
+
+<div class="quote">Es mag verr&uuml;ckt klingen, aber &quot;Turnstiles for Two&quot; ist eine &quot;Auftragsarbeit&quot;.
+Im Zuge der Ver&ouml;ffentlichung von v1.00 erhielten wir Berichte &uuml;ber 
+Absturzprobleme, die scheinbar mit den Turnstiles zusammenhingen. 
+Beim Debuggen des Turnstile Codes zogen die gr&uuml;nen Turnstiles meine 
+Aufmerksamkeit an sich. Es gab bis dahin nur einen einzigen Level, der 
+Gebrauch von ihnen machte: &quot;Zig Zag&quot; - und dort kamen sie nur 
+indirekt zum Einsatz. Ich begann, die Existenzberechtigung dieser Variante
+in Frage zu stellen - mit all dem Extra-Code, den sie verursachte. Aber
+nach kurzer Zeit entdeckte ich ein erstes direkt anwendbares Muster f&uuml;r
+einen Level mit nur einer Murmel, was schlie&szlig;lich Mitte Februar 2007 
+zum Level &quot;Revolver&quot; f&uuml;hrte.</div> 
+
+<div class="quote">Aber meiner Ansicht nach musste der wahre Wert der gr&uuml;nen Turnstiles 
+erst in Multi-Murmel-Leveln erkennbar werden. Also habe ich am 
+13. M&auml;rz dazu aufgerufen, einen Einf&uuml;hrungslevel f&uuml;r gr&uuml;ne Turnstiles
+zu schreiben, der einige brauchbare Muster demonstrieren sollte. 
+Zwei Tage sp&auml;ter habe ich selbst versucht, einen solchen Level zu 
+verfassen. Nach drei Arbeitsstunden hatte ich zwei neue Level 
+fertiggestellt: &quot;Cold Meditation&quot; und &quot;Polar 
+Bear's Paradise&quot;. Am n&auml;chsten Tag hat Andreas verzweifelt bei mir
+angefragt, ob denn wirklich &quot;Cold Meditation&quot; der von mir 
+angek&uuml;ndigte Level sein solle.</div> 
+
+<div class="quote">Nat&uuml;rlich nicht! Ich hatte nur ein paar Muster gesammelt und war dabei 
+von Ideen f&uuml;r andere Level abgelenkt worden. Aber nun hatte ich eine 
+Idee f&uuml;r ein Arrangement verschiedener Muster, und mit jedem Muster,
+das ich zum Level hinzuf&uuml;gte, ergaben sich wieder neue Muster mit den 
+gr&uuml;nen Turnstiles. Zwei unterhaltsame Abend-Sessions sp&auml;ter - in den 
+fr&uuml;hen Morgenstunden des 17. M&auml;rz - war &quot;Turnstiles for Two&quot; 
+dann so weit f&uuml;r den ersten Versand. Die gr&uuml;nen Turnstiles hatten sich 
+als weitaus wertvoller erwiesen, als ich es jemals zu hoffen gewagt hatte!</div> 
+
+<div class="lotmpic">
+<img src="$$imagedir$$/lotm/lotm_200804_e.png" alt="Level des Monats 04/2008" border="0">
+<div class="imagetitle">
+Eine Wippe f&uuml;r Kinder und <br> Erwachsene in (fast) jedem Alter
+</div>
+</div>
+
+<div class="quote">Auf der Suche nach Inspirationen unterbrach ich an beiden Abenden meine 
+Arbeit. Beide Male setzte ich mich ans Klavier und begann aus dem Kopf 
+eines meiner Lieblingsst&uuml;cke zu spielen: Gershwins &quot;Rhapsodie In Blue&quot;.
+Es hat einfacht gepasst - die verschiedenen voneinander unabh&auml;ngigen 
+Muster zu einem gemeinsamen Thema, miteinander verbunden in einem 
+umfassenden Rahmen, schwarz und wei&szlig;, und zus&auml;tzlich Gef&uuml;hle
+wie Sehnsucht und Unbestimmtheit. In der Tat hat Gershwin sein St&uuml;ck zuerst &quot;Nocturne in Blue and Green&quot;genannt, wobei die Farben f&uuml;r die Gef&uuml;hle stehen. Da die gr&uuml;nen 
+Turnstiles der haupts&auml;chliche Anlass f&uuml;r den Level gewesen waren, 
+brauchte ich nur noch den Untertitel &quot;Rhapsody On Turnstiles In Blue And Green&quot;.
+hinzuzuf&uuml;gen.</div> 
+
+
+<div class="quote">Bereits mehrere Male haben einige User ihre Verwunderung zum Ausdruck
+gebracht &uuml;ber den Zeitrahmen, in dem ich einige meiner besten Level
+verfasst habe. Aber so ist nun einmal die Natur der Kreativit&auml;t. Man 
+verbringt unz&auml;hlige Stunden damit, Enigma zu spielen und weiterzuentwickeln,
+und auf einmal hat man die Idee f&uuml;r einen Level. BTW hat Gershwin seine 
+Rhapsodie in nur 24 Tagen und N&auml;chten komponiert! Aber er hat die Niederschrift
+seiner eigenen Klavierpartitur erst Monate nach der Weltpremiere fertig gestellt.</div> 
+
+<div class="quote">Genauso war auch &quot;Turnstiles for Two&quot; nicht nach zwei Abenden
+vollendet. Ich entdeckte einen feinen Punkt, f&uuml;r den ich zun&auml;chst keine 
+Patentrezept parat hatte: eine faire und auch l&ouml;sbare Verteilung der 
+Oxydfarben. Die Farbverteilung einfach per Zufallsgenerator vorzunehmen
+funktioniert nicht. Wenn z.B. alle oberen Oxyds miteinander Paare bilden,
+gibt es keinen Grund nach der Untersuchung des unteren Teils sp&auml;ter noch
+einmal zum oberen Teil zur&uuml;ckzukehren. Aber es ist nun einmal ein
+wesentlicher Punkt an dem Level, dass man zum oberen Teil zur&uuml;ckkehren
+MUSS nach der Untersuchung des unteren Teils. Schlie&szlig;lich habe 
+ich eine kleine Spezialfunktion geschrieben, die in angemessener Weise 
+Einfluss auf die Farbverteilung an die Oxyds nimmt. Aber dieses Problem
+fairer Oxydverteilung wurde daraufhin auf Enigmas Todo Liste gesetzt. 
+Es hat den ganzen Monat Oktober in Anspruch genommen, einen generellen
+Algorithmus zu finden und zu programmieren, der dieses ziemlich komplexe
+Problem auch f&uuml;r alle zuk&uuml;nftigen Level l&ouml;st.</div> 
+
+<div class="quote">Wenn ich jetzt, nachdem ein Jahr vergangen ist, auf den Level zur&uuml;ckblicke,
+f&auml;llt mir auf, dass er doch etwas schwieriger geraten ist, als ich das 
+urspr&uuml;nglich geplant hatte. Besonders der Einfache Modus sollte einfacher
+zu l&ouml;sen sein, der Vortex ist nicht notwendig und im Schwierigen Modus sollte
+der Spieler gezwungen sein, ALLE verschiedenen Muster zu verwenden anstatt
+nur diejenigen auch im Einfachen Modus erforderlichen. Ich habe die Reibung 
+innerhalb des kritischen Bereichs der s&uuml;dlichen Rosette erh&ouml;ht, und den 
+mittleren Abschnitt f&uuml;r den Einfachen Modus vereinfacht. Ich hoffe, dass
+gibt mehr Spielern die Chance, an der Vielseitigkeit der &quot;Turnstiles for Two&quot; 
+Gefallen zu finden.</div> 
+
+<div class="quote">Vielen Dank f&uuml;r die guten Bewertungen, und viel Spass beim Spielen!</div> 
+
+<div class="author">Ronald Lamprecht</div> 
+
+<p>Vielen Dank an Ronald Lamprecht f&uuml;r dieses musikalische Meisterwerk.</p>
+
+<p><i>NObby</i></p>
+
+</div>

Copied: homepage/input/lotm/lotm_200804_ru.html (from rev 1092, feature_branches/hp_lotm/input/lotm/lotm_200804_ru.html)
===================================================================
--- feature_branches/hp_lotm/input/lotm/lotm_200804_ru.html	2008-04-04 21:08:43 UTC (rev 1092)
+++ homepage/input/lotm/lotm_200804_ru.html	2008-04-06 19:10:27 UTC (rev 1093)
@@ -0,0 +1,288 @@
+<div class="lotm">
+$$lotm_header$$
+
+  <h3 class="lotm">
+    <span class="date">?????? 2008: </span>
+    &quot;Turnstiles for Two - Rhapsody on Turnstiles in Blue and Green&quot;
+  </h3>
+
+<h4>?? Ronald Lamprecht</h4>
+
+<p>
+??? &quot;??????? ??????&quot; ???????????: ?????, ?????????, ????????? ?????? ?
+??????????, ???????????, ??????????? ???????????, ? ???????? ??? ??????, ????????
+?? ???? ?????????? ??????? ?????????. ? ??? ?????? ???? ??????? ????????????? ?????? ???.
+??, ???? ???? ????? ???? ?? ???????? ?????????? ???????, ????? ????????? ????????.
+</p>
+
+<div class="lotmpic">
+<img src="$$imagedir$$/lotm/lotm_200804_a.png" alt="of the Month" border="0">
+<div class="imagetitle">Enigma VI # 77</div>
+</div>
+
+<table cellpadding="0" cellspacing="1" class="statistics">
+<caption class="normalcaption">????????? ???????? ??????? 2008</caption>
+<colgroup>
+   <col width="80">
+   <col width="160">
+</colgroup>
+<tr><td class="num">9:30</td>
+        <td class="left">dev0</td></tr>
+    <tr><td class="num">10:04</td>
+        <td class="left">Taztunes</td></tr>
+    <tr><td class="num">10:43</td>
+        <td class="left">Craven</td></tr>
+    <tr><td class="num">16:03</td>
+        <td class="left">ryujun</td></tr>
+    <tr><td class="num">16:36</td>
+        <td class="left">Ronald</td></tr>
+    <tr><td class="num">16:47</td>
+        <td class="left">Daisy</td></tr>
+    <tr><td class="num">21:19</td>
+        <td class="left">para_doks</td></tr>
+</table>
+
+<p></p>
+
+<table cellpadding="0" cellspacing="1" class="statistics">
+<caption class="normalcaption">?????????? ?????</caption>
+<colgroup>
+   <col width="80">
+   <col width="160">
+</colgroup>
+    <tr><td class="num">8:11</td>
+        <td class="left">dev0</td></tr>
+    <tr><td class="num">10:40</td>
+        <td class="left">Taztunes</td></tr>
+    <tr><td class="num">12:29</td>
+        <td class="left">Ronald</td></tr>
+    <tr><td class="num">13:04</td>
+        <td class="left">ryujun</td></tr>
+    <tr><td class="num">14:46</td>
+        <td class="left">Craven</td></tr>
+    <tr><td class="num">17:47</td>
+        <td class="left">para_doks</td></tr>
+    <tr><td class="num">18:42</td>
+        <td class="left">Daisy</td></tr>
+</table>
+
+
+<p>
+<span class="alter">
+??????: &quot;????&quot;<br>
+??????? <i>(???????, ???????? ?????? ?????)</i>:
+&quot;????? ?? ???????? ???????? ????? ???????&quot;<br>
+?????? <i>(????? ??????? ?????? ? ?????? ?????)</i>: &quot;?????,
+? ?? ????? ??? ?????????.&quot;<br>
+??????? <i>(?????????? (? ??? ?????), ????? ????-????)</i>:
+&quot;????? ??????, ?????? ?????. ???????? - ??? ??????????? ????????????
+? ??????, ??????? ??????????? ?? ??????, ? ????????. ????? ???? ???, ?????????????, ??
+???????? ????? &mdash;? ??????????, ?? ???????? ?????????? <i>(?????? ????? ??????? ?????,
+?????? ??? ??????)</i>&mdash;????? ???? ?????????? ?? ??????????? ?? ????????? ???? ? ??????,
+??? ???? ?????????? ???? ?? ????? 
+&hellip;&quot;<br>
+?????? <i>(???????????? ??????????? ? ???? ??????, ?????? ??? ????)</i>: &quot;???, ???
+???&hellip;&quot;
+</span>
+</p>
+
+<div class="lotmpic">
+<img src="$$imagedir$$/lotm/lotm_200804_b.png" alt="Level des Monats 04/2008" border="0">
+<div class="imagetitle">???? ??????</div>
+</div>
+
+<p>
+<span class="alter">
+? ???! ??????? ?????? ??????? ??? ??????? ????? ? ???????? ? ????? ???????? ?????.
+</span>
+??, ??? ??? ?????. ????? ??????.<br>
+<span class="alter">?? ?&hellip;</span><br>
+??????? &quot;??&quot;.<br>
+&hellip;<br>
+??????, ?? ????.
+</p>
+
+<p>?????, ????????? &hellip; ??? ??????? ???????. ???? ?? ?? ??????
+????????? ????, ?? ?????? ????? ?????. ??????, ????? ???????? ???, ??? ??
+?? ?????? ????????? ??? ???????????? ??????. <br>
+?? ????? ????, ????? ???? ? ????? ??? ?????; ? ????? ??????, ???? ?????? ????????, ??? ????????? ?? ?????.
+????????? ???????? ???????.
+</p>
+
+<h4>&quot;????? ????? ???, ??????????, ? ?????? ?????????&quot;</h4>
+
+<div class="quote">? ??? ???????? ????? ????? ? &quot;Turnstiles for Two&quot;. ?? ??????, ????? ? ??? ??? ????????????
+???????????? ? ??????, ? ????????, ??? ????? ??????? ????????? ??? ???? ???? ?????????? ?? ?????, ????? ??????? ??????
+?? ??????????. ???????? ??? ???????? ? ????????? ??????? ?????? ?????, ??? ? ??? ?? ??????? ???????????? ???
+???????. ??? ?????? ????????????? ? ???, ??? ??????????? ?????? ??? ?????? ???????? ?????????? ? ??????? ??????.</div>
+
+<div class="quote">???????? ?????? ???? ??????????????? ????????????! ?? ??????, ??? ?????? ??????? ? ???????, ?? ? ??? ???????? ?? ???. ??? ???????????? ?? ??? ????? ???????, ????? ?????? ??? ????????? ??? &quot;???????&quot; ? ????? ?????
+????? ????????????.</div> 
+
+<div class="quote">?? ????????? ?????????? ? &quot;Turnstiles for Two&quot; - ????? - ???? ????????? ? ?????????? ??????. ????? ????? ???, ??????????, ? ?????? ?????????: ???? ?? ?????? ??? ??? ???????, ?????? ??? ???-?? ?? ??????????. ???
+????? ???????? ?? ??????????? ????? ??? ????? ???????, ????? ????? ?? ????????? ?? ??????? ? ????????? ???????.</div>
+
+<div class="quote">??????, ???? ??? ???? ??????? ?? Ronald Lamprecht (&quot;Cold Meditation&quot;), ??? ??? ?????
+????????? ????????, ????? ????????? ? ????????? ????? ????.</div>
+
+<div class="author">Craven</div>
+
+<div class="lotmpic">
+<img src="$$imagedir$$/lotm/lotm_200804_d.png" alt="Level des Monats 04/2008" border="0">
+<div class="imagetitle">
+??? &hellip; ? ???????
+</div>
+</div>
+
+<p>
+????, ??????? ????????? ? ?????????, ??? ??? ????? ?????????? ??? ????? ?????????. ?????? ???????? ?????????????.
+? ?????? ?????, ???? ?????? ???????, ? ?????? ???????????. ?? ??? ???? ????????? ??????? ? ???????????? ??????????.
+??????, ??? ????????? ???????, ???????? ???? ??????????? ??????????? ?????. ??? ???????? ??????,
+?? ??????????? ??????????? ???????? ????, ?????? ???????? ???????? ?????????. ??? ????? ?????? ?? ????????? ?????
+???????, ? ??????? ?????????? ???? ?? ????????: ???????? ????, ?????????? ? ??????? ?????????? ? ??????? ?? ?????
+??????????? ??????????? ????? ?? ???????? - ??????? ????????????? ??????? ??????? ?????, ??????? ??????? ???????????? ?
+???????????? ?? ????? ??????.
+</p>
+
+<h4>&quot;? ??????? ??? ??????????? ???????? ??????? ???????????? ????? ????????? ? ????&quot;</h4>
+
+<div class="quote">? ???, ??? ???? ????????? ????????????????? &quot;Turnstiles for Two&quot; ?? ?????? ??????,
+??? ?????? ???????? ???????????? ????? ? ???? ?????, ?? ? ??????, ??? ??? ????????????? ??? ????? ???????
+&quot;????????? ???????&quot; ? Enigma. ? ????, ??? Ronald ??????? ??? ??? ????????
+? ??????????? ??????? ??????????, ?? ???? ??????? ???????? ??? ???-?? ??????? ????? ??????. ???????, ?
+???????????? ???????????? ???????? ???? ? ????? ???????? ? ???, ??? ?????? Ronald.</div>
+
+<div class="quote">? ???? ?????????????? ??????? ???????? ????? ?????? - ?????? ???? ?????????? ????? ??????????,
+???? ? ???? ??? ? ? ?????? ? ??????? ?????? ???? ??????????? ?? ??, ??? ??? ????? ?????? ? ??? ???, ??? ??? ????? 
+??????????, ? ??? ???. ?????? ??? ?????????? ????? ??????? ??????????? ?????????, ?????? ??? ??? ?????????? ???? ?? ????? ???? ?? ?????? ????. ? ???? ?? ??????? ???????? ?? ?????? ??????? ?????????? ?????????????, ?? ???????????? ??????,
+?? ????????? ?????? ??? ????? ????? ????????? ??????? ??????.</div>
+
+<div class="quote">???? ?? ?????, ??????? ? ??????? ? ??????? Ronald'?, ??? ??? ??????????? ???????? ???????
+???????????? ????? ????????? ? ???? ??? ????? ????? ???????? ?? ??????????. ???? ??????? ????????????? ???????????? 
+??????? ??????? ??????????. ????? ?????? ???????? ???????, ????? ??? ?????? ???????? ??????.
+????? Ronald ?????? ??????? ????? ??????? (? ?????????????) ???????? ??????? ???, ??? ?? ??????? ??????? ???????
+???????????? ????? ??????????? ?? ?????  - ???? ????.</div>
+
+<div class="quote">?? ????? ????????, ??? ?? ??????????? ??????; ????? ????????? ??????? ?? ?????? ????????? ??????? ?????? ? ????? ????? ??????????. ????? ??????? ?????????? ??? ???? ???? ?????? ?? 4 ??????? ? ???? ? ?????? ??????
+????? ?????? - ????????????? ?????? ???????? ?????? ???? ??? ????? ?????, ? ????? ????? ?? ?????? ?????? ??? ???????.</div>
+
+<div class="quote">??? ???? ????? ???????????? ?????? &quot;Turnstiles for Two&quot; ??? ??, ??? ?? ??????? ??????? ?????????. ?? ??????, ? ???????, ???????? ? ??????? ?? ???????? ?????? ????????? ?????? ????? ? ????? ??????? ?????.
+??? ???????????? Ronald'? ?? ????? ???????? ???? ? Enigma!</div>
+
+<div class="author">Taztunes</div>
+
+<p>
+??????, ????? ???????????? ??? ??????, ??? ????? ????????? ???? ??????? ????????????? ??????. ??? ????? ????????????
+? ???????????? ??????, ????????? ??? ???????. ?? ??????? ? ?????, ??? ???? ?? ??? ????? ????????????? ??????????
+???? ?? ????? ???????????. ??? ?????? ??? ???????? ?????, ??????? ??????? ???? ????? ?????????? ?????? ????????????? ??????????????. ????? ?????????????? ???!
+</p>
+
+<div class="lotmpic">
+<img src="$$imagedir$$/lotm/lotm_200804_c.png" alt="Level des Monats 04/2008" border="0">
+<div class="imagetitle">
+?????????? ?????: &quot;?? ????&quot;
+</div>
+</div>
+
+<p>
+?? ????? ??????? ??????????? ??????, ????? ????? ??????????????, ?????? ??? ?????? ?????? ????????????:
+????? ???????? ? ?????? ??????. ??????????? (?????? ???????????? ??? ????????) ? ?????? ??????,
+????????? ???????????? ??????, ????????? ??????????? ?????? (Shift-F3).
+</p>
+
+<p>
+<span class="alter">? ?????? ???????,<br> ??? ???????? ??????????????.</span><br>
+&quot;?? ??! ??????! ????????? ???? ?????????? ???????????.&quot;</p>
+
+<p>??? ?? ?? ????. ??? ????? ? ????????????? ???????? ? ???????? ???? ?????? '?????'? ???? ??? ??-?? ?????????????
+???????????? ??? ?????? ??? ? ??????? ????????????? ?? ?????? ????? - ??? ?????. ????: ????????????,
+?????????? ??????????? ? ?? ??????? ???????????? ?????????. ??? ???????? ????? ??? (????? ??? ?) ?????? ?????????????
+??????? ???? ??????????? ????. ? ????? ?????? ????, ????? ???????????? ????? ???????? ???? ;-).
+</p>
+
+<p>
+????? ???? ????? ?????? ????????? ??????????? ????? (?? ????????? ?????, ?????? ??? ?? ?? ????? ????? ??????? ????????).
+??? '????? ???????????' ?????? ???? ?????? ??????????? ? ??????????????????, ???? ?? ?? ?????? ?????????? ???? ????????
+???? ? ??????? ? ?????? ???????. ???? '??????????' ??????????? '????????', ????????? ????????? ?????????? (Shift-F3).
+</p>
+
+<p>
+??????? ????? ??????????????, ????????? ????????????? ?????? ? ??????? ???????. ? ??????? ?? ??? ???? ???????, ??
+????????? ?? ?????, ? ????????? ?????? ??????? ??????, ????? ?????? ? ??? (??? ???????? '????').
+</p>
+
+<p>
+? ??????, ??????, ????????? ???? '???????????' ? ????????????? ? ????????? ?????? ?????.
+</p>
+
+<h4>&quot;???????? ????????? ??????? ???? ????? ???? ????? ????????, ??? ? ??? ????????&quot;</h4>
+
+<p>
+? ???????? ?????????? ?????????? ???????? ?? ????????? ?????????; ?????? ?? ??????????? ??? ????????????.
+?? ????? ???? ? ?? ?? ????? ????? ???? ??? ?????. ??????? ? ? ??????? ????????????? ?????? ??????????? ??????? ? ???
+?????? Enigma.
+</p>
+
+<div class="quote">???????? ??? ?????? ????, ?? &quot;Turnstiles for Two&quot; ??? ??????????? ??????.
+????? ??????? 1.00 ?? ???????? ????????? ? ??????????? ??????? ? ??????? ? ???????????.
+? ???????? ??????? ??? ???????? ??????? ??? ??????? ??????????. ?? ????????????? ?????? ? ????? ??????
+- &quot;Zig Zag&quot; ? ???? ??? ?? ????????????? ?? ????????. ? ????? ?????? ??????? ???? ????????????? ?? ???? ??????????? ????????????? ?????. ? ???? ????? ? ????? ?????? ???????????????? ????????????? ????? ??????? ?
+?????? ??? ?????? ??????, ??????? ? ???????? ??????? 2007-?? ???? ??????????? ? &quot;Revolver&quot;.</div>
+ 
+<div class="quote">?? ? ??????????? ???????? ????????? ???????? ??????? ?????????? ? ??????? ??? ?????????? ???????.
+??????? 13 ????? ? ???????, ??? ?? ?????? ???????? ??????? ??????? ??? ??????? ??????????, ??????? ?????? 
+??????????????? ????????? ???????? ????????. ?????? ??? ??? ? ?????????? ???????? ???? ???????. ????? ???? ?????
+?????? ? ???????? ??? ????? ??????: &quot;Cold Meditation&quot; ? &quot;Polar Bear's Paradise&quot;.
+?? ????????? ???? Andreas ?????????? ??????? ?? &quot;Cold Meditation&quot; ?? ????? ?????????? ???????????????? ???????.</div>
+
+<div class="quote">??????? ???! ? ?????? ?????? ?????? ????????? ????????? ? ???????? ?? ????????? ???? ???????.
+?? ?????? ? ???? ???????? ???? ?????????? ???????? ? ? ?????? ???????? ???????? ?????????, ??????? ? ???????? ?
+??????? ??? ? ?????? ???????? ??? ????. ????? ???? ???????? ??????? &quot;Turnstiles for Two&quot; ??? ?????
+? ?????? ?? ???? ????? 17-?? ?????. ???????? ????????? ??????? ???? ????? ???? ????? ????????, ??? ? ??? ????????.</div>
+
+<div class="lotmpic">
+<img src="$$imagedir$$/lotm/lotm_200804_e.png" alt="Level des Monats 04/2008" border="0">
+<div class="imagetitle">
+?????? ??? ????? ? ???????? <br>(?????) ?????? ????????
+</div>
+</div>
+
+<div class="quote">??? ?????? ? ???????? ???? ?????? ? ??????? ???????????. ?
+??????? ?? ??????? ? ?????? ??? ??????? ?????? ?? ?????? ???? ?? ???? ??????? ????????????
+- &quot;???????? ????????&quot; ????????. ??? ????????? - 
+????????? ??????????? ??????? ???? ??????? ? ??????? ???????? ?????-????? ???? ? ?????????????? ??????, ????? ???
+???????? ? ???????????????. ?? ????? ???? ??????? ??????? ?????? ???? ???????????? &quot;??????? ? ??????? ? ??????? ?????&quot;, ?????????? ??? ??????. ??? ??? ???????? ????? ????? ?????? ???? ??????? ?????????, ?? ? ?????? ?????? ???
+&quot;Rhapsody on turnstiles in blue and green&quot;.
+</div>
+
+<div class="quote">???????????? ???????????? ?????????? ????????, ?? ??????? ? ??????? ????????? ?? ???? ?????? ???????.
+?? ?????? ? ???? ? ??????????? ??????? ??????????. ?? ????????? ????????? ????? ????? ? ???????????? Enigma  ? 
+????? ? ???? ?????????? ??????? ??? ??????. ?????? ??????? ??????? ???? ???????? ?? 24 ??? ? ????!
+?? ???? ??????? ?????? ?? ??????? ?? ????? ?? ???????????? ?????? ?????? ????? ??????? ????????.</div>
+
+<div class="quote">? ????? ?????? &quot;Turnstiles for Two&quot; ?? ??? ???????? ?? ??? ??????. ? ?????????
+???? ?????????? ??????, ??????? ??????? ?? ???? ??? ????????? - ??????? ????????? ????????????? ???????.
+??????? ????????????? ???? 16-?? ??????? ?? ?????????. ????????, ???? ??? ??????? ?????? ???????? ????,
+?? ???????????? ????? ???????????? ? ??????? ?????. ?? ???????? ?????? ?????? ? ???, ????? ?? ?????????
+? ??????? ????? ????? ???????????? ??????. ? ?????, ? ??????? ????????? ??????????? ??????? ??? Lua, ???????
+???????????? ?????? ? ???????????? ???????. ?? ??? ???????? ???????? ?????????? ????????????? ??????? ?????? ???? 
+????????? ? ?????? ????, ??? ???? ??????? ? Enigma. ? ??????? ?? ??, ????? ????????? ? ????????????????? ????????,
+??????? ????? ?? ??? ???????? ??????? ???????? ??? ????????? ???????, ???? ????? ????? ??????.</div>
+
+<div class="quote">?????? ???, ??????????? ????? ? ???????, ??? ??????? ???? ???????, ??? ? ??? ?????????.
+???????? ????? ????????, ??? ?????????? ????? ?????? ??? ???????? ?????, ??????? ?? ?????, ? ??????? ?????
+?????? ??? ????????? ?????? ???????????? ????? ?????? ??????? ? ??????? ?? ??????????? ??????.
+?????? ????? ???????? ? ???????? ?????? ? ???????? ??????????? ????? ? ?????????? ??????. ? ???????, ??? ???
+?????? ??????? ???? ??????????? ?????????????? &quot;Turnstiles for Two&quot;.</div>
+
+<div class="quote">??????? ?? ??????? ?????? ? ???????? ???????????????????!</div>
+
+<div class="author">Ronald Lamprecht</div>
+
+<p>
+??????? ??????? Ronald Lamprecht ?? ???? ??????????? ??????.
+</p>
+
+<p><i>NObby</i><p>
+
+</div>

Modified: homepage/input/lotm/lotm_archive_data.lua
===================================================================
--- homepage/input/lotm/lotm_archive_data.lua	2008-04-04 21:08:43 UTC (rev 1092)
+++ homepage/input/lotm/lotm_archive_data.lua	2008-04-06 19:10:27 UTC (rev 1093)
@@ -112,6 +112,15 @@
   position_num   = "5045"
 }
 
+lotm_archive_data[13] = {
+  date           = { month = 4, year = 2008 },
+  chronological  = 13,
+  name           = "Turnstiles for Two",
+  author         = "Ronald Lamprecht",
+  position       = "VI/77",
+  position_num   = "6077"
+}
+
 -- LotM variable data
 -- format: Level Title, current_rating, current_votes, additional text
 
@@ -126,11 +135,12 @@
 lotm_rating(      "Big Adventures",  8.39,  23,  "")
 lotm_rating(      "Temple of Gold",  9.17,   6,  "")
 lotm_rating(      "Puzzle Puzzles",  8.83,   6,  "")
-lotm_rating(      "Psycho Pushing",  8.38,   8,  "<b>(newcomer)</b>")
+lotm_rating(      "Psycho Pushing",  8.38,   8,  "")
+lotm_rating(  "Turnstiles for Two",  9.00,   5,  "<b>(newcomer)</b>")
 
 -- Don't forget to adjust the archive dates:
 
-lotm_archive_data_from = { month = 1, year = 2008 }
+lotm_archive_data_from = { month = 2, year = 2008 }
 
 lotm_current = lotm_archive_data[table.getn(lotm_archive_data)]
 



From andreasl at mail.berlios.de  Sun Apr  6 21:21:50 2008
From: andreasl at mail.berlios.de (andreasl at mail.berlios.de)
Date: Sun, 6 Apr 2008 21:21:50 +0200
Subject: [Enigma-game-svn] r1094 - in feature_branches/hp_lotm:
	images/articles input input/articles input/lotm
Message-ID: <200804061921.m36JLo77011604@sheep.berlios.de>

Author: andreasl
Date: 2008-04-06 21:21:37 +0200 (Sun, 06 Apr 2008)
New Revision: 1094

Added:
   feature_branches/hp_lotm/images/articles/april_2008.png
   feature_branches/hp_lotm/images/articles/april_2008_a.png
   feature_branches/hp_lotm/images/articles/april_2008_b.png
   feature_branches/hp_lotm/images/articles/april_2008_c.png
   feature_branches/hp_lotm/images/articles/april_2008_d.png
   feature_branches/hp_lotm/input/articles/april_2008.html
   feature_branches/hp_lotm/input/articles/april_2008_de.html
Modified:
   feature_branches/hp_lotm/input/infobox.html
   feature_branches/hp_lotm/input/infobox_de.html
   feature_branches/hp_lotm/input/infobox_ru.html
   feature_branches/hp_lotm/input/lotm/lotm_200804.html
   feature_branches/hp_lotm/input/lotm/lotm_200804_de.html
   feature_branches/hp_lotm/input/lotm/lotm_200804_ru.html
   feature_branches/hp_lotm/input/output-files.lua
   feature_branches/hp_lotm/input/stat-other.html
   feature_branches/hp_lotm/input/table-hcp.html
   feature_branches/hp_lotm/input/table-rat.html
   feature_branches/hp_lotm/input/table-solved.html
   feature_branches/hp_lotm/input/table-wr.html
   feature_branches/hp_lotm/input/userlist.html
Log:
LotM Feature branch:
 - Merged homepage back to feature branch,
   they are now synchronous.


Copied: feature_branches/hp_lotm/images/articles/april_2008.png (from rev 1093, homepage/images/articles/april_2008.png)

Copied: feature_branches/hp_lotm/images/articles/april_2008_a.png (from rev 1093, homepage/images/articles/april_2008_a.png)

Copied: feature_branches/hp_lotm/images/articles/april_2008_b.png (from rev 1093, homepage/images/articles/april_2008_b.png)

Copied: feature_branches/hp_lotm/images/articles/april_2008_c.png (from rev 1093, homepage/images/articles/april_2008_c.png)

Copied: feature_branches/hp_lotm/images/articles/april_2008_d.png (from rev 1093, homepage/images/articles/april_2008_d.png)

Copied: feature_branches/hp_lotm/input/articles/april_2008.html (from rev 1093, homepage/input/articles/april_2008.html)

Copied: feature_branches/hp_lotm/input/articles/april_2008_de.html (from rev 1093, homepage/input/articles/april_2008_de.html)

Modified: feature_branches/hp_lotm/input/infobox.html
===================================================================
--- feature_branches/hp_lotm/input/infobox.html	2008-04-06 19:10:27 UTC (rev 1093)
+++ feature_branches/hp_lotm/input/infobox.html	2008-04-06 19:21:37 UTC (rev 1094)
@@ -4,12 +4,22 @@
          In 2 out of 3 statistics, Enigma jumped the 500.000 downloads mark on
          the Berlios server. This includes downloads from 0.92 up to 1.01.
          Thanks to all players who made this possible!
+         
          <h3>Level of the Month</h3>
          <a href="$$lotm_current$$"><img src="$$lotm_current_image$$"
          alt="$$lotm_expansion$$" border="0"></a>
          <div class="imagetitle">
            <a href="$$lotm_current$$">&quot;$$lotm_current_name$$&quot;</a>
          </div>
+
+         <h3>April Fool's Day '08</h3>
+         <a href="$$april_2008$$"><img src="$$imagedir$$/articles/april_2008.png"
+         alt="$$lotm_expansion$$" border="0"></a>
+         <div class="imagetitle">
+           <a href="$$april_2008$$">&quot;The Three Clouds&quot;</a>
+         </div>
+         
+         <!--
          <h3>End-of-Year Awards</h3>
          <a href="$$eoya_2007$$"><img src="images/articles/eoya_2007.png"
          alt="Which might be the Level of the Year?" border="0"></a>
@@ -18,6 +28,8 @@
            has been determined - find out who got the awards
            <a href="$$eoya_2007$$">here</a>!
          </div>
+         -->
+         
          <h3>PAR and Hcp Recalibration</h3>
 	 Due to the increasing number of score submitters we are now able to
 	 base the PAR value mainly on given scores. The effect of users who
@@ -25,6 +37,7 @@
 	 PAR values should be more realistic. As a sideeffect the HCP values
 	 did increase more or less for most users as you can see on the
 	 <a href="$$statistics$$">statistics</a> page.
+         
          <h3>Contribution</h3>
          Writing Levels, Translation, Bug Reports, Application Coding.<br>
 	 We need your help. See <a href="$$development$$">Development</a>.

Modified: feature_branches/hp_lotm/input/infobox_de.html
===================================================================
--- feature_branches/hp_lotm/input/infobox_de.html	2008-04-06 19:10:27 UTC (rev 1093)
+++ feature_branches/hp_lotm/input/infobox_de.html	2008-04-06 19:21:37 UTC (rev 1094)
@@ -5,12 +5,22 @@
          500.000-Download-Marke auf dem Berlios-Server &uuml;bersprungen.
          Dies umfasst Downloads von 0.92 bis 1.01. Vielen Dank an alle Spieler,
          die dies m&ouml;glich gemacht haben!
+
          <h3>Level des Monats</h3>
          <a href="$$lotm_current$$"><img src="$$lotm_current_image$$"
          alt="$$lotm_expansion$$" border="0"></a>
          <div class="imagetitle">
            <a href="$$lotm_current$$">&quot;$$lotm_current_name$$&quot;</a>
          </div>
+
+         <h3>Aprilscherz '08</h3>
+         <a href="$$april_2008$$"><img src="$$imagedir$$/articles/april_2008.png"
+         alt="$$lotm_expansion$$" border="0"></a>
+         <div class="imagetitle">
+           <a href="$$april_2008$$">&quot;The Three Clouds&quot;</a>
+         </div>
+         
+         <!--
          <h3>Jahresend-<br>auszeichnungen</h3>
          <a href="$$eoya_2007$$"><img src="images/articles/eoya_2007.png"
          alt="Welches mag der Level des Jahres sein?" border="0"></a>
@@ -19,6 +29,8 @@
            Jahres 2007 steht fest - finden Sie <a href="$$eoya_2007$$">hier</a>
            raus, wer die Preise gewonnen hat!
          </div>
+         -->
+
          <h3>PAR und Hcp Recalibration</h3>
 	 Aufgrund der gestiegenen Anzahl an Einsendungen von Ergebnissen
 	 k&ouml;nnen die PAR Werte nun haups&auml;chlich auf den Spielresultaten
@@ -27,6 +39,7 @@
 	 daher realistischer sein. Als Seiteneffekt sind die HCP Werte f&uuml;r
 	 fast alle Spieler gestiegen wie man auf der <a href="$$statistics$$">
 	 Statistikseite</a> sehen kann.
+
          <h3>Unterst&uuml;tzung</h3>
          Level schreiben, &Uuml;bersetzen, Fehlermeldungen, Coden.<br>
 	 Wir brauchen Ihre Hilfe. Siehe <a href="$$development$$">Entwicklung</a>.

Modified: feature_branches/hp_lotm/input/infobox_ru.html
===================================================================
--- feature_branches/hp_lotm/input/infobox_ru.html	2008-04-06 19:10:27 UTC (rev 1093)
+++ feature_branches/hp_lotm/input/infobox_ru.html	2008-04-06 19:21:37 UTC (rev 1094)
@@ -4,18 +4,30 @@
          ? 2 ?? 3 ?????????????? ???????, Enigma ???????? ??????? ? 500.000 ???????? ?
          ??????? Berlios. ? ??? ?????? ???????? ? ?????? 0.92 ?? 1.01.
          ??????? ???? ???????, ??????? ??????? ??? ?????????!
+
          <h3>??????? ??????</h3>
          <a href="$$lotm_current$$"><img src="$$lotm_current_image$$"
          alt="$$lotm_expansion$$" border="0"></a>
          <div class="imagetitle">
            <a href="$$lotm_current$$">&quot;$$lotm_current_name$$&quot;</a>
          </div>
+
+         <h3>April Fool's Day '08</h3>
+         <a href="$$april_2008$$"><img src="$$imagedir$$/articles/april_2008.png"
+         alt="$$lotm_expansion$$" border="0"></a>
+         <div class="imagetitle">
+           <a href="$$april_2008$$">&quot;The Three Clouds&quot;</a>
+         </div>
+         
+         <!--
          <h3>??????? ????? ????</h3>
          <a href="$$eoya_2007$$"><img src="images/articles/eoya_2007.png"
          alt="????? ????? ???? ??????? ?????" border="0"></a>
          <div class="imagetitle">
            ?????? ?????? 2007 ???????, ? ??????? ???? 2007 ????????? - ??????? ??? ??????? ??????? <a href="$$eoya_2007$$">?????</a>!
          </div>
+         -->
+
          <h3>???????????? PAR ? Hcp</h3>
 	 ?? ????????? ????????? ????? ??????????? ???????????, ?? ??????
 	 ????? ?????????? ???????? PAR ??????????????? ?? ?????????? ?????. ???????
@@ -24,6 +36,7 @@
 	 ??? ???????? ??????, ???????? HCP ?????????? ?? ????????? ???????? ??? 
 	 ??????????? ?????????????, ? ??? ?? ?????? ????????? ?? ????????
 	 <a href="$$statistics$$">??????????</a>.
+
          <h3>??????</h3>
          ???????? ???????, ???????, ????????? ?? ???????, ????????? ?????????.<br>
 	 ??? ????? ???? ??????. ???????????? ? <a href="$$development$$">???????????</a>.

Modified: feature_branches/hp_lotm/input/lotm/lotm_200804.html
===================================================================
--- feature_branches/hp_lotm/input/lotm/lotm_200804.html	2008-04-06 19:10:27 UTC (rev 1093)
+++ feature_branches/hp_lotm/input/lotm/lotm_200804.html	2008-04-06 19:21:37 UTC (rev 1094)
@@ -74,7 +74,7 @@
 Pupil: &quot;A what?&quot;<br>
 Schoolmaster <i>(speaking demurely while raising his finger)</i>:
 &quot;Once again, not paying attention during music class?&quot;<br>
-Pupil </i>(sheepishly with lowered head, but rolliing his eyes)</i>: &quot;I'm
+Pupil <i>(sheepishly with lowered head, but rolliing his eyes)</i>: &quot;I'm
 afraid, I don't remember this.&quot;<br>
 Schoolmaster <i>(patronizingly (what else), pacing up and down)</i>:
 &quot;Very
@@ -334,3 +334,4 @@
 
 <p><i>NObby</i><p>
 
+</div>

Modified: feature_branches/hp_lotm/input/lotm/lotm_200804_de.html
===================================================================
--- feature_branches/hp_lotm/input/lotm/lotm_200804_de.html	2008-04-06 19:10:27 UTC (rev 1093)
+++ feature_branches/hp_lotm/input/lotm/lotm_200804_de.html	2008-04-06 19:21:37 UTC (rev 1094)
@@ -343,3 +343,4 @@
 
 <p><i>NObby</i></p>
 
+</div>

Modified: feature_branches/hp_lotm/input/lotm/lotm_200804_ru.html
===================================================================
--- feature_branches/hp_lotm/input/lotm/lotm_200804_ru.html	2008-04-06 19:10:27 UTC (rev 1093)
+++ feature_branches/hp_lotm/input/lotm/lotm_200804_ru.html	2008-04-06 19:21:37 UTC (rev 1094)
@@ -72,7 +72,7 @@
 ??????: &quot;????&quot;<br>
 ??????? <i>(???????, ???????? ?????? ?????)</i>:
 &quot;????? ?? ???????? ???????? ????? ???????&quot;<br>
-?????? </i>(????? ??????? ?????? ? ?????? ?????)</i>: &quot;?????,
+?????? <i>(????? ??????? ?????? ? ?????? ?????)</i>: &quot;?????,
 ? ?? ????? ??? ?????????.&quot;<br>
 ??????? <i>(?????????? (? ??? ?????), ????? ????-????)</i>:
 &quot;????? ??????, ?????? ?????. ???????? - ??? ??????????? ????????????
@@ -285,3 +285,4 @@
 
 <p><i>NObby</i><p>
 
+</div>

Modified: feature_branches/hp_lotm/input/output-files.lua
===================================================================
--- feature_branches/hp_lotm/input/output-files.lua	2008-04-06 19:10:27 UTC (rev 1093)
+++ feature_branches/hp_lotm/input/output-files.lua	2008-04-06 19:21:37 UTC (rev 1094)
@@ -483,3 +483,15 @@
     body = {"articles/eoya_2007_statistics"}
 }
 
+----------------------------------------------------------------------
+-- April 2008 ("The Three Clouds")
+----------------------------------------------------------------------
+
+html.april_2008 = {
+    outfile = "april_2008.html",
+    title = "$$lotm_expansion$$: $$April$$ '08",
+    title_de = "$$lotm_expansion$$: $$April$$ '08",
+    title_ru = "$$lotm_expansion$$: $$April$$ '08",
+    rightcolumn = {},
+    body = {"articles/april_2008"},
+}    

Modified: feature_branches/hp_lotm/input/stat-other.html
===================================================================
--- feature_branches/hp_lotm/input/stat-other.html	2008-04-06 19:10:27 UTC (rev 1093)
+++ feature_branches/hp_lotm/input/stat-other.html	2008-04-06 19:21:37 UTC (rev 1094)
@@ -1,22 +1,22 @@
   <div class="stat-help">
     <h3>$$Other_Statistics$$</h3>
     <h4>$$Scores$$</h4>
-      73526 $$single_level_scores$$.
+      75496 $$single_level_scores$$.
     <h4>$$Ratings$$</h4>
-      13840 $$single_level_ratings$$ 4.89 $$and_distribution$$: 
+      14014 $$single_level_ratings$$ 4.90 $$and_distribution$$: 
       <table>
         <colgroup><col width="80"><col width="80"></colgroup>
         <tr><th>$$rating$$</th><th>$$count$$</th></tr>
-        <tr><td class="num">0</td><td class="num">57</td></tr>
-        <tr><td class="num">1</td><td class="num">264</td></tr>
-        <tr><td class="num">2</td><td class="num">723</td></tr>
-        <tr><td class="num">3</td><td class="num">2008</td></tr>
-        <tr><td class="num">4</td><td class="num">2657</td></tr>
-        <tr><td class="num">5</td><td class="num">3325</td></tr>
-        <tr><td class="num">6</td><td class="num">2309</td></tr>
-        <tr><td class="num">7</td><td class="num">1580</td></tr>
-        <tr><td class="num">8</td><td class="num">583</td></tr>
-        <tr><td class="num">9</td><td class="num">231</td></tr>
-        <tr><td class="num">10</td><td class="num">103</td></tr>
+        <tr><td class="num">0</td><td class="num">58</td></tr>
+        <tr><td class="num">1</td><td class="num">269</td></tr>
+        <tr><td class="num">2</td><td class="num">731</td></tr>
+        <tr><td class="num">3</td><td class="num">2015</td></tr>
+        <tr><td class="num">4</td><td class="num">2679</td></tr>
+        <tr><td class="num">5</td><td class="num">3347</td></tr>
+        <tr><td class="num">6</td><td class="num">2344</td></tr>
+        <tr><td class="num">7</td><td class="num">1616</td></tr>
+        <tr><td class="num">8</td><td class="num">607</td></tr>
+        <tr><td class="num">9</td><td class="num">238</td></tr>
+        <tr><td class="num">10</td><td class="num">110</td></tr>
       </table>
   </div>

Modified: feature_branches/hp_lotm/input/table-hcp.html
===================================================================
--- feature_branches/hp_lotm/input/table-hcp.html	2008-04-06 19:10:27 UTC (rev 1093)
+++ feature_branches/hp_lotm/input/table-hcp.html	2008-04-06 19:21:37 UTC (rev 1094)
@@ -1,138 +1,143 @@
   <table>
-    <caption>$$Handicap_Statistics$$ $$February$$ 2008</caption>
+    <caption>$$Handicap_Statistics$$ $$March$$ 2008</caption>
     <colgroup><col width="130"><col width="220"></colgroup>
     <tr><th>$$solved_hcp$$</th><th class="left">$$user$$</th></tr>
-     <tr><td class="num">-140.7</td><td class="left">'Moneymaker'</td></tr>
-     <tr><td class="num"> -83.8</td><td class="left">'Johannes'</td></tr>
-     <tr><td class="num"> -83.5</td><td class="left">'Stupid'</td></tr>
-     <tr><td class="num"> -72.0</td><td class="left">'Great Scott'</td></tr>
-     <tr><td class="num"> -61.6</td><td class="left">'Duffy'</td></tr>
-     <tr><td class="num"> -60.7</td><td class="left">'Malla'</td></tr>
-     <tr><td class="num"> -57.6</td><td class="left">'daydreamer'</td></tr>
-     <tr><td class="num"> -50.2</td><td class="left">'Django'</td></tr>
-     <tr><td class="num"> -47.5</td><td class="left">'ryujun'</td></tr>
-     <tr><td class="num"> -44.8</td><td class="left">'Gloop'</td></tr>
-     <tr><td class="num"> -43.6</td><td class="left">'Alexandros'</td></tr>
-     <tr><td class="num"> -41.8</td><td class="left">'Taztunes'</td></tr>
-     <tr><td class="num"> -38.2</td><td class="left">'Safalra'</td></tr>
-     <tr><td class="num"> -34.3</td><td class="left">'dev0'</td></tr>
-     <tr><td class="num"> -29.8</td><td class="left">'B-Huff'</td></tr>
-     <tr><td class="num"> -29.0</td><td class="left">'Ludmian'</td></tr>
-     <tr><td class="num"> -28.1</td><td class="left">'bojster'</td></tr>
-     <tr><td class="num"> -28.0</td><td class="left">'Zekobah'</td></tr>
-     <tr><td class="num"> -24.3</td><td class="left">'hendrik'</td></tr>
-     <tr><td class="num"> -22.6</td><td class="left">'ABS'</td></tr>
-     <tr><td class="num"> -21.7</td><td class="left">'ged'</td></tr>
-     <tr><td class="num"> -20.2</td><td class="left">'Raoul'</td></tr>
-     <tr><td class="num"> -19.9</td><td class="left">'Emmanuel'</td></tr>
-     <tr><td class="num"> -16.6</td><td class="left">'Ghatotkacha'</td></tr>
-     <tr><td class="num"> -16.0</td><td class="left">'Ronald'</td></tr>
-     <tr><td class="num"> -14.7</td><td class="left">'dpl'</td></tr>
-     <tr><td class="num"> -13.0</td><td class="left">'Lukas'</td></tr>
-     <tr><td class="num"> -12.2</td><td class="left">'HuB34'</td></tr>
-     <tr><td class="num">  -9.1</td><td class="left">'joseba'</td></tr>
-     <tr><td class="num">  -8.9</td><td class="left">'Daisy'</td></tr>
-     <tr><td class="num">  -8.8</td><td class="left">'Iceshark7'</td></tr>
-     <tr><td class="num">  -5.0</td><td class="left">'Daniel'</td></tr>
-     <tr><td class="num">  -3.7</td><td class="left">'fabian'</td></tr>
-     <tr><td class="num">  -2.3</td><td class="left">'Craven'</td></tr>
-     <tr><td class="num">  -2.0</td><td class="left">'JuSt'</td></tr>
-     <tr><td class="num">  -1.7</td><td class="left">'Wuzzy'</td></tr>
-     <tr><td class="num">   0.8</td><td class="left">'para_doks'</td></tr>
-     <tr><td class="num">   0.9</td><td class="left">'Tobias'</td></tr>
-     <tr><td class="num">   2.1</td><td class="left">'Guglielmo'</td></tr>
-     <tr><td class="num">   3.0</td><td class="left">'U-Punkt'</td></tr>
-     <tr><td class="num">   3.3</td><td class="left">'Andy'</td></tr>
-     <tr><td class="num">   3.4</td><td class="left">'serpent'</td></tr>
+     <tr><td class="num">-143.6</td><td class="left">'Moneymaker'</td></tr>
+     <tr><td class="num"> -82.6</td><td class="left">'Johannes'</td></tr>
+     <tr><td class="num"> -82.4</td><td class="left">'Stupid'</td></tr>
+     <tr><td class="num"> -71.3</td><td class="left">'daydreamer'</td></tr>
+     <tr><td class="num"> -71.0</td><td class="left">'Great Scott'</td></tr>
+     <tr><td class="num"> -60.9</td><td class="left">'Duffy'</td></tr>
+     <tr><td class="num"> -59.5</td><td class="left">'Malla'</td></tr>
+     <tr><td class="num"> -52.8</td><td class="left">'ryujun'</td></tr>
+     <tr><td class="num"> -49.0</td><td class="left">'Django'</td></tr>
+     <tr><td class="num"> -43.6</td><td class="left">'Gloop'</td></tr>
+     <tr><td class="num"> -42.4</td><td class="left">'Alexandros'</td></tr>
+     <tr><td class="num"> -41.6</td><td class="left">'dev0'</td></tr>
+     <tr><td class="num"> -40.5</td><td class="left">'Taztunes'</td></tr>
+     <tr><td class="num"> -37.1</td><td class="left">'Safalra'</td></tr>
+     <tr><td class="num"> -31.7</td><td class="left">'B-Huff'</td></tr>
+     <tr><td class="num"> -30.8</td><td class="left">'Ludmian'</td></tr>
+     <tr><td class="num"> -27.0</td><td class="left">'Zekobah'</td></tr>
+     <tr><td class="num"> -27.0</td><td class="left">'bojster'</td></tr>
+     <tr><td class="num"> -23.3</td><td class="left">'hendrik'</td></tr>
+     <tr><td class="num"> -21.6</td><td class="left">'ABS'</td></tr>
+     <tr><td class="num"> -20.7</td><td class="left">'ged'</td></tr>
+     <tr><td class="num"> -19.8</td><td class="left">'dpl'</td></tr>
+     <tr><td class="num"> -19.5</td><td class="left">'Raoul'</td></tr>
+     <tr><td class="num"> -18.9</td><td class="left">'Emmanuel'</td></tr>
+     <tr><td class="num"> -16.2</td><td class="left">'Ronald'</td></tr>
+     <tr><td class="num"> -15.7</td><td class="left">'Ghatotkacha'</td></tr>
+     <tr><td class="num"> -12.3</td><td class="left">'Lukas'</td></tr>
+     <tr><td class="num"> -11.5</td><td class="left">'HuB34'</td></tr>
+     <tr><td class="num"> -11.1</td><td class="left">'Daisy'</td></tr>
+     <tr><td class="num">  -8.2</td><td class="left">'joseba'</td></tr>
+     <tr><td class="num">  -8.1</td><td class="left">'Iceshark7'</td></tr>
+     <tr><td class="num">  -4.3</td><td class="left">'Daniel'</td></tr>
+     <tr><td class="num">  -3.0</td><td class="left">'fabian'</td></tr>
+     <tr><td class="num">  -1.5</td><td class="left">'Craven'</td></tr>
+     <tr><td class="num">  -1.2</td><td class="left">'JuSt'</td></tr>
+     <tr><td class="num">  -1.0</td><td class="left">'Wuzzy'</td></tr>
+     <tr><td class="num">   1.5</td><td class="left">'para_doks'</td></tr>
+     <tr><td class="num">   1.7</td><td class="left">'Tobias'</td></tr>
+     <tr><td class="num">   2.6</td><td class="left">'Guglielmo'</td></tr>
      <tr><td class="num">   3.7</td><td class="left">'Kevin'</td></tr>
-     <tr><td class="num">   5.5</td><td class="left">'Austin'</td></tr>
-     <tr><td class="num">   7.7</td><td class="left">'mrduke'</td></tr>
-     <tr><td class="num">  10.3</td><td class="left">'ShadowPhrogg32642342'</td></tr>
-     <tr><td class="num">  11.1</td><td class="left">'Tiza'</td></tr>
-     <tr><td class="num">  12.0</td><td class="left">'Andreas'</td></tr>
-     <tr><td class="num">  12.3</td><td class="left">'alfred69'</td></tr>
-     <tr><td class="num">  12.7</td><td class="left">'Chocolate Zero'</td></tr>
-     <tr><td class="num">  13.8</td><td class="left">'Sim_Ed'</td></tr>
-     <tr><td class="num">  14.1</td><td class="left">'Agnieszka'</td></tr>
-     <tr><td class="num">  14.2</td><td class="left">'shoki'</td></tr>
-     <tr><td class="num">  14.6</td><td class="left">'Mark P.'</td></tr>
-     <tr><td class="num">  18.6</td><td class="left">'Alex'</td></tr>
-     <tr><td class="num">  21.4</td><td class="left">'Klaus'</td></tr>
-     <tr><td class="num">  21.7</td><td class="left">'Marc-Hendrik'</td></tr>
-     <tr><td class="num">  21.9</td><td class="left">'Chris'</td></tr>
-     <tr><td class="num">  22.8</td><td class="left">'Thomas'</td></tr>
-     <tr><td class="num">  22.9</td><td class="left">'Bent'</td></tr>
-     <tr><td class="num">  23.6</td><td class="left">'hdwow'</td></tr>
-     <tr><td class="num">  24.2</td><td class="left">'Gottseinsohn'</td></tr>
-     <tr><td class="num">  24.7</td><td class="left">'Hans-HD'</td></tr>
-     <tr><td class="num">  25.3</td><td class="left">'Ale'</td></tr>
-     <tr><td class="num">  26.6</td><td class="left">'J3FF'</td></tr>
-     <tr><td class="num">  26.6</td><td class="left">'Little_Mole'</td></tr>
-     <tr><td class="num">  27.9</td><td class="left">'biotopa'</td></tr>
-     <tr><td class="num">  28.6</td><td class="left">'oblo'</td></tr>
-     <tr><td class="num">  28.8</td><td class="left">'redsantz'</td></tr>
-     <tr><td class="num">  29.1</td><td class="left">'geembo_90'</td></tr>
-     <tr><td class="num">  30.0</td><td class="left">'Edgar_Flesk'</td></tr>
-     <tr><td class="num">  30.4</td><td class="left">'Melanie'</td></tr>
-     <tr><td class="num">  30.6</td><td class="left">'IChrisI'</td></tr>
-     <tr><td class="num">  30.7</td><td class="left">'Vinksu'</td></tr>
-     <tr><td class="num">  31.0</td><td class="left">'erich'</td></tr>
-     <tr><td class="num">  31.0</td><td class="left">'NorthForty'</td></tr>
-     <tr><td class="num">  31.3</td><td class="left">'Gorn'</td></tr>
-     <tr><td class="num">  31.4</td><td class="left">'Davacardo'</td></tr>
-     <tr><td class="num">  32.5</td><td class="left">'Antonio EE'</td></tr>
-     <tr><td class="num">  34.1</td><td class="left">'niebie'</td></tr>
-     <tr><td class="num">  34.2</td><td class="left">'MicWa'</td></tr>
-     <tr><td class="num">  34.3</td><td class="left">'WP319'</td></tr>
-     <tr><td class="num">  34.6</td><td class="left">'Kosby'</td></tr>
-     <tr><td class="num">  36.4</td><td class="left">'Rugby4ever'</td></tr>
-     <tr><td class="num">  37.8</td><td class="left">'Drotten'</td></tr>
-     <tr><td class="num">  38.3</td><td class="left">'Archcorenth'</td></tr>
-     <tr><td class="num">  38.5</td><td class="left">'Harry Lim'</td></tr>
-     <tr><td class="num">  38.7</td><td class="left">'B-man'</td></tr>
-     <tr><td class="num">  38.9</td><td class="left">'Angolino'</td></tr>
-     <tr><td class="num">  39.4</td><td class="left">'mecke'</td></tr>
-     <tr><td class="num">  39.7</td><td class="left">'Nfol'</td></tr>
-     <tr><td class="num">  40.1</td><td class="left">'Tiger'</td></tr>
-     <tr><td class="num">  40.8</td><td class="left">'Snaily'</td></tr>
-     <tr><td class="num">  41.0</td><td class="left">'Vlad'</td></tr>
-     <tr><td class="num">  42.1</td><td class="left">'Momcat'</td></tr>
-     <tr><td class="num">  42.2</td><td class="left">'Liam Sheehan'</td></tr>
-     <tr><td class="num">  42.6</td><td class="left">'Breezy'</td></tr>
-     <tr><td class="num">  42.7</td><td class="left">'Uli'</td></tr>
-     <tr><td class="num">  44.5</td><td class="left">'Tarim'</td></tr>
-     <tr><td class="num">  45.1</td><td class="left">'IntKecsk'</td></tr>
-     <tr><td class="num">  46.5</td><td class="left">'ntaeijr'</td></tr>
-     <tr><td class="num">  46.8</td><td class="left">'mhatta'</td></tr>
-     <tr><td class="num">  48.3</td><td class="left">'Zak'</td></tr>
-     <tr><td class="num">  48.7</td><td class="left">'Valkyrie2'</td></tr>
-     <tr><td class="num">  49.1</td><td class="left">'Sandra'</td></tr>
-     <tr><td class="num">  50.0</td><td class="left">'jdcampo'</td></tr>
-     <tr><td class="num">  50.6</td><td class="left">'Jeffrey S'</td></tr>
-     <tr><td class="num">  51.4</td><td class="left">'brynn'</td></tr>
-     <tr><td class="num">  51.4</td><td class="left">'Vaily'</td></tr>
-     <tr><td class="num">  52.6</td><td class="left">'Turbogurk'</td></tr>
-     <tr><td class="num">  52.6</td><td class="left">'Neophilus'</td></tr>
-     <tr><td class="num">  52.8</td><td class="left">'Cyphase'</td></tr>
-     <tr><td class="num">  55.0</td><td class="left">'krazy62'</td></tr>
-     <tr><td class="num">  55.8</td><td class="left">'Adonica'</td></tr>
-     <tr><td class="num">  61.3</td><td class="left">'Asbel'</td></tr>
-     <tr><td class="num">  61.5</td><td class="left">'Mecki'</td></tr>
-     <tr><td class="num">  63.1</td><td class="left">'Meeve'</td></tr>
-     <tr><td class="num">  65.7</td><td class="left">'ael'</td></tr>
-     <tr><td class="num">  66.1</td><td class="left">'Samuel'</td></tr>
-     <tr><td class="num">  66.4</td><td class="left">'schmusi20'</td></tr>
-     <tr><td class="num">  67.1</td><td class="left">'Alf'</td></tr>
-     <tr><td class="num">  68.7</td><td class="left">'Magnus and Susi'</td></tr>
-     <tr><td class="num">  69.8</td><td class="left">'xmouse'</td></tr>
-     <tr><td class="num">  71.5</td><td class="left">'Joona'</td></tr>
-     <tr><td class="num">  71.7</td><td class="left">'AQZ'</td></tr>
-     <tr><td class="num">  73.7</td><td class="left">'Dvorhagen'</td></tr>
-     <tr><td class="num">  74.7</td><td class="left">'jojo'</td></tr>
-     <tr><td class="num">  74.8</td><td class="left">'AsuCaga'</td></tr>
-     <tr><td class="num">  79.5</td><td class="left">'AkRa'</td></tr>
-     <tr><td class="num">  80.0</td><td class="left">'Agares'</td></tr>
-     <tr><td class="num">  84.7</td><td class="left">'Miel56'</td></tr>
-     <tr><td class="num">  89.8</td><td class="left">'The red O'</td></tr>
+     <tr><td class="num">   3.7</td><td class="left">'U-Punkt'</td></tr>
+     <tr><td class="num">   4.0</td><td class="left">'Andy'</td></tr>
+     <tr><td class="num">   4.0</td><td class="left">'serpent'</td></tr>
+     <tr><td class="num">   6.3</td><td class="left">'Austin'</td></tr>
+     <tr><td class="num">   8.1</td><td class="left">'shoki'</td></tr>
+     <tr><td class="num">   8.3</td><td class="left">'mrduke'</td></tr>
+     <tr><td class="num">  10.8</td><td class="left">'ShadowPhrogg32642342'</td></tr>
+     <tr><td class="num">  11.9</td><td class="left">'Tiza'</td></tr>
+     <tr><td class="num">  12.2</td><td class="left">'Andreas'</td></tr>
+     <tr><td class="num">  12.2</td><td class="left">'Freshman'</td></tr>
+     <tr><td class="num">  13.1</td><td class="left">'alfred69'</td></tr>
+     <tr><td class="num">  13.4</td><td class="left">'Chocolate Zero'</td></tr>
+     <tr><td class="num">  14.4</td><td class="left">'Sim_Ed'</td></tr>
+     <tr><td class="num">  14.7</td><td class="left">'Agnieszka'</td></tr>
+     <tr><td class="num">  15.0</td><td class="left">'Mark P.'</td></tr>
+     <tr><td class="num">  19.2</td><td class="left">'Alex'</td></tr>
+     <tr><td class="num">  21.1</td><td class="left">'Antonio EE'</td></tr>
+     <tr><td class="num">  22.0</td><td class="left">'Klaus'</td></tr>
+     <tr><td class="num">  22.2</td><td class="left">'Marc-Hendrik'</td></tr>
+     <tr><td class="num">  22.4</td><td class="left">'Chris'</td></tr>
+     <tr><td class="num">  23.3</td><td class="left">'Thomas'</td></tr>
+     <tr><td class="num">  23.4</td><td class="left">'Bent'</td></tr>
+     <tr><td class="num">  24.1</td><td class="left">'hdwow'</td></tr>
+     <tr><td class="num">  24.7</td><td class="left">'Gottseinsohn'</td></tr>
+     <tr><td class="num">  25.2</td><td class="left">'Hans-HD'</td></tr>
+     <tr><td class="num">  25.7</td><td class="left">'Ale'</td></tr>
+     <tr><td class="num">  27.0</td><td class="left">'Little_Mole'</td></tr>
+     <tr><td class="num">  27.1</td><td class="left">'J3FF'</td></tr>
+     <tr><td class="num">  28.3</td><td class="left">'biotopa'</td></tr>
+     <tr><td class="num">  29.0</td><td class="left">'oblo'</td></tr>
+     <tr><td class="num">  29.3</td><td class="left">'redsantz'</td></tr>
+     <tr><td class="num">  29.7</td><td class="left">'geembo_90'</td></tr>
+     <tr><td class="num">  30.4</td><td class="left">'Edgar_Flesk'</td></tr>
+     <tr><td class="num">  30.8</td><td class="left">'Melanie'</td></tr>
+     <tr><td class="num">  31.0</td><td class="left">'IChrisI'</td></tr>
+     <tr><td class="num">  31.2</td><td class="left">'Vinksu'</td></tr>
+     <tr><td class="num">  31.3</td><td class="left">'erich'</td></tr>
+     <tr><td class="num">  31.4</td><td class="left">'NorthForty'</td></tr>
+     <tr><td class="num">  31.6</td><td class="left">'Gorn'</td></tr>
+     <tr><td class="num">  31.8</td><td class="left">'Davacardo'</td></tr>
+     <tr><td class="num">  34.5</td><td class="left">'niebie'</td></tr>
+     <tr><td class="num">  34.5</td><td class="left">'MicWa'</td></tr>
+     <tr><td class="num">  34.7</td><td class="left">'WP319'</td></tr>
+     <tr><td class="num">  35.0</td><td class="left">'Kosby'</td></tr>
+     <tr><td class="num">  36.7</td><td class="left">'Rugby4ever'</td></tr>
+     <tr><td class="num">  38.1</td><td class="left">'mecke'</td></tr>
+     <tr><td class="num">  38.2</td><td class="left">'Drotten'</td></tr>
+     <tr><td class="num">  38.6</td><td class="left">'Archcorenth'</td></tr>
+     <tr><td class="num">  38.9</td><td class="left">'Harry Lim'</td></tr>
+     <tr><td class="num">  39.1</td><td class="left">'B-man'</td></tr>
+     <tr><td class="num">  39.5</td><td class="left">'Angolino'</td></tr>
+     <tr><td class="num">  40.0</td><td class="left">'Nfol'</td></tr>
+     <tr><td class="num">  40.5</td><td class="left">'Tiger'</td></tr>
+     <tr><td class="num">  41.1</td><td class="left">'Snaily'</td></tr>
+     <tr><td class="num">  41.4</td><td class="left">'Vlad'</td></tr>
+     <tr><td class="num">  42.4</td><td class="left">'Momcat'</td></tr>
+     <tr><td class="num">  42.5</td><td class="left">'Liam Sheehan'</td></tr>
+     <tr><td class="num">  42.9</td><td class="left">'Breezy'</td></tr>
+     <tr><td class="num">  43.0</td><td class="left">'Uli'</td></tr>
+     <tr><td class="num">  44.8</td><td class="left">'Tarim'</td></tr>
+     <tr><td class="num">  45.4</td><td class="left">'IntKecsk'</td></tr>
+     <tr><td class="num">  45.7</td><td class="left">'tjRaven'</td></tr>
+     <tr><td class="num">  46.8</td><td class="left">'ntaeijr'</td></tr>
+     <tr><td class="num">  47.0</td><td class="left">'mhatta'</td></tr>
+     <tr><td class="num">  48.6</td><td class="left">'Zak'</td></tr>
+     <tr><td class="num">  49.1</td><td class="left">'Valkyrie2'</td></tr>
+     <tr><td class="num">  49.5</td><td class="left">'Sandra'</td></tr>
+     <tr><td class="num">  50.4</td><td class="left">'jdcampo'</td></tr>
+     <tr><td class="num">  50.9</td><td class="left">'Jeffrey S'</td></tr>
+     <tr><td class="num">  51.2</td><td class="left">'brynn'</td></tr>
+     <tr><td class="num">  51.3</td><td class="left">'Slav'</td></tr>
+     <tr><td class="num">  51.4</td><td class="left">'AkRa'</td></tr>
+     <tr><td class="num">  51.8</td><td class="left">'Vaily'</td></tr>
+     <tr><td class="num">  52.9</td><td class="left">'Turbogurk'</td></tr>
+     <tr><td class="num">  52.9</td><td class="left">'Neophilus'</td></tr>
+     <tr><td class="num">  52.9</td><td class="left">'Cyphase'</td></tr>
+     <tr><td class="num">  55.3</td><td class="left">'krazy62'</td></tr>
+     <tr><td class="num">  56.1</td><td class="left">'Adonica'</td></tr>
+     <tr><td class="num">  58.7</td><td class="left">'Mecki'</td></tr>
+     <tr><td class="num">  61.4</td><td class="left">'Asbel'</td></tr>
+     <tr><td class="num">  63.3</td><td class="left">'Meeve'</td></tr>
+     <tr><td class="num">  65.9</td><td class="left">'ael'</td></tr>
+     <tr><td class="num">  66.3</td><td class="left">'Samuel'</td></tr>
+     <tr><td class="num">  66.6</td><td class="left">'schmusi20'</td></tr>
+     <tr><td class="num">  67.2</td><td class="left">'Alf'</td></tr>
+     <tr><td class="num">  68.9</td><td class="left">'Magnus and Susi'</td></tr>
+     <tr><td class="num">  70.0</td><td class="left">'xmouse'</td></tr>
+     <tr><td class="num">  71.6</td><td class="left">'Joona'</td></tr>
+     <tr><td class="num">  71.8</td><td class="left">'AQZ'</td></tr>
+     <tr><td class="num">  73.3</td><td class="left">'crypto_rsa'</td></tr>
+     <tr><td class="num">  73.8</td><td class="left">'Dvorhagen'</td></tr>
+     <tr><td class="num">  74.8</td><td class="left">'jojo'</td></tr>
+     <tr><td class="num">  74.9</td><td class="left">'AsuCaga'</td></tr>
+     <tr><td class="num">  78.2</td><td class="left">'colonel crayon'</td></tr>
+     <tr><td class="num">  80.1</td><td class="left">'Agares'</td></tr>
+     <tr><td class="num">  84.8</td><td class="left">'Miel56'</td></tr>
+     <tr><td class="num">  89.9</td><td class="left">'The red O'</td></tr>
      <tr><td class="num">  92.2</td><td class="left">'Michael'</td></tr>
   </table>

Modified: feature_branches/hp_lotm/input/table-rat.html
===================================================================
--- feature_branches/hp_lotm/input/table-rat.html	2008-04-06 19:10:27 UTC (rev 1093)
+++ feature_branches/hp_lotm/input/table-rat.html	2008-04-06 19:21:37 UTC (rev 1094)
@@ -1,19 +1,19 @@
   <table>
-    <caption>$$Rating_Statistics$$ $$February$$ 2008</caption>
+    <caption>$$Rating_Statistics$$ $$March$$ 2008</caption>
     <colgroup><col width="80"><col width="80"><col width="220"></colgroup>
     <tr><th>$$count$$</th><th>$$average$$</th><th class="left">$$user$$</th></tr>    <tr><td class="num">1062</td><td class="num"> 5.06</td><td class="left">'ryujun'</td></tr>
     <tr><td class="num">1056</td><td class="num"> 4.83</td><td class="left">'Taztunes'</td></tr>
+    <tr><td class="num">880</td><td class="num"> 5.00</td><td class="left">'dev0'</td></tr>
     <tr><td class="num">871</td><td class="num"> 5.09</td><td class="left">'Stupid'</td></tr>
-    <tr><td class="num">853</td><td class="num"> 4.78</td><td class="left">'daydreamer'</td></tr>
-    <tr><td class="num">821</td><td class="num"> 4.94</td><td class="left">'dev0'</td></tr>
+    <tr><td class="num">864</td><td class="num"> 4.78</td><td class="left">'daydreamer'</td></tr>
     <tr><td class="num">653</td><td class="num"> 5.01</td><td class="left">'Duffy'</td></tr>
-    <tr><td class="num">627</td><td class="num"> 4.99</td><td class="left">'Moneymaker'</td></tr>
-    <tr><td class="num">613</td><td class="num"> 4.20</td><td class="left">'shoki'</td></tr>
+    <tr><td class="num">628</td><td class="num"> 5.00</td><td class="left">'Moneymaker'</td></tr>
+    <tr><td class="num">622</td><td class="num"> 4.22</td><td class="left">'shoki'</td></tr>
     <tr><td class="num">596</td><td class="num"> 4.82</td><td class="left">'U-Punkt'</td></tr>
-    <tr><td class="num">518</td><td class="num"> 5.08</td><td class="left">'dpl'</td></tr>
-    <tr><td class="num">517</td><td class="num"> 4.96</td><td class="left">'B-Huff'</td></tr>
+    <tr><td class="num">539</td><td class="num"> 5.11</td><td class="left">'dpl'</td></tr>
+    <tr><td class="num">534</td><td class="num"> 4.97</td><td class="left">'B-Huff'</td></tr>
     <tr><td class="num">511</td><td class="num"> 5.30</td><td class="left">'Lukas'</td></tr>
-    <tr><td class="num">469</td><td class="num"> 5.03</td><td class="left">'Ronald'</td></tr>
+    <tr><td class="num">487</td><td class="num"> 5.02</td><td class="left">'Ronald'</td></tr>
     <tr><td class="num">448</td><td class="num"> 5.08</td><td class="left">'Johannes'</td></tr>
     <tr><td class="num">433</td><td class="num"> 4.24</td><td class="left">'Alexandros'</td></tr>
     <tr><td class="num">424</td><td class="num"> 4.35</td><td class="left">'ged'</td></tr>
@@ -36,10 +36,11 @@
     <tr><td class="num"> 49</td><td class="num"> 6.02</td><td class="left">'oblo'</td></tr>
     <tr><td class="num"> 49</td><td class="num"> 4.90</td><td class="left">'hendrik'</td></tr>
     <tr><td class="num"> 43</td><td class="num"> 3.74</td><td class="left">'Iceshark7'</td></tr>
+    <tr><td class="num"> 31</td><td class="num"> 7.61</td><td class="left">'AkRa'</td></tr>
     <tr><td class="num"> 30</td><td class="num"> 4.40</td><td class="left">'Archcorenth'</td></tr>
     <tr><td class="num"> 25</td><td class="num"> 6.04</td><td class="left">'mrduke'</td></tr>
     <tr><td class="num"> 25</td><td class="num"> 4.88</td><td class="left">'Drotten'</td></tr>
-    <tr><td class="num"> 22</td><td class="num"> 7.32</td><td class="left">'Mark P.'</td></tr>
+    <tr><td class="num"> 23</td><td class="num"> 7.22</td><td class="left">'Mark P.'</td></tr>
     <tr><td class="num"> 17</td><td class="num"> 5.53</td><td class="left">'Jeffrey S'</td></tr>
     <tr><td class="num"> 16</td><td class="num"> 7.63</td><td class="left">'Ghatotkacha'</td></tr>
     <tr><td class="num"> 16</td><td class="num"> 3.88</td><td class="left">'Mecki'</td></tr>
@@ -48,6 +49,7 @@
     <tr><td class="num"> 11</td><td class="num"> 6.36</td><td class="left">'ShadowPhrogg32642342'</td></tr>
     <tr><td class="num"> 10</td><td class="num"> 7.80</td><td class="left">'hdwow'</td></tr>
     <tr><td class="num">  8</td><td class="num"> 3.25</td><td class="left">'Vlad'</td></tr>
+    <tr><td class="num">  8</td><td class="num"> 7.63</td><td class="left">'Antonio EE'</td></tr>
     <tr><td class="num">  7</td><td class="num"> 4.29</td><td class="left">'Snaily'</td></tr>
     <tr><td class="num">  5</td><td class="num"> 6.80</td><td class="left">'Breezy'</td></tr>
     <tr><td class="num">  5</td><td class="num"> 9.20</td><td class="left">'HuB34'</td></tr>
@@ -55,7 +57,6 @@
     <tr><td class="num">  4</td><td class="num">10.00</td><td class="left">'Kevin'</td></tr>
     <tr><td class="num">  4</td><td class="num"> 5.75</td><td class="left">'joseba'</td></tr>
     <tr><td class="num">  4</td><td class="num"> 1.00</td><td class="left">'Hans-HD'</td></tr>
-    <tr><td class="num">  4</td><td class="num"> 8.75</td><td class="left">'Antonio EE'</td></tr>
     <tr><td class="num">  4</td><td class="num"> 6.50</td><td class="left">'serpent'</td></tr>
     <tr><td class="num">  4</td><td class="num"> 7.00</td><td class="left">'redsantz'</td></tr>
     <tr><td class="num">  3</td><td class="num"> 0.67</td><td class="left">'Turbogurk'</td></tr>
@@ -63,13 +64,14 @@
     <tr><td class="num">  3</td><td class="num"> 7.67</td><td class="left">'Joona'</td></tr>
     <tr><td class="num">  3</td><td class="num"> 3.00</td><td class="left">'Rugby4ever'</td></tr>
     <tr><td class="num">  3</td><td class="num"> 4.33</td><td class="left">'krazy62'</td></tr>
+    <tr><td class="num">  2</td><td class="num"> 6.50</td><td class="left">'tjRaven'</td></tr>
     <tr><td class="num">  2</td><td class="num"> 0.00</td><td class="left">'mhatta'</td></tr>
     <tr><td class="num">  1</td><td class="num"> 5.00</td><td class="left">'ael'</td></tr>
+    <tr><td class="num">  1</td><td class="num"> 6.00</td><td class="left">'Slav'</td></tr>
     <tr><td class="num">  1</td><td class="num"> 4.00</td><td class="left">'Angolino'</td></tr>
     <tr><td class="num">  1</td><td class="num"> 5.00</td><td class="left">'Uli'</td></tr>
     <tr><td class="num">  1</td><td class="num">10.00</td><td class="left">'Cyphase'</td></tr>
     <tr><td class="num">  1</td><td class="num"> 5.00</td><td class="left">'Harry Lim'</td></tr>
-    <tr><td class="num">  1</td><td class="num"> 3.00</td><td class="left">'AkRa'</td></tr>
     <tr><td class="num">  1</td><td class="num"> 6.00</td><td class="left">'Emmanuel'</td></tr>
     <tr><td class="num">  1</td><td class="num"> 4.00</td><td class="left">'jojo'</td></tr>
   </table>

Modified: feature_branches/hp_lotm/input/table-solved.html
===================================================================
--- feature_branches/hp_lotm/input/table-solved.html	2008-04-06 19:10:27 UTC (rev 1093)
+++ feature_branches/hp_lotm/input/table-solved.html	2008-04-06 19:21:37 UTC (rev 1094)
@@ -1,55 +1,56 @@
   <table>
-    <caption>$$Solved_Level_Statistics$$ $$February$$ 2008</caption>
+    <caption>$$Solved_Level_Statistics$$ $$March$$ 2008</caption>
     <colgroup><col width="130"><col width="130"><col width="130"><col width="240"></colgroup>
     <tr><th>$$difficult$$</th><th>$$easy$$</th><th>$$total$$</th><th class="left">$$user$$</th></tr>
     <tr><td class="num">1045/1045</td><td class="num">189/189</td><td class="num">100.00%</td><td class="left">'ryujun'</td></tr>
     <tr><td class="num">1043/1045</td><td class="num">189/189</td><td class="num"> 99.84%</td><td class="left">'Taztunes'</td></tr>
     <tr><td class="num">1029/1045</td><td class="num">183/189</td><td class="num"> 98.22%</td><td class="left">'Craven'</td></tr>
-    <tr><td class="num">1030/1045</td><td class="num">178/189</td><td class="num"> 97.89%</td><td class="left">'Moneymaker'</td></tr>
+    <tr><td class="num">1031/1045</td><td class="num">179/189</td><td class="num"> 98.06%</td><td class="left">'Moneymaker'</td></tr>
+    <tr><td class="num">1016/1045</td><td class="num">182/189</td><td class="num"> 97.08%</td><td class="left">'Ronald'</td></tr>
     <tr><td class="num">1021/1045</td><td class="num">177/189</td><td class="num"> 97.08%</td><td class="left">'Malla'</td></tr>
-    <tr><td class="num">1012/1045</td><td class="num">179/189</td><td class="num"> 96.52%</td><td class="left">'Ronald'</td></tr>
     <tr><td class="num">1014/1045</td><td class="num">175/189</td><td class="num"> 96.35%</td><td class="left">'Stupid'</td></tr>
     <tr><td class="num"> 999/1045</td><td class="num">177/189</td><td class="num"> 95.30%</td><td class="left">'biotopa'</td></tr>
-    <tr><td class="num"> 969/1045</td><td class="num">170/189</td><td class="num"> 92.30%</td><td class="left">'daydreamer'</td></tr>
+    <tr><td class="num"> 984/1045</td><td class="num">173/189</td><td class="num"> 93.76%</td><td class="left">'daydreamer'</td></tr>
     <tr><td class="num"> 970/1045</td><td class="num">166/189</td><td class="num"> 92.06%</td><td class="left">'Andy'</td></tr>
     <tr><td class="num"> 949/1045</td><td class="num">170/189</td><td class="num"> 90.68%</td><td class="left">'para_doks'</td></tr>
-    <tr><td class="num"> 942/1045</td><td class="num">172/189</td><td class="num"> 90.28%</td><td class="left">'Daisy'</td></tr>
+    <tr><td class="num"> 943/1045</td><td class="num">172/189</td><td class="num"> 90.36%</td><td class="left">'Daisy'</td></tr>
+    <tr><td class="num"> 943/1045</td><td class="num">168/189</td><td class="num"> 90.03%</td><td class="left">'mecke'</td></tr>
     <tr><td class="num"> 933/1045</td><td class="num">125/189</td><td class="num"> 85.74%</td><td class="left">'Alex'</td></tr>
     <tr><td class="num"> 914/1045</td><td class="num">135/189</td><td class="num"> 85.01%</td><td class="left">'JuSt'</td></tr>
+    <tr><td class="num"> 879/1045</td><td class="num">163/189</td><td class="num"> 84.44%</td><td class="left">'dev0'</td></tr>
     <tr><td class="num"> 894/1045</td><td class="num">140/189</td><td class="num"> 83.79%</td><td class="left">'Johannes'</td></tr>
     <tr><td class="num"> 887/1045</td><td class="num">143/189</td><td class="num"> 83.47%</td><td class="left">'mrduke'</td></tr>
-    <tr><td class="num"> 891/1045</td><td class="num">133/189</td><td class="num"> 82.98%</td><td class="left">'mecke'</td></tr>
+    <tr><td class="num">1020/1045</td><td class="num">  6/189</td><td class="num"> 83.14%</td><td class="left">'Freshman'</td></tr>
     <tr><td class="num"> 863/1045</td><td class="num">161/189</td><td class="num"> 82.98%</td><td class="left">'Tobias'</td></tr>
     <tr><td class="num"> 917/1045</td><td class="num">106/189</td><td class="num"> 82.90%</td><td class="left">'Django'</td></tr>
     <tr><td class="num"> 863/1045</td><td class="num">150/189</td><td class="num"> 82.09%</td><td class="left">'Gloop'</td></tr>
     <tr><td class="num"> 849/1045</td><td class="num">151/189</td><td class="num"> 81.04%</td><td class="left">'WP319'</td></tr>
     <tr><td class="num"> 867/1045</td><td class="num">124/189</td><td class="num"> 80.31%</td><td class="left">'Lukas'</td></tr>
-    <tr><td class="num"> 841/1045</td><td class="num">144/189</td><td class="num"> 79.82%</td><td class="left">'Gorn'</td></tr>
+    <tr><td class="num"> 846/1045</td><td class="num">144/189</td><td class="num"> 80.23%</td><td class="left">'Gorn'</td></tr>
+    <tr><td class="num"> 854/1045</td><td class="num">131/189</td><td class="num"> 79.82%</td><td class="left">'shoki'</td></tr>
     <tr><td class="num"> 874/1045</td><td class="num">103/189</td><td class="num"> 79.17%</td><td class="left">'Melanie'</td></tr>
-    <tr><td class="num"> 815/1045</td><td class="num">149/189</td><td class="num"> 78.12%</td><td class="left">'dev0'</td></tr>
-    <tr><td class="num"> 841/1045</td><td class="num">123/189</td><td class="num"> 78.12%</td><td class="left">'shoki'</td></tr>
     <tr><td class="num"> 950/1045</td><td class="num">  0/189</td><td class="num"> 76.99%</td><td class="left">'Tarim'</td></tr>
     <tr><td class="num"> 804/1045</td><td class="num">142/189</td><td class="num"> 76.66%</td><td class="left">'Safalra'</td></tr>
     <tr><td class="num"> 938/1045</td><td class="num">  1/189</td><td class="num"> 76.09%</td><td class="left">'Ale'</td></tr>
     <tr><td class="num"> 772/1045</td><td class="num">113/189</td><td class="num"> 71.72%</td><td class="left">'U-Punkt'</td></tr>
     <tr><td class="num"> 739/1045</td><td class="num">131/189</td><td class="num"> 70.50%</td><td class="left">'ABS'</td></tr>
-    <tr><td class="num"> 719/1045</td><td class="num">122/189</td><td class="num"> 68.15%</td><td class="left">'B-Huff'</td></tr>
+    <tr><td class="num"> 728/1045</td><td class="num">126/189</td><td class="num"> 69.21%</td><td class="left">'B-Huff'</td></tr>
+    <tr><td class="num"> 755/1045</td><td class="num"> 96/189</td><td class="num"> 68.96%</td><td class="left">'brynn'</td></tr>
     <tr><td class="num"> 762/1045</td><td class="num"> 73/189</td><td class="num"> 67.67%</td><td class="left">'redsantz'</td></tr>
-    <tr><td class="num"> 745/1045</td><td class="num"> 73/189</td><td class="num"> 66.29%</td><td class="left">'brynn'</td></tr>
     <tr><td class="num"> 734/1045</td><td class="num"> 82/189</td><td class="num"> 66.13%</td><td class="left">'bojster'</td></tr>
     <tr><td class="num"> 782/1045</td><td class="num"> 33/189</td><td class="num"> 66.05%</td><td class="left">'Sim_Ed'</td></tr>
+    <tr><td class="num"> 686/1045</td><td class="num">118/189</td><td class="num"> 65.15%</td><td class="left">'dpl'</td></tr>
     <tr><td class="num"> 766/1045</td><td class="num"> 37/189</td><td class="num"> 65.07%</td><td class="left">'alfred69'</td></tr>
+    <tr><td class="num"> 670/1045</td><td class="num">107/189</td><td class="num"> 62.97%</td><td class="left">'Ludmian'</td></tr>
     <tr><td class="num"> 681/1045</td><td class="num"> 78/189</td><td class="num"> 61.51%</td><td class="left">'HuB34'</td></tr>
     <tr><td class="num"> 659/1045</td><td class="num"> 95/189</td><td class="num"> 61.10%</td><td class="left">'Marc-Hendrik'</td></tr>
-    <tr><td class="num"> 649/1045</td><td class="num">101/189</td><td class="num"> 60.78%</td><td class="left">'Ludmian'</td></tr>
     <tr><td class="num"> 633/1045</td><td class="num">110/189</td><td class="num"> 60.21%</td><td class="left">'Raoul'</td></tr>
     <tr><td class="num"> 643/1045</td><td class="num"> 83/189</td><td class="num"> 58.83%</td><td class="left">'Great Scott'</td></tr>
-    <tr><td class="num"> 633/1045</td><td class="num"> 84/189</td><td class="num"> 58.10%</td><td class="left">'dpl'</td></tr>
     <tr><td class="num"> 714/1045</td><td class="num">  0/189</td><td class="num"> 57.86%</td><td class="left">'Gottseinsohn'</td></tr>
     <tr><td class="num"> 620/1045</td><td class="num"> 72/189</td><td class="num"> 56.08%</td><td class="left">'Breezy'</td></tr>
     <tr><td class="num"> 636/1045</td><td class="num"> 55/189</td><td class="num"> 56.00%</td><td class="left">'fabian'</td></tr>
+    <tr><td class="num"> 569/1045</td><td class="num">113/189</td><td class="num"> 55.27%</td><td class="left">'Mark P.'</td></tr>
     <tr><td class="num"> 588/1045</td><td class="num"> 93/189</td><td class="num"> 55.19%</td><td class="left">'Ghatotkacha'</td></tr>
-    <tr><td class="num"> 568/1045</td><td class="num">112/189</td><td class="num"> 55.11%</td><td class="left">'Mark P.'</td></tr>
     <tr><td class="num"> 599/1045</td><td class="num"> 80/189</td><td class="num"> 55.02%</td><td class="left">'serpent'</td></tr>
     <tr><td class="num"> 634/1045</td><td class="num"> 43/189</td><td class="num"> 54.86%</td><td class="left">'Klaus'</td></tr>
     <tr><td class="num"> 557/1045</td><td class="num">117/189</td><td class="num"> 54.62%</td><td class="left">'Alexandros'</td></tr>
@@ -64,8 +65,8 @@
     <tr><td class="num"> 478/1045</td><td class="num">101/189</td><td class="num"> 46.92%</td><td class="left">'Austin'</td></tr>
     <tr><td class="num"> 504/1045</td><td class="num"> 62/189</td><td class="num"> 45.87%</td><td class="left">'Hans-HD'</td></tr>
     <tr><td class="num"> 519/1045</td><td class="num"> 37/189</td><td class="num"> 45.06%</td><td class="left">'Valkyrie2'</td></tr>
+    <tr><td class="num"> 492/1045</td><td class="num"> 63/189</td><td class="num"> 44.98%</td><td class="left">'Antonio EE'</td></tr>
     <tr><td class="num"> 516/1045</td><td class="num"> 24/189</td><td class="num"> 43.76%</td><td class="left">'niebie'</td></tr>
-    <tr><td class="num"> 467/1045</td><td class="num"> 63/189</td><td class="num"> 42.95%</td><td class="left">'Antonio EE'</td></tr>
     <tr><td class="num"> 494/1045</td><td class="num"> 26/189</td><td class="num"> 42.14%</td><td class="left">'Daniel'</td></tr>
     <tr><td class="num"> 506/1045</td><td class="num"> 12/189</td><td class="num"> 41.98%</td><td class="left">'Duffy'</td></tr>
     <tr><td class="num"> 503/1045</td><td class="num">  7/189</td><td class="num"> 41.33%</td><td class="left">'Edgar_Flesk'</td></tr>
@@ -94,13 +95,13 @@
     <tr><td class="num"> 288/1045</td><td class="num"> 36/189</td><td class="num"> 26.26%</td><td class="left">'Drotten'</td></tr>
     <tr><td class="num"> 261/1045</td><td class="num"> 53/189</td><td class="num"> 25.45%</td><td class="left">'Andreas'</td></tr>
     <tr><td class="num"> 287/1045</td><td class="num"> 18/189</td><td class="num"> 24.72%</td><td class="left">'Nfol'</td></tr>
+    <tr><td class="num"> 269/1045</td><td class="num"> 26/189</td><td class="num"> 23.91%</td><td class="left">'Mecki'</td></tr>
     <tr><td class="num"> 276/1045</td><td class="num"> 15/189</td><td class="num"> 23.58%</td><td class="left">'Thomas'</td></tr>
     <tr><td class="num"> 245/1045</td><td class="num"> 36/189</td><td class="num"> 22.77%</td><td class="left">'B-man'</td></tr>
     <tr><td class="num"> 259/1045</td><td class="num">  7/189</td><td class="num"> 21.56%</td><td class="left">'geembo_90'</td></tr>
     <tr><td class="num"> 243/1045</td><td class="num"> 23/189</td><td class="num"> 21.56%</td><td class="left">'Snaily'</td></tr>
     <tr><td class="num"> 201/1045</td><td class="num"> 54/189</td><td class="num"> 20.66%</td><td class="left">'mhatta'</td></tr>
     <tr><td class="num"> 210/1045</td><td class="num"> 38/189</td><td class="num"> 20.10%</td><td class="left">'Sandra'</td></tr>
-    <tr><td class="num"> 220/1045</td><td class="num"> 25/189</td><td class="num"> 19.85%</td><td class="left">'Mecki'</td></tr>
     <tr><td class="num"> 208/1045</td><td class="num"> 33/189</td><td class="num"> 19.53%</td><td class="left">'Uli'</td></tr>
     <tr><td class="num"> 203/1045</td><td class="num"> 34/189</td><td class="num"> 19.21%</td><td class="left">'ntaeijr'</td></tr>
     <tr><td class="num"> 214/1045</td><td class="num"> 19/189</td><td class="num"> 18.88%</td><td class="left">'Adonica'</td></tr>
@@ -110,7 +111,9 @@
     <tr><td class="num"> 125/1045</td><td class="num"> 55/189</td><td class="num"> 14.59%</td><td class="left">'Vlad'</td></tr>
     <tr><td class="num"> 149/1045</td><td class="num"> 30/189</td><td class="num"> 14.51%</td><td class="left">'Chris'</td></tr>
     <tr><td class="num"> 158/1045</td><td class="num"> 20/189</td><td class="num"> 14.42%</td><td class="left">'Turbogurk'</td></tr>
+    <tr><td class="num"> 160/1045</td><td class="num"> 15/189</td><td class="num"> 14.18%</td><td class="left">'AkRa'</td></tr>
     <tr><td class="num"> 156/1045</td><td class="num"> 17/189</td><td class="num"> 14.02%</td><td class="left">'Zak'</td></tr>
+    <tr><td class="num"> 163/1045</td><td class="num"> 10/189</td><td class="num"> 14.02%</td><td class="left">'tjRaven'</td></tr>
     <tr><td class="num"> 164/1045</td><td class="num">  0/189</td><td class="num"> 13.29%</td><td class="left">'Bent'</td></tr>
     <tr><td class="num"> 124/1045</td><td class="num"> 33/189</td><td class="num"> 12.72%</td><td class="left">'joseba'</td></tr>
     <tr><td class="num"> 127/1045</td><td class="num"> 29/189</td><td class="num"> 12.64%</td><td class="left">'ael'</td></tr>
@@ -124,14 +127,16 @@
     <tr><td class="num">  75/1045</td><td class="num"> 12/189</td><td class="num">  7.05%</td><td class="left">'schmusi20'</td></tr>
     <tr><td class="num">  67/1045</td><td class="num"> 19/189</td><td class="num">  6.97%</td><td class="left">'Dvorhagen'</td></tr>
     <tr><td class="num">  57/1045</td><td class="num"> 26/189</td><td class="num">  6.73%</td><td class="left">'Meeve'</td></tr>
+    <tr><td class="num">  65/1045</td><td class="num"> 16/189</td><td class="num">  6.56%</td><td class="left">'Slav'</td></tr>
     <tr><td class="num">  64/1045</td><td class="num"> 16/189</td><td class="num">  6.48%</td><td class="left">'AQZ'</td></tr>
     <tr><td class="num">  59/1045</td><td class="num"> 21/189</td><td class="num">  6.48%</td><td class="left">'AsuCaga'</td></tr>
     <tr><td class="num">  58/1045</td><td class="num"> 19/189</td><td class="num">  6.24%</td><td class="left">'xmouse'</td></tr>
     <tr><td class="num">  67/1045</td><td class="num">  7/189</td><td class="num">  6.00%</td><td class="left">'Joona'</td></tr>
     <tr><td class="num">  54/1045</td><td class="num"> 12/189</td><td class="num">  5.35%</td><td class="left">'Samuel'</td></tr>
+    <tr><td class="num">  47/1045</td><td class="num"> 17/189</td><td class="num">  5.19%</td><td class="left">'crypto_rsa'</td></tr>
     <tr><td class="num">  44/1045</td><td class="num"> 16/189</td><td class="num">  4.86%</td><td class="left">'Agares'</td></tr>
     <tr><td class="num">  39/1045</td><td class="num"> 14/189</td><td class="num">  4.29%</td><td class="left">'jojo'</td></tr>
-    <tr><td class="num">  50/1045</td><td class="num">  1/189</td><td class="num">  4.13%</td><td class="left">'AkRa'</td></tr>
+    <tr><td class="num">  31/1045</td><td class="num"> 10/189</td><td class="num">  3.32%</td><td class="left">'colonel crayon'</td></tr>
     <tr><td class="num">  27/1045</td><td class="num">  5/189</td><td class="num">  2.59%</td><td class="left">'Miel56'</td></tr>
     <tr><td class="num">  23/1045</td><td class="num">  5/189</td><td class="num">  2.27%</td><td class="left">'The red O'</td></tr>
     <tr><td class="num">   7/1045</td><td class="num"> 12/189</td><td class="num">  1.54%</td><td class="left">'Michael'</td></tr>

Modified: feature_branches/hp_lotm/input/table-wr.html
===================================================================
--- feature_branches/hp_lotm/input/table-wr.html	2008-04-06 19:10:27 UTC (rev 1093)
+++ feature_branches/hp_lotm/input/table-wr.html	2008-04-06 19:21:37 UTC (rev 1094)
@@ -1,52 +1,52 @@
   <table>
-    <caption>$$Worldrecord_Statistics$$ $$February$$ 2008</caption>
+    <caption>$$Worldrecord_Statistics$$ $$March$$ 2008</caption>
     <colgroup><col width="80"><col width="80"><col width="470"></colgroup>
     <tr><th>$$total$$</th><th>$$shared$$</th><th class="left">$$user$$</th></tr>
-    <tr><td class="num">931</td><td class="num">260</td><td class="left">'Moneymaker'</td></tr>
-    <tr><td class="num">202</td><td class="num">112</td><td class="left">'Stupid'</td></tr>
-    <tr><td class="num">145</td><td class="num">128</td><td class="left">'Johannes'</td></tr>
-    <tr><td class="num"> 77</td><td class="num"> 50</td><td class="left">'Duffy'</td></tr>
-    <tr><td class="num"> 61</td><td class="num"> 55</td><td class="left">'daydreamer'</td></tr>
-    <tr><td class="num"> 58</td><td class="num"> 55</td><td class="left">'Great Scott'</td></tr>
-    <tr><td class="num"> 57</td><td class="num"> 33</td><td class="left">'Malla'</td></tr>
-    <tr><td class="num"> 41</td><td class="num"> 38</td><td class="left">'Django'</td></tr>
-    <tr><td class="num"> 38</td><td class="num"> 31</td><td class="left">'Iceshark7'</td></tr>
-    <tr><td class="num"> 36</td><td class="num"> 27</td><td class="left">'Zekobah'</td></tr>
-    <tr><td class="num"> 35</td><td class="num"> 29</td><td class="left">'Alexandros'</td></tr>
-    <tr><td class="num"> 33</td><td class="num"> 31</td><td class="left">'joseba'</td></tr>
-    <tr><td class="num"> 28</td><td class="num"> 27</td><td class="left">'Ghatotkacha'</td></tr>
-    <tr><td class="num"> 23</td><td class="num"> 19</td><td class="left">'Ludmian'</td></tr>
-    <tr><td class="num"> 23</td><td class="num"> 20</td><td class="left">'ged'</td></tr>
-    <tr><td class="num"> 21</td><td class="num"> 15</td><td class="left">'Emmanuel'</td></tr>
-    <tr><td class="num"> 21</td><td class="num"> 19</td><td class="left">'Safalra'</td></tr>
-    <tr><td class="num"> 18</td><td class="num">  8</td><td class="left">'ryujun'</td></tr>
-    <tr><td class="num"> 18</td><td class="num"> 16</td><td class="left">'B-Huff'</td></tr>
-    <tr><td class="num"> 17</td><td class="num"> 14</td><td class="left">'HuB34'</td></tr>
+    <tr><td class="num">977</td><td class="num">240</td><td class="left">'Moneymaker'</td></tr>
+    <tr><td class="num">165</td><td class="num"> 96</td><td class="left">'Stupid'</td></tr>
+    <tr><td class="num">126</td><td class="num">115</td><td class="left">'Johannes'</td></tr>
+    <tr><td class="num"> 73</td><td class="num"> 57</td><td class="left">'daydreamer'</td></tr>
+    <tr><td class="num"> 62</td><td class="num"> 43</td><td class="left">'Duffy'</td></tr>
+    <tr><td class="num"> 48</td><td class="num"> 31</td><td class="left">'Malla'</td></tr>
+    <tr><td class="num"> 47</td><td class="num"> 46</td><td class="left">'Great Scott'</td></tr>
+    <tr><td class="num"> 36</td><td class="num"> 30</td><td class="left">'dev0'</td></tr>
+    <tr><td class="num"> 36</td><td class="num"> 34</td><td class="left">'Django'</td></tr>
+    <tr><td class="num"> 35</td><td class="num"> 27</td><td class="left">'Zekobah'</td></tr>
+    <tr><td class="num"> 34</td><td class="num"> 29</td><td class="left">'Iceshark7'</td></tr>
+    <tr><td class="num"> 32</td><td class="num"> 26</td><td class="left">'Alexandros'</td></tr>
+    <tr><td class="num"> 30</td><td class="num"> 29</td><td class="left">'joseba'</td></tr>
+    <tr><td class="num"> 29</td><td class="num"> 15</td><td class="left">'ryujun'</td></tr>
+    <tr><td class="num"> 27</td><td class="num"> 26</td><td class="left">'Ghatotkacha'</td></tr>
+    <tr><td class="num"> 20</td><td class="num"> 15</td><td class="left">'Emmanuel'</td></tr>
+    <tr><td class="num"> 20</td><td class="num"> 17</td><td class="left">'Ludmian'</td></tr>
+    <tr><td class="num"> 20</td><td class="num"> 18</td><td class="left">'ged'</td></tr>
+    <tr><td class="num"> 20</td><td class="num"> 19</td><td class="left">'Safalra'</td></tr>
+    <tr><td class="num"> 19</td><td class="num"> 17</td><td class="left">'B-Huff'</td></tr>
     <tr><td class="num"> 17</td><td class="num"> 17</td><td class="left">'bojster'</td></tr>
-    <tr><td class="num"> 16</td><td class="num"> 16</td><td class="left">'ABS'</td></tr>
-    <tr><td class="num"> 14</td><td class="num">  7</td><td class="left">'Ronald'</td></tr>
+    <tr><td class="num"> 16</td><td class="num">  8</td><td class="left">'Ronald'</td></tr>
+    <tr><td class="num"> 16</td><td class="num"> 14</td><td class="left">'HuB34'</td></tr>
+    <tr><td class="num"> 15</td><td class="num"> 15</td><td class="left">'ABS'</td></tr>
     <tr><td class="num"> 11</td><td class="num">  8</td><td class="left">'Chocolate Zero'</td></tr>
-    <tr><td class="num"> 11</td><td class="num">  9</td><td class="left">'dev0'</td></tr>
     <tr><td class="num"> 10</td><td class="num">  6</td><td class="left">'Taztunes'</td></tr>
-    <tr><td class="num"> 10</td><td class="num"> 10</td><td class="left">'fabian'</td></tr>
     <tr><td class="num">  9</td><td class="num">  5</td><td class="left">'ShadowPhrogg32642342'</td></tr>
     <tr><td class="num">  9</td><td class="num">  6</td><td class="left">'Gloop'</td></tr>
-    <tr><td class="num">  7</td><td class="num">  2</td><td class="left">'Breezy'</td></tr>
-    <tr><td class="num">  7</td><td class="num">  6</td><td class="left">'dpl' + 'Edgar_Flesk'</td></tr>
+    <tr><td class="num">  9</td><td class="num">  9</td><td class="left">'fabian'</td></tr>
+    <tr><td class="num">  8</td><td class="num">  8</td><td class="left">'dpl'</td></tr>
+    <tr><td class="num">  7</td><td class="num">  6</td><td class="left">'Edgar_Flesk'</td></tr>
+    <tr><td class="num">  6</td><td class="num">  2</td><td class="left">'Breezy'</td></tr>
     <tr><td class="num">  6</td><td class="num">  3</td><td class="left">'para_doks'</td></tr>
     <tr><td class="num">  6</td><td class="num">  4</td><td class="left">'Lukas'</td></tr>
-    <tr><td class="num">  6</td><td class="num">  5</td><td class="left">'Guglielmo' + 'U-Punkt'</td></tr>
+    <tr><td class="num">  6</td><td class="num">  5</td><td class="left">'Guglielmo'</td></tr>
     <tr><td class="num">  6</td><td class="num">  6</td><td class="left">'Tobias' + 'Wuzzy'</td></tr>
     <tr><td class="num">  5</td><td class="num">  4</td><td class="left">'Angolino'</td></tr>
     <tr><td class="num">  5</td><td class="num">  5</td><td class="left">'Raoul' + 'Cyphase' + 'Thomas' + 'Chris' + 'Ralf'</td></tr>
-    <tr><td class="num">  4</td><td class="num">  2</td><td class="left">'Bent' + 'Craven'</td></tr>
-    <tr><td class="num">  4</td><td class="num">  4</td><td class="left">'J3FF'</td></tr>
-    <tr><td class="num">  3</td><td class="num">  2</td><td class="left">'Stephanie' + 'Daisy'</td></tr>
+    <tr><td class="num">  4</td><td class="num">  2</td><td class="left">'Bent'</td></tr>
+    <tr><td class="num">  4</td><td class="num">  4</td><td class="left">'U-Punkt' + 'J3FF'</td></tr>
+    <tr><td class="num">  3</td><td class="num">  2</td><td class="left">'Craven' + 'colonel crayon' + 'Stephanie'</td></tr>
     <tr><td class="num">  3</td><td class="num">  3</td><td class="left">'geembo_90' + 'Neophilus' + 'Andy'</td></tr>
-    <tr><td class="num">  2</td><td class="num">  0</td><td class="left">'Ale'</td></tr>
-    <tr><td class="num">  2</td><td class="num">  1</td><td class="left">'mrduke' + 'Daniel' + 'oblo'</td></tr>
-    <tr><td class="num">  2</td><td class="num">  2</td><td class="left">'Drotten' + 'Sim_Ed' + 'hendrik' + 'Austin' + 'Snaily' + 'Ingo' + 'serpent'</td></tr>
-    <tr><td class="num">  1</td><td class="num">  0</td><td class="left">'Gorn' + 'Nat'</td></tr>
-    <tr><td class="num">  1</td><td class="num">  1</td><td class="left">'alfred69' + 'Agares' + 'ntaeijr' + 'Tiger' + 'Zak' + 'Tiza' + 'niebie' + 'Andreas' + 'Samuel' + 'Mark P.' + 'jdcampo' + 'hdwow' + 'B-man' + 'Asbel' + 'Vlad' + 'Vaily' + 'Hans-HD' + 'krazy62' + 'JuSt'</td></tr>
-    <tr><td class="num">  0</td><td class="num">  0</td><td class="left">'AQZ' + 'Miel56' + 'Alf' + 'Turbogurk' + 'Gottseinsohn' + 'ael' + 'biotopa' + 'brynn' + 'IntKecsk' + 'Davacardo' + 'Adonica' + 'Joona' + 'Sandra' + 'schmusi20' + 'Kosby' + 'Magnus and Susi' + 'WP319' + 'Kevin' + 'xmouse' + 'erich' + 'Vinksu' + 'Uli' + 'Alex' + 'Little_Mole' + 'Harry Lim' + 'AkRa' + 'Momcat' + 'NorthForty' + 'Mecki' + 'The red O' + 'Jeffrey S' + 'Nfol' + 'Marc-Hendrik' + 'shoki' + 'jojo' + 'Klaus' + 'Valkyrie2' + 'MicWa' + 'AsuCaga' + 'Rugby4ever' + 'Archcorenth' + 'Meeve' + 'mhatta' + 'mecke' + 'Dvorhagen' + 'Antonio EE' + 'Holger' + 'Ingo_K' + 'Ant' + 'Melanie' + 'IChrisI' + 'redsantz' + 'Markus' + 'Liam Sheehan' + 'Michael' + 'Tarim' + 'Agnieszka'</td></tr>
+    <tr><td class="num">  2</td><td class="num">  1</td><td class="left">'mrduke' + 'Daniel' + 'Slav' + 'tjRaven'</td></tr>
+    <tr><td class="num">  2</td><td class="num">  2</td><td class="left">'Drotten' + 'Sim_Ed' + 'hendrik' + 'Austin' + 'Snaily' + 'Antonio EE' + 'Ingo' + 'serpent'</td></tr>
+    <tr><td class="num">  1</td><td class="num">  0</td><td class="left">'Ale' + 'Gorn' + 'Nat' + 'Daisy'</td></tr>
+    <tr><td class="num">  1</td><td class="num">  1</td><td class="left">'alfred69' + 'Agares' + 'ntaeijr' + 'Tiger' + 'Zak' + 'Tiza' + 'niebie' + 'Andreas' + 'Samuel' + 'Mark P.' + 'oblo' + 'hdwow' + 'B-man' + 'Asbel' + 'Vlad' + 'Vaily' + 'krazy62' + 'JuSt'</td></tr>
+    <tr><td class="num">  0</td><td class="num">  0</td><td class="left">'AQZ' + 'Miel56' + 'Alf' + 'Turbogurk' + 'Gottseinsohn' + 'ael' + 'biotopa' + 'brynn' + 'IntKecsk' + 'Davacardo' + 'Adonica' + 'Joona' + 'Sandra' + 'schmusi20' + 'Kosby' + 'Magnus and Susi' + 'WP319' + 'Kevin' + 'xmouse' + 'erich' + 'Vinksu' + 'Uli' + 'Alex' + 'jdcampo' + 'Freshman' + 'Little_Mole' + 'crypto_rsa' + 'Harry Lim' + 'AkRa' + 'Momcat' + 'NorthForty' + 'Mecki' + 'The red O' + 'Jeffrey S' + 'Nfol' + 'Marc-Hendrik' + 'shoki' + 'jojo' + 'Klaus' + 'Valkyrie2' + 'MicWa' + 'AsuCaga' + 'Rugby4ever' + 'Archcorenth' + 'Meeve' + 'mhatta' + 'Hans-HD' + 'mecke' + 'Dvorhagen' + 'Holger' + 'Ingo_K' + 'Ant' + 'Melanie' + 'IChrisI' + 'redsantz' + 'Markus' + 'Liam Sheehan' + 'Michael' + 'Tarim' + 'Agnieszka'</td></tr>
   </table>

Modified: feature_branches/hp_lotm/input/userlist.html
===================================================================
--- feature_branches/hp_lotm/input/userlist.html	2008-04-06 19:10:27 UTC (rev 1093)
+++ feature_branches/hp_lotm/input/userlist.html	2008-04-06 19:21:37 UTC (rev 1094)
@@ -31,7 +31,9 @@
     <li>brynn</li>
     <li>Chocolate Zero</li>
     <li>Chris</li>
+    <li>colonel crayon</li>
     <li>Craven</li>
+    <li>crypto_rsa</li>
     <li>Cyphase</li>
     <li>Daisy</li>
     <li>Daniel</li>
@@ -47,6 +49,7 @@
     <li>Emmanuel</li>
     <li>erich</li>
     <li>fabian</li>
+    <li>Freshman</li>
     <li>ged</li>
     <li>geembo_90</li>
     <li>Ghatotkacha</li>
@@ -120,6 +123,7 @@
     <li>ShadowPhrogg32642342</li>
     <li>shoki</li>
     <li>Sim_Ed</li>
+    <li>Slav</li>
     <li>Snaily</li>
     <li>Stephanie</li>
     <li>Stupid</li>
@@ -129,6 +133,7 @@
     <li>Thomas</li>
     <li>Tiger</li>
     <li>Tiza</li>
+    <li>tjRaven</li>
     <li>Tobias</li>
     <li>Turbogurk</li>
     <li>Uli</li>



From ged at mail.berlios.de  Sun Apr  6 21:48:30 2008
From: ged at mail.berlios.de (ged at mail.berlios.de)
Date: Sun, 6 Apr 2008 21:48:30 +0200
Subject: [Enigma-game-svn] r1095 - homepage/input
Message-ID: <200804061948.m36JmUpj013715@sheep.berlios.de>

Author: ged
Date: 2008-04-06 21:48:28 +0200 (Sun, 06 Apr 2008)
New Revision: 1095

Modified:
   homepage/input/infobox_ru.html
Log:
Homepage: infobox_ru localization

Modified: homepage/input/infobox_ru.html
===================================================================
--- homepage/input/infobox_ru.html	2008-04-06 19:21:37 UTC (rev 1094)
+++ homepage/input/infobox_ru.html	2008-04-06 19:48:28 UTC (rev 1095)
@@ -12,7 +12,7 @@
            <a href="$$lotm_current$$">&quot;$$lotm_current_name$$&quot;</a>
          </div>
 
-         <h3>April Fool's Day '08</h3>
+         <h3>?????? ?????? '08</h3>
          <a href="$$april_2008$$"><img src="$$imagedir$$/articles/april_2008.png"
          alt="$$lotm_expansion$$" border="0"></a>
          <div class="imagetitle">



From ral at mail.berlios.de  Tue Apr  8 23:08:19 2008
From: ral at mail.berlios.de (ral at BerliOS)
Date: Tue, 8 Apr 2008 23:08:19 +0200
Subject: [Enigma-game-svn] r1096 - in trunk: data data/schemas src src/stones
Message-ID: <200804082108.m38L8J7Q012397@sheep.berlios.de>

Author: ral
Date: 2008-04-08 23:08:17 +0200 (Tue, 08 Apr 2008)
New Revision: 1096

Modified:
   trunk/data/api1init.lua
   trunk/data/models-2d.lua
   trunk/data/schemas/objects.xml
   trunk/src/WorldProxy.cc
   trunk/src/items.cc
   trunk/src/ox_extra.cc
   trunk/src/ox_magnum.cc
   trunk/src/ox_oxyd1.cc
   trunk/src/ox_peroxyd.cc
   trunk/src/oxyd.cc
   trunk/src/stones/CoinSlot.cc
   trunk/src/stones/CoinSlot.hh
Log:
Trunk 1.1: new API reengineering Coinslot, Coin
- fix it_magnet - strength, range attributes set prior grid set
- it-coin* to it_coin_s, it_coin_m, it_coin_l - a single class
- coins have no longer a value, but coinslots have attributes
  interval_s, interval_m, interval_l
- coinslot with instant attribute/variation
  - instant false (default) gets active after coin insertion, next coin
      insertable after last one finished its insertion animation.
  - instant true: immediately active on coin insertion, accepts coins
      at any frequency
- coinslot fully swappable in any state
- coinslot state is read only, no "on" messages, etc are accepted
- oxyd magnum activation of levels 110,121,126,127,128,129,159,166,181,182


Modified: trunk/data/api1init.lua
===================================================================
--- trunk/data/api1init.lua	2008-04-06 19:48:28 UTC (rev 1095)
+++ trunk/data/api1init.lua	2008-04-08 21:08:17 UTC (rev 1096)
@@ -47,6 +47,9 @@
 RenamingObjectsNew2Old = {
     it_blocker = "it-blocker",
     it_blocker_new = "it-blocker-new",
+    it_coin_s = "it-coin1",
+    it_coin_m = "it-coin2",
+    it_coin_l = "it-coin4",
     it_extralife = "it-extralife",
     it_hammer = "it-hammer",
     it_magnet = "it-magnet",
@@ -240,6 +243,9 @@
      if key == "on" then
          _key = "state"
      end
+     if key == "value" then
+         _key = "coin_value"
+     end
      if key == "targetx" then
          local d = enigma._GetAttrib(obj, "destination")
          if (en.usertype(d) == "position") then
@@ -294,6 +300,9 @@
      if key == "delay" then
          _key = "interval"
      end
+     if key == "value" then
+         _key = "coin_value"
+     end
      if key == "blackball" or key == "whiteball" then
          _key = "color"
      end

Modified: trunk/data/models-2d.lua
===================================================================
--- trunk/data/models-2d.lua	2008-04-06 19:48:28 UTC (rev 1095)
+++ trunk/data/models-2d.lua	2008-04-08 21:08:17 UTC (rev 1096)
@@ -395,9 +395,6 @@
         "it-booze-broken",
         "it-brush",
         "it-cherry",
-        "it-coin1",
-        "it-coin2",
-        "it-coin4",
         "it-cross",
         "it-document",
         "it-drop",
@@ -436,6 +433,9 @@
     DefImages(itemlist)
 
     DefImage("it-brake", {filename="st-brake"})
+    DefImage("it_coin_s", {filename="it-coin1"})
+    DefImage("it_coin_m", {filename="it-coin2"})
+    DefImage("it_coin_l", {filename="it-coin4"})
     DefImage("it_extralife", {filename="it-extralife"})
     DefImage("it_hammer", {filename="it-hammer"})
     DefImage("it_sword", {filename="it-sword"})

Modified: trunk/data/schemas/objects.xml
===================================================================
--- trunk/data/schemas/objects.xml	2008-04-06 19:48:28 UTC (rev 1095)
+++ trunk/data/schemas/objects.xml	2008-04-08 21:08:17 UTC (rev 1096)
@@ -4,6 +4,7 @@
     <attr name="action" type="tokens" default="nil" rw="rw"/>
     <attr name="autoclose" type="bool" default="false" rw="rw"/>
     <attr name="cluster" type="int" default="nil" min="0" max="1" rw="rw"/>
+    <attr name="coin_value" type="double" default="1" rw="rw"/>
     <attr name="color" type="int" default="nil" min="0" max="1" rw="rw"/>
     <attr name="connections" type="string" default="nil" rw="rw"/>
     <attr name="counterclock" type="bool" default="false" rw="rw"/>
@@ -11,6 +12,9 @@
     <attr name="faces" type="string" default="nil" rw="rw"/>
     <attr name="instant" type="bool" default="false" rw="rw"/>
     <attr name="interval" type="double" default="1" rw="rw"/>
+    <attr name="interval_s" type="double" default="3" rw="rw"/>
+    <attr name="interval_m" type="double" default="6" rw="rw"/>
+    <attr name="interval_l" type="double" default="12" rw="rw"/>
     <attr name="inverse" type="bool" default="false" rw="rw"/>
     <attr name="invisible" type="bool" default="false" rw="rw"/>
     <attr name="loop" type="bool" default="true" rw="rw"/>
@@ -71,6 +75,19 @@
     </object>
     <object name="it_blocker_new" init="true">
     </object>
+    <object name="it_coin">
+      <attr name="coin_value" default="3"/>
+      <attr name="state" rw="r"/>
+    </object>
+    <object name="it_coin_s">
+      <attr name="state" value="0"/>
+    </object>
+    <object name="it_coin_m">
+      <attr name="state" value="1"/>
+    </object>
+    <object name="it_coin_l">
+      <attr name="state" value="2"/>
+    </object>
     <object name="it_extralife"/>
     <object name="it_extralife_new" init="true"/>
     <object name="it_hammer"/>
@@ -242,6 +259,16 @@
     <object name="st_brick_nesw">
       <attr name="connections" value="nesw"/>
     </object>
+    <object name="st_coinslot">
+      <attr name="instant"/>
+      <attr name="interval_s"/>
+      <attr name="interval_m"/>
+      <attr name="interval_l"/>
+      <attr name="state" rw="r"/>
+    </object>
+    <object name="st_coinslot_instant">
+      <attr name="instant" value="true"/>
+    </object>
     <object name="st_floppy">
       <msg name="on"/>
       <msg name="off"/>

Modified: trunk/src/WorldProxy.cc
===================================================================
--- trunk/src/WorldProxy.cc	2008-04-06 19:48:28 UTC (rev 1095)
+++ trunk/src/WorldProxy.cc	2008-04-08 21:08:17 UTC (rev 1096)
@@ -117,20 +117,24 @@
             server::HoleForce = val;
         } else if (key == "IceFriction") {
             server::IceFriction = val;
-        } else if (key == "MagnetForce") {
+        } else if (key == "MagnetStrength") {
             server::MagnetForce = val;
+            BroadcastMessage("_updateglobals", "it_magnet", GRID_ITEMS_BIT);
         } else if (key == "MagnetRange") {
             server::MagnetRange = val;
+            BroadcastMessage("_updateglobals", "it_magnet", GRID_ITEMS_BIT);
         } else if (key == "SlopeForce") {
             server::SlopeForce = val;
         } else if (key == "SwampSinkSpeed") {
             server::SwampSinkSpeed = val;
         } else if (key == "WaterSinkSpeed") {
             server::WaterSinkSpeed = val;
-        } else if (key == "WormholeForce") {
+        } else if (key == "WormholeStrength") {
             server::WormholeForce = val;
+            BroadcastMessage("_updateglobals", "it_wormhole", GRID_ITEMS_BIT);
         } else if (key == "WormholeRange") {
             server::WormholeRange = val;
+            BroadcastMessage("_updateglobals", "it_wormhole", GRID_ITEMS_BIT);
         }
     }
 

Modified: trunk/src/items.cc
===================================================================
--- trunk/src/items.cc	2008-04-06 19:48:28 UTC (rev 1095)
+++ trunk/src/items.cc	2008-04-08 21:08:17 UTC (rev 1096)
@@ -666,66 +666,69 @@
 
 /* -------------------- Coins -------------------- */
 
-// :value    1,2,4: how many time-units this coin buys
-namespace
-{
-    class Coin1 : public Item {
-        CLONEOBJ(Coin1);
-        DECL_TRAITS;
+// TODO id renaming when names are stable
 
-        void processLight(Direction d) {
-            sound_event ("itemtransform");
-            transform("it_umbrella_new");
-        }
+    class Coin : public Item {
+        CLONEOBJ(Coin);
+        DECL_TRAITS_ARRAY(3, state);
 
-        void on_stonehit(Stone *) {
-            replace(it_coin2);
-        }
+    public:
+        Coin(int type);
+        static void setup();
+        
+        // Object interface
+        virtual std::string getClass() const;
 
-    public:
-        Coin1() {
-            setAttr("value", 3.0);
-        }
+        // GridObject interface
+        virtual void processLight(Direction d);
+        
+        // Item interface
+        virtual void on_stonehit(Stone *st);
     };
-    DEF_TRAITS(Coin1, "it-coin1", it_coin1);
+    
+    void Coin::setup() {
+        RegisterItem (new Coin(0));
+        RegisterItem (new Coin(1));
+        RegisterItem (new Coin(2));
+    }
 
-    class Coin2 : public Item {
-        CLONEOBJ(Coin2);
-        DECL_TRAITS;
-
-        void processLight(Direction d) {
-            sound_event ("itemtransform");
-            transform("it_hammer_new");
+    Coin::Coin(int type) {
+        state = type;
+        setAttr("coin_value", state == 0 ? 3.0 : (state == 1 ? 6.0 : 12.0));
+    }
+    
+    std::string Coin::getClass() const {
+        return "Coin";
+    }
+    
+    void Coin::processLight(Direction d) {
+        sound_event("itemtransform");
+        switch (state) {
+            case 0 : 
+                transform("it_umbrella_new"); break;
+            case 1 :
+                transform("it_hammer_new"); break;
+            case 2 :
+                transform("it_extralife_new"); break;
         }
+    }
 
-        void on_stonehit(Stone *) {
-            replace(it_coin4);
+    void Coin::on_stonehit(Stone *) {
+        if (state <= 1) {
+            state += 1;
+            init_model();
         }
 
-    public:
-        Coin2() {
-            setAttr("value", 6.0);
-        }
+    }
+    
+    ItemTraits Coin::traits[3] = {
+        {"it_coin_s",  it_coin1,  itf_none, 0.0},
+        {"it_coin_m",  it_coin2,  itf_none, 0.0},
+        {"it_coin_l",  it_coin4,  itf_none, 0.0},
     };
-    DEF_TRAITS(Coin2, "it-coin2", it_coin2);
+    
 
-    class Coin4 : public Item {
-        CLONEOBJ(Coin4);
-        DECL_TRAITS;
 
-        void processLight(Direction d) {
-            sound_event ("itemtransform");
-            transform("it_extralife_new");
-        }
-    public:
-        Coin4() {
-            setAttr("value", 12.0);
-        }
-    };
-    DEF_TRAITS(Coin4, "it-coin4", it_coin4);
-}
-
-
 /* -------------------- Hills and Hollows -------------------- */
 
 /** \page it-hills Hills and Hollows
@@ -1814,8 +1817,8 @@
             squareRange = range * range;
         } else if (key == "strength") {
             correctedStrength = 0.6 * ((val.getType() == Value::NIL) ? server::MagnetForce : (double)val);
-        } else
-            Item::setAttr(key, val);
+        }
+        Item::setAttr(key, val);
     }
     
     Value Magnet::message(const Message &m) {
@@ -3944,9 +3947,7 @@
     RegisterItem (new ChangeFloorItem);
     RegisterItem (new Cherry);
     RegisterItem (new Coffee);
-    RegisterItem (new Coin1);
-    RegisterItem (new Coin2);
-    RegisterItem (new Coin4);
+    Coin::setup();
     Crack::setup();
     RegisterItem (new Cross);
     RegisterItem (new Death);

Modified: trunk/src/ox_extra.cc
===================================================================
--- trunk/src/ox_extra.cc	2008-04-06 19:48:28 UTC (rev 1095)
+++ trunk/src/ox_extra.cc	2008-04-08 21:08:17 UTC (rev 1096)
@@ -222,7 +222,7 @@
     UNUSED,              // OxydExtra stone 0x61
     UNUSED,              // OxydExtra stone 0x62
     UNUSED,              // OxydExtra stone 0x63
-    "st_coinslot",       // OxydExtra stone 0x64
+    "st_coinslot_instant", // OxydExtra stone 0x64
     "st-thief",          // OxydExtra stone 0x65
     "st-shogun-s",       // OxydExtra stone 0x66
     UNUSED,              // OxydExtra stone 0x67

Modified: trunk/src/ox_magnum.cc
===================================================================
--- trunk/src/ox_magnum.cc	2008-04-06 19:48:28 UTC (rev 1095)
+++ trunk/src/ox_magnum.cc	2008-04-08 21:08:17 UTC (rev 1096)
@@ -228,7 +228,7 @@
     UNUSED,                     // OxydMagnum stone 0x67
     "st-bombs",                 // OxydMagnum stone 0x68 (common was 'st-shogun-l')
     "st-flash",                 // OxydMagnum stone 0x69
-    "st_coinslot",              // OxydMagnum stone 0x6a
+    "st_coinslot_instant",      // OxydMagnum stone 0x6a
     "st-thief",                 // OxydMagnum stone 0x6b
     "st-shogun-s",              // OxydMagnum stone 0x6c
     "st-stoneimpulse",          // OxydMagnum stone 0x6d

Modified: trunk/src/ox_oxyd1.cc
===================================================================
--- trunk/src/ox_oxyd1.cc	2008-04-06 19:48:28 UTC (rev 1095)
+++ trunk/src/ox_oxyd1.cc	2008-04-08 21:08:17 UTC (rev 1096)
@@ -258,7 +258,7 @@
     "st-disco-light",           // Oxyd1 stone 0x67
     "st-bombs",                 // Oxyd1 stone 0x68
     "st-flash",                 // Oxyd1 stone 0x69
-    "st_coinslot",              // Oxyd1 stone 0x6a
+    "st_coinslot_instant",      // Oxyd1 stone 0x6a
     "st-thief",                 // Oxyd1 stone 0x6b
     "st-shogun-s",              // Oxyd1 stone 0x6c
     "st-stoneimpulse",          // Oxyd1 stone 0x6d

Modified: trunk/src/ox_peroxyd.cc
===================================================================
--- trunk/src/ox_peroxyd.cc	2008-04-06 19:48:28 UTC (rev 1095)
+++ trunk/src/ox_peroxyd.cc	2008-04-08 21:08:17 UTC (rev 1096)
@@ -294,7 +294,7 @@
     "st-disco-medium",          // PerOxyd stone 0x61
     "st-bombs",                 // PerOxyd stone 0x62
     "st-flash",                 // PerOxyd stone 0x63
-    "st_coinslot",              // PerOxyd stone 0x64
+    "st_coinslot_instant",      // PerOxyd stone 0x64
     "st-thief",                 // PerOxyd stone 0x65
     "st-shogun-s",              // PerOxyd stone 0x66
     "st-shogun-m",              // PerOxyd stone 0x67

Modified: trunk/src/oxyd.cc
===================================================================
--- trunk/src/oxyd.cc	2008-04-06 19:48:28 UTC (rev 1095)
+++ trunk/src/oxyd.cc	2008-04-08 21:08:17 UTC (rev 1096)
@@ -856,7 +856,7 @@
 
 LP_OxydMagnum::LP_OxydMagnum(OxydVersion version, DatFile *dat)
 : LevelPack_Oxyd (version, dat, 0, 
-                  (version==OxydVersion_OxydMagnumGold) ? 120 : 99, 
+                  (version==OxydVersion_OxydMagnumGold) ? 120 : 182, 
                   false)
 {
 }

Modified: trunk/src/stones/CoinSlot.cc
===================================================================
--- trunk/src/stones/CoinSlot.cc	2008-04-06 19:48:28 UTC (rev 1095)
+++ trunk/src/stones/CoinSlot.cc	2008-04-08 21:08:17 UTC (rev 1096)
@@ -20,54 +20,122 @@
  */
 
 #include "stones/CoinSlot.hh"
-#include "server.hh"
+#include "errors.hh"
 #include "Inventory.hh"
+#include "main.hh"
 #include "player.hh"
-#include "errors.hh"
+#include "server.hh"
 
 namespace enigma {
-    CoinSlot::CoinSlot() : Stone () {
+    CoinSlot::CoinSlot(bool isInstant) : Stone() {
+        if (isInstant)
+            objFlags |= OBJBIT_INSTANT;
         state = OFF;
-        remaining_time = 0;
+        setAttr("$addTime", 0);
     }
 
     CoinSlot::~CoinSlot() {
         GameTimer.remove_alarm (this);
     }
 
+    std::string CoinSlot::getClass() const {
+        return "st_coinslot";
+    }
+
+    Value CoinSlot::getAttr(const std::string &key) const {
+        if (key == "instant") {
+            return (bool)(objFlags & OBJBIT_INSTANT != 0);
+        }
+        return Stone::getAttr(key);
+    }
+    
+    void CoinSlot::setAttr(const string& key, const Value &val) {
+        if (key == "instant") {
+            if (val.to_bool())
+                objFlags |= OBJBIT_INSTANT;
+            else
+                objFlags &= ~OBJBIT_INSTANT;
+            return;
+        }
+        Stone::setAttr(key, val);
+    }
+
+    Value CoinSlot::message(const Message &m) {
+        if (m.message == "_model_reanimated") {
+            // we are swapped - may be that an alarm switched off the slot meanwhile
+            if (state <= ON)
+                init_model();  // replace potential bogus model
+        }
+        return Stone::message(m);
+    }
+
     int CoinSlot::externalState() const {
-        return state % 2; // 0 for OFF, TURNON, 1 for ON
+        return state % 2; 
     }
 
     void CoinSlot::setState(int extState) {
-        if (isDisplayable()) {
-            if (extState == 0)
-                setIState(OFF);
-            else if (extState == 1)
-                setIState(ON);
-        } else
-            state = extState;
+        return;   // ignore any write attempts
     }
 
     void CoinSlot::init_model() {
-        set_model(state==ON ? "st-coinslot-active" : "st-coinslot");
+        // just static models
+        if (state <= ON)
+            set_model(state==ON ? "st-coinslot-active" : "st-coinslot");
     }
 
     void CoinSlot::animcb() {
-        setIState(ON);
+        ASSERT(state >= INSERT_OFF, XLevelRuntime, "Coinslot - animcb on wrong state");
+        double rest = GameTimer.remove_alarm(this);   // stop alarm
+        iState newIState = ON;                        // standard follow up state
+        if (!(objFlags & OBJBIT_INSTANT)) {
+            // start or update timer
+            rest += (double)getAttr("$addTime");
+            setAttr("$addTime", 0);
+        } else { // instant
+            if (rest == 0)
+                // the coin value is less than the animation time 
+                newIState = OFF;
+        }
+        if (rest > 0)
+            GameTimer.set_alarm(this, (double)getAttr("$addTime") + rest, false);
+        setIState(newIState);
     }
 
     void CoinSlot::actor_hit(const StoneContact &sc) {
+        // no coin insert if instant and coin is currently being inserted 
+        if (state >= INSERT_OFF && !(objFlags & OBJBIT_INSTANT))
+            return;
+            
         if (enigma::Inventory *inv = player::GetInventory(sc.actor)) {
-            if (Item *it = inv->get_item (0)) {
+            if (Item *it = inv->get_item(0)) {
                 ItemID id = get_id(it);
                 if (id == it_coin1 || id == it_coin2 || id == it_coin4) {
-                    double coin_value = it->getAttr("value");
-                    remaining_time += coin_value;
+                    double interval;
+                    if (server::EnigmaCompatibility < 1.10) 
+                        interval = it->getAttr("coin_value");
+                    else 
+                        switch (id) {
+                            case it_coin1:
+                                interval = getAttr("interval_s"); break;
+                            case it_coin2:
+                                interval = getAttr("interval_m"); break;
+                            case it_coin4:
+                                interval = getAttr("interval_l"); break;
+                        }
+                    
+                    if (objFlags & OBJBIT_INSTANT) {
+                        // start or update timer
+                        double rest = GameTimer.remove_alarm(this);
+                        GameTimer.set_alarm(this, interval + rest, false);
+                    } else {
+                        // remember time value for animcb evaluation
+                        setAttr("$addTime", (double)getAttr("$addTime") + interval);
+                    }
                     inv->yield_first();
-                    player::RedrawInventory (inv);
+                    player::RedrawInventory(inv);
                     delete it;
-                    setIState(TURNON);
+                    
+                    setIState((objFlags & OBJBIT_INSTANT) ? INSERT_ON : (iState)(state + 2));
                 }
             }
         }
@@ -77,51 +145,74 @@
          return "metal";
     }
 
-    void CoinSlot::tick(double dtime) {
-        ASSERT(remaining_time > 0, XLevelRuntime, "CoinSlot: tick called, but no remaining time");
-
-        remaining_time -= dtime;
-        if (remaining_time <= 0)
-            setIState(OFF);
+    void CoinSlot::alarm() {
+        ASSERT((state & 1) == ON, XLevelRuntime, "Coinslot - alarm of not active slot");
+        setIState(state == ON ? OFF : INSERT_OFF);
     }
-
+    
     void CoinSlot::setIState(iState newIState) {
-        if (newIState == ON) {
-            if (state == TURNON) {
-                state = ON;
-                performAction(state == ON);
-                GameTimer.activate(this);
-            }
-            else if (state == ON) {
-                // state is already ON, this was just a "coin-supply"
-                // Do nothing but change the model
-            }
-            init_model();
+        bool doAction = false;
+        bool actionValue = false;
+        bool doInit = false;
+        
+        Log << "Coinslot state change from " << state << " to " << newIState << "\n";
+        switch (state) {
+            case OFF :
+                ASSERT(newIState != ON, XLevelRuntime, "Coinslot - illegal state change from OFF to ON");
+                actionValue = true;
+                doAction = (newIState == INSERT_ON);
+                set_anim("st-coin2slot");
+                break;
+            case ON :
+                if (newIState == INSERT_ON)
+                    set_anim("st-coin2slot");
+                else if (newIState == OFF) {
+                    actionValue = false;
+                    doAction = true;
+                    doInit = true;
+                } else
+                    ASSERT(false , XLevelRuntime, "Coinslot - illegal state change from ");
+                break;
+            case INSERT_OFF:
+                ASSERT(newIState == ON, XLevelRuntime, "Coinslot - illegal state change from ");
+                doInit = true;
+                actionValue = true;
+                doAction = true;
+                break;
+            case INSERT_ON :
+                switch (newIState) {
+                    case INSERT_ON :
+                        set_anim("st-coin2slot");  // may restart anim!
+                        break;
+                    case ON :
+                        doInit = true;
+                        break;
+                    case OFF :
+                        doInit = true;
+                        // fall through
+                    case INSERT_OFF :  // continue insert animation
+                        actionValue = false;
+                        doAction = true;
+                        break;
+                }
+                break;
         }
-        else if (newIState == TURNON) {
-            if (state == OFF) {
-                state = TURNON;
-            }
-            else if (state == ON) {
-                // state is already ON, this was just a "coin-supply"
-                // Do nothing but play the anim
-            }
-            sound_event ("coinsloton");
-            set_anim("st-coin2slot");
-        }
-        else if (newIState == OFF) {
-            state = OFF;
-            performAction(state == ON);
-            GameTimer.deactivate(this);
-            sound_event ("coinslotoff");
+        
+        state = newIState;
+
+        if (doInit && isDisplayable())
             init_model();
-        }
+        
+        if (doAction)
+           performAction(actionValue);
+                
     }
 
     DEF_TRAITS(CoinSlot, "st_coinslot", st_coinslot);
 
     BOOT_REGISTER_START
-        BootRegister(new CoinSlot(), "st_coinslot");
+        BootRegister(new CoinSlot(false), "st_coinslot");
+        BootRegister(new CoinSlot(true), "st_coinslot_instant");
     BOOT_REGISTER_END
 
 } // namespace enigma

Modified: trunk/src/stones/CoinSlot.hh
===================================================================
--- trunk/src/stones/CoinSlot.hh	2008-04-06 19:48:28 UTC (rev 1095)
+++ trunk/src/stones/CoinSlot.hh	2008-04-08 21:08:17 UTC (rev 1096)
@@ -37,13 +37,28 @@
         CLONEOBJ(CoinSlot);
         DECL_TRAITS;
     private:
-        enum iState { OFF, ON, TURNON };
-        double remaining_time;
+        enum iState { 
+            OFF, 
+            ON,
+            INSERT_OFF,   ///< coin is currently inserted, switch is still off if not instant
+                          ///< this state does not exist for instant switches
+            INSERT_ON     ///< coin is currently inserted while switch in on
+        };
+        
+        enum ObjectPrivatFlagsBits {
+            OBJBIT_INSTANT   =  1<<24  ///< Object is instant active on coin insertion 
+        };
 
     public:
-        CoinSlot();
+        CoinSlot(bool isInstant);
         ~CoinSlot();
 
+        // Object interface
+        virtual std::string getClass() const;
+        virtual void setAttr(const string& key, const Value &val);
+        virtual Value getAttr(const std::string &key) const;
+        virtual Value message(const Message &m);
+
         // StateObject interface
         virtual int externalState() const;
         virtual void setState(int extState);
@@ -59,7 +74,7 @@
         virtual const char *collision_sound();
 
         // TimeHandler interface
-        virtual void tick(double dtime);
+        virtual void alarm();
 
     private:
         void setIState(iState newIState);



From ral at mail.berlios.de  Wed Apr  9 01:19:00 2008
From: ral at mail.berlios.de (ral at BerliOS)
Date: Wed, 9 Apr 2008 01:19:00 +0200
Subject: [Enigma-game-svn] r1097 - team_levelpacks/team_test_new_api
Message-ID: <200804082319.m38NJ0s4023385@sheep.berlios.de>

Author: ral
Date: 2008-04-09 01:18:59 +0200 (Wed, 09 Apr 2008)
New Revision: 1097

Modified:
   team_levelpacks/team_test_new_api/ralT014_1.xml
   team_levelpacks/team_test_new_api/ralT037_1.xml
   team_levelpacks/team_test_new_api/ralT038_1.xml
   team_levelpacks/team_test_new_api/raoulT04_1.xml
Log:
Test Level new API:
- it_coin adjusted levels


Modified: team_levelpacks/team_test_new_api/ralT014_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/ralT014_1.xml	2008-04-08 21:08:17 UTC (rev 1096)
+++ team_levelpacks/team_test_new_api/ralT014_1.xml	2008-04-08 23:18:59 UTC (rev 1097)
@@ -23,7 +23,7 @@
 ti[" "] = {"fl-sahara"}
 ti["."] = ti({"fl-rough-blue", checkerboard=0}) .. {"fl-rough-red", checkerboard=1}
 ti["c"] = ti[" "] .. {"it-cherry", name="cherry#"}
-ti["5"] = ti[" "] .. {"it-coin2", name="money", target={"otto", "emil*"}}
+ti["5"] = ti[" "] .. {"it_coin_m", name="money", target={"otto", "emil*"}}
 ti["S"] = ti[" "] .. {"st_coinslot"}
 ti["m"] = ti[" "] .. {"#ac-blackball"}
 ti["x"] = {"fl-rough-blue"} .. {"it-banana"} .. ti({"ac-bug", 0.7})

Modified: team_levelpacks/team_test_new_api/ralT037_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/ralT037_1.xml	2008-04-08 21:08:17 UTC (rev 1096)
+++ team_levelpacks/team_test_new_api/ralT037_1.xml	2008-04-08 23:18:59 UTC (rev 1097)
@@ -16,6 +16,7 @@
     </el:info>
     <el:luamain><![CDATA[
 wo["ConserveLevel"] = true
+wo["MagnetRange"] = 3
 
 ti[" "] = {"fl-sahara"}
 ti["~"] = {"fl-water"}
@@ -27,6 +28,7 @@
 ti["t"] = {"st-turnstile-n","it"}
 ti["R"] = {"it-rubberband", target="it", length=4}
 ti["p"] = {"st-swap", "you"}
+ti["m"] = {"it_magnet_on", strength=-40}
 ti["1"] = {"#ac-blackball", "me"}
 
 w, h = wo(ti, " ", {
@@ -34,14 +36,14 @@
 "               t    ",
 "           R   T    ",
 "                    ",
-"        ~           ",
+"     m  ~           ",
 "                    ",
 "     S pw  s        ",
 "                    ",
 "        r  1        ",
 "                    ",
+"        m           ",
 "                    ",
-"                    ",
 "                    "
 })
 
@@ -50,6 +52,8 @@
 function killwood()
     no["you"]:kill()
 end
+
+
   ]]></el:luamain>
     <el:i18n>
 	 <el:string el:key="title">

Modified: team_levelpacks/team_test_new_api/ralT038_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/ralT038_1.xml	2008-04-08 21:08:17 UTC (rev 1096)
+++ team_levelpacks/team_test_new_api/ralT038_1.xml	2008-04-08 23:18:59 UTC (rev 1097)
@@ -43,9 +43,9 @@
 ti["H"] = {"it_hammer_new"}
 ti["d"] = {"it_sword"}
 ti["D"] = {"it_sword_new"}
-ti["1"] = {"it-coin1"}
-ti["2"] = {"it-coin2"}
-ti["4"] = {"it-coin4"}
+ti["1"] = {"it_coin_s"}
+ti["2"] = {"it_coin_m"}
+ti["4"] = {"it_coin_l"}
 ti["0"] = {"#ac-blackball"}
 
 w, h = wo(ti, " ", {

Modified: team_levelpacks/team_test_new_api/raoulT04_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/raoulT04_1.xml	2008-04-08 21:08:17 UTC (rev 1096)
+++ team_levelpacks/team_test_new_api/raoulT04_1.xml	2008-04-08 23:18:59 UTC (rev 1097)
@@ -36,27 +36,29 @@
 ti["T"] = ti[" "] .. {"st_switch", name="la3", target="la3", action="toggle"}
 ti["U"] = ti[" "] .. {"st_switch", name="la4", target="la4", action="toggle"}
 
-ti["X"] = ti[" "] .. {"it-coin1"}
-ti["Y"] = ti[" "] .. {"it-coin2"}
-ti["Z"] = ti[" "] .. {"it-coin4"}
+ti["X"] = ti[" "] .. {"it_coin_s"}
+ti["Y"] = ti[" "] .. {"it_coin_m"}
+ti["Z"] = ti[" "] .. {"it_coin_l"}
 
-ti["x"] = ti[" "] .. {"it-coin1", value=6}
-ti["y"] = ti[" "] .. {"it-coin2", value=6}
-ti["z"] = ti[" "] .. {"it-coin4", value=6}
+ti["x"] = ti[" "] .. {"it_coin_s", coin_value=6}
+ti["y"] = ti[" "] .. {"it_coin_m", coin_value=6}
+ti["z"] = ti[" "] .. {"it_coin_l", coin_value=6}
 
 ti["l"] = ti[" "] .. {"st_laser_e", name="la5"}
 ti["m"] = ti[" "] .. {"st_laser_e", name="la6"}
 ti["n"] = ti[" "] .. {"st_laser_e", name="la7"}
 
-ti["E"] = ti[" "] .. {"st_coinslot", name="csx", target="la5", action="toggle"}
-ti["F"] = ti[" "] .. {"st_coinslot", name="csy", target="la6", action="toggle"}
-ti["G"] = ti[" "] .. {"st_coinslot", name="csz", target="la7", action="toggle"}
+ti["E"] = ti[" "] .. {"st_coinslot", name="csx", interval_s=1, target="la5", action="toggle"}
+ti["F"] = ti[" "] .. {"st_coinslot", name="csy", interval_m=1, target="la6", action="toggle"}
+ti["G"] = ti[" "] .. {"st_coinslot", name="csz", interval_l=1, target="la7", action="toggle"}
 
+ti["W"] = {"st-wood"}
+
 w, h = wo(ti, " ", {
 "0      A     RL     ",
 "       B     SM     ",
 "       C     TN     ",
-"       D     UO     ",
+" W     D     UO     ",
 "                    ",
 "XXXXXXXXXX          ",
 "     YYYYYYYYYY     ",



From ral at mail.berlios.de  Sat Apr 12 00:42:12 2008
From: ral at mail.berlios.de (ral at BerliOS)
Date: Sat, 12 Apr 2008 00:42:12 +0200
Subject: [Enigma-game-svn] r1098 - in trunk: data data/schemas src src/stones
Message-ID: <200804112242.m3BMgCTJ016612@sheep.berlios.de>

Author: ral
Date: 2008-04-12 00:42:10 +0200 (Sat, 12 Apr 2008)
New Revision: 1098

Modified:
   trunk/data/api1init.lua
   trunk/data/api2init.lua
   trunk/data/models-2d.lua
   trunk/data/schemas/objects.xml
   trunk/src/items.cc
   trunk/src/stones/FloppySwitch.cc
   trunk/src/stones/OxydStone.cc
   trunk/src/stones/OxydStone.hh
   trunk/src/stones/TimerStone.cc
Log:
Trunk 1.1: new API reengineering item floppy
- oxyd stone: reengineering from PhotoStone to GridStone laser support
- oxyd stone: fix swapping problems on closeall and pair opening
- fix timer stone: model update on state change
- fix coins in old API: correct default values on stone hit
- renaming it-floppy to it_floppy

Modified: trunk/data/api1init.lua
===================================================================
--- trunk/data/api1init.lua	2008-04-08 23:18:59 UTC (rev 1097)
+++ trunk/data/api1init.lua	2008-04-11 22:42:10 UTC (rev 1098)
@@ -51,6 +51,7 @@
     it_coin_m = "it-coin2",
     it_coin_l = "it-coin4",
     it_extralife = "it-extralife",
+    it_floppy = "it-floppy",
     it_hammer = "it-hammer",
     it_magnet = "it-magnet",
     it_magnet_on = "it-magnet-on",

Modified: trunk/data/api2init.lua
===================================================================
--- trunk/data/api2init.lua	2008-04-08 23:18:59 UTC (rev 1097)
+++ trunk/data/api2init.lua	2008-04-11 22:42:10 UTC (rev 1098)
@@ -62,10 +62,11 @@
 ----------------
 
 -- state
-OFF = 0
-ON  = 1
-CLOSED = 0
-OPEN   = 1
+OFF      = 0
+ON       = 1
+CLOSED   = 0
+OPEN     = 1
+OXYDPAIR = 2
 
 -- color
 BLACK = 0

Modified: trunk/data/models-2d.lua
===================================================================
--- trunk/data/models-2d.lua	2008-04-08 23:18:59 UTC (rev 1097)
+++ trunk/data/models-2d.lua	2008-04-11 22:42:10 UTC (rev 1098)
@@ -402,7 +402,6 @@
         "it-dynamite",
         "it-flagblack",
         "it-flagwhite",
-        "it-floppy",
         "it-glasses",
         "it-glasses-broken",
         "it-hill",
@@ -437,6 +436,7 @@
     DefImage("it_coin_m", {filename="it-coin2"})
     DefImage("it_coin_l", {filename="it-coin4"})
     DefImage("it_extralife", {filename="it-extralife"})
+    DefImage("it_floppy", {filename="it-floppy"})
     DefImage("it_hammer", {filename="it-hammer"})
     DefImage("it_sword", {filename="it-sword"})
     DefImage("it_umbrella", {filename="it-umbrella"})

Modified: trunk/data/schemas/objects.xml
===================================================================
--- trunk/data/schemas/objects.xml	2008-04-08 23:18:59 UTC (rev 1097)
+++ trunk/data/schemas/objects.xml	2008-04-11 22:42:10 UTC (rev 1098)
@@ -10,6 +10,7 @@
     <attr name="counterclock" type="bool" default="false" rw="rw"/>
     <attr name="destination" type="tokens" default="nil" rw="rw"/>
     <attr name="faces" type="string" default="nil" rw="rw"/>
+    <attr name="flavor" type="string" default="b" rw="rw"/>
     <attr name="instant" type="bool" default="false" rw="rw"/>
     <attr name="interval" type="double" default="1" rw="rw"/>
     <attr name="interval_s" type="double" default="3" rw="rw"/>
@@ -20,7 +21,9 @@
     <attr name="loop" type="bool" default="true" rw="rw"/>
     <attr name="name" type="string" default="nil" rw="rw"/>
     <attr name="nopaction" type="bool" default="false" rw="rw"/>
+    <attr name="noshuffle" type="bool" default="false" rw="rw"/>
     <attr name="orientation" type="int" default="0" min="0" max="3" rw="rw"/>
+    <attr name="oxydcolor" type="int" default="-1" min="-4" max="7" rw="rw"/>
     <attr name="range" type="double" default="1.0" rw="rw"/>
     <attr name="scissor" type="bool" default="true" rw="rw"/>
     <attr name="state" type="int" default="0" min="0" max="1" rw="rw"/>
@@ -49,6 +52,7 @@
     <msg name="_model_reanimated" type="nil"/>
     <msg name="_passed" type="nil"/>            <!-- check type-->
     <msg name="_performaction" type="nil"/>
+    <msg name="_spitter" type="nil"/>
     <msg name="_start" type="nil"/>
     <msg name="_trigger" type="bool"/>
     <msg name="_updateglobals" type="string"/>
@@ -90,6 +94,7 @@
     </object>
     <object name="it_extralife"/>
     <object name="it_extralife_new" init="true"/>
+    <object name="it_floppy"/>
     <object name="it_hammer"/>
     <object name="it_hammer_new" init="true"/>
     <object name="it_magnet">
@@ -317,6 +322,32 @@
       <msg name="on"/>
       <msg name="signal"/>
     </object>
+    <object name="st_oxyd">
+      <attr name="flavor"/>
+      <attr name="noshuffle"/>
+      <attr name="oxydcolor"/>
+      <attr name="static"/>
+      <msg name="closeall"/>
+      <msg name="shuffle"/>
+      <msg name="_trigger"/>
+      <msg name="_spitter"/>
+      <msg name="_init"/>
+      <msg name="open"/>
+      <msg name="close"/>
+      <msg name="signal"/>
+    </object>
+    <object name="st_oxyd_a">
+      <attr name="flavor" value="a"/>
+    </object>
+    <object name="st_oxyd_b">
+      <attr name="flavor" value="b"/>
+    </object>
+    <object name="st_oxyd_c">
+      <attr name="flavor" value="c"/>
+    </object>
+    <object name="st_oxyd_d">
+      <attr name="flavor" value="d"/>
+    </object>
     <object name="st_panel" super="st_clusterstone"/>
     <object name="st_panel_w">
       <attr name="connections" value="w"/>

Modified: trunk/src/items.cc
===================================================================
--- trunk/src/items.cc	2008-04-08 23:18:59 UTC (rev 1097)
+++ trunk/src/items.cc	2008-04-11 22:42:10 UTC (rev 1098)
@@ -184,7 +184,7 @@
 namespace
 {
     DEF_ITEM(MagicWand, "it-magicwand", it_magicwand);
-    DEF_ITEM(Floppy,    "it-floppy", it_floppy);
+    DEF_ITEM(Floppy,    "it_floppy", it_floppy);
     DEF_ITEM(Odometer,  "it-odometer", it_odometer);
     DEF_ITEM(Wrench,    "it-wrench", it_wrench);
     DEF_ITEM(BrokenGlasses, "it-glasses-broken", it_glasses_broken);
@@ -716,6 +716,7 @@
     void Coin::on_stonehit(Stone *) {
         if (state <= 1) {
             state += 1;
+            setAttr("coin_value", (state == 1 ? 6.0 : 12.0));  // API 1 compatibility
             init_model();
         }
 

Modified: trunk/src/stones/FloppySwitch.cc
===================================================================
--- trunk/src/stones/FloppySwitch.cc	2008-04-08 23:18:59 UTC (rev 1097)
+++ trunk/src/stones/FloppySwitch.cc	2008-04-11 22:42:10 UTC (rev 1098)
@@ -48,11 +48,11 @@
         if (enigma::Inventory *inv = player::GetInventory(sc.actor)) {
             if (state == ON) {
                 if (!inv->is_full()) {
-                    inv->add_item (MakeItem("it-floppy"));
+                    inv->add_item (MakeItem("it_floppy"));
                     setState(OFF);
                 }
             }
-            else if (player::WieldedItemIs (sc.actor, "it-floppy")) {
+            else if (player::WieldedItemIs (sc.actor, "it_floppy")) {
                 DisposeObject(inv->yield_first());
                 setState(ON);
             }

Modified: trunk/src/stones/OxydStone.cc
===================================================================
--- trunk/src/stones/OxydStone.cc	2008-04-08 23:18:59 UTC (rev 1097)
+++ trunk/src/stones/OxydStone.cc	2008-04-11 22:42:10 UTC (rev 1098)
@@ -1,6 +1,6 @@
 /*
  * Copyright (C) 2002,2003,2004 Daniel Heck
- * Copyright (C) 2007 Ronald Lamprecht
+ * Copyright (C) 2007,2008 Ronald Lamprecht
  *
  * This program is free software; you can redistribute it and/or
  * modify it under the terms of the GNU General Public License
@@ -836,7 +836,7 @@
     
     // Instance Methods
     
-    OxydStone::OxydStone(std::string flavor) : PhotoStone("st_oxyd") {
+    OxydStone::OxydStone(std::string flavor) : Stone("st_oxyd") {
         setAttr("flavor", flavor);
         setAttr("oxydcolor", AUTO);
     }
@@ -870,8 +870,23 @@
         else if (m.message == "_init") {
             initColors();
             return Value();
+        } else if (m.message == "_model_reanimated") {
+            if (objFlags & OBJBIT_CLOSED) {
+                state = CLOSED;
+                std::string flavor(getAttr("flavor"));
+                set_model(string("st-oxyd") + flavor);
+                objFlags &= ~OBJBIT_CLOSED;
+            } else if (objFlags & OBJBIT_OPENPAIR) {
+                state = OPEN_PAIR;
+                std::string flavor(getAttr("flavor"));
+                string color(getDefaultedAttr("oxydcolor", 0));
+                set_model(string("st-oxyd") + flavor + color + "-open");
+                objFlags &= ~OBJBIT_OPENPAIR;
+            }
+            return Value();
         }
-        return PhotoStone::message(m);
+        
+        return Stone::message(m);
     }
     
     void OxydStone::setAttr(const string& key, const Value &val) {
@@ -881,7 +896,7 @@
             ASSERT(state == CLOSED, XLevelRuntime, "OxydStone error - reflavoring of an not closed stone");
         }
         
-        PhotoStone::setAttr(key, val);   // do value checking
+        Stone::setAttr(key, val);   // do value checking
         
         if (key == "flavor" && IsInsideLevel(get_pos()))
             set_model(string("st-oxyd")+(std::string)val);
@@ -918,7 +933,6 @@
     }
     
     void OxydStone::setState(int extState) {
-        ASSERT(extState <= 1, XLevelRuntime, "OxydStone error - attempt to set state OPEN_PAIR");
         if (isDisplayable()) {
             if (state == OPEN_PAIR)
                 return;      // ignore - no change possible
@@ -943,22 +957,29 @@
         else if (state == OPENING)
             set_iState(OPEN_SINGLE);
         else if (state == OPEN_PAIR)     // end of opening anim for second oxyd in a pair
-            set_iState(OPEN_PAIR);      // set the right model
+            set_iState(OPEN_PAIR);       // set the right model
         else if (state == OPEN_SINGLE)   // pseudo animation
             set_iState(CLOSING);
     }
     
     void OxydStone::on_creation (GridPos) {
-        string flavor(getDefaultedAttr("flavor", "a"));
+        std::string flavor(getDefaultedAttr("flavor", "a"));
         set_model(string("st-oxyd") + flavor);
-        photo_activate();
+        activatePhoto();
     }
     
     void OxydStone::on_removal(GridPos p) {
-        photo_deactivate();
-        kill_model (p);
+        deactivatePhoto();
+        kill_model(p);
     }
     
+    void OxydStone::lightDirChanged(DirectionBits oldDirs, DirectionBits newDirs) {
+        if (oldDirs == 0) {
+            // side independent light switch on
+            tryOpen();
+        }
+    }
+    
     void OxydStone::tryOpen() {
         bool isSingleOpened = false;
         OxydStone *pairCandidate = NULL;
@@ -1024,11 +1045,28 @@
     
     void OxydStone::closeAllStandardOxyds() {
         for (unsigned i=0; i<levelOxyds.size(); ++i)
-            if ((int)(levelOxyds[i]->getAttr("oxydcolor")) >= AUTO)
-                levelOxyds[i]->set_iState(CLOSING);
+            if ((int)(levelOxyds[i]->getAttr("oxydcolor")) >= AUTO) {
+                    levelOxyds[i]->set_iState(CLOSING);
+            }
     }
     
     void OxydStone::set_iState(iState newState) {
+        if (!isDisplayable()) {
+            // an oxyd yielded while swapping - mark oxyd to set state when reset to the grid
+            switch (newState) {
+                case CLOSING :
+                    objFlags |= OBJBIT_CLOSED;
+                    break;
+                case OPEN_PAIR :
+                    objFlags |= OBJBIT_OPENPAIR;
+                    break;
+                default :
+                    ASSERT(false, XLevelRuntime, "OxydStone error - unexpected new iState");
+                    break;
+            }
+            return;
+        }
+        
         string flavor(getDefaultedAttr("flavor","a"));
         string color(getDefaultedAttr("oxydcolor", 0));
     

Modified: trunk/src/stones/OxydStone.hh
===================================================================
--- trunk/src/stones/OxydStone.hh	2008-04-08 23:18:59 UTC (rev 1097)
+++ trunk/src/stones/OxydStone.hh	2008-04-11 22:42:10 UTC (rev 1098)
@@ -1,6 +1,6 @@
 /*
  * Copyright (C) 2002,2003,2004 Daniel Heck
- * Copyright (C) 2007 Ronald Lamprecht
+ * Copyright (C) 2007,2008 Ronald Lamprecht
  *
  * This program is free software; you can redistribute it and/or
  * modify it under the terms of the GNU General Public License
@@ -21,7 +21,6 @@
 #define OXYDSTONE_HH_INCLUDED
 
 #include "stones.hh"
-#include "laser.hh"
 #include <stdint.h>
 
 /* -------------------- Oxyd stone -------------------- */
@@ -61,7 +60,7 @@
     /**
      * 
      */
-    class OxydStone : public PhotoStone {
+    class OxydStone : public Stone {
     public:
         enum RuleType {RULE_SINGLE_MIN, RULE_SINGLE_MAX, RULE_PAIR_MIN, RULE_PAIR_MAX};
         enum Color {BLUE = 0, RED, GREEN, YELLOW, CYAN, PURPLE, WHITE, BLACK, 
@@ -92,26 +91,27 @@
         virtual int externalState() const;
         virtual void setState(int extState);
 
+        // GridObject interface
+        virtual void on_creation(GridPos p);
+        virtual void on_removal (GridPos p);
+        virtual void lightDirChanged(DirectionBits oldDirs, DirectionBits newDirs);
+
         // Stone interface
         virtual void actor_hit(const StoneContact &sc);
         virtual const char *collision_sound() { return "stone"; }
         virtual bool is_removable() const;
         
-        // PhotoStone interface
-        virtual void notify_laseron() { tryOpen(); }
-        virtual void notify_laseroff() {}
-
         // ModelCallback interface  - Animation callback
         virtual void animcb();
     
-    protected:
-        // GridObject interface
-        void on_creation (GridPos p);
-        void on_removal (GridPos p);
-            
     private:
         enum iState { CLOSED, OPEN_PAIR, OPENING, CLOSING, OPEN_SINGLE };
         
+        enum ObjectPrivatFlagsBits {
+            OBJBIT_CLOSED   =  1<<24,  ///< force a closed state on grid set
+            OBJBIT_OPENPAIR =  1<<25   ///< force an open state on grid set
+        };
+
         typedef std::vector<OxydStone *> InstanceVector;
         
         typedef struct {

Modified: trunk/src/stones/TimerStone.cc
===================================================================
--- trunk/src/stones/TimerStone.cc	2008-04-08 23:18:59 UTC (rev 1097)
+++ trunk/src/stones/TimerStone.cc	2008-04-11 22:42:10 UTC (rev 1098)
@@ -59,6 +59,7 @@
                 } else {
                     GameTimer.remove_alarm(this);
                 }
+                init_model();
             }
         } else {
             state = extState;



From ral at mail.berlios.de  Sat Apr 12 10:14:50 2008
From: ral at mail.berlios.de (ral at BerliOS)
Date: Sat, 12 Apr 2008 10:14:50 +0200
Subject: [Enigma-game-svn] r1099 - in trunk: data data/schemas src src/stones
Message-ID: <200804120814.m3C8EoiJ022608@sheep.berlios.de>

Author: ral
Date: 2008-04-12 10:14:48 +0200 (Sat, 12 Apr 2008)
New Revision: 1099

Modified:
   trunk/data/api1init.lua
   trunk/data/models-2d.lua
   trunk/data/schemas/objects.xml
   trunk/src/items.cc
   trunk/src/items.hh
   trunk/src/oxyd.cc
   trunk/src/oxyd_internal.hh
   trunk/src/stones/KeySwitch.cc
   trunk/src/stones/WindowStone.cc
   trunk/src/stones_complex.cc
   trunk/src/stones_simple.cc
   trunk/src/world.cc
Log:
Trunk 1.1: new API reengineering 
- renaming it-wrench to it_wrench
- renaming it-brush to it_brush
- it_key as successor of all it-key_*, attribute "code" instead "keycode"
- it_vortex, it_vortex_open, it_vortex_closed
  autoclose defaults to false for all variations


Modified: trunk/data/api1init.lua
===================================================================
--- trunk/data/api1init.lua	2008-04-11 22:42:10 UTC (rev 1098)
+++ trunk/data/api1init.lua	2008-04-12 08:14:48 UTC (rev 1099)
@@ -47,6 +47,7 @@
 RenamingObjectsNew2Old = {
     it_blocker = "it-blocker",
     it_blocker_new = "it-blocker-new",
+    it_brush = "it-brush",
     it_coin_s = "it-coin1",
     it_coin_m = "it-coin2",
     it_coin_l = "it-coin4",
@@ -59,8 +60,12 @@
     it_sword = "it-sword",
     it_trigger = "it-trigger",
     it_umbrella = "it-umbrella",
+    it_vortex = "it-vortex-open",
+    it_vortex_open = "it-vortex-open",
+    it_vortex_closed = "it-vortex-closed",
     it_wormhole_on = "it-wormhole",
     it_wormhole_off = "it-wormhole-off",
+    it_wrench = "it-wrench",
     st_blocker = "st-blocker",
     st_blocker_new = "st-blocker-growing",
     st_bluesand = "st-blue-sand",
@@ -128,19 +133,19 @@
     if name == "st-key" then
         local obj = enigma._MakeObject("st_key")
         -- Old API keycode default was 0 for st-key, but 1 for it-key!
-        enigma._SetAttrib(obj, "keycode", 0)
+        enigma._SetAttrib(obj, "code", 0)
         return obj
     elseif name == "st-key_a" then
         local obj = enigma._MakeObject("st_key")
-        enigma._SetAttrib(obj, "keycode", 1)
+        enigma._SetAttrib(obj, "code", 1)
         return obj
     elseif name == "st-key_b" then
         local obj = enigma._MakeObject("st_key")
-        enigma._SetAttrib(obj, "keycode", 2)
+        enigma._SetAttrib(obj, "code", 2)
         return obj
     elseif name == "st-key_c" then
         local obj = enigma._MakeObject("st_key")
-        enigma._SetAttrib(obj, "keycode", 3)
+        enigma._SetAttrib(obj, "code", 3)
         return obj
     elseif name == "st-switch" then
         local obj = enigma._MakeObject("st_switch")
@@ -154,6 +159,18 @@
         local obj = enigma._MakeObject("st_switch_white")
         enigma._SetAttrib(obj, "instant", true)
         return obj
+    elseif name == "it-key_a" or  name == "it-key" then
+        local obj = enigma._MakeObject("it_key")
+        enigma._SetAttrib(obj, "code", 1)
+        return obj
+    elseif name == "it-key_b" then
+        local obj = enigma._MakeObject("it_key")
+        enigma._SetAttrib(obj, "code", 2)
+        return obj
+    elseif name == "it-key_c" then
+        local obj = enigma._MakeObject("it_key")
+        enigma._SetAttrib(obj, "code", 3)
+        return obj
     elseif name == "it-wormhole" then
         local obj = enigma._MakeObject("it_wormhole_on")
         enigma._SetAttrib(obj, "scissor", false)
@@ -162,6 +179,15 @@
         local obj = enigma._MakeObject("it_wormhole_off")
         enigma._SetAttrib(obj, "scissor", false)
         return obj
+    elseif name == "it-vortex-open" then
+        local obj = enigma._MakeObject("it_vortex_open")
+        enigma._SetAttrib(obj, "scissor", false)
+        return obj
+    elseif name == "it-vortex-closed" then
+        local obj = enigma._MakeObject("it_vortex_closed")
+        enigma._SetAttrib(obj, "scissor", false)
+        enigma._SetAttrib(obj, "autoclose", true)
+        return obj
     end
 
     newname = RenamingObjectsOld2New[name]
@@ -182,7 +208,7 @@
     local _oldname = RenamingObjectsNew2Old[_newname]
 
     if _newname == "st_key" then
-        local code = enigma._GetAttrib(obj, "keycode")
+        local code = enigma._GetAttrib(obj, "code")
         if code == 0 then
             return "st-key"
         elseif code == 1 then
@@ -195,6 +221,18 @@
             return "st-key"
         end
     end
+    if _newname == "it_key" then
+        local code = enigma._GetAttrib(obj, "code")
+        if code == 1 then
+            return "it-key_a"
+        elseif code == 2 then
+            return "it-key_b"
+        elseif code == 3 then
+            return "it-key_c"
+        else -- arbitrary keycodes
+            return "it-key_a"
+        end
+    end
     if string.sub(_newname, 1, 8) == "st_laser" then
         return "st-laser"
     end
@@ -235,6 +273,9 @@
          elseif  val == 16 then _val = "nesw"
          end
      end
+     if key == "keycode" then
+         _key = "code"
+     end
      if key == "delay" then
          _key = "interval"
      end
@@ -298,6 +339,9 @@
 function enigma.GetAttrib(obj, key)
      local _key = key
      local _obj_name = enigma.GetKind(obj)
+     if key == "keycode" then
+         _key = "code"
+     end
      if key == "delay" then
          _key = "interval"
      end
@@ -392,8 +436,8 @@
     it_magnet__onoff = "toggle",
     ["it-tinyhill__trigger"] = "flip",
     ["it-tinyhollow__trigger"] = "flip",
-    ["it-vortex-open__trigger"] = "toggle",
-    ["it-vortex-closed__trigger"] = "toggle",
+    it_vortex__openclose = "toggle",
+    it_vortex__trigger = "toggle",
     it_wormhole__onoff = "toggle",
     ["st-black1__trigger"] = "signal",
     ["st-black2__trigger"] = "signal",

Modified: trunk/data/models-2d.lua
===================================================================
--- trunk/data/models-2d.lua	2008-04-11 22:42:10 UTC (rev 1098)
+++ trunk/data/models-2d.lua	2008-04-12 08:14:48 UTC (rev 1099)
@@ -393,7 +393,6 @@
         "it-blocker",
         "it-booze",
         "it-booze-broken",
-        "it-brush",
         "it-cherry",
         "it-cross",
         "it-document",
@@ -407,7 +406,6 @@
         "it-hill",
         "it-hollow",
         "it-hstrip",
-        "it-key",
         "it-landmine",
         "it-magicwand",
         "it-odometer",
@@ -425,21 +423,23 @@
         "it-tinyhollow",
         "it-vstrip",
         "it-weight",
-        "it-whitebomb",
-        "it-wrench"
+        "it-whitebomb"
     }
 
     DefImages(itemlist)
 
     DefImage("it-brake", {filename="st-brake"})
+    DefImage("it_brush", {filename="it-brush"})
     DefImage("it_coin_s", {filename="it-coin1"})
     DefImage("it_coin_m", {filename="it-coin2"})
     DefImage("it_coin_l", {filename="it-coin4"})
     DefImage("it_extralife", {filename="it-extralife"})
     DefImage("it_floppy", {filename="it-floppy"})
     DefImage("it_hammer", {filename="it-hammer"})
+    DefImage("it_key", {filename="it-key"})
     DefImage("it_sword", {filename="it-sword"})
     DefImage("it_umbrella", {filename="it-umbrella"})
+    DefImage("it_wrench", {filename="it-wrench"})
 end
 
 -------------------------

Modified: trunk/data/schemas/objects.xml
===================================================================
--- trunk/data/schemas/objects.xml	2008-04-11 22:42:10 UTC (rev 1098)
+++ trunk/data/schemas/objects.xml	2008-04-12 08:14:48 UTC (rev 1099)
@@ -4,6 +4,7 @@
     <attr name="action" type="tokens" default="nil" rw="rw"/>
     <attr name="autoclose" type="bool" default="false" rw="rw"/>
     <attr name="cluster" type="int" default="nil" min="0" max="1" rw="rw"/>
+    <attr name="code" type="int" default="1" rw="rw"/>
     <attr name="coin_value" type="double" default="1" rw="rw"/>
     <attr name="color" type="int" default="nil" min="0" max="1" rw="rw"/>
     <attr name="connections" type="string" default="nil" rw="rw"/>
@@ -79,6 +80,7 @@
     </object>
     <object name="it_blocker_new" init="true">
     </object>
+    <object name="it_brush"/>
     <object name="it_coin">
       <attr name="coin_value" default="3"/>
       <attr name="state" rw="r"/>
@@ -97,6 +99,9 @@
     <object name="it_floppy"/>
     <object name="it_hammer"/>
     <object name="it_hammer_new" init="true"/>
+    <object name="it_key">
+      <attr name="code"/>
+    </object>
     <object name="it_magnet">
       <attr name="range" default="nil"/>
       <attr name="strength" default="nil"/>
@@ -120,6 +125,20 @@
     </object>
     <object name="it_umbrella"/>
     <object name="it_umbrella_new" init="true"/>
+    <object name="it_vortex">
+      <attr name="destination"/>
+      <attr name="autoclose"/>
+      <attr name="scissor" default="true"/>
+      <msg name="open"/>
+      <msg name="close"/>
+      <msg name="signal"/>
+    </object>
+    <object name="it_vortex_closed">
+      <attr name="state" value="0"/>
+    </object>
+    <object name="it_vortex_open">
+      <attr name="state" value="1"/>
+    </object>
     <object name="it_wormhole">
       <attr name="destination"/>
       <attr name="interval" default="0"/>
@@ -136,6 +155,7 @@
     <object name="it_wormhole_on">
       <attr name="state" value="1"/>
     </object>
+    <object name="it_wrench"/>
     <object name="st" abstract="true"/>
     <object name="st_clusterstone" abstract="true">
       <attr name="cluster"/>
@@ -285,6 +305,12 @@
       <msg name="signal"/>
       <msg name="_trigger"/>
     </object>
+    <object name="st_key">
+      <attr name="code"/>
+      <msg name="on"/>
+      <msg name="off"/>
+      <msg name="signal"/>
+    </object>
     <object name="st_laser">
       <attr name="counterclock"/>
       <attr name="orientation"/>

Modified: trunk/src/items.cc
===================================================================
--- trunk/src/items.cc	2008-04-11 22:42:10 UTC (rev 1098)
+++ trunk/src/items.cc	2008-04-12 08:14:48 UTC (rev 1099)
@@ -185,8 +185,9 @@
 {
     DEF_ITEM(MagicWand, "it-magicwand", it_magicwand);
     DEF_ITEM(Floppy,    "it_floppy", it_floppy);
+    DEF_ITEM(Key,       "it_key", it_key);
     DEF_ITEM(Odometer,  "it-odometer", it_odometer);
-    DEF_ITEM(Wrench,    "it-wrench", it_wrench);
+    DEF_ITEM(Wrench,    "it_wrench", it_wrench);
     DEF_ITEM(BrokenGlasses, "it-glasses-broken", it_glasses_broken);
     DEF_ITEMF(Coffee,   "it-coffee", it_coffee, itf_inflammable);
 }
@@ -566,29 +567,6 @@
     DEF_TRAITS(Spoon, "it-spoon", it_spoon);
 }
 
-/* -------------------- Keys -------------------- */
-namespace
-{
-    class Key : public Item {
-        CLONEOBJ(Key);
-        DECL_TRAITS_ARRAY(3, subtype);
-
-    public:
-        enum SubType { KEY1, KEY2, KEY3 } subtype;
-    	Key(SubType type = KEY1)
-        : subtype(type)
-        {
-            setAttr("keycode", subtype+1);
-        }
-    };
-
-    ItemTraits Key::traits[3] = {
-        {"it-key_a", it_key_a, itf_none, 0.0},
-        {"it-key_b", it_key_b, itf_none, 0.0},
-        {"it-key_c", it_key_c, itf_none, 0.0}
-    };
-}
-
 /* -------------------- Booze -------------------- */
 
 namespace
@@ -645,25 +623,31 @@
 }
 
 /* -------------------- Brush -------------------- */
-namespace
-{
     /* Can "paint" some stones and remove ash. */
     class Brush : public Item {
         CLONEOBJ(Brush);
         DECL_TRAITS;
 
-        ItemAction activate(Actor *, GridPos p) {
-            if (Item *it = GetItem(p))
-                SendMessage (it, "brush");
-            return ITEM_DROP;
-        }
     public:
-        Brush() {}
+        Brush();
+        
+        // Item interface
+        virtual ItemAction activate(Actor* a, GridPos p);
     };
-    DEF_TRAITSF(Brush, "it-brush", it_brush, itf_inflammable);
-}
+    
+    Brush::Brush() {
+    }
+    
+    ItemAction Brush::activate(Actor *a, GridPos p) {
+        if (Item *it = GetItem(p))
+            SendMessage (it, "brush");
+        return ITEM_DROP;
+    }
+    
+    DEF_TRAITSF(Brush, "it_brush", it_brush, itf_inflammable);
 
 
+
 /* -------------------- Coins -------------------- */
 
 // TODO id renaming when names are stable
@@ -2079,306 +2063,293 @@
 - \b signal     signal value: 1 -> "open"; 0 -> "close"
 */
 
-namespace
-{
     class Vortex : public Item, public TimeHandler {
+    private:
+        enum iState {
+            OPEN,          ///< TODO exchange OPEN, CLOSED to match external state 
+            CLOSED,        ///<
+            OPENING,       ///<
+            CLOSING,       ///<
+            WARPING,       ///< an open vortex occupied in process of sending a marble
+            EMITTING,      ///< an open vortex occupied, waiting for the destination to open
+            SWALLOWING     ///< an open vortex eats up a marble
+        };
+
+    public:
         CLONEOBJ(Vortex);
         DECL_TRAITS_ARRAY(2, is_open());
-    public:
+        
         Vortex(bool opened);
         virtual ~Vortex();
 
-    private:
-        static const double RANGE;
-
-        // Item interface
-        bool actor_hit(Actor*);
-        void init_model();
-        void animcb();
+        // Object interface
+        virtual std::string getClass() const;
         virtual Value message(const Message &m);
 
-        // TimeHandler interface
-        void alarm();
+        // StateObject interface
+        virtual int externalState() const;
+        virtual void setState(int extState);
+        virtual void toggleState();
 
-        // Private methods
+        // GridObject interface
+        virtual void init_model();
+        virtual void on_removal(GridPos p);
+        
+        // ModelCallback interface
+        virtual void animcb();
 
-        V2 vec_to_center (V2 v) {
-            return v-get_pos().center();
-        }
-        bool near_center_p (Actor *a) {
-            return length(vec_to_center(a->get_pos())) < RANGE;
-        }
+        // Item interface
+        virtual bool actor_hit(Actor*);
 
-        void open();
-        void close();
-        void openclose();
+        // TimeHandler interface
+        virtual void alarm();
 
-        void prepare_for_warp (Actor *actor);
+    private:
+        void prepare_for_warp(Actor *actor);
         void emit_actor(Vortex *destVortex);
 
         void perform_warp();    // warp swallowed actor(s)
         void warp_to(const V2 &target);
 
-        bool is_open() const { return state == OPEN; }
+        bool is_open() const { return externalState() == 1 ; }
 
-        void on_removal(GridPos p);
-
-        // Variables
-        enum State {
-            OPEN,
-            CLOSED,
-            OPENING,
-            CLOSING,
-            WARPING,
-            EMITTING,
-            SWALLOWING,
-        };
-
-        State  state;
     };
 
     ItemTraits Vortex::traits[2] = {
-        {"it-vortex-closed", it_vortex_closed, itf_static | itf_fireproof, 0.0},
-        {"it-vortex-open", it_vortex_open,     itf_static | itf_fireproof, 0.0}
+        {"it_vortex_closed", it_vortex_closed, itf_static | itf_fireproof, 0.0},
+        {"it_vortex_open", it_vortex_open,     itf_static | itf_fireproof, 0.0}
     };
 
-    const double Vortex::RANGE = 0.5/2;
-}
+    Vortex::Vortex(bool open) : Item() {
+        state = open ? OPEN : CLOSED;
+        setAttr("$dest_idx", 0);
+        setAttr("$dest_vortex", (Object *)NULL);
+        setAttr("$grabbed_actor", (Object *)NULL);
+    }
 
-Vortex::Vortex(bool open) : state(open ? OPEN : CLOSED) {
-    setAttr("autoclose", !open);
-    setAttr("$dest_idx", 0);
-    setAttr("$dest_vortex", (Object *)NULL);
-    setAttr("$grabbed_actor", (Object *)NULL);
-}
+    Vortex::~Vortex() {
+        GameTimer.remove_alarm(this);
+        if (Actor *actor = dynamic_cast<Actor *>((Object *)getAttr("$grabbed_actor"))) {
+            // release an actor that is grabbed on behalf of this vortex - actor state FALLING_VORTEX
+            SendMessage(actor, "rise");
+        }
+    }
 
-Vortex::~Vortex() {
-    GameTimer.remove_alarm(this);
-    if (Actor *actor = dynamic_cast<Actor *>((Object *)getAttr("$grabbed_actor"))) {
-        // release an actor that is grabbed on behalf of this vortex - actor state FALLING_VORTEX
-        SendMessage(actor, "rise");
+    std::string Vortex::getClass() const {
+        return "it_vortex";
     }
     
-}
-
-void Vortex::on_removal(GridPos p) {
-    Item::on_removal(p);
-    ASSERT(state != WARPING && state != SWALLOWING && state != EMITTING,
-        XLevelRuntime, "Tried to kill a busy vortex. Please use another way.");
-}
-
-void Vortex::prepare_for_warp (Actor *actor) {
-    SendMessage(actor, "fallvortex");
-    setAttr("$dest_idx", 0);
-    setAttr("$grabbed_actor", actor);
-    state = SWALLOWING;
-
-    GameTimer.set_alarm(this, 0.4, false);
-}
-
-
-bool Vortex::actor_hit (Actor *actor) {
-    if (state == OPEN && near_center_p(actor) && actor->can_be_warped())
-        prepare_for_warp (actor);
-    return false;
-}
-
-Value Vortex::message(const Message &m)
-{
-    if (m.message == "signal") {
-        int ival = m.value;
-        if (ival != 0)
-            open();
-        else
-            close();
-        return Value();
-    } else if (m.message == "openclose" || m.message == "toggle") {
-        openclose();
-        return Value();
-    } else if (m.message == "open") {
-        open();
-        return Value();
-    } else if (m.message == "close" || (m.message == "_passed" && getAttr("autoclose").to_bool())) {
-        close();
-        if (m.message == "_passed")
+    Value Vortex::message(const Message &m) {
+        if (m.message == "_passed" && getAttr("autoclose").to_bool()) {
+            setState(0);
             performAction(getAttr("$grabbed_actor"));
-        return Value();
+            return Value();
+        }
+        return Item::message(m);
     }
-    return Item::message(m);
-}
 
-void Vortex::init_model() {
-    switch(state) {
-        case WARPING:
-        case OPEN:
-        case EMITTING:
-        case SWALLOWING:
-            set_model("it-vortex-open");
-            break;
-        case CLOSED: 
-            set_model("it-vortex-closed"); break;
-        case OPENING: 
-            set_anim("it-vortex-opening"); break;
-        case CLOSING: 
-            set_anim("it-vortex-closing"); break;
+    int Vortex::externalState() const {
+        return (state >= CLOSED && state <= CLOSING) ? 0 : 1 ;
     }
-}
-
-void Vortex::animcb() {
-    if (state == CLOSING) {
-        state = CLOSED;
-        init_model();
+    
+    void Vortex::setState(int extState) {
+        if (isDisplayable()) {
+            if (extState == 1) {  // open
+                if (state == CLOSING) {
+                    state = OPENING;
+                    get_model()->reverse(); // reverse animation
+                }
+                else if (state == CLOSED) {
+                    state = OPENING;
+                    sound_event ("vortexopen");
+                    init_model();
+                }
+            } else if (extState == 0) { // close
+                if (state == OPENING) {
+                    state = CLOSING;
+                    get_model()->reverse(); // reverse animation
+                }
+                else if (state == OPEN) {
+                    state = CLOSING;
+                    sound_event ("vortexclose");
+                    init_model();
+                }
+            }
+        } else {
+            if (extState <= 1 && extState >= 0)
+                state = 1 - extState;
+        }
     }
-    else if (state == OPENING) {
-        state = OPEN;
-        init_model();
+        
+    void Vortex::toggleState() {
+        if (state == OPEN || state == OPENING)
+            setState(0);
+        else
+            setState(1);
     }
-}
-
-void Vortex::open() {
-    if (state == CLOSING) {
-        state = OPENING;
-        get_model()->reverse(); // reverse animation
+    
+    void Vortex::init_model() {
+        switch(state) {
+            case WARPING:
+            case OPEN:
+            case EMITTING:
+            case SWALLOWING:
+                set_model("it-vortex-open");
+                break;
+            case CLOSED: 
+                set_model("it-vortex-closed"); break;
+            case OPENING: 
+                set_anim("it-vortex-opening"); break;
+            case CLOSING: 
+                set_anim("it-vortex-closing"); break;
+        }
     }
-    else if (state == CLOSED) {
-        state = OPENING;
-        sound_event ("vortexopen");
-        init_model();
+    
+    void Vortex::on_removal(GridPos p) {
+        Item::on_removal(p);
+        ASSERT(state != WARPING && state != SWALLOWING && state != EMITTING,
+            XLevelRuntime, "Tried to kill a busy vortex. Please use another way.");
     }
-}
-
-void Vortex::close() {
-    if (state == OPENING) {
-        state = CLOSING;
-        get_model()->reverse(); // reverse animation
+    
+    void Vortex::animcb() {
+        if (state == CLOSING) {
+            state = CLOSED;
+            init_model();
+        }
+        else if (state == OPENING) {
+            state = OPEN;
+            init_model();
+        }
     }
-    else if (state == OPEN) {
-        state = CLOSING;
-        sound_event ("vortexclose");
-        init_model();
+    
+    bool Vortex::actor_hit (Actor *actor) {
+        if (state == OPEN && (length((actor->get_pos()) - get_pos().center()) < 0.25) && actor->can_be_warped())
+            prepare_for_warp (actor);
+        return false;
     }
-}
+    
+    void Vortex::alarm() {
+        if (state == WARPING) {
+            perform_warp();
+        } else if (state == EMITTING) {
+            emit_actor(dynamic_cast<Vortex *>((Object *)getAttr("$dest_vortex")));
+        } else if (state == SWALLOWING) {
+            state = WARPING;
+            sound_event ("hitfloor");
+            perform_warp();
+        } else
+            ASSERT (0, XLevelRuntime, "Vortex: alarm called with inconsistent state");
+    }
+    
+    void Vortex::prepare_for_warp (Actor *actor) {
+        SendMessage(actor, "fallvortex");
+        setAttr("$dest_idx", 0);
+        setAttr("$grabbed_actor", actor);
+        state = SWALLOWING;
+    
+        GameTimer.set_alarm(this, 0.4, false);
+    }
+    
+    void Vortex::emit_actor(Vortex *destVortex) {
+        if (destVortex == NULL)   // destination vortex got killed in meantime
+            destVortex = this;    // reemit from source vortex 
+        V2 v(destVortex->get_pos().center());
+        if (Actor *actor = dynamic_cast<Actor *>((Object *)getAttr("$grabbed_actor"))) {
+            WarpActor(actor, v[0], v[1], false);
+            SendMessage(actor, "rise");
+            if (destVortex != this) {
+                bool isScissor = to_bool(getDefaultedAttr("scissor", 
+                        (server::EnigmaCompatibility >= 1.10) || server::GameCompatibility != GAMET_ENIGMA));
+                if (isScissor)
+                    KillRubberBands(actor);
+            }
+        }
+        state = OPEN;
+        if (this != destVortex && getAttr("autoclose").to_bool())  // do not close source vortex if destination is currently blocked
+            setState(0);
+        if (this != destVortex)
+            performAction(getAttr("$grabbed_actor"));
+    
+        setAttr("$grabbed_actor", (Object *)NULL);
+    }
 
-void Vortex::openclose() {
-    if (state == OPEN || state == OPENING)
-        close();
-    else
-        open();
-}
-
-void Vortex::alarm() {
-    if (state == WARPING) {
-        perform_warp();
-    } else if (state == EMITTING) {
-        emit_actor(dynamic_cast<Vortex *>((Object *)getAttr("$dest_vortex")));
-    } else if (state == SWALLOWING) {
-        state = WARPING;
-        sound_event ("hitfloor");
-        perform_warp();
-    } else
-        ASSERT (0, XLevelRuntime, "Vortex: alarm called with inconsistent state");
-}
-
-void Vortex::emit_actor(Vortex *destVortex) {
-    if (destVortex == NULL)   // destination vortex got killed in meantime
-        destVortex = this;    // reemit from source vortex 
-    V2 v(destVortex->get_pos().center());
-    if (Actor *actor = dynamic_cast<Actor *>((Object *)getAttr("$grabbed_actor"))) {
-        WarpActor(actor, v[0], v[1], false);
-        SendMessage(actor, "rise");
-        if (destVortex != this) {
+    void Vortex::warp_to(const V2 &target) {
+        client::Msg_Sparkle (target);
+        if (Actor *actor = dynamic_cast<Actor *>((Object *)getAttr("$grabbed_actor"))) {
+            WarpActor(actor, target[0], target[1], false);
+            SendMessage(actor, "appear");
             bool isScissor = to_bool(getDefaultedAttr("scissor", 
                     (server::EnigmaCompatibility >= 1.10) || server::GameCompatibility != GAMET_ENIGMA));
             if (isScissor)
                 KillRubberBands(actor);
         }
-    }
-    state = OPEN;
-    if (this != destVortex && getAttr("autoclose").to_bool())  // do not close source vortex if destination is currently blocked
-        close();
-    if (this != destVortex)
+        state = OPEN;
+        if (getAttr("autoclose").to_bool())
+            setState(0);
+    
         performAction(getAttr("$grabbed_actor"));
-
-    setAttr("$grabbed_actor", (Object *)NULL);
-}
-
-void Vortex::warp_to(const V2 &target) {
-    client::Msg_Sparkle (target);
-    if (Actor *actor = dynamic_cast<Actor *>((Object *)getAttr("$grabbed_actor"))) {
-        WarpActor(actor, target[0], target[1], false);
-        SendMessage(actor, "appear");
-        bool isScissor = to_bool(getDefaultedAttr("scissor", 
-                (server::EnigmaCompatibility >= 1.10) || server::GameCompatibility != GAMET_ENIGMA));
-        if (isScissor)
-            KillRubberBands(actor);
+        setAttr("$grabbed_actor", (Object *)NULL);
     }
-    state = OPEN;
-    if (getAttr("autoclose").to_bool())
-        close();
 
-    performAction(getAttr("$grabbed_actor"));
-    setAttr("$grabbed_actor", (Object *)NULL);
-}
-
-void Vortex::perform_warp() {
-    Actor *actor = dynamic_cast<Actor *>((Object *)getAttr("$grabbed_actor"));
-    if (actor == NULL)
-        return;
-
-    ASSERT (state == WARPING, XLevelRuntime, "Vortex: perform_warp called with inconsistent state");
-
-    V2 v_target;
-
-    // is another target position defined?
-    int dest_idx = getAttr("$dest_idx");
-    if (Object::getDestinationByIndex(dest_idx, v_target)) {
-        GridPos  p_target(v_target);
-
-        Vortex *v = dynamic_cast<Vortex*>(GetItem(p_target));
-
-        if (v) {                // Destination is also a vortex
-            Stone *st = GetStone(p_target);
-
-            if (st && !st->is_floating()) {
-                // is destination vortex blocked? redirect
-                setAttr("$dest_idx", dest_idx + 1);
-                client::Msg_Sparkle(v_target);
-                WarpActor(actor, v_target[0], v_target[1], false);
-                GameTimer.set_alarm(this, 0.4, false);
-            }
-            else {
-                switch (v->state) {
-                    case OPEN:
-                    case OPENING:
-                        // destination is open
-                        emit_actor(v);
-                        break;
+    void Vortex::perform_warp() {
+        Actor *actor = dynamic_cast<Actor *>((Object *)getAttr("$grabbed_actor"));
+        if (actor == NULL)
+            return;
     
-                    case CLOSED:
-                    case CLOSING:
-                        // destination is closed
-                        SendMessage(v, "open");
-                        setAttr("$dest_vortex", v);
-                        state = EMITTING;
-                        GameTimer.set_alarm(this, 0.4, false);
-                        break;
-                    case SWALLOWING:
-                    case WARPING:
-                    case EMITTING:
-                        // destination is busy -> don't warp actor, emit
-                        // it where it has started
-                        emit_actor(this);
+        ASSERT (state == WARPING, XLevelRuntime, "Vortex: perform_warp called with inconsistent state");
+    
+        V2 v_target;
+    
+        // is another target position defined?
+        int dest_idx = getAttr("$dest_idx");
+        if (Object::getDestinationByIndex(dest_idx, v_target)) {
+            GridPos  p_target(v_target);
+    
+            Vortex *v = dynamic_cast<Vortex*>(GetItem(p_target));
+    
+            if (v) {                // Destination is also a vortex
+                Stone *st = GetStone(p_target);
+    
+                if (st && !st->is_floating()) {
+                    // is destination vortex blocked? redirect
+                    setAttr("$dest_idx", dest_idx + 1);
+                    client::Msg_Sparkle(v_target);
+                    WarpActor(actor, v_target[0], v_target[1], false);
+                    GameTimer.set_alarm(this, 0.4, false);
                 }
+                else {
+                    switch (v->state) {
+                        case OPEN:
+                        case OPENING:
+                            // destination is open
+                            emit_actor(v);
+                            break;
+        
+                        case CLOSED:
+                        case CLOSING:
+                            // destination is closed
+                            SendMessage(v, "open");
+                            setAttr("$dest_vortex", v);
+                            state = EMITTING;
+                            GameTimer.set_alarm(this, 0.4, false);
+                            break;
+                        case SWALLOWING:
+                        case WARPING:
+                        case EMITTING:
+                            // destination is busy -> don't warp actor, emit
+                            // it where it has started
+                            emit_actor(this);
+                    }
+                }
+            } else {
+                warp_to(v_target);
             }
-        } else {
-            warp_to(v_target);
         }
+        else {
+            // if no target defined, don't warp actor
+            emit_actor(this);
+        }
     }
-    else {
-        // if no target defined, don't warp actor
-        emit_actor(this);
-    }
-}
 
 
 /* -------------------- YinYang item -------------------- */
@@ -3977,10 +3948,7 @@
     RegisterItem (new HStrip);
     RegisterItem (new InverseSensor);
     RegisterItem (new InvisibleAbyss);
-    Register ("it-key", new Key);
-    RegisterItem (new Key(Key::KEY1));
-    RegisterItem (new Key(Key::KEY2));
-    RegisterItem (new Key(Key::KEY3));
+    RegisterItem (new Key);
     RegisterItem (new Landmine);
     RegisterItem (new MagicWand);
     Register ("it_magnet", new Magnet(false));
@@ -4017,6 +3985,7 @@
     RegisterItem (new TwoPKillStone);
     RegisterItem (new Umbrella(false));
     Register ("it_umbrella_new", new Umbrella(true));
+    Register ("it_vortex", new Vortex(true));
     RegisterItem (new Vortex(false));
     RegisterItem (new Vortex(true));
     RegisterItem (new VStrip);

Modified: trunk/src/items.hh
===================================================================
--- trunk/src/items.hh	2008-04-11 22:42:10 UTC (rev 1098)
+++ trunk/src/items.hh	2008-04-12 08:14:48 UTC (rev 1099)
@@ -84,9 +84,7 @@
         it_hollow,
         it_hstrip,
         it_inversesensor,
-        it_key_a,
-        it_key_b,
-        it_key_c,
+        it_key,
         it_landmine,
         it_laserbeam,
         it_magicwand,

Modified: trunk/src/oxyd.cc
===================================================================
--- trunk/src/oxyd.cc	2008-04-11 22:42:10 UTC (rev 1098)
+++ trunk/src/oxyd.cc	2008-04-12 08:14:48 UTC (rev 1099)
@@ -382,12 +382,30 @@
 	}
         break;
     case 0x03:                  // note 2
-	{
-	    it = MakeItem (it_document);
-	    string text = convert_encoding(level.getNoteText(1, lang));
-	    it->setAttr ("text", text.c_str());
-	}
-	break;
+    {
+        it = MakeItem (it_document);
+        string text = convert_encoding(level.getNoteText(1, lang));
+        it->setAttr ("text", text.c_str());
+    }
+    break;
+    case 0x14:                  // key a
+    {
+        it = MakeItem(it_key);
+        it->setAttr ("code", 1);
+    }
+    break;
+    case 0x15:                  // key b
+    {
+        it = MakeItem(it_key);
+        it->setAttr ("code", 2);
+    }
+    break;
+    case 0x16:                  // key c
+    {
+        it = MakeItem(it_key);
+        it->setAttr ("code", 3);
+    }
+    break;
     default:
         {
             ItemID id = config.itemtable[type];
@@ -395,9 +413,11 @@
                 Log << ecl::strf ("Unknown item %X\n",type);
                 it = MakeItem (it_dummy);
                 it->setAttr("code", type);
+            } else {
+                it = MakeItem (id);
+                if (id == it_vortex_closed)
+                    it->setAttr("autoclose", true);
             }
-            else
-                it = MakeItem (id);
         }
     }
     return it;

Modified: trunk/src/oxyd_internal.hh
===================================================================
--- trunk/src/oxyd_internal.hh	2008-04-11 22:42:10 UTC (rev 1098)
+++ trunk/src/oxyd_internal.hh	2008-04-12 08:14:48 UTC (rev 1099)
@@ -32,7 +32,11 @@
 #define it_UNUSED it_INVALID
 #define it_EXTERNAL it_INVALID
 #define it_MISSING it_INVALID
+#define it_key_a it_key
+#define it_key_b it_key
+#define it_key_c it_key
 
+
 #define UNUSED ""
 #define SPECIAL ""
 

Modified: trunk/src/stones/KeySwitch.cc
===================================================================
--- trunk/src/stones/KeySwitch.cc	2008-04-11 22:42:10 UTC (rev 1098)
+++ trunk/src/stones/KeySwitch.cc	2008-04-12 08:14:48 UTC (rev 1099)
@@ -26,7 +26,6 @@
 
 namespace enigma {
     KeySwitch::KeySwitch() : Stone () {
-        setAttr("keycode", Value(1));
     }
 
     void KeySwitch::setState(int extState) {
@@ -60,8 +59,8 @@
         if (server::GameCompatibility == enigma::GAMET_ENIGMA) {
             if (state == ON) {
                 if (!inv->is_full()) {
-                    Item *key = MakeItem("it-key");
-                    key->setAttr("keycode", getAttr("keycode"));
+                    Item *key = MakeItem("it_key");
+                    key->setAttr("code", getAttr("code"));
                     inv->add_item(key);
                     toggle = true;
                 }
@@ -89,8 +88,8 @@
     {
         Item *it = inv->get_item(0);
         return (it
-             && it->is_kind("it-key*")
-             && it->getAttr("keycode") == getAttr("keycode"));
+             && it->isKind("it_key")
+             && it->getAttr("code") == getAttr("code"));
     }
 
     DEF_TRAITS(KeySwitch, "st_key", st_key);

Modified: trunk/src/stones/WindowStone.cc
===================================================================
--- trunk/src/stones/WindowStone.cc	2008-04-11 22:42:10 UTC (rev 1098)
+++ trunk/src/stones/WindowStone.cc	2008-04-12 08:14:48 UTC (rev 1099)
@@ -61,7 +61,7 @@
                 set_anim("st_window_anim");  // TODO anim with remaining unbroken faces
             }
             
-            else if (player::WieldedItemIs (sc.actor, "it-wrench")) {
+            else if (player::WieldedItemIs (sc.actor, "it_wrench")) {
                 if (sc.faces == WESTBIT && sc.normal[0] < 0){
                     tryInnerPull(EAST);
                 } else if (sc.faces == EASTBIT && sc.normal[0] > 0) {

Modified: trunk/src/stones_complex.cc
===================================================================
--- trunk/src/stones_complex.cc	2008-04-11 22:42:10 UTC (rev 1098)
+++ trunk/src/stones_complex.cc	2008-04-12 08:14:48 UTC (rev 1099)
@@ -103,7 +103,7 @@
         }
 
         void actor_hit (const StoneContact &sc) {
-            if (player::WieldedItemIs (sc.actor, "it-wrench")) {
+            if (player::WieldedItemIs (sc.actor, "it_wrench")) {
                 clockwise = !clockwise;
                 init_model();
             }
@@ -1987,7 +1987,7 @@
             bool clockwise = (a == ROTR);
             Actor *a = dynamic_cast<Actor*>(impulse.sender);
             if ((pivot->get_traits().id == st_turnstile_green) && a != NULL &&
-                    player::WieldedItemIs(a, "it-wrench"))
+                    player::WieldedItemIs(a, "it_wrench"))
                 clockwise = !clockwise;
             pivot->rotate(clockwise, impulse.sender); // ROTR is clockwise
         }

Modified: trunk/src/stones_simple.cc
===================================================================
--- trunk/src/stones_simple.cc	2008-04-11 22:42:10 UTC (rev 1098)
+++ trunk/src/stones_simple.cc	2008-04-12 08:14:48 UTC (rev 1099)
@@ -864,7 +864,7 @@
 
         void actor_hit(const StoneContact &sc) {
             if( state == INVISIBLE) {
-                if (player::WieldedItemIs (sc.actor, "it-brush")) {
+                if (player::WieldedItemIs (sc.actor, "it_brush")) {
                     sound_event ("stonepaint");
                     state = BRUSH;
                     if (server::GameCompatibility == GAMET_PEROXYD) {
@@ -909,7 +909,7 @@
         State state;
         void actor_hit(const StoneContact &sc) {
             if (state == INVISIBLE) {
-                if (player::WieldedItemIs (sc.actor, "it-brush")) {
+                if (player::WieldedItemIs (sc.actor, "it_brush")) {
                     sound_event ("stonepaint");
                     state = BRUSH;
                     set_model("st-stone_break");
@@ -1529,7 +1529,7 @@
         ActorImpulseStoneInvisible() : ActorImpulseBase("st-actorimpulse_invisible") {}
 
         void actor_hit(const StoneContact& sc) {
-            if (player::WieldedItemIs (sc.actor, "it-brush")) {
+            if (player::WieldedItemIs (sc.actor, "it_brush")) {
                 Stone *st = MakeStone("st-actorimpulse");
                 SetStone(get_pos(), st);
                 st->actor_hit(sc);
@@ -1694,7 +1694,7 @@
     private:
         void actor_hit(const StoneContact &sc) {
             if (player::WieldedItemIs (sc.actor, "it-magicwand") ||
-                player::WieldedItemIs (sc.actor, "it-brush"))
+                player::WieldedItemIs (sc.actor, "it_brush"))
             {
                 Value color = sc.actor->getAttr("color");
                 if      (color && color == BLACK) 
@@ -2112,7 +2112,7 @@
         }
 
         void actor_hit(const StoneContact &sc) {
-            if (player::WieldedItemIs(sc.actor, "it-brush")) {
+            if (player::WieldedItemIs(sc.actor, "it_brush")) {
                 sound_event("stonepaint");
                 ReplaceStone(get_pos(), MakeStone("st-plain"));
             } else
@@ -2143,7 +2143,7 @@
         }
 
         void actor_hit(const StoneContact &sc) {
-            if (player::WieldedItemIs(sc.actor, "it-brush")) {
+            if (player::WieldedItemIs(sc.actor, "it_brush")) {
                 sound_event("stonepaint");
                 ReplaceStone(get_pos(), MakeStone("st-plain_move"));
             } else

Modified: trunk/src/world.cc
===================================================================
--- trunk/src/world.cc	2008-04-11 22:42:10 UTC (rev 1098)
+++ trunk/src/world.cc	2008-04-12 08:14:48 UTC (rev 1099)
@@ -1884,8 +1884,8 @@
     // activate which key hole
     if (src->getObjectType() == Object::ITEM) {
         ItemID src_id = get_id(dynamic_cast<Item *>(src));
-        if (src_id >= it_key_a && src_id <= it_key_c && dst->is_kind("st_key")) {
-            dst->setAttr("keycode", src->getAttr("keycode"));
+        if (src_id == it_key && dst->is_kind("st_key")) {
+            dst->setAttr("code", src->getAttr("code"));
             return;
         }
     }



From ral at mail.berlios.de  Sat Apr 12 11:04:17 2008
From: ral at mail.berlios.de (ral at BerliOS)
Date: Sat, 12 Apr 2008 11:04:17 +0200
Subject: [Enigma-game-svn] r1100 - team_levelpacks/team_test_new_api
Message-ID: <200804120904.m3C94HGs028732@sheep.berlios.de>

Author: ral
Date: 2008-04-12 11:04:17 +0200 (Sat, 12 Apr 2008)
New Revision: 1100

Modified:
   team_levelpacks/team_test_new_api/ralT021_1.xml
   team_levelpacks/team_test_new_api/ralT028_1.xml
   team_levelpacks/team_test_new_api/ralT040_1.xml
   team_levelpacks/team_test_new_api/raoulT01_1.xml
   team_levelpacks/team_test_new_api/raoulT02_1.xml
   team_levelpacks/team_test_new_api/raoulT03_1.xml
Log:
Test Level new API:
- adjustments on r1098 and r1099 renamings 


Modified: team_levelpacks/team_test_new_api/ralT021_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/ralT021_1.xml	2008-04-12 08:14:48 UTC (rev 1099)
+++ team_levelpacks/team_test_new_api/ralT021_1.xml	2008-04-12 09:04:17 UTC (rev 1100)
@@ -22,15 +22,15 @@
 ti[" "] = {"fl-sahara"}
 ti["#"] = ti[" "] .. {"st-rock1"}
 
-ti["A"] = ti[" "] .. {"it-vortex-open", name="v1", destination="v2", scissor=true}
-ti["B"] = ti[" "] .. {"it-vortex-open", name="v2", destination="v3"}
-ti["C"] = ti[" "] .. {"it-vortex-open", name="v3", destination={"v1","v2","v4"}}
-ti["D"] = ti[" "] .. {"it-vortex-open", name="v4", destination=po(3.1,7.7)}
-ti["R"] = ti[" "] .. {"st-rubberband"}
-ti["W"] = ti[" "] .. {"st-wood"}
-ti["S"] = ti[" "] .. {"st_switch", target="autoclose"}
+ti["A"] = {"it_vortex", name="v1", destination="v2", scissor=true}
+ti["B"] = {"it_vortex", name="v2", destination="v3"}
+ti["C"] = {"it_vortex", name="v3", destination={"v1","v2","v4"}}
+ti["D"] = {"it_vortex", name="v4", destination=po(3.1,7.7)}
+ti["R"] = {"st-rubberband"}
+ti["W"] = {"st-wood"}
+ti["S"] = {"st_switch", target="autoclose"}
 
-ti["1"] = ti[" "] .. {"#ac-blackball"}
+ti["1"] = {"#ac-blackball"}
 
 w, h = wo(ti, " ", {
 "   R                ",

Modified: team_levelpacks/team_test_new_api/ralT028_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/ralT028_1.xml	2008-04-12 08:14:48 UTC (rev 1099)
+++ team_levelpacks/team_test_new_api/ralT028_1.xml	2008-04-12 09:04:17 UTC (rev 1100)
@@ -20,46 +20,49 @@
 wo["ConserveLevel"] = true
 
 ti[" "] = {"fl-sahara"}
-ti["#"] = ti[" "] .. {"st-rock1"}
+ti["#"] = {"st-rock1"}
 
-ti["O"] = ti[" "] .. {"st_oxyd", "o#", target="enlighten"}
-ti["D"] = ti[" "] .. {"st_oxyd_d", "o#", target="enlighten"}
-ti["F"] = ti[" "] .. {"st_oxyd", oxydcolor=-3, noshuffle=true}
-ti["B"] = ti[" "] .. {"st_oxyd", "bold", oxydcolor=-4, noshuffle=true}
-ti["S"] = ti[" "] .. {"st_switch", target="o#1"}
-ti["T"] = ti[" "] .. {"st_switch", target="o#2", action="open"}
-ti["U"] = ti[" "] .. {"st_switch", target="o#2", action="close"}
-ti["V"] = ti[" "] .. {"st_switch", target="o#3", action="signal"}
-ti["W"] = ti[" "] .. {"st_switch", target="statetest"}
-ti["C"] = ti[" "] .. {"st_switch", target="bold", action="signal"}
-ti["L"] = ti[" "] .. {"st_laser_n", "Laser#"}
-ti["l"] = ti[" "] .. {"st_laser_n", "laser#"}
-ti["b"] = ti[" "] .. {"st_boulder_s"}
-ti["s"] = ti[" "] .. {"st-swap"}
-ti["X"] = ti[" "] .. {"st_switch", target="o#1", action="shuffle"}
-ti["Y"] = ti[" "] .. {"st_switch", target="o#1", action="closeall"}
+ti["o"] = {"st_oxyd"}
+ti["O"] = {"st_oxyd", "o#", target="enlighten"}
+ti["D"] = {"st_oxyd_d", "o#", target="enlighten"}
+ti["F"] = {"st_oxyd", oxydcolor=-3, noshuffle=true}
+ti["B"] = {"st_oxyd", "bold", oxydcolor=-4, noshuffle=true}
+ti["S"] = {"st_switch", target="o#1"}
+ti["T"] = {"st_switch", target="o#2", action="open"}
+ti["U"] = {"st_switch", target="o#2", action="close"}
+ti["V"] = {"st_switch", target="o#3", action="signal"}
+ti["W"] = {"st_switch", target="statetest"}
+ti["C"] = {"st_switch", target="bold", action="signal"}
+ti["L"] = {"st_laser_n", "Laser#"}
+ti["l"] = {"st_laser_n", "laser#"}
+ti["b"] = {"st_boulder_s"}
+ti["s"] = {"st-swap"}
+ti["X"] = {"st_switch", target="o#1", action="shuffle"}
+ti["Y"] = {"st_switch", target="o#1", action="closeall"}
 ti["1"] = (ti[" "] .. {"it-magicwand"}) .. {"#ac-blackball"}
 
-ti["w"] = ti[" "] .. {"st_switch", target="Laser#7", action="toggle"}
-ti["f"] = ti[" "] .. {"st-fart"}
+ti["w"] = {"st_switch", target="Laser#7", action="toggle"}
+ti["f"] = {"st-fart"}
 
+ti["p"] = {"st_oxyd", "p#"}
+
 w, h = wo(ti, " ", {
 "                    ",
 "  Ll Ll Ll Ll Ll Ll ",
 "                    ",
-"  O  O  O  O  D  O  ",
+"  O  O  O  O  sD O  ",
 "                    ",
 "  S  TU V  W        ",
 "                    ",
-"      1             ",
+"  o   1             ",
 "f                   ",
-"                    ",
-"                    ",
+"  os   ps           ",
+"    f    p          ",
 "  F      C Bs       ",
-"    Y  X     wL  b  "
+"    Y  X      wL b  "
 })
 
-wo:shuffleOxyd()
+wo:shuffleOxyd({no["p#*"],min=1})
 
 function statetest(value)
     local newstate = 0
@@ -74,7 +77,7 @@
     -- all pair opened oxyds with the second laser
     for i=1,6 do
         if no["o#"..i]["state"] == 2 then
-            no["laser#"..i]["on"] = 1   -- laser not yet new API!
+            no["laser#"..i]:on()
         else
             no["laser#"..i]:off()
         end

Modified: team_levelpacks/team_test_new_api/ralT040_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/ralT040_1.xml	2008-04-12 08:14:48 UTC (rev 1099)
+++ team_levelpacks/team_test_new_api/ralT040_1.xml	2008-04-12 09:04:17 UTC (rev 1100)
@@ -32,7 +32,7 @@
 ti["e"] = {"st-turnstile-e"}
 
 ti["G"] = {"st-turnstile-green"}
-ti["w"] = {"it-wrench"}
+ti["w"] = {"it_wrench"}
 
 
 

Modified: team_levelpacks/team_test_new_api/raoulT01_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/raoulT01_1.xml	2008-04-12 08:14:48 UTC (rev 1099)
+++ team_levelpacks/team_test_new_api/raoulT01_1.xml	2008-04-12 09:04:17 UTC (rev 1100)
@@ -45,7 +45,7 @@
 ti["L"] = ti[" "] .. {"st_floppy", name="stfl7", target="da7", action="on", inverse=true}
 ti["M"] = ti[" "] .. {"st_floppy", name="stfl8", target="da8", action="off", inverse=true}
 
-ti["f"] = ti[" "] .. {"it-floppy"}
+ti["f"] = ti[" "] .. {"it_floppy"}
 
 w, h = wo(ti, " ", {
 "0  f   F      A    5",

Modified: team_levelpacks/team_test_new_api/raoulT02_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/raoulT02_1.xml	2008-04-12 08:14:48 UTC (rev 1099)
+++ team_levelpacks/team_test_new_api/raoulT02_1.xml	2008-04-12 09:04:17 UTC (rev 1100)
@@ -47,12 +47,12 @@
 ti["L"] = ti[" "] .. {"st_key", name="la7", target="da7", action="on", inverse=true}
 ti["M"] = ti[" "] .. {"st_key", name="la8", target="da8", action="off", inverse=true}
 
-ti["a"] = ti[" "] .. {"it-key"}
-ti["b"] = ti[" "] .. {"it-key", keycode=1}
-ti["c"] = ti[" "] .. {"it-key", keycode=2}
-ti["d"] = ti[" "] .. {"it-key", keycode=3}
-ti["e"] = ti[" "] .. {"it-key", keycode=4}
-ti["f"] = ti[" "] .. {"it-key", keycode=5}
+ti["a"] = ti[" "] .. {"it_key"}
+ti["b"] = ti[" "] .. {"it_key", keycode=1}
+ti["c"] = ti[" "] .. {"it_key", keycode=2}
+ti["d"] = ti[" "] .. {"it_key", keycode=3}
+ti["e"] = ti[" "] .. {"it_key", keycode=4}
+ti["f"] = ti[" "] .. {"it_key", keycode=5}
 
 w, h = wo(ti, " ", {
 "0  a   F      A     ",

Modified: team_levelpacks/team_test_new_api/raoulT03_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/raoulT03_1.xml	2008-04-12 08:14:48 UTC (rev 1099)
+++ team_levelpacks/team_test_new_api/raoulT03_1.xml	2008-04-12 09:04:17 UTC (rev 1100)
@@ -42,7 +42,7 @@
 ti["V"] = ti["."] .. {"st_window", faces="we"}
 ti["*"] = ti["."] .. {"st_window", faces="esw"}
 
-ti["w"] = ti[" "] .. {"it-wrench"}
+ti["w"] = ti[" "] .. {"it_wrench"}
 ti["I"] = ti[" "] .. {"st-stoneimpulse"}
 ti["W"] = ti[" "] .. {"it-puller-w"}
 ti["E"] = ti[" "] .. {"it-puller-e"}



From ral at mail.berlios.de  Sat Apr 12 11:34:21 2008
From: ral at mail.berlios.de (ral at BerliOS)
Date: Sat, 12 Apr 2008 11:34:21 +0200
Subject: [Enigma-game-svn] r1101 - in trunk: data doc/reference
Message-ID: <200804120934.m3C9YLkD031918@sheep.berlios.de>

Author: ral
Date: 2008-04-12 11:34:19 +0200 (Sat, 12 Apr 2008)
New Revision: 1101

Added:
   trunk/doc/reference/ConceptLuaAPI2.txt
Modified:
   trunk/data/api1init.lua
   trunk/doc/reference/enigma-ref.texi
Log:
Trunk 1.1: new API 
- fix r1090: problems with API 1 and puzzles
- new API documentation: 
  refman entries for many objects
  API concept draft as text file


Modified: trunk/data/api1init.lua
===================================================================
--- trunk/data/api1init.lua	2008-04-12 09:04:17 UTC (rev 1100)
+++ trunk/data/api1init.lua	2008-04-12 09:34:19 UTC (rev 1101)
@@ -254,7 +254,7 @@
              _key = "oxydcolor"
 	 end
      end
-     if key == "connections" then
+     if key == "connections" and _obj_name ~= "st-puzzle" then
          if val == 1 then _val = ""
          elseif  val == 2  then _val = "w"
          elseif  val == 3  then _val = "s"
@@ -369,7 +369,7 @@
      if key == "whiteball" then
         if val == 1 then val = 1 else val = 0 end
      end
-     if key == "connections" then
+     if key == "connections" and _obj_name ~= "st-puzzle" then
          if val == "" then val = 1
          elseif  val == "w"    then val = 2
          elseif  val == "s"    then val = 3

Added: trunk/doc/reference/ConceptLuaAPI2.txt
===================================================================
--- trunk/doc/reference/ConceptLuaAPI2.txt	2008-04-12 09:04:17 UTC (rev 1100)
+++ trunk/doc/reference/ConceptLuaAPI2.txt	2008-04-12 09:34:19 UTC (rev 1101)
@@ -0,0 +1,607 @@
+Concept Lua API 2         (Draft 0.6)
+=================
+
+
+C1 - Object Based Syntax   (coded - besides lines starting with a ".")
+------------------------
+
+The new API provides successor functions for all basic functions of the
+old API with simplified names and arguments. (As the naming of the
+successor functions is not yet fixed just a few examples are listed. This
+set of functions will be completed to ensure that all previous styles of
+level programming are supported in the API as well).
+
+The following example based description explains the idea of the
+new object based syntax additions:
+
+Namespace "en"
+
+  Any system object or function is addressable as "sysname" and "en.sysname" 
+
+Special value types:
+
+  position      - a position within the world that can be described by an
+                  x and y coordinate
+  object        - an Enimga object like a stone, item, floor, rubberband,...
+  world         - a singleton type for the world that contains all objects
+  namedobjects  - a singleton type for the repository of all named objects
+  group         - a list of objects
+  tile          - a description of objects at a common grid position (floor,
+                  item, stone, actor)
+  tiles         - a singleton type for the repository of all tile instances
+
+Special objects given at init:
+
+  wo   world with map and global attributes of type <world>
+  no   named object repository of type <namedobjects> 
+  ti   tile template repository of type <tiles>
+
+Let "obj" be an example object reference of a stone/item/floor (type <object>).
+
+Grid Positions are table/objects:
+
+  pos = po(7, 3)            -- a function "po()"
+  pos = po({7, 3})
+  pos = obj                 -- every object is a valid position
+  pos = po(12.3, 3.7)       -- position within a grid (for an actor) 
+
+Position constants
+  {7,3}     -- a valid position for all arguments and operations (see caveats)
+
+Access to x, y coordinates:
+
+  x, y = pos.x, pos.y
+  x, y = pos["x"], pos["y"]
+  x, y = pos:xy()
+  x, y = obj.x, obj.y
+  x, y = obj:xy()
+
+Position calculation
+
+  pos = obj + {2,7}
+  dpos = obj1 - obj2
+  dpos2 = 2 * dpos
+
+Center positions for set actors
+
+  pos_centered1 = pos + {0.5, 0.5}
+  pos_centered2 = #pos
+  pos_centered3 = #obj
+
+Round a position to a grid
+
+  grid_pos = pos:grid()
+
+Position comparison
+
+  pos_centered1 == pos_centered2
+
+Setting a single attribute of objects including global attributes of world:
+
+  obj["attr_name"] = value
+  wo["Brittleness"] = 7
+
+
+Setting multiple attributes at once:
+
+  obj:set({attr_name1=value1, attr_name2=value2})
+
+Requesting attributes of objects including global attributes of world:
+
+  value = obj["attr_name"]
+  value = wo["Brittleness"]
+
+  if wo["IsDifficult"] then ... end
+
+Reset an attribute to its default - "delete":
+
+  obj["attr_name"] = nil
+
+Creating a new object:
+
+  wo[pos] = {"st_chess", color = 0, name="Atrax"}   -- on edge of grid pos
+  wo[#pos] = {"ac_bug"}              -- actor centered on grid pos
+  wo[pos] = {"#ac_bug"}              -- actor centered on grid pos
+  wo[pos] = {"ac_bug", 0.3, 0.7}     -- actor with offsets to pos
+  wo[my_floor] = {"it_wand"}         -- set an wand on top of a given foor
+
+Naming an object:
+
+  no["Atrax"] = obj
+
+Consecutive naming of objects (building object groups)
+
+  wo[pos] = {"st_chess", color = 0, name="Atrax#"}
+
+  For each call of the line above the new object will be named with a unique
+  number appended after the "#" giving "Atrax#1", "Atrax#2", "Atrax#3", ...
+
+Requesting an object:
+
+  obj = it(pos)
+  obj = it(x, y)
+  obj = st(pos)
+  obj = wo:it(pos)
+  my_item = it(my_floor)    -- get the item that is on top of the given floor
+  
+  obj = no["Atrax"]
+
+Killing an object:
+
+  obj:kill()
+  wo[pos] = {"it_nil"}
+
+Comparing objects
+
+  obj1 == obj2
+
+Existance of an object
+
+  obj:exists()
+  -obj                -- unary minus operator on object
+  if -obj then ...
+
+Messages:
+
+  my_boulder:message("direction", WEST)
+  my_boulder:direction(EAST)
+  my_door:open()
+
+Classification of objects:
+
+  obj:is("st_chess")
+  obj:is("st")
+  obj:is("st_chess_black")
+
+Group of objects:
+
+  group = no["Atrax#*"]            -- a group of all matching objects
+                                   --   wildcards "*","?" allowed
+  group = grp(obj1, obj2, obj3)
+  group = grp({obj1, obj2, obj3})  -- a group of objects set up in a table
+
+Many operations can be applied to groups
+
+  floor_group[friction] = 3.2      -- set attribute on all floors in the group
+  door_group:message("open")
+  door_group:open()
+  stone_group:kill()
+  wo[floor_group] = {"it-coin2"}   -- add some money on all floor positions
+  
+  wo[pos] = {"st_switch", target=door_group, action="open"}
+  wo[pos] = {"st_switch", target="door#*", action="close"}
+
+Group operations
+
+  doors_lasers = doorgrp + lasergrp       -- join of two groups
+  lasergrp     = doors_lasers - doorgrp   -- difference of two groups
+  common_doors = doorgrp1 * doorgrp2      -- intersection of two groups
+
+For loops over a group
+
+  for i = 1, #mygroup do obj = mygroup[i] ... end
+  for obj in mygroup do ... end
+
+Setting and connecting two vortices:
+
+ wo[{3,4}] = {"it_vortex", name="vortex1", destination="vortex3"}
+ wo[{8,6}] = {"it_vortex", name="vortex2", destination="vortex1"}
+ wo[{8,6}] = {"it_vortex", name="vortex3", destination={"vortex1","vortex2"}}
+
+
+Tiles:
+
+  ti["  "] = {"fl_sand"}
+  ti[" w"] = ti["  "] .. {"it_wand"}
+  ti["  "] = {"fl_abyss"}   -- redefinition causes error to avoid common
+                            --   mistakes
+
+  wo[{3,4}] = ti[" w"]
+  wo[{5,6}] = ti["  "] .. {"st_chess"}
+
+  width, height = wo(ti, "  ", { -- second arg: default tile key that 
+  "########",                    --   defines the base, too - this example
+  "##   w##",                    --   is 2 chars per tile/grid 
+  "########"
+  })
+
+Note: Tiles kann be used after the initialization as well:
+
+function my_callback(value, sender)
+    wo[sender] = ti[" w"]
+end
+
+
+
+
+C2 - Object reference validity and usability   (done)
+--------------------------------------------
+
+Objects existance and validity can be checked at via the "obj:exists()"
+method or the operator "-obj". Not existing objects are still of type
+object (not nil like in old API!). These "null" objects are not equal
+concerning the Lua "==" comparison to any object, even themself.
+
+Write access, kill of and messages to "null" objects are silently ignored.
+World set objects to "null" object position is ignored, too. This allows
+loops and group usage even with "null" targets without problems.
+
+All read operations that return object specific values which are not
+usable for group operations and can just be used with a single object
+as target will throw an error if this object is a "null" object. The
+application will no longer crash. Just a backtrace will be shown like
+on other level exceptions.
+
+
+C3 - Booleans and Nil   (mainly done)
+---------------------
+
+All boolean type attributes and values in the new API are Lua 5.0++
+booleans with values "true" and "false". The engine internal value
+representation takes boolean as another explicit type. Type mismatches
+on transfer of boolean values from or to Lua will no longer occur.
+
+Some attributes and values of the old API that did take values 0 and 1
+may change to other types than boolean due to other API concepts.
+
+Setting an attribute value to "nil" causes the value to be deleted.
+Any further access returns the default value for the attribute.
+
+C4 - Multitarget and Multiaction (coded)
+--------------------------------
+
+The target-action paradigm is extended to a multitarget and multiaction
+messaging system that is even configurable on the senders state. 
+
+Every object can take objects, groups of objects or namestrings (including
+wildcards) as target:
+
+  {"st_switch", target=my_laser, action="on_off"}
+
+  {"st_switch", target=no["my_doors#*"], action="open_close"}
+  {"st_switch", target="my_doors#*", action="open_close"}
+
+Note the subtle difference between the last two expressions: The first one
+evaluates the wildcarded string immediatley and builds a fixed group of the
+current objects that fit the name pattern. The second string is stored as
+given and will be evaluated at the moment the action is performed. This is
+what you need in tile definitions, as the desired target do not exist at the
+moment of the tile definition.
+
+Multiple targets can be declared and each target can take a different action:
+
+  {"st_switch", target={my_laser, "my_door#*", "my_function"},
+                action={"on_off", "open_close", "callback"}}
+
+The default action for all functions is "callback", which can thus be
+omitted:
+
+  {"st_switch", target="my_function"}
+
+The default action for all objects is "toggle", which can thus be
+omitted:
+
+  {"st_switch", target="my_laser"}
+
+Every callback takes the arguments (state_value, sender) where 
+"state_value" is an integer value that represents the internal state
+of the sender object. For switch like objects the state will be 0 for
+"off" and 1 for "on". Other objects like fourswitch etc. will count the
+their states from 0, 1, 2,...
+
+For special cases, especially for editor based levels, the author can
+specify different target/action behaviour based on the value of the
+sender objects state. For each state the following special targets and
+actions preceed the default target and actions given above:
+
+  {"st_switch", target_0="my_door", action_0="close",
+                target_1="my_laser", action_1="off"}
+
+
+The multitarget feature is the successor of the old signal feature. In
+contrast to signals that were bound to tile positions like "stone on
+grid {15, 4}" the multitarget addresses objects themselves. The action
+will find its target even when the user swaps it to another grid postion.
+
+
+C5 - Renaming (partially done)
+-------------
+
+The necessary API changes gives the unique opportunity to simplify
+many old names and to make them consistence. None of names used above
+is fixed. It is up to the level authors to agree on a naming scheme.
+
+Note that valid Lua names start with letter or underscore and consist
+just of these plus numbers.
+
+Just the following rules and conditions need to be observed:
+
+- Short 2 or 3 letter names for the namespace and the special objects
+- System attribute and message names have to be valid Lua names not
+  starting with underscore
+- User attributes start with an underscore
+- System attribute and method names are disjoint
+- Identical system attributes or methods have identical behaviour for
+  all objects
+- User names for objects do not start with "$","#" or "%", do not contain a character
+  out of ",;" and do not end with "#"
+- Object Classnames should use a common scheme of underscore/hyphen
+  usage: Either underscore only, or first hyphen and all other 
+  underscore,... (st_chess_black, st-chess_black, ...)
+
+  Decision of Draft 0.60: all object names will uses exclusivly underscore! 
+
+
+C6 - Global Variables   (coded)
+---------------------
+
+Global variables are handled as attributes of the special world object
+"wo". Write access on variables will be checked and can cause actions
+if necessary. A write to a read only variable like "IsDifficult" will be
+silently ignored.
+
+
+C7 - Critical functions
+-----------------------
+
+All critical functions will be abolished to ensure that new levels
+will be suited for upcoming features. For the very few existing levels
+of the distribution that depend on such features exceptions will be
+hardcoded that will keep these levels to conflict with the new features.
+
+
+C8 - Oxyd   (coded)
+---------
+
+The color attribute is an integer value (0, 1, ..., 7).
+
+Oxyds can be set like any other stones. If no color attribute is
+specified pairs of oxyds with the same color will be set.
+
+To guarantee fair distributions and levels that are solvable the
+author can declare minimum and maximum conditions and groups of
+oxyds like:
+
+wo:shuffleOxyd({grp1, max=0}, {grp1, grp2, min=2}, 
+    {grp1, grp3, min=1, max=1})
+
+As a shortcut groups of oxyds can be declared to be positioned either
+circular or linear. This declaration expands to all rules necessary to
+avoid any neighbour oxyd pairs.
+
+wo:shuffleOxyd({grp(ox1, ox2, ox3, ox4, ox5, ox6), circular=true},
+    {grp2, linear=true})
+
+C9 - Rubberband
+---------------
+
+Rubberband is an object that can be referenced and checked for existance.
+
+
+C10 - Name inheritance   (partially done)
+----------------------
+
+Items like it_seed, it_rubberband that change into stone or rubberband
+objects on activation will inherit their name to the successor stone
+object.
+
+C11 - Checkerboard Floor   (coded)
+------------------------
+
+Every floor takes an attribute "checkerboard". If set to an integer value
+0 the floor will only be placed on grids with x+y being even, if set
+to 1 the floor will be placed only on grids with x+y being uneven.
+
+ti["x"] = ti({"fl_rough_red", checkerboard=0}) + 
+         {"fl_rough_blue", checkerboard=1}
+
+generates an arbitrary shaped checkboardfloor on areas with tile "x"
+on the world map.
+
+C12 - Puzzle
+------------
+
+Puzzles can be autoconfigured and shuffled by the engine. Besides the
+single puzzle stones a dummy stone named "st_puzzle_auto" can be set.
+All adjacent "st_puzzle_auto" and "st_puzzle_hollow" of the same color
+will be configured to a puzzle with maximum number of connections:
+
+ti["#"] = {"st_puzzle_auto"}
+ti["*"] = {"st_puzzle_hollow"}
+
+wo{ti," ",{
+"  # ",
+"##*#",
+"### ",
+" #  "}
+
+results in a puzzle:
+
+   |
+ /T+-
+ \+/
+  |
+
+with the upper "+" being a hollow cross.
+
+If any of the involved puzzle stones has an attribute "shuffle" set
+to "true" the complete puzzle will shuffled. If the value of any
+puzzle stone is an integer it will be taken as the number of permutations
+to be applied. The maximum number of all values will be taken.
+
+Shuffle occurs by permutation of rows and columns that a marble can
+reverse. By default it is assumed that the user can permute rows and
+columns on every side which is not blocked by a stone that is not hollow.
+
+In case the puzzle is only accessable from one side the author can add
+attributes "permute_v" and "permute_h" with boolean values to every
+puzzle stone that does not follow the standard rule.
+
+As hollow puzzle stones will never be permuted to the border of a puzzle
+the author can ensure that every shuffle results in a solvable puzzle.
+
+
+
+Appendix
+========
+
+
+Index/member interpretation and operations of new types:
+--------------------------------------------------------
+
+value = number|string|boolean|object|nil    add  |group|position ?
+
+Enigmaobject:
+  x, y       - grid position access
+
+  exists()
+  is()           - (string)        - test kind
+  kind()         - ()              - get most specific kind
+  kill()         - ()              - kill object
+  message()      - (string [, value]) - send message with an optional value
+  set()          - (table)         - set multiple attributes given in a table
+                                     as key, value pairs
+  xy()
+
+  attribute name       - set/get attribute
+
+  other String not prefixed by "_"   - message
+
+  valid Operations:
+    +            - (object|position|table) + (object|position|table)
+    -            - (object|position|table) - (object|position|table)
+    #            - #object         -- center
+    - (unary)    - -object         -- existance
+    ==           - object == object
+    
+
+Position:
+
+  x, y,          - grid position access
+  
+  grid()               - returns a position aligned to the grid
+  xy()                 - returns x, y
+  
+  valid Operations:
+    +            - (object|position|table) + (object|position|table)
+    -            - (object|position|table) - (object|position|table)
+    *            - (number|position) * (number|position)
+    /            - position / number
+    #            - # position
+    ==           - position == position
+.   ..           - position .. position
+
+Namedobject:
+
+  $String              - reserved for future usage
+  String               - named object access - returns nil if not existing
+                       - name must not include wildcard chars *,?
+  String*?             - get named group with wildcards *,?
+
+Worldobject:
+  [object|position|table|group] = table|tile - write access to world grid
+  [string]             - global world attribute read/write access
+  
+  ()             - (ti|function, string, table) -- initialization "wo(,,)"
+  
+
+  fl()           - (position|table|obj|(num,num)) - get floor at position
+  it()           - (position|table|obj|(num,num))      - get item at position
+  st()           - (position|table|obj|(num,num))      - get stone at position
+  
+  
+  init()         - (ti|function, string, table) -- method synonym for () 
+
+
+Group:
+  1, 2, 3,...          - positve integer as sequence index like table read access
+  String               - on write: set attrib on members
+                       - on access: call method or send message on object
+
+  valid Operations:
+    +                  - join of groups
+    *                  - intersection of groups
+    -                  - difference of groups
+    #                  - length, inherited from table
+
+Tile:
+  
+  valid Operations:
+   ..                   - concat tiles
+   ti(table)            - new tile
+
+
+Tiles:
+  String               - table like read access with string  as index
+                       - write only on not yet existing indices - no overwrite
+		         assign (table|tile)
+
+
+Global Functions  (to be defined)
+----------------
+
+  po(table|[num,num]|obj)
+  fl(position|table|obj|(num,num))
+  it(position|table|obj|(num,num))
+  st(position|table|obj|(num,num))
+
+
+Lua Caveats:
+============
+
+It is a basic LUA feature that the user has no real control about the used
+variable types. This causes overall trouble:
+
+a = "3"
+b = "7"
+c = 4
+b - a == c          -- is true as    7 - 3 == 4
+c + a == b          -- is false as   4 + 3 == 7  but 7 ~= "7"
+
+A similar LUA problem may hit authors in the usage of position constants.
+Expressions like {7,3} may be used anywhere as position arguments as they are
+autoconverted into positions. But care must be taken with direct calculations
+and variable assignments of constant positions:
+
+table = {7, 3}      -- this variable is a simple table with two numbers at
+                    -- the indices 1 and 2 but it is not a position
+wo[table] = obj     -- o.k. as the table gets now converted as an argument
+pos = #table        -- is not a centerd position but a number with value 2
+                    -- as it the length operation of a table
+pos = table + {1,2} -- error as two tables cannot be added like positions
+pos = obj + table   -- o.k. as obj is a position that forces an autoconvert
+                    -- of the table
+
+
+Another similar Lua caveat exists in the position comparison. Even though
+you can use objects as position standins anywhere else the Lua comparison of
+variables priorises the type comparison to the value comparison:
+
+pos = po(3, 5)
+wo[pos] = {"st-switch"}
+obj = st(pos)
+pos == obj          -- false as the types differ
+pos == po(obj)      -- true as types and values are equal
+
+
+
+Lua index syntax - different treatment of numbers, names and strings:
+
+1, 2                        -- are valid Lua numbers
+x, y, otto2, _myX           -- are valid Lua names
+"$secret", "1", "fl-abyss"  -- are just Lua strings
+
+x = 7
+pos = po(3, 5)
+pos["x"]          -- valid table like access to x coordinate
+pos[x]            -- error as pos[7] is accessed
+pos.x             -- valid member access that is equivalent to pos["x"]
+obj["state"]      -- valid access to attribute "state"
+obj[state]        -- error as global variable "state" is first evaluated (nil)
+obj.state         -- valid access to attribute "state"
+tab[1]            -- valid table access to first entry
+tab["1"]          -- table access to entry at key "1" which is not the first
+                  --   table entry but likley nil.
+tab.1             -- error - Lua needs a valid Lua-name as member
+
+


Property changes on: trunk/doc/reference/ConceptLuaAPI2.txt
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/doc/reference/enigma-ref.texi
===================================================================
--- trunk/doc/reference/enigma-ref.texi	2008-04-12 09:04:17 UTC (rev 1100)
+++ trunk/doc/reference/enigma-ref.texi	2008-04-12 09:34:19 UTC (rev 1101)
@@ -3044,7 +3044,7 @@
 You can generate an initially open door by setting its attributes. But how
 can a switch stone open a door when it is hit by a marble? It simply sends
 a message @samp{open} to the door. Another switch may send a message
- at samp{on} to a laser or @samp{ignite} to a @ref{it_dynamite}. On explosion
+ at samp{on} to a laser or @samp{ignite} to an @ref{it_dynamite}. On explosion
 the dynamite will in turn send automatically @samp{ignite} messages to the
 neighbour grid positions.
 
@@ -3176,7 +3176,9 @@
 @samp{0} representing @samp{WEST}.
 
 In most cases it is sufficient to perform a state independent common action
-like @ref{toggle}. But sometimes you may want to perform state specific actions.
+like @ref{toggle}. Even two stated objects can be easily sychronized by the
+standard action @ref{signal}. But sometimes you may want to perform very state
+specific actions. Let us look how this can be done.
 
 E.g. a @ref{st_fourswitch} that switches two @ref{st_laser} beaming in 3 states
 but one of them being switched off while in @samp{EAST} state and the other being
@@ -3212,7 +3214,7 @@
 the first trigger should switch the laser on, an object pressing the second
 trigger should switch it off. But a trigger is two stated and performs one
 action on being pressed and another on being released. Thus we want to block
-the actions an trigger release events:
+the actions on trigger release events:
 
 @example
 @{it_trigger, name="on_trigger",  target="laser#1", action_1="on", action_0="nop"@}
@@ -3337,6 +3339,8 @@
 @node Lua API
 @chapter Lua API
 
+Read API Concept Draft
+
 @c ===================  Commons  =======================
 @node Common Attributes and Messages
 @chapter Common Attributes and Messages
@@ -3349,6 +3353,7 @@
 @menu
 * Common Attributes:: 
 * Common Messages::   
+* Global Attributes::
 @end menu
 
 @node Common Attributes
@@ -3425,7 +3430,31 @@
 @node destination
 @subsection destination
 
+An attribute that describes one or several destinations. It is used by objects
+like @ref{it_vortex} and @ref{it_wormhole} to describe their teleporting
+destination.
 
+Note that this attribute is only supported if it is listed in the individual
+description.
+
+ at table @asis
+ at item @b{Type:} @ @ tokens or a single position
+Just a single position for a first destination is allowed. Use tokens to
+define multiple destination.
+ at item @b{Values:} @ @ @xref{Object Attributes}
+ at example
+destination = po(3.0, 4.7)
+destination = "myFloor"
+destination = myObject
+destination = @{"vortex2","vortex3","vortex4"@}
+ at end example
+Note that objects like @samp{it_wormhole} that have just a single destination
+do take the first token object.
+ at item @b{Default:} @ @ @code{nil}
+ at item @b{Access:} @ @ read/write
+ at item @b{Support:} @ @ by teleporting objects
+ at end table
+
 @node Common Messages
 @section Common Messages
 
@@ -3460,6 +3489,76 @@
 @node close
 @subsection close
 
+ at node Global Attributes
+ at section Global Attributes
+
+ at menu
+* MagnetRange:: 
+* MagnetStrength:: 
+* WormholeRange:: 
+* WormholeStrength:: 
+ at end menu
+
+ at node MagnetRange
+ at subsection MagnetRange
+
+A global default distance up to which magnets apply forces to actors. This
+global value is only used if no object specific value is set. 
+
+ at table @asis
+ at item @b{Type:} @ @ number
+ at item @b{Values:} @ @ positive float number or zero
+ at item @b{Default:} @ @ @code{10.0}
+ at item @b{Access:} @ @ read/write
+ at item @b{Support:} @ @ @ref{it_magnet}
+ at end table
+
+ at node MagnetStrength
+ at subsection MagnetStrength
+
+A global scalar default factor for magnet forces. Positive numbers are 
+attracting forces where as negative numbers are repelling forces. This global 
+value is only used if no object specific value is set. 
+
+ at table @asis
+ at item @b{Type:} @ @ number
+ at item @b{Values:} @ @ float number
+ at item @b{Default:} @ @ @code{30.0}
+Positve number are attracting, negative numbers are repelling.
+ at item @b{Access:} @ @ read/write
+ at item @b{Support:} @ @ @ref{it_magnet}
+ at end table
+
+ at node WormholeRange
+ at subsection WormholeRange
+
+A global default distance up to which wormholes apply forces to actors. This
+global value is only used if no object specific value is set. 
+
+ at table @asis
+ at item @b{Type:} @ @ number
+ at item @b{Values:} @ @ positive float number or zero
+ at item @b{Default:} @ @ @code{10.0}
+ at item @b{Access:} @ @ read/write
+ at item @b{Support:} @ @ @ref{it_wormhole}
+ at end table
+
+ at node WormholeStrength
+ at subsection WormholeStrength
+
+A global scalar default factor for wormhole forces. Positive numbers are 
+attracting forces where as negative numbers are repelling forces. This global 
+value is only used if no object specific value is set. 
+
+ at table @asis
+ at item @b{Type:} @ @ number
+ at item @b{Values:} @ @ float number
+ at item @b{Default:} @ @ @code{30.0}
+Positve number are attracting, negative numbers are repelling.
+ at item @b{Access:} @ @ read/write
+ at item @b{Support:} @ @ @ref{it_wormhole}
+ at end table
+
 @c ===================  Floors  =======================
 
 @node Floor Objects
@@ -3478,13 +3577,19 @@
 
 @menu
 * it_blocker::         Shrinked Blocker Stone
+* it_brush::           
+* it_coin::            Enigma's currency
 * it_extralife::
+* it_floppy::          
 * it_hammer::
+* it_key::             
 * it_magnet::
 * it_sword::
 * it_trigger::         Floor Switch for Actors and Stones
-* it_umbrella::
-* it_wormhole::
+* it_umbrella::        Death Protection Item
+* it_vortex::          Teleport of Marbels
+* it_wormhole::        Teleport of Actors
+* it_wrench::          
 @end menu
 
 
@@ -3568,6 +3673,66 @@
 
 @end table
 
+ at c ----------------- Brush Item -------------------- 
+ at node it_brush
+ at subsection it_brush
+ at obindex it_brush
+
+
+ at table @asis
+
+ at item @b{Attributes:} none
+
+ at item @b{Messages:} none
+
+ at end table
+
+ at c ----------------- Coin Item -------------------- 
+ at node it_coin
+ at subsection it_coin
+ at obindex it_coin
+
+A coin activates an @ref{st_coinslot} when inserted by hitting the stone with
+the coin as first item in the players inventory. The time interval of activity 
+of the coinslot depends on the coin type that is represented by its 
+ at samp{state}. Small, medium and large coin variants do exist.
+
+When hit by a moving stone the coin type changes from small to medium and
+from medium to large.
+
+A laser beam transforms a small coin into an @ref{it_umbrella}, a medium coin
+into an @ref{it_hammer} and a large coin into an @ref{it_extralife}.
+
+A coin that comes into existence on an illuminated grid position will not
+transform due to already existing laser beams. But it will transform on the first
+additional beam and on laser beams that are switched off and on again.
+
+ at table @asis
+
+ at item @b{Attributes:}
+
+ at table @asis
+ at item @b{state}, @ @ @i{values}: @code{0}, @code{1}, @code{2}; @ @ @i{access}: @code{read only} @ @ @xref{state}
+Represents the coin type with 0 being a small coin, 1 being a medium coin and
+2 being a large coin.
+ at end table
+
+ at item @b{Messages:} none
+
+ at item @b{Variants:}
+ at table @asis
+ at item @b{it_coin}
+A small coin.
+ at item @b{it_coin_s}
+A small coin.
+ at item @b{it_coin_m}
+A medium coin.
+ at item @b{it_coin_l}
+A large coin.
+ at end table
+
+ at end table
+
 @c ----------------- Extralife Item -------------------- 
 @node it_extralife
 @subsection it_extralife
@@ -3596,6 +3761,22 @@
 
 @end table
 
+ at c ----------------- Floppy Item -------------------- 
+ at node it_floppy
+ at subsection it_floppy
+ at obindex it_floppy
+
+A floppy activates an @ref{st_floppy} when inserted by hitting the stone with
+the floppy as first item in the players inventory.
+
+ at table @asis
+
+ at item @b{Attributes:} none
+
+ at item @b{Messages:} none
+
+ at end table
+
 @c ----------------- Hammer Item -------------------- 
 @node it_hammer
 @subsection it_hammer
@@ -3628,11 +3809,83 @@
 
 @end table
 
+ at c ----------------- Key Item -------------------- 
+ at node it_key
+ at subsection it_key
+ at obindex it_key
+
+A key activates an @ref{st_key} when inserted by hitting the stone with
+the key as first item in the players inventory.
+
+ at table @asis
+
+ at item @b{Attributes:} none
+
+ at table @asis
+ at item @b{code}, @ @ @i{values}: number; @ @ @i{default}: @code{1}
+The code of a key must match that of an @ref{st_key} to unlock it.
+ at end table
+
+ at item @b{Messages:} none
+
+ at end table
+
 @c ----------------- Magnet Item -------------------- 
 @node it_magnet
 @subsection it_magnet
 @obindex it_magnet
 
+Attracts or repells actors in its @samp{range} with a force proportional to the
+ at samp{strength} and the inverse of the squared distance. A magnet can be 
+switched @samp{ON} and @samp{OFF}.
+
+Note that no forces are applied to actors at a distance smaller than 0.05 grids
+to avoid extraordinary large forces.
+
+ at table @asis
+ at item @b{Attributes:}
+
+ at table @asis
+ at item @b{state}, @ @ @i{values}: @code{ON}, @code{OFF}; @ @ @i{default}: @code{OFF} @ @ @xref{state}
+The current magnet state - @samp{ON} for an active magnet, @samp{OFF} for an
+inactive magnet.
+
+ at item @b{range} @ @ @i{values}: float number greater equal 0; @ @ @i{default}: @code{10.0} @ @ @xref{MagnetRange}
+The distance up to which the magnet applies forces to actors.
+
+ at item @b{strength} @ @ @i{values}: float number; @ @ @i{default}: @code{+30.0} @ @ @xref{MagnetStrength}
+A scalar factor for magnet forces. Positive numbers are attracting forces
+where as negative numbers are repelling forces.
+ at end table
+
+ at item @b{Messages:}
+
+ at table @asis
+ at item @b{signal} @ @ @xref{signal}
+A signal of value 1 switches the magnet on, a value of 0 switches the magnet off.
+ at item @b{toggle} @ @ @xref{toggle}
+A toggle causes a change in the magnet activity state.
+ at item @b{on} @ @ @xref{on}
+Switches the magnet on.
+ at item @b{off} @ @ @xref{off}
+Switches the magnet off.
+ at end table
+
+ at item @b{Action:}
+none
+
+ at item @b{Variants:}
+ at table @asis
+ at item @b{it_magnet}
+A magnet in state @samp{OFF}.
+ at item @b{it_magnet_on}
+A magnet in state @samp{ON}.
+ at item @b{it_magnet_off}
+A magnet in state @samp{OFF}.
+ at end table
+
+ at end table
+
 @c ----------------- Sword Item -------------------- 
 @node it_sword
 @subsection it_sword
@@ -3668,7 +3921,7 @@
 @subsection it_trigger
 @obindex it_trigger
 
-The trigger item is a switch on top of the floor that reacts on actors and
+The trigger item is a switch on top of a floor that reacts on actors and
 stones on top of it that may press it. It performs actions when it is initially
 pressed and again when it releases after the last object left it. A pressed 
 trigger is in state @samp{ON} and will send an action value of @samp{true}, a 
@@ -3751,17 +4004,182 @@
 
 @end table
 
+ at c ----------------- Vortex Item -------------------- 
+ at node it_vortex
+ at subsection it_vortex
+ at obindex it_vortex
+
+Teleports marbles to a given @samp{destination}. Unlike @ref{it_wormhole} it
+does not teleport other actors.
+
+In the simplest case, a vortex is connected to a single destination given by
+an object or a position. If the destination is not blocked by a stone the
+marble will be teleported to the destination.
+
+If there multiple destination addresses are given, the marble will be teleported
+to the single destinations in sequence. Blocked destinations are indicated by
+sparkles. Finally the marble exists on the first unblocked destination. If no
+unblocked destination exists the marble exists on the starting vortex. A level
+author can write nice puzzle which require the user to block destinations to
+reach the final destination of a vortex.
+
+Vortices can be open or closed. Of course a marble can enter just an open
+vortex. Closed vortices at the destination are opened automatically. By default
+such vortices remain open. By usage of the attribute @samp{autoclose} you can
+configure a vortex to close after a marble has been emitted.
+
+Marbles are emitted by vortices in a jumping fashion. The user can accelerate
+the marble for a short period and the marble may jump out of a vortex into a
+desired direction.
+
+Vortex teleportation take a short amount of time and the involved vortices are
+blocked for other teleporting request during this process. Thus it is no problem
+to set up destinations of vortices that build a cycle.
+
+Rubberbands bound to teleported actors are cut by default. The attribute
+ at samp{scissor} allows you to control the cutting behaviour.
+
+
+ at table @asis
+ at item @b{Attributes:}
+
+ at table @asis
+ at item @b{state}, @ @ @i{values}: @code{OPEN}, @code{CLOSED}; @ @ @i{default}: @code{OPEN} @ @ @xref{state}
+The visual state of a vortex. An @samp{OPEN} vortex may still be busy due
+to ongoing teleportations and may not accept a marble.
+
+ at item @b{destination}, @ @ @i{values}: tokens or position; @ @ @i{default}: @code{nil} @ @ @xref{destination}
+The destination of the teleport given by an object or a position.
+
+ at item @b{autoclose}, @ @ @i{values}: @code{true}, @code{false}; @ @ @i{default}: @code{false}
+Flag that indicates whether the vortex should be closed after a teleport.
+
+ at item @b{scissor}, @ @ @i{values}: @code{true}, @code{false}; @ @ @i{default}: @code{true}
+Rubberband cutting behaviour on teleporting.
+
+ at item @b{Messages:}
+
+ at table @asis
+ at item @b{signal} @ @ @xref{signal}
+Opens the vortex on value @samp{1}, and closes the vortex on value @samp{0}.
+ at item @b{toggle} @ @ @xref{toggle}
+Opens a closed vortex and closes an open vortex if possible.
+ at item @b{open} @ @ @xref{open}
+Try to open a vortex.
+ at item @b{close} @ @ @xref{close}
+Try to close a vortex.
+ at end table
+
+ at item @b{Action:}
+none
+
+ at end table
+
 @c ----------------- Wormhole Item -------------------- 
 @node it_wormhole
 @subsection it_wormhole
 @obindex it_wormhole
 
+Teleports actors of any kind to a given @samp{destination}. Unlike 
+ at ref{it_vortex} every wormhole has a unique destination. But of course the
+destination may be another wormhole which instantly teleports the actor again.
+Infinite circle of wormholes conneted by destinations are forbidden.
+
+A wormhole can attract or repell actors in its @samp{range} with a force
+proportional to the @samp{strength} and the inverse of the squared distance.
+The force can be switched @samp{ON} and @samp{OFF} and is represented by its
+external @samp{state}. Note that no forces are applied to actors at a distance
+smaller than 0.05 grids to avoid extraordinary large forces.
+
+Rubberbands bound to teleported actors are cut by default. The attribute
+ at samp{scissor} allows you to control the cutting behaviour.
+
+After teleporting an actor, the wormhole's teleporting ability may be switched
+off for a short latency period given by @samp{interval}. A letancy separates
+actors travelling through a wormhole and avoids overlapping actors at the
+destination.
+
+ at table @asis
+ at item @b{Attributes:}
+
+ at table @asis
+ at item @b{state}, @ @ @i{values}: @code{ON}, @code{OFF}; @ @ @i{default}: @code{OFF} @ @ @xref{state}
+The current force state - @samp{ON} for an force applying wormholes, @samp{OFF}
+for force neutral wormholes.
+
+ at item @b{destination}, @ @ @i{values}: tokens or position; @ @ @i{default}: @code{nil} @ @ @xref{destination}
+The destination of the teleport given by an object or a position.
+
+ at item @b{range} @ @ @i{values}: float number greater equal 0; @ @ @i{default}: @code{10.0} @ @ @xref{WormholeRange}
+The distance up to which the wormhole applies forces to actors.
+
+ at item @b{strength} @ @ @i{values}: float number; @ @ @i{default}: @code{+30.0} @ @ @xref{WormholeStrength}
+A scalar factor for the wormhole force. Positive numbers are attracting forces
+where as negative numbers are repelling forces.
+ at end table
+
+ at item @b{scissor}, @ @ @i{values}: @code{true}, @code{false}; @ @ @i{default}: @code{true}
+Rubberband cutting behaviour on teleporting.
+
+ at item @b{interval} @ @ @i{values}: float number greater equal 0; @ @ @i{default}: @code{0.0}
+The letancy time after a teleport during which no further teleports take place.
+
+
+ at item @b{Messages:}
+
+ at table @asis
+ at item @b{signal} @ @ @xref{signal}
+A signal of value 1 switches the wormhole force on, a value of 0 switches the
+wormhole force off.
+ at item @b{toggle} @ @ @xref{toggle}
+A toggle causes a change in the wormhle force activity state.
+ at item @b{on} @ @ @xref{on}
+Switches the wormhole on.
+ at item @b{off} @ @ @xref{off}
+Switches the wormhole off.
+ at end table
+
+ at item @b{Action:}
+none
+
+ at item @b{Variants:}
+ at table @asis
+ at item @b{it_wormhole}
+A wormhole in state @samp{OFF}.
+ at item @b{it_wormhole_on}
+A wormhole in state @samp{ON}.
+ at item @b{it_wormhole_off}
+A wormhole in state @samp{OFF}.
+ at end table
+
+ at end table
+
+ at c ----------------- Wrench Item -------------------- 
+ at node it_wrench
+ at subsection it_wrench
+ at obindex it_wrench
+
+A wrench wielded as first item in the players inventory causes some objects
+to react on actor hits. An @ref{st_rotator} changes its turning direction.
+An green @ref{st_turnstile} rotates backwards when hit. An @ref{st_window}
+face pushed with an wrench will swap to the opposite side of the stone if
+possible.
+
+ at table @asis
+
+ at item @b{Attributes:} none
+
+ at item @b{Messages:} none
+
+ at end table
+
 @c ===================  Stones  =======================
 @node Stone Objects
 @chapter Stone Objects
 
 @menu
-* Simple Stones:: 
+* Simple Stones::
+* Cluster Stones::
 * Transparent Stones::
 * Breakable Stones::
 * Special Stones::
@@ -3771,6 +4189,169 @@
 @node Simple Stones
 @section Simple Stones
 
+ at node Cluster Stones
+ at section Cluster Stones
+
+A cluster stone is a passive wall stone like a simple stone. But several
+cluster stones adjacent to each other can visually build a cluster and look
+like a single big stone with a one common outer face.
+
+ at menu
+* Cluster Features::   Common Attributes and Features
+* st_bluesand::        big sand stone look
+* st_brick::           brick wall look
+* st_panel::           wooden panel look
+ at end menu
+
+ at c ----------------- Cluster Features -------------------- 
+ at node Cluster Features
+ at subsection Cluster Features
+
+For each cluster stone there exist 16 different variations that represent all
+needed combinations of inner and outer faces to build arbitrary shaped big
+blocks. 
+
+There exist two methods of describing a special variation. You can either give
+the inner faces, the @samp{connections}, those sides that should be adjacent to
+other stones of the same cluster. Or you can give the outer faces, the 
+ at samp{faces}, that build the common outer face of the resulting big block.
+
+As it is a tedious work to set up larger blocks by their single stones with
+appropriate faces you can rely on an automatical clustering feature. Just
+set the @samp{cluster} attribute of all single stones of a big block to the
+same number and the faces will be set up automatically to form a large block.
+
+You can build a screen of arbitrary big blocks and it is proven that there will
+be never be the need of more than 4 different cluster numbers (the "4 color 
+theorem"). But for convenience you are free to use additional cluster numbers
+as you like. Note that the autoclustering is quite dynamic. A single cluster
+stone with fitting cluster number that is swapped at the side of an existing
+block with the same cluster number will melt and join the block like seen in
+"Terminator 2".
+
+We recommend making use of the autoclustering feature by setting the 
+ at samp{cluster} attribute and using the @samp{faces} attribute where necessary.
+ at samp{connections} attribute and explicit naming of variations by suffices 
+are depreceated, but will continue to be supported.
+
+ at table @asis
+ at item @b{Attributes:}
+
+ at table @asis
+ at item @b{connections}, @ @ @i{values}: string; @ @ @i{default}: @code{nil}
+Describes the inner faces of stone. The string is a substring of @code{"nesw"}
+listing the inner faces. The sequence of the sides, north, east, south, west,
+is guaranteed on read access but arbitrary on write access.
+
+ at item @b{faces} @ @ @i{values}: string; @ @ @i{default}: @code{nil}
+Describes the outer faces of stone. The string is a substring of @code{"nesw"}
+listing the outer faces. The sequence of the sides, north, east, south, west,
+is guaranteed on read access but arbitrary on write access.
+
+ at item @b{cluster} @ @ @i{values}: number; @ @ @i{default}: @code{nil}
+If set to a number all adjacent cluster stones of the same base type with
+the identical cluster number will build a big block. This attribute superceeds
+any explicit given face description.
+
+ at end table
+ at end table
+
+ at c ----------------- Bluesand Stone -------------------- 
+ at node st_bluesand
+ at subsection st_bluesand
+ at obindex st_bluesand
+
+A standard cluster stone with the @ref{Cluster Features}. It is recommended
+to use @samp{st_bluesand} with the attributes @samp{cluster} and @samp{faces}.
+
+ at table @asis
+ at item @b{Variants:}
+ at table @asis
+ at item @b{st_bluesand}: connections = @code{""}
+ at item @b{st_bluesand_w}: connections = @code{"w"}
+ at item @b{st_bluesand_s}: connections = @code{"s"}
+ at item @b{st_bluesand_sw}: connections = @code{"sw"}
+ at item @b{st_bluesand_e}: connections = @code{"e"}
+ at item @b{st_bluesand_ew}: connections = @code{"ew"}
+ at item @b{st_bluesand_es}: connections = @code{"es"}
+ at item @b{st_bluesand_esw}: connections = @code{"esw"}
+ at item @b{st_bluesand_n}: connections = @code{"n"}
+ at item @b{st_bluesand_nw}: connections = @code{"nw"}
+ at item @b{st_bluesand_ns}: connections = @code{"ns"}
+ at item @b{st_bluesand_nsw}: connections = @code{"nsw"}
+ at item @b{st_bluesand_ne}: connections = @code{"ne"}
+ at item @b{st_bluesand_new}: connections = @code{"new"}
+ at item @b{st_bluesand_nes}: connections = @code{"nes"}
+ at item @b{st_bluesand_nesw}: connections = @code{"nesw"}
+
+ at end table
+
+ at end table
+
+ at c ----------------- Brick Stone -------------------- 
+ at node st_brick
+ at subsection st_brick
+ at obindex st_brick
+
+A standard cluster stone with the @ref{Cluster Features}. It is recommended
+to use @samp{st_brick} with the attributes @samp{cluster} and @samp{faces}.
+
+ at table @asis
+ at item @b{Variants:}
+ at table @asis
+ at item @b{st_brick}: connections = @code{""}
+ at item @b{st_brick_w}: connections = @code{"w"}
+ at item @b{st_brick_s}: connections = @code{"s"}
+ at item @b{st_brick_sw}: connections = @code{"sw"}
+ at item @b{st_brick_e}: connections = @code{"e"}
+ at item @b{st_brick_ew}: connections = @code{"ew"}
+ at item @b{st_brick_es}: connections = @code{"es"}
+ at item @b{st_brick_esw}: connections = @code{"esw"}
+ at item @b{st_brick_n}: connections = @code{"n"}
+ at item @b{st_brick_nw}: connections = @code{"nw"}
+ at item @b{st_brick_ns}: connections = @code{"ns"}
+ at item @b{st_brick_nsw}: connections = @code{"nsw"}
+ at item @b{st_brick_ne}: connections = @code{"ne"}
+ at item @b{st_brick_new}: connections = @code{"new"}
+ at item @b{st_brick_nes}: connections = @code{"nes"}
+ at item @b{st_brick_nesw}: connections = @code{"nesw"}
+
+ at end table
+
+ at end table
+ at c ----------------- Panel Stone -------------------- 
+ at node st_panel
+ at subsection st_panel
+ at obindex st_panel
+
+A standard cluster stone with the @ref{Cluster Features}. It is recommended
+to use @samp{st_panel} with the attributes @samp{cluster} and @samp{faces}.
+
+ at table @asis
+ at item @b{Variants:}
+ at table @asis
+ at item @b{st_panel}: connections = @code{""}
+ at item @b{st_panel_w}: connections = @code{"w"}
+ at item @b{st_panel_s}: connections = @code{"s"}
+ at item @b{st_panel_sw}: connections = @code{"sw"}
+ at item @b{st_panel_e}: connections = @code{"e"}
+ at item @b{st_panel_ew}: connections = @code{"ew"}
+ at item @b{st_panel_es}: connections = @code{"es"}
+ at item @b{st_panel_esw}: connections = @code{"esw"}
+ at item @b{st_panel_n}: connections = @code{"n"}
+ at item @b{st_panel_nw}: connections = @code{"nw"}
+ at item @b{st_panel_ns}: connections = @code{"ns"}
+ at item @b{st_panel_nsw}: connections = @code{"nsw"}
+ at item @b{st_panel_ne}: connections = @code{"ne"}
+ at item @b{st_panel_new}: connections = @code{"new"}
+ at item @b{st_panel_nes}: connections = @code{"nes"}
+ at item @b{st_panel_nesw}: connections = @code{"nesw"}
+
+ at end table
+
+ at end table
+
+
 @node Transparent Stones
 @section Transparent Stones
 @node Breakable Stones
@@ -3781,9 +4362,15 @@
 @menu
 * st_blocker::         Shrinkable Blocker
 * st_boulder::         Moving Arrow Boulder
+* st_coinslot::        Coin Driven Switch
+* st_floppy::          Floppy Driven Switch
 * st_fourswitch::      Four Direction Switch
+* st_key::             Key Driven Switch
 * st_laser::           Lightemitting Laser
+* st_laserflop::       Lightsensitive Monoflop
 * st_laserswitch::     Lightsensitive Switch
+* st_monoflop::        Monoflop Switch
+* st_oxyd::            Game Target Stone
 * st_polarswitch::     Transparency Switch for Light Beams
 * st_switch::          Classical on/off Switch
 * st_timer::           Animated Timer
@@ -3935,6 +4522,97 @@
 
 @end table
 
+ at c ----------------- Coinslot Stone -------------------- 
+ at node st_coinslot
+ at subsection st_coinslot
+ at obindex st_coinslot
+
+A switch that is activated by insertion of an @ref{it_coin}. Just actors
+assigned to a player can insert coins out of their item inventory by hitting
+the coinslot with the coin being the first item. Depending on the coin type the
+coinslot remains in state @samp{ON} for a given @samp{interval} before switching
+back to state @samp{OFF}. Multiple inserted coins do prolong the activity 
+interval.
+
+Standard not @samp{instant} coinslots do activate after the insertion process
+of the coin. No additional coins can be inserted while another coin is being
+inserted. This prevents unintended multiple coin insertions. On the other hand
+the player has to insert additional coins early enough to prolong the active
+state without temporaryly switching back to @samp{OFF} state. If the first
+interval runs off while the next coin did not yet finish its insertion the
+coinslot will first switch @samp{OFF} and switch @samp{ON} when the next coin
+is completly inserted.
+
+Coinslots configured as @samp{instant} do activy immediatly when the actor
+hits the stone. On every actor hit a coin is inserted independent of the last
+insertion.
+
+The @samp{state} of a coinslot can be requested but it can not be set, neither
+by attribute nor by messages.
+
+ at table @asis
+ at item @b{Attributes:}
+
+ at table @asis
+ at item @b{state}, @ @ @i{values}: @code{ON}, @code{OFF}; @ @ @i{default}: @code{OFF}: @i{access}: @code{read only}  @ @ @xref{state}
+Current activity state of the coinslot.
+ at item @b{instant} @ @ @i{values}: @code{true}, @code{false}; @ @ @i{default}: @code{false}
+A default coinslot switches to active state after insertion of a coin and allows
+the insertion of just one coin at a time.
+ at item @b{interval_s} @ @ @i{values}: positive number; @ @ @i{default}: @code{3.0}
+Number of additional active seconds on insertion of a small @ref{it_coin}.
+ at item @b{interval_m} @ @ @i{values}: positive number; @ @ @i{default}: @code{6.0}
+Number of additional active seconds on insertion of a medium @ref{it_coin}.
+ at item @b{interval_l} @ @ @i{values}: positive number; @ @ @i{default}: @code{12.0}
+Number of additional active seconds on insertion of a large @ref{it_coin}.
+ at end table
+
+ at item @b{Messages:} none
+
+ at item @b{Action:} @ @ @xref{target}, @ @ @xref{action}
+
+ at item @b{Variants:}
+
+ at table @asis
+ at item @b{st_coinslot}: instant = @code{false}
+ at item @b{st_coinslot_instant}: instant = @code{true}
+ at end table
+
+ at end table
+
+ at c ----------------- Floppy Stone -------------------- 
+ at node st_floppy
+ at subsection st_floppy
+ at obindex st_floppy
+
+A switch that is activated by insertion of an @ref{it_floppy}. Just actors
+assigned to a player can insert a floppy out of their item inventory by hitting
+the floppy switch with a floppy being the first item. 
+
+On a second hit the switch is deactivated and the inserted floppy is returned
+to the players inventory.
+
+ at table @asis
+ at item @b{Attributes:}
+
+ at table @asis
+ at item @b{state}, @ @ @i{values}: @code{ON}, @code{OFF}; @ @ @i{default}: @code{OFF}: @ @ @xref{state}
+Current activity state of the floppy stone.
+ at end table
+
+ at item @b{Messages:}
+
+ at table @asis
+ at item @b{signal} @ @ @xref{signal}
+Switches on at value @samp{1}, and off at values @samp{0}.
+ at item @b{on} @ @ @xref{on}
+ at item @b{off} @ @ @xref{off}
+ at end table
+
+ at item @b{Action:} @ @ @xref{target}, @ @ @xref{action}
+
+ at end table
+
 @c ----------------- Fourswitch Stone -------------------- 
 @node st_fourswitch
 @subsection st_fourswitch
@@ -3992,6 +4670,41 @@
 and off alternative sources by a fourswitch.
 @end table
 
+ at c ----------------- Key Stone -------------------- 
+ at node st_key
+ at subsection st_key
+ at obindex st_key
+
+A switch that is activated by insertion of an @ref{it_key}. Just actors
+assigned to a player can insert a key out of their item inventory by hitting
+the key switch with a key being the first item. Just keys with a matching
+ at samp{code} are accepted.
+
+On a second hit the switch is deactivated and the inserted key is returned
+to the players inventory.
+
+ at table @asis
+ at item @b{Attributes:}
+
+ at table @asis
+ at item @b{state}, @ @ @i{values}: @code{ON}, @code{OFF}; @ @ @i{default}: @code{OFF}: @ @ @xref{state}
+Current activity state of the key stone.
+ at item @b{code}, @ @ @i{values}: number; @ @ @i{default}: @code{1}:
+The code that is required to activy this switch.
+ at end table
+
+ at item @b{Messages:}
+
+ at table @asis
+ at item @b{signal} @ @ @xref{signal}
+Switches on at value @samp{1}, and off at values @samp{0}.
+ at item @b{on} @ @ @xref{on}
+ at item @b{off} @ @ @xref{off}
+ at end table
+
+ at item @b{Action:} @ @ @xref{target}, @ @ @xref{action}
+
+ at end table
 @c ----------------- Laser Stone -------------------- 
 @node st_laser
 @subsection st_laser
@@ -4057,6 +4770,53 @@
 
 @end table
 
+ at c ----------------- Laserflop Stone -------------------- 
+ at node st_laserflop
+ at subsection st_laserflop
+ at obindex st_laserflop
+
+A switch that is triggered by actor hits and laser light. It switches instantly 
+to state @samp{ON} and when it is no longer illuminated it switches back to
+state @samp{OFF} after a given @samp{interval}. Repeatitive actor hits and 
+continuing laser light will prolong the @samp{ON} state untill a trailing 
+ at samp{interval} after the last hit has been expired. A similar object without
+light sensitiveness is the @ref{st_monoflop}.
+
+The single state cycle, called monoflop, can be initiated by @samp{on} and
+ at samp{signal} messages. But an activated monoflop cannot be stopped by
+messages or state setting.
+
+At initialization a laserflop that is exposed to laser light will start in state
+ at samp{ON} without sending actions due to the @ref{Snapshot Principle}.
+
+A laserflop that is moved or swapped in or out of a laser beam will act on
+the light change with proper actions.
+
+ at table @asis
+ at item @b{Attributes:}
+
+ at table @asis
+ at item @b{state}, @ @ @i{values}: @code{ON}, @code{OFF}; @ @ @i{default}: @code{OFF}; @ @ @xref{state}
+Represents the activity state. The state of a new object can be set, but an
+active monoflop cannot be set to state @samp{OFF}.
+ at item @b{interval} @ @ @i{values}: positive number; @ @ @i{default}: @code{1.8}
+Number of seconds to return to state @samp{OFF} after the last hit.
+
+ at end table
+
+ at item @b{Messages:}
+
+ at table @asis
+ at item @b{signal} @ @ @xref{signal}
+Switches on at value @samp{1}. A values of @samp{0} is ignored.
+ at item @b{on} @ @ @xref{on}
+Switch the monoflop on like on an actor hit.
+ at end table
+
+ at item @b{Action:} @ @ @xref{target}, @ @ @xref{action}
+
+ at end table
+
 @c ----------------- Laserswitch Stone -------------------- 
 @node st_laserswitch
 @subsection st_laserswitch
@@ -4088,6 +4848,158 @@
 
 @end table
 
+ at c ----------------- Monoflop Stone -------------------- 
+ at node st_monoflop
+ at subsection st_monoflop
+ at obindex st_monoflop
+
+A switch that is triggered by actor hits. It switches instantly to
+state @samp{ON} and after a given @samp{interval} back to state @samp{OFF}.
+Repeatitive actor hits will prolong the @samp{ON} state untill a trailing 
+ at samp{interval} after the last hit has been expired. A switch similar to
+the monoflop is the @ref{st_laserflop}, which is additionally light sensitive.
+
+The single state cycle, called monoflop, can be initiated by @samp{on} and
+ at samp{signal} messages. But an activated monoflop cannot be stopped by
+messages or state setting.
+
+ at table @asis
+ at item @b{Attributes:}
+
+ at table @asis
+ at item @b{state}, @ @ @i{values}: @code{ON}, @code{OFF}; @ @ @i{default}: @code{OFF}; @ @ @xref{state}
+Represents the activity state. The state of a new object can be set, but an
+active monoflop cannot be set to state @samp{OFF}.
+ at item @b{interval} @ @ @i{values}: positive number; @ @ @i{default}: @code{1.8}
+Number of seconds to return to state @samp{OFF} after the last hit.
+
+ at end table
+
+ at item @b{Messages:}
+
+ at table @asis
+ at item @b{signal} @ @ @xref{signal}
+Switches on at value @samp{1}. A values of @samp{0} is ignored.
+ at item @b{on} @ @ @xref{on}
+Switch the monoflop on like on an actor hit.
+ at end table
+
+ at item @b{Action:} @ @ @xref{target}, @ @ @xref{action}
+
+ at end table
+
+ at c ----------------- Oxyd Stone -------------------- 
+ at node st_oxyd
+ at subsection st_oxyd
+ at obindex st_oxyd
+
+The main target stones of the game. Opening all regular oxyd stones is the
+standard goal of the existing @ref{Ending Conditions}. Regular oxyds stones show
+a color spot when opening. Pairs of same colored stones have to be opened in
+sequence, otherwise the first one closes again.
+
+Even though most levels make use of just a single pair of each color, there
+is no limit on a single color. If you like you can define 3 blue pairs of oxyds
+together with 2 yellow pairs. You do this by setting explicit @samp{color}
+attributes to the oxyds.
+
+For standard levels the @samp{color} can be set to its default @samp{OXYD_AUTO}.
+This causes an automatic coloring by pairs of colors in the standard color
+sequence.
+
+There is no limit on the number of used oxyd pairs. But as just 8 colors do exist
+the colors will repeat from the 9th pair giving the user the possibility to
+build arbitrary couples within a single color. Uneven number of regular colored
+oxyds are not allowed.
+
+Usually oxyds are shuffled by a @samp{wo:shuffleOxyd()} statement after setting
+of all oxyds. All @samp{CLOSED} oxyds that are not explicitly excluded by the
+ at samp{noshuffle} attribute take place in shuffling. But you can define
+arbitrary rules to limit and influence the shuffling process to guarantee
+solvabitlity and fairness (@pxref{Oxyd Shuffling Rules}).
+
+Oxyds are opened either by an actor hit, an additional laser beam, an
+ at ref{st_boulder} triggering or a message call. A single opened oxyd is in the
+state @samp{OPEN}. If a matching second oxyd is opened both switch to the state
+ at samp{OXYDPAIR}. Note that this state can be requested, but it can not be set
+directly.
+
+Single opened oxyds close on not matching partner oxyds being opened and on 
+ at samp{close} messages and state setting operations. But oxyds being part of
+an opened pair will not be closed this way.
+
+All oxyds including pairs will close on the @samp{closeall} messages that is
+issued by @ref{st_fart} and oxyds colored @samp{OXYD_FART} on actor hits.
+
+Closed oxyds can have different looks. Their visual representation is defined
+by their @samp{flavor}. For each flavor exists an identical looking simple
+stone: @ref{st_likeoxyd_a}, @ref{st_likeoxyd_b}, @ref{st_likeoxyd_c},
+ at ref{st_likeoxyd_d}. If you like an identical looking pseudo stone that takes
+part in the oxyd shuffling you can use an oxyd of color @samp{OXYD_FAKE}.
+
+During the game oxyds can be reshuffled. Just those oxyds that are still closed
+will take part in the new shuffle process. @ref{Oxyd Shuffling Rules} will be
+still guranteed for these partial in game reshuffles. It can be initiated either
+by a @samp{shuffle} message that is send to any of the oxyd objects, or by
+usage of an oxyd of color @samp{OXYD_BOLD}. If such a special oxyd is opened,
+e.g. by an actor hit, it shuffles all remaining oxyds including itself.
+
+At initialization an oxyd that is exposed to laser light will start in state
+ at samp{CLOSED}. As it is the gaming target it is a certain exception to the
+ at ref{Snapshot Principle}.
+
+An oxyd that is swapped in or out of a laser beam will act on the light change
+with proper actions.
+
+ at table @asis
+ at item @b{Attributes:}
+
+ at table @asis
+ at item @b{state}, @ @ @i{values}: @code{CLOSED}, @code{OPEN}, @code{OXYDPAIR}; @ @ @i{default}: @code{CLOSED} @ @ @xref{state}
+
+ at item @b{flavor}, @ @ @i{values}: @code{"a"}, @code{"b"}, @code{"c"}, @code{"d"}; @ @ @i{default}: @code{"b"}
+The flavor only affects the visual representation of the stone. Mainly the 
+closed state and the way of opening differ in the following way:
+ at table @asis
+ at item @code{"a"} bronze, pyramid like stone that opens like a flower
+ at item @code{"b"} black, flat stone that opens by a fade animation
+ at item @code{"c"} blue, flat stone that opens by a concentric animation
+ at item @code{"d"} dark blue, pyramid like stone that opens like a flower
+ at end table
+ at item @b{color}, @ @ @i{values}: @code{OXYD_AUTO}, @code{OXYD_FAKE}, @code{OXYD_FART}, @code{OXYD_BOLD}, @code{OXYD_BLUE}, @code{OXYD_RED}, @code{OXYD_GREEN}, @code{OXYD_YELLOW}, @code{OXYD_CYAN}, @code{OXYD_PURPLE}, @code{OXYD_WHITE}, @code{OXYD_BLACK}, ; @ @ @i{default}: @code{OXYD_AUTO}
+ at item @b{noshuffle} @ @ @i{values}: @code{true}, @code{false}; @ @ @i{default}: @code{false}
+ at item @b{static} @ @ @i{values}: @code{true}, @code{false}; @ @ @i{default}: @code{false}
+Static oxyds are neither swappable nor pullable.
+ at end table
+
+ at item @b{Messages:}
+
+ at table @asis
+ at item @b{signal} @ @ @xref{signal}
+Try open at value @samp{1}, and close at values @samp{0}.
+ at item @b{open} @ @ @xref{open}
+ at item @b{close} @ @ @xref{close}
+ at item @b{closeall}
+Closes all opened oxyds if send to any object instance.
+ at item @b{shuffle}
+Reshuffles all closed oxyds if send to any object instance.
+ at end table
+
+ at item @b{Action:} @ @ @xref{target}, @ @ @xref{action}
+Values 0, 1.
+
+ at item @b{Variants:}
+
+ at table @asis
+ at item @b{st_oxyd}: flavor = @code{"b"}
+ at item @b{st_oxyd_a}: flavor = @code{"a"}
+ at item @b{st_oxyd_b}: flavor = @code{"b"}
+ at item @b{st_oxyd_c}: flavor = @code{"c"}
+ at item @b{st_oxyd_d}: flavor = @code{"d"}
+ at end table
+
+ at end table
+
 @c ----------------- Polarswitch Stone -------------------- 
 @node st_polarswitch
 @subsection st_polarswitch
@@ -4240,12 +5152,25 @@
 @node Actor Objects
 @chapter Actor Objects
 
+ at c ===================  Other Objects  =======================
+
 @node Other Objects
 @chapter Other Objects
 
+ at c ===================  Advanced Features  =======================
+
 @node Advanced Features
 @chapter Advanced Features
 
+ at menu 
+* Oxyd Shuffling Rules::       
+ at end menu
+
+ at node Oxyd Shuffling Rules
+ at section Oxyd Shuffling Rules
+
+Read API Concept Draft
+
 @node Old API - Objects
 @chapter Old API - Objects
 



From ral at mail.berlios.de  Sat Apr 12 13:17:02 2008
From: ral at mail.berlios.de (ral at BerliOS)
Date: Sat, 12 Apr 2008 13:17:02 +0200
Subject: [Enigma-game-svn] r1102 - in trunk: doc/reference etc
Message-ID: <200804121117.m3CBH2qU005246@sheep.berlios.de>

Author: ral
Date: 2008-04-12 13:16:59 +0200 (Sat, 12 Apr 2008)
New Revision: 1102

Modified:
   trunk/doc/reference/enigma-ref.texi
   trunk/etc/mingw32-dist.sh.in
Log:
Trunk 1.1: 
- small fixes

Modified: trunk/doc/reference/enigma-ref.texi
===================================================================
--- trunk/doc/reference/enigma-ref.texi	2008-04-12 09:34:19 UTC (rev 1101)
+++ trunk/doc/reference/enigma-ref.texi	2008-04-12 11:16:59 UTC (rev 1102)
@@ -4073,8 +4073,19 @@
 @item @b{Action:}
 none
 
+ at item @b{Variants:}
+ at table @asis
+ at item @b{it_vortex}
+A vortex in state @samp{OPEN}.
+ at item @b{it_vortex_open}
+A vortex in state @samp{OPEN}.
+ at item @b{it_vortex_closed}
+A vortex in state @samp{CLOSED}.
 @end table
 
+
+ at end table
+
 @c ----------------- Wormhole Item -------------------- 
 @node it_wormhole
 @subsection it_wormhole

Modified: trunk/etc/mingw32-dist.sh.in
===================================================================
--- trunk/etc/mingw32-dist.sh.in	2008-04-12 09:34:19 UTC (rev 1101)
+++ trunk/etc/mingw32-dist.sh.in	2008-04-12 11:16:59 UTC (rev 1102)
@@ -128,6 +128,7 @@
     cpfile doc/images/flags25x15/*.png	images/flags25x15
     cptext etc/README-SDL.txt 	        README-SDL.txt
     cptext doc/reference/ant_lua.txt 	reference/ant_lua.txt
+    cptext doc/reference/ConceptLuaAPI2.txt 	reference/ConceptLuaAPI2.txt
     cptext doc/reference/sounds.txt	reference/sounds.txt
     cptext doc/reference/soundset.lua   reference/soundset.lua
     cpfile doc/reference/lua2xml	reference/



From andreasl at mail.berlios.de  Thu Apr 17 00:07:24 2008
From: andreasl at mail.berlios.de (andreasl at BerliOS)
Date: Thu, 17 Apr 2008 00:07:24 +0200
Subject: [Enigma-game-svn] r1103 - in trunk: . data data/music
	data/music/menu src src/gui
Message-ID: <200804162207.m3GM7Oag029022@sheep.berlios.de>

Author: andreasl
Date: 2008-04-17 00:06:28 +0200 (Thu, 17 Apr 2008)
New Revision: 1103

Added:
   trunk/data/music/
   trunk/data/music/Makefile.am
   trunk/data/music/menu/
   trunk/data/music/menu/Makefile.am
   trunk/data/music/menu/esprit.ogg
   trunk/data/music/menu/menu.s3m
Removed:
   trunk/data/sound/
Modified:
   trunk/configure.ac
   trunk/data/Makefile.am
   trunk/src/client.cc
   trunk/src/gui/LevelMenu.cc
   trunk/src/gui/MainMenu.cc
   trunk/src/gui/Menu.cc
   trunk/src/gui/OptionsMenu.cc
   trunk/src/gui/OptionsMenu.hh
   trunk/src/main.cc
   trunk/src/server.cc
   trunk/src/sound.cc
   trunk/src/sound.hh
   trunk/src/sound_internal.hh
Log:
Menu music part 1:
 - data structures for music files and music queues
 - looping of Ogg-Vorbis and mp3 (mp3 not tested)
 - added esprit.ogg
Notes:
 - You can access the loop test in the options menu,
   third entry in "Menu music".
 - Changes to the current music queues and loops
   are temporarily possible in SoundEngine::init_music().
 - Music might be noisy when music volume is < 10.
   Possibly my sdl_mixer is outdated? Please feedback.
Todo (probably in this sequence):
 - split sound.cc into three files:
     SoundEngine, SoundEffectManager, MusicManager
 - reorganize options menu
 - loop for mod-files (like "Pentagonal Dreams")
 - xml-files for meta data input, correct load/save
   of menu music choice.
 - activate/deactivate single music files
 - random queue
 - download of music files with gui


Modified: trunk/configure.ac
===================================================================
--- trunk/configure.ac	2008-04-12 11:16:59 UTC (rev 1102)
+++ trunk/configure.ac	2008-04-16 22:06:28 UTC (rev 1103)
@@ -381,7 +381,8 @@
            data/levels/lib/Makefile
            data/levels/patches/Makefile
            data/fonts/Makefile
-           data/sound/Makefile
+           data/music/Makefile
+           data/music/menu/Makefile
            data/soundsets/Makefile
            data/soundsets/enigma/Makefile
            data/schemas/Makefile

Modified: trunk/data/Makefile.am
===================================================================
--- trunk/data/Makefile.am	2008-04-12 11:16:59 UTC (rev 1102)
+++ trunk/data/Makefile.am	2008-04-16 22:06:28 UTC (rev 1103)
@@ -1,4 +1,4 @@
-SUBDIRS = gfx fonts schemas levels sound soundsets gfx16 gfx32 gfx40 gfx48 gfx64
+SUBDIRS = gfx fonts schemas levels music soundsets gfx16 gfx32 gfx40 gfx48 gfx64
 
 pkgdata_DATA = \
 	api1init.lua \


Property changes on: trunk/data/music
___________________________________________________________________
Name: svn:ignore
   + Makefile
Makefile.in


Added: trunk/data/music/Makefile.am
===================================================================
--- trunk/data/music/Makefile.am	2008-04-12 11:16:59 UTC (rev 1102)
+++ trunk/data/music/Makefile.am	2008-04-16 22:06:28 UTC (rev 1103)
@@ -0,0 +1,6 @@
+SUBDIRS = menu
+
+pkgdatadir = $(datadir)/@PACKAGE@/music
+pkgdata_DATA = 
+
+EXTRA_DIST = $(pkgdata_DATA)


Property changes on: trunk/data/music/menu
___________________________________________________________________
Name: svn:ignore
   + Makefile
Makefile.in


Added: trunk/data/music/menu/Makefile.am
===================================================================
--- trunk/data/music/menu/Makefile.am	2008-04-12 11:16:59 UTC (rev 1102)
+++ trunk/data/music/menu/Makefile.am	2008-04-16 22:06:28 UTC (rev 1103)
@@ -0,0 +1,5 @@
+pkgdatadir = $(datadir)/@PACKAGE@/menu
+pkgdata_DATA = menu.s3m \
+               esprit.ogg
+
+EXTRA_DIST = $(pkgdata_DATA)

Added: trunk/data/music/menu/esprit.ogg
===================================================================
(Binary files differ)


Property changes on: trunk/data/music/menu/esprit.ogg
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/data/music/menu/menu.s3m
===================================================================
(Binary files differ)


Property changes on: trunk/data/music/menu/menu.s3m
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Modified: trunk/src/client.cc
===================================================================
--- trunk/src/client.cc	2008-04-12 11:16:59 UTC (rev 1102)
+++ trunk/src/client.cc	2008-04-16 22:06:28 UTC (rev 1103)
@@ -840,12 +840,7 @@
         }
     }
 
-    sound::FadeoutMusic();
-    if (options::GetBool("InGameMusic")) {
-        sound::PlayMusic (options::GetString("LevelMusicFile"));
-    } else {
-        sound::StopMusic();
-    }
+    sound::StartLevelMusic();
 
     // start screen transition
     GC gc(video::BackBuffer());

Modified: trunk/src/gui/LevelMenu.cc
===================================================================
--- trunk/src/gui/LevelMenu.cc	2008-04-12 11:16:59 UTC (rev 1102)
+++ trunk/src/gui/LevelMenu.cc	2008-04-16 22:06:28 UTC (rev 1103)
@@ -422,7 +422,7 @@
         const video::VMInfo *vminfo = video::GetInfo();
         
         video::SetCaption(("Enigma - Level Menu"));
-        sound::PlayMusic (options::GetString("MenuMusicFile"));
+        sound::StartMenuMusic();
     
         blit(gc, vminfo->mbg_offsetx, vminfo->mbg_offsety, enigma::GetImage("menu_bg", ".jpg"));
     }

Modified: trunk/src/gui/MainMenu.cc
===================================================================
--- trunk/src/gui/MainMenu.cc	2008-04-12 11:16:59 UTC (rev 1102)
+++ trunk/src/gui/MainMenu.cc	2008-04-16 22:06:28 UTC (rev 1103)
@@ -230,7 +230,7 @@
         const video::VMInfo *vminfo = video::GetInfo();
     
         video::SetCaption (("Enigma - Main Menu"));
-        sound::PlayMusic (options::GetString("MenuMusicFile"));
+        sound::StartMenuMusic();
     
         blit(gc, vminfo->mbg_offsetx, vminfo->mbg_offsety, enigma::GetImage("menu_bg", ".jpg"));
     

Modified: trunk/src/gui/Menu.cc
===================================================================
--- trunk/src/gui/Menu.cc	2008-04-12 11:16:59 UTC (rev 1102)
+++ trunk/src/gui/Menu.cc	2008-04-16 22:06:28 UTC (rev 1103)
@@ -86,7 +86,8 @@
             SDL_Delay(10);
             if(active_widget) active_widget->tick(0.01);
             if(key_focus_widget && (key_focus_widget != active_widget)) key_focus_widget->tick(0.01);
-            tick (0.01);
+            tick(0.01);
+            sound::MusicTick(0.01);
             refresh();
         }
         sound::EmitSoundEvent ("menuexit");

Modified: trunk/src/gui/OptionsMenu.cc
===================================================================
--- trunk/src/gui/OptionsMenu.cc	2008-04-12 11:16:59 UTC (rev 1102)
+++ trunk/src/gui/OptionsMenu.cc	2008-04-16 22:06:28 UTC (rev 1103)
@@ -182,7 +182,26 @@
         return _(sound::GetOptionSoundSetText(value).c_str());
     }
 
+    /* -------------------- MenuMusicButton -------------------- */
+    
+    MenuMusicButton::MenuMusicButton() : ValueButton(0, 1) {
+        int numAvail = sound::GetOptionMenuMusicCount();
+        setMaxValue(numAvail - 1);
+        init();
+    }
 
+    int MenuMusicButton::get_value() const {
+        return sound::GetOptionMenuMusic();
+    }
+
+    void MenuMusicButton::set_value(int value) {
+        sound::SetOptionMenuMusic(value);
+    }
+
+    string MenuMusicButton::get_text(int value) const {
+        return _(sound::GetOptionMenuMusicText(value).c_str());
+    }
+
     /* -------------------- StereoButton -------------------- */
     
     StereoButton::StereoButton() : ValueButton(-1, 1)
@@ -377,6 +396,7 @@
         bottomlabels.add (new Label(N_("User name: "), HALIGN_RIGHT));
         bottomlabels.add (new Label(N_("User path: "), HALIGN_RIGHT));
         bottomlabels.add (new Label(N_("User image path: "), HALIGN_RIGHT));
+        bottomlabels.add (new Label(N_("Menu music: "), HALIGN_RIGHT));
         userNameTF = new TextField(app.state->getString("UserName"));
         userNameTF->setMaxChars(20);
         userNameTF->setInvalidChars("+");
@@ -385,6 +405,7 @@
         bottom.add (userPathTF);
         userImagePathTF = new TextField(XMLtoUtf8(LocalToXML(app.userImagePath.c_str()).x_str()).c_str());
         bottom.add (userImagePathTF);
+        bottom.add (new MenuMusicButton);
 
 //            add (m_restartinfo, Rect (l.x, l.y + 15, 400, 20));
 //            m_restartinfo->set_alignment (HALIGN_LEFT);

Modified: trunk/src/gui/OptionsMenu.hh
===================================================================
--- trunk/src/gui/OptionsMenu.hh	2008-04-12 11:16:59 UTC (rev 1102)
+++ trunk/src/gui/OptionsMenu.hh	2008-04-16 22:06:28 UTC (rev 1103)
@@ -50,6 +50,7 @@
         gui::TextField *userNameTF;
         gui::TextField *userPathTF;
         gui::TextField *userImagePathTF;
+        gui::TextField *menuMusicTF;
         gui::Label  *m_restartinfo;
         ecl::Surface *background;
         std::string  previous_caption;
@@ -88,6 +89,14 @@
         std::string get_text(int value) const;
     };
 
+    class MenuMusicButton : public ValueButton {
+    public:
+        MenuMusicButton();
+        int get_value() const;
+        void set_value(int value);
+        std::string get_text(int value) const;
+    };
+    
     class LanguageButton : public ValueButton {
         int get_value() const;
         void set_value(int value);

Modified: trunk/src/main.cc
===================================================================
--- trunk/src/main.cc	2008-04-12 11:16:59 UTC (rev 1102)
+++ trunk/src/main.cc	2008-04-16 22:06:28 UTC (rev 1103)
@@ -377,6 +377,9 @@
     // ----- Initialize sound tables -- needs sound, oxyd, video (error messages!)
     sound::InitSoundSets();
 
+    // ----- Initialize music -- needs application state
+    sound::InitMusic();
+    
 #if MACOSX
     updateMac1_00();
 #endif

Modified: trunk/src/server.cc
===================================================================
--- trunk/src/server.cc	2008-04-12 11:16:59 UTC (rev 1102)
+++ trunk/src/server.cc	2008-04-16 22:06:28 UTC (rev 1103)
@@ -553,7 +553,10 @@
     else if (cmd == "cheats") {
         client::Msg_ShowText("god, collision  -- Be aware: you'll get no medals!", true);
     }
-
+    else if (cmd == "April 1st") {
+        client::Msg_ShowText("No pizza, and a cloudless sky.", true);
+    }
+   
     else {
         enigma::Log << "Warning: Server received unknown command '" << cmd << "'\n";
     }

Modified: trunk/src/sound.cc
===================================================================
--- trunk/src/sound.cc	2008-04-12 11:16:59 UTC (rev 1102)
+++ trunk/src/sound.cc	2008-04-16 22:06:28 UTC (rev 1103)
@@ -69,6 +69,12 @@
 }
 
 
+SoundEngine::SoundEngine()
+: sound_sets(), sound_effects(), active_sound_set_key(""),
+  default_sound_set(""), sound_set_count(0), music_singles(),
+  music_queues(), active_music_queue(""), music_context(MUSIC_NONE)
+{}
+
 
 /* -------------------- SoundEngine_SDL implementation -------------------- */
 
@@ -180,13 +186,18 @@
     m_current_music = 0;
 }
 
-bool SoundEngine_SDL::play_music (const std::string &filename) 
+bool SoundEngine_SDL::play_music (const std::string &filename, double position) 
 {
     if (Mix_Music *music = Mix_LoadMUS(filename.c_str())) {
         if (m_current_music)
             Mix_FreeMusic (m_current_music);
         m_current_music = music;
-        Mix_PlayMusic (m_current_music, -1);
+        Mix_PlayMusic (m_current_music, 1);
+        if(position > 0) {
+          Log << "Start music at position " << position << "\n";
+          if(Mix_SetMusicPosition(position) == -1)
+          Log << "Mix_SetMusicPosition: " << Mix_GetError() << "\n";
+        }
         Mix_VolumeMusic (m_musicvolume);
         return true;
     }
@@ -385,6 +396,7 @@
 void sound::Tick (double dtime)
 {
     sound_engine->tick (dtime);
+    sound::MusicTick(dtime);
 }
 
 void sound::DisableSound() {
@@ -454,19 +466,23 @@
     sound_engine->fadeout_music();
 }
 
-void sound::PlayMusic (const std::string &name) 
+bool sound::PlayMusic (const std::string &name, double position) 
 {
-    if (!sound_enabled || !music_enabled || name==current_music_name)
-        return;
-
+    if(name == current_music_name)
+        return true;
+    if(!sound_enabled || !music_enabled || name=="")
+        return false;
+    
     FadeoutMusic();
 
     string fname;
-    if (app.resourceFS->findFile (name, fname) && sound_engine->play_music (fname))
+    if (app.resourceFS->findFile (name, fname) && sound_engine->play_music(fname, position)) {
         current_music_name = name;
-    else
+        return true;
+    } else {
         current_music_name = "";
-
+        return false;
+    }
 }
 
 void sound::StopMusic() {
@@ -479,6 +495,95 @@
         StopMusic();
 }
 
+bool sound::StartMenuMusic()
+{
+    if(sound_engine->getMusicContext() != MUSIC_MENU) {
+        sound::FadeoutMusic();
+        sound_engine->setMusicContext(MUSIC_MENU);
+    }
+}
+
+bool sound::StartLevelMusic()
+{
+    if(sound_engine->getMusicContext() != MUSIC_GAME) {
+        sound::FadeoutMusic();
+        sound_engine->setMusicContext(MUSIC_GAME);
+    }
+}
+
+void sound::MusicTick(double dtime)
+{
+    sound_engine->music_tick(dtime);
+}
+
+void SoundEngine::music_tick(double dtime)
+{
+    static double cumulated_dtime = 0;
+    cumulated_dtime += dtime;
+    if(cumulated_dtime > 0.2) {
+      if((!Mix_PlayingMusic()) && (!Mix_PausedMusic())) {
+        // Music has ended or not even begun
+        current_music_name = "";
+        switch(sound_engine->getMusicContext()) {
+            case MUSIC_MENU:
+                music_queues[active_music_queue].next();                
+                //sound::PlayMusic ("music/menu/esprit.ogg");
+                //sound::PlayMusic (options::GetString("MenuMusicFile"));
+                break;
+            case MUSIC_GAME:
+                if (options::GetBool("InGameMusic")) {
+                    //sound::PlayMusic ("music/menu/esprit.ogg");
+                    //sound::PlayMusic (options::GetString("LevelMusicFile"));
+                } else
+                    sound::StopMusic();
+                break;
+        }
+      } else {
+        // Music is still running. Check if we should reloop.
+        if(active_music_queue != "") {
+            string current_title = music_queues[active_music_queue].getCurrentMusicTitle();
+            if(current_title != "") {
+                music_singles[current_title].maybeLoopBack();
+            }
+        }
+      }
+      cumulated_dtime = 0;
+    }
+}
+
+void sound::InitMusic()
+{
+    sound_engine->init_music();
+}
+
+void SoundEngine::init_music()
+{
+    // TODO: This is only temporary. Information will come 
+    // from an xml file later.
+    music_singles["Esprit Loop"] =
+        MusicSingle("Esprit Loop", "music/menu/esprit.ogg", 178180, 10690, 21600, true);
+    music_singles["Esprit"] =
+        MusicSingle("Esprit", "music/menu/esprit.ogg", 178180, 10690, 21600, false);
+    music_singles["Pentagonal Dreams"] =
+        MusicSingle("Pentagonal Dreams", "music/menu/menu.s3m");
+
+    music_queues["Default"] = MusicQueue("Default", 0);
+    music_queues["Default"].appendSingle("Esprit");
+    music_queues["Default"].appendSingle("Pentagonal Dreams");
+
+    music_queues["Esprit"] = MusicQueue("Esprit", 1);
+    music_queues["Esprit"].appendSingle("Esprit");
+
+    music_queues["Pentagonal Dreams"] = MusicQueue("Pentagonal Dreams", 2);
+    music_queues["Pentagonal Dreams"].appendSingle("Pentagonal Dreams");
+
+    music_queues["Loop test"] = MusicQueue("Loop test", 3);
+    music_queues["Loop test"].appendSingle("Esprit Loop");
+
+    app.state->setProperty("MenuMusicQueue", "Default");
+    active_music_queue = "Default";
+}
+
 void sound::ClearCache()
 {
     sound_engine->clear_cache();
@@ -894,6 +999,131 @@
     return (factor <= damp.mini);
 }
 
+/* -------------------- MusicSingle -------------------- */
+
+void sound::DefineMusicSingle(string title, string filename) {
+    // TODO: include play_till, replay_from, volume etc
+    assert(sound_engine.get());
+    if(filename == "") {
+        Log << "Warning: Tried to define music single '" << title
+            << "' without file name. Skipped.\n";
+        return;
+    }
+    sound_engine->defineMusicSingle(title, filename);
+}
+
+bool SoundEngine::defineMusicSingle(string title, string filename)
+{
+    music_singles[title] = MusicSingle(title, filename);
+    Log << "Added music single '" << title << "'.\n";
+    return true;
+}
+
+bool MusicSingle::start()
+{
+    start_time = SDL_GetTicks();
+    return PlayMusic(filename);
+}
+
+bool MusicSingle::maybeLoopBack()
+{
+    Uint32 current_ticks = SDL_GetTicks();
+    if(allows_loop) {
+        if(current_ticks >= start_time + loop_end) {
+            Uint32 position = loop_start + current_ticks - start_time - loop_end;
+            start_time = current_ticks - position;
+            StopMusic();
+            return PlayMusic(filename, position/1000.0);
+        } else
+            return false;
+    } else
+        return false;
+}
+
+bool SoundEngine::playMusicSingle(string title)
+{
+    return ((sound_engine->music_singles)[title]).start();
+}
+
+/* -------------------- Music Queue -------------------- */
+
+string MusicQueue::getCurrentMusicTitle()
+{
+    if(current_position_in_queue == -1)
+        return "";
+    else
+        return single_title[current_position_in_queue];
+}
+
+void MusicQueue::appendSingle(string title)
+{
+    single_title.push_back(title);
+}
+
+bool MusicQueue::start()
+{
+    if(single_title.size() > 0) {
+        current_position_in_queue = 0;
+        return sound_engine->playMusicSingle(single_title[0]);
+    } else
+        return false;
+}
+
+bool MusicQueue::next()
+{
+    if(current_position_in_queue == -1)
+        // Queue did not start yet. Request first title instead.
+        return start();
+    else {
+        // TODO: Add random
+        current_position_in_queue++;
+        if(current_position_in_queue >= single_title.size())
+            current_position_in_queue = 0;
+        Log << "Play next in queue " << title << ".\n";
+        return sound_engine->playMusicSingle(single_title[current_position_in_queue]);
+    }
+}
+
+bool SoundEngine::setActiveMusicQueue(string music_queue_title)
+{
+    if (music_queue_title == "") {
+        Log << "Warning: Tried to choose empty music queue title as menu music queue.\n";
+        return false;
+    }
+    if (music_queue_title == getActiveMusicQueueTitle()) {
+        // Current queue is aready running.
+        return true;
+    }
+    sound::FadeoutMusic();
+    if (music_queues[music_queue_title].start()) {
+        active_music_queue = music_queue_title;
+        Log << "Switched to menu music queue '" << music_queue_title << "'.\n";
+        return true;
+    } else {
+        Log << "Warning: Problems loading menu music queue '" << music_queue_title << "'.\n";
+        return false;
+    }
+}
+
+string SoundEngine::getMusicQueueByPosition(int button_position)
+{
+    for (MusicQueueRepository::iterator i = music_queues.begin();
+             i != music_queues.end(); ++i)
+        if((*i).second.getButtonPosition() == button_position)
+            return (*i).first;
+    return "";
+}
+
+int SoundEngine::getMenuMusicQueueCount()
+{
+    int count = 0;
+    for (MusicQueueRepository::iterator i = music_queues.begin();
+             i != music_queues.end(); ++i)
+        if((*i).second.getButtonPosition() != -1)
+            count++;
+    return count;
+}
+
 /* -------------------- Sound option helpers -------------------- */
 
 /*! These functions are used in OptionsMenu.cc for the Soundset-Button. */
@@ -908,7 +1138,7 @@
     string soundSet = app.state->getString("SoundSetName");
     if (soundSet == "Default")
         return 0;
-    int pos = sound_engine->getButtonPosition(soundSet);
+    int pos = sound_engine->getSoundSetButtonPosition(soundSet);
     assert(pos > 0);
     return pos;
 }
@@ -943,3 +1173,31 @@
     return soundset_name;
 }
 
+/*! These functions are used in OptionsMenu.cc for the MenuMusicButton. */
+
+int sound::GetOptionMenuMusicCount()
+{        
+    return sound_engine->getMenuMusicQueueCount();
+}
+
+int sound::GetOptionMenuMusic()
+{
+    string music_queue = app.state->getString("MenuMusicQueue");
+    int pos = sound_engine->getMusicQueueButtonPosition(music_queue);
+    assert(pos >= 0);
+    return pos;
+}
+
+void sound::SetOptionMenuMusic(int value)
+{
+    string music_queue = sound_engine->getMusicQueueByPosition(value);
+    Log << "Try to set mmq '" << music_queue << "' from position " << value << ".\n";
+    app.state->setProperty("MenuMusicQueue", music_queue);
+    sound_engine->setActiveMusicQueue(music_queue);
+}
+
+string sound::GetOptionMenuMusicText(int value)
+{
+    return sound_engine->getMusicQueueByPosition(value);
+}
+

Modified: trunk/src/sound.hh
===================================================================
--- trunk/src/sound.hh	2008-04-12 11:16:59 UTC (rev 1102)
+++ trunk/src/sound.hh	2008-04-16 22:06:28 UTC (rev 1103)
@@ -193,7 +193,7 @@
                     double relative_volume = 1.0, int priority=0);
     bool PlaySoundGlobal (const SoundName &, double relative_volume = 1.0, int priority=0);
 
-    void PlayMusic (const std::string &name);
+    bool PlayMusic (const std::string &name, double position = 0.0);
     void FadeoutMusic();
 
     /*! Stop any music currently playing. */
@@ -203,6 +203,12 @@
       continue playing. */
     void StopMusic (const std::string &name);
 
+    void DefineMusicSingle(std::string title, std::string filename);
+    bool StartMenuMusic();
+    bool StartLevelMusic();
+    void MusicTick(double dtime);
+    void InitMusic();
+    
     void ClearCache();
     void DefineSound (const SoundName &, const SoundData &);
     void SetSoundVolume (double vol);
@@ -236,6 +242,10 @@
     int GetOptionSoundSet();
     void SetOptionSoundSet(int value);
     std::string GetOptionSoundSetText(int value);
+    int GetOptionMenuMusicCount();
+    int GetOptionMenuMusic();
+    void SetOptionMenuMusic(int value);
+    std::string GetOptionMenuMusicText(int value);
 }
 
 #endif

Modified: trunk/src/sound_internal.hh
===================================================================
--- trunk/src/sound_internal.hh	2008-04-12 11:16:59 UTC (rev 1102)
+++ trunk/src/sound_internal.hh	2008-04-16 22:06:28 UTC (rev 1103)
@@ -98,14 +98,86 @@
         OxydLib::OxydVersion oxyd_ver;
         int button_position;
     };
-
+    
     typedef map<string, SoundEffect> SoundEffectRepository;
     typedef map<string, SoundSet> SoundSetRepository;
+
+/* -------------------- Music and MusicQueue -------------------- */
+
+/*! The class "MusicSingle" holds filename and default playing information
+    for a single music file. Several music files can be combined into
+    a "MusicQueue" to play in a given or random sequence. MusicQueues are
+    used for menu music. One MusicQueue corresponds to one choice on the
+    option menu's button. */
+
+    class MusicSingle {
+    public:
+        MusicSingle(string title_, string filename_, Uint32 length_,
+                    Uint32 loop_start_, Uint32 loop_end_, bool allows_loop_)
+        : title(title_), filename(filename_), length(length_),
+          loop_start(loop_start_), loop_end(loop_end_),
+          allows_loop(allows_loop_), start_time() {}
+
+        MusicSingle(string title_, string filename_)
+        : title(title_), filename(filename_), length(0),
+          loop_start(0), loop_end(0), allows_loop(false), start_time() {}
+
+        MusicSingle()
+        : title(""), filename(""), length(0), loop_start(0), loop_end(0),
+          allows_loop(false) {}
+
+        bool start();
+        bool maybeLoopBack();
+
+    private:
+        string title;
+        string filename;
+        Uint32 length;      // in milliseconds
+        Uint32 loop_start;  // where the loop starts
+        Uint32 loop_end;    // where the loop should end (but continues playing until next tick)
+        Uint32 start_time;  // number of milliseconds since SDL init
+        bool allows_loop;
+    };
+
+    class MusicQueue {
+    public:
+        MusicQueue(string title_, int button_position_)
+        : title(title_), button_position(button_position_),
+          current_position_in_queue(-1), single_title() {}
+
+        MusicQueue()
+        : title(""), button_position(-1),
+          current_position_in_queue(-1), single_title() {}
+
+        bool start();
+        bool next();
+        string getCurrentMusicTitle();
+        int getButtonPosition() { return button_position; }
+        void setButtonPosition(int pos) { button_position = pos; }
+        void appendSingle(string title);
+
+    private:
+        int current_position_in_queue;
+        string title;
+        int button_position;
+        vector<string> single_title;
+    };
+
+    typedef map<string, MusicSingle> MusicSingleRepository;
+    typedef map<string, MusicQueue> MusicQueueRepository;
+
+    /*! MusicContext is a nominal condition to change the
+      music during the next tick.
+      NONE: during initialisation (don't play music now),
+      MENU/GAME: play music suitable for menu or during game. */
+    enum MusicContext { MUSIC_NONE, MUSIC_MENU, MUSIC_GAME };
+
         
 /* -------------------- SoundEngine -------------------- */
 
     class SoundEngine {
     public:
+        SoundEngine();
         virtual ~SoundEngine() {}
         
         //! Returns true if successful.
@@ -116,20 +188,33 @@
         virtual void set_sound_volume (double soundvol) = 0;
         virtual void set_music_volume (double musicvol) = 0;
 
-        // ---------- Music ----------
+        // ---------- Music and music repository ----------
 
-        virtual bool play_music (const std::string &filename) = 0;
+        virtual bool play_music(const std::string &filename, double position) = 0;
         virtual void stop_music() = 0;
         virtual void fadeout_music() = 0;
-
+        void setMusicContext(MusicContext context) { music_context = context; }
+        MusicContext getMusicContext() { return music_context; }
+        bool defineMusicSingle(string title, string filename);
+        bool playMusicSingle(string title);
+        bool setActiveMusicQueue(string music_queue_title);
+        string getActiveMusicQueueTitle() { return active_music_queue; }
+        void music_tick(double dtime);
+        void init_music();
+        string getMusicQueueByPosition(int button_position);
+        int getMenuMusicQueueCount();
+        int getMusicQueueButtonPosition(string music_queue_title) {
+            return music_queues[music_queue_title].getButtonPosition();
+        }
+        
         // ---------- Sound effects ----------
 
         virtual void clear_cache() = 0;
-        virtual void define_sound (const SoundName &, const SoundData &)=0;
-        virtual bool play_sound (const SoundEvent &s) = 0;
+        virtual void define_sound(const SoundName &, const SoundData &)=0;
+        virtual bool play_sound(const SoundEvent &s) = 0;
         virtual void cache_sound(const SoundEffect &s) = 0;
-        virtual void set_listenerpos (ecl::V2 pos) = 0;
-        virtual void tick (double dtime) {}
+        virtual void set_listenerpos(ecl::V2 pos) = 0;
+        virtual void tick(double dtime) {}
 
         // ---------- Sound effect repository and sound sets ----------
 
@@ -160,7 +245,8 @@
 
         void setSoundSetCount(int count) { sound_set_count = count; }
         int getSoundSetCount() { return sound_set_count; }
-        int getButtonPosition(string soundset_name) {
+        
+        int getSoundSetButtonPosition(string soundset_name) {
             return sound_sets[soundset_name].getButtonPosition();
         }
         string getSoundSetByPosition(int button_position);
@@ -171,6 +257,10 @@
         string                   active_sound_set_key;
         string                   default_sound_set;
         int                      sound_set_count;
+        MusicSingleRepository    music_singles;
+        MusicQueueRepository     music_queues;
+        string                   active_music_queue;
+        MusicContext             music_context;
     };
 
     class SoundEngine_Null : public SoundEngine {
@@ -183,7 +273,7 @@
         bool is_initialized() const { return true; }
         void set_sound_volume(double /*soundvol*/) {}
         void set_music_volume(double /*musicvol*/) {}
-        bool play_music (const std::string &/*filename*/) { return false; }
+        bool play_music (const std::string &/*filename*/, double /*position*/) { return false; }
         void stop_music() {}
         void fadeout_music() {}
 
@@ -206,7 +296,7 @@
         void set_sound_volume(double soundvol);
         void set_music_volume(double musicvol);
 
-        bool play_music (const std::string &filename);
+        bool play_music (const std::string &filename, double position);
         void stop_music();
         void fadeout_music();
 



From andreasl at mail.berlios.de  Sat Apr 19 00:46:03 2008
From: andreasl at mail.berlios.de (andreasl at BerliOS)
Date: Sat, 19 Apr 2008 00:46:03 +0200
Subject: [Enigma-game-svn] r1104 - in trunk/src: . gui lev
Message-ID: <200804182246.m3IMk354026351@sheep.berlios.de>

Author: andreasl
Date: 2008-04-19 00:45:50 +0200 (Sat, 19 Apr 2008)
New Revision: 1104

Added:
   trunk/src/MusicManager.cc
   trunk/src/MusicManager.hh
   trunk/src/SoundEffectManager.cc
   trunk/src/SoundEffectManager.hh
   trunk/src/SoundEngine.cc
   trunk/src/SoundEngine.hh
Removed:
   trunk/src/sound.cc
   trunk/src/sound.hh
   trunk/src/sound_internal.hh
Modified:
   trunk/src/GridObject.cc
   trunk/src/Makefile.am
   trunk/src/Object.cc
   trunk/src/actors.cc
   trunk/src/client.cc
   trunk/src/enigma-lua.pkg
   trunk/src/game.cc
   trunk/src/gui/LevelMenu.cc
   trunk/src/gui/LevelPackComposer.cc
   trunk/src/gui/LevelWidget.cc
   trunk/src/gui/MainMenu.cc
   trunk/src/gui/Menu.cc
   trunk/src/gui/OptionsMenu.cc
   trunk/src/gui/TextField.cc
   trunk/src/gui/widgets.cc
   trunk/src/items.cc
   trunk/src/laser.cc
   trunk/src/lev/Index.cc
   trunk/src/lua-display.cc
   trunk/src/lua-display.hh
   trunk/src/lua-ecl.cc
   trunk/src/lua-ecl.hh
   trunk/src/lua-editor.cc
   trunk/src/lua-editor.hh
   trunk/src/lua-enigma.cc
   trunk/src/lua-enigma.hh
   trunk/src/lua-global.cc
   trunk/src/lua-global.hh
   trunk/src/lua.cc
   trunk/src/main.cc
   trunk/src/options.cc
   trunk/src/oxyd.cc
   trunk/src/player.cc
   trunk/src/stones_complex.cc
   trunk/src/world.cc
   trunk/src/world_internal.hh
Log:
Menu music part 2:
 - Splitted sound and sound_internal into:
     SoundEngine, SoundEffectManager, MusicManager
 - Stripped some blind functions, cleaned dependencies
Note:
 - SoundEffectManager and MusicManager don't have any references
   to SDL anymore - only exception is the datatype Uint32 which
   is still used by MusicManager.
 - All SDL_mixer-calls are now located in SoundEngine_SDL.
 - SoundEffectManager and MusicManager are singletons in the
   same sense as RatingManager. sound_engine still is an
   auto_ptr, as it has to reference different classes
   (SoundEngine_SDL or _null).


Modified: trunk/src/GridObject.cc
===================================================================
--- trunk/src/GridObject.cc	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/GridObject.cc	2008-04-18 22:45:50 UTC (rev 1104)
@@ -25,7 +25,7 @@
 #include "laser.hh"
 #include "lua.hh"
 #include "main.hh"
-#include "sound.hh"
+#include "SoundEffectManager.hh"
 #include "world.hh"
 
 #include "ecl_util.hh"

Modified: trunk/src/Makefile.am
===================================================================
--- trunk/src/Makefile.am	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/Makefile.am	2008-04-18 22:45:50 UTC (rev 1104)
@@ -111,9 +111,12 @@
 	server.cc 		\
 	server.hh		\
 	server_internal.hh	\
-	sound.cc 		\
-	sound.hh 		\
-	sound_internal.hh	\
+	SoundEffectManager.cc   \
+	SoundEffectManager.hh   \
+	SoundEngine.cc          \
+	SoundEngine.hh 		\
+	MusicManager.cc		\
+	MusicManager.hh         \
 	StateObject.cc		\
 	StateObject.hh		\
 	StateManager.cc		\

Added: trunk/src/MusicManager.cc
===================================================================
--- trunk/src/MusicManager.cc	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/MusicManager.cc	2008-04-18 22:45:50 UTC (rev 1104)
@@ -0,0 +1,334 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2007,2008 Andreas Lochmann
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#include "errors.hh"
+#include "options.hh"
+#include "MusicManager.hh"
+#include "SoundEngine.hh"
+#include "main.hh"
+
+#include "SDL.h"
+#include "SDL_mixer.h"
+
+#include <string>
+#include <cassert>
+
+using namespace std;
+using namespace enigma;
+using namespace sound;
+
+
+/* -------------------- Interface Functions -------------------- */
+
+bool sound::StartMenuMusic()
+{
+    if(MusicManager::instance()->getMusicContext() != MUSIC_MENU) {
+        sound::FadeoutMusic();
+        MusicManager::instance()->setMusicContext(MUSIC_MENU);
+    }
+}
+
+bool sound::StartLevelMusic()
+{
+    if(MusicManager::instance()->getMusicContext() != MUSIC_GAME) {
+        sound::FadeoutMusic();
+        MusicManager::instance()->setMusicContext(MUSIC_GAME);
+    }
+}
+
+void sound::SetInGameMusicActive(bool active)
+{
+    // TODO!
+    if (active)
+        sound::PlayMusic(options::GetString("LevelMusicFile"));
+    else
+        sound::StopMusic();
+}
+
+void sound::MusicTick(double dtime)
+{
+    MusicManager::instance()->tick(dtime);
+}
+
+void sound::InitMusic()
+{
+    MusicManager::instance()->init();
+}
+
+void sound::DefineMusicSingle(string title, string filename) {
+    // TODO: include play_till, replay_from, volume etc
+    if(filename == "") {
+        Log << "Warning: Tried to define music single '" << title
+            << "' without file name. Skipped.\n";
+        return;
+    }
+    MusicManager::instance()->defineMusicSingle(title, filename);
+}
+
+/* -------------------- Sound option helpers -------------------- */
+
+/*! These functions are used in OptionsMenu.cc for the MenuMusicButton. */
+
+int sound::GetOptionMenuMusicCount()
+{        
+    return MusicManager::instance()->getMenuMusicQueueCount();
+}
+
+int sound::GetOptionMenuMusic()
+{
+    string music_queue = app.state->getString("MenuMusicQueue");
+    int pos = MusicManager::instance()->getMusicQueueButtonPosition(music_queue);
+    assert(pos >= 0);
+    return pos;
+}
+
+void sound::SetOptionMenuMusic(int value)
+{
+    string music_queue = MusicManager::instance()->getMusicQueueByPosition(value);
+    app.state->setProperty("MenuMusicQueue", music_queue);
+    MusicManager::instance()->setActiveMusicQueue(music_queue);
+}
+
+string sound::GetOptionMenuMusicText(int value)
+{
+    return MusicManager::instance()->getMusicQueueByPosition(value);
+}
+
+/* -------------------- MusicManager -------------------- */
+
+MusicManager *MusicManager::theSingleton = 0;
+    
+MusicManager* MusicManager::instance() {
+    if (theSingleton == 0) {
+        theSingleton = new MusicManager();
+    }
+    return theSingleton;
+}
+
+MusicManager::MusicManager()
+: music_singles(), music_queues(), active_music_queue(""),
+  music_context(MUSIC_NONE)
+{}    
+
+void MusicManager::tick(double dtime)
+{
+    static double cumulated_dtime = 0;
+    cumulated_dtime += dtime;
+    if((cumulated_dtime > 0.2) || (dtime < 0.0)) {
+        if(!sound::IsMusicPlaying()) {
+            // Music has ended or not even begun
+            switch(MusicManager::instance()->getMusicContext()) {
+                case MUSIC_MENU:
+                    if(active_music_queue != "")
+                        music_queues[active_music_queue].next();                
+                    break;
+                case MUSIC_GAME:
+                    // TODO
+                    //if (options::GetBool("InGameMusic")) {
+                    //}
+                    break;
+            }
+        } else {
+            // Music is still running. Check if we should reloop.
+            if(getCurrentMusicTitle() != "") {
+                music_singles[getCurrentMusicTitle()].maybeLoopBack();
+            }
+        }
+        cumulated_dtime = 0;
+    }
+}
+
+void MusicManager::init()
+{
+    // TODO: This is only temporary. Information will come 
+    // from an xml file later.
+    music_singles["Esprit Loop"] =
+        MusicSingle("Esprit Loop", "music/menu/esprit.ogg", 178180, 10690, 21600, true);
+    music_singles["Esprit"] =
+        MusicSingle("Esprit", "music/menu/esprit.ogg", 178180, 10690, 21600, false);
+    music_singles["Pentagonal Dreams"] =
+        MusicSingle("Pentagonal Dreams", "music/menu/menu.s3m");
+
+    music_queues["Default"] = MusicQueue("Default", 0);
+    music_queues["Default"].appendSingle("Esprit");
+    music_queues["Default"].appendSingle("Pentagonal Dreams");
+
+    music_queues["Esprit"] = MusicQueue("Esprit", 1);
+    music_queues["Esprit"].appendSingle("Esprit");
+
+    music_queues["Pentagonal Dreams"] = MusicQueue("Pentagonal Dreams", 2);
+    music_queues["Pentagonal Dreams"].appendSingle("Pentagonal Dreams");
+
+    music_queues["Loop test"] = MusicQueue("Loop test", 3);
+    music_queues["Loop test"].appendSingle("Esprit Loop");
+
+    app.state->setProperty("MenuMusicQueue", "Default");
+    active_music_queue = "Default";
+    setMusicContext(MUSIC_MENU);
+    tick(-1);
+}
+
+bool MusicManager::defineMusicSingle(string title, string filename)
+{
+    music_singles[title] = MusicSingle(title, filename);
+    Log << "Added music single '" << title << "'.\n";
+    return true;
+}
+
+bool MusicManager::playMusicSingle(string title)
+{
+    return music_singles[title].start();
+}
+
+bool MusicManager::setActiveMusicQueue(string music_queue_title)
+{
+    if (music_queue_title == "") {
+        Log << "Warning: Tried to choose empty music queue title as menu music queue.\n";
+        return false;
+    }
+    if (music_queue_title == getActiveMusicQueueTitle()) {
+        // Current queue is aready running.
+        return true;
+    }
+    // Stop current music and leave this queue.
+    sound::FadeoutMusic();
+    if (active_music_queue != "")
+        music_queues[active_music_queue].leave();
+    // Switch to new queue if possible.
+    if (music_queues[music_queue_title].next()) {
+        active_music_queue = music_queue_title;
+        Log << "Switched to menu music queue '" << music_queue_title << "'.\n";
+        return true;
+    } else {
+        active_music_queue = "";
+        Log << "Warning: Problems loading menu music queue '" << music_queue_title << "'.\n";
+        return false;
+    }
+}
+
+string MusicManager::getMusicQueueByPosition(int button_position)
+{
+    for (MusicQueueRepository::iterator i = music_queues.begin();
+             i != music_queues.end(); ++i)
+        if((*i).second.getButtonPosition() == button_position)
+            return (*i).first;
+    return "";
+}
+
+int MusicManager::getMenuMusicQueueCount()
+{
+    int count = 0;
+    for (MusicQueueRepository::iterator i = music_queues.begin();
+             i != music_queues.end(); ++i)
+        if((*i).second.getButtonPosition() != -1)
+            count++;
+    return count;
+}
+
+string MusicManager::getCurrentMusicTitle() {
+    if(sound::IsMusicPlaying() && (active_music_queue != ""))
+        return music_queues[active_music_queue].getCurrentMusicTitle();
+    else
+        return "";
+}
+
+
+/* -------------------- MusicSingle -------------------- */
+
+bool MusicSingle::start()
+{
+    if(title == MusicManager::instance()->getCurrentMusicTitle())
+        return true;
+    sound::FadeoutMusic();
+    if(sound::PlayMusic(filename)) {
+        start_time = SDL_GetTicks();
+        return true;
+    }
+    return false;
+}
+
+bool MusicSingle::maybeLoopBack()
+{
+    Uint32 current_ticks = SDL_GetTicks();
+    if((allows_loop) && (current_ticks >= start_time + loop_end)) {
+        Uint32 position = current_ticks + loop_start - start_time - loop_end;
+        if(loop_end > loop_start)
+            while(position >= loop_end)
+                position = position + loop_start - loop_end;
+        start_time = current_ticks - position;
+        sound::StopMusic();
+        if(sound::PlayMusic(filename, position/1000.0)) {
+            start_time = current_ticks - position;
+            return true;
+        } else
+            return false;
+    } else
+        return false;
+}
+
+/* -------------------- Music Queue -------------------- */
+
+string MusicQueue::getCurrentMusicTitle()
+{
+    if(current_position_in_queue == -1)
+        return "";
+    else
+        return single_title[current_position_in_queue];
+}
+
+void MusicQueue::appendSingle(string title)
+{
+    single_title.push_back(title);
+}
+
+bool MusicQueue::start()
+{
+    if(single_title.size() > 0) {
+        current_position_in_queue = 0;
+        return MusicManager::instance()->playMusicSingle(single_title[0]);
+    } else
+        return false;
+}
+
+bool MusicQueue::next()
+{
+    if(current_position_in_queue == -1)
+        // Queue did not start yet. Request first title instead.
+        return start();
+    else {
+        // TODO: Add random
+        current_position_in_queue++;
+        if(current_position_in_queue >= single_title.size())
+            current_position_in_queue = 0;
+        string single = single_title[current_position_in_queue];
+        Log << "Play next in queue " << title << ": " << single << ".\n";
+        return MusicManager::instance()->playMusicSingle(single);
+    }
+}
+
+void MusicQueue::leave()
+{
+    /*! We have the following choices, to determine where
+      to start the queue next time. Remember that "next"
+      will be called and auto-increase current_position_in_queue.
+      Complete reset: current_position_in_queue = -1;
+      Start with second song: current_position_in_queue = 0;
+      Restart the current: decrease current_position_in_queue by one
+      Start the next position in queue: don't change anything. */
+}

Added: trunk/src/MusicManager.hh
===================================================================
--- trunk/src/MusicManager.hh	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/MusicManager.hh	2008-04-18 22:45:50 UTC (rev 1104)
@@ -0,0 +1,161 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2007,2008 Andreas Lochmann
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef MUSICMGR_HH_INCLUDED
+#define MUSICMGR_HH_INCLUDED
+
+#include "SDL_mixer.h"
+
+#include <string>
+#include <vector>
+#include <map>
+
+using namespace std;
+
+namespace sound
+{
+
+/* -------------------- Interface Functions -------------------- */
+
+    void DefineMusicSingle(string title, string filename);
+
+    bool StartMenuMusic();
+    bool StartLevelMusic();
+    void MusicTick(double dtime);
+    void InitMusic();
+    void SetInGameMusicActive(bool active);
+
+    /*! Helper functions for options menu */
+    int GetOptionMenuMusicCount();
+    int GetOptionMenuMusic();
+    void SetOptionMenuMusic(int value);
+    string GetOptionMenuMusicText(int value);
+
+/* -------------------- Music and MusicQueue -------------------- */
+
+/*! The class "MusicSingle" holds filename and default playing information
+    for a single music file. Several music files can be combined into
+    a "MusicQueue" to play in a given or random sequence. MusicQueues are
+    used for menu music. One MusicQueue corresponds to one choice on the
+    option menu's button. */
+
+    class MusicSingle {
+    public:
+        MusicSingle(string title_, string filename_, Uint32 length_,
+                    Uint32 loop_start_, Uint32 loop_end_, bool allows_loop_)
+        : title(title_), filename(filename_), length(length_),
+          loop_start(loop_start_), loop_end(loop_end_),
+          allows_loop(allows_loop_), start_time() {}
+
+        MusicSingle(string title_, string filename_)
+        : title(title_), filename(filename_), length(0),
+          loop_start(0), loop_end(0), allows_loop(false), start_time() {}
+
+        MusicSingle()
+        : title(""), filename(""), length(0), loop_start(0), loop_end(0),
+          allows_loop(false) {}
+
+        bool start();
+        bool maybeLoopBack();
+
+    private:
+        string title;
+        string filename;
+        Uint32 length;      // in milliseconds
+        Uint32 loop_start;  // where the loop starts
+        Uint32 loop_end;    // where the loop should end (but continues playing until next tick)
+        Uint32 start_time;  // number of milliseconds since SDL init
+        bool allows_loop;
+    };
+
+    class MusicQueue {
+    public:
+        MusicQueue(string title_, int button_position_)
+        : title(title_), button_position(button_position_),
+          current_position_in_queue(-1), single_title() {}
+
+        MusicQueue()
+        : title(""), button_position(-1),
+          current_position_in_queue(-1), single_title() {}
+
+        bool start();
+        bool next();
+        void leave();
+        string getCurrentMusicTitle();
+        int getButtonPosition() { return button_position; }
+        void setButtonPosition(int pos) { button_position = pos; }
+        void appendSingle(string title);
+
+    private:
+        int current_position_in_queue;
+        string title;
+        int button_position;
+        vector<string> single_title;
+    };
+
+    typedef map<string, MusicSingle> MusicSingleRepository;
+    typedef map<string, MusicQueue> MusicQueueRepository;
+
+    /*! MusicContext is a nominal condition to change the
+      music during the next tick.
+      NONE: during initialisation (don't play music now),
+      MENU/GAME: play music suitable for menu or during game. */
+    enum MusicContext { MUSIC_NONE, MUSIC_MENU, MUSIC_GAME };
+
+/* -------------------- MusicManager -------------------- */
+
+    class MusicManager {
+    public:
+        static MusicManager* instance();
+        ~MusicManager() {}
+
+        void init();
+        void tick(double dtime);
+
+        // ---------- Music and music repository ----------
+
+        void setMusicContext(MusicContext context) { music_context = context; }
+        MusicContext getMusicContext() { return music_context; }
+
+        bool defineMusicSingle(string title, string filename);
+        bool playMusicSingle(string title);
+        string getCurrentMusicTitle();
+                
+        bool setActiveMusicQueue(string music_queue_title);
+        string getActiveMusicQueueTitle() { return active_music_queue; }
+        string getMusicQueueByPosition(int button_position);
+        int getMenuMusicQueueCount();
+        int getMusicQueueButtonPosition(string music_queue_title) {
+            return music_queues[music_queue_title].getButtonPosition();
+        }
+
+    protected:
+        MusicManager();
+        
+    private:
+        static MusicManager *theSingleton;
+        MusicSingleRepository    music_singles;
+        MusicQueueRepository     music_queues;
+        string                   active_music_queue;
+        MusicContext             music_context;
+    };
+    
+}
+
+#endif

Modified: trunk/src/Object.cc
===================================================================
--- trunk/src/Object.cc	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/Object.cc	2008-04-18 22:45:50 UTC (rev 1104)
@@ -26,7 +26,6 @@
 #include "lua.hh"
 #include "ObjectValidator.hh"
 #include "server.hh"
-#include "sound.hh"
 #include "world.hh"
 
 #include "ecl_util.hh"

Added: trunk/src/SoundEffectManager.cc
===================================================================
--- trunk/src/SoundEffectManager.cc	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/SoundEffectManager.cc	2008-04-18 22:45:50 UTC (rev 1104)
@@ -0,0 +1,433 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2007,2008 Andreas Lochmann
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#include "errors.hh"
+#include "options.hh"
+#include "SoundEffectManager.hh"
+#include "SoundEngine.hh"
+#include "main.hh"
+#include "oxyd.hh"
+#include "nls.hh"
+#include "client.hh"
+
+#include <string>
+#include <cassert>
+#include <memory>
+
+using namespace std;
+using namespace enigma;
+using namespace sound;
+using namespace OxydLib;
+
+
+/* -------------------- Interface Functions -------------------- */
+
+string sound::GetOxydSoundSet(OxydVersion oxyd_ver)
+{
+    return SoundEffectManager::instance()->getOxydSoundSet(oxyd_ver);
+}
+
+void sound::InitSoundSets() {
+    SoundEffectManager::instance()->initSoundSets();
+}
+
+void sound::SetActiveSoundSet(string soundset_name)
+{
+    SoundEffectManager::instance()->setActiveSoundSet(soundset_name);
+}
+
+void sound::SetDefaultSoundSet(string soundset_name)
+{
+    SoundEffectManager::instance()->setDefaultSoundSet(soundset_name);
+    if(app.state->getString("SoundSetName") == "Default")
+        SetActiveSoundSet(soundset_name);
+}
+
+/*! The following function is an interface to add sound events to Enigma.
+  It is accessed via sound-defaults.lua and user sound definitions. */
+void sound::DefineSoundEffect(string soundset_key, string name, string filename,
+                              double volume, bool loop, bool global, int priority,
+                              double damp_max, double damp_inc, double damp_mult,
+                              double damp_min, double damp_tick, string silence_string) {
+    if(soundset_key == "") {
+        Log << "Warning: Tried to define sound event '" << name
+            << "' without sound set key. Skipped.\n";
+        return;
+    }
+    SoundEffectManager::instance()->defineSoundEffect(soundset_key, name,
+        SoundEffect(name, soundset_key, filename, volume, loop, global, priority,
+        damp_max, damp_inc, damp_mult, damp_min, damp_tick, silence_string));
+}
+
+
+bool sound::EmitSoundEvent (const string &eventname, const ecl::V2 &pos,
+                            double volume, bool force_global)
+{
+    return SoundEffectManager::instance()->emitSoundEvent(eventname, pos, volume, force_global);
+}
+
+bool sound::EmitSoundEventGlobal (const string &eventname, double volume)
+{
+    return SoundEffectManager::instance()->emitSoundEvent(eventname, ecl::V2(), volume, true);
+}
+
+void sound::WriteSilenceString (const string &eventname)
+{
+    SoundEffectManager::instance()->writeSilenceString(eventname);
+}
+
+
+/* -------------------- Sound option helpers -------------------- */
+
+/*! These functions are used in OptionsMenu.cc for the Soundset-Button. */
+
+int sound::GetOptionSoundSetCount()
+{        
+    return SoundEffectManager::instance()->getSoundSetCount() + 1;
+}
+
+int sound::GetOptionSoundSet()
+{
+    string soundSet = app.state->getString("SoundSetName");
+    if (soundSet == "Default")
+        return 0;
+    int pos = SoundEffectManager::instance()->getSoundSetButtonPosition(soundSet);
+    assert(pos > 0);
+    return pos;
+}
+
+void sound::SetOptionSoundSet(int value)
+{
+    if(value == 0) {
+        // setting to default sound set
+        if (app.state->getString("SoundSetName") == "Default")
+            return;
+        app.state->setProperty("SoundSetName", "Default");
+        options::SetOption("SoundSet", SoundEffectManager::instance()->convertToOldSoundSetNumber("Default"));
+        SetActiveSoundSet(SoundEffectManager::instance()->getDefaultSoundSet());
+    } else {
+        string newSet = SoundEffectManager::instance()->getSoundSetByPosition(value);
+        assert(newSet != "");
+        if (app.state->getString("SoundSetName") == newSet)
+            return;
+        app.state->setProperty("SoundSetName", newSet);
+        options::SetOption("SoundSet", SoundEffectManager::instance()->convertToOldSoundSetNumber(newSet));
+        SetActiveSoundSet(newSet);
+    }
+}
+
+string sound::GetOptionSoundSetText(int value)
+{
+    if(value == 0)
+        return N_("Default");
+    string soundset_name = SoundEffectManager::instance()->getSoundSetByPosition(value);
+    if(soundset_name == "")
+        return "INVALID";
+    return soundset_name;
+}
+
+/* -------------------- SoundEvent implementation -------------------- */
+
+SoundEvent::SoundEvent ()
+: name(""), has_position(false), position(),
+  priority (0), volume (0.0),
+  left (0), right(0), active (false),
+  playing_time (0)
+{}
+
+/* -------------------- SoundEffectManager -------------------- */
+
+SoundEffectManager *SoundEffectManager::theSingleton = 0;
+    
+SoundEffectManager* SoundEffectManager::instance() {
+    if (theSingleton == 0) {
+        theSingleton = new SoundEffectManager();
+    }
+    return theSingleton;
+}
+
+SoundEffectManager::SoundEffectManager()
+: sound_sets(), sound_effects(), active_sound_set_key(""),
+  default_sound_set(""), sound_set_count(0)
+{}    
+
+/* ------------- Conversion and helper functions ------------- */
+
+/*! This function defines how to put soundset_key and eventname together to
+  create an eventkey. */
+
+string SoundEffectManager::effectKey(string effect_name, string soundset_name)
+{
+    if (soundset_name == "")
+        return getActiveSoundSetKey() + "#" + effect_name;
+    else
+        return soundset_name + "#" + effect_name;
+}
+
+/*! This function searches the known sound sets for a sound set with given
+  oxyd version, and returns the sound set name (or empty string if none). */
+
+string SoundEffectManager::getOxydSoundSet(OxydVersion oxyd_ver)
+{
+    for (SoundSetRepository::iterator i = sound_sets.begin();
+             i != sound_sets.end(); ++i)
+        if((*i).second.getOxydVersion() == oxyd_ver)
+            return (*i).first;
+    return "";
+}
+
+/*! Enigma 1.00 only knew the option "SoundSet", which was an integer. This
+  was quite unhandy if one wanted to add additional sound sets. Since 1.01
+  Enigma features the option "SoundSetName". Still, old "SoundSet" is needed
+  if user wants to switch to <= 1.00 again; so here are the conversion
+  functions. Any user sound set is mapped to 0 ("Default").  */
+
+int SoundEffectManager::convertToOldSoundSetNumber(string soundset_name)
+{
+    if(soundset_name == "Default")  return 0;
+    if(soundset_name == "Enigma")   return 1;
+    SoundSet sd = sound_sets[soundset_name];
+    if(sd.isOxyd())
+        return ((int) sd.getOxydVersion()) + 2;
+    return 0;
+}
+
+string SoundEffectManager::convertFromOldSoundSetNumber(int soundset_number)
+{
+    if(soundset_number == 0)  return "Default";
+    if(soundset_number == 1)  return "Enigma";
+    return getOxydSoundSet((OxydVersion) (soundset_number - 2));
+}
+
+/* -------------------- Sound set handling -------------------- */
+
+/*! These functions fill in data for the sound sets, initialises and
+  activates them. Return false, if something went wrong, e.g. when an
+  oxyd sound set is mentioned, but the corresponding oxyd version
+  wasn't found. */
+
+bool SoundEffectManager::defineSoundSet(string soundset_name, string soundset_key,
+                                 int button_position)
+{
+    sound_sets[soundset_name] = SoundSet(soundset_key, button_position);
+    Log << "Added sound set '" << soundset_name << "' (key '" << soundset_key
+        << "') on position " << button_position << ".\n";
+    return true;
+}
+
+bool SoundEffectManager::defineSoundSetOxyd(string soundset_name, string soundset_key,
+                                     OxydVersion oxyd_ver, int button_position)
+{
+    if(oxyd::FoundOxyd(oxyd_ver)) {
+        sound_sets[soundset_name] =
+            SoundSet(soundset_key, button_position, (OxydVersion) oxyd_ver);
+        Log << "Added sound set '" << soundset_name << "' (key '" << soundset_key
+            << "') on position " << button_position << ".\n";
+        return true;
+    } else {
+        Log << "Skipped sound set '" << soundset_name << "'.\n";
+        return false;
+    }
+}
+
+bool SoundSet::activate()
+{
+    if(getSoundSetKey() == "")
+        return false;
+    if(isOxyd() &&  !oxyd::InitOxydSoundSet(getOxydVersion()))
+        return false;
+
+    SoundEffectManager::instance()->setActiveSoundSetKey(getSoundSetKey());
+    return true;
+}
+
+void SoundEffectManager::initSoundSets()
+{
+    // Define sound sets
+    sound_sets.clear();
+    assert(sound_sets.empty());
+    assert(defineSoundSet ("Enigma",   "Enigma",  1));
+    int pos = 2; // position in options menu button
+    if (defineSoundSetOxyd ("Oxyd",     "Oxyd*",   OxydVersion_Oxyd1,          pos))  pos++;
+    if (defineSoundSetOxyd ("Magnum",   "Magnum*", OxydVersion_OxydMagnum,     pos))  pos++;
+    if (defineSoundSetOxyd ("Mag.Gold", "Magnum*", OxydVersion_OxydMagnumGold, pos))  pos++;
+    if (defineSoundSetOxyd ("Per.Oxyd", "Oxyd*",   OxydVersion_PerOxyd,        pos))  pos++;
+    if (defineSoundSetOxyd ("Extra",    "Oxyd*",   OxydVersion_OxydExtra,      pos))  pos++;
+    // Define user sound sets, as given by sound_effects
+    for (SoundEffectRepository::iterator i = sound_effects.begin();
+         i != sound_effects.end(); ++i) {
+        string soundset_key = (*i).second.getSoundSetKey();
+        bool found = false;
+        // ignore Oxyd* and Magnum* sound effects, if no 
+        if ((soundset_key != "Oxyd*") && (soundset_key != "Magnum*")) {
+            for (SoundSetRepository::iterator j = sound_sets.begin();
+                 j != sound_sets.end(); ++j)
+                if((*j).second.getSoundSetKey() == soundset_key)
+                    found = true;
+            if(!found)
+                if (defineSoundSet (soundset_key, soundset_key, pos))  pos++;
+        }
+    }
+    Log << "Found " << pos - 1 << " different sound sets.\n";
+    setSoundSetCount(pos - 1);
+    setDefaultSoundSet("Enigma");
+    // Extract sound set names and keys from options; activate!
+    string soundset_name = app.state->getString("SoundSetName");
+    if (soundset_name == "") { // just switched from 1.00 to higher
+        soundset_name = convertFromOldSoundSetNumber(options::GetInt("SoundSet"));
+        app.state->setProperty("SoundSetName", soundset_name);
+    }
+    if (soundset_name == "Default")
+        soundset_name = getDefaultSoundSet();
+    ClearCache();
+    if (sound_sets[soundset_name].activate())  {
+        preloadSoundEffects();
+        Log << "Activated sound set '" << soundset_name << "'.\n";
+    }
+    else {
+        // Fallback, happens e.g. when oxyd sound set can't be established or 
+        // a user soundset is given which doesn't exist anymore.
+        Log << "Warning: Soundset '" << soundset_name << "' not available.\n";
+        if (sound_sets["Enigma"].activate()) {
+            app.state->setProperty("SoundSetName", "Enigma");
+            options::SetOption("SoundSet", convertToOldSoundSetNumber("Enigma"));
+        } else
+            ASSERT(false, XFrontend,
+                "Soundsets defect and fallback 'Enigma' not available.");
+    }
+}
+
+void SoundEffectManager::setActiveSoundSet(string soundset_name)
+{
+    string soundset_key = sound_sets[soundset_name].getSoundSetKey();
+    if (soundset_key == getActiveSoundSetKey())
+        return;
+    if (soundset_key == "Default") {
+        Log << "Warning: Tried to choose 'Default' as effective sound set.\n";
+        return;
+    }
+    if (soundset_key == "") {
+        Log << "Warning: Tried to choose empty sound set key as effective sound set.\n";
+        return;
+    }
+    ClearCache();
+    if (sound_sets[soundset_name].activate()) {
+        preloadSoundEffects();
+        Log << "Switched to sound set '" << soundset_name << "' (key '" 
+            << soundset_key << "').\n";
+    } else
+        Log << "Warning: Problems loading sound set '" << soundset_name << "' (key'"
+            << soundset_key << "').\n";
+}
+
+/*! Pre-cache all sound effects so that they can be played without lag
+  when the game is running. */
+void SoundEffectManager::preloadSoundEffects()
+{
+    SoundEffectRepository::iterator i = sound_effects.begin(), 
+        end = sound_effects.end();
+    string prefix = getActiveSoundSetKey() + "#";
+    for (; i != end; ++i) {
+        if (i->first.compare(0, prefix.size(), prefix) == 0)
+            CacheSound(i->second);
+    }
+}
+
+string SoundEffectManager::getSoundSetByPosition(int button_position)
+{
+    for (SoundSetRepository::iterator i = sound_sets.begin();
+             i != sound_sets.end(); ++i)
+        if((*i).second.getButtonPosition() == button_position)
+            return (*i).first;
+    return "";
+}
+
+/* -------------------- Playing sound events -------------------- */
+
+/*! The following method is the interface between the formal SoundEffect
+  and the sound engine (via PlaySound[Global]). The last two functions
+  define the interface between level objects and SoundEffect. */
+
+bool SoundEffect::play(const ecl::V2 &pos, double vol, bool glob)
+{
+    if (name == "")
+        return false;
+    if (filename == "") {
+        Log << "No soundfile given for sound event " << name << ".\n";
+        return false;
+    }
+    if (glob || global)
+        return PlaySoundGlobal (filename, volume * vol, priority);
+    else
+        return PlaySound (filename, pos, volume * vol, priority);
+}
+
+bool SoundEffectManager::emitSoundEvent (const string &eventname, const ecl::V2 &pos,
+                            double volume, bool force_global)
+{
+    string effectkey = effectKey(eventname);
+    SoundEffectRepository::iterator i = sound_effects.find(effectkey);
+    if (i == sound_effects.end()) {
+        Log << "Undefined sound event " << effectkey << " @ " 
+            << pos[0] << "," << pos[1] << "\n";
+        return false;
+    } else {
+        return i->second.play(pos, volume, force_global);
+    }
+}
+
+void SoundEffectManager::writeSilenceString (const string &eventname)
+{
+    string effectkey = effectKey(eventname);
+    SoundEffectRepository::iterator i = sound_effects.find(effectkey);
+    if (i != sound_effects.end()) {
+        string silence_string = (*i).second.getSilenceString();
+        if (silence_string != "")
+            client::Msg_ShowText (silence_string, true);
+    }
+}
+
+/* -------------------- Sound damping implementation -------------------- */
+
+/*! These methods are connected to the sound damping mechanism, designed
+  to reduce the noise created by some objects like st-lightpassenger. */
+
+SoundDamping::SoundDamping(string effect_name_, const void *origin_)
+: effect_name(effect_name_), origin(origin_)
+{
+    damp = SoundEffectManager::instance()->getDampingData(effect_name_);
+    factor = damp.incr;
+    //Log << "New damping entry " << effect_name << " with " << damp.incr << ".\n";
+}
+
+float SoundDamping::get_volume(float def_volume) {
+    if (factor < damp.maxi)
+        factor += damp.incr;
+    //Log << "  Found entry " << effect_name << ". Factor is now " << i->factor << ".\n";
+    float q = factor * damp.mult;
+    if (q > 1.0)
+        return def_volume / q;
+    return def_volume;
+}
+
+bool SoundDamping::tick() {
+    // return true, if this entity is to be destroyed.
+    factor *= damp.tick;
+    return (factor <= damp.mini);
+}

Added: trunk/src/SoundEffectManager.hh
===================================================================
--- trunk/src/SoundEffectManager.hh	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/SoundEffectManager.hh	2008-04-18 22:45:50 UTC (rev 1104)
@@ -0,0 +1,370 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2007,2008 Andreas Lochmann
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef SOUNDEFFECTMGR_HH_INCLUDED
+#define SOUNDEFFECTMGR_HH_INCLUDED
+
+#include "ecl_math.hh"
+#include "oxydlib/OxydVersion.h"
+
+#include <string>
+#include <vector>
+#include <map>
+
+using namespace std;
+
+/** ----------- Survey of the formal data structure -----------
+ *
+ *  The wav-files are not to be accessed directly. There are several layers
+ *  between the wav-data and the final EmitSoundEvent-function, to allow for the
+ *  following uses:
+ *    (a) Sound Sets, possibly user defined,
+ *    (b) Access to oxyd's sound data,
+ *    (c) Sound damping for loud objects with user defined data,
+ *    (d) A "Default" mode which switches the sound set between level packs.
+ *    (e) A "silence string" that can be written instead of playing the sound.
+ *  For this, six layers of sound information exist.
+ *  Note: A sound effect is given by a wav-file and several data how to play it.
+ *        An object may choose a sound effect to play. Then it becomes a sound
+ *        event (= sound effect + position etc.).
+ *
+ *    (1) SoundEngine
+ *         -> Providing global information and methods for using SDL.
+ *    (2) SoundData
+ *         -> Holding technical details about how to play the wav-files.
+ *    (3) SoundEffect
+ *         -> Holding game-related information about how to play a sound
+ *            effect. This includes the effect's filename, default volume,
+ *            if it's looped, if it's played on a global scale by default,
+ *            the default damping information for this event, etc.
+ *    (4) SoundSet
+ *         -> Holding the sound set key of a sound set (see below), and if
+ *            it is connected to Oxyd. It also provides methods to
+ *            activate a sound set.
+ *    (5) SoundEvent
+ *         -> A struct to hold information about a sound event, like the
+ *            effect's name, position, priority, volume etc.
+ *    (6) SoundDamping
+ *         -> Each time an object makes noise, a SoundDamping-record
+ *            is created with an entry of the objects address (as void *).
+ *            This class modulates the volume with which the next effect
+ *            connected to this object is played.
+ *
+ *  Sound events are normally invoked by "EmitSoundEvent(EFFECTNAME, ...)".
+ *  EFFECTNAME can then be e.g. "pickup" or "laseron". This effect name does not
+ *  yet define the sound effect completely. Instead, the actually activated sound
+ *  set is looked up. It holds a string called sound set key (e.g. "Enigma" or
+ *  "Oxyd*"), and together with the effect name they form the effect key, here
+ *  "Enigma#pickup" or "Oxyd*#laseron". This effect key is looked up in the sound
+ *  effect repository and results in a SoundEffect-entry, which is then played.
+ *
+ */
+
+/** -------------- About the sound damping system --------------
+ *
+ *  The sound damping is not automatically used. Instead, it is called through
+ *  the "World::getVolume"-function:
+ *    sound::EmitSoundEvent (NAME, POS, getVolume(NAME, OBJECT_CALLING, DEF_VOLUME))
+ *  OBJECT_CALLING need not be a real address, it is never dereferenced. It just
+ *  holds as a representative of the calling object. The SoundDamping-records
+ *  are evaluated and finally erased by World::tick_sound_dampings. 
+ *
+ *  The values used in the sound damping systes can be user defined. In the
+ *  following, we use the defaults:
+ *
+ *  tick_sound_dampings is only to be evaluated every 10th tick (0.1s).
+ *  Each damping factor (the ivar connected to the noisy object and its sound
+ *  effect name) is reduced by 0.9. This is less than the 10th root of 0.5 (0.933),
+ *  so after 1s the damping factor is reduced by more than one half. If the factor
+ *  shrinks under 0.5, it is considered 0.
+ *
+ *  Examples:
+ *    1) Frequency less than one sound event per 0.6 seconds.
+ *       Then there is no damping at all.
+ *    2) N events per second. For each event, factor (F) is raised by
+ *       one. And each 0.1 seconds it is multiplied with 0.9. We now
+ *       have N/10 events per 0.1 seconds, hence in equilibrium f
+ *       oscillates between
+ *            f = (f + N/10) * 0.9   =>   f = N
+ *       and  f + N/10 = N * 1.1 (geometric series!).
+ *  In particular, for large enough N, f is approximately proportional
+ *  to N with half-life of less than a second. This is then evaluated
+ *  in getVolume.
+ * 
+ *  World::getVolume returns the volume, if object OBJECT_CALLING wants
+ *  to play sound effect NAME with default volume DEF_VOLUME. Often played
+ *  sounds from always the same object are damped to reduce noise-level.
+ *  Note that OBJECT_CALLING == NULL is explicitly allowed and used e.g.
+ *  for all laser-sounds. The damping factor is increased by 1.0 for each
+ *  event, and multiplied with 0.9 each 0.1 seconds, thereby approximately
+ *  equals the average number of events per second.
+ *
+ */
+
+/** -------------- Compatibility with 1.00 --------------
+ *
+ *  Enigma 1.01 uses a new option "SoundSetName", which replaces "SoundSet".
+ *  To enable Enigma 1.00 to run on the same system, the "SoundSet" variable
+ *  still exists. It is set to 0 (= "Default") for all user sound sets:
+ *  When exiting 1.01 with a user sound set and starting 1.00, the default
+ *  sound set will be activated for 1.00. Yet, as "SoundSetName" still shows
+ *  the old value, 1.01 will use it to find its user sound set. Even if
+ *  you change the sound set in 1.00, this will have no effect on the
+ *  chosen sound set for 1.01. In contrast to this, if you change the 1.01
+ *  sound set, the 1.00 "SoundSet"-variable will be adapted. Except for this
+ *  "restriction", you can use two different sound sets for 1.00 and 1.01.
+ *
+ */
+
+namespace sound
+{
+/* -------------------- Data types -------------------- */
+
+    typedef string SoundName;
+
+    typedef vector <unsigned char> ByteVec;
+
+    struct SoundData {
+        ByteVec  buf;
+        unsigned freq;
+        size_t   samplesize;
+        bool     signedp;
+        int      nchannels;
+    };
+
+/* -------------------- Interface Functions -------------------- */
+
+    void DefineSound (const SoundName &, const SoundData &);
+    
+    /*! Helper function for oxyd.cc */
+    string GetOxydSoundSet(OxydLib::OxydVersion oxyd_ver);
+
+    /*! Sound set handling */
+    void InitSoundSets();
+    void SetActiveSoundSet(string soundset_name);
+    void SetDefaultSoundSet(string soundset_name);
+
+    /*! Define a new sound event. */
+    void DefineSoundEffect(string soundset_key, string name, string filename,
+                           double volume, bool loop, bool global, int priority,
+                           double damp_max, double damp_inc, double damp_mult,
+                           double damp_min, double damp_tick, string silence_string);
+
+    /*! Trigger a sound event.  Return whether the event was handled. */
+    bool EmitSoundEvent (const string &eventname,
+                         const ecl::V2 &pos = ecl::V2 (), 
+                         double volume = 1.0, bool force_global = false);
+    bool EmitSoundEventGlobal (const string &eventname, double volume = 1.0);
+
+    /*! Send the silence string of a sound effect to command line. */
+    void WriteSilenceString (const string &eventname);
+
+    /*! Helper functions for options menu */
+    int GetOptionSoundSetCount();
+    int GetOptionSoundSet();
+    void SetOptionSoundSet(int value);
+    string GetOptionSoundSetText(int value);
+
+/* -------------------- SoundDampingList ---------------- */
+
+/*! This class stores object addresses and assigns volumes to
+    sound events, based on the frequency of the event. */
+
+    struct DampingData {
+        double incr;
+        double maxi;
+        double mult;
+        double mini;
+        double tick;
+    };
+
+    class SoundDamping {
+    private:
+        string effect_name;
+        const void *origin;
+        float factor;
+        DampingData damp;
+
+    public:
+        SoundDamping(string effect_name_, const void *origin_);
+        bool is_equal(string name2, const void *origin2) {
+            return (origin2 == origin) && (effect_name == name2);
+        }
+        float get_volume(float def_volume);
+        bool tick();  // returns true if this entry should be erased
+    };
+
+/* -------------------- SoundEvent -------------------- */
+
+    struct SoundEvent {
+        // Variables
+        SoundName name;
+        bool      has_position;
+        ecl::V2   position;
+        int       priority;
+        double    volume;           // Volume between 0.0 and 1.0
+        int       left;
+        int       right;
+
+        // Variables used internally by sound engine
+        bool      active;
+        double    playing_time;
+
+        // Constructor
+        SoundEvent ();
+    };
+
+/* -------------------- SoundEffect and SoundEffectRepository ---------------- */
+
+/*! This class stores information about how to play sound events
+    and provides methods to play them. */
+
+    class SoundEffect {
+    public:
+        SoundEffect(string name_, string soundset_key_, string filename_,
+                       double volume_, bool loop_, bool global_, int priority_,
+                       double damp_max_, double damp_inc_, double damp_mult_,
+                       double damp_min_, double damp_tick_, string silence_string_)
+        : name(name_), soundset_key(soundset_key_), filename(filename_), volume(volume_),
+          loop(loop_), global(global_), priority(priority_),
+          silence_string(silence_string_) {
+            damp.maxi = damp_max_;
+            damp.incr = damp_inc_;
+            damp.mult = damp_mult_;
+            damp.mini = damp_min_;
+            damp.tick = damp_tick_;
+        }
+
+        SoundEffect()  // standard empty data set, compare sound-defaults.lua
+        : name("EMPTY_EVENT"), filename(""), soundset_key(""), volume(1.0),
+          loop(false), global(false), priority(1), silence_string("") {
+            damp.maxi = 20.0;
+            damp.incr =  1.0;
+            damp.mult =  1.0;
+            damp.mini =  0.5;
+            damp.tick =  0.9;
+        }
+
+        void setFilename(string filename_) { filename = filename_; }
+        string getFilename() const { return filename; }
+        bool play(const ecl::V2 &pos = ecl::V2(), double vol = 1.0, bool glob = false);
+        DampingData getDampingData() { return damp; }
+        string getSoundSetKey() { return soundset_key; }
+        string getSilenceString() { return silence_string; }
+
+    private:
+        string name;
+        string filename;
+        string soundset_key;
+        string silence_string;
+        double volume;
+        bool loop;
+        bool global;
+        int priority;
+        DampingData damp;
+    };
+
+    class SoundSet {
+    public:
+        SoundSet(string soundset_key_, int button_position_, OxydLib::OxydVersion oxyd_ver_)
+        : soundset_key(soundset_key_), is_oxyd(true), oxyd_ver(oxyd_ver_),
+          button_position(button_position_) {}
+
+        SoundSet(string soundset_key_, int button_position_)
+        : soundset_key(soundset_key_), is_oxyd(false),
+          oxyd_ver(OxydLib::OxydVersion_Invalid), button_position(button_position_) {}
+
+        SoundSet()
+        : soundset_key(""), is_oxyd(false),
+          oxyd_ver(OxydLib::OxydVersion_Invalid), button_position(-1) {}
+
+        bool activate();
+        OxydLib::OxydVersion getOxydVersion() { return oxyd_ver; }
+        bool isOxyd() { return is_oxyd; }
+        string getSoundSetKey() { return soundset_key; }
+        int getButtonPosition() { return button_position; }
+        void setButtonPosition(int pos) { button_position = pos; }
+
+    private:
+        string soundset_key;
+        bool is_oxyd;
+        OxydLib::OxydVersion oxyd_ver;
+        int button_position;
+    };
+    
+    typedef map<string, SoundEffect> SoundEffectRepository;
+    typedef map<string, SoundSet> SoundSetRepository;
+
+
+/* -------------------- SoundEffectManager -------------------- */
+
+    class SoundEffectManager {
+    public:
+        static SoundEffectManager* instance();
+        ~SoundEffectManager() {}
+
+        // ---------- Sound effect repository and sound sets ----------
+
+        void setActiveSoundSetKey(string soundset_key) {active_sound_set_key=soundset_key;}
+        string getActiveSoundSetKey() { return active_sound_set_key; }
+        void setDefaultSoundSet(string soundset_name) {default_sound_set=soundset_name;}
+        string getDefaultSoundSet() { return default_sound_set; }
+        string effectKey(string effect_name, string soundset_name = "");
+        DampingData getDampingData(string effect_name) {
+            return sound_effects[effectKey(effect_name)].getDampingData(); }
+        void defineSoundEffect(string soundset_key, string name, SoundEffect se) {
+            sound_effects[effectKey(name, soundset_key)] = se;
+        }
+        bool emitSoundEvent (const string &eventname, const ecl::V2 &pos = ecl::V2 (), 
+                             double volume = 1.0, bool force_global = false);
+        void writeSilenceString (const string &eventname);
+        void initSoundSets();
+        bool defineSoundSet(string soundset_name, string soundset_key, int button_position);
+        bool defineSoundSetOxyd(string soundset_name, string soundset_key,
+                                OxydLib::OxydVersion oxyd_ver, int button_position);
+        string getOxydSoundSet(OxydLib::OxydVersion oxyd_ver);
+
+        int convertToOldSoundSetNumber(string soundset_name);
+        string convertFromOldSoundSetNumber(int soundset_number);
+
+        void setActiveSoundSet(string soundset_name);
+        void preloadSoundEffects();
+
+        void setSoundSetCount(int count) { sound_set_count = count; }
+        int getSoundSetCount() { return sound_set_count; }
+        
+        int getSoundSetButtonPosition(string soundset_name) {
+            return sound_sets[soundset_name].getButtonPosition();
+        }
+        string getSoundSetByPosition(int button_position);
+        
+    protected:
+        SoundEffectManager();
+        
+    private:
+        static SoundEffectManager *theSingleton;
+        SoundSetRepository         sound_sets;
+        SoundEffectRepository      sound_effects;
+        string                     active_sound_set_key;
+        string                     default_sound_set;
+        int                        sound_set_count;
+    };
+}
+
+#endif

Added: trunk/src/SoundEngine.cc
===================================================================
--- trunk/src/SoundEngine.cc	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/SoundEngine.cc	2008-04-18 22:45:50 UTC (rev 1104)
@@ -0,0 +1,542 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2007,2008 Andreas Lochmann
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#include "errors.hh"
+#include "options.hh"
+#include "SoundEngine.hh"
+#include "main.hh"
+
+#include "SDL_mixer.h"
+
+#include <string>
+#include <cassert>
+
+using namespace std;
+using namespace sound;
+using namespace enigma;
+
+
+/* -------------------- Local variables -------------------- */
+namespace
+{
+    auto_ptr<SoundEngine> sound_engine;
+
+    bool sound_enabled      = true;
+    bool music_enabled      = true;
+    bool sound_enabled_temp = false;
+}
+
+
+/* -------------------- Interface Functions -------------------- */
+
+void sound::Init() 
+{
+    if (!sound_engine.get()) {
+        sound_engine.reset(new SoundEngine_SDL);
+    }
+
+    if (sound_engine->init()) {
+        options::UpdateVolume();
+    }
+    else {
+        sound_enabled = false;
+        sound_engine.reset(new SoundEngine_Null);
+    }
+}
+
+void sound::Shutdown() 
+{
+    if (sound_engine.get())
+        sound_engine->shutdown();
+}
+
+void sound::Tick (double dtime)
+{
+    sound_engine->tick (dtime);
+    sound::MusicTick(dtime);
+}
+
+void sound::DisableSound() {
+    if (sound_enabled) {
+        sound_enabled = false;
+        Shutdown();
+    }
+}
+
+void sound::EnableSound() {
+    if (!sound_enabled) {
+        sound_enabled = true;
+        Init();
+    }
+}
+
+void sound::TempDisableSound() {
+    sound_enabled_temp = sound_enabled;
+    sound_enabled      = false;
+}
+
+void sound::TempReEnableSound() {
+    sound_enabled = sound_enabled_temp;
+}
+
+void sound::DefineSound (const SoundName &name, const SoundData &data)
+{
+    sound_engine->define_sound (name, data);
+}
+
+void sound::DisableMusic() {
+    music_enabled = false;
+}
+
+void sound::SetListenerPosition (const ecl::V2 &pos) 
+{
+    sound_engine->set_listenerpos (pos);
+}
+
+bool sound::PlaySound (const SoundName &name, const ecl::V2 &pos, double volume, int priority) 
+{
+    if (!sound_enabled)
+        return false;
+
+    SoundEvent se;
+    se.name         = name;
+    se.has_position = true;
+    se.position     = pos;
+    se.priority     = priority;
+    se.volume       = volume * options::GetDouble("SoundVolume");
+    se.left = se.right = 0;
+
+    return sound_engine->play_sound (se);
+}
+
+bool sound::PlaySoundGlobal (const SoundName &name, double volume, int priority) 
+{
+    SoundEvent se;
+    se.name         = name;
+    se.has_position = false;
+    se.position     = ecl::V2();
+    se.priority     = priority;
+    se.volume       = volume * options::GetDouble("SoundVolume");
+    se.left         = 255;
+    se.right        = 255;
+
+    return sound_engine->play_sound (se);
+}
+
+void sound::ClearCache()
+{
+    sound_engine->clear_cache();
+}
+
+void sound::CacheSound(const SoundEffect &s)
+{
+    sound_engine->cache_sound(s);
+}
+
+void sound::FadeoutMusic() 
+{
+    sound_engine->fadeout_music();
+}
+
+bool sound::PlayMusic (const string &name, double position) 
+{
+    if(!sound_enabled || !music_enabled || name=="")
+        return false;
+    
+    string fname;
+    return app.resourceFS->findFile (name, fname) && sound_engine->play_music(fname, position);
+}
+
+void sound::StopMusic() {
+    sound_engine->stop_music();
+}
+
+bool sound::IsMusicPlaying() {
+    return sound_engine->is_music_playing();
+}
+
+void sound::SetSoundVolume (double vol)
+{
+    sound_engine->set_sound_volume (vol);
+}
+
+void sound::SetMusicVolume (double vol)
+{
+    sound_engine->set_music_volume (vol);
+}
+
+
+/* -------------------- SoundEngine_SDL implementation -------------------- */
+
+SoundEngine::SoundEngine()
+{}
+
+class MutexLock {
+public:
+    MutexLock (SDL_mutex *m) {
+        mutex = m;
+        SDL_mutexP (mutex);
+    }
+    ~MutexLock () {
+        SDL_mutexV (mutex);
+    };
+private:
+    SDL_mutex *mutex;
+};
+
+SoundEngine_SDL *SoundEngine_SDL::m_instance = 0;
+
+SoundEngine_SDL::SoundEngine_SDL()
+: m_initialized(false),
+  m_soundvolume (MIX_MAX_VOLUME),
+  m_musicvolume (MIX_MAX_VOLUME),
+  m_current_music (0),
+  m_freq (MIX_DEFAULT_FREQUENCY),
+  m_format (MIX_DEFAULT_FORMAT),
+  m_channels (MIX_DEFAULT_CHANNELS)
+{
+    assert (m_instance == 0);
+    m_instance = this;
+}
+
+SoundEngine_SDL::~SoundEngine_SDL()
+{
+    shutdown();
+    m_instance = 0;
+}
+
+bool SoundEngine_SDL::init() 
+{
+    if (!m_initialized) {
+        // Initialize SDL audio subsystem
+        if (SDL_InitSubSystem (SDL_INIT_AUDIO) == -1) {
+            fprintf(stderr, "Couldn't open SDL audio subsystem: %s\n", SDL_GetError());
+            return false;
+        }
+
+        // Initialize SDL_mixer lib
+        if (Mix_OpenAudio(m_freq, m_format, m_channels, 1024) < 0) {
+            fprintf(stderr, "Couldn't open mixer: %s\n", Mix_GetError());
+            return false;
+        }
+
+        // Update number of available channels
+        m_channels = Mix_GroupCount (-1);
+        m_channelinfo.resize (m_channels);
+
+        Mix_ChannelFinished (&channel_finished);
+        m_mutex = SDL_CreateMutex();
+        if (!m_mutex)
+            return false;
+
+        m_initialized = true;
+    }
+    return true;
+}
+
+void SoundEngine_SDL::shutdown() 
+{
+    if (m_initialized) {
+	Mix_FreeMusic(m_current_music);
+        Mix_CloseAudio();
+        clear_cache();
+        SDL_DestroyMutex (m_mutex);
+        m_initialized = false;
+    }
+}
+
+void SoundEngine_SDL::clear_cache() 
+{
+    for (ecl::Dict<Mix_Chunk*>::iterator it = wav_cache.begin(); it != wav_cache.end(); ++it)
+        Mix_FreeChunk(it->second);
+    wav_cache.clear();
+}
+
+void SoundEngine_SDL::set_sound_volume (double soundvol) 
+{
+    if (!m_initialized)
+        return;                 // SDL_mixer crashes without this check
+
+    m_soundvolume = ecl::round_down<int>(ecl::Clamp(soundvol, 0.0, 1.0) * MIX_MAX_VOLUME);
+    Mix_Volume (-1, m_soundvolume);
+}
+
+void SoundEngine_SDL::set_music_volume (double musicvol) 
+{
+    if (!m_initialized)
+        return;                 // SDL_mixer crashes without this check
+
+    m_musicvolume = ecl::round_down<int>(ecl::Clamp(musicvol, 0.0, 1.0) * MIX_MAX_VOLUME);
+    Mix_VolumeMusic (m_musicvolume);
+    //Mix_SetPanning(MIX_CHANNEL_POST, m_musicvolume, m_musicvolume);
+}
+
+
+void SoundEngine_SDL::stop_music() 
+{
+    Mix_HaltMusic();
+    Mix_FreeMusic(m_current_music);
+    m_current_music = 0;
+}
+
+bool SoundEngine_SDL::play_music (const string &filename, double position) 
+{
+    if (Mix_Music *music = Mix_LoadMUS(filename.c_str())) {
+        if (m_current_music)
+            Mix_FreeMusic (m_current_music);
+        m_current_music = music;
+        if(Mix_PlayMusic (m_current_music, 1) == -1)
+            Log << "Mix_PlayMusic: " << Mix_GetError() << "\n";
+        if(position > 0) {
+            Log << "Start music at position " << position << "\n";
+            if(Mix_SetMusicPosition(position) == -1)
+                Log << "Mix_SetMusicPosition: " << Mix_GetError() << "\n";
+        }
+        Mix_VolumeMusic (m_musicvolume);
+        //Mix_SetPanning(MIX_CHANNEL_POST, m_musicvolume, m_musicvolume);
+        return true;
+    }
+    return false;
+}
+
+void SoundEngine_SDL::fadeout_music()
+{
+    while (Mix_FadingMusic() != MIX_NO_FADING)
+        SDL_Delay(10);
+
+    if (Mix_PlayingMusic()) {
+        Mix_FadeOutMusic(500);
+        SDL_Delay(400);
+    }
+    while (Mix_PlayingMusic())
+        SDL_Delay(10);
+}
+
+void SoundEngine_SDL::update_channel (int channel)
+{
+    // If distance sound origin <= this value, play at full volume
+    const double fullvol_range = 0.2;
+
+    // How far can sound travel?
+    const double range = 30;    
+
+    SoundEvent &se = m_channelinfo[channel];
+
+    double volume;
+    int    left;
+    int    right;
+    if (se.has_position) {
+        ecl::V2 distv = se.position - m_listenerpos;
+        double dist = max(0.0, length(distv) - fullvol_range);
+
+        int xdist = int(distv[0] * options::GetDouble("StereoSeparation"));
+
+        left  = ecl::Clamp (255 - xdist, 0, 255);
+        right = ecl::Clamp (255 + xdist, 0, 255);
+        volume = (1 - dist/range) * se.volume;
+    }
+    else
+    {
+        volume = se.volume;
+        left = se.left;
+        right = se.right;
+    }
+
+    Mix_SetPanning (channel, left, right);
+
+    int mixvol = ecl::round_down<int>(volume * MIX_MAX_VOLUME);
+    Mix_Volume(channel, ecl::Clamp(mixvol, 0, MIX_MAX_VOLUME));
+}
+
+int SoundEngine_SDL::already_playing (const SoundEvent &s)
+{
+    for (size_t i=0; i<m_channelinfo.size(); ++i) {
+        const SoundEvent &se = m_channelinfo[i];
+
+        if (se.active && se.name == s.name && se.playing_time < 0.05
+            && (!se.has_position || !s.has_position ||
+		ecl::length(se.position - s.position) < 30))
+            return static_cast<int> (i);
+    }
+    return -1;
+}
+
+Mix_Chunk *SoundEngine_SDL::cache_sound(const string &name)
+{
+    ecl::Dict<Mix_Chunk*>::iterator i=wav_cache.find(name);
+    if (i == wav_cache.end()) {
+        Mix_Chunk *ch = 0;
+        string filename;
+        if (app.resourceFS->findFile("soundsets/" + name + ".wav", filename))
+             ch = Mix_LoadWAV(filename.c_str());
+        if (ch != 0)
+            wav_cache.insert(name, ch);
+        else
+            enigma::Log << "Couldn't load sample '" << name << "': "
+                        << Mix_GetError() << endl;
+        return ch;
+    } else
+        return i->second;
+}
+
+void SoundEngine_SDL::cache_sound(const SoundEffect &s) 
+{
+    string filename = s.getFilename();
+    if (filename != "")
+        cache_sound(filename);
+}
+
+bool SoundEngine_SDL::play_sound (const SoundEvent &s)
+{
+    int channel = already_playing (s);
+    if (channel != -1) {
+        MutexLock (m_instance->m_mutex);
+        SoundEvent &se = m_channelinfo [channel];
+        if (se.has_position) {
+            se.position = (se.position + s.position) / 2;
+            update_channel (channel);
+            return true;
+        }
+    }
+    
+    if (Mix_Chunk *chunk = cache_sound(s.name)) {
+        channel = -1; //Mix_GroupOldest(-1);
+
+        channel = Mix_PlayChannel(channel, chunk, 0);
+
+        if (channel != -1) {
+            {
+                MutexLock (m_instance->m_mutex);
+                SoundEvent &se = m_channelinfo[channel];
+                se = s;
+                se.active       = true;
+                se.playing_time = 0.0;
+            }
+            update_channel (channel);
+        }
+        return true; // even if no free channel was found
+    } else
+        return false;
+}
+
+bool SoundEngine_SDL::is_music_playing() {
+    return Mix_PlayingMusic() || Mix_PausedMusic();
+}
+
+void SoundEngine_SDL::tick (double dtime)
+{
+    MutexLock (m_instance->m_mutex);
+    for (size_t i=0; i<m_channelinfo.size(); ++i) {
+        SoundEvent &se = m_channelinfo[i];
+        if (se.active)
+            se.playing_time += dtime;
+    }
+}
+
+void SoundEngine_SDL::define_sound (
+    const SoundName &name, 
+    const SoundData &data)
+{
+    Uint32 bufsize = static_cast<Uint32> (data.buf.size());
+    Mix_Chunk *ch= ChunkFromRaw (&data.buf[0], bufsize,
+                                 data.freq, AUDIO_S8, data.nchannels);
+    if (ch != 0)
+        wav_cache.insert(name, ch);
+}
+
+void SoundEngine_SDL::channel_finished (int channel)
+{
+    MutexLock (m_instance->m_mutex);
+    SoundEvent &se = m_instance->m_channelinfo[channel];
+    se.active = false;
+}
+
+/*! SDL_ConvertAudio is only capable of changing the sound frequency by
+  integer powers of 2 (i.e., by a factor of ... 1/4 1/2 1 2 ...).
+  The sound files used by Oxyd are sampled at 6kHz which we must
+  convert to roughly 22kHz.  This function resamples between any two
+  frequencies using simple linear interpolation.  It is not capable
+  of changing the sample format or dealing with more than one
+  channel.
+
+  FIXME: We should apply a lowpass filter after reampling to get rid
+  of the artifacts introduced by linear interpolation or use a better
+  interpolator. */
+Sint8* SoundEngine_SDL::resample (const Sint8 *data, Uint32 len, int oldfreq,
+                                  int newfreq, Uint32 *newlen_)
+    {
+        assert (data);
+        assert (len>0);
+        assert (oldfreq > 0);
+        assert (newfreq > 0);
+        const int sample_size = 1;    //  8bit sample data
+
+        float ratio = float(oldfreq) / float(newfreq);
+        Uint32 newlen = ecl::round_down<int> (len / ratio);
+        *newlen_ = newlen;
+        Sint8 *newdata = (Sint8*) malloc (sample_size * newlen);
+        if (!newdata)
+            return 0;
+
+        const Sint8 *src = data;
+        Sint8       *dst = newdata;
+
+        float srcinc = float (len-1) / float (newlen); 
+        for (unsigned i=0; i<newlen; ++i) {
+            int srcidx = ecl::round_down <int> (i * srcinc);
+            float a2 = i*srcinc - srcidx;
+            float a1 = 1.0f - a2;
+            dst[i] = static_cast<Sint8> ((a1*src[srcidx] + a2*src[srcidx+1])/2);
+        }
+        return newdata;
+    }
+
+Mix_Chunk* SoundEngine_SDL::ChunkFromRaw (const Uint8 *buf, Uint32 len,
+                                           int sfreq, int sformat, int schannels)
+{
+    if (!sound_enabled || !buf)
+        return 0;
+
+    // Get destination format
+    int dfreq, dchannels;
+    Uint16 dformat;
+    Mix_QuerySpec (&dfreq, &dformat, &dchannels);
+
+    // Resample
+    Uint32 newlen=0;
+    Uint8 *newbuf = (Uint8*)resample((const Sint8*)buf, len, sfreq, dfreq, &newlen);
+
+    // Convert audio data
+    SDL_AudioCVT cvt;
+    if (!SDL_BuildAudioCVT (&cvt, sformat, schannels, dfreq,
+                            dformat, dchannels, dfreq))
+        return 0;
+
+    cvt.buf = (Uint8*) malloc(newlen * cvt.len_mult);
+    cvt.len = newlen;
+    memcpy(cvt.buf, newbuf, newlen);
+    free(newbuf);
+
+    SDL_ConvertAudio(&cvt);
+
+    Mix_Chunk *chunk = Mix_QuickLoad_RAW(cvt.buf, cvt.len_cvt);
+    chunk->allocated = 1;
+    return chunk;
+}
+

Added: trunk/src/SoundEngine.hh
===================================================================
--- trunk/src/SoundEngine.hh	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/SoundEngine.hh	2008-04-18 22:45:50 UTC (rev 1104)
@@ -0,0 +1,179 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2007,2008 Andreas Lochmann
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef SOUNDENGINE_HH_INCLUDED
+#define SOUNDENGINE_HH_INCLUDED
+
+#include "ecl_math.hh"
+#include "ecl_dict.hh"
+
+#include "SoundEffectManager.hh"
+#include "MusicManager.hh"
+#include "SDL_mixer.h"
+
+#include <string>
+#include <vector>
+
+using namespace std;
+
+namespace sound
+{
+
+/* -------------------- Interface Functions -------------------- */
+
+    void Init();
+    void Shutdown();
+
+    void Tick (double dtime);
+
+    void DisableSound();
+    void EnableSound();
+    void DisableMusic();
+    bool PlayMusic (const string &name, double position = 0.0);
+    void FadeoutMusic();
+
+    /*! Stop any music currently playing. */
+    void StopMusic();
+    bool IsMusicPlaying();
+
+    void TempDisableSound();
+    void TempReEnableSound();
+
+    void SetListenerPosition (const ecl::V2 &pos);
+    bool PlaySound (const SoundName &, const ecl::V2 &pos,
+                    double relative_volume = 1.0, int priority=0);
+    bool PlaySoundGlobal (const SoundName &, double relative_volume = 1.0, int priority=0);
+    
+    void ClearCache();
+    void CacheSound(const SoundEffect &s);
+    void SetSoundVolume (double vol);
+    void SetMusicVolume (double vol);
+
+/* -------------------- SoundEngine -------------------- */
+
+    class SoundEngine {
+    public:
+        SoundEngine();
+        virtual ~SoundEngine() {}
+        
+        //! Returns true if successful.
+        virtual bool init() = 0;
+        virtual void shutdown() = 0;
+        virtual bool is_initialized() const = 0;
+
+        virtual void set_sound_volume (double soundvol) = 0;
+        virtual void set_music_volume (double musicvol) = 0;
+
+        // ---------- Music ----------
+
+        virtual bool play_music(const string &filename, double position) = 0;
+        virtual void stop_music() = 0;
+        virtual void fadeout_music() = 0;
+        virtual bool is_music_playing() = 0;
+        
+        // ---------- Sound effects ----------
+
+        virtual void clear_cache() = 0;
+        virtual void define_sound(const SoundName &, const SoundData &) = 0;
+        virtual bool play_sound(const SoundEvent &s) = 0;
+        virtual void cache_sound(const SoundEffect &s) = 0;
+        virtual void set_listenerpos(ecl::V2 pos) = 0;
+        virtual void tick(double dtime) = 0;
+    };
+
+    class SoundEngine_Null : public SoundEngine {
+    public:
+
+        // SoundEngine interface
+        bool init() { return true; }
+        void shutdown() {}
+        bool is_initialized() const { return true; }
+        void set_sound_volume(double /*soundvol*/) {}
+        void set_music_volume(double /*musicvol*/) {}
+        bool play_music (const string &/*filename*/, double /*position*/) { return false; }
+        void stop_music() {}
+        void fadeout_music() {}
+        bool is_music_playing() { return false; }
+        void clear_cache() {}
+        void define_sound (const SoundName &, const SoundData &) {}
+        bool play_sound (const SoundEvent &) {}
+        void cache_sound(const SoundEffect &s) {}
+        void set_listenerpos (ecl::V2 pos) {}
+        void tick(double /*dtime*/) {}
+    };
+
+    class SoundEngine_SDL : public SoundEngine {
+    public:
+        SoundEngine_SDL();
+        ~SoundEngine_SDL();
+
+        // ---------- SoundEngine interface ----------
+        bool init();        
+        void shutdown();
+        bool is_initialized() const { return m_initialized; }
+        void set_sound_volume(double soundvol);
+        void set_music_volume(double musicvol);
+        bool play_music (const string &filename, double position);
+        void stop_music();
+        void fadeout_music();
+        bool is_music_playing();
+        void clear_cache();
+        void define_sound (const SoundName &, const SoundData &);
+        bool play_sound(const SoundEvent &s);
+        void cache_sound(const SoundEffect &s);
+        void set_listenerpos (ecl::V2 pos) { m_listenerpos = pos; }
+        void tick (double dtime);
+
+        /*! These functions convert raw audio data with a specified format to
+          the mixer's audio format.  This is used for converting the original
+          Oxyd sounds to a format usable by Enigma. */
+
+        Sint8* resample (const Sint8 *data, Uint32 len, int oldfreq,
+                         int newfreq, Uint32 *newlen_);
+        Mix_Chunk *ChunkFromRaw (const Uint8 *buf, Uint32 len,
+                                 int freq, int format, int channels);
+
+    private:
+        // ---------- Private methods ----------
+        Mix_Chunk *cache_sound(const string &name);
+
+        void update_channel (int channel);
+        int already_playing (const SoundEvent &s);
+
+
+        static void channel_finished (int channel);
+
+
+        // ---------- Variables ----------
+        bool       m_initialized;
+        int        m_soundvolume;
+        int        m_musicvolume;
+        Mix_Music *m_current_music;
+        int        m_freq;
+        Uint16     m_format;
+        int        m_channels;
+        ecl::Dict<Mix_Chunk*> wav_cache;
+        vector<SoundEvent> m_channelinfo;
+        ecl::V2      m_listenerpos;
+        SDL_mutex  *m_mutex;
+        static SoundEngine_SDL *m_instance;
+    };
+}
+
+#endif

Modified: trunk/src/actors.cc
===================================================================
--- trunk/src/actors.cc	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/actors.cc	2008-04-18 22:45:50 UTC (rev 1104)
@@ -21,7 +21,7 @@
 #include "errors.hh"
 #include "enigma.hh"
 #include "player.hh"
-#include "sound.hh"
+#include "SoundEffectManager.hh"
 #include "server.hh"
 #include "world.hh"
 //#include "main.hh"

Modified: trunk/src/client.cc
===================================================================
--- trunk/src/client.cc	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/client.cc	2008-04-18 22:45:50 UTC (rev 1104)
@@ -26,7 +26,9 @@
 #include "gui/HelpMenu.hh"
 #include "main.hh"
 #include "gui/GameMenu.hh"
-#include "sound.hh"
+#include "SoundEngine.hh"
+#include "SoundEffectManager.hh"
+#include "MusicManager.hh"
 #include "player.hh"
 #include "world.hh"
 #include "nls.hh"

Modified: trunk/src/enigma-lua.pkg
===================================================================
--- trunk/src/enigma-lua.pkg	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/enigma-lua.pkg	2008-04-18 22:45:50 UTC (rev 1104)
@@ -114,7 +114,7 @@
 
 /* -------------------- sound.cc -------------------- */
 
-$#include "sound.hh"
+$#include "SoundEffectManager.hh"
 $using namespace sound;
 
 module sound

Modified: trunk/src/game.cc
===================================================================
--- trunk/src/game.cc	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/game.cc	2008-04-18 22:45:50 UTC (rev 1104)
@@ -24,7 +24,7 @@
 #include "client.hh"
 #include "server.hh"
 #include "world.hh"
-#include "sound.hh"
+#include "SoundEngine.hh"
 #include "lev/PersistentIndex.hh"
 
 #include "ecl_sdl.hh"

Modified: trunk/src/gui/LevelMenu.cc
===================================================================
--- trunk/src/gui/LevelMenu.cc	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/gui/LevelMenu.cc	2008-04-18 22:45:50 UTC (rev 1104)
@@ -28,7 +28,7 @@
 #include "nls.hh"
 #include "options.hh"
 #include "server.hh"
-#include "sound.hh"
+#include "MusicManager.hh"
 #include "StateManager.hh"
 #include "video.hh"
 #include "lev/Index.hh"

Modified: trunk/src/gui/LevelPackComposer.cc
===================================================================
--- trunk/src/gui/LevelPackComposer.cc	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/gui/LevelPackComposer.cc	2008-04-18 22:45:50 UTC (rev 1104)
@@ -23,7 +23,7 @@
 #include "enigma.hh"
 #include "errors.hh"
 #include "nls.hh"
-#include "sound.hh"
+#include "SoundEffectManager.hh"
 #include "video.hh"
 #include "lev/Index.hh"
 

Modified: trunk/src/gui/LevelWidget.cc
===================================================================
--- trunk/src/gui/LevelWidget.cc	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/gui/LevelWidget.cc	2008-04-18 22:45:50 UTC (rev 1104)
@@ -26,7 +26,7 @@
 #include "main.hh"
 #include "nls.hh"
 #include "options.hh"
-#include "sound.hh"
+#include "SoundEffectManager.hh"
 #include "StateManager.hh"
 #include "video.hh"
 #include "file.hh"

Modified: trunk/src/gui/MainMenu.cc
===================================================================
--- trunk/src/gui/MainMenu.cc	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/gui/MainMenu.cc	2008-04-18 22:45:50 UTC (rev 1104)
@@ -29,7 +29,7 @@
 #include "main.hh"
 #include "nls.hh"
 #include "options.hh"
-#include "sound.hh"
+#include "MusicManager.hh"
 #include "video.hh"
 #include "world.hh"
 

Modified: trunk/src/gui/Menu.cc
===================================================================
--- trunk/src/gui/Menu.cc	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/gui/Menu.cc	2008-04-18 22:45:50 UTC (rev 1104)
@@ -18,7 +18,8 @@
  */
 
 #include "gui/Menu.hh"
-#include "sound.hh"
+#include "SoundEffectManager.hh"
+#include "MusicManager.hh"
 #include "video.hh"
 #include "options.hh"
 #include "main.hh"

Modified: trunk/src/gui/OptionsMenu.cc
===================================================================
--- trunk/src/gui/OptionsMenu.cc	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/gui/OptionsMenu.cc	2008-04-18 22:45:50 UTC (rev 1104)
@@ -26,7 +26,9 @@
 #include "nls.hh"
 #include "options.hh"
 #include "oxyd.hh"
-#include "sound.hh"
+#include "SoundEngine.hh"
+#include "SoundEffectManager.hh"
+#include "MusicManager.hh"
 #include "Utf8ToXML.hh"
 #include "video.hh"
 #include "XMLtoLocal.hh"
@@ -99,12 +101,8 @@
     };
 
     class InGameMusicButton : public BoolOptionButton {
-        void on_action(Widget *) {
-            if (toggle())
-                sound::PlayMusic (options::GetString("LevelMusicFile"));
-            else
-                sound::StopMusic (options::GetString("LevelMusicFile"));
-        }
+        void on_action(Widget *) { sound::SetInGameMusicActive(toggle()); }
+
     public:
         InGameMusicButton() :
             BoolOptionButton("InGameMusic", N_("Music in game"), N_("No music in game"), this)

Modified: trunk/src/gui/TextField.cc
===================================================================
--- trunk/src/gui/TextField.cc	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/gui/TextField.cc	2008-04-18 22:45:50 UTC (rev 1104)
@@ -22,7 +22,7 @@
 #include "gui/TextField.hh"
 #include "ecl_utf.hh"
 #include "enigma.hh"
-#include "sound.hh"
+#include "SoundEffectManager.hh"
 #include "video.hh"
 #include "options.hh"
 #include "nls.hh"

Modified: trunk/src/gui/widgets.cc
===================================================================
--- trunk/src/gui/widgets.cc	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/gui/widgets.cc	2008-04-18 22:45:50 UTC (rev 1104)
@@ -19,7 +19,7 @@
 
 #include "gui/widgets.hh"
 #include "enigma.hh"
-#include "sound.hh"
+#include "SoundEffectManager.hh"
 #include "video.hh"
 #include "options.hh"
 #include "nls.hh"

Modified: trunk/src/items.cc
===================================================================
--- trunk/src/items.cc	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/items.cc	2008-04-18 22:45:50 UTC (rev 1104)
@@ -23,7 +23,7 @@
 #include "display.hh"
 #include "player.hh"
 #include "client.hh"
-#include "sound.hh"
+#include "SoundEffectManager.hh"
 #include "server.hh"
 #include "world.hh"
 #include "Inventory.hh"

Modified: trunk/src/laser.cc
===================================================================
--- trunk/src/laser.cc	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/laser.cc	2008-04-18 22:45:50 UTC (rev 1104)
@@ -19,7 +19,7 @@
  */
 #include "errors.hh"
 #include "laser.hh"
-#include "sound.hh"
+#include "SoundEffectManager.hh"
 #include "stones_internal.hh"
 #include "server.hh"
 #include "stones/LaserStone.hh"

Modified: trunk/src/lev/Index.cc
===================================================================
--- trunk/src/lev/Index.cc	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/lev/Index.cc	2008-04-18 22:45:50 UTC (rev 1104)
@@ -21,7 +21,7 @@
 #include "errors.hh"
 #include "main.hh"
 #include "options.hh"
-#include "sound.hh"
+#include "SoundEffectManager.hh"
 #include "PreferenceManager.hh"
 #include "StateManager.hh"
 #include "lev/ScoreManager.hh"

Modified: trunk/src/lua-display.cc
===================================================================
--- trunk/src/lua-display.cc	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/lua-display.cc	2008-04-18 22:45:50 UTC (rev 1104)
@@ -1,6 +1,6 @@
 /*
 ** Lua binding: display
-** Generated automatically by tolua++-1.0.92 on Mon Oct 29 00:41:21 2007.
+** Generated automatically by tolua++-1.0.92 on Fri Apr 18 01:20:21 2008.
 */
 
 #ifndef __cplusplus

Modified: trunk/src/lua-display.hh
===================================================================
--- trunk/src/lua-display.hh	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/lua-display.hh	2008-04-18 22:45:50 UTC (rev 1104)
@@ -1,6 +1,6 @@
 /*
 ** Lua binding: display
-** Generated automatically by tolua++-1.0.92 on Mon Oct 29 00:41:21 2007.
+** Generated automatically by tolua++-1.0.92 on Fri Apr 18 01:20:21 2008.
 */
 
 /* Exported function */

Modified: trunk/src/lua-ecl.cc
===================================================================
--- trunk/src/lua-ecl.cc	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/lua-ecl.cc	2008-04-18 22:45:50 UTC (rev 1104)
@@ -1,6 +1,6 @@
 /*
 ** Lua binding: px
-** Generated automatically by tolua++-1.0.92 on Mon Oct 29 00:41:21 2007.
+** Generated automatically by tolua++-1.0.92 on Fri Apr 18 01:20:21 2008.
 */
 
 #ifndef __cplusplus

Modified: trunk/src/lua-ecl.hh
===================================================================
--- trunk/src/lua-ecl.hh	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/lua-ecl.hh	2008-04-18 22:45:50 UTC (rev 1104)
@@ -1,6 +1,6 @@
 /*
 ** Lua binding: px
-** Generated automatically by tolua++-1.0.92 on Mon Oct 29 00:41:21 2007.
+** Generated automatically by tolua++-1.0.92 on Fri Apr 18 01:20:21 2008.
 */
 
 /* Exported function */

Modified: trunk/src/lua-editor.cc
===================================================================
--- trunk/src/lua-editor.cc	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/lua-editor.cc	2008-04-18 22:45:50 UTC (rev 1104)
@@ -1,6 +1,6 @@
 /*
 ** Lua binding: editor
-** Generated automatically by tolua++-1.0.92 on Mon Oct 29 00:41:21 2007.
+** Generated automatically by tolua++-1.0.92 on Fri Apr 18 01:20:21 2008.
 */
 
 #ifndef __cplusplus

Modified: trunk/src/lua-editor.hh
===================================================================
--- trunk/src/lua-editor.hh	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/lua-editor.hh	2008-04-18 22:45:50 UTC (rev 1104)
@@ -1,6 +1,6 @@
 /*
 ** Lua binding: editor
-** Generated automatically by tolua++-1.0.92 on Mon Oct 29 00:41:21 2007.
+** Generated automatically by tolua++-1.0.92 on Fri Apr 18 01:20:21 2008.
 */
 
 /* Exported function */

Modified: trunk/src/lua-enigma.cc
===================================================================
--- trunk/src/lua-enigma.cc	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/lua-enigma.cc	2008-04-18 22:45:50 UTC (rev 1104)
@@ -1,6 +1,6 @@
 /*
 ** Lua binding: enigma
-** Generated automatically by tolua++-1.0.92 on Mon Oct 29 00:41:21 2007.
+** Generated automatically by tolua++-1.0.92 on Fri Apr 18 01:20:21 2008.
 */
 
 #ifndef __cplusplus
@@ -25,7 +25,7 @@
 #include "video.hh"
 using namespace video;
 using ecl::Screen;
-#include "sound.hh"
+#include "SoundEffectManager.hh"
 using namespace sound;
 
 /* function to register type */

Modified: trunk/src/lua-enigma.hh
===================================================================
--- trunk/src/lua-enigma.hh	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/lua-enigma.hh	2008-04-18 22:45:50 UTC (rev 1104)
@@ -1,6 +1,6 @@
 /*
 ** Lua binding: enigma
-** Generated automatically by tolua++-1.0.92 on Mon Oct 29 00:41:21 2007.
+** Generated automatically by tolua++-1.0.92 on Fri Apr 18 01:20:21 2008.
 */
 
 /* Exported function */

Modified: trunk/src/lua-global.cc
===================================================================
--- trunk/src/lua-global.cc	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/lua-global.cc	2008-04-18 22:45:50 UTC (rev 1104)
@@ -1,6 +1,6 @@
 /*
 ** Lua binding: global
-** Generated automatically by tolua++-1.0.92 on Mon Oct 29 00:41:21 2007.
+** Generated automatically by tolua++-1.0.92 on Fri Apr 18 01:20:21 2008.
 */
 
 #ifndef __cplusplus

Modified: trunk/src/lua-global.hh
===================================================================
--- trunk/src/lua-global.hh	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/lua-global.hh	2008-04-18 22:45:50 UTC (rev 1104)
@@ -1,6 +1,6 @@
 /*
 ** Lua binding: global
-** Generated automatically by tolua++-1.0.92 on Mon Oct 29 00:41:21 2007.
+** Generated automatically by tolua++-1.0.92 on Fri Apr 18 01:20:21 2008.
 */
 
 /* Exported function */

Modified: trunk/src/lua.cc
===================================================================
--- trunk/src/lua.cc	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/lua.cc	2008-04-18 22:45:50 UTC (rev 1104)
@@ -24,7 +24,7 @@
 #include "config.h"
 #include "video.hh"
 #include "server.hh"
-#include "sound.hh"
+#include "SoundEffectManager.hh"
 #include "options.hh"
 #include "WorldProxy.hh"
 #include "lev/Index.hh"

Modified: trunk/src/main.cc
===================================================================
--- trunk/src/main.cc	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/main.cc	2008-04-18 22:45:50 UTC (rev 1104)
@@ -25,7 +25,9 @@
 #include "gui/LevelPreviewCache.hh"
 #include "options.hh"
 #include "oxyd.hh"
-#include "sound.hh"
+#include "SoundEngine.hh"
+#include "SoundEffectManager.hh"
+#include "MusicManager.hh"
 #include "video.hh"
 #include "ecl_argp.hh"
 #include "ecl_system.hh"

Modified: trunk/src/options.cc
===================================================================
--- trunk/src/options.cc	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/options.cc	2008-04-18 22:45:50 UTC (rev 1104)
@@ -21,7 +21,9 @@
 #include "main.hh"
 #include "options.hh"
 #include "PreferenceManager.hh"
-#include "sound.hh"
+#include "SoundEngine.hh"
+#include "SoundEffectManager.hh"
+#include "MusicManager.hh"
 #include "ecl_system.hh"
 
 #include <cassert>

Modified: trunk/src/oxyd.cc
===================================================================
--- trunk/src/oxyd.cc	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/oxyd.cc	2008-04-18 22:45:50 UTC (rev 1104)
@@ -25,7 +25,8 @@
 
 #include "errors.hh"
 #include "oxyd.hh"
-#include "sound.hh"
+#include "SoundEngine.hh"
+#include "SoundEffectManager.hh"
 #include "lua.hh"
 #include "server.hh"
 #include "player.hh"

Modified: trunk/src/player.cc
===================================================================
--- trunk/src/player.cc	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/player.cc	2008-04-18 22:45:50 UTC (rev 1104)
@@ -20,7 +20,7 @@
 #include "Inventory.hh"
 #include "display.hh"
 #include "errors.hh"
-#include "sound.hh"
+#include "SoundEffectManager.hh"
 #include "client.hh"
 #include "server.hh"
 #include "world.hh"

Deleted: trunk/src/sound.cc
===================================================================
--- trunk/src/sound.cc	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/sound.cc	2008-04-18 22:45:50 UTC (rev 1104)
@@ -1,1203 +0,0 @@
-/*
- * Copyright (C) 2002,2003,2004 Daniel Heck
- * Copyright (C) 2007 Andreas Lochmann
- *
- * This program is free software; you can redistribute it and/or
- * modify it under the terms of the GNU General Public License
- * as published by the Free Software Foundation; either version 2
- * of the License, or (at your option) any later version.
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- * GNU General Public License for more details.
- *
- * You should have received a copy of the GNU General Public License along
- * with this program; if not, write to the Free Software Foundation, Inc.,
- * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
- *
- */
-#include "errors.hh"
-#include "enigma.hh"
-#include "options.hh"
-#include "sound.hh"
-#include "main.hh"
-#include "oxyd.hh"
-#include "oxydlib/OxydVersion.h"
-#include "nls.hh"
-#include "client.hh"
-
-#include "SDL.h"
-#include "SDL_mixer.h"
-
-#include <string>
-#include <iostream>
-#include <cassert>
-#include <memory>
-
-using namespace std;
-using namespace enigma;
-using namespace sound;
-using namespace OxydLib;
-
-#include "sound_internal.hh"
-
-/*! This function converts raw audio data with a specified format to
-  the mixer's audio format.  This is used for converting the original
-  Oxyd sounds to a format usable by Enigma. */
-Mix_Chunk *ChunkFromRaw (const Uint8 *buf, Uint32 len,
-                         int freq, int format, int channels);
-
-
-/* -------------------- SoundEvent implementation -------------------- */
-SoundEvent::SoundEvent ()
-: name(""), has_position(false), position(),
-  priority (0), volume (0.0),
-  left (0), right(0), active (false),
-  playing_time (0)
-{
-}
-
-bool not_active (const SoundEvent &s)
-{
-    return !s.active;
-}
-
-bool lower_priority (const SoundEvent &s, const SoundEvent &t)
-{
-    return s.priority < t.priority;
-}
-
-
-SoundEngine::SoundEngine()
-: sound_sets(), sound_effects(), active_sound_set_key(""),
-  default_sound_set(""), sound_set_count(0), music_singles(),
-  music_queues(), active_music_queue(""), music_context(MUSIC_NONE)
-{}
-
-
-/* -------------------- SoundEngine_SDL implementation -------------------- */
-
-class MutexLock {
-public:
-    MutexLock (SDL_mutex *m) {
-        mutex = m;
-        SDL_mutexP (mutex);
-    }
-    ~MutexLock () {
-        SDL_mutexV (mutex);
-    };
-private:
-    SDL_mutex *mutex;
-};
-
-SoundEngine_SDL *SoundEngine_SDL::m_instance = 0;
-
-SoundEngine_SDL::SoundEngine_SDL()
-: m_initialized(false),
-  m_soundvolume (MIX_MAX_VOLUME),
-  m_musicvolume (MIX_MAX_VOLUME),
-  m_current_music (0),
-  m_freq (MIX_DEFAULT_FREQUENCY),
-  m_format (MIX_DEFAULT_FORMAT),
-  m_channels (MIX_DEFAULT_CHANNELS)
-{
-    assert (m_instance == 0);
-    m_instance = this;
-}
-
-SoundEngine_SDL::~SoundEngine_SDL()
-{
-    shutdown();
-    m_instance = 0;
-}
-
-bool SoundEngine_SDL::init() 
-{
-    if (!m_initialized) {
-        // Initialize SDL audio subsystem
-        if (SDL_InitSubSystem (SDL_INIT_AUDIO) == -1) {
-            fprintf(stderr, "Couldn't open SDL audio subsystem: %s\n", SDL_GetError());
-            return false;
-        }
-
-        // Initialize SDL_mixer lib
-        if (Mix_OpenAudio(m_freq, m_format, m_channels, 1024) < 0) {
-            fprintf(stderr, "Couldn't open mixer: %s\n", Mix_GetError());
-            return false;
-        }
-
-        // Update number of available channels
-        m_channels = Mix_GroupCount (-1);
-        m_channelinfo.resize (m_channels);
-
-        Mix_ChannelFinished (&channel_finished);
-        m_mutex = SDL_CreateMutex();
-        if (!m_mutex)
-            return false;
-
-        m_initialized = true;
-    }
-    return true;
-}
-
-void SoundEngine_SDL::shutdown() 
-{
-    if (m_initialized) {
-	Mix_FreeMusic(m_current_music);
-        Mix_CloseAudio();
-        clear_cache();
-        SDL_DestroyMutex (m_mutex);
-        m_initialized = false;
-    }
-}
-
-
-void SoundEngine_SDL::clear_cache() 
-{
-    for (ecl::Dict<Mix_Chunk*>::iterator it = wav_cache.begin(); it != wav_cache.end(); ++it)
-        Mix_FreeChunk(it->second);
-    wav_cache.clear();
-}
-
-void SoundEngine_SDL::set_sound_volume (double soundvol) 
-{
-    if (!m_initialized)
-        return;                 // SDL_mixer crashes without this check
-
-    m_soundvolume = ecl::round_down<int>(ecl::Clamp(soundvol, 0.0, 1.0) * MIX_MAX_VOLUME);
-    Mix_Volume (-1, m_soundvolume);
-}
-
-void SoundEngine_SDL::set_music_volume (double musicvol) 
-{
-    if (!m_initialized)
-        return;                 // SDL_mixer crashes without this check
-
-    m_musicvolume = ecl::round_down<int>(ecl::Clamp(musicvol, 0.0, 1.0) * MIX_MAX_VOLUME);
-    Mix_VolumeMusic (m_musicvolume);
-}
-
-
-void SoundEngine_SDL::stop_music() 
-{
-    Mix_HaltMusic();
-    Mix_FreeMusic(m_current_music);
-    m_current_music = 0;
-}
-
-bool SoundEngine_SDL::play_music (const std::string &filename, double position) 
-{
-    if (Mix_Music *music = Mix_LoadMUS(filename.c_str())) {
-        if (m_current_music)
-            Mix_FreeMusic (m_current_music);
-        m_current_music = music;
-        Mix_PlayMusic (m_current_music, 1);
-        if(position > 0) {
-          Log << "Start music at position " << position << "\n";
-          if(Mix_SetMusicPosition(position) == -1)
-          Log << "Mix_SetMusicPosition: " << Mix_GetError() << "\n";
-        }
-        Mix_VolumeMusic (m_musicvolume);
-        return true;
-    }
-    return false;
-}
-
-void SoundEngine_SDL::fadeout_music()
-{
-    while (Mix_FadingMusic() != MIX_NO_FADING)
-        SDL_Delay(10);
-
-    if (Mix_PlayingMusic()) {
-        Mix_FadeOutMusic(500);
-        SDL_Delay(400);
-    }
-    while (Mix_PlayingMusic())
-        SDL_Delay(10);
-}
-
-void SoundEngine_SDL::update_channel (int channel)
-{
-    // If distance sound origin <= this value, play at full volume
-    const double fullvol_range = 0.2;
-
-    // How far can sound travel?
-    const double range = 30;    
-
-    SoundEvent &se = m_channelinfo[channel];
-
-    double volume;
-    int    left;
-    int    right;
-    if (se.has_position) {
-        ecl::V2 distv = se.position - m_listenerpos;
-        double dist = max(0.0, length(distv) - fullvol_range);
-
-        int xdist = int(distv[0] * options::GetDouble("StereoSeparation"));
-
-        left  = ecl::Clamp (255 - xdist, 0, 255);
-        right = ecl::Clamp (255 + xdist, 0, 255);
-        volume = (1 - dist/range) * se.volume;
-    }
-    else
-    {
-        volume = se.volume;
-        left = se.left;
-        right = se.right;
-    }
-
-    Mix_SetPanning (channel, left, right);
-
-    int mixvol = ecl::round_down<int>(volume * MIX_MAX_VOLUME);
-    Mix_Volume(channel, ecl::Clamp(mixvol, 0, MIX_MAX_VOLUME));
-}
-
-int SoundEngine_SDL::already_playing (const SoundEvent &s)
-{
-    for (size_t i=0; i<m_channelinfo.size(); ++i) {
-        const SoundEvent &se = m_channelinfo[i];
-
-        if (se.active && se.name == s.name && se.playing_time < 0.05
-            && (!se.has_position || !s.has_position ||
-		ecl::length(se.position - s.position) < 30))
-            return static_cast<int> (i);
-    }
-    return -1;
-}
-
-
-Mix_Chunk *SoundEngine_SDL::cache_sound(const std::string &name)
-{
-    ecl::Dict<Mix_Chunk*>::iterator i=wav_cache.find(name);
-    if (i == wav_cache.end()) {
-        Mix_Chunk *ch = 0;
-        string filename;
-        if (app.resourceFS->findFile("soundsets/" + name + ".wav", filename))
-             ch = Mix_LoadWAV(filename.c_str());
-        if (ch != 0)
-            wav_cache.insert(name, ch);
-        else
-            enigma::Log << "Couldn't load sample '" << name << "': "
-                        << Mix_GetError() << endl;
-        return ch;
-    } else
-        return i->second;
-}
-
-void SoundEngine_SDL::cache_sound(const SoundEffect &s) 
-{
-    string filename = s.getFilename();
-    if (filename != "")
-        cache_sound(filename);
-}
-
-bool SoundEngine_SDL::play_sound (const SoundEvent &s)
-{
-    int channel = already_playing (s);
-    if (channel != -1) {
-        MutexLock (m_instance->m_mutex);
-        SoundEvent &se = m_channelinfo [channel];
-        if (se.has_position) {
-            se.position = (se.position + s.position) / 2;
-            update_channel (channel);
-            return true;
-        }
-    }
-    
-    if (Mix_Chunk *chunk = cache_sound(s.name)) {
-        channel = -1; //Mix_GroupOldest(-1);
-
-        channel = Mix_PlayChannel(channel, chunk, 0);
-
-        if (channel != -1) {
-            {
-                MutexLock (m_instance->m_mutex);
-                SoundEvent &se = m_channelinfo[channel];
-                se = s;
-                se.active       = true;
-                se.playing_time = 0.0;
-            }
-            update_channel (channel);
-        }
-        return true; // even if no free channel was found
-    } else
-        return false;
-}
-
-void SoundEngine_SDL::tick (double dtime)
-{
-    MutexLock (m_instance->m_mutex);
-    for (size_t i=0; i<m_channelinfo.size(); ++i) {
-        SoundEvent &se = m_channelinfo[i];
-        if (se.active)
-            se.playing_time += dtime;
-    }
-}
-
-void SoundEngine_SDL::define_sound (
-    const SoundName &name, 
-    const SoundData &data)
-{
-    Uint32 bufsize = static_cast<Uint32> (data.buf.size());
-    Mix_Chunk *ch= ChunkFromRaw (&data.buf[0], bufsize,
-                                 data.freq, AUDIO_S8, data.nchannels);
-    if (ch != 0)
-        wav_cache.insert(name, ch);
-}
-
-void SoundEngine_SDL::channel_finished (int channel)
-{
-    MutexLock (m_instance->m_mutex);
-    SoundEvent &se = m_instance->m_channelinfo[channel];
-    se.active = false;
-}
-
-
-
-
-/* -------------------- Local variables -------------------- */
-namespace
-{
-    auto_ptr<SoundEngine> sound_engine;
-
-    bool sound_enabled      = true;
-    bool music_enabled      = true;
-    bool sound_enabled_temp = false;
-
-    string     current_music_name;
-}
-
-
-
-/* -------------------- Functions -------------------- */
-
-void sound::Init() 
-{
-    if (!sound_engine.get()) {
-        sound_engine.reset(new SoundEngine_SDL);
-    }
-
-    if (sound_engine->init()) {
-        options::UpdateVolume();
-    }
-    else {
-        sound_enabled = false;
-        sound_engine.reset(new SoundEngine_Null);
-    }
-}
-
-void sound::Shutdown() 
-{
-    if (sound_engine.get())
-        sound_engine->shutdown();
-}
-
-void sound::Tick (double dtime)
-{
-    sound_engine->tick (dtime);
-    sound::MusicTick(dtime);
-}
-
-void sound::DisableSound() {
-    if (sound_enabled) {
-        sound_enabled = false;
-        Shutdown();
-    }
-}
-
-void sound::EnableSound() {
-    if (!sound_enabled) {
-        sound_enabled = true;
-        Init();
-    }
-}
-
-void sound::TempDisableSound() {
-    sound_enabled_temp = sound_enabled;
-    sound_enabled      = false;
-}
-
-void sound::TempReEnableSound() {
-    sound_enabled = sound_enabled_temp;
-}
-
-void sound::DisableMusic() {
-    music_enabled = false;
-}
-
-void sound::SetListenerPosition (const ecl::V2 &pos) 
-{
-    sound_engine->set_listenerpos (pos);
-}
-
-bool sound::PlaySound (const SoundName &name, const ecl::V2 &pos, double volume, int priority) 
-{
-    if (!sound_enabled)
-        return false;
-
-    SoundEvent se;
-    se.name         = name;
-    se.has_position = true;
-    se.position     = pos;
-    se.priority     = priority;
-    se.volume       = volume * options::GetDouble("SoundVolume");
-    se.left = se.right = 0;
-
-    return sound_engine->play_sound (se);
-}
-
-bool sound::PlaySoundGlobal (const SoundName &name, double volume, int priority) 
-{
-    SoundEvent se;
-    se.name         = name;
-    se.has_position = false;
-    se.position     = ecl::V2();
-    se.priority     = priority;
-    se.volume       = volume * options::GetDouble("SoundVolume");
-    se.left         = 255;
-    se.right        = 255;
-
-    return sound_engine->play_sound (se);
-}
-
-void sound::FadeoutMusic() 
-{
-    sound_engine->fadeout_music();
-}
-
-bool sound::PlayMusic (const std::string &name, double position) 
-{
-    if(name == current_music_name)
-        return true;
-    if(!sound_enabled || !music_enabled || name=="")
-        return false;
-    
-    FadeoutMusic();
-
-    string fname;
-    if (app.resourceFS->findFile (name, fname) && sound_engine->play_music(fname, position)) {
-        current_music_name = name;
-        return true;
-    } else {
-        current_music_name = "";
-        return false;
-    }
-}
-
-void sound::StopMusic() {
-    sound_engine->stop_music();
-    current_music_name = "";
-}
-
-void sound::StopMusic (const std::string &name) {
-    if (name==current_music_name)
-        StopMusic();
-}
-
-bool sound::StartMenuMusic()
-{
-    if(sound_engine->getMusicContext() != MUSIC_MENU) {
-        sound::FadeoutMusic();
-        sound_engine->setMusicContext(MUSIC_MENU);
-    }
-}
-
-bool sound::StartLevelMusic()
-{
-    if(sound_engine->getMusicContext() != MUSIC_GAME) {
-        sound::FadeoutMusic();
-        sound_engine->setMusicContext(MUSIC_GAME);
-    }
-}
-
-void sound::MusicTick(double dtime)
-{
-    sound_engine->music_tick(dtime);
-}
-
-void SoundEngine::music_tick(double dtime)
-{
-    static double cumulated_dtime = 0;
-    cumulated_dtime += dtime;
-    if(cumulated_dtime > 0.2) {
-      if((!Mix_PlayingMusic()) && (!Mix_PausedMusic())) {
-        // Music has ended or not even begun
-        current_music_name = "";
-        switch(sound_engine->getMusicContext()) {
-            case MUSIC_MENU:
-                music_queues[active_music_queue].next();                
-                //sound::PlayMusic ("music/menu/esprit.ogg");
-                //sound::PlayMusic (options::GetString("MenuMusicFile"));
-                break;
-            case MUSIC_GAME:
-                if (options::GetBool("InGameMusic")) {
-                    //sound::PlayMusic ("music/menu/esprit.ogg");
-                    //sound::PlayMusic (options::GetString("LevelMusicFile"));
-                } else
-                    sound::StopMusic();
-                break;
-        }
-      } else {
-        // Music is still running. Check if we should reloop.
-        if(active_music_queue != "") {
-            string current_title = music_queues[active_music_queue].getCurrentMusicTitle();
-            if(current_title != "") {
-                music_singles[current_title].maybeLoopBack();
-            }
-        }
-      }
-      cumulated_dtime = 0;
-    }
-}
-
-void sound::InitMusic()
-{
-    sound_engine->init_music();
-}
-
-void SoundEngine::init_music()
-{
-    // TODO: This is only temporary. Information will come 
-    // from an xml file later.
-    music_singles["Esprit Loop"] =
-        MusicSingle("Esprit Loop", "music/menu/esprit.ogg", 178180, 10690, 21600, true);
-    music_singles["Esprit"] =
-        MusicSingle("Esprit", "music/menu/esprit.ogg", 178180, 10690, 21600, false);
-    music_singles["Pentagonal Dreams"] =
-        MusicSingle("Pentagonal Dreams", "music/menu/menu.s3m");
-
-    music_queues["Default"] = MusicQueue("Default", 0);
-    music_queues["Default"].appendSingle("Esprit");
-    music_queues["Default"].appendSingle("Pentagonal Dreams");
-
-    music_queues["Esprit"] = MusicQueue("Esprit", 1);
-    music_queues["Esprit"].appendSingle("Esprit");
-
-    music_queues["Pentagonal Dreams"] = MusicQueue("Pentagonal Dreams", 2);
-    music_queues["Pentagonal Dreams"].appendSingle("Pentagonal Dreams");
-
-    music_queues["Loop test"] = MusicQueue("Loop test", 3);
-    music_queues["Loop test"].appendSingle("Esprit Loop");
-
-    app.state->setProperty("MenuMusicQueue", "Default");
-    active_music_queue = "Default";
-}
-
-void sound::ClearCache()
-{
-    sound_engine->clear_cache();
-}
-
-void sound::DefineSound (const SoundName &name, const SoundData &data)
-{
-    sound_engine->define_sound (name, data);
-}
-
-void sound::SetSoundVolume (double vol)
-{
-    sound_engine->set_sound_volume (vol);
-}
-
-void sound::SetMusicVolume (double vol)
-{
-    sound_engine->set_music_volume (vol);
-}
-
-/* SDL_ConvertAudio is only capable of changing the sound frequency by
-   integer powers of 2 (i.e., by a factor of ... 1/4 1/2 1 2 ...).
-   The sound files used by Oxyd are sampled at 6kHz which we must
-   convert to roughly 22kHz.  This function resamples between any two
-   frequencies using simple linear interpolation.  It is not capable
-   of changing the sample format or dealing with more than one
-   channel.
-
-   FIXME: We should apply a lowpass filter after reampling to get rid
-   of the artifacts introduced by linear interpolation or use a better
-   interpolator.
-*/
-namespace
-{
-    Sint8 *resample (const Sint8 *data, Uint32 len, int oldfreq, int newfreq, 
-                     Uint32 *newlen_)
-    {
-        assert (data);
-        assert (len>0);
-        assert (oldfreq > 0);
-        assert (newfreq > 0);
-        const int sample_size = 1;    //  8bit sample data
-
-        float ratio = float(oldfreq) / float(newfreq);
-        Uint32 newlen = ecl::round_down<int> (len / ratio);
-        *newlen_ = newlen;
-        Sint8 *newdata = (Sint8*) malloc (sample_size * newlen);
-        if (!newdata)
-            return 0;
-
-        const Sint8 *src = data;
-        Sint8       *dst = newdata;
-
-        float srcinc = float (len-1) / float (newlen); 
-        for (unsigned i=0; i<newlen; ++i) {
-            int srcidx = ecl::round_down <int> (i * srcinc);
-            float a2 = i*srcinc - srcidx;
-            float a1 = 1.0f - a2;
-            dst[i] = static_cast<Sint8> ((a1*src[srcidx] + a2*src[srcidx+1])/2);
-        }
-        return newdata;
-    }
-}
-
-Mix_Chunk * ChunkFromRaw (const Uint8 *buf, Uint32 len,
-                          int sfreq, int sformat, int schannels)
-{
-    if (!sound_enabled || !buf)
-        return 0;
-
-    // Get destination format
-    int dfreq, dchannels;
-    Uint16 dformat;
-    Mix_QuerySpec (&dfreq, &dformat, &dchannels);
-
-    // Resample
-    Uint32 newlen=0;
-    Uint8 *newbuf = (Uint8*)resample((const Sint8*)buf, len, sfreq, dfreq, &newlen);
-
-    // Convert audio data
-    SDL_AudioCVT cvt;
-    if (!SDL_BuildAudioCVT (&cvt, sformat, schannels, dfreq,
-                            dformat, dchannels, dfreq))
-        return 0;
-
-    cvt.buf = (Uint8*) malloc(newlen * cvt.len_mult);
-    cvt.len = newlen;
-    memcpy(cvt.buf, newbuf, newlen);
-    free(newbuf);
-
-    SDL_ConvertAudio(&cvt);
-
-    Mix_Chunk *chunk = Mix_QuickLoad_RAW(cvt.buf, cvt.len_cvt);
-    chunk->allocated = 1;
-    return chunk;
-}
-
-
-/* ------------- Conversion and helper functions ------------- */
-
-/*! This function defines how to put soundset_key and eventname together to
-  create an eventkey. */
-
-string SoundEngine::effectKey(string effect_name, string soundset_name)
-{
-    if (soundset_name == "")
-        return getActiveSoundSetKey() + "#" + effect_name;
-    else
-        return soundset_name + "#" + effect_name;
-}
-
-/*! This function searches the known sound sets for a sound set with given
-  oxyd version, and returns the sound set name (or empty string if none). */
-
-string SoundEngine::getOxydSoundSet(OxydVersion oxyd_ver)
-{
-    for (SoundSetRepository::iterator i = sound_sets.begin();
-             i != sound_sets.end(); ++i)
-        if((*i).second.getOxydVersion() == oxyd_ver)
-            return (*i).first;
-    return "";
-}
-
-string sound::GetOxydSoundSet(OxydVersion oxyd_ver)
-{
-    return sound_engine->getOxydSoundSet(oxyd_ver);
-}
-
-/*! Enigma 1.00 only knew the option "SoundSet", which was an integer. This
-  was quite unhandy if one wanted to add additional sound sets. Since 1.01
-  Enigma features the option "SoundSetName". Still, old "SoundSet" is needed
-  if user wants to switch to <= 1.00 again; so here are the conversion
-  functions. Any user sound set is mapped to 0 ("Default").  */
-
-int SoundEngine::convertToOldSoundSetNumber(string soundset_name)
-{
-    if(soundset_name == "Default")  return 0;
-    if(soundset_name == "Enigma")   return 1;
-    SoundSet sd = sound_sets[soundset_name];
-    if(sd.isOxyd())
-        return ((int) sd.getOxydVersion()) + 2;
-    return 0;
-}
-
-string SoundEngine::convertFromOldSoundSetNumber(int soundset_number)
-{
-    if(soundset_number == 0)  return "Default";
-    if(soundset_number == 1)  return "Enigma";
-    return getOxydSoundSet((OxydVersion) (soundset_number - 2));
-}
-
-/* -------------------- Sound set handling -------------------- */
-
-/*! These functions fill in data for the sound sets, initialises and
-  activates them. Return false, if something went wrong, e.g. when an
-  oxyd sound set is mentioned, but the corresponding oxyd version
-  wasn't found. */
-
-bool SoundEngine::defineSoundSet(string soundset_name, string soundset_key,
-                                 int button_position)
-{
-    sound_sets[soundset_name] = SoundSet(soundset_key, button_position);
-    Log << "Added sound set '" << soundset_name << "' (key '" << soundset_key
-        << "') on position " << button_position << ".\n";
-    return true;
-}
-
-bool SoundEngine::defineSoundSetOxyd(string soundset_name, string soundset_key,
-                                     OxydVersion oxyd_ver, int button_position)
-{
-    if(oxyd::FoundOxyd(oxyd_ver)) {
-        sound_sets[soundset_name] =
-            SoundSet(soundset_key, button_position, (OxydVersion) oxyd_ver);
-        Log << "Added sound set '" << soundset_name << "' (key '" << soundset_key
-            << "') on position " << button_position << ".\n";
-        return true;
-    } else {
-        Log << "Skipped sound set '" << soundset_name << "'.\n";
-        return false;
-    }
-}
-
-bool SoundSet::activate()
-{
-    if(getSoundSetKey() == "")
-        return false;
-    if(isOxyd() &&  !oxyd::InitOxydSoundSet(getOxydVersion()))
-        return false;
-
-    sound_engine->setActiveSoundSetKey(getSoundSetKey());
-    return true;
-}
-
-void sound::InitSoundSets() {
-    sound_engine->initSoundSets();
-}
-
-void SoundEngine::initSoundSets()
-{
-    // Define sound sets
-    sound_sets.clear();
-    assert(sound_sets.empty());
-    assert(defineSoundSet ("Enigma",   "Enigma",  1));
-    int pos = 2; // position in options menu button
-    if (defineSoundSetOxyd ("Oxyd",     "Oxyd*",   OxydVersion_Oxyd1,          pos))  pos++;
-    if (defineSoundSetOxyd ("Magnum",   "Magnum*", OxydVersion_OxydMagnum,     pos))  pos++;
-    if (defineSoundSetOxyd ("Mag.Gold", "Magnum*", OxydVersion_OxydMagnumGold, pos))  pos++;
-    if (defineSoundSetOxyd ("Per.Oxyd", "Oxyd*",   OxydVersion_PerOxyd,        pos))  pos++;
-    if (defineSoundSetOxyd ("Extra",    "Oxyd*",   OxydVersion_OxydExtra,      pos))  pos++;
-    // Define user sound sets, as given by sound_effects
-    for (SoundEffectRepository::iterator i = sound_effects.begin();
-         i != sound_effects.end(); ++i) {
-        string soundset_key = (*i).second.getSoundSetKey();
-        bool found = false;
-        // ignore Oxyd* and Magnum* sound effects, if no 
-        if ((soundset_key != "Oxyd*") && (soundset_key != "Magnum*")) {
-            for (SoundSetRepository::iterator j = sound_sets.begin();
-                 j != sound_sets.end(); ++j)
-                if((*j).second.getSoundSetKey() == soundset_key)
-                    found = true;
-            if(!found)
-                if (defineSoundSet (soundset_key, soundset_key, pos))  pos++;
-        }
-    }
-    Log << "Found " << pos - 1 << " different sound sets.\n";
-    setSoundSetCount(pos - 1);
-    setDefaultSoundSet("Enigma");
-    // Extract sound set names and keys from options; activate!
-    string soundset_name = app.state->getString("SoundSetName");
-    if (soundset_name == "") { // just switched from 1.00 to higher
-        soundset_name = convertFromOldSoundSetNumber(options::GetInt("SoundSet"));
-        app.state->setProperty("SoundSetName", soundset_name);
-    }
-    if (soundset_name == "Default")
-        soundset_name = getDefaultSoundSet();
-    clear_cache();
-    if (sound_sets[soundset_name].activate())  {
-        preloadSoundEffects();
-        Log << "Activated sound set '" << soundset_name << "'.\n";
-    }
-    else {
-        // Fallback, happens e.g. when oxyd sound set can't be established or 
-        // a user soundset is given which doesn't exist anymore.
-        Log << "Warning: Soundset '" << soundset_name << "' not available.\n";
-        if (sound_sets["Enigma"].activate()) {
-            app.state->setProperty("SoundSetName", "Enigma");
-            options::SetOption("SoundSet", convertToOldSoundSetNumber("Enigma"));
-        } else
-            ASSERT(false, XFrontend,
-                "Soundsets defect and fallback 'Enigma' not available.");
-    }
-}
-
-void SoundEngine::setActiveSoundSet(string soundset_name)
-{
-    string soundset_key = sound_sets[soundset_name].getSoundSetKey();
-    if (soundset_key == getActiveSoundSetKey())
-        return;
-    if (soundset_key == "Default") {
-        Log << "Warning: Tried to choose 'Default' as effective sound set.\n";
-        return;
-    }
-    if (soundset_key == "") {
-        Log << "Warning: Tried to choose empty sound set key as effective sound set.\n";
-        return;
-    }
-    clear_cache();
-    if (sound_sets[soundset_name].activate()) {
-        preloadSoundEffects();
-        Log << "Switched to sound set '" << soundset_name << "' (key '" 
-            << soundset_key << "').\n";
-    } else
-        Log << "Warning: Problems loading sound set '" << soundset_name << "' (key'"
-            << soundset_key << "').\n";
-}
-
-/*! Pre-cache all sound effects so that they can be played without lag
-  when the game is running. */
-void SoundEngine::preloadSoundEffects()
-{
-    SoundEffectRepository::iterator i = sound_effects.begin(), 
-        end = sound_effects.end();
-    string prefix = getActiveSoundSetKey() + "#";
-    for (; i != end; ++i) {
-        if (i->first.compare(0, prefix.size(), prefix) == 0)
-            cache_sound(i->second);
-    }
-}
-
-void sound::SetActiveSoundSet(string soundset_name)
-{
-    sound_engine->setActiveSoundSet(soundset_name);
-}
-
-void sound::SetDefaultSoundSet(string soundset_name)
-{
-    sound_engine->setDefaultSoundSet(soundset_name);
-    if(app.state->getString("SoundSetName") == "Default")
-        SetActiveSoundSet(soundset_name);
-}
-
-string SoundEngine::getSoundSetByPosition(int button_position)
-{
-    for (SoundSetRepository::iterator i = sound_sets.begin();
-             i != sound_sets.end(); ++i)
-        if((*i).second.getButtonPosition() == button_position)
-            return (*i).first;
-    return "";
-}
-
-/* -------------------- Playing sound events -------------------- */
-
-/*! The first function creates an interface to add sound events to Enigma.
-  It is accessed via sound-defaults.lua and user sound definitions.
-  The second method is the interface between the formal SoundEffect
-  and the sound engine (via PlaySound[Global]). The last two functions
-  define the interface between level objects and SoundEffect. */
-
-void sound::DefineSoundEffect(string soundset_key, string name, string filename,
-                              double volume, bool loop, bool global, int priority,
-                              double damp_max, double damp_inc, double damp_mult,
-                              double damp_min, double damp_tick, string silence_string) {
-    assert(sound_engine.get());
-    if(soundset_key == "") {
-        Log << "Warning: Tried to define sound event '" << name
-            << "' without sound set key. Skipped.\n";
-        return;
-    }
-    sound_engine->defineSoundEffect(soundset_key, name,
-        SoundEffect(name, soundset_key, filename, volume, loop, global, priority,
-        damp_max, damp_inc, damp_mult, damp_min, damp_tick, silence_string));
-}
-
-bool SoundEffect::play(const ecl::V2 &pos, double vol, bool glob)
-{
-    if (filename == "") {
-        Log << "No soundfile given for sound event " << name << ".\n";
-        return false;
-    }
-    if (glob || global)
-        return PlaySoundGlobal (filename, volume * vol, priority);
-    else
-        return PlaySound (filename, pos, volume * vol, priority);
-}
-
-bool SoundEngine::emitSoundEvent (const std::string &eventname, const ecl::V2 &pos,
-                            double volume, bool force_global)
-{
-    string effectkey = effectKey(eventname);
-    SoundEffectRepository::iterator i = sound_effects.find(effectkey);
-    if (i == sound_effects.end()) {
-        Log << "Undefined sound event " << effectkey << " @ " 
-            << pos[0] << "," << pos[1] << "\n";
-        return false;
-    } else {
-        return i->second.play(pos, volume, force_global);
-    }
-}
-
-bool sound::EmitSoundEvent (const std::string &eventname, const ecl::V2 &pos,
-                            double volume, bool force_global)
-{
-    return sound_engine->emitSoundEvent(eventname, pos, volume, force_global);
-}
-
-bool sound::EmitSoundEventGlobal (const std::string &eventname, double volume)
-{
-    return sound_engine->emitSoundEvent(eventname, ecl::V2(), volume, true);
-}
-
-void SoundEngine::writeSilenceString (const std::string &eventname)
-{
-    string effectkey = effectKey(eventname);
-    SoundEffectRepository::iterator i = sound_effects.find(effectkey);
-    if (i != sound_effects.end()) {
-        string silence_string = (*i).second.getSilenceString();
-        if (silence_string != "")
-            client::Msg_ShowText (silence_string, true);
-    }
-}
-
-void sound::WriteSilenceString (const std::string &eventname)
-{
-    sound_engine->writeSilenceString(eventname);
-}
-
-/* -------------------- Sound damping implementation -------------------- */
-
-/*! These methods are connected to the sound damping mechanism, designed
-  to reduce the noise created by some objects like st-lightpassenger. */
-
-SoundDamping::SoundDamping(std::string effect_name_, const void *origin_)
-: effect_name(effect_name_), origin(origin_)
-{
-    damp = sound_engine->getDampingData(effect_name_);
-    factor = damp.incr;
-    //Log << "New damping entry " << effect_name << " with " << damp.incr << ".\n";
-}
-
-float SoundDamping::get_volume(float def_volume) {
-    if (factor < damp.maxi)
-        factor += damp.incr;
-    //Log << "  Found entry " << effect_name << ". Factor is now " << i->factor << ".\n";
-    float q = factor * damp.mult;
-    if (q > 1.0)
-        return def_volume / q;
-    return def_volume;
-}
-
-bool SoundDamping::tick() {
-    // return true, if this entity is to be destroyed.
-    factor *= damp.tick;
-    return (factor <= damp.mini);
-}
-
-/* -------------------- MusicSingle -------------------- */
-
-void sound::DefineMusicSingle(string title, string filename) {
-    // TODO: include play_till, replay_from, volume etc
-    assert(sound_engine.get());
-    if(filename == "") {
-        Log << "Warning: Tried to define music single '" << title
-            << "' without file name. Skipped.\n";
-        return;
-    }
-    sound_engine->defineMusicSingle(title, filename);
-}
-
-bool SoundEngine::defineMusicSingle(string title, string filename)
-{
-    music_singles[title] = MusicSingle(title, filename);
-    Log << "Added music single '" << title << "'.\n";
-    return true;
-}
-
-bool MusicSingle::start()
-{
-    start_time = SDL_GetTicks();
-    return PlayMusic(filename);
-}
-
-bool MusicSingle::maybeLoopBack()
-{
-    Uint32 current_ticks = SDL_GetTicks();
-    if(allows_loop) {
-        if(current_ticks >= start_time + loop_end) {
-            Uint32 position = loop_start + current_ticks - start_time - loop_end;
-            start_time = current_ticks - position;
-            StopMusic();
-            return PlayMusic(filename, position/1000.0);
-        } else
-            return false;
-    } else
-        return false;
-}
-
-bool SoundEngine::playMusicSingle(string title)
-{
-    return ((sound_engine->music_singles)[title]).start();
-}
-
-/* -------------------- Music Queue -------------------- */
-
-string MusicQueue::getCurrentMusicTitle()
-{
-    if(current_position_in_queue == -1)
-        return "";
-    else
-        return single_title[current_position_in_queue];
-}
-
-void MusicQueue::appendSingle(string title)
-{
-    single_title.push_back(title);
-}
-
-bool MusicQueue::start()
-{
-    if(single_title.size() > 0) {
-        current_position_in_queue = 0;
-        return sound_engine->playMusicSingle(single_title[0]);
-    } else
-        return false;
-}
-
-bool MusicQueue::next()
-{
-    if(current_position_in_queue == -1)
-        // Queue did not start yet. Request first title instead.
-        return start();
-    else {
-        // TODO: Add random
-        current_position_in_queue++;
-        if(current_position_in_queue >= single_title.size())
-            current_position_in_queue = 0;
-        Log << "Play next in queue " << title << ".\n";
-        return sound_engine->playMusicSingle(single_title[current_position_in_queue]);
-    }
-}
-
-bool SoundEngine::setActiveMusicQueue(string music_queue_title)
-{
-    if (music_queue_title == "") {
-        Log << "Warning: Tried to choose empty music queue title as menu music queue.\n";
-        return false;
-    }
-    if (music_queue_title == getActiveMusicQueueTitle()) {
-        // Current queue is aready running.
-        return true;
-    }
-    sound::FadeoutMusic();
-    if (music_queues[music_queue_title].start()) {
-        active_music_queue = music_queue_title;
-        Log << "Switched to menu music queue '" << music_queue_title << "'.\n";
-        return true;
-    } else {
-        Log << "Warning: Problems loading menu music queue '" << music_queue_title << "'.\n";
-        return false;
-    }
-}
-
-string SoundEngine::getMusicQueueByPosition(int button_position)
-{
-    for (MusicQueueRepository::iterator i = music_queues.begin();
-             i != music_queues.end(); ++i)
-        if((*i).second.getButtonPosition() == button_position)
-            return (*i).first;
-    return "";
-}
-
-int SoundEngine::getMenuMusicQueueCount()
-{
-    int count = 0;
-    for (MusicQueueRepository::iterator i = music_queues.begin();
-             i != music_queues.end(); ++i)
-        if((*i).second.getButtonPosition() != -1)
-            count++;
-    return count;
-}
-
-/* -------------------- Sound option helpers -------------------- */
-
-/*! These functions are used in OptionsMenu.cc for the Soundset-Button. */
-
-int sound::GetOptionSoundSetCount()
-{        
-    return sound_engine->getSoundSetCount() + 1;
-}
-
-int sound::GetOptionSoundSet()
-{
-    string soundSet = app.state->getString("SoundSetName");
-    if (soundSet == "Default")
-        return 0;
-    int pos = sound_engine->getSoundSetButtonPosition(soundSet);
-    assert(pos > 0);
-    return pos;
-}
-
-void sound::SetOptionSoundSet(int value)
-{
-    if(value == 0) {
-        // settting to default sound set
-        if (app.state->getString("SoundSetName") == "Default")
-            return;
-        app.state->setProperty("SoundSetName", "Default");
-        options::SetOption("SoundSet", sound_engine->convertToOldSoundSetNumber("Default"));
-        SetActiveSoundSet(sound_engine->getDefaultSoundSet());
-    } else {
-        string newSet = sound_engine->getSoundSetByPosition(value);
-        assert(newSet != "");
-        if (app.state->getString("SoundSetName") == newSet)
-            return;
-        app.state->setProperty("SoundSetName", newSet);
-        options::SetOption("SoundSet", sound_engine->convertToOldSoundSetNumber(newSet));
-        SetActiveSoundSet(newSet);
-    }
-}
-
-string sound::GetOptionSoundSetText(int value)
-{
-    if(value == 0)
-        return N_("Default");
-    string soundset_name = sound_engine->getSoundSetByPosition(value);
-    if(soundset_name == "")
-        return "INVALID";
-    return soundset_name;
-}
-
-/*! These functions are used in OptionsMenu.cc for the MenuMusicButton. */
-
-int sound::GetOptionMenuMusicCount()
-{        
-    return sound_engine->getMenuMusicQueueCount();
-}
-
-int sound::GetOptionMenuMusic()
-{
-    string music_queue = app.state->getString("MenuMusicQueue");
-    int pos = sound_engine->getMusicQueueButtonPosition(music_queue);
-    assert(pos >= 0);
-    return pos;
-}
-
-void sound::SetOptionMenuMusic(int value)
-{
-    string music_queue = sound_engine->getMusicQueueByPosition(value);
-    Log << "Try to set mmq '" << music_queue << "' from position " << value << ".\n";
-    app.state->setProperty("MenuMusicQueue", music_queue);
-    sound_engine->setActiveMusicQueue(music_queue);
-}
-
-string sound::GetOptionMenuMusicText(int value)
-{
-    return sound_engine->getMusicQueueByPosition(value);
-}
-

Deleted: trunk/src/sound.hh
===================================================================
--- trunk/src/sound.hh	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/sound.hh	2008-04-18 22:45:50 UTC (rev 1104)
@@ -1,251 +0,0 @@
-/*
- * Copyright (C) 2002,2003,2004 Daniel Heck
- * Copyright (C) 2007 Andreas Lochmann
- *
- * This program is free software; you can redistribute it and/or
- * modify it under the terms of the GNU General Public License
- * as published by the Free Software Foundation; either version 2
- * of the License, or (at your option) any later version.
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- * GNU General Public License for more details.
- *
- * You should have received a copy of the GNU General Public License along
- * with this program; if not, write to the Free Software Foundation, Inc.,
- * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
- *
- */
-#ifndef SOUND_HH
-#define SOUND_HH
-
-#include "ecl_math.hh"
-#include "oxydlib/OxydVersion.h"
-
-#include <string>
-#include <vector>
-
-/** ----------- Survey of the formal data structure -----------
- *
- *  The wav-files are not to be accessed directly. There are several layers
- *  between the wav-data and the final EmitSoundEvent-function, to allow for the
- *  following uses:
- *    (a) Sound Sets, possibly user defined,
- *    (b) Access to oxyd's sound data,
- *    (c) Sound damping for loud objects with user defined data,
- *    (d) A "Default" mode which switches the sound set between level packs.
- *    (e) A "silence string" that can be written instead of playing the sound.
- *  For this, six layers of sound information exist.
- *  Note: A sound effect is given by a wav-file and several data how to play it.
- *        An object may choose a sound effect to play. Then it becomes a sound
- *        event (= sound effect + position etc.).
- *
- *    (1) SoundEngine
- *         -> Providing global information and methods for using SDL.
- *    (2) SoundData
- *         -> Holding technical details about how to play the wav-files.
- *    (3) SoundEffect
- *         -> Holding game-related information about how to play a sound
- *            effect. This includes the effect's filename, default volume,
- *            if it's looped, if it's played on a global scale by default,
- *            the default damping information for this event, etc.
- *    (4) SoundSet
- *         -> Holding the sound set key of a sound set (see below), and if
- *            it is connected to Oxyd. It also provides methods to
- *            activate a sound set.
- *    (5) SoundEvent
- *         -> A struct to hold information about a sound event, like the
- *            effect's name, position, priority, volume etc.
- *    (6) SoundDamping
- *         -> Each time an object makes noise, a SoundDamping-record
- *            is created with an entry of the objects address (as void *).
- *            This class modulates the volume with which the next effect
- *            connected to this object is played.
- *
- *  Sound events are normally invoked by "EmitSoundEvent(EFFECTNAME, ...)".
- *  EFFECTNAME can then be e.g. "pickup" or "laseron". This effect name does not
- *  yet define the sound effect completely. Instead, the actually activated sound
- *  set is looked up. It holds a string called sound set key (e.g. "Enigma" or
- *  "Oxyd*"), and together with the effect name they form the effect key, here
- *  "Enigma#pickup" or "Oxyd*#laseron". This effect key is looked up in the sound
- *  effect repository and results in a SoundEffect-entry, which is then played.
- *
- */
-
-/** -------------- About the sound damping system --------------
- *
- *  The sound damping is not automatically used. Instead, it is called through
- *  the "World::getVolume"-function:
- *    sound::EmitSoundEvent (NAME, POS, getVolume(NAME, OBJECT_CALLING, DEF_VOLUME))
- *  OBJECT_CALLING need not be a real address, it is never dereferenced. It just
- *  holds as a representative of the calling object. The SoundDamping-records
- *  are evaluated and finally erased by World::tick_sound_dampings. 
- *
- *  The values used in the sound damping systes can be user defined. In the
- *  following, we use the defaults:
- *
- *  tick_sound_dampings is only to be evaluated every 10th tick (0.1s).
- *  Each damping factor (the ivar connected to the noisy object and its sound
- *  effect name) is reduced by 0.9. This is less than the 10th root of 0.5 (0.933),
- *  so after 1s the damping factor is reduced by more than one half. If the factor
- *  shrinks under 0.5, it is considered 0.
- *
- *  Examples:
- *    1) Frequency less than one sound event per 0.6 seconds.
- *       Then there is no damping at all.
- *    2) N events per second. For each event, factor (F) is raised by
- *       one. And each 0.1 seconds it is multiplied with 0.9. We now
- *       have N/10 events per 0.1 seconds, hence in equilibrium f
- *       oscillates between
- *            f = (f + N/10) * 0.9   =>   f = N
- *       and  f + N/10 = N * 1.1 (geometric series!).
- *  In particular, for large enough N, f is approximately proportional
- *  to N with half-life of less than a second. This is then evaluated
- *  in getVolume.
- * 
- *  World::getVolume returns the volume, if object OBJECT_CALLING wants
- *  to play sound effect NAME with default volume DEF_VOLUME. Often played
- *  sounds from always the same object are damped to reduce noise-level.
- *  Note that OBJECT_CALLING == NULL is explicitly allowed and used e.g.
- *  for all laser-sounds. The damping factor is increased by 1.0 for each
- *  event, and multiplied with 0.9 each 0.1 seconds, thereby approximately
- *  equals the average number of events per second.
- *
- */
-
-/** -------------- Compatibility with 1.00 --------------
- *
- *  Enigma 1.01 uses a new option "SoundSetName", which replaces "SoundSet".
- *  To enable Enigma 1.00 to run on the same system, the "SoundSet" variable
- *  still exists. It is set to 0 (= "Default") for all user sound sets:
- *  When exiting 1.01 with a user sound set and starting 1.00, the default
- *  sound set will be activated for 1.00. Yet, as "SoundSetName" still shows
- *  the old value, 1.01 will use it to find its user sound set. Even if
- *  you change the sound set in 1.00, this will have no effect on the
- *  chosen sound set for 1.01. In contrast to this, if you change the 1.01
- *  sound set, the 1.00 "SoundSet"-variable will be adapted. Except for this
- *  "restriction", you can use two different sound sets for 1.00 and 1.01.
- *
- */
-
-namespace sound
-{
-/* -------------------- Data types -------------------- */
-
-    typedef std::string SoundName;
-
-    typedef std::vector <unsigned char> ByteVec;
-
-    struct SoundData {
-        ByteVec  buf;
-        unsigned freq;
-        size_t   samplesize;
-        bool     signedp;
-        int      nchannels;
-    };
-
-/* -------------------- SoundDampingList ---------------- */
-
-/*! This class stores object addresses and assigns volumes to
-    sound events, based on the frequency of the event. */
-
-    struct DampingData {
-        double incr;
-        double maxi;
-        double mult;
-        double mini;
-        double tick;
-    };
-
-    class SoundDamping {
-    private:
-        std::string effect_name;
-        const void *origin;
-        float factor;
-        DampingData damp;
-
-    public:
-        SoundDamping(std::string effect_name_, const void *origin_);
-        bool is_equal(std::string name2, const void *origin2) {
-            return (origin2 == origin) && (effect_name == name2);
-        }
-        float get_volume(float def_volume);
-        bool tick();  // returns true if this entry should be erased
-    };
-
-/* -------------------- Functions -------------------- */
-
-    void Init();
-    void Shutdown();
-
-    void Tick (double dtime);
-
-    void DisableSound();
-    void EnableSound();
-    void DisableMusic();
-
-    void TempDisableSound();
-    void TempReEnableSound();
-
-    void SetListenerPosition (const ecl::V2 &pos);
-    bool PlaySound (const SoundName &, const ecl::V2 &pos,
-                    double relative_volume = 1.0, int priority=0);
-    bool PlaySoundGlobal (const SoundName &, double relative_volume = 1.0, int priority=0);
-
-    bool PlayMusic (const std::string &name, double position = 0.0);
-    void FadeoutMusic();
-
-    /*! Stop any music currently playing. */
-    void StopMusic();
-
-    /*! Stop music only if it has the specified name, otherwise
-      continue playing. */
-    void StopMusic (const std::string &name);
-
-    void DefineMusicSingle(std::string title, std::string filename);
-    bool StartMenuMusic();
-    bool StartLevelMusic();
-    void MusicTick(double dtime);
-    void InitMusic();
-    
-    void ClearCache();
-    void DefineSound (const SoundName &, const SoundData &);
-    void SetSoundVolume (double vol);
-    void SetMusicVolume (double vol);
-
-    /*! Helper function for oxyd.cc */
-    std::string GetOxydSoundSet(OxydLib::OxydVersion oxyd_ver);
-
-    /*! Sound set handling */
-    void InitSoundSets();
-    void SetActiveSoundSet(std::string soundset_name);
-    void SetDefaultSoundSet(std::string soundset_name);
-
-    /*! Define a new sound event. */
-    void DefineSoundEffect(std::string soundset_key, std::string name, std::string filename,
-                           double volume, bool loop, bool global, int priority,
-                           double damp_max, double damp_inc, double damp_mult,
-                           double damp_min, double damp_tick, std::string silence_string);
-
-    /*! Trigger a sound event.  Return whether the event was handled. */
-    bool EmitSoundEvent (const std::string &eventname,
-                         const ecl::V2 &pos = ecl::V2 (), 
-                         double volume = 1.0, bool force_global = false);
-    bool EmitSoundEventGlobal (const std::string &eventname, double volume = 1.0);
-
-    /*! Send the silence string of a sound effect to command line. */
-    void WriteSilenceString (const std::string &eventname);
-
-    /*! Helper functions for options menu */
-    int GetOptionSoundSetCount();
-    int GetOptionSoundSet();
-    void SetOptionSoundSet(int value);
-    std::string GetOptionSoundSetText(int value);
-    int GetOptionMenuMusicCount();
-    int GetOptionMenuMusic();
-    void SetOptionMenuMusic(int value);
-    std::string GetOptionMenuMusicText(int value);
-}
-
-#endif

Deleted: trunk/src/sound_internal.hh
===================================================================
--- trunk/src/sound_internal.hh	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/sound_internal.hh	2008-04-18 22:45:50 UTC (rev 1104)
@@ -1,335 +0,0 @@
-namespace
-{
-
-/* -------------------- SoundEvent -------------------- */
-
-    struct SoundEvent {
-        // Variables
-        SoundName name;
-        bool      has_position;
-        ecl::V2   position;
-        int       priority;
-        double    volume;           // Volume between 0.0 and 1.0
-        int       left;
-        int       right;
-
-        // Variables used internally by sound engine
-        bool      active;
-        double    playing_time;
-
-        // Constructor
-        SoundEvent ();
-    };
-
-/* -------------------- SoundEffect and SoundEffectRepository ---------------- */
-
-/*! This class stores information about how to play sound events
-    and provides methods to play them. */
-
-    class SoundEffect {
-    public:
-        SoundEffect(string name_, string soundset_key_, string filename_,
-                       double volume_, bool loop_, bool global_, int priority_,
-                       double damp_max_, double damp_inc_, double damp_mult_,
-                       double damp_min_, double damp_tick_, string silence_string_)
-        : name(name_), soundset_key(soundset_key_), filename(filename_), volume(volume_),
-          loop(loop_), global(global_), priority(priority_),
-          silence_string(silence_string_) {
-            damp.maxi = damp_max_;
-            damp.incr = damp_inc_;
-            damp.mult = damp_mult_;
-            damp.mini = damp_min_;
-            damp.tick = damp_tick_;
-        }
-
-        SoundEffect()  // standard empty data set, compare sound-defaults.lua
-        : name("EMPTY_EVENT"), filename(""), soundset_key(""), volume(1.0),
-          loop(false), global(false), priority(1), silence_string("") {
-            damp.maxi = 20.0;
-            damp.incr =  1.0;
-            damp.mult =  1.0;
-            damp.mini =  0.5;
-            damp.tick =  0.9;
-        }
-
-        void setFilename(string filename_) { filename = filename_; }
-        string getFilename() const { return filename; }
-        bool play(const ecl::V2 &pos = ecl::V2(), double vol = 1.0, bool glob = false);
-        DampingData getDampingData() { return damp; }
-        string getSoundSetKey() { return soundset_key; }
-        string getSilenceString() { return silence_string; }
-
-    private:
-        string name;
-        string filename;
-        string soundset_key;
-        string silence_string;
-        double volume;
-        bool loop;
-        bool global;
-        int priority;
-        DampingData damp;
-    };
-
-    class SoundSet {
-    public:
-        SoundSet(string soundset_key_, int button_position_, OxydLib::OxydVersion oxyd_ver_)
-        : soundset_key(soundset_key_), is_oxyd(true), oxyd_ver(oxyd_ver_),
-          button_position(button_position_) {}
-
-        SoundSet(string soundset_key_, int button_position_)
-        : soundset_key(soundset_key_), is_oxyd(false),
-          oxyd_ver(OxydLib::OxydVersion_Invalid), button_position(button_position_) {}
-
-        SoundSet()
-        : soundset_key(""), is_oxyd(false),
-          oxyd_ver(OxydLib::OxydVersion_Invalid), button_position(-1) {}
-
-        bool activate();
-        OxydLib::OxydVersion getOxydVersion() { return oxyd_ver; }
-        bool isOxyd() { return is_oxyd; }
-        string getSoundSetKey() { return soundset_key; }
-        int getButtonPosition() { return button_position; }
-        void setButtonPosition(int pos) { button_position = pos; }
-
-    private:
-        string soundset_key;
-        bool is_oxyd;
-        OxydLib::OxydVersion oxyd_ver;
-        int button_position;
-    };
-    
-    typedef map<string, SoundEffect> SoundEffectRepository;
-    typedef map<string, SoundSet> SoundSetRepository;
-
-/* -------------------- Music and MusicQueue -------------------- */
-
-/*! The class "MusicSingle" holds filename and default playing information
-    for a single music file. Several music files can be combined into
-    a "MusicQueue" to play in a given or random sequence. MusicQueues are
-    used for menu music. One MusicQueue corresponds to one choice on the
-    option menu's button. */
-
-    class MusicSingle {
-    public:
-        MusicSingle(string title_, string filename_, Uint32 length_,
-                    Uint32 loop_start_, Uint32 loop_end_, bool allows_loop_)
-        : title(title_), filename(filename_), length(length_),
-          loop_start(loop_start_), loop_end(loop_end_),
-          allows_loop(allows_loop_), start_time() {}
-
-        MusicSingle(string title_, string filename_)
-        : title(title_), filename(filename_), length(0),
-          loop_start(0), loop_end(0), allows_loop(false), start_time() {}
-
-        MusicSingle()
-        : title(""), filename(""), length(0), loop_start(0), loop_end(0),
-          allows_loop(false) {}
-
-        bool start();
-        bool maybeLoopBack();
-
-    private:
-        string title;
-        string filename;
-        Uint32 length;      // in milliseconds
-        Uint32 loop_start;  // where the loop starts
-        Uint32 loop_end;    // where the loop should end (but continues playing until next tick)
-        Uint32 start_time;  // number of milliseconds since SDL init
-        bool allows_loop;
-    };
-
-    class MusicQueue {
-    public:
-        MusicQueue(string title_, int button_position_)
-        : title(title_), button_position(button_position_),
-          current_position_in_queue(-1), single_title() {}
-
-        MusicQueue()
-        : title(""), button_position(-1),
-          current_position_in_queue(-1), single_title() {}
-
-        bool start();
-        bool next();
-        string getCurrentMusicTitle();
-        int getButtonPosition() { return button_position; }
-        void setButtonPosition(int pos) { button_position = pos; }
-        void appendSingle(string title);
-
-    private:
-        int current_position_in_queue;
-        string title;
-        int button_position;
-        vector<string> single_title;
-    };
-
-    typedef map<string, MusicSingle> MusicSingleRepository;
-    typedef map<string, MusicQueue> MusicQueueRepository;
-
-    /*! MusicContext is a nominal condition to change the
-      music during the next tick.
-      NONE: during initialisation (don't play music now),
-      MENU/GAME: play music suitable for menu or during game. */
-    enum MusicContext { MUSIC_NONE, MUSIC_MENU, MUSIC_GAME };
-
-        
-/* -------------------- SoundEngine -------------------- */
-
-    class SoundEngine {
-    public:
-        SoundEngine();
-        virtual ~SoundEngine() {}
-        
-        //! Returns true if successful.
-        virtual bool init() = 0;
-        virtual void shutdown() = 0;
-        virtual bool is_initialized() const = 0;
-
-        virtual void set_sound_volume (double soundvol) = 0;
-        virtual void set_music_volume (double musicvol) = 0;
-
-        // ---------- Music and music repository ----------
-
-        virtual bool play_music(const std::string &filename, double position) = 0;
-        virtual void stop_music() = 0;
-        virtual void fadeout_music() = 0;
-        void setMusicContext(MusicContext context) { music_context = context; }
-        MusicContext getMusicContext() { return music_context; }
-        bool defineMusicSingle(string title, string filename);
-        bool playMusicSingle(string title);
-        bool setActiveMusicQueue(string music_queue_title);
-        string getActiveMusicQueueTitle() { return active_music_queue; }
-        void music_tick(double dtime);
-        void init_music();
-        string getMusicQueueByPosition(int button_position);
-        int getMenuMusicQueueCount();
-        int getMusicQueueButtonPosition(string music_queue_title) {
-            return music_queues[music_queue_title].getButtonPosition();
-        }
-        
-        // ---------- Sound effects ----------
-
-        virtual void clear_cache() = 0;
-        virtual void define_sound(const SoundName &, const SoundData &)=0;
-        virtual bool play_sound(const SoundEvent &s) = 0;
-        virtual void cache_sound(const SoundEffect &s) = 0;
-        virtual void set_listenerpos(ecl::V2 pos) = 0;
-        virtual void tick(double dtime) {}
-
-        // ---------- Sound effect repository and sound sets ----------
-
-        void setActiveSoundSetKey(string soundset_key) {active_sound_set_key=soundset_key;}
-        string getActiveSoundSetKey() { return active_sound_set_key; }
-        void setDefaultSoundSet(string soundset_name) {default_sound_set=soundset_name;}
-        string getDefaultSoundSet() { return default_sound_set; }
-        string effectKey(string effect_name, string soundset_name = "");
-        DampingData getDampingData(string effect_name) {
-            return sound_effects[effectKey(effect_name)].getDampingData(); }
-        void defineSoundEffect(string soundset_key, string name, SoundEffect se) {
-            sound_effects[effectKey(name, soundset_key)] = se;
-        }
-        bool emitSoundEvent (const std::string &eventname, const ecl::V2 &pos = ecl::V2 (), 
-                             double volume = 1.0, bool force_global = false);
-        void writeSilenceString (const std::string &eventname);
-        void initSoundSets();
-        bool defineSoundSet(string soundset_name, string soundset_key, int button_position);
-        bool defineSoundSetOxyd(string soundset_name, string soundset_key,
-                                OxydLib::OxydVersion oxyd_ver, int button_position);
-        string getOxydSoundSet(OxydLib::OxydVersion oxyd_ver);
-
-        int convertToOldSoundSetNumber(string soundset_name);
-        string convertFromOldSoundSetNumber(int soundset_number);
-
-        void setActiveSoundSet(string soundset_name);
-        void preloadSoundEffects();
-
-        void setSoundSetCount(int count) { sound_set_count = count; }
-        int getSoundSetCount() { return sound_set_count; }
-        
-        int getSoundSetButtonPosition(string soundset_name) {
-            return sound_sets[soundset_name].getButtonPosition();
-        }
-        string getSoundSetByPosition(int button_position);
-
-    private:
-        SoundSetRepository       sound_sets;
-        SoundEffectRepository    sound_effects;
-        string                   active_sound_set_key;
-        string                   default_sound_set;
-        int                      sound_set_count;
-        MusicSingleRepository    music_singles;
-        MusicQueueRepository     music_queues;
-        string                   active_music_queue;
-        MusicContext             music_context;
-    };
-
-    class SoundEngine_Null : public SoundEngine {
-    public:
-
-        // SoundEngine interface
-        bool init() { return true; }
-        void shutdown() {}
-        void clear_cache() {}
-        bool is_initialized() const { return true; }
-        void set_sound_volume(double /*soundvol*/) {}
-        void set_music_volume(double /*musicvol*/) {}
-        bool play_music (const std::string &/*filename*/, double /*position*/) { return false; }
-        void stop_music() {}
-        void fadeout_music() {}
-
-        bool play_sound (const SoundEvent &) {}
-        void cache_sound(const SoundEffect &s) {}
-        void define_sound (const SoundName &, const SoundData &) {}
-        void set_listenerpos (ecl::V2 pos) {}
-    };
-
-    class SoundEngine_SDL : public SoundEngine {
-    public:
-        SoundEngine_SDL();
-        ~SoundEngine_SDL();
-
-        // ---------- SoundEngine interface ----------
-        bool init();        
-        void shutdown();
-
-        bool is_initialized() const { return m_initialized; }
-        void set_sound_volume(double soundvol);
-        void set_music_volume(double musicvol);
-
-        bool play_music (const std::string &filename, double position);
-        void stop_music();
-        void fadeout_music();
-
-        bool play_sound(const SoundEvent &s);
-        void cache_sound(const SoundEffect &s);
-        void clear_cache();
-        void define_sound (const SoundName &, const SoundData &);
-
-        void set_listenerpos (ecl::V2 pos) { m_listenerpos = pos; }
-        void tick (double dtime);
-    private:
-        // ---------- Private methods ----------
-        Mix_Chunk *cache_sound(const std::string &name);
-
-        void update_channel (int channel);
-        int already_playing (const SoundEvent &s);
-
-
-        static void channel_finished (int channel);
-
-
-        // ---------- Variables ----------
-        bool       m_initialized;
-        int        m_soundvolume;
-        int        m_musicvolume;
-        Mix_Music *m_current_music;
-        int        m_freq;
-        Uint16     m_format;
-        int        m_channels;
-        ecl::Dict<Mix_Chunk*> wav_cache;
-        vector<SoundEvent> m_channelinfo;
-        ecl::V2      m_listenerpos;
-        SDL_mutex  *m_mutex;
-        static SoundEngine_SDL *m_instance;
-    };
-}

Modified: trunk/src/stones_complex.cc
===================================================================
--- trunk/src/stones_complex.cc	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/stones_complex.cc	2008-04-18 22:45:50 UTC (rev 1104)
@@ -20,7 +20,7 @@
 
 #include "errors.hh"
 #include "laser.hh"
-#include "sound.hh"
+#include "SoundEffectManager.hh"
 #include "server.hh"
 #include "player.hh"
 #include "Inventory.hh"

Modified: trunk/src/world.cc
===================================================================
--- trunk/src/world.cc	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/world.cc	2008-04-18 22:45:50 UTC (rev 1104)
@@ -20,7 +20,7 @@
 #include "errors.hh"
 #include "laser.hh"
 #include "player.hh"
-#include "sound.hh"
+#include "SoundEffectManager.hh"
 #include "options.hh"
 #include "server.hh"
 #include "lua.hh"
@@ -1493,7 +1493,7 @@
 
 void World::tick_sound_dampings ()
 {
-    // See sound.hh and sound.cc for details.
+    // See SoundEffectManager.hh for details.
     static int counter = 0;
     ++counter;
 
@@ -2302,7 +2302,7 @@
 
 float getVolume(const char *name, Object *obj, float def_volume)
 {
-    // See sound.hh and sound.cc for details.
+    // See SoundEffectManager.hh for details.
     SoundDampingList::iterator i = level->sound_dampings.begin(),
         end = level->sound_dampings.end();
     while (i != end) {

Modified: trunk/src/world_internal.hh
===================================================================
--- trunk/src/world_internal.hh	2008-04-16 22:06:28 UTC (rev 1103)
+++ trunk/src/world_internal.hh	2008-04-18 22:45:50 UTC (rev 1104)
@@ -350,7 +350,7 @@
         ImpulseList          delayed_impulses;
         vector<GridPos>      changed_stones;
 
-        SoundDampingList     sound_dampings; // see sound.hh for details
+        SoundDampingList     sound_dampings; // see SoundEffectManager for details
 
         FloorLayer      fl_layer;
         ItemLayer       it_layer;



From andreasl at mail.berlios.de  Sat Apr 19 23:56:12 2008
From: andreasl at mail.berlios.de (andreasl at BerliOS)
Date: Sat, 19 Apr 2008 23:56:12 +0200
Subject: [Enigma-game-svn] r1105 - in homepage: images input
Message-ID: <200804192156.m3JLuCoF012466@sheep.berlios.de>

Author: andreasl
Date: 2008-04-19 23:56:11 +0200 (Sat, 19 Apr 2008)
New Revision: 1105

Added:
   homepage/input/hp_archive.html
   homepage/input/hp_archive_de.html
   homepage/input/top_news.html
   homepage/input/top_news_de.html
Modified:
   homepage/images/menu_bg.jpg
   homepage/input/faq_core.html
   homepage/input/faq_core_de.html
   homepage/input/faq_questions.html
   homepage/input/faq_questions_de.html
   homepage/input/menu.html
   homepage/input/menu_de.html
   homepage/input/menu_ru.html
   homepage/input/output-files.lua
Log:
Homepage:
 - Added "Homepage Archive"
    - special articles (currently two and a half)
    - collected top news
 - A new FAQ (Enigma and sound under Linux)
 - Improved background image
Todo:
 - Russian translation:
     hp_archive, top_news, menu_ru, faq_core, faq_questions,
     output_files (entry "hp_archive")
 - Validation


Modified: homepage/images/menu_bg.jpg
===================================================================
(Binary files differ)

Modified: homepage/input/faq_core.html
===================================================================
--- homepage/input/faq_core.html	2008-04-18 22:45:50 UTC (rev 1104)
+++ homepage/input/faq_core.html	2008-04-19 21:56:11 UTC (rev 1105)
@@ -166,6 +166,15 @@
 </p>
 
 
+<h4><a name="s2q10">I use Linux. While playing Enigma, xmms (or any other music
+player) doesn't work, or Enigma doesn't have sound.</a></h4>
+<p>
+Your music player should use ALSA instead of OSS. In case of xmms: Right-click,
+&quot;Options&quot;, &quot;Preferences&quot;, &quot;Audio I/O Plugins&quot;,
+&quot;Output Plugin&quot;: Choose ALSA, if possible.
+</p>
+
+
 <h4><a name="s2q4">When I enter a level pack, it takes so long to load the images?</a></h4>
 <p>This happens only the first time you start Enigma, and only
 if no thumbnails had been downloaded with Enigma. It's normal

Modified: homepage/input/faq_core_de.html
===================================================================
--- homepage/input/faq_core_de.html	2008-04-18 22:45:50 UTC (rev 1104)
+++ homepage/input/faq_core_de.html	2008-04-19 21:56:11 UTC (rev 1105)
@@ -40,7 +40,7 @@
 
 <h4><a name="s1q3">Wie mache ich ein Update f&uuml;r Enigma?</a></h4>
 <p>Im Grunde gibt es drei Arten von Updates: Die Weltrekordliste
-(bzw. Spielergebnisse oder Statistiken), die Level und das Programm.</p>
+(bzw. Spielergebnisse oder Statistiken), die Levels und das Programm.</p>
 <ul>
 <li>
 Enigma erneuert seine Statistiken automatisch, falls Sie im Optionsmen&uuml; die
@@ -96,7 +96,7 @@
 </p><p>
 Beachten Sie bitte, dass der Level fehlerhaft sein kann. Falls dem so ist,
 wird sich Enigma beim Programmstart dar&uuml;ber beschweren. In diesem Fall kann es
-sinnvoll sein, die Level aus dem &quot;levels/auto&quot;-Verzeichnis wieder zu
+sinnvoll sein, den Level aus dem &quot;levels/auto&quot;-Verzeichnis wieder zu
 entfernen.</p>
 
 
@@ -183,6 +183,17 @@
 </p>
 
 
+<h4><a name="s2q10">Ich benutze Linux. W&auml;hrend ich Enigma spiele,
+funktioniert xmms (oder irgend ein anderer Musicplayer) nicht, oder
+Enigma hat keinen Sound.</a></h4>
+<p>
+Ihr Musicplayer sollte ALSA anstelle von OSS benutzen. Im Falle von xmms:
+Rechts-Klick, &quot;Optionen&quot;, &quot;Einstellungen&quot;,
+&quot;Audio-I/O-Plugins&quot;, &quot;Ausgabe-Plugin&quot;: W&auml;hlen Sie
+ALSA, wenn m&ouml;glich.
+</p>
+
+
 <h4><a name="s2q4">Wenn ich ein Levelpaket &ouml;ffne, dauert es so lange, bis die Bilder geladen
 sind?</a></h4>
 <p>Das geschieht nur zu Beginn, und auch nur, wenn Sie keine Vorschaubilder
@@ -271,7 +282,7 @@
 einige Zeit diese Level gespielt haben, sollten Sie am besten mit dem
 Levelpack &quot;Enigma I&quot; beginnen und sich dann langsam durch die
 Levelpacks spielen. Nat&uuml;rlich k&ouml;nnen Sie auch mit einem anderen Levelpack
-anfangen, aber die Level sind so geordnet, dass nicht zu viele neue
+anfangen, aber die Levels sind so geordnet, dass nicht zu viele neue
 Spielobjekte auf einmal eingef&uuml;hrt werden.</p>
 
 
@@ -368,7 +379,7 @@
 entfernen Sie die Datei &quot;enigma.score&quot;. Sie wollen dann vielleicht
 auch Ihre 0.92-Ergebnisse l&ouml;schen oder umbenennen (&quot;enigmarc.lua2&quot;).
 Bitte bedenken Sie, dass mit dem L&ouml;schen der Datei &quot;enigma.score&quot;
-auch alle Ihre pers&ouml;nlichen Bewertungen von Levlen verloren gehen!</p>
+auch alle Ihre pers&ouml;nlichen Bewertungen von Leveln verloren gehen!</p>
 
 
 <h4><a name="s3q9">Ich habe einen Level gesehen und m&ouml;chte ihn nochmal spielen; aber ich habe
@@ -399,7 +410,7 @@
 
 <h4><a name="s3q11">Darf ich auch Spielergebnisse einsenden, die mit Version 0.92 erreicht
 wurden?</a></h4>
-<p>Ja. Alle Ergebnisse, die inkompatibel zur 1.00-Version der Levels sind
+<p>Ja. Alle Ergebnisse, die inkompatibel zur 1.00-Version der Levels sind,
 werden nicht in der Statistik ber&uuml;cksichtigt. Sie werden ein kleines rotes
 Dreieck bei solchen Levels im Levelmen&uuml; bemerken. Wenn Sie diese Level mit
 1.00 l&ouml;sen, werden Ihre neuen Ergebnisse das n&auml;chste Mal registriert.</p>
@@ -414,8 +425,8 @@
 Ihnen vielleicht Tipps.</p>
 
 
-<h4><a name="s3q13">Ich hatte einen Weltrekord f&uuml;r eine Level. Nach einem Neustart von Enigma
-ist er verschwunden!</a></h4>
+<h4><a name="s3q13">Ich hatte einen Weltrekord f&uuml;r einen Level. Nach einem
+Neustart von Enigma ist er verschwunden!</a></h4>
 <p>Ihr Spielergebnis ist nach wie vor derselbe. Aber Sie konkurrieren mit
 anderen Spielern weltweit um die besten Ergebnisse. Wenn Sie die &quot;Update
 Bewertungen&quot;-Einstellung auf &quot;Autom.&quot; gestellt haben, wird
@@ -445,9 +456,9 @@
 href="http://www.mag-heut.net/blackball/index.php"
 >http://www.mag-heut.net/</a>.</li>
 
-<li>Sie k&ouml;nnen neue Level schreiben und uns schicken oder auf
+<li>Sie k&ouml;nnen neue Levels schreiben und uns schicken oder auf
 <a href="http://www.mag-heut.net/blackball/index.php"
->http://www.mag-heut.net/</a> posten; vgl. &quot;Wie kann ich eine Level f&uuml;r
+>http://www.mag-heut.net/</a> posten; vgl. &quot;Wie kann ich einen Level f&uuml;r
 Enigma schreiben?&quot;</li>
 
 <li>Sie k&ouml;nnen Enigma in andere Sprachen &uuml;bersetzen. Das ben&ouml;tigt einige
@@ -475,7 +486,7 @@
 href="#s4q1">Aufgaben</a> helfen.</p>
 
 
-<h4><a name="s4q3">Wie kann ich eine Level f&uuml;r Enigma schreiben?</a></h4>
+<h4><a name="s4q3">Wie kann ich einen Level f&uuml;r Enigma schreiben?</a></h4>
 <p>Lesen Sie dazu das <a href="$$refman$$">Referenz-Handbuch</a>, besuchen Sie
 <a href="http://www.mag-heut.net" >mag-heut.net</a> oder studieren Sie
 existierende Level; diese befinden sich im Unterverzeichnis
@@ -506,7 +517,7 @@
 >http://www.capkoh.narod.ru/SL_MainPage.html</a>.</p>
 
 
-<h4><a name="s4q5">Ich habe neue Level geschrieben, w&uuml;rdet ihr sie in Enigma einbinden?</a></h4>
+<h4><a name="s4q5">Ich habe neue Levels geschrieben, w&uuml;rdet ihr sie in Enigma einbinden?</a></h4>
 <p>Ja, das werden wir gerne. Bitte senden Sie uns eine Email an die
 Entwickler-Mailing-Liste, wenn Sie gerne Ihre Level mit anderen teilen
 m&ouml;chten. Die Mailing-Liste hat ein Limit von 300k, also fragen Sie bitte vorher
@@ -517,10 +528,10 @@
 wurden.</p>
 
 
-<h4><a name="s4q6">Ich m&ouml;chte ein Objekt in meiner neuen Level verwenden, aber kenne nicht
+<h4><a name="s4q6">Ich m&ouml;chte ein Objekt in meinem neuen Level verwenden, aber kenne nicht
 seinen Namen.</a></h4>
 <p>Besuchen Sie hierf&uuml;r das Enigma Wiki auf
-<a href="$$wiki$$" >$$wiki$$</a> oder analysieren Sie eine Level, in der das
+<a href="$$wiki$$" >$$wiki$$</a> oder analysieren Sie einen Level, in der das
 Objekt erscheint.</p>
 
 
@@ -580,7 +591,7 @@
 <ul>
 <li>Es muss neue Aspekte ins Spiel bringen, die bisher nicht durch andere Objekte
 abgedeckt sind.</li>
-<li>Es muss gut f&uuml;r neue Level sein und sollte m&ouml;glichst viele Level
+<li>Es muss gut f&uuml;r neue Levels sein und sollte m&ouml;glichst viele Levels
 inspirieren.</li>
 <li>Es muss wohl definiert in seinem Verhalten bez&uuml;glich allen anderen
 bereits bestenenden Objekten sein.</li>

Modified: homepage/input/faq_questions.html
===================================================================
--- homepage/input/faq_questions.html	2008-04-18 22:45:50 UTC (rev 1104)
+++ homepage/input/faq_questions.html	2008-04-19 21:56:11 UTC (rev 1105)
@@ -53,6 +53,10 @@
     I use Kaspersky Internet Security 7.0. When I start Enigma,
     it says &quot;Keylogger found&quot;.</a></li>
 
+    <li><a href="$$faq$$#s2q10">
+    I use Linux. While playing Enigma, xmms (or any other music player) doesn't
+    work, or Enigma doesn't have sound.</a></li>
+
     <li><a href="$$faq$$#s2q4">
     When I enter a level pack, it takes so long to load the images?</a></li>
 

Modified: homepage/input/faq_questions_de.html
===================================================================
--- homepage/input/faq_questions_de.html	2008-04-18 22:45:50 UTC (rev 1104)
+++ homepage/input/faq_questions_de.html	2008-04-19 21:56:11 UTC (rev 1105)
@@ -55,6 +55,10 @@
     Ich benutze Kaspersky Internet Security 7.0. Wenn ich Enigma starte, kommt
     &quot;Keylogger gefunden&quot;.</a></li> 
 
+    <li><a href="$$faq$$#s2q10">
+    Ich benutze Linux. W&auml;hrend ich Enigma spiele, funktioniert xmms (oder
+    irgend ein anderer Musicplayer) nicht, oder Enigma hat keinen Sound.</a></li>
+
     <li><a href="$$faq$$#s2q4">
     Wenn ich ein Levelpaket &ouml;ffne, dauert es so lange, bis die Bilder
     geladen sind?</a></li> 

Added: homepage/input/hp_archive.html
===================================================================
--- homepage/input/hp_archive.html	2008-04-18 22:45:50 UTC (rev 1104)
+++ homepage/input/hp_archive.html	2008-04-19 21:56:11 UTC (rev 1105)
@@ -0,0 +1,22 @@
+
+<h2>Homepage Archive</h2>
+
+<p>
+You can find our collected Level-of-the-Month articles <a
+href="$$lotm$$">here</a>.
+</p>
+
+<p>
+All news articles can be viewed <a href="$$news$$">here</a>.
+</p>
+
+<h3>Special articles</h3>
+
+<ul>
+  <li><a href="$$eoya_2007$$">End of Year Awards 2007</a>
+  </li>
+  <li><a href="$$eoya_2007_statistics$$">End of Year Awards 2007 - Pure Statistics</a>
+  </li>
+  <li><a href="$$april_2008$$">April Fool's Day Joke 2008 - &quot;The Three Clouds&quot;</a>
+  </li>
+</ul>

Added: homepage/input/hp_archive_de.html
===================================================================
--- homepage/input/hp_archive_de.html	2008-04-18 22:45:50 UTC (rev 1104)
+++ homepage/input/hp_archive_de.html	2008-04-19 21:56:11 UTC (rev 1105)
@@ -0,0 +1,23 @@
+
+<h2>Homepage-Archiv</h2>
+
+<p>
+Sie finden unsere gesammelten Artikel zum Level des Monats <a
+href="$$lotm$$">hier</a>.
+</p>
+
+<p>
+Alle News-Artikel k&ouml;nnen Sie <a href="$$news$$">hier</a> einsehen.
+</p>
+
+<h3>Besondere Artikel</h3>
+
+<ul>
+  <li><a href="$$eoya_2007$$">Jahresendauszeichnungen 2007</a>
+  </li>
+  <li><a href="$$eoya_2007_statistics$$">Jahresendauszeichnungen 2007 - Pure Statistiken</a>
+  </li>
+  <li><a href="$$april_2008$$">Aprilscherz 2008 - &quot;The Three Clouds&quot;</a>
+  </li>
+</ul>
+

Modified: homepage/input/menu.html
===================================================================
--- homepage/input/menu.html	2008-04-18 22:45:50 UTC (rev 1104)
+++ homepage/input/menu.html	2008-04-19 21:56:11 UTC (rev 1105)
@@ -1,4 +1,8 @@
     <div class="menu">
+      <!--<ul class="mlist">
+        <li><a href="$$index$$">Home</a>
+        </li>
+      </ul>-->
       <ul class="mlist">
         <li><a href="$$about$$">About</a>
           <ul>
@@ -6,6 +10,7 @@
             <li><a href="$$about$$#testimonials">Testimonials<br>
               <span class="menusubtitle">User Comments</span></a></li>
             <li><a href="$$news$$">News and Olds</a></li>
+            <li><a href="$$hp_archive$$">Homepage Archive</a></li>
             <li><a href="$$screenshots$$">Screenshots</a></li>
             <li><a href="$$credits$$">Credits</a></li>
           </ul>

Modified: homepage/input/menu_de.html
===================================================================
--- homepage/input/menu_de.html	2008-04-18 22:45:50 UTC (rev 1104)
+++ homepage/input/menu_de.html	2008-04-19 21:56:11 UTC (rev 1105)
@@ -6,6 +6,7 @@
             <li><a href="$$about$$#testimonials">Meinungen<br>
               <span class="menusubtitle">von Spielern</span></a></li>
             <li><a href="$$news$$">Neues und Altes</a></li>
+            <li><a href="$$hp_archive$$">Homepage-Archiv</a></li>
             <li><a href="$$screenshots$$">Schnappsch&uuml;sse</a></li>
             <li><a href="$$credits$$">Danksagungen</a></li>
           </ul>

Modified: homepage/input/menu_ru.html
===================================================================
--- homepage/input/menu_ru.html	2008-04-18 22:45:50 UTC (rev 1104)
+++ homepage/input/menu_ru.html	2008-04-19 21:56:11 UTC (rev 1105)
@@ -6,6 +6,7 @@
             <li><a href="about_ru.html#testimonials">??????<br>
               <span class="menusubtitle">??????????? ?????????????</span></a></li>
             <li><a href="news_ru.html">??????? ? ?????</a></li>
+            <li><a href="$$hp_archive$$">Homepage Archive</a></li>
             <li><a href="screenshots_ru.html">?????????</a></li>
             <li><a href="credits_ru.html">?????????????</a></li>
           </ul>

Modified: homepage/input/output-files.lua
===================================================================
--- homepage/input/output-files.lua	2008-04-18 22:45:50 UTC (rev 1104)
+++ homepage/input/output-files.lua	2008-04-19 21:56:11 UTC (rev 1105)
@@ -457,10 +457,22 @@
 --------------------------------------------------------------------------------
 
 ----------------------------------------------------------------------
--- Remaining Articles
+-- Homepage Archiv
 ----------------------------------------------------------------------
+html.hp_archive = {
+    outfile = "hp_archive.html",
+    title = "Homepage Archive",
+    title_de = "Homepage-Archiv",
+    --ru-- title_ru = "Homepage Archive",
+    --es-- title_es = "Homepage Archive",
+    body = {"hp_archive", "top_news"}
+}
 
 ----------------------------------------------------------------------
+-- Special Articles
+----------------------------------------------------------------------
+
+----------------------------------------------------------------------
 -- End of Year Awards 2007
 ----------------------------------------------------------------------
 html.eoya_2007 = {

Added: homepage/input/top_news.html
===================================================================
--- homepage/input/top_news.html	2008-04-18 22:45:50 UTC (rev 1104)
+++ homepage/input/top_news.html	2008-04-19 21:56:11 UTC (rev 1105)
@@ -0,0 +1,44 @@
+
+<h3>Top News</h3>
+
+<p>Here we collected all our Top News:</p>
+
+         <h4><span class="date">2007-03-28:</span> Top News</h4>
+         New homepage, now with Top News!<br>
+         Read brief news around Enigma here.
+         
+         <h4><span class="date">2007-05-26:</span> Enigma 1.01 Released</h4>
+         Enigma 1.01 is a bug fix and level addition release with some small
+         feature additions.
+         
+         <h4><span class="date">2007-05-26:</span> Enigma 1.01 Released</h4>
+         All compilations inclusive Mac OS X are now available. See recent news for
+         details.
+         
+         <h4><span class="date">2007-07-27:</span> 100 000 Downloads</h4>
+         Enigma release 1.01 shows again more than 100 000 downloads since
+         end of May.
+         
+         <h4><span class="date">2007-09-01:</span> 100 Score Submitters</h4>
+         We welcome user &quot;dpl&quot; who is the 100th active score submitter
+         since Enigma 1.00.
+         
+         <h4><span class="date">2007-10-02:</span> More than 10,000 level ratings</h4>
+         This month we reached the 10,000-ratings mark. Thanks to all the
+         sedulous players, who sent us their opinions!
+         
+         <h4><span class="date">2008-01-02:</span> Happy IV/2!</h4>
+         The Enigma Team wishes everyone a Happy New Year!
+         Let's hope for many new levels in 2008&mdash;some are
+         already in the starting blocks&hellip;
+         
+         <h4><span class="date">2008-02-01:</span> 100% Solved!</h4>
+         Congratulations to our Japanese user Ryujun who succeeded first
+         in solving all levels of Enigma 1.01 in easy and difficult mode.
+         
+         <h4><span class="date">2008-03-14:</span> 500,000 Downloads!</h4>
+         In 2 out of 3 statistics, Enigma jumped the 500.000 downloads mark on
+         the Berlios server. This includes downloads from 0.92 up to 1.01.
+         Thanks to all players who made this possible!
+         
+         

Added: homepage/input/top_news_de.html
===================================================================
--- homepage/input/top_news_de.html	2008-04-18 22:45:50 UTC (rev 1104)
+++ homepage/input/top_news_de.html	2008-04-19 21:56:11 UTC (rev 1105)
@@ -0,0 +1,47 @@
+
+<h3>Top News</h3>
+
+<p>Hier haben wir alle unsere Top News gesammelt:</p>
+         
+         <h4><span class="date">28.3.2007:</span> Top News</h4>
+         Neue Homepage, jetzt mit Top News!<br>
+         Lesen Sie Kurznachrichten rund um Enigma hier.
+         
+         <h4><span class="date">26.5.2007:</span> Enigma 1.01 Released</h4>
+         Enigma 1.01 dient zur Korrektur einiger Fehler, der Hinzuf&uuml;gung
+         neuer Level und einiger kleinerer Erweiterungen.
+         
+         <h4><span class="date">26.5.2007:</span> Enigma 1.01 Released</h4>
+         Alle Compilationen inklusive Mac OS X sind nun verf&uuml;gbar. Siehe aktuelle
+         Neuigkeiten f&uuml;r Details.
+         
+         <h4><span class="date">27.7.2007:</span> 100 000 Downloads</h4>
+         Auch Enigma Release 1.01 weist nun mehr als 100.000 Downloads seit
+         Ende Mai auf.
+         
+         <h4><span class="date">1.9.2007:</span> 100 Einsender von Ergebnissen</h4>
+         Wir hei&szlig;en den Spieler &quot;dpl&quot; willkommen, den wir als 100sten
+         aktiven Einsender von Spielergebnissen registriert haben.
+         
+         <h4><span class="date">2.10.2007:</span> &Uuml;ber 10.000 Levelbewertungen</h4>
+         Diesen Monat haben wir die 10.000er Marke bei den Ratings
+         &uuml;berboten. Vielen Dank an die unerm&uuml;dlichen Spieler,
+         die uns ihre Meinung mitgeteilt haben!
+         
+         <h4><span class="date">2.1.2008:</span> Frohes IV/2!</h4>
+         Das Enigma-Team w&uuml;nscht allen ein frohes neues Jahr!
+         Lasst uns auf viele neue Levels in 2008 hoffen - einige
+         stehen bereits in den Startbl&ouml;cken&hellip;
+         
+         <h4><span class="date">1.2.2008:</span> 100% Gel&ouml;st!</h4>
+         Gl&uuml;ckwunsch an unseren japanischen Spieler Ryujun, dem es
+         als erstem gelungen ist, alle Level von Enigma 1.01 im einfachen
+         und im schwierigen Modus zu l&ouml;sen.
+         
+         <h4><span class="date">14.3.2008:</span> 500.000 Downloads!</h4>
+         In zwei von drei Statistiken hat Enigma die
+         500.000-Download-Marke auf dem Berlios-Server &uuml;bersprungen.
+         Dies umfasst Downloads von 0.92 bis 1.01. Vielen Dank an alle Spieler,
+         die dies m&ouml;glich gemacht haben!
+         
+         



From ral at mail.berlios.de  Sun Apr 20 20:40:42 2008
From: ral at mail.berlios.de (ral at BerliOS)
Date: Sun, 20 Apr 2008 20:40:42 +0200
Subject: [Enigma-game-svn] r1106 - in trunk: data data/gfx32 data/gfx40
	data/gfx48 data/schemas src
Message-ID: <200804201840.m3KIegps029204@sheep.berlios.de>

Author: ral
Date: 2008-04-20 20:40:41 +0200 (Sun, 20 Apr 2008)
New Revision: 1106

Added:
   trunk/data/gfx32/it_sensor.png
   trunk/data/gfx40/it_sensor.png
   trunk/data/gfx48/it_sensor.png
Modified:
   trunk/data/api1init.lua
   trunk/data/models-2d.lua
   trunk/data/schemas/objects.xml
   trunk/data/schemas/objects.xsd
   trunk/src/items.cc
   trunk/src/items.hh
   trunk/src/oxyd.cc
   trunk/src/stones_complex.cc
Log:
Trunk 1.1: new API reengineering sensor, cross item
- sensor:
  - renaming to it_sensor
  - elimination of it-inversesenor - use "inverse" attribute
  - added model and animation
  - default sensor is visible
  - new boolean attribute "invisible"
- cross:
  - renaming to it_cross
  - fix bug that prevented cross from performing actions after 10 s
  - new attribute "interval" that defaults to 10 s
  - state as read only that indicates if timer is running


Modified: trunk/data/api1init.lua
===================================================================
--- trunk/data/api1init.lua	2008-04-19 21:56:11 UTC (rev 1105)
+++ trunk/data/api1init.lua	2008-04-20 18:40:41 UTC (rev 1106)
@@ -51,6 +51,7 @@
     it_coin_s = "it-coin1",
     it_coin_m = "it-coin2",
     it_coin_l = "it-coin4",
+    it_cross = "it-cross",
     it_extralife = "it-extralife",
     it_floppy = "it-floppy",
     it_hammer = "it-hammer",
@@ -171,6 +172,15 @@
         local obj = enigma._MakeObject("it_key")
         enigma._SetAttrib(obj, "code", 3)
         return obj
+    elseif name == "it-sensor" then
+        local obj = enigma._MakeObject("it_sensor")
+        enigma._SetAttrib(obj, "invisible", true)
+        return obj
+    elseif name == "it-inversesensor" then
+        local obj = enigma._MakeObject("it_sensor")
+        enigma._SetAttrib(obj, "invisible", true)
+        enigma._SetAttrib(obj, "inverse", true)
+        return obj
     elseif name == "it-wormhole" then
         local obj = enigma._MakeObject("it_wormhole_on")
         enigma._SetAttrib(obj, "scissor", false)
@@ -233,6 +243,14 @@
             return "it-key_a"
         end
     end
+    if _newname == "it_sensor" then
+        local code = enigma._GetAttrib(obj, "inverse")
+        if code == false then
+            return "it-sensor"
+        else
+            return "it-inversesensor"
+        end
+    end
     if string.sub(_newname, 1, 8) == "st_laser" then
         return "st-laser"
     end

Added: trunk/data/gfx32/it_sensor.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx32/it_sensor.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx40/it_sensor.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx40/it_sensor.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx48/it_sensor.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx48/it_sensor.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Modified: trunk/data/models-2d.lua
===================================================================
--- trunk/data/models-2d.lua	2008-04-19 21:56:11 UTC (rev 1105)
+++ trunk/data/models-2d.lua	2008-04-20 18:40:41 UTC (rev 1106)
@@ -433,6 +433,7 @@
     DefImage("it_coin_s", {filename="it-coin1"})
     DefImage("it_coin_m", {filename="it-coin2"})
     DefImage("it_coin_l", {filename="it-coin4"})
+    DefImage("it_cross", {filename="it-cross"})
     DefImage("it_extralife", {filename="it-extralife"})
     DefImage("it_floppy", {filename="it-floppy"})
     DefImage("it_hammer", {filename="it-hammer"})
@@ -595,6 +596,13 @@
     DefAnim("it-seed-growing", BuildFrames(frames, 120))
 end
 
+-- it-sensor --
+do
+    DefTiles("it_sensor", {"it_sensor","it_sensor1"})
+    local frames = BuildFrames({"it_sensor","it_sensor1"}, 300)
+    DefAnim("it_sensor_hit", RepeatAnim(frames, 3), false)
+end
+
 -- it-shogun --
 do
     NewAnim("it-shogun-s", {img="it-shogun-small", h=3, speed=160, pingpong=1, loop=1})

Modified: trunk/data/schemas/objects.xml
===================================================================
--- trunk/data/schemas/objects.xml	2008-04-19 21:56:11 UTC (rev 1105)
+++ trunk/data/schemas/objects.xml	2008-04-20 18:40:41 UTC (rev 1106)
@@ -35,6 +35,8 @@
   <messages>
     <msg name="close" type="nil"/>
     <msg name="closeall" type="nil"/>
+    <msg name="brush" type="nil"/>
+    <msg name="hit" type="object"/>
     <msg name="inner_pull" type="dir"/>
     <msg name="off" type="nil"/>
     <msg name="on" type="nil"/>
@@ -47,6 +49,7 @@
     <msg name="turnback" type="nil"/>
     <msg name="_bombstone" type="nil"/>
     <msg name="_explosion" type="nil"/>
+    <msg name="_hit" type="object"/>
     <msg name="_init" type="nil"/>
     <msg name="_jumping" type="bool"/>
     <msg name="_performaction" type="nil"/>
@@ -94,6 +97,12 @@
     <object name="it_coin_l">
       <attr name="state" value="2"/>
     </object>
+    <object name="it_cross">
+      <attr name="interval" default="10"/>
+      <attr name="state" rw="r"/>
+      <msg name="brush"/>
+      <msg name="signal"/>
+    </object>
     <object name="it_extralife"/>
     <object name="it_extralife_new" init="true"/>
     <object name="it_floppy"/>
@@ -115,6 +124,10 @@
     <object name="it_magnet_on">
       <attr name="state" value="1"/>
     </object>
+    <object name="it_sensor">
+      <attr name="invisible"/>
+      <msg name="_hit"/>
+    </object>
     <object name="it_sword"/>
     <object name="it_sword_new" init="true"/>
     <object name="it_trigger">

Modified: trunk/data/schemas/objects.xsd
===================================================================
--- trunk/data/schemas/objects.xsd	2008-04-19 21:56:11 UTC (rev 1105)
+++ trunk/data/schemas/objects.xsd	2008-04-20 18:40:41 UTC (rev 1106)
@@ -116,6 +116,7 @@
 <!--      <xs:enumeration value="pos"/>  -->
       <xs:enumeration value="string"/>
       <xs:enumeration value="enum"/>
+      <xs:enumeration value="object"/>
       <xs:enumeration value="tokens"/>
     </xs:restriction>
   </xs:simpleType>

Modified: trunk/src/items.cc
===================================================================
--- trunk/src/items.cc	2008-04-19 21:56:11 UTC (rev 1105)
+++ trunk/src/items.cc	2008-04-20 18:40:41 UTC (rev 1106)
@@ -3152,47 +3152,56 @@
 
 /* Basically behave like regular triggers, but they are invisible and can be
    activated only once. */
-namespace
-{
     class Sensor : public Item {
         CLONEOBJ(Sensor);
         DECL_TRAITS;
     public:
         Sensor() {}
+        
+        // Object interface
+        virtual Value message(const Message &m);
+        
+        // GridObject interface
+        virtual void init_model();
 
-        void actor_enter (Actor *) {
+        // ModelCallback interface
+        virtual void animcb();
+
+        // Item interface
+        virtual void actor_enter(Actor *a);
+    };
+    
+    Value Sensor::message(const Message &m) {
+        if (m.message == "_hit") {   // door knocking forward to black/whitballstone
+            setAttr("$hitactor", m.value);
             performAction(true);
+            setAttr("$hitactor", (Object *)NULL);
+            return Value();
+        } else if (m.message == "_hitactor") {
+            return getAttr("$hitactor");
         }
-        
-        virtual Value message(const Message &m) {
-            if (m.message == "hit") {   // door knocking forward to black/whitballstone
-                setAttr("$hitactor", m.value);
-                performAction(true);
-                setAttr("$hitactor", (Object *)NULL);
-                return Value();
-            } else if (m.message == "_hitactor") {
-                return getAttr("$hitactor");
-            }
-            return Item::message(m);
-        }
-    };
-    DEF_TRAITSF(Sensor, "it-sensor", it_sensor, itf_static | itf_invisible);
+        return Item::message(m);
+    }
+    
+    void Sensor::init_model() {
+        if (getAttr("invisible").to_bool())
+            set_model("invisible");
+        else
+            set_model("it_sensor");
+    }
 
-    class InverseSensor : public Item {
-        CLONEOBJ(InverseSensor);
-        DECL_TRAITS;
-    public:
-        InverseSensor() {}
+    void Sensor::animcb() {
+        init_model();
+    }
 
-        void actor_enter (Actor *) {
-            performAction (false);
-        }
-    };
-    DEF_TRAITSF(InverseSensor, "it-inversesensor", it_inversesensor,
-                itf_static | itf_invisible);
-}
+    void Sensor::actor_enter(Actor *) {
+        if (!getAttr("invisible").to_bool())
+            set_anim("it_sensor_hit");
+        performAction(true);
+    }
+    
+    DEF_TRAITSF(Sensor, "it_sensor", it_sensor, itf_static);
 
-
 /* -------------------- Signal filters -------------------- */
 namespace
 {
@@ -3434,60 +3443,74 @@
 
 
 /* -------------------- Cross -------------------- */
-namespace
-{
     class Cross : public Item, public TimeHandler {
         CLONEOBJ(Cross);
         DECL_TRAITS;
 
-        bool m_active;
+    public:
+        virtual ~Cross();
+        
+        // Object interface
+        virtual Value message(const Message &m);
+        
+        // StateObject interface
+        virtual void setState(int extState);
+        
+        // Item interface
+        virtual void actor_enter(Actor *a);
+        virtual void actor_leave(Actor *a);
 
-        void actor_enter(Actor *a) {
-            if (!m_active && a->getAttr("player")) {
-                GameTimer.set_alarm (this, 10);
+        // TimeHandler interface
+        virtual void alarm();
+    };
+        
+    Cross::~Cross() {
+        GameTimer.remove_alarm(this);
+    }
+    
+    Value Cross::message(const Message &m) {
+        if (server::GameCompatibility == enigma::GAMET_PEROXYD) {
+            // Crosses can be used to invert signals in Per.Oxyd
+            if (m.message == "signal") {
+                performAction(!m.value.to_bool()); // convert 1/0 values to true/false
+                return Value();
             }
-        }
-
-        void actor_leave (Actor *) {
-            if (m_active) {
-                GameTimer.remove_alarm (this);
-                m_active = false;
+        } else if (enigma_server::GameCompatibility == GAMET_ENIGMA) {
+            if (m.message == "brush") {
+                KillItem(this->get_pos());
+                return Value();
             }
         }
+        return Item::message(m);
+    }
+    
+    void Cross::setState(int extState) {
+        return;   // ignore any write attempts
+    }
 
-        void alarm() {
-            performAction(true);
+    void Cross::actor_enter(Actor *a) {
+        if ((state == 0) && a->getAttr("player")) {
+            state = 1;
+            GameTimer.set_alarm (this, getAttr("interval"));
         }
+    }
 
-        virtual Value message(const Message &m) {
-            if (server::GameCompatibility == enigma::GAMET_PEROXYD) {
-                // Crosses can be used to invert signals in Per.Oxyd
-                if (m.message == "signal") {
-                    performAction(!m.value.to_bool()); // convert 1/0 values to true/false
-                    return Value();
-                }
-            } else if (enigma_server::GameCompatibility == GAMET_ENIGMA) {
-                if (m.message == "brush") {
-                    KillItem(this->get_pos());
-                    return Value();
-                }
-            }
-            return Item::message(m);
+    void Cross::actor_leave(Actor *) {
+        if (state == 1) {
+            GameTimer.remove_alarm (this);
+            state = 0;
         }
+    }
 
-    public:
-        Cross() : m_active(false) {
-        }
-        virtual ~Cross();
-    };
-    DEF_TRAITSF(Cross, "it-cross", it_cross, itf_static);
-
-    Cross::~Cross() {
-            GameTimer.remove_alarm(this);
+    void Cross::alarm() {
+        state = 0;
+        performAction(true);
     }
+    
+    DEF_TRAITSF(Cross, "it_cross", it_cross, itf_static);
 
-}
 
+
 /* -------------------- Bag -------------------- */
 namespace
 {
@@ -3946,7 +3969,6 @@
     RegisterItem (new Hill);
     RegisterItem (new Hollow);
     RegisterItem (new HStrip);
-    RegisterItem (new InverseSensor);
     RegisterItem (new InvisibleAbyss);
     RegisterItem (new Key);
     RegisterItem (new Landmine);

Modified: trunk/src/items.hh
===================================================================
--- trunk/src/items.hh	2008-04-19 21:56:11 UTC (rev 1105)
+++ trunk/src/items.hh	2008-04-20 18:40:41 UTC (rev 1106)
@@ -83,7 +83,6 @@
         it_hill,
         it_hollow,
         it_hstrip,
-        it_inversesensor,
         it_key,
         it_landmine,
         it_laserbeam,
@@ -133,7 +132,9 @@
         it_wrench,
         it_yinyang,
         it_LAST,
-        it_COUNT
+        it_COUNT,
+        //  for DAT compatibility only
+        it_inversesensor
     };
 
     /*! What may happen to an item _after_ it was activated? */

Modified: trunk/src/oxyd.cc
===================================================================
--- trunk/src/oxyd.cc	2008-04-19 21:56:11 UTC (rev 1105)
+++ trunk/src/oxyd.cc	2008-04-20 18:40:41 UTC (rev 1106)
@@ -407,6 +407,12 @@
         it->setAttr ("code", 3);
     }
     break;
+    case 0x2a:                  // sensor inverse
+    {
+        it = MakeItem(it_sensor);
+        it->setAttr("inverse", true);
+    }
+    break;
     default:
         {
             ItemID id = config.itemtable[type];
@@ -418,6 +424,13 @@
                 it = MakeItem (id);
                 if (id == it_vortex_closed)
                     it->setAttr("autoclose", true);
+                else if (id == it_sensor) {
+                    it->setAttr("invisible", true);
+                }
+                else if (id == it_inversesensor) {
+                    it->setAttr("invisible", true);
+                    it->setAttr("inverse", true);
+                }
             }
         }
     }

Modified: trunk/src/stones_complex.cc
===================================================================
--- trunk/src/stones_complex.cc	2008-04-19 21:56:11 UTC (rev 1105)
+++ trunk/src/stones_complex.cc	2008-04-20 18:40:41 UTC (rev 1106)
@@ -1368,7 +1368,7 @@
             Item *it = GetItem(get_pos());
             if (it != NULL && server::GameCompatibility != GAMET_PEROXYD 
                     && (server::GameCompatibility != GAMET_ENIGMA || server::EnigmaCompatibility < 1.10 ))
-                SendMessage(it, "hit", sc.actor);
+                SendMessage(it, "_hit", sc.actor);
             else
                 performAction(sc.actor);
         }



From ral at mail.berlios.de  Sun Apr 20 21:03:50 2008
From: ral at mail.berlios.de (ral at BerliOS)
Date: Sun, 20 Apr 2008 21:03:50 +0200
Subject: [Enigma-game-svn] r1107 - team_levelpacks/team_test_new_api
Message-ID: <200804201903.m3KJ3oSA031267@sheep.berlios.de>

Author: ral
Date: 2008-04-20 21:03:49 +0200 (Sun, 20 Apr 2008)
New Revision: 1107

Added:
   team_levelpacks/team_test_new_api/ralT041_1.xml
Modified:
   team_levelpacks/team_test_new_api/ralT019_1.xml
   team_levelpacks/team_test_new_api/raoulT02_1.xml
Log:
Test Level new API:
- fixes on attribute renaming keycode to code
- new test level for sensor and cross


Modified: team_levelpacks/team_test_new_api/ralT019_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/ralT019_1.xml	2008-04-20 18:40:41 UTC (rev 1106)
+++ team_levelpacks/team_test_new_api/ralT019_1.xml	2008-04-20 19:03:49 UTC (rev 1107)
@@ -20,15 +20,15 @@
 wo["ConserveLevel"] = true
 
 ti[" "] = {"fl-sahara"}
-ti["#"] = ti[" "] .. {"st-rock1"}
+ti["#"] = {"st-rock1"}
 
-ti["O"] = ti[" "] .. {"st_oxyd", name="o#"}
-ti["P"] = ti[" "] .. {"st_oxyd", name="p#"}
-ti["Q"] = ti[" "] .. {"st_oxyd", name="q#"}
-ti["R"] = ti[" "] .. {"st_oxyd", name="r#"}
-ti["S"] = ti[" "] .. {"st_oxyd", name="s#"}
-ti["T"] = ti[" "] .. {"st_oxyd", name="t#"}
-ti["1"] = ti[" "] .. {"#ac-blackball"}
+ti["O"] = {"st_oxyd", name="o#"}
+ti["P"] = {"st_oxyd", name="p#"}
+ti["Q"] = {"st_oxyd", name="q#"}
+ti["R"] = {"st_oxyd", name="r#"}
+ti["S"] = {"st_oxyd", name="s#"}
+ti["T"] = {"st_oxyd", name="t#"}
+ti["1"] = {"#ac-blackball"}
 
 w, h = wo(ti, " ", {
 "S  OOO              ",

Added: team_levelpacks/team_test_new_api/ralT041_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/ralT041_1.xml	2008-04-20 18:40:41 UTC (rev 1106)
+++ team_levelpacks/team_test_new_api/ralT041_1.xml	2008-04-20 19:03:49 UTC (rev 1107)
@@ -0,0 +1,71 @@
+<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
+<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
+  <el:protected>
+    <el:info el:type="level">
+      <el:identity el:title="Test Sensor new API" el:subtitle="" el:id="20080420ral550"/>
+      <el:version el:score="1" el:release="1" el:revision="$Revision: 1011 $" el:status="experimental"/>
+      <el:author  el:name="Ronald Lamprecht" el:email="ral at users.berlios.de"/>
+      <el:copyright>Copyright ? 2007 Ronald Lamprecht</el:copyright>
+      <el:license el:type="GPL v2.0 or above" el:open="true"/>
+      <el:compatibility el:enigma="1.10">
+      </el:compatibility>
+      <el:modes el:easy="false" el:single="true" el:network="false"/>
+      <el:comments>
+      </el:comments>
+      <el:score el:easy="-" el:difficult="-"/>
+    </el:info>
+    <el:luamain><![CDATA[
+
+
+wo["ConserveLevel"] = true
+
+ti[" "] = {"fl-sahara"}
+ti["y"] = ti[" "] .. {"it-yinyang"}
+ti["b"] = ti[" "] .. {"it_brush"}
+
+ti["e"] = {"it_sensor", invisible=true, target="sensorlaseri", action="signal"}
+ti["f"] = {"it_sensor", invisible=true, inverse=true, target="sensorlaseri", action="signal"}
+ti["l"] = {"st_laser_n", "sensorlaseri"}
+
+ti["E"] = {"it_sensor", target="sensorlaser", action="signal"}
+ti["F"] = {"it_sensor", inverse=true, target="sensorlaser", action="signal"}
+ti["L"] = {"st_laser_n", "sensorlaser"}
+
+ti["C"] = {"it_cross", target="crosslaser1"}
+ti["M"] = {"st_laser_n", "crosslaser1"}
+
+ti["c"] = {"it_cross", interval=3, target="crosslaser2"}
+ti["m"] = {"st_laser_n", "crosslaser2"}
+
+
+
+ti["1"] = ti["y"] .. {"#ac-blackball"} 
+ti["2"] = ti["y"] .. {"#ac-whiteball"}
+
+
+w, h = wo(ti, " ", {
+"                    ",
+" l   L     M   m    ",
+"                    ",
+" e   E     C   c    ",
+" f   F              ",
+"                    ",
+"                    ",
+"                    ",
+"                    ",
+"                    ",
+"        1 2      b  ",
+"                    ",
+"                    "
+})
+
+  
+  ]]></el:luamain>
+    <el:i18n>
+	 <el:string el:key="title">
+	   <el:english el:translate="false"/>
+	 </el:string>
+   </el:i18n>
+  </el:protected>
+</el:level>
+


Property changes on: team_levelpacks/team_test_new_api/ralT041_1.xml
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: team_levelpacks/team_test_new_api/raoulT02_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/raoulT02_1.xml	2008-04-20 18:40:41 UTC (rev 1106)
+++ team_levelpacks/team_test_new_api/raoulT02_1.xml	2008-04-20 19:03:49 UTC (rev 1107)
@@ -31,11 +31,11 @@
 ti["H"] = ti[" "] .. {"st_key", name="stk3", target="da3", action="on"}
 ti["I"] = ti[" "] .. {"st_key", name="stk4", target="da4", action="off"}
 
-ti["1"] = ti[" "] .. {"st_key", keycode=1}
-ti["2"] = ti[" "] .. {"st_key", keycode=2}
-ti["3"] = ti[" "] .. {"st_key", keycode=3}
-ti["4"] = ti[" "] .. {"st_key", keycode=4}
-ti["5"] = ti[" "] .. {"st_key", keycode=5}
+ti["1"] = ti[" "] .. {"st_key", code=1}
+ti["2"] = ti[" "] .. {"st_key", code=2}
+ti["3"] = ti[" "] .. {"st_key", code=3}
+ti["4"] = ti[" "] .. {"st_key", code=4}
+ti["5"] = ti[" "] .. {"st_key", code=5}
 
 ti["W"] = ti[" "] .. {"st_laser_e", name="la5"}
 ti["X"] = ti[" "] .. {"st_laser_e", name="la6"}
@@ -48,11 +48,11 @@
 ti["M"] = ti[" "] .. {"st_key", name="la8", target="da8", action="off", inverse=true}
 
 ti["a"] = ti[" "] .. {"it_key"}
-ti["b"] = ti[" "] .. {"it_key", keycode=1}
-ti["c"] = ti[" "] .. {"it_key", keycode=2}
-ti["d"] = ti[" "] .. {"it_key", keycode=3}
-ti["e"] = ti[" "] .. {"it_key", keycode=4}
-ti["f"] = ti[" "] .. {"it_key", keycode=5}
+ti["b"] = ti[" "] .. {"it_key", code=1}
+ti["c"] = ti[" "] .. {"it_key", code=2}
+ti["d"] = ti[" "] .. {"it_key", code=3}
+ti["e"] = ti[" "] .. {"it_key", code=4}
+ti["f"] = ti[" "] .. {"it_key", code=5}
 
 w, h = wo(ti, " ", {
 "0  a   F      A     ",



From ged at mail.berlios.de  Sun Apr 20 21:16:55 2008
From: ged at mail.berlios.de (ged at mail.berlios.de)
Date: Sun, 20 Apr 2008 21:16:55 +0200
Subject: [Enigma-game-svn] r1108 - homepage/input
Message-ID: <200804201916.m3KJGtMR000042@sheep.berlios.de>

Author: ged
Date: 2008-04-20 21:16:52 +0200 (Sun, 20 Apr 2008)
New Revision: 1108

Added:
   homepage/input/hp_archive_ru.html
   homepage/input/top_news_ru.html
Modified:
   homepage/input/faq_core_ru.html
   homepage/input/faq_questions_ru.html
   homepage/input/menu_ru.html
   homepage/input/output-files.lua
Log:
Homepage: Russian translation of new 'Homepage Archive' section's files

Modified: homepage/input/faq_core_ru.html
===================================================================
--- homepage/input/faq_core_ru.html	2008-04-20 19:03:49 UTC (rev 1107)
+++ homepage/input/faq_core_ru.html	2008-04-20 19:16:52 UTC (rev 1108)
@@ -155,6 +155,15 @@
 </p>
 
 
+<h4><a name="s2q10">? ????????? Linux. ?? ????? ???? ? Enigma, xmms (??? ????? ?????? ??????????? ?????????????) ?? ????????
+    ??? ??? ????? ? Enigma.</a></h4>
+<p>
+??? ??????????? ????????????? ?????? ???????????? ALSA, ? ?? OSS. ??? xmms: ???????? ?????? ???????,
+&quot;?????????(Options)&quot;, &quot;????????(Preferences)&quot;, &quot;?????????? ?????-?????? ?????(Audio I/O Plugins)&quot;,
+&quot;?????????? ??? ??????(Output Plugin)&quot;: ???? ? ?????? ???? ALSA, ?? ???????? ??.
+</p>
+
+
 <h4><a name="s2q4">??????, ????? ? ??????? ????? ???????, ??????????? ??????????? ??? ??????</a></h4>
 <p>??? ?????????? ?????? ??? ?????? ??????? Enigma, ? ?????? 
 ???? ? Enigma ?? ???? ????????? ??????. ??? ?????????

Modified: homepage/input/faq_questions_ru.html
===================================================================
--- homepage/input/faq_questions_ru.html	2008-04-20 19:03:49 UTC (rev 1107)
+++ homepage/input/faq_questions_ru.html	2008-04-20 19:16:52 UTC (rev 1108)
@@ -25,7 +25,7 @@
     ? ????????? ? ????? ??????? ??? Enigma ? ???? ??????? ?? ??? &#8230;</a></li>
 
     <li><a href="$$faq$$#s1q7">
-    ??? ? ???? ??????? ?? ??????? Sokoban ????? ?????????</a></li>
+    ??? ? ???? ??????? ?? ??????? ???????? ????? ?????????</a></li>
 
 </ul><li><a href="$$faq$$#section2" name="index_section2">?????? Enigma</a><ul>
 
@@ -51,6 +51,10 @@
     ? ????????? Kaspersky Internet Security 7.0. ????? ? ???????? Enigma,
     ?? ???????? &quot;Keylogger found&quot;.</a></li>
 
+    <li><a href="$$faq$$#s2q10">
+    ? ????????? Linux. ?? ????? ???? ? Enigma, xmms (??? ????? ?????? ??????????? ?????????????) ?? ????????
+    ??? ??? ????? ? Enigma.</a></li>
+
     <li><a href="$$faq$$#s2q4">
     ??????, ????? ? ??????? ????? ???????, ??????????? ??????????? ??? ??????</a></li>
 

Added: homepage/input/hp_archive_ru.html
===================================================================
--- homepage/input/hp_archive_ru.html	2008-04-20 19:03:49 UTC (rev 1107)
+++ homepage/input/hp_archive_ru.html	2008-04-20 19:16:52 UTC (rev 1108)
@@ -0,0 +1,21 @@
+
+<h2>????? ???????? ????????</h2>
+
+<p>
+<a href="$$lotm$$">?????</a> ?? ?????? ????? ????????? ???? ?????? ?? ??????? ??????.
+</p>
+
+<p>
+??? ??????? ????? ???????? <a href="$$news$$">?????</a>.
+</p>
+
+<h3>?????? ??????</h3>
+
+<ul>
+  <li><a href="$$eoya_2007$$">??????? ????? ???? 2007</a>
+  </li>
+  <li><a href="$$eoya_2007_statistics$$">??????? ????? ???? 2007 - ?????????????? ?????</a>
+  </li>
+  <li><a href="$$april_2008$$">??????????????? ????? 2008 - &quot;The Three Clouds&quot;</a>
+  </li>
+</ul>


Property changes on: homepage/input/hp_archive_ru.html
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: homepage/input/menu_ru.html
===================================================================
--- homepage/input/menu_ru.html	2008-04-20 19:03:49 UTC (rev 1107)
+++ homepage/input/menu_ru.html	2008-04-20 19:16:52 UTC (rev 1108)
@@ -6,7 +6,7 @@
             <li><a href="about_ru.html#testimonials">??????<br>
               <span class="menusubtitle">??????????? ?????????????</span></a></li>
             <li><a href="news_ru.html">??????? ? ?????</a></li>
-            <li><a href="$$hp_archive$$">Homepage Archive</a></li>
+            <li><a href="$$hp_archive$$">????? ???????? ????????</a></li>
             <li><a href="screenshots_ru.html">?????????</a></li>
             <li><a href="credits_ru.html">?????????????</a></li>
           </ul>

Modified: homepage/input/output-files.lua
===================================================================
--- homepage/input/output-files.lua	2008-04-20 19:03:49 UTC (rev 1107)
+++ homepage/input/output-files.lua	2008-04-20 19:16:52 UTC (rev 1108)
@@ -463,7 +463,7 @@
     outfile = "hp_archive.html",
     title = "Homepage Archive",
     title_de = "Homepage-Archiv",
-    --ru-- title_ru = "Homepage Archive",
+    title_ru = "????? ???????? ????????",
     --es-- title_es = "Homepage Archive",
     body = {"hp_archive", "top_news"}
 }

Added: homepage/input/top_news_ru.html
===================================================================
--- homepage/input/top_news_ru.html	2008-04-20 19:03:49 UTC (rev 1107)
+++ homepage/input/top_news_ru.html	2008-04-20 19:16:52 UTC (rev 1108)
@@ -0,0 +1,36 @@
+
+<h3>?????? ???????</h3>
+
+<p>????? ?? ???????? ??? ?????? ???????:</p>
+
+         <h4><span class="date">2007-03-28:</span> ?????? ???????</h4>
+         ????? ???????? ????????, ?????? ?? ??????? ?????????!<br>
+         ????? ????? ???????? ???????? ??????? ?? ???? Enigma.
+         
+         <h4><span class="date">2007-05-26:</span> ???????? Enigma 1.01</h4>
+         Enigma 1.01 - ??? ?????? ? ???????????? ??????, ??????????????? ???????? ? ??????????? ??????????????? ?????????????.
+         
+         <h4><span class="date">2007-05-26:</span> ???????? Enigma 1.01</h4>
+         ?????? ???????? ??? ??????, ??????? Mac OS X. ????????? ???????? ????????? ???????.
+         
+         <h4><span class="date">2007-07-27:</span> 100 000 ????????</h4>
+         ?????? Enigma 1.01 ? ????? ??? ??? ???????? ??? ????? 100 000 ???.
+         
+         <h4><span class="date">2007-09-01:</span> 100 ????? ???????? ??? ???? ??????????</h4>
+         ?? ???????????? ???????????? &quot;dpl&quot;, ??????? 100-? ????? ??????? Enigma 1.00 ??????? ??? ???? ??????????.
+         
+         <h4><span class="date">2007-10-02:</span> ????? 10,000 ?????? ???????</h4>
+         ? ???? ?????? ?? ???????? ??????? ? 10,000 ??????. ??????? ???? ????????? ???????, ??????? ????????? ???? ??????!
+         
+         <h4><span class="date">2008-01-02:</span> ??????????? IV/2!</h4>
+         ??????? Enigma ?????? ???? ??????????? ?????? ????!
+         ???????? ??? ? 2008 ???? ?? ?????? ??? ????? ????? ???????&mdash;????????? ??? ? ???????? ????????&hellip;
+         
+         <h4><span class="date">2008-02-01:</span> ?????? 100%!</h4>
+         ??????????? ?????? ????????? ???????????? Ryujun, ??????? ?????? ??????? ????? ??? ?????? Enigma 1.01 ?
+	?????????? ? ??????? ???????.
+         
+         <h4><span class="date">2008-03-14:</span> 500,000 ????????!</h4>
+         ? 2 ?? 3 ?????????????? ???????, Enigma ???????? ??????? ? 500.000 ???????? ? ??????? Berlios. ? ??? ?????? ???????? ? ?????? 0.92 ?? 1.01. ??????? ???? ???????, ????????? ??????? ??? ????? ?????????!
+         
+         


Property changes on: homepage/input/top_news_ru.html
___________________________________________________________________
Name: svn:eol-style
   + native



From andreasl at mail.berlios.de  Sun Apr 20 23:14:53 2008
From: andreasl at mail.berlios.de (andreasl at BerliOS)
Date: Sun, 20 Apr 2008 23:14:53 +0200
Subject: [Enigma-game-svn] r1109 - in trunk: . data/gfx data/gfx/flags25x15
	src src/gui
Message-ID: <200804202114.m3KLErGG009547@sheep.berlios.de>

Author: andreasl
Date: 2008-04-20 23:14:52 +0200 (Sun, 20 Apr 2008)
New Revision: 1109

Added:
   trunk/data/gfx/flags25x15/
   trunk/data/gfx/flags25x15/Makefile.am
   trunk/data/gfx/flags25x15/de.png
   trunk/data/gfx/flags25x15/es.png
   trunk/data/gfx/flags25x15/fi.png
   trunk/data/gfx/flags25x15/flags.txt
   trunk/data/gfx/flags25x15/fr.png
   trunk/data/gfx/flags25x15/gb.png
   trunk/data/gfx/flags25x15/hu.png
   trunk/data/gfx/flags25x15/it.png
   trunk/data/gfx/flags25x15/nl.png
   trunk/data/gfx/flags25x15/pt.png
   trunk/data/gfx/flags25x15/ru.png
   trunk/data/gfx/flags25x15/se.png
Modified:
   trunk/configure.ac
   trunk/data/gfx/Makefile.am
   trunk/src/gui/MainMenu.cc
   trunk/src/gui/MainMenu.hh
   trunk/src/gui/OptionsMenu.cc
   trunk/src/nls.hh
Log:
Restructuring options menu part 1:
 - Added language buttons to main menu.
Note:
 - No language buttons in main menu for 320x240,
   the button in the options menu must suffice.
 - Please feedback about the position and the
   general look-and-feel. I prepared variations
   with the buttons horizontal at the bottom
   and vertical at the right edge (see
   outcommented BuildHList/BuildVList in
   MainMenu.cc -> MainMenu::build_menu()).
Todo:
 - The "default language"-button currently uses
   the par-symbol. Needs something else or to
   be removed completely.
 - Please add data/gfx/flags25x15-directory
   to Win/Mac-distributions where neccessary
   (or tell me how to do it/where to add it).


Modified: trunk/configure.ac
===================================================================
--- trunk/configure.ac	2008-04-20 19:16:52 UTC (rev 1108)
+++ trunk/configure.ac	2008-04-20 21:14:52 UTC (rev 1109)
@@ -353,6 +353,7 @@
 AC_CONFIG_FILES([Makefile m4/Makefile  intl/Makefile 
            data/Makefile
            data/gfx/Makefile
+           data/gfx/flags25x15/Makefile
            data/gfx16/Makefile
            data/gfx32/Makefile
            data/gfx40/Makefile

Modified: trunk/data/gfx/Makefile.am
===================================================================
--- trunk/data/gfx/Makefile.am	2008-04-20 19:16:52 UTC (rev 1108)
+++ trunk/data/gfx/Makefile.am	2008-04-20 21:14:52 UTC (rev 1109)
@@ -1,3 +1,6 @@
+SUBDIRS = flags25x15
+
 pkgdatadir = $(datadir)/@PACKAGE@/gfx
 pkgdata_DATA = $(wildcard $(srcdir)/*.png $(srcdir)/*.jpg)
+
 EXTRA_DIST = $(pkgdata_DATA)


Property changes on: trunk/data/gfx/flags25x15
___________________________________________________________________
Name: svn:ignore
   + Makefile
Makefile.in


Added: trunk/data/gfx/flags25x15/Makefile.am
===================================================================
--- trunk/data/gfx/flags25x15/Makefile.am	2008-04-20 19:16:52 UTC (rev 1108)
+++ trunk/data/gfx/flags25x15/Makefile.am	2008-04-20 21:14:52 UTC (rev 1109)
@@ -0,0 +1,3 @@
+pkgdatadir = $(datadir)/@PACKAGE@/flags25x15
+pkgdata_DATA = $(wildcard $(srcdir)/*.png $(srcdir)/*.jpg $(srcdir)/*.txt)
+EXTRA_DIST = $(pkgdata_DATA)

Added: trunk/data/gfx/flags25x15/de.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx/flags25x15/de.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/data/gfx/flags25x15/es.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx/flags25x15/es.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/data/gfx/flags25x15/fi.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx/flags25x15/fi.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/data/gfx/flags25x15/flags.txt
===================================================================
--- trunk/data/gfx/flags25x15/flags.txt	2008-04-20 19:16:52 UTC (rev 1108)
+++ trunk/data/gfx/flags25x15/flags.txt	2008-04-20 21:14:52 UTC (rev 1109)
@@ -0,0 +1,2 @@
+Flag images found at http://www.hahn-hotel.com/flags/
+"All sets provided by us are free to use to anyone, for commercial or non-commercial websites."

Added: trunk/data/gfx/flags25x15/fr.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx/flags25x15/fr.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/data/gfx/flags25x15/gb.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx/flags25x15/gb.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/data/gfx/flags25x15/hu.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx/flags25x15/hu.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/data/gfx/flags25x15/it.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx/flags25x15/it.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/data/gfx/flags25x15/nl.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx/flags25x15/nl.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/data/gfx/flags25x15/pt.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx/flags25x15/pt.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/data/gfx/flags25x15/ru.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx/flags25x15/ru.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/data/gfx/flags25x15/se.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx/flags25x15/se.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Modified: trunk/src/gui/MainMenu.cc
===================================================================
--- trunk/src/gui/MainMenu.cc	2008-04-20 19:16:52 UTC (rev 1108)
+++ trunk/src/gui/MainMenu.cc	2008-04-20 21:14:52 UTC (rev 1109)
@@ -223,6 +223,16 @@
         options     = b.add(new StaticTextButton(N_("Options"), this));
         credits     = b.add(new StaticTextButton(N_("Credits"), this));
         quit        = b.add(new StaticTextButton(N_("Quit"), this));
+        int ly = vminfo->width - 5 - 35*NUMENTRIES(nls::languages);
+        //BuildHList l(this, Rect(ly, (vminfo->height) - 30, 30, 20), 5);
+        BuildHList l(this, Rect(ly, 10, 30, 20), 5);
+        //BuildVList l(this, Rect(vminfo->width - 45, 15, 30, 20), 5);
+        language.clear();
+        if(!vshrink)
+            for (size_t i=0; i<NUMENTRIES(nls::languages); ++i)
+                language.push_back(l.add(
+                    new ImageButton(nls::languages[i].flagimage,
+                                    nls::languages[i].flagimage, this)));
     }
     
     void MainMenu::draw_background(ecl::GC &gc) 
@@ -264,14 +274,11 @@
         if (w == m_startgame) {            
             LevelPackMenu m;
             m.manageLevelMenu();
-            invalidate_all();
         } else if (w == m_levelpack) {
             LevelPackMenu m;
             m.manage();
-            invalidate_all();
         } else if (w == credits) {
             displayInfo(credit_text, 6);
-            invalidate_all();
         } else if (w == options) {
             ShowOptionsMenu(0);
     
@@ -283,6 +290,12 @@
     #endif
         } else if (w == quit) {
             Menu::quit();
+        } else if (language.size() > 0) {
+            for (size_t i=0; i<NUMENTRIES(nls::languages); ++i)
+                if (w == language[i]) {
+                    options::SetOption ("Language", nls::languages[i].localename);
+                    app.setLanguage(nls::languages[i].localename);
+                }
         } else
             return;
         invalidate_all();

Modified: trunk/src/gui/MainMenu.hh
===================================================================
--- trunk/src/gui/MainMenu.hh	2008-04-20 19:16:52 UTC (rev 1108)
+++ trunk/src/gui/MainMenu.hh	2008-04-20 21:14:52 UTC (rev 1109)
@@ -21,6 +21,8 @@
 
 #include "gui/Menu.hh"
 
+#include <vector>
+
 namespace enigma { namespace gui {
 /* -------------------- MainMenu -------------------- */
 
@@ -52,6 +54,7 @@
         Widget *credits;
         Widget *quit;
         Widget *lpack;
+        std::vector <Widget*> language;
     };
 
 /* -------------------- NetworkMenu -------------------- */

Modified: trunk/src/gui/OptionsMenu.cc
===================================================================
--- trunk/src/gui/OptionsMenu.cc	2008-04-20 19:16:52 UTC (rev 1108)
+++ trunk/src/gui/OptionsMenu.cc	2008-04-20 21:14:52 UTC (rev 1109)
@@ -246,34 +246,14 @@
     
     /* -------------------- LanguageButton -------------------- */
     
-    struct Language {
-        const char *name;
-        const char *localename;
-    };
-    
-    Language languages[] = {
-        { "default",                "" },
-        { "Deutsch",                "de_DE" },
-        { "English",                "en_EN" },
-        { "Espa?ol",         "es_ES" },
-        { "Fran?ais",        "fr_FR" },
-        { "Italiano",               "it_IT" },
-        { "Nederlands",             "nl_NL" },
-        { "Svenska",             "sv_SE" },
-        { "???????",             "ru_RU" },
-        { "Magyar",             "hu_HU" },
-        { "Portugu?s",             "pt_BR" },
-        { "Suomi",             "fi_FI" },
-    };
-    
     int LanguageButton::get_value() const
     {
         string localename; //  = ecl::DefaultMessageLocale ();
         options::GetOption ("Language", localename);
     
         int lang = 0;                  // unknown language
-        for (size_t i=0; i<NUMENTRIES(languages); ++i) {
-            if (localename == languages[i].localename)
+        for (size_t i=0; i<NUMENTRIES(nls::languages); ++i) {
+            if (localename == nls::languages[i].localename)
                 lang = int(i);
         }
         return lang;
@@ -281,11 +261,11 @@
     
     void LanguageButton::set_value(int value)
     {
-        options::SetOption ("Language", languages[value].localename);
+        options::SetOption ("Language", nls::languages[value].localename);
         
-        if ( not inInit) {
+        if (not inInit) {
             // change language only on user action
-            app.setLanguage(languages[value].localename);
+            app.setLanguage(nls::languages[value].localename);
             myListener->on_action(this);
         }
     }
@@ -295,11 +275,11 @@
         if (value == -1)
             return _("unknown");
         else
-            return languages[value].name;
+            return nls::languages[value].name;
     }
     
     LanguageButton::LanguageButton (ActionListener *al)
-    : ValueButton(0, NUMENTRIES(languages)-1), myListener(al)
+    : ValueButton(0, NUMENTRIES(nls::languages)-1), myListener(al)
     {
         inInit = true;
         init();

Modified: trunk/src/nls.hh
===================================================================
--- trunk/src/nls.hh	2008-04-20 19:16:52 UTC (rev 1108)
+++ trunk/src/nls.hh	2008-04-20 21:14:52 UTC (rev 1109)
@@ -17,6 +17,27 @@
 namespace nls
 {
     void SetMessageLocale (const std::string &language);
+
+    struct Language {
+        const char *name;
+        const char *localename;
+        const char *flagimage;
+    };
+    
+    const Language languages[] = {
+        { "default",    "",      "par" },
+        { "Deutsch",    "de_DE", "flags25x15/de" },
+        { "English",    "en_EN", "flags25x15/gb" },
+        { "Espa?ol",    "es_ES", "flags25x15/es" },
+        { "Fran?ais",   "fr_FR", "flags25x15/fr" },
+        { "Italiano",   "it_IT", "flags25x15/it" },
+        { "Nederlands", "nl_NL", "flags25x15/nl" },
+        { "Svenska",    "sv_SE", "flags25x15/se" },
+        { "???????",    "ru_RU", "flags25x15/ru" },
+        { "Magyar",     "hu_HU", "flags25x15/hu" },
+        { "Portugu?s",  "pt_BR", "flags25x15/pt" },
+        { "Suomi",      "fi_FI", "flags25x15/fi" },
+    };
 }
 
 #endif



From andreasl at mail.berlios.de  Fri Apr 25 02:57:58 2008
From: andreasl at mail.berlios.de (andreasl at BerliOS)
Date: Fri, 25 Apr 2008 02:57:58 +0200
Subject: [Enigma-game-svn] r1110 - trunk/src
Message-ID: <200804250057.m3P0vwVn027687@sheep.berlios.de>

Author: andreasl
Date: 2008-04-25 02:57:57 +0200 (Fri, 25 Apr 2008)
New Revision: 1110

Modified:
   trunk/src/MusicManager.cc
   trunk/src/SoundEffectManager.cc
   trunk/src/SoundEngine.cc
   trunk/src/SoundEngine.hh
   trunk/src/world.cc
Log:
Some minor improvement to the sound system:
 - Shortcut functions like the damping-tick
   if sound/music is disabled or mute (volume 0)


Modified: trunk/src/MusicManager.cc
===================================================================
--- trunk/src/MusicManager.cc	2008-04-20 21:14:52 UTC (rev 1109)
+++ trunk/src/MusicManager.cc	2008-04-25 00:57:57 UTC (rev 1110)
@@ -63,7 +63,8 @@
 
 void sound::MusicTick(double dtime)
 {
-    MusicManager::instance()->tick(dtime);
+    if(!sound::IsMusicMute())
+        MusicManager::instance()->tick(dtime);
 }
 
 void sound::InitMusic()

Modified: trunk/src/SoundEffectManager.cc
===================================================================
--- trunk/src/SoundEffectManager.cc	2008-04-20 21:14:52 UTC (rev 1109)
+++ trunk/src/SoundEffectManager.cc	2008-04-25 00:57:57 UTC (rev 1110)
@@ -381,6 +381,8 @@
 bool SoundEffectManager::emitSoundEvent (const string &eventname, const ecl::V2 &pos,
                             double volume, bool force_global)
 {
+    if((volume == 0) || sound::IsSoundMute())
+        return false;
     string effectkey = effectKey(eventname);
     SoundEffectRepository::iterator i = sound_effects.find(effectkey);
     if (i == sound_effects.end()) {
@@ -406,7 +408,7 @@
 /* -------------------- Sound damping implementation -------------------- */
 
 /*! These methods are connected to the sound damping mechanism, designed
-  to reduce the noise created by some objects like st-lightpassenger. */
+  to reduce the noise created by some objects like st_lightpassenger. */
 
 SoundDamping::SoundDamping(string effect_name_, const void *origin_)
 : effect_name(effect_name_), origin(origin_)

Modified: trunk/src/SoundEngine.cc
===================================================================
--- trunk/src/SoundEngine.cc	2008-04-20 21:14:52 UTC (rev 1109)
+++ trunk/src/SoundEngine.cc	2008-04-25 00:57:57 UTC (rev 1110)
@@ -40,6 +40,8 @@
     bool sound_enabled      = true;
     bool music_enabled      = true;
     bool sound_enabled_temp = false;
+    bool sound_mute         = false;
+    bool music_mute         = false;
 }
 
 
@@ -95,15 +97,23 @@
     sound_enabled = sound_enabled_temp;
 }
 
-void sound::DefineSound (const SoundName &name, const SoundData &data)
-{
-    sound_engine->define_sound (name, data);
+bool sound::IsSoundMute() {
+    return !sound_enabled || sound_mute;
 }
 
 void sound::DisableMusic() {
     music_enabled = false;
 }
 
+bool sound::IsMusicMute() {
+    return !sound_enabled || !music_enabled || music_mute;
+}
+
+void sound::DefineSound (const SoundName &name, const SoundData &data)
+{
+    sound_engine->define_sound (name, data);
+}
+
 void sound::SetListenerPosition (const ecl::V2 &pos) 
 {
     sound_engine->set_listenerpos (pos);
@@ -111,7 +121,7 @@
 
 bool sound::PlaySound (const SoundName &name, const ecl::V2 &pos, double volume, int priority) 
 {
-    if (!sound_enabled)
+    if (sound::IsSoundMute())
         return false;
 
     SoundEvent se;
@@ -127,6 +137,9 @@
 
 bool sound::PlaySoundGlobal (const SoundName &name, double volume, int priority) 
 {
+    if (sound::IsSoundMute())
+        return false;
+
     SoundEvent se;
     se.name         = name;
     se.has_position = false;
@@ -156,7 +169,7 @@
 
 bool sound::PlayMusic (const string &name, double position) 
 {
-    if(!sound_enabled || !music_enabled || name=="")
+    if(sound::IsMusicMute() || name=="")
         return false;
     
     string fname;
@@ -174,11 +187,13 @@
 void sound::SetSoundVolume (double vol)
 {
     sound_engine->set_sound_volume (vol);
+    sound_mute = (vol == 0.0);
 }
 
 void sound::SetMusicVolume (double vol)
 {
     sound_engine->set_music_volume (vol);
+    music_mute = (vol == 0.0);
 }
 
 
@@ -510,7 +525,7 @@
 Mix_Chunk* SoundEngine_SDL::ChunkFromRaw (const Uint8 *buf, Uint32 len,
                                            int sfreq, int sformat, int schannels)
 {
-    if (!sound_enabled || !buf)
+    if (sound::IsSoundMute() || !buf)
         return 0;
 
     // Get destination format

Modified: trunk/src/SoundEngine.hh
===================================================================
--- trunk/src/SoundEngine.hh	2008-04-20 21:14:52 UTC (rev 1109)
+++ trunk/src/SoundEngine.hh	2008-04-25 00:57:57 UTC (rev 1110)
@@ -54,6 +54,8 @@
 
     void TempDisableSound();
     void TempReEnableSound();
+    bool IsSoundMute();
+    bool IsMusicMute();
 
     void SetListenerPosition (const ecl::V2 &pos);
     bool PlaySound (const SoundName &, const ecl::V2 &pos,

Modified: trunk/src/world.cc
===================================================================
--- trunk/src/world.cc	2008-04-20 21:14:52 UTC (rev 1109)
+++ trunk/src/world.cc	2008-04-25 00:57:57 UTC (rev 1110)
@@ -21,6 +21,7 @@
 #include "laser.hh"
 #include "player.hh"
 #include "SoundEffectManager.hh"
+#include "SoundEngine.hh"
 #include "options.hh"
 #include "server.hh"
 #include "lua.hh"
@@ -1493,10 +1494,12 @@
 
 void World::tick_sound_dampings ()
 {
+    if(sound::IsSoundMute())
+        return;
     // See SoundEffectManager.hh for details.
     static int counter = 0;
     ++counter;
-
+    
     if (counter > 9) {
         counter = 0;
         SoundDampingList::iterator i = level->sound_dampings.begin(),
@@ -2302,6 +2305,8 @@
 
 float getVolume(const char *name, Object *obj, float def_volume)
 {
+    if((def_volume == 0.0) || sound::IsSoundMute())
+        return 0;
     // See SoundEffectManager.hh for details.
     SoundDampingList::iterator i = level->sound_dampings.begin(),
         end = level->sound_dampings.end();



From andreasl at mail.berlios.de  Sat Apr 26 01:38:53 2008
From: andreasl at mail.berlios.de (andreasl at BerliOS)
Date: Sat, 26 Apr 2008 01:38:53 +0200
Subject: [Enigma-game-svn] r1111 - trunk/src/gui
Message-ID: <200804252338.m3PNcrQH001872@sheep.berlios.de>

Author: andreasl
Date: 2008-04-26 01:38:53 +0200 (Sat, 26 Apr 2008)
New Revision: 1111

Modified:
   trunk/src/gui/Menu.hh
   trunk/src/gui/OptionsMenu.cc
   trunk/src/gui/OptionsMenu.hh
Log:
Restructuring options menu part 2:
 - Options menu now uses multiple pages
   (main, video, audio, config), which can
   easily be extended and reorganized.
Todo:
 - Textspeed-button
 - Maybe Undo-button


Modified: trunk/src/gui/Menu.hh
===================================================================
--- trunk/src/gui/Menu.hh	2008-04-25 00:57:57 UTC (rev 1110)
+++ trunk/src/gui/Menu.hh	2008-04-25 23:38:53 UTC (rev 1111)
@@ -52,7 +52,8 @@
 
     protected:
         void reset_active_widget() { active_widget = NULL; }
-
+        void reset_key_focus_widget() { key_focus_widget = NULL; }
+        
         // Menu interface.
         virtual void draw_background(ecl::GC &/*gc*/) {}
 

Modified: trunk/src/gui/OptionsMenu.cc
===================================================================
--- trunk/src/gui/OptionsMenu.cc	2008-04-25 00:57:57 UTC (rev 1110)
+++ trunk/src/gui/OptionsMenu.cc	2008-04-25 23:38:53 UTC (rev 1111)
@@ -239,8 +239,8 @@
 
     /* -------------------- FullscreenButton -------------------- */
     
-    FullscreenButton::FullscreenButton()
-        : BoolOptionButton("FullScreen", N_("Yes"), N_("No"))
+    FullscreenButton::FullscreenButton(ActionListener *al)
+    : BoolOptionButton("FullScreen", N_("Yes"), N_("No"), al)        
     {
     }
     
@@ -318,115 +318,283 @@
     /* -------------------- Options Menu -------------------- */
     
     OptionsMenu::OptionsMenu(ecl::Surface *background_)
-    : back(new StaticTextButton(N_("Back"), this)),
-      m_restartinfo (new Label("")),
-      background(background_),
-      previous_caption(video::GetCaption())
+    : back(NULL),  //(new StaticTextButton(N_("Back"), this)),
+      background(background_), previous_caption(video::GetCaption()),
+      pagesVList(NULL), commandHList(NULL), optionsVList(NULL),
+      language(NULL), but_main_options(NULL), but_video_options(NULL),
+      but_audio_options(NULL), but_config_options(NULL), fullscreen(NULL),
+      videomode(NULL), userNameTF(NULL), userPathTF(NULL),
+      userImagePathTF(NULL), menuMusicTF(NULL)
     {
+        center();
+        close_page();
+        open_page(OPTIONS_MAIN);
+    }
+
+    OptionsMenu::~OptionsMenu() {
+        video::SetCaption(previous_caption.c_str());
+    }
+
+    void OptionsMenu::open_page(OptionsPage new_page) {
         const video::VMInfo *vminfo = video::GetInfo();
         const int vshrink = vminfo->width < 640 ? 1 : 0;
-        const int spacing     = vshrink ? 2 : 5;
-        const int big_spacing = vshrink ? 30 : 60;
-        const int label_width = vshrink ? 90 : 180;
-        const int but_width   = vshrink ? 50 : 100;
-        const int but_height  = vshrink ? 15 : 30;
         int hmargin = vshrink ? 5 : (vminfo->width < 660 ? 10 : (vminfo->width < 900 ? 20 : 80));
-        int midspacing = vminfo->width - 2*hmargin - 2*but_width - 2*label_width;
-    
-        BuildVList leftlabels (this, Rect(-label_width, 0, label_width, but_height), spacing);
-        BuildVList left (this, Rect(0, 0, but_width, but_height), spacing);
-        BuildVList rightlabels (this, Rect(but_width+midspacing, 0, label_width, but_height), spacing);
-        BuildVList right(this, Rect(but_width+midspacing+label_width, 0, but_width, but_height), spacing);
-        leftlabels.add (new Label(N_("Language: "), HALIGN_RIGHT));
-        leftlabels.add (new Label(N_("Fullscreen: "), HALIGN_RIGHT));
-        leftlabels.add (new Label(N_("Video mode: "), HALIGN_RIGHT));
-        leftlabels.add (new Label(N_("Gamma correction: "), HALIGN_RIGHT));
-        leftlabels.add (new Label(N_("Mouse speed: "), HALIGN_RIGHT));
-    
-        language = new LanguageButton(this);
-        left.add (language);
-        fullscreen = new FullscreenButton();
-        fullscreen->set_listener(this);
-        left.add (fullscreen);
-        videomode = new VideoModeButton();
-        left.add (videomode);
-        left.add (new GammaButton);
-        left.add (new MouseSpeedButton);
-    
-        rightlabels.add (new Label(N_("Sound volume: "), HALIGN_RIGHT));
-        rightlabels.add (new Label(N_("Sound set: "), HALIGN_RIGHT));
-        rightlabels.add (new Label(N_("Music volume: "), HALIGN_RIGHT));
-        rightlabels.add (new Label(N_("Stereo: "), HALIGN_RIGHT));
-        rightlabels.add (new Label(N_("Ratings update: "), HALIGN_RIGHT));
-    
-        right.add (new SoundVolumeButton);
-        right.add (new SoundSetButton);
-        right.add (new MusicVolumeButton);
-//        right.add (new InGameMusicButton);?ber
-        right.add (new StereoButton);
-        right.add (new RatingsUpdateButton);
+        video::VideoModes vm = vminfo->videomode;
+        video::VideoTileType vtt = vminfo->tt;
+        int vh = vminfo->area.x;
+        int vv = (vminfo->height - vminfo->area.h)/2;
+        static struct SpacingConfig {
+            int rows;
+            int button_height, optionb_width, commandb_width, pageb_width;
+            int vmargin, vrow_row;
+            int hmargin, hpage_option, hoption_option;
+        } param[] = {
+            {  // VTS_16 (320x240)
+                9,
+                17, 100, 70, 50,
+                7, 5,
+                10, 10, 10
+            },
+            {  // VTS_32 (640x480)
+                9,
+                30, 200, 140, 100,
+                15, 13,
+                20, 20, 20
+            },
+            {  // VTS_40 (800x600)
+                10,
+                35, 200, 140, 100,
+                20, 15,
+                15, 46, 15
+            },
+            {  // VTS_48 (960x720)  VM_1024x768
+                11,
+                35, 200, 140, 100,
+                30, 18,
+                70, 76, 20
+            },
+            {  // VTS_64 (1280x960)
+                11,
+                35, 200, 140, 100,
+                25, 20,
+                60, 58, 20
+            }
+        };
         
-        Rect l = left.pos();
-        Rect r = right.pos();
+        // These are exactly the same preferences as in LevelPackMenu.cc
+        // Left side: Availabe submenus ("pages")
+        pagesVList = new VList; 
+        pagesVList->set_spacing(param[vtt].vrow_row);
+        pagesVList->set_alignment(HALIGN_CENTER, VALIGN_TOP);
+        pagesVList->set_default_size(param[vtt].pageb_width, param[vtt].button_height);
+        but_main_options = new StaticTextButton(N_("Main"), this);
+        but_main_options->setHighlight(new_page == OPTIONS_MAIN);
+        but_video_options = new StaticTextButton(N_("Video"), this);
+        but_video_options->setHighlight(new_page == OPTIONS_VIDEO);
+        but_audio_options = new StaticTextButton(N_("Audio"), this);
+        but_audio_options->setHighlight(new_page == OPTIONS_AUDIO);
+        but_config_options = new StaticTextButton(N_("Config"), this);
+        but_config_options->setHighlight(new_page == OPTIONS_CONFIG);
+        pagesVList->add_back(but_main_options);
+        pagesVList->add_back(but_video_options);
+        pagesVList->add_back(but_audio_options);
+        pagesVList->add_back(but_config_options);
+        this->add(pagesVList, Rect(param[vtt].hmargin + vh,
+                                   param[vtt].vmargin + vv, 
+                                   param[vtt].pageb_width,
+                                   param[vtt].rows * param[vtt].button_height + 
+                                       (param[vtt].rows - 1) * param[vtt].vrow_row));
 
-        BuildVList bottomlabels (this, Rect(-label_width, Max(l.y, r.y), label_width, but_height), spacing);
-        BuildVList bottom (this, Rect(0, Max(l.y, r.y), vminfo->width - 2*hmargin - label_width, but_height), spacing);
-        bottomlabels.add (new Label(N_("User name: "), HALIGN_RIGHT));
-        bottomlabels.add (new Label(N_("User path: "), HALIGN_RIGHT));
-        bottomlabels.add (new Label(N_("User image path: "), HALIGN_RIGHT));
-        bottomlabels.add (new Label(N_("Menu music: "), HALIGN_RIGHT));
-        userNameTF = new TextField(app.state->getString("UserName"));
-        userNameTF->setMaxChars(20);
-        userNameTF->setInvalidChars("+");
-        bottom.add (userNameTF);
-        userPathTF = new TextField(XMLtoUtf8(LocalToXML(app.userPath.c_str()).x_str()).c_str());
-        bottom.add (userPathTF);
-        userImagePathTF = new TextField(XMLtoUtf8(LocalToXML(app.userImagePath.c_str()).x_str()).c_str());
-        bottom.add (userImagePathTF);
-        bottom.add (new MenuMusicButton);
+        // At the bottom: Currently only "Back"
+        commandHList = new HList;
+        commandHList->set_spacing(param[vtt].hoption_option);
+        commandHList->set_alignment(HALIGN_LEFT, VALIGN_TOP);
+        commandHList->set_default_size(param[vtt].commandb_width, param[vtt].button_height);
+        commandHList->add_back(back = new StaticTextButton(N_("Ok"), this));
+        this->add(commandHList, Rect(vminfo->width + vh - param[vtt].hmargin
+                                         - 1*param[vtt].commandb_width  // number of buttons
+                                         - 0*param[vtt].hoption_option, // number - 1
+                                     param[vtt].vmargin + param[vtt].rows*
+                                         (param[vtt].vrow_row + param[vtt].button_height)
+                                         + param[vtt].vrow_row + vv,
+                                     vminfo->width-2*param[vtt].hmargin,
+                                     param[vtt].button_height));
 
-//            add (m_restartinfo, Rect (l.x, l.y + 15, 400, 20));
-//            m_restartinfo->set_alignment (HALIGN_LEFT);
-//            update_info();
-    
-        Rect b = bottom.pos();
-        l.x = (l.x+r.x)/2;
-        l.y = b.y+big_spacing;
-    
-        add(back, l);
+        optionsVList = new VList;
+        optionsVList->set_spacing(param[vtt].vrow_row);
+        optionsVList->set_alignment(HALIGN_LEFT, VALIGN_TOP);
+        optionsVList->set_default_size(2*param[vtt].optionb_width
+                                           + param[vtt].hoption_option,
+                                       param[vtt].button_height);
+
+        /*! All options on our pages consist of a label and a button,
+          a very long (text-)button, or just a label, suited to the
+          long buttons. optionsVList is a list of such rows.
+          Each row itself is an HList, and has to be initialised
+          with positioning data. To make things easier, we use
+          Macros for initialisation. */
+
+        HList *lb;  // a list of labels and/or buttons
+
+#define OPTIONS_NEW_L(label) lb = new HList;\
+        lb->set_spacing(param[vtt].hoption_option); \
+        lb->set_alignment(HALIGN_LEFT, VALIGN_TOP); \
+        lb->set_default_size(param[vtt].optionb_width, \
+                             param[vtt].rows*param[vtt].button_height + \
+                                 (param[vtt].rows - 1) * param[vtt].vrow_row); \
+        lb->add_back(new Label(N_(label), HALIGN_LEFT, VALIGN_BOTTOM)); \
+        optionsVList->add_back(lb); \
+// end define
+#define OPTIONS_NEW_LB(label,button) lb = new HList;\
+        lb->set_spacing(param[vtt].hoption_option); \
+        lb->set_alignment(HALIGN_CENTER, VALIGN_TOP); \
+        lb->set_default_size(param[vtt].optionb_width, \
+                             param[vtt].rows*param[vtt].button_height + \
+                                 (param[vtt].rows - 1) * param[vtt].vrow_row); \
+        lb->add_back(new Label(N_(label), HALIGN_RIGHT, VALIGN_CENTER)); \
+        lb->add_back(button); \
+        optionsVList->add_back(lb); \
+// end define
+#define OPTIONS_NEW_T(textbutton) lb = new HList;\
+        lb->set_spacing(param[vtt].hoption_option); \
+        lb->set_alignment(HALIGN_LEFT, VALIGN_TOP); \
+        lb->set_default_size(2*param[vtt].optionb_width + param[vtt].hoption_option, \
+                             param[vtt].rows*param[vtt].button_height + \
+                                 (param[vtt].rows - 1) * param[vtt].vrow_row); \
+        lb->add_back(textbutton); \
+        optionsVList->add_back(lb); \
+// end define
+
+        switch (new_page) {
+            case OPTIONS_MAIN:
+                OPTIONS_NEW_LB("Language: ", language = new LanguageButton(this))
+                OPTIONS_NEW_LB("Fullscreen: ", fullscreen = new FullscreenButton(this))
+                OPTIONS_NEW_LB("Video mode: ", videomode = new VideoModeButton())
+                OPTIONS_NEW_LB("Mouse speed: ", new MouseSpeedButton())
+                OPTIONS_NEW_LB("Sound volume: ", new SoundVolumeButton())
+                OPTIONS_NEW_LB("Music volume: ", new MusicVolumeButton())
+                OPTIONS_NEW_LB("Ratings update: ", new RatingsUpdateButton())
+                userNameTF = new TextField(app.state->getString("UserName"));
+                userNameTF->setMaxChars(20);
+                userNameTF->setInvalidChars("+");
+                OPTIONS_NEW_L("User name: ")
+                OPTIONS_NEW_T(userNameTF)
+                break;
+            case OPTIONS_VIDEO:
+                OPTIONS_NEW_LB("Fullscreen: ", fullscreen = new FullscreenButton())
+                fullscreen->set_listener(this);
+                OPTIONS_NEW_LB("Video mode: ", videomode = new VideoModeButton())
+                OPTIONS_NEW_LB("Gamma correction: ", new GammaButton())
+                break;
+            case OPTIONS_AUDIO:
+                OPTIONS_NEW_LB("Sound set: ", new SoundSetButton())
+                OPTIONS_NEW_LB("Menu music: ", new MenuMusicButton)
+                OPTIONS_NEW_LB("Sound volume: ", new SoundVolumeButton())
+                OPTIONS_NEW_LB("Music volume: ", new MusicVolumeButton())
+                OPTIONS_NEW_LB("Stereo: ", new StereoButton())
+                //...("Music ingame: ", new InGameMusicButton)
+                break;
+            case OPTIONS_CONFIG:
+                OPTIONS_NEW_LB("Language: ", language = new LanguageButton(this))
+                OPTIONS_NEW_LB("Mouse speed: ", new MouseSpeedButton())
+                OPTIONS_NEW_LB("Ratings update: ", new RatingsUpdateButton())
+                userNameTF = new TextField(app.state->getString("UserName"));
+                userNameTF->setMaxChars(20);
+                userNameTF->setInvalidChars("+");
+                OPTIONS_NEW_L("User name: ")
+                OPTIONS_NEW_T(userNameTF)
+                //...("Text speed: ", new TextSpeedButton())
+                userPathTF = new TextField(XMLtoUtf8(LocalToXML(app.userPath.c_str()).x_str()).c_str());
+                OPTIONS_NEW_L("User path: ")
+                OPTIONS_NEW_T(userPathTF)
+                userImagePathTF = new TextField(XMLtoUtf8(LocalToXML(app.userImagePath.c_str()).x_str()).c_str());
+                OPTIONS_NEW_L("User image path: ")
+                OPTIONS_NEW_T(userImagePathTF)
+                break;
+        }
+#undef OPTIONS_NEW_L
+#undef OPTIONS_NEW_LB
+#undef OPTIONS_NEW_T
+
+        // Now add all options to the page.
+        this->add(optionsVList,
+           Rect(param[vtt].hmargin + vh + param[vtt].pageb_width
+                    + param[vtt].hpage_option,
+                param[vtt].vmargin + vv,
+                2*param[vtt].optionb_width + param[vtt].hoption_option,
+                param[vtt].rows * param[vtt].button_height + 
+                    (param[vtt].rows - 1) * param[vtt].vrow_row));
+        invalidate_all();
     }
     
-    OptionsMenu::~OptionsMenu() {
-        video::SetCaption(previous_caption.c_str());
+    void OptionsMenu::close_page() {
+        // Reset active and key_focus widgets, they will be deleted soon,
+        // and we don't want any ticks for them anymore.
+        reset_active_widget();
+        reset_key_focus_widget();
+        // Evaluate and save text field entries (if existing).
+        if(userNameTF) {
+            if (app.state->getString("UserName") != userNameTF->getText())
+                // ensure that enigma.score is saved with new Username or to new location
+                lev::ScoreManager::instance()->markModified();
+            // strip off leading and trailing whitespace from user name
+            std::string userName = userNameTF->getText();
+            std::string::size_type firstChar = userName.find_first_not_of(" ");
+            std::string::size_type lastChar = userName.find_last_not_of(" ");
+            if (firstChar != std::string::npos)
+                app.state->setProperty("UserName", userName.substr(firstChar, lastChar - firstChar + 1));
+            else
+                app.state->setProperty("UserName", std::string(""));
+        }
+        if(userPathTF) {
+            std::string tfUserPathLocal = XMLtoLocal(Utf8ToXML(userPathTF->getText().c_str()).x_str()).c_str();
+            if (app.userPath != tfUserPathLocal)
+                // ensure that enigma.score is saved with new Username or to new location
+                lev::ScoreManager::instance()->markModified();
+            app.setUserPath(tfUserPathLocal.c_str());
+        }
+        if(userImagePathTF) {
+            std::string tfUserImageLocal = XMLtoLocal(Utf8ToXML(userImagePathTF->getText().c_str()).x_str()).c_str();
+            if (app.userImagePath != tfUserImageLocal)
+                // ensure that enigma.score is saved with new Username or to new location
+                lev::ScoreManager::instance()->markModified();
+            app.setUserImagePath(tfUserImageLocal.c_str());
+        }
+        // Delete widgets.
+        if (pagesVList != NULL) {
+            pagesVList->clear();
+            remove_child(pagesVList);
+            delete pagesVList;
+            pagesVList = NULL;
+        }
+        but_main_options = NULL;
+        but_video_options = NULL;
+        but_audio_options = NULL;
+        but_config_options = NULL;
+        if (commandHList != NULL) {
+            commandHList->clear();
+            remove_child(commandHList);
+            delete commandHList;
+            commandHList = NULL;
+        }
+        back = NULL;
+        if (optionsVList != NULL) {
+            optionsVList->clear();
+            remove_child(optionsVList);
+            delete optionsVList;
+            optionsVList = NULL;
+        }
+        language = NULL;
+        fullscreen = NULL;
+        videomode = NULL;
+        menuMusicTF = NULL;
+        userNameTF = NULL;
+        userPathTF = NULL;
+        userImagePathTF = NULL;
     }
-    
-//    void OptionsMenu::update_info() 
-//    {
-//        if (options::MustRestart)
-//            m_restartinfo->set_text (
-//                N_("Please restart Enigma to activate your changes!"));
-//        else
-//            m_restartinfo->set_text ("");
-//    }
-    
+
     void OptionsMenu::quit() {
-        std::string tfUserPathLocal = XMLtoLocal(Utf8ToXML(userPathTF->getText().c_str()).x_str()).c_str();
-        std::string tfUserImageLocal = XMLtoLocal(Utf8ToXML(userImagePathTF->getText().c_str()).x_str()).c_str();
-        if ((app.state->getString("UserName") != userNameTF->getText())
-                || (app.userPath != tfUserPathLocal ) || (app.userImagePath != tfUserImageLocal)) {
-            // ensure that enigma.score is saved with new Username or to new location
-            lev::ScoreManager::instance()->markModified();
-        }
-        // strip off leading and trailing whitespace from user name
-        std::string userName = userNameTF->getText();
-        std::string::size_type firstChar = userName.find_first_not_of(" ");
-        std::string::size_type lastChar = userName.find_last_not_of(" ");
-        if (firstChar != std::string::npos)
-            app.state->setProperty("UserName", userName.substr(firstChar, lastChar - firstChar + 1));
-        else
-            app.state->setProperty("UserName", std::string(""));
-        app.setUserPath(tfUserPathLocal.c_str());
-        app.setUserImagePath(tfUserImageLocal.c_str());
+        close_page();
         Menu::quit();
     }
 
@@ -459,14 +627,21 @@
             // update the video mode button to the modes available
             videomode->reinit();
             invalidate_all();
+        } else if (w == but_main_options) {
+            close_page();
+            open_page(OPTIONS_MAIN);
+        } else if (w == but_video_options) {
+            close_page();
+            open_page(OPTIONS_VIDEO);
+        } else if (w == but_audio_options) {
+            close_page();
+            open_page(OPTIONS_AUDIO);
+        } else if (w == but_config_options) {
+            close_page();
+            open_page(OPTIONS_CONFIG);
         }
     }
     
-    void OptionsMenu::tick (double)
-    {
-//        update_info();
-    }
-    
     void OptionsMenu::draw_background(ecl::GC &gc)
     {
         const video::VMInfo *vminfo = video::GetInfo();
@@ -481,7 +656,6 @@
         if (background == 0)
             background = enigma::GetImage("menu_bg", ".jpg");
         OptionsMenu m(background);
-        m.center();
         m.manage();
     }
 

Modified: trunk/src/gui/OptionsMenu.hh
===================================================================
--- trunk/src/gui/OptionsMenu.hh	2008-04-25 00:57:57 UTC (rev 1110)
+++ trunk/src/gui/OptionsMenu.hh	2008-04-25 23:38:53 UTC (rev 1111)
@@ -32,34 +32,45 @@
         OptionsMenu(ecl::Surface *background_);
         ~OptionsMenu();
         virtual void quit();
+
     private:
-        void update_info();
-
         // ActionListener interface.
         bool on_event (const SDL_Event &e);
         void on_action(gui::Widget *w);
-
+        
         // Menu interface.
         void draw_background(ecl::GC &gc);
-        void tick(double dtime);
+        void tick(double dtime) {}
 
+        // Page structure.
+        enum OptionsPage { OPTIONS_MAIN, OPTIONS_VIDEO, OPTIONS_AUDIO, OPTIONS_CONFIG };
+        void open_page(OptionsPage new_page);
+        void close_page();
+
         // Variables.
+        VList *pagesVList;
+        HList *commandHList;
+        VList *optionsVList;
         gui::Widget *back, *language;
+        gui::StaticTextButton *but_main_options;
+        gui::StaticTextButton *but_video_options;
+        gui::StaticTextButton *but_audio_options;
+        gui::StaticTextButton *but_config_options;
         gui::BoolOptionButton *fullscreen;
         gui::VideoModeButton *videomode;
         gui::TextField *userNameTF;
         gui::TextField *userPathTF;
         gui::TextField *userImagePathTF;
         gui::TextField *menuMusicTF;
-        gui::Label  *m_restartinfo;
         ecl::Surface *background;
         std::string  previous_caption;
     };
 
 /* -------------------- Options Buttons -------------------- */
 
-    struct FullscreenButton : public BoolOptionButton {
-        FullscreenButton();
+    class FullscreenButton : public BoolOptionButton {
+    public:
+        FullscreenButton(ActionListener *al = 0);
     };
 
 
@@ -105,8 +116,7 @@
         ActionListener *myListener;
     public:
         // second user action listener: first one is misused by ValueButton 
-        LanguageButton (ActionListener *al = 0);
-        
+        LanguageButton (ActionListener *al = 0);        
     };
 
     class GammaButton : public ValueButton {
@@ -114,8 +124,7 @@
         void set_value(int value);
         std::string get_text(int value) const;
     public:
-        GammaButton ();
-        
+        GammaButton ();        
     };
     
 /* -------------------- Functions -------------------- */



From ral at mail.berlios.de  Sat Apr 26 21:19:53 2008
From: ral at mail.berlios.de (ral at BerliOS)
Date: Sat, 26 Apr 2008 21:19:53 +0200
Subject: [Enigma-game-svn] r1112 - in trunk: doc/reference etc src
Message-ID: <200804261919.m3QJJrl9011868@sheep.berlios.de>

Author: ral
Date: 2008-04-26 21:19:52 +0200 (Sat, 26 Apr 2008)
New Revision: 1112

Modified:
   trunk/doc/reference/enigma-ref.texi
   trunk/etc/mingw32-dist.sh.in
   trunk/src/Makefile.am
Log:
Trunk 1.1:
- finish r1103: Win and Mac distribution
- finish r1109: Win and Mac distribution
- refman new API additions

Modified: trunk/doc/reference/enigma-ref.texi
===================================================================
--- trunk/doc/reference/enigma-ref.texi	2008-04-25 23:38:53 UTC (rev 1111)
+++ trunk/doc/reference/enigma-ref.texi	2008-04-26 19:19:52 UTC (rev 1112)
@@ -3341,6 +3341,36 @@
 
 Read API Concept Draft
 
+ at menu
+* Lua Example:: 
+* Enigma Lua Types::   
+* Object Definitions and Tiles::
+* Lua Positions::
+ at end menu
+
+ at c ----------------- Lua Example -------------------- 
+
+ at node Lua Example
+ at section Lua Example
+
+ at c ----------------- Enigma Lua Types -------------------- 
+
+ at node Enigma Lua Types
+ at section Enigma Lua Types
+
+
+
+ at c -------------- Object Definitions and Tiles ----------------- 
+
+ at node Object Definitions and Tiles
+ at section Object Definitions and Tiles
+
+ at c ----------------- Lua Positions -------------------- 
+
+ at node Lua Positions
+ at section Lua Positions
+
+
 @c ===================  Commons  =======================
 @node Common Attributes and Messages
 @chapter Common Attributes and Messages
@@ -3493,12 +3523,29 @@
 @section Global Attributes
 
 @menu
+* IsDifficult:: 
 * MagnetRange:: 
 * MagnetStrength:: 
 * WormholeRange:: 
 * WormholeStrength:: 
 @end menu
 
+ at node IsDifficult
+ at subsection IsDifficult
+
+A global read only variable that defines the current diffculty mode selected
+by the user. All differences of easy and difficult mode within the level should
+be coded solely in dependence of this flag. A level that supports an easy mode
+the author needs to declare it in the XML header in the element @ref{<modes>}.
+
+ at table @asis
+ at item @b{Type:} @ @ bool
+ at item @b{Values:} @ @ @code{true}, @code{false}
+ at item @b{Default:} @ @ @code{true}
+ at item @b{Access:} @ @ read only
+ at item @b{Support:} @ @ object independent
+ at end table
+
 @node MagnetRange
 @subsection MagnetRange
 
@@ -3578,12 +3625,14 @@
 @menu
 * it_blocker::         Shrinked Blocker Stone
 * it_brush::           
+* it_cross::           Floor switch for patient Actors
 * it_coin::            Enigma's currency
 * it_extralife::
 * it_floppy::          
 * it_hammer::
 * it_key::             
 * it_magnet::
+* it_sensor::          Floor Switch for passing Actors
 * it_sword::
 * it_trigger::         Floor Switch for Actors and Stones
 * it_umbrella::        Death Protection Item
@@ -3678,6 +3727,7 @@
 @subsection it_brush
 @obindex it_brush
 
+TBD
 
 @table @asis
 
@@ -3733,6 +3783,40 @@
 
 @end table
 
+ at c ----------------- Cross Item -------------------- 
+ at node it_cross
+ at subsection it_cross
+ at obindex it_cross
+
+An eye-catching cross spot that can detect actors staying on it for a given
+time. When an actor remains on top of the cross for the given @samp{interval}
+without any other actor leaving or passing the cross grid the cross will perform
+its action. Similar, but instant sensors for actors are @ref{it_sensor} and
+ at ref{it_trigger}
+
+A cross can be drawn with an @ref{it_pencil} and it can be removed with an
+ at ref{it_brush}.
+
+ at table @asis
+ at item @b{Attributes:}
+
+ at table @asis
+ at item @b{state}, @ @ @i{values}: @code{0}, @code{1}; @ @ @i{access}: @code{read only} @ @ @xref{state}
+The current state - @samp{0} for the last event being an actor leaving the cross,
+ at samp{1} for the last event being an actor entering the cross.
+
+ at item @b{interval} @ @ @i{values}: positive number; @ @ @i{default}: @code{10.0}
+Number of seconds that the actor must stay on the sensor to cause an action.
+
+ at end table
+
+ at item @b{Messages:} none
+
+ at item @b{Action:} @ @ @xref{target}, @ @ @xref{action}
+
+ at end table
+
+
 @c ----------------- Extralife Item -------------------- 
 @node it_extralife
 @subsection it_extralife
@@ -3886,6 +3970,45 @@
 
 @end table
 
+ at c ----------------- Sensor Item -------------------- 
+ at node it_sensor
+ at subsection it_sensor
+ at obindex it_sensor
+
+The sensor item is a switch on top of a floor that reacts on actors passing it.
+It just performs actions on actors entering the sensors grid. It will
+send an action value of @samp{true} but of course the @ref{inverse} attribute
+can be used to send an action value of @samp{false} instead.
+
+Any actors passing the grid, either on the floor or jumping over it will be
+detected.
+
+Sensors do not cause any noise. Visible sensors will nevertheless flash on
+passing actors. You can make the trigger invisible by setting its attribute. 
+Be aware that the user will still notice that actors cannot drop items onto the
+same grid position.
+
+Alternative objects that reacts on actors are @ref{it_trigger} and 
+ at ref{it_cross}.
+
+ at table @asis
+ at item @b{Attributes:}
+
+ at table @asis
+
+ at item @b{invisible} @ @ @i{values}: @code{true}, @code{false}; @ @ @i{default}: @code{false}
+An invisible sensor is totally transparent. But the user may notice it, as actors
+cannot drop items onto the same grid position.
+
+ at end table
+
+ at item @b{Messages:} none
+
+ at item @b{Action:} @ @ @xref{target}, @ @ @xref{action}
+
+ at end table
+
+
 @c ----------------- Sword Item -------------------- 
 @node it_sword
 @subsection it_sword

Modified: trunk/etc/mingw32-dist.sh.in
===================================================================
--- trunk/etc/mingw32-dist.sh.in	2008-04-25 23:38:53 UTC (rev 1111)
+++ trunk/etc/mingw32-dist.sh.in	2008-04-26 19:19:52 UTC (rev 1112)
@@ -81,14 +81,17 @@
 	mkdir $DDIR/data/$folder; 
 	cp -p $SDIR/data/$folder/*.{png,jpg} $DDIR/data/$folder
     done
+    mkdir $DDIR/data/gfx/flags25x15
+    cp -p $SDIR/data/gfx/flags25x15/*.png $DDIR/data/gfx/flags25x15
     mkdir $DDIR/data/schemas
     cplffiles data/schemas data/schemas xsd
     cplffiles data/schemas data/schemas xml
     copy_levels
     mkdir $DDIR/data/fonts
     cp -p $SDIR/data/fonts/*.{bmf,png,txt,ttf} $DDIR/data/fonts
-    mkdir $DDIR/data/sound
-    cp -p $SDIR/data/sound/*.{ogg,s3m} $DDIR/data/sound
+    mkdir $DDIR/data/music
+    mkdir $DDIR/data/music/menu
+    cp -p $SDIR/data/music/menu/*.{ogg,s3m} $DDIR/data/music/menu
     mkdir $DDIR/data/soundsets 
     mkdir $DDIR/data/soundsets/enigma 
     cp -p $SDIR/data/soundsets/enigma/*.wav $DDIR/data/soundsets/enigma

Modified: trunk/src/Makefile.am
===================================================================
--- trunk/src/Makefile.am	2008-04-25 23:38:53 UTC (rev 1111)
+++ trunk/src/Makefile.am	2008-04-26 19:19:52 UTC (rev 1112)
@@ -292,6 +292,8 @@
 	cp $(top_builddir)/data/*.xml $(bundle_name)/Contents/Resources/data/
 	mkdir -p $(bundle_name)/Contents/Resources/data/gfx
 	cp $(top_builddir)/data/gfx/*.png $(bundle_name)/Contents/Resources/data/gfx
+	mkdir -p $(bundle_name)/Contents/Resources/data/gfx/flags25x15
+	cp $(top_builddir)/data/gfx/flags25x15/*.png $(bundle_name)/Contents/Resources/data/gfx/flags25x15
 	mkdir -p $(bundle_name)/Contents/Resources/data/gfx32
 	cp $(top_builddir)/data/gfx32/*.png $(bundle_name)/Contents/Resources/data/gfx32
 	cp $(top_builddir)/data/gfx32/*.jpg $(bundle_name)/Contents/Resources/data/gfx32
@@ -304,8 +306,10 @@
 	mkdir -p $(bundle_name)/Contents/Resources/data/schemas
 	cp $(top_builddir)/data/schemas/*.xml $(bundle_name)/Contents/Resources/data/schemas
 	cp $(top_builddir)/data/schemas/*.xsd $(bundle_name)/Contents/Resources/data/schemas
-	mkdir -p $(bundle_name)/Contents/Resources/data/sound
-	cp $(top_builddir)/data/sound/*.s3m $(bundle_name)/Contents/Resources/data/sound
+	mkdir -p $(bundle_name)/Contents/Resources/data/music
+	mkdir -p $(bundle_name)/Contents/Resources/data/music/menu
+	cp $(top_builddir)/data/music/menu/*.s3m $(bundle_name)/Contents/Resources/data/music/menu
+	cp $(top_builddir)/data/music/menu/*.ogg $(bundle_name)/Contents/Resources/data/music/menu
 	mkdir -p $(bundle_name)/Contents/Resources/data/soundsets
 	mkdir -p $(bundle_name)/Contents/Resources/data/soundsets/enigma
 	cp $(top_builddir)/data/soundsets/enigma/*.wav $(bundle_name)/Contents/Resources/data/soundsets/enigma



From ral at mail.berlios.de  Sat Apr 26 23:01:34 2008
From: ral at mail.berlios.de (ral at BerliOS)
Date: Sat, 26 Apr 2008 23:01:34 +0200
Subject: [Enigma-game-svn] r1113 - in trunk: data data/schemas src
Message-ID: <200804262101.m3QL1YuS019761@sheep.berlios.de>

Author: ral
Date: 2008-04-26 23:01:32 +0200 (Sat, 26 Apr 2008)
New Revision: 1113

Modified:
   trunk/data/api1init.lua
   trunk/data/schemas/objects.xml
   trunk/src/items.cc
   trunk/src/world.cc
Log:
Trunk 1.1: 
- fix crashes on world initialization on scrambleIntensity init:
  - now it is initialized via api1init.lua
  - api 2 defaults temporarily to 10 independent of difficulty 
- message "brush" is now an internal message named "_brush"


Modified: trunk/data/api1init.lua
===================================================================
--- trunk/data/api1init.lua	2008-04-26 19:19:52 UTC (rev 1112)
+++ trunk/data/api1init.lua	2008-04-26 21:01:32 UTC (rev 1113)
@@ -504,6 +504,11 @@
     -- do nothing by default
 end
 
+if difficult then
+    enigma.SetScrambleIntensity(10)
+else
+    enigma.SetScrambleIntensity(3)
+end
 
 ----------------------
 -- Global variables --

Modified: trunk/data/schemas/objects.xml
===================================================================
--- trunk/data/schemas/objects.xml	2008-04-26 19:19:52 UTC (rev 1112)
+++ trunk/data/schemas/objects.xml	2008-04-26 21:01:32 UTC (rev 1113)
@@ -35,7 +35,6 @@
   <messages>
     <msg name="close" type="nil"/>
     <msg name="closeall" type="nil"/>
-    <msg name="brush" type="nil"/>
     <msg name="hit" type="object"/>
     <msg name="inner_pull" type="dir"/>
     <msg name="off" type="nil"/>
@@ -48,6 +47,7 @@
     <msg name="turn" type="nil"/>
     <msg name="turnback" type="nil"/>
     <msg name="_bombstone" type="nil"/>
+    <msg name="_brush" type="nil"/>
     <msg name="_explosion" type="nil"/>
     <msg name="_hit" type="object"/>
     <msg name="_init" type="nil"/>
@@ -100,7 +100,7 @@
     <object name="it_cross">
       <attr name="interval" default="10"/>
       <attr name="state" rw="r"/>
-      <msg name="brush"/>
+      <msg name="_brush"/>
       <msg name="signal"/>
     </object>
     <object name="it_extralife"/>

Modified: trunk/src/items.cc
===================================================================
--- trunk/src/items.cc	2008-04-26 19:19:52 UTC (rev 1112)
+++ trunk/src/items.cc	2008-04-26 21:01:32 UTC (rev 1113)
@@ -238,7 +238,7 @@
 
         virtual Value message (const Message &m) {
             if (enigma_server::GameCompatibility == GAMET_ENIGMA) {
-                if (m.message == "brush") {
+                if (m.message == "_brush") {
                     KillItem(this->get_pos());
                     return Value();
                 }
@@ -607,7 +607,7 @@
 
         virtual Value message (const Message &m) {
             if (enigma_server::GameCompatibility == GAMET_ENIGMA) {
-                if (m.message == "brush") {
+                if (m.message == "_brush") {
                     KillItem(this->get_pos());
                     return Value();
                 }
@@ -640,7 +640,7 @@
     
     ItemAction Brush::activate(Actor *a, GridPos p) {
         if (Item *it = GetItem(p))
-            SendMessage (it, "brush");
+            SendMessage (it, "_brush");
         return ITEM_DROP;
     }
     
@@ -2703,7 +2703,7 @@
         state = FIREPROOF;
         init_model();
         return Value();
-    } else if (m.message == "brush" && (state == ASH || state == FIREPROOF)) {
+    } else if (m.message == "_brush" && (state == ASH || state == FIREPROOF)) {
         kill();   // The brush cleans the floor
         return Value();
     } else if (Floor *fl = GetFloor(get_pos())) {
@@ -3476,7 +3476,7 @@
                 return Value();
             }
         } else if (enigma_server::GameCompatibility == GAMET_ENIGMA) {
-            if (m.message == "brush") {
+            if (m.message == "_brush") {
                 KillItem(this->get_pos());
                 return Value();
             }

Modified: trunk/src/world.cc
===================================================================
--- trunk/src/world.cc	2008-04-26 19:19:52 UTC (rev 1112)
+++ trunk/src/world.cc	2008-04-26 21:01:32 UTC (rev 1113)
@@ -300,11 +300,11 @@
 
 World::World(int ww, int hh) : fields(ww,hh), preparing_level(true),
         leftmost_actor (NULL), rightmost_actor (NULL), numMeditatists (0), 
-        indispensableHollows (0), engagedIndispensableHollows(0), engagedDispensableHollows (0) {
+        indispensableHollows (0), engagedIndispensableHollows(0), engagedDispensableHollows (0),
+        scrambleIntensity(10) // difficult default
+        {
     w = ww;
     h = hh;
-
-    scrambleIntensity = server::GetDifficulty() == DIFFICULTY_EASY ? 3 : 10;
 }
 
 World::~World()



From andreasl at mail.berlios.de  Mon Apr 28 00:27:45 2008
From: andreasl at mail.berlios.de (andreasl at BerliOS)
Date: Mon, 28 Apr 2008 00:27:45 +0200
Subject: [Enigma-game-svn] r1114 - in trunk: data/gfx/flags25x15
	data/music/menu data/schemas src src/gui
Message-ID: <200804272227.m3RMRj2q012197@sheep.berlios.de>

Author: andreasl
Date: 2008-04-28 00:27:43 +0200 (Mon, 28 Apr 2008)
New Revision: 1114

Modified:
   trunk/data/gfx/flags25x15/Makefile.am
   trunk/data/music/menu/Makefile.am
   trunk/data/schemas/state.xml
   trunk/src/SoundEngine.cc
   trunk/src/SoundEngine.hh
   trunk/src/display.cc
   trunk/src/display.hh
   trunk/src/gui/OptionsMenu.cc
   trunk/src/gui/OptionsMenu.hh
   trunk/src/options.cc
   trunk/src/options.hh
Log:
Trunk:
 - Fix even more of r1103 and r1109: Install language flags
   and menu music into correct directories under Linux.
Options restructuring:
 - new page "Paths"
 - text speed button (1..20, default 8, based in display.cc/hh)
 - moved "UpdateVolume" from options.cc/hh to SoundEngine
 - small adjustments to spacing in options menu


Modified: trunk/data/gfx/flags25x15/Makefile.am
===================================================================
--- trunk/data/gfx/flags25x15/Makefile.am	2008-04-26 21:01:32 UTC (rev 1113)
+++ trunk/data/gfx/flags25x15/Makefile.am	2008-04-27 22:27:43 UTC (rev 1114)
@@ -1,3 +1,3 @@
-pkgdatadir = $(datadir)/@PACKAGE@/flags25x15
+pkgdatadir = $(datadir)/@PACKAGE@/gfx/flags25x15
 pkgdata_DATA = $(wildcard $(srcdir)/*.png $(srcdir)/*.jpg $(srcdir)/*.txt)
 EXTRA_DIST = $(pkgdata_DATA)

Modified: trunk/data/music/menu/Makefile.am
===================================================================
--- trunk/data/music/menu/Makefile.am	2008-04-26 21:01:32 UTC (rev 1113)
+++ trunk/data/music/menu/Makefile.am	2008-04-27 22:27:43 UTC (rev 1114)
@@ -1,4 +1,4 @@
-pkgdatadir = $(datadir)/@PACKAGE@/menu
+pkgdatadir = $(datadir)/@PACKAGE@/music/menu
 pkgdata_DATA = menu.s3m \
                esprit.ogg
 

Modified: trunk/data/schemas/state.xml
===================================================================
--- trunk/data/schemas/state.xml	2008-04-26 21:01:32 UTC (rev 1113)
+++ trunk/data/schemas/state.xml	2008-04-27 22:27:43 UTC (rev 1114)
@@ -6,6 +6,7 @@
     <property key="NextLevelMode" value="0"/>
     <property key="Difficulty" value="1"/>
     <property key="RatingsUpdateTime" value="2006-03-31T20:20:00Z"/>
+    <property key="TextSpeed" value="8"/>
   </properties>
   <groups>
     <group title="Enigma" curindex="Tutorial" curcolumn="0"/>

Modified: trunk/src/SoundEngine.cc
===================================================================
--- trunk/src/SoundEngine.cc	2008-04-26 21:01:32 UTC (rev 1113)
+++ trunk/src/SoundEngine.cc	2008-04-27 22:27:43 UTC (rev 1114)
@@ -54,7 +54,7 @@
     }
 
     if (sound_engine->init()) {
-        options::UpdateVolume();
+        sound::UpdateVolume();
     }
     else {
         sound_enabled = false;
@@ -196,6 +196,12 @@
     music_mute = (vol == 0.0);
 }
 
+void sound::UpdateVolume() 
+{
+    sound::SetSoundVolume(options::GetDouble("SoundVolume"));
+    sound::SetMusicVolume(options::GetDouble("MusicVolume"));
+}
+
 
 /* -------------------- SoundEngine_SDL implementation -------------------- */
 

Modified: trunk/src/SoundEngine.hh
===================================================================
--- trunk/src/SoundEngine.hh	2008-04-26 21:01:32 UTC (rev 1113)
+++ trunk/src/SoundEngine.hh	2008-04-27 22:27:43 UTC (rev 1114)
@@ -40,12 +40,12 @@
     void Init();
     void Shutdown();
 
-    void Tick (double dtime);
+    void Tick(double dtime);
 
     void DisableSound();
     void EnableSound();
     void DisableMusic();
-    bool PlayMusic (const string &name, double position = 0.0);
+    bool PlayMusic(const string &name, double position = 0.0);
     void FadeoutMusic();
 
     /*! Stop any music currently playing. */
@@ -58,15 +58,19 @@
     bool IsMusicMute();
 
     void SetListenerPosition (const ecl::V2 &pos);
-    bool PlaySound (const SoundName &, const ecl::V2 &pos,
+    bool PlaySound(const SoundName &, const ecl::V2 &pos,
                     double relative_volume = 1.0, int priority=0);
-    bool PlaySoundGlobal (const SoundName &, double relative_volume = 1.0, int priority=0);
+    bool PlaySoundGlobal(const SoundName &, double relative_volume = 1.0, int priority=0);
     
     void ClearCache();
     void CacheSound(const SoundEffect &s);
-    void SetSoundVolume (double vol);
-    void SetMusicVolume (double vol);
+    void SetSoundVolume(double vol);
+    void SetMusicVolume(double vol);
 
+    /*! Set the sound and music volume to the values in SoundVolume
+      and MusicVolume. */
+    void UpdateVolume();
+
 /* -------------------- SoundEngine -------------------- */
 
     class SoundEngine {

Modified: trunk/src/display.cc
===================================================================
--- trunk/src/display.cc	2008-04-26 21:01:32 UTC (rev 1113)
+++ trunk/src/display.cc	2008-04-27 22:27:43 UTC (rev 1114)
@@ -303,13 +303,17 @@
   changedp(false), finishedp(true),
   pingpong (false),
   showscroll(false),
-  xoff(0), scrollspeed(200),
+  xoff(0), scrollspeed(DEFAULT_TextSpeed * FACTOR_TextSpeed),
   textsurface(0), font(f)
 {
     const video::VMInfo *vminfo = video::GetInfo();
     area = vminfo->sb_textarea;
-
     time = maxtime = 0;
+    // Note: "scrollspeed" is not yet initialised with
+    //   display::GetTextSpeed() * FACTOR_TextSpeed but a
+    //   default value instead, because Application State
+    //   Manager has not been initialised at this point
+    //   yet: This would crash.
 }
 
 void TextDisplay::set_text (const string &t, bool scrolling, double duration) 
@@ -323,7 +327,7 @@
     if (scrolling) {
         if (duration <= 0) {
             xoff = -area.w;
-            scrollspeed = 160;
+            scrollspeed = display::GetTextSpeed() * FACTOR_TextSpeed;
         } else {
             // Showscroll mode: first show string then scoll it out
             showscroll = true;
@@ -366,7 +370,7 @@
     if (time > maxtime) {
         if (showscroll) {
             showscroll = false;
-            scrollspeed = 160;            
+            scrollspeed = display::GetTextSpeed() * FACTOR_TextSpeed;
             maxtime = 1e20;       // "infinite" for all practical purposes
         } else {
             finishedp = true;
@@ -2188,3 +2192,18 @@
 {
     return gamedpy->add_line (p1, p2);
 }
+
+void display::SetTextSpeed(int newspeed) {
+    int speed = ecl::Clamp<int>(newspeed, MIN_TextSpeed, MAX_TextSpeed);
+    app.state->setProperty("TextSpeed", speed);
+}
+
+int display::GetTextSpeed() {
+    int speed = app.state->getInt("TextSpeed");
+    if(speed == 0) {
+        // Text Speed has not been set yet. Use default.
+        SetTextSpeed(DEFAULT_TextSpeed);
+        return DEFAULT_TextSpeed;
+    } else
+        return speed;
+}

Modified: trunk/src/display.hh
===================================================================
--- trunk/src/display.hh	2008-04-26 21:01:32 UTC (rev 1113)
+++ trunk/src/display.hh	2008-04-27 22:27:43 UTC (rev 1114)
@@ -214,6 +214,13 @@
 #define STATUSBAR display::GetStatusBar()
 
 
+/* -------------------- Constants -------------------- */
+
+    const int MIN_TextSpeed = 1;
+    const int MAX_TextSpeed = 20;
+    const int DEFAULT_TextSpeed = 8;
+    const int FACTOR_TextSpeed = 20;  // Multiplicative factor for text speed
+
 /* -------------------- Interface to display engine -------------------- */
 
     enum DisplayFlags
@@ -242,6 +249,9 @@
     void RedrawAll (ecl::Screen *sfc);
     void Redraw (ecl::Screen *sfc);
     void Tick (double dtime);
+
+    void SetTextSpeed(int newspeed);
+    int GetTextSpeed();
 }
 
 #endif

Modified: trunk/src/gui/OptionsMenu.cc
===================================================================
--- trunk/src/gui/OptionsMenu.cc	2008-04-26 21:01:32 UTC (rev 1113)
+++ trunk/src/gui/OptionsMenu.cc	2008-04-27 22:27:43 UTC (rev 1114)
@@ -25,6 +25,7 @@
 #include "main.hh"
 #include "nls.hh"
 #include "options.hh"
+#include "display.hh"
 #include "oxyd.hh"
 #include "SoundEngine.hh"
 #include "SoundEffectManager.hh"
@@ -60,13 +61,30 @@
         { init(); }
     };
 
+    class TextSpeedButton : public ValueButton {
+        int get_value() const     { 
+            return display::GetTextSpeed();
+        }
+        void set_value(int value) { 
+            display::SetTextSpeed(value);
+        }
+
+        string get_text(int value) const  {
+            return strf("%d", value);
+        }
+    public:
+        TextSpeedButton()
+        : ValueButton(display::MIN_TextSpeed, display::MAX_TextSpeed)
+        { init(); }
+    };
+    
     class SoundVolumeButton : public ValueButton {
         int get_value() const     { 
             return round_nearest<int>(options::GetDouble("SoundVolume")*10.0); 
         }
         void set_value(int value) {
             options::SetOption("SoundVolume", value/10.0);
-            options::UpdateVolume();
+            sound::UpdateVolume();
         }
 
         string get_text(int value) const {
@@ -87,7 +105,7 @@
         }
         void set_value(int value) {
             options::SetOption("MusicVolume", value/10.0);
-            options::UpdateVolume();
+            sound::UpdateVolume();
         }
 
         string get_text(int value) const {
@@ -376,7 +394,7 @@
             {  // VTS_64 (1280x960)
                 11,
                 35, 200, 140, 100,
-                25, 20,
+                40, 20,
                 60, 58, 20
             }
         };
@@ -395,10 +413,14 @@
         but_audio_options->setHighlight(new_page == OPTIONS_AUDIO);
         but_config_options = new StaticTextButton(N_("Config"), this);
         but_config_options->setHighlight(new_page == OPTIONS_CONFIG);
+        but_paths_options = new StaticTextButton(N_("Paths"), this);
+        but_paths_options->setHighlight(new_page == OPTIONS_PATHS);
         pagesVList->add_back(but_main_options);
+        pagesVList->add_back(new Label(""));
         pagesVList->add_back(but_video_options);
         pagesVList->add_back(but_audio_options);
         pagesVList->add_back(but_config_options);
+        pagesVList->add_back(but_paths_options);
         this->add(pagesVList, Rect(param[vtt].hmargin + vh,
                                    param[vtt].vmargin + vv, 
                                    param[vtt].pageb_width,
@@ -439,18 +461,14 @@
 #define OPTIONS_NEW_L(label) lb = new HList;\
         lb->set_spacing(param[vtt].hoption_option); \
         lb->set_alignment(HALIGN_LEFT, VALIGN_TOP); \
-        lb->set_default_size(param[vtt].optionb_width, \
-                             param[vtt].rows*param[vtt].button_height + \
-                                 (param[vtt].rows - 1) * param[vtt].vrow_row); \
+        lb->set_default_size(param[vtt].optionb_width, param[vtt].button_height); \
         lb->add_back(new Label(N_(label), HALIGN_LEFT, VALIGN_BOTTOM)); \
         optionsVList->add_back(lb); \
 // end define
 #define OPTIONS_NEW_LB(label,button) lb = new HList;\
         lb->set_spacing(param[vtt].hoption_option); \
         lb->set_alignment(HALIGN_CENTER, VALIGN_TOP); \
-        lb->set_default_size(param[vtt].optionb_width, \
-                             param[vtt].rows*param[vtt].button_height + \
-                                 (param[vtt].rows - 1) * param[vtt].vrow_row); \
+        lb->set_default_size(param[vtt].optionb_width, param[vtt].button_height); \
         lb->add_back(new Label(N_(label), HALIGN_RIGHT, VALIGN_CENTER)); \
         lb->add_back(button); \
         optionsVList->add_back(lb); \
@@ -459,8 +477,7 @@
         lb->set_spacing(param[vtt].hoption_option); \
         lb->set_alignment(HALIGN_LEFT, VALIGN_TOP); \
         lb->set_default_size(2*param[vtt].optionb_width + param[vtt].hoption_option, \
-                             param[vtt].rows*param[vtt].button_height + \
-                                 (param[vtt].rows - 1) * param[vtt].vrow_row); \
+                             param[vtt].button_height); \
         lb->add_back(textbutton); \
         optionsVList->add_back(lb); \
 // end define
@@ -497,13 +514,15 @@
             case OPTIONS_CONFIG:
                 OPTIONS_NEW_LB("Language: ", language = new LanguageButton(this))
                 OPTIONS_NEW_LB("Mouse speed: ", new MouseSpeedButton())
+                OPTIONS_NEW_LB("Text speed: ", new TextSpeedButton())
                 OPTIONS_NEW_LB("Ratings update: ", new RatingsUpdateButton())
                 userNameTF = new TextField(app.state->getString("UserName"));
                 userNameTF->setMaxChars(20);
                 userNameTF->setInvalidChars("+");
                 OPTIONS_NEW_L("User name: ")
                 OPTIONS_NEW_T(userNameTF)
-                //...("Text speed: ", new TextSpeedButton())
+                break;
+            case OPTIONS_PATHS:
                 userPathTF = new TextField(XMLtoUtf8(LocalToXML(app.userPath.c_str()).x_str()).c_str());
                 OPTIONS_NEW_L("User path: ")
                 OPTIONS_NEW_T(userPathTF)
@@ -639,6 +658,9 @@
         } else if (w == but_config_options) {
             close_page();
             open_page(OPTIONS_CONFIG);
+        } else if (w == but_paths_options) {
+            close_page();
+            open_page(OPTIONS_PATHS);
         }
     }
     

Modified: trunk/src/gui/OptionsMenu.hh
===================================================================
--- trunk/src/gui/OptionsMenu.hh	2008-04-26 21:01:32 UTC (rev 1113)
+++ trunk/src/gui/OptionsMenu.hh	2008-04-27 22:27:43 UTC (rev 1114)
@@ -43,7 +43,8 @@
         void tick(double dtime) {}
 
         // Page structure.
-        enum OptionsPage { OPTIONS_MAIN, OPTIONS_VIDEO, OPTIONS_AUDIO, OPTIONS_CONFIG };
+        enum OptionsPage { OPTIONS_MAIN, OPTIONS_VIDEO, OPTIONS_AUDIO,
+                           OPTIONS_CONFIG, OPTIONS_PATHS };
         void open_page(OptionsPage new_page);
         void close_page();
 
@@ -56,6 +57,7 @@
         gui::StaticTextButton *but_video_options;
         gui::StaticTextButton *but_audio_options;
         gui::StaticTextButton *but_config_options;
+        gui::StaticTextButton *but_paths_options;
         gui::BoolOptionButton *fullscreen;
         gui::VideoModeButton *videomode;
         gui::TextField *userNameTF;

Modified: trunk/src/options.cc
===================================================================
--- trunk/src/options.cc	2008-04-26 21:01:32 UTC (rev 1113)
+++ trunk/src/options.cc	2008-04-27 22:27:43 UTC (rev 1114)
@@ -148,12 +148,6 @@
     return GetDouble ("MouseSpeed");
 }
 
-void options::UpdateVolume() 
-{
-    sound::SetSoundVolume (GetDouble("SoundVolume"));
-    sound::SetMusicVolume (GetDouble("MusicVolume"));
-}
-
 std::string options::GetString (const char *name) 
 {
     std::string val;

Modified: trunk/src/options.hh
===================================================================
--- trunk/src/options.hh	2008-04-26 21:01:32 UTC (rev 1113)
+++ trunk/src/options.hh	2008-04-27 22:27:43 UTC (rev 1114)
@@ -91,11 +91,6 @@
     bool GetLevelStatus (const std::string &levelname,
                          LevelStatus &stat);
 
-
-    /*! Set the sound and music volume to the values in SoundVolume
-      and MusicVolume. */
-    void UpdateVolume();
-
     /*! Try to load the user's configuration file.  Returns true if
       successful. */
     bool Load ();



From andreasl at mail.berlios.de  Tue Apr 29 02:13:53 2008
From: andreasl at mail.berlios.de (andreasl at BerliOS)
Date: Tue, 29 Apr 2008 02:13:53 +0200
Subject: [Enigma-game-svn] r1115 - in trunk: data/gfx/flags25x15 src/gui
Message-ID: <200804290013.m3T0Dr0Q022738@sheep.berlios.de>

Author: andreasl
Date: 2008-04-29 02:13:52 +0200 (Tue, 29 Apr 2008)
New Revision: 1115

Added:
   trunk/data/gfx/flags25x15/de-shaded.png
   trunk/data/gfx/flags25x15/es-shaded.png
   trunk/data/gfx/flags25x15/fi-shaded.png
   trunk/data/gfx/flags25x15/fr-shaded.png
   trunk/data/gfx/flags25x15/gb-shaded.png
   trunk/data/gfx/flags25x15/hu-shaded.png
   trunk/data/gfx/flags25x15/it-shaded.png
   trunk/data/gfx/flags25x15/nl-shaded.png
   trunk/data/gfx/flags25x15/pt-shaded.png
   trunk/data/gfx/flags25x15/ru-shaded.png
   trunk/data/gfx/flags25x15/se-shaded.png
Modified:
   trunk/src/gui/MainMenu.cc
   trunk/src/gui/OptionsMenu.cc
   trunk/src/gui/widgets.cc
   trunk/src/gui/widgets.hh
Log:
Options menu restructuring:
 - Language flag buttons:
    - now own widget (RenderlessImageButton)
    - flags are shaded when not used
    - Removed default language button.
    - Shifted Enigma logo and main menu down to make
      place for the language buttons.
 - Hopefully fixed options menu translation bug.


Added: trunk/data/gfx/flags25x15/de-shaded.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx/flags25x15/de-shaded.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/data/gfx/flags25x15/es-shaded.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx/flags25x15/es-shaded.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/data/gfx/flags25x15/fi-shaded.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx/flags25x15/fi-shaded.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/data/gfx/flags25x15/fr-shaded.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx/flags25x15/fr-shaded.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/data/gfx/flags25x15/gb-shaded.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx/flags25x15/gb-shaded.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/data/gfx/flags25x15/hu-shaded.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx/flags25x15/hu-shaded.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/data/gfx/flags25x15/it-shaded.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx/flags25x15/it-shaded.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/data/gfx/flags25x15/nl-shaded.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx/flags25x15/nl-shaded.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/data/gfx/flags25x15/pt-shaded.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx/flags25x15/pt-shaded.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/data/gfx/flags25x15/ru-shaded.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx/flags25x15/ru-shaded.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/data/gfx/flags25x15/se-shaded.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx/flags25x15/se-shaded.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Modified: trunk/src/gui/MainMenu.cc
===================================================================
--- trunk/src/gui/MainMenu.cc	2008-04-27 22:27:43 UTC (rev 1114)
+++ trunk/src/gui/MainMenu.cc	2008-04-29 00:13:52 UTC (rev 1115)
@@ -212,27 +212,34 @@
     {
         const video::VMInfo *vminfo = video::GetInfo();
         const int vshrink = vminfo->width < 640 ? 1 : 0;
-        int y[] = {75, 150, 170, 200, 200};
+        int y[] = {75, 170, 190, 220, 220};
+        // parameters to use when flags are not at top: {75, 150, 170, 200, 200};
+#ifdef ENABLE_EXPERIMENTAL
+        y[1] = 150;
+#endif
         BuildVList b(this, Rect((vminfo->width - 150)/2, y[vminfo->tt], 150, vshrink?20:40), 5);
         m_startgame = b.add(new StaticTextButton(N_("Start Game"), this));
         m_levelpack = b.add(new StaticTextButton(N_("Level Pack"), this));
 #ifdef ENABLE_EXPERIMENTAL
-        m_netgame   = b.add (new StaticTextButton (N_("Network Game"), this));
+        m_netgame   = b.add(new StaticTextButton(N_("Network Game"), this));
         leveled     = b.add(new StaticTextButton(N_("Editor"), this));
 #endif
         options     = b.add(new StaticTextButton(N_("Options"), this));
         credits     = b.add(new StaticTextButton(N_("Credits"), this));
         quit        = b.add(new StaticTextButton(N_("Quit"), this));
-        int ly = vminfo->width - 5 - 35*NUMENTRIES(nls::languages);
+        int ly = vminfo->width - 5 - 35*(NUMENTRIES(nls::languages) - 1);
         //BuildHList l(this, Rect(ly, (vminfo->height) - 30, 30, 20), 5);
         BuildHList l(this, Rect(ly, 10, 30, 20), 5);
         //BuildVList l(this, Rect(vminfo->width - 45, 15, 30, 20), 5);
         language.clear();
         if(!vshrink)
-            for (size_t i=0; i<NUMENTRIES(nls::languages); ++i)
-                language.push_back(l.add(
-                    new ImageButton(nls::languages[i].flagimage,
-                                    nls::languages[i].flagimage, this)));
+            for (size_t i=1; i<NUMENTRIES(nls::languages); ++i) {
+                BorderlessImageButton *but = new BorderlessImageButton(
+                    nls::languages[i].flagimage + string("-shaded"),
+                    nls::languages[i].flagimage,
+                    nls::languages[i].flagimage, this);
+                language.push_back(l.add(but));
+            }
     }
     
     void MainMenu::draw_background(ecl::GC &gc) 
@@ -247,7 +254,11 @@
         Font *f = enigma::GetFont("levelmenu");
         Surface * logo(enigma::GetImage("enigma_logo3"));
         int x0=(vminfo->width - logo->width())/2;
-        int y0[] = {0, 30, 40, 50, 60};
+        int y0[] = {0, 50, 60, 70, 80};
+        // parameters to use when flags are not at top: {0, 30, 40, 50, 60};
+#ifdef ENABLE_EXPERIMENTAL
+        y0[1] = 30;
+#endif
         blit(gc, x0, y0[vminfo->tt], logo);
         f->render (gc, 5, vminfo->height - 20, app.getVersionInfo().c_str());
     }
@@ -291,8 +302,8 @@
         } else if (w == quit) {
             Menu::quit();
         } else if (language.size() > 0) {
-            for (size_t i=0; i<NUMENTRIES(nls::languages); ++i)
-                if (w == language[i]) {
+            for (size_t i=1; i<NUMENTRIES(nls::languages); ++i)
+                if (w == language[i-1]) {
                     options::SetOption ("Language", nls::languages[i].localename);
                     app.setLanguage(nls::languages[i].localename);
                 }

Modified: trunk/src/gui/OptionsMenu.cc
===================================================================
--- trunk/src/gui/OptionsMenu.cc	2008-04-27 22:27:43 UTC (rev 1114)
+++ trunk/src/gui/OptionsMenu.cc	2008-04-29 00:13:52 UTC (rev 1115)
@@ -462,14 +462,14 @@
         lb->set_spacing(param[vtt].hoption_option); \
         lb->set_alignment(HALIGN_LEFT, VALIGN_TOP); \
         lb->set_default_size(param[vtt].optionb_width, param[vtt].button_height); \
-        lb->add_back(new Label(N_(label), HALIGN_LEFT, VALIGN_BOTTOM)); \
+        lb->add_back(new Label(label, HALIGN_LEFT, VALIGN_BOTTOM)); \
         optionsVList->add_back(lb); \
 // end define
 #define OPTIONS_NEW_LB(label,button) lb = new HList;\
         lb->set_spacing(param[vtt].hoption_option); \
         lb->set_alignment(HALIGN_CENTER, VALIGN_TOP); \
         lb->set_default_size(param[vtt].optionb_width, param[vtt].button_height); \
-        lb->add_back(new Label(N_(label), HALIGN_RIGHT, VALIGN_CENTER)); \
+        lb->add_back(new Label(label, HALIGN_RIGHT, VALIGN_CENTER)); \
         lb->add_back(button); \
         optionsVList->add_back(lb); \
 // end define
@@ -484,50 +484,50 @@
 
         switch (new_page) {
             case OPTIONS_MAIN:
-                OPTIONS_NEW_LB("Language: ", language = new LanguageButton(this))
-                OPTIONS_NEW_LB("Fullscreen: ", fullscreen = new FullscreenButton(this))
-                OPTIONS_NEW_LB("Video mode: ", videomode = new VideoModeButton())
-                OPTIONS_NEW_LB("Mouse speed: ", new MouseSpeedButton())
-                OPTIONS_NEW_LB("Sound volume: ", new SoundVolumeButton())
-                OPTIONS_NEW_LB("Music volume: ", new MusicVolumeButton())
-                OPTIONS_NEW_LB("Ratings update: ", new RatingsUpdateButton())
+                OPTIONS_NEW_LB(N_("Language: "), language = new LanguageButton(this))
+                OPTIONS_NEW_LB(N_("Fullscreen: "), fullscreen = new FullscreenButton(this))
+                OPTIONS_NEW_LB(N_("Video mode: "), videomode = new VideoModeButton())
+                OPTIONS_NEW_LB(N_("Mouse speed: "), new MouseSpeedButton())
+                OPTIONS_NEW_LB(N_("Sound volume: "), new SoundVolumeButton())
+                OPTIONS_NEW_LB(N_("Music volume: "), new MusicVolumeButton())
+                OPTIONS_NEW_LB(N_("Ratings update: "), new RatingsUpdateButton())
                 userNameTF = new TextField(app.state->getString("UserName"));
                 userNameTF->setMaxChars(20);
                 userNameTF->setInvalidChars("+");
-                OPTIONS_NEW_L("User name: ")
+                OPTIONS_NEW_L(N_("User name: "))
                 OPTIONS_NEW_T(userNameTF)
                 break;
             case OPTIONS_VIDEO:
-                OPTIONS_NEW_LB("Fullscreen: ", fullscreen = new FullscreenButton())
+                OPTIONS_NEW_LB(N_("Fullscreen: "), fullscreen = new FullscreenButton())
                 fullscreen->set_listener(this);
-                OPTIONS_NEW_LB("Video mode: ", videomode = new VideoModeButton())
-                OPTIONS_NEW_LB("Gamma correction: ", new GammaButton())
+                OPTIONS_NEW_LB(N_("Video mode: "), videomode = new VideoModeButton())
+                OPTIONS_NEW_LB(N_("Gamma correction: "), new GammaButton())
                 break;
             case OPTIONS_AUDIO:
-                OPTIONS_NEW_LB("Sound set: ", new SoundSetButton())
-                OPTIONS_NEW_LB("Menu music: ", new MenuMusicButton)
-                OPTIONS_NEW_LB("Sound volume: ", new SoundVolumeButton())
-                OPTIONS_NEW_LB("Music volume: ", new MusicVolumeButton())
-                OPTIONS_NEW_LB("Stereo: ", new StereoButton())
+                OPTIONS_NEW_LB(N_("Sound set: "), new SoundSetButton())
+                OPTIONS_NEW_LB(N_("Menu music: "), new MenuMusicButton)
+                OPTIONS_NEW_LB(N_("Sound volume: "), new SoundVolumeButton())
+                OPTIONS_NEW_LB(N_("Music volume: "), new MusicVolumeButton())
+                OPTIONS_NEW_LB(N_("Stereo: "), new StereoButton())
                 //...("Music ingame: ", new InGameMusicButton)
                 break;
             case OPTIONS_CONFIG:
-                OPTIONS_NEW_LB("Language: ", language = new LanguageButton(this))
-                OPTIONS_NEW_LB("Mouse speed: ", new MouseSpeedButton())
-                OPTIONS_NEW_LB("Text speed: ", new TextSpeedButton())
-                OPTIONS_NEW_LB("Ratings update: ", new RatingsUpdateButton())
+                OPTIONS_NEW_LB(N_("Language: "), language = new LanguageButton(this))
+                OPTIONS_NEW_LB(N_("Mouse speed: "), new MouseSpeedButton())
+                OPTIONS_NEW_LB(N_("Text speed: "), new TextSpeedButton())
+                OPTIONS_NEW_LB(N_("Ratings update: "), new RatingsUpdateButton())
                 userNameTF = new TextField(app.state->getString("UserName"));
                 userNameTF->setMaxChars(20);
                 userNameTF->setInvalidChars("+");
-                OPTIONS_NEW_L("User name: ")
+                OPTIONS_NEW_L(N_("User name: "))
                 OPTIONS_NEW_T(userNameTF)
                 break;
             case OPTIONS_PATHS:
                 userPathTF = new TextField(XMLtoUtf8(LocalToXML(app.userPath.c_str()).x_str()).c_str());
-                OPTIONS_NEW_L("User path: ")
+                OPTIONS_NEW_L(N_("User path: "))
                 OPTIONS_NEW_T(userPathTF)
                 userImagePathTF = new TextField(XMLtoUtf8(LocalToXML(app.userImagePath.c_str()).x_str()).c_str());
-                OPTIONS_NEW_L("User image path: ")
+                OPTIONS_NEW_L(N_("User image path: "))
                 OPTIONS_NEW_T(userImagePathTF)
                 break;
         }

Modified: trunk/src/gui/widgets.cc
===================================================================
--- trunk/src/gui/widgets.cc	2008-04-27 22:27:43 UTC (rev 1114)
+++ trunk/src/gui/widgets.cc	2008-04-29 00:13:52 UTC (rev 1115)
@@ -606,7 +606,9 @@
 
 /* -------------------- Button -------------------- */
 
-Button::Button() : m_activep (false), highlight (false) {
+Button::Button()
+: m_activep (false), highlight (false)
+{
 }
 
 void Button::activate() 
@@ -632,7 +634,7 @@
 void Button::draw(ecl::GC &gc, const ecl::Rect &r) {
     const int borderw = 4;
 
-    ecl::Surface *s = enigma::GetImage (m_activep ? "buttonhl" : "button");
+    ecl::Surface *s = enigma::GetImage(m_activep ? "buttonhl" : "button");
 
     if (s) {                    // Ugly, but hey, it works
         Rect srcrect (0,0,borderw, borderw);
@@ -941,3 +943,32 @@
         blit(gc, x, y, s);
     }
 }
+
+/* -------------------- BorderlessImageButton -------------------- */
+
+BorderlessImageButton::BorderlessImageButton(const string &unselected,
+    const string &selected, const string &mouseover, ActionListener *al)
+: fname_sel(selected), fname_unsel(unselected), fname_mouse(mouseover)
+{
+    set_listener(al);
+}
+
+void BorderlessImageButton::set_images(const string &unselected,
+                                       const string &selected, const string &mouseover) {
+    fname_sel = selected;
+    fname_unsel = unselected;
+    fname_mouse = mouseover;
+}
+
+void BorderlessImageButton::draw(ecl::GC &gc, const ecl::Rect &r) {
+    string &fname = m_activep ? fname_mouse : (is_pressed() ? fname_sel : fname_unsel);
+
+    if (Surface *s = enigma::GetImage(fname.c_str())) {
+        int w=s->width();
+        int h=s->height();
+        int x = get_x() + (get_w()-w)/2;
+        int y = get_y() + (get_h()-h)/2;
+        blit(gc, x, y, s);
+    }
+}
+

Modified: trunk/src/gui/widgets.hh
===================================================================
--- trunk/src/gui/widgets.hh	2008-04-27 22:27:43 UTC (rev 1114)
+++ trunk/src/gui/widgets.hh	2008-04-29 00:13:52 UTC (rev 1115)
@@ -333,7 +333,7 @@
         bool isHighlight();
     protected:
         Button();
-
+        
         // Widget interface.
         void draw(ecl::GC &gc, const ecl::Rect &r);
         void activate();
@@ -465,5 +465,22 @@
         std::string fname_sel, fname_unsel;
     };
 
+
+    /* -------------------- BorderlessImageButton -------------------- */
+
+    class BorderlessImageButton : public PushButton {
+    public:
+        BorderlessImageButton(const std::string &unselected,
+                              const std::string &selected,
+                              const std::string &mouseover,
+                              ActionListener    *al = 0);
+        void set_images(const std::string &unselected, const std::string &selected,
+                        const std::string &mouseover);
+        // Widget interface.
+        virtual void draw(ecl::GC &gc, const ecl::Rect &r);
+    private:
+        std::string fname_sel, fname_unsel, fname_mouse;
+    };
+
 }} // namespace enigma::gui
 #endif



From ral at mail.berlios.de  Tue Apr 29 22:47:41 2008
From: ral at mail.berlios.de (ral at BerliOS)
Date: Tue, 29 Apr 2008 22:47:41 +0200
Subject: [Enigma-game-svn] r1116 - in trunk: data data/schemas src src/stones
Message-ID: <200804292047.m3TKlfMr026958@sheep.berlios.de>

Author: ral
Date: 2008-04-29 22:47:40 +0200 (Tue, 29 Apr 2008)
New Revision: 1116

Added:
   trunk/src/stones/RotatorStone.cc
   trunk/src/stones/RotatorStone.hh
Modified:
   trunk/data/api1init.lua
   trunk/data/schemas/objects.xml
   trunk/src/Makefile.am
   trunk/src/ox_peroxyd.cc
   trunk/src/stones_complex.cc
Log:
Trunk 1.1: reengineering new API rotator stone
- renaming to st_rotator, st_rotator_cw, st_rotator_ccw
- state as rotation direction
- attribute "movable" instead of stone variation
- improved light behaviour: 
  - every light addition causes change
  - light changes on moves and swap are fully respected
- fixed strange impulsing behaviour that could cause stones
  to be pushed several grids at once or two rotators to move together
- fixed all swap problems concerning light and crashed due to impulses


Modified: trunk/data/api1init.lua
===================================================================
--- trunk/data/api1init.lua	2008-04-29 00:13:52 UTC (rev 1115)
+++ trunk/data/api1init.lua	2008-04-29 20:47:40 UTC (rev 1116)
@@ -119,6 +119,10 @@
     st_oxyd = "st-oxyd",
     st_panel = "st-wood_001",
     st_polarswitch = "st-polarswitch",
+    st_rotator_cw = "st-rotator-right",
+    st_rotator_ccw = "st-rotator-left",
+    st_rotator_cw_movable = "st-rotator_move-right",
+    st_rotator_ccw_movable = "st-rotator_move-left",
     st_switch = "st-switch",
     st_switch_black = "st-switch_black",
     st_switch_white = "st-switch_white",

Modified: trunk/data/schemas/objects.xml
===================================================================
--- trunk/data/schemas/objects.xml	2008-04-29 00:13:52 UTC (rev 1115)
+++ trunk/data/schemas/objects.xml	2008-04-29 20:47:40 UTC (rev 1116)
@@ -20,6 +20,7 @@
     <attr name="inverse" type="bool" default="false" rw="rw"/>
     <attr name="invisible" type="bool" default="false" rw="rw"/>
     <attr name="loop" type="bool" default="true" rw="rw"/>
+    <attr name="movable" type="bool" default="false" rw="rw"/>
     <attr name="name" type="string" default="nil" rw="rw"/>
     <attr name="nopaction" type="bool" default="false" rw="rw"/>
     <attr name="noshuffle" type="bool" default="false" rw="rw"/>
@@ -438,6 +439,17 @@
       <msg name="off"/>
       <msg name="signal"/>
     </object>
+    <object name="st_rotator">
+      <attr name="counterclock"/>
+      <attr name="movable"/>
+      <msg name="_model_reanimated"/>
+    </object>
+    <object name="st_rotator_cw">
+      <attr name="state" value="0"/>
+    </object>
+    <object name="st_rotator_ccw">
+      <attr name="state" value="1"/>
+    </object>
     <object name="st_switch">
       <attr name="color"/>
       <attr name="instant"/>

Modified: trunk/src/Makefile.am
===================================================================
--- trunk/src/Makefile.am	2008-04-29 00:13:52 UTC (rev 1115)
+++ trunk/src/Makefile.am	2008-04-29 20:47:40 UTC (rev 1116)
@@ -223,6 +223,8 @@
 	stones/OxydStone.hh	\
 	stones/PolarSwitchStone.cc	\
 	stones/PolarSwitchStone.hh	\
+	stones/RotatorStone.cc	\
+	stones/RotatorStone.hh	\
 	stones/Switch.cc	\
 	stones/Switch.hh	\
 	stones/TimerStone.cc	\

Modified: trunk/src/ox_peroxyd.cc
===================================================================
--- trunk/src/ox_peroxyd.cc	2008-04-29 00:13:52 UTC (rev 1115)
+++ trunk/src/ox_peroxyd.cc	2008-04-29 20:47:40 UTC (rev 1116)
@@ -339,8 +339,8 @@
     "st-rock2",                 // PerOxyd stone 0x8e
     UNUSED,                     // PerOxyd stone 0x8f
     "st-rock8",                 // PerOxyd stone 0x90
-    "st-rotator_move-left",     // PerOxyd stone 0x91
-    "st-rotator_move-right",    // PerOxyd stone 0x92
+    "st_rotator_ccw_movable",   // PerOxyd stone 0x91
+    "st_rotator_cw_movable",    // PerOxyd stone 0x92
     "st-swap",                  // PerOxyd stone 0x93
     "st-spitter",               // PerOxyd stone 0x94
     0,                          // PerOxyd stone 0x95 (dynamite holder, will implememnt it)(levels: 41 184 200)

Added: trunk/src/stones/RotatorStone.cc
===================================================================
--- trunk/src/stones/RotatorStone.cc	2008-04-29 00:13:52 UTC (rev 1115)
+++ trunk/src/stones/RotatorStone.cc	2008-04-29 20:47:40 UTC (rev 1116)
@@ -0,0 +1,172 @@
+/*
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *  
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include "stones/RotatorStone.hh"
+#include "laser.hh"
+#include "main.hh"
+#include "player.hh"
+
+namespace enigma {
+    RotatorStone::RotatorStone(bool isMovable, bool counterclockwise) : Stone () {
+        if (isMovable)
+            objFlags |= OBJBIT_MOVABLE;
+            
+        state = counterclockwise ? CCW : CW;
+    }
+
+    std::string RotatorStone::getClass() const {
+        return "st_rotator";
+    }
+        
+    void RotatorStone::setAttr(const string& key, const Value &val) {
+        if (key == "counterclock") {
+            int newstate = val.to_bool() ? CCW : CW;
+            if (newstate != state) {
+                state = newstate;
+                if (isDisplayable())
+                    init_model();
+            } 
+        } else if (key == "movable") {
+            if (val.to_bool())
+                objFlags |= OBJBIT_MOVABLE;
+            else
+                objFlags &= ~OBJBIT_MOVABLE;
+        } else
+            Stone::setAttr(key, val);
+    }
+    
+    Value RotatorStone::getAttr(const std::string &key) const {
+        if (key == "counterclock") {
+            return state == CCW;
+        } else if (key == "movable") {
+            return (bool)(objFlags & OBJBIT_MOVABLE);
+        } else
+            return Stone::getAttr(key);
+    }
+            
+    void RotatorStone::setState(int extState) {
+        if (isDisplayable() && state != extState) {
+            state = extState;
+            init_model();
+        } else  // object initialisation
+            state = extState;
+    }
+
+    void RotatorStone::init_model() {
+        set_anim(state == CW ? "st-rotator-right" : "st-rotator-left");
+    }
+    
+    void RotatorStone::on_creation(GridPos p) {
+        // just update light status, do not react for new stones
+        // swapped and moved once are handled by the on_move method
+        updateCurrentLightDirs();
+            
+        activatePhoto();
+
+        Stone::on_creation(p);
+    }
+    
+    void RotatorStone::on_removal(GridPos p) {
+        // remember last enlightment for stone moves and swaps
+        objFlags &= ~OBJBIT_LIGHT;
+        objFlags |= (objFlags & OBJBIT_LIGHTNEWDIRS) << 25;
+        GameTimer.remove_alarm(this);
+        Stone::on_removal(p);
+    }
+
+    void RotatorStone::lightDirChanged(DirectionBits oldDirs, DirectionBits newDirs) {
+        if (added_dirs(oldDirs, newDirs)) {
+            state = 1 - state;  // change rotation direction
+            init_model();
+         }
+    }
+
+    void RotatorStone::animcb() {
+        init_model();
+        send_impulses();
+    }
+    
+    void RotatorStone::actor_hit(const StoneContact &sc) {
+        if (player::WieldedItemIs (sc.actor, "it_wrench")) {
+            state = 1 - state;  // change rotation direction
+            init_model();
+        }
+
+        if (objFlags & OBJBIT_MOVABLE)
+            maybe_push_stone(sc);
+    }
+
+    void RotatorStone::on_impulse(const Impulse& impulse) {
+        if (objFlags & OBJBIT_MOVABLE) {
+            move_stone(impulse.dir);
+        }
+    }
+    
+    void RotatorStone::on_move() {
+        objFlags &= ~OBJBIT_LIGHTNEWDIRS;
+        objFlags |= (objFlags & OBJBIT_LIGHT) >> 25;
+        RecalcLight();   // necessary for rotators swapped out of light
+        
+        Stone::on_move();
+    }
+    
+    FreezeStatusBits RotatorStone::get_freeze_bits() {
+       return FREEZEBIT_IRREGULAR;
+    }    
+
+    void RotatorStone::alarm() {
+        GridPos p = get_pos();
+        
+        for (int i = WEST; i <= NORTH; i++) {
+            if (Value id = getAttr(ecl::strf("$neighbour%d",i))) {
+                Stone *st = GetStone(move(get_pos(), (Direction)i));
+                if (st != NULL  && id == st->getId()) {
+                    send_impulse(move(p, (Direction)i), state == CW ? rotate_cw((Direction)i) : rotate_ccw((Direction)i));
+                }
+            }
+        }
+    }
+
+    int RotatorStone::traitsIdx() const {
+        return (objFlags & OBJBIT_MOVABLE) ? 1 : 0;
+    }
+
+    void RotatorStone::send_impulses() {
+        for (int i = WEST; i <= NORTH; i++) {
+            Stone *st = GetStone(move(get_pos(), (Direction)i));
+            Stone::setAttr(ecl::strf("$neighbour%d",i), (st == NULL) ? Value() : Value(st->getId()));
+        }
+        GameTimer.set_alarm(this, 0.1);
+        
+    }
+    
+    StoneTraits RotatorStone::traits[2] = {
+        {"st_rotator", st_rotator, stf_none, material_stone, 1.0, MOVABLE_PERSISTENT},
+        {"st_rotator", st_rotator, stf_none, material_stone, 1.0, MOVABLE_STANDARD},
+    };
+    
+    BOOT_REGISTER_START
+        BootRegister(new RotatorStone(false, false), "st_rotator");
+        BootRegister(new RotatorStone(false, false), "st_rotator_cw");
+        BootRegister(new RotatorStone(false, true), "st_rotator_ccw");
+        BootRegister(new RotatorStone(true, false), "st_rotator_cw_movable");
+        BootRegister(new RotatorStone(true, true), "st_rotator_ccw_movable");
+    BOOT_REGISTER_END
+
+} // namespace enigma


Property changes on: trunk/src/stones/RotatorStone.cc
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/stones/RotatorStone.hh
===================================================================
--- trunk/src/stones/RotatorStone.hh	2008-04-29 00:13:52 UTC (rev 1115)
+++ trunk/src/stones/RotatorStone.hh	2008-04-29 20:47:40 UTC (rev 1116)
@@ -0,0 +1,84 @@
+/*
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef ROTATORSTONE_HH
+#define ROTATORSTONE_HH
+
+#include "stones.hh"
+
+#include "stones_internal.hh"
+
+namespace enigma {
+
+    /** 
+     * 
+     */
+    class RotatorStone : public Stone, public TimeHandler {
+        CLONEOBJ(RotatorStone);
+        DECL_TRAITS_ARRAY(2, traitsIdx());
+    private:
+        enum iState {
+            CW,   ///< clockwise rotation 
+            CCW   ///< counter clockwise rotation
+        };
+        
+        enum ObjectPrivatFlagsBits {
+            OBJBIT_MOVABLE   =   1<<24,  ///< Object is movable 
+            OBJBIT_LIGHT     =  15<<25   ///< Light status kept for move, swap, pull operations 
+        };
+    public:
+        RotatorStone(bool isMovable, bool counterclockwise);
+        
+        // Object interface
+        virtual std::string getClass() const;
+        virtual void setAttr(const string& key, const Value &val);
+        virtual Value getAttr(const std::string &key) const;
+        
+        // StateObject interface
+        virtual void setState(int extState);
+
+        // GridObject interface
+        virtual void init_model();
+        virtual void on_creation(GridPos p);
+        virtual void on_removal(GridPos p);
+        virtual void lightDirChanged(DirectionBits oldDirs, DirectionBits newDirs);
+        
+        // ModelCallback interface
+        virtual void animcb();
+        
+        // Stone interface
+        virtual void actor_hit(const StoneContact &sc);
+        virtual void on_impulse(const Impulse& impulse);
+        virtual void on_move();
+        virtual FreezeStatusBits get_freeze_bits();
+
+        // TimeHandler interface
+        virtual void alarm();
+        
+    private:
+        int traitsIdx() const;
+        void send_impulses();
+    };
+
+} // namespace enigma
+
+#endif
+#ifndef ROTATORSTONE_HH_
+#define ROTATORSTONE_HH_
+
+#endif /*ROTATORSTONE_HH_*/


Property changes on: trunk/src/stones/RotatorStone.hh
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/src/stones_complex.cc
===================================================================
--- trunk/src/stones_complex.cc	2008-04-29 00:13:52 UTC (rev 1115)
+++ trunk/src/stones_complex.cc	2008-04-29 20:47:40 UTC (rev 1116)
@@ -39,105 +39,6 @@
 
 namespace enigma { 
 
-
-/* -------------------- RotatorStone -------------------- */
-namespace
-{
-    class RotatorStone : public PhotoStone {
-    public:
-        RotatorStone(bool clockwise_, bool movable_)
-        : clockwise(clockwise_), movable(movable_)
-        {
-            traits.name = "st-rotator";
-            traits.id = st_rotator;
-            traits.flags = stf_none;
-            traits.material = material_stone;
-            traits.restitution = 1.0;
-            traits.movable = movable_ ? MOVABLE_STANDARD : MOVABLE_PERSISTENT;
-        }
-
-    private:
-        static const double RATE;
-        static const double IMPULSE_DELAY;
-
-        bool clockwise;
-        bool movable;
-        StoneTraits traits;
-
-        Stone *clone() { return new RotatorStone(clockwise, movable); }
-        void dispose() { delete this; }
-        
-        // Stone interface
-        void on_creation (GridPos p) {
-            Stone::on_creation(p);
-            photo_activate();
-        }
-        void on_removal (GridPos p){
-            photo_deactivate();
-            Stone::on_removal(p);
-        }
-
-        void send_impulses() {
-            GridPos p = get_pos();
-
-            if (clockwise) {
-                send_impulse (move(p, NORTH), EAST, IMPULSE_DELAY);
-                send_impulse (move(p, EAST), SOUTH, IMPULSE_DELAY);
-                send_impulse (move(p, SOUTH), WEST, IMPULSE_DELAY);
-                send_impulse (move(p, WEST), NORTH, IMPULSE_DELAY);
-            } else {
-                send_impulse (move(p, NORTH), WEST, IMPULSE_DELAY);
-                send_impulse (move(p, EAST), NORTH, IMPULSE_DELAY);
-                send_impulse (move(p, SOUTH), EAST, IMPULSE_DELAY);
-                send_impulse (move(p, WEST), SOUTH, IMPULSE_DELAY);
-            }
-        }
-
-
-        void init_model() {
-            set_anim(clockwise ? "st-rotator-right" : "st-rotator-left");
-        }
-        void animcb() {
-            init_model();
-            send_impulses();
-        }
-
-        void actor_hit (const StoneContact &sc) {
-            if (player::WieldedItemIs (sc.actor, "it_wrench")) {
-                clockwise = !clockwise;
-                init_model();
-            }
-
-            if (movable)
-                maybe_push_stone(sc);
-        }
-
-        void on_impulse(const Impulse& impulse) {
-            if (movable)
-                move_stone(impulse.dir);
-        }
-
-        // PhotoStone interface
-        void notify_laseron() {
-            clockwise = !clockwise;
-            init_model();
-        }
-        void notify_laseroff() {}
-
-        const StoneTraits &get_traits() const
-        {
-            return traits;
-        }
-
-    private:
-        FreezeStatusBits get_freeze_bits() { return FREEZEBIT_IRREGULAR; }    
-    };
-    
-    const double RotatorStone::RATE          = 1.0;
-    const double RotatorStone::IMPULSE_DELAY = 0.1;
-}
-
-
 /* -------------------- PullStone -------------------- */
 
 // When pushed this stone acts like pulled.
@@ -2979,12 +2880,6 @@
     Register("st-puzzle2-esw", new PuzzleStone(8, true));
     Register("st-puzzle2-nesw", new PuzzleStone(16, true));
 
-
-    Register ("st-rotator-right", new RotatorStone(true, false));
-    Register ("st-rotator-left", new RotatorStone(false, false));
-    Register ("st-rotator_move-right", new RotatorStone(true, true));
-    Register ("st-rotator_move-left", new RotatorStone(false, true));
-
     Register(new ShogunStone);
     Register("st-shogun-s", new ShogunStone(1));
     Register("st-shogun-m", new ShogunStone(2));



From ral at mail.berlios.de  Tue Apr 29 23:58:08 2008
From: ral at mail.berlios.de (ral at BerliOS)
Date: Tue, 29 Apr 2008 23:58:08 +0200
Subject: [Enigma-game-svn] r1117 - team_levelpacks/team_test_new_api
Message-ID: <200804292158.m3TLw8jE032561@sheep.berlios.de>

Author: ral
Date: 2008-04-29 23:58:07 +0200 (Tue, 29 Apr 2008)
New Revision: 1117

Modified:
   team_levelpacks/team_test_new_api/ralT016_1.xml
   team_levelpacks/team_test_new_api/ralT035_1.xml
   team_levelpacks/team_test_new_api/ralT041_1.xml
Log:
Test Level new API:
- update test level for rotator
Note:
- a small bug currently disables rotators to turn boulders
  will be fixed in next trunk commit


Modified: team_levelpacks/team_test_new_api/ralT016_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/ralT016_1.xml	2008-04-29 20:47:40 UTC (rev 1116)
+++ team_levelpacks/team_test_new_api/ralT016_1.xml	2008-04-29 21:58:07 UTC (rev 1117)
@@ -23,34 +23,34 @@
 
 ti[" "] = {"fl-sahara"}
 ti["."] = {"fl-abyss"}
-ti["#"] = ti[" "] .. {"st-rock1"}
-ti["l"] = ti[" "] .. {"st-lightpassenger_off"}
-ti["B"] = ti[" "] .. {"st_boulder_n"}
-ti["W"] = ti[" "] .. {"st-white1"}
-ti["P"] = ti[" "] .. {"st-plain"}
-ti["p"] = ti[" "] .. {"st_polarswitch"}
-ti["E"] = ti[" "] .. {"st_laser_e", state = ON}
-ti["e"] = ti[" "] .. {"st_laser_n", state = ON}
-ti["m"] = ti[" "] .. {"st-pmirror", movable=1, transparent=true, orientation=2}
-ti["w"] = ti[" "] .. {"it-magicwand"}
-ti["V"] = ti[" "] .. {"st-volcano_inactive"}
-ti["I"] = ti[" "] .. {"st-stoneimpulse"}
-ti["i"] = ti[" "] .. {"st-stoneimpulse_movable"}
-ti["L"] = ti[" "] .. {"st-rotator-left"}
-ti["R"] = ti[" "] .. {"st-rotator-right"}
-ti["b"] = ti[" "] .. {"st_blocker"}
-ti["H"] = ti[" "] .. {"st-wood"}
-ti["A"] = ti[" "] .. {"st_blocker"}
-ti["a"] = ti[" "] .. {"it_blocker"}
-ti["c"] = ti[" "] .. {"it_blocker_new"}
+ti["#"] = {"st-rock1"}
+ti["l"] = {"st-lightpassenger_off"}
+ti["B"] = {"st_boulder_n"}
+ti["W"] = {"st-white1"}
+ti["P"] = {"st-plain"}
+ti["p"] = {"st_polarswitch"}
+ti["E"] = {"st_laser_e", state = ON}
+ti["e"] = {"st_laser_n", state = ON}
+ti["m"] = {"st-pmirror", movable=1, transparent=true, orientation=2}
+ti["w"] = {"it-magicwand"}
+ti["V"] = {"st-volcano_inactive"}
+ti["I"] = {"st-stoneimpulse"}
+ti["i"] = {"st-stoneimpulse_movable"}
+ti["L"] = {"st_rotator_ccw"}
+ti["R"] = {"st_rotator_cw"}
+ti["b"] = {"st_blocker"}
+ti["H"] = {"st-wood"}
+ti["A"] = {"st_blocker"}
+ti["a"] = {"it_blocker"}
+ti["c"] = {"it_blocker_new"}
 ti["C"] = ti[" "] .. {"st_boulder_w"}
 ti["D"] = ti["a"] .. {"st_boulder_w"}
 ti["F"] = ti["c"] .. {"st_boulder_w"}
-ti["G"] = ti[" "] .. {"st_boulder_e"}
+ti["G"] = {"st_boulder_e"}
 
 
-ti["X"] = ti[" "] .. {"st_oxyd"}
-ti["1"] = ti[" "] .. {"#ac-blackball"}
+ti["X"] = {"st_oxyd"}
+ti["1"] = {"#ac-blackball"}
 
 w, h = wo(ti, " ", {
 "###X##########X#####",

Modified: team_levelpacks/team_test_new_api/ralT035_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/ralT035_1.xml	2008-04-29 20:47:40 UTC (rev 1116)
+++ team_levelpacks/team_test_new_api/ralT035_1.xml	2008-04-29 21:58:07 UTC (rev 1117)
@@ -39,7 +39,7 @@
 -- TODO argument check with error on faults
 
 ti[".."] = {"it_blocker"}
-ti["::"] = {"it-cross"}
+ti["::"] = {"it_cross"}
 
 function myresolver(key, x, y)
     if key == "##" then

Modified: team_levelpacks/team_test_new_api/ralT041_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/ralT041_1.xml	2008-04-29 20:47:40 UTC (rev 1116)
+++ team_levelpacks/team_test_new_api/ralT041_1.xml	2008-04-29 21:58:07 UTC (rev 1117)
@@ -20,8 +20,9 @@
 wo["ConserveLevel"] = true
 
 ti[" "] = {"fl-sahara"}
-ti["y"] = ti[" "] .. {"it-yinyang"}
-ti["b"] = ti[" "] .. {"it_brush"}
+ti["y"] = {"it-yinyang"}
+ti["b"] = {"it_brush"}
+ti["w"] = {"it_wrench"}
 
 ti["e"] = {"it_sensor", invisible=true, target="sensorlaseri", action="signal"}
 ti["f"] = {"it_sensor", invisible=true, inverse=true, target="sensorlaseri", action="signal"}
@@ -38,7 +39,22 @@
 ti["m"] = {"st_laser_n", "crosslaser2"}
 
 
+ti["r"] = {"st_rotator_cw", movable=true}
+ti["R"] = {"st_rotator_ccw", movable=false}
+ti["W"] = {"st-wood"}
+ti["s"] = {"st-swap"}
+ti["g"] = {"st-glass1"}
+ti["S"] = {"st_switch", target="addrot"}
 
+ti["X"] = {"st_laser_s", "rotlaser", state=ON}
+ti["x"] = {"st_laser_e", "rotlasere"}
+ti["Z"] = {"st_laser_n", "rotlasern1"}
+ti["Y"] = {"st_laser_n", "rotlasern2"}
+ti["t"] = {"st_switch", target="rotlasere"}
+ti["u"] = {"st_switch", target="rotlasern1"}
+ti["U"] = {"st_switch", target="rotlasern2"}
+
+
 ti["1"] = ti["y"] .. {"#ac-blackball"} 
 ti["2"] = ti["y"] .. {"#ac-whiteball"}
 
@@ -49,17 +65,19 @@
 "                    ",
 " e   E     C   c    ",
 " f   F              ",
+"          1 2  b w  ",
+"S   X               ",
+"t         W         ",
+"x           r       ",
 "                    ",
+"   sr            R  ",
 "                    ",
-"                    ",
-"                    ",
-"                    ",
-"        1 2      b  ",
-"                    ",
-"                    "
+"  uZYU              "
 })
 
-  
+function addrot()
+    wo[no["rotlaser"] + {0, 2}] = ti["r"]
+end
   ]]></el:luamain>
     <el:i18n>
 	 <el:string el:key="title">



