<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Enigma-game-svn] r747 - branches/1.0/etc
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/enigma-game-svn/2007-May/index.html" >
   <LINK REL="made" HREF="mailto:enigma-game-svn%40lists.berlios.de?Subject=Re%3A%20%5BEnigma-game-svn%5D%20r747%20-%20branches/1.0/etc&In-Reply-To=%3C200705212241.l4LMfPZD031004%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000183.html">
   <LINK REL="Next"  HREF="000185.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Enigma-game-svn] r747 - branches/1.0/etc</H1>
    <B>ral at BerliOS</B> 
    <A HREF="mailto:enigma-game-svn%40lists.berlios.de?Subject=Re%3A%20%5BEnigma-game-svn%5D%20r747%20-%20branches/1.0/etc&In-Reply-To=%3C200705212241.l4LMfPZD031004%40sheep.berlios.de%3E"
       TITLE="[Enigma-game-svn] r747 - branches/1.0/etc">ral at mail.berlios.de
       </A><BR>
    <I>Tue May 22 00:41:25 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000183.html">[Enigma-game-svn] r746 - in branches/1.0: . src
</A></li>
        <LI>Next message: <A HREF="000185.html">[Enigma-game-svn] r748 - in branches/1.0: . src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#184">[ date ]</a>
              <a href="thread.html#184">[ thread ]</a>
              <a href="subject.html#184">[ subject ]</a>
              <a href="author.html#184">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: ral
Date: 2007-05-22 00:41:11 +0200 (Tue, 22 May 2007)
New Revision: 747

Added:
   branches/1.0/etc/enigma-inst-lang.nsh
   branches/1.0/etc/enigma-inst-opt.ini
   branches/1.0/etc/enigma-inst-welcome.bmp
Modified:
   branches/1.0/etc/Makefile.am
   branches/1.0/etc/enigma.nsi.in
   branches/1.0/etc/mingw32-dist.sh.in
Log:
Branch 1.0:
- update Windows NSI to modern interface by Tobias, Jen

Modified: branches/1.0/etc/Makefile.am
===================================================================
--- branches/1.0/etc/Makefile.am	2007-05-21 21:45:40 UTC (rev 746)
+++ branches/1.0/etc/Makefile.am	2007-05-21 22:41:11 UTC (rev 747)
@@ -27,7 +27,11 @@
 	enigma.icns \
 	mac-build.sh \
 	README-SDL.txt \
-	enigma.nsi
+	enigma.nsi.in \
+	enigma.nsi \
+	enigma-inst-lang.nsh \
+	enigma-inst-opt.ini \
+	enigma-inst-welcome.bmp
 
 MOSTLYCLEANFILES = \
 	enigma.dmg

Added: branches/1.0/etc/enigma-inst-lang.nsh
===================================================================
--- branches/1.0/etc/enigma-inst-lang.nsh	2007-05-21 21:45:40 UTC (rev 746)
+++ branches/1.0/etc/enigma-inst-lang.nsh	2007-05-21 22:41:11 UTC (rev 747)
@@ -0,0 +1,41 @@
+  !insertmacro MUI_LANGUAGE &quot;English&quot;
+;  !insertmacro MUI_LANGUAGE &quot;French&quot;
+  !insertmacro MUI_LANGUAGE &quot;German&quot;
+;  !insertmacro MUI_LANGUAGE &quot;Spanish&quot;
+;  !insertmacro MUI_LANGUAGE &quot;Italian&quot;
+;  !insertmacro MUI_LANGUAGE &quot;Dutch&quot;
+;  !insertmacro MUI_LANGUAGE &quot;Swedish&quot;
+;  !insertmacro MUI_LANGUAGE &quot;Finnish&quot;
+;  !insertmacro MUI_LANGUAGE &quot;Russian&quot;       
+;  !insertmacro MUI_LANGUAGE &quot;Portuguese&quot;
+;  !insertmacro MUI_LANGUAGE &quot;Hungarian&quot;
+  ;Include language definitions
+  !include /NONFATAL &quot;enigma-inst-eng.nsh&quot;
+  !include /NONFATAL &quot;enigma-inst-fre.nsh&quot;
+  !include /NONFATAL &quot;enigma-inst-ger.nsh&quot;
+  !include /NONFATAL &quot;enigma-inst-spa.nsh&quot;
+  !include /NONFATAL &quot;enigma-inst-ita.nsh&quot;
+  !include /NONFATAL &quot;enigma-inst-dut.nsh&quot;
+  !include /NONFATAL &quot;enigma-inst-swe.nsh&quot;
+  !include /NONFATAL &quot;enigma-inst-fin.nsh&quot;
+  !include /NONFATAL &quot;enigma-inst-rus.nsh&quot;
+  !include /NONFATAL &quot;enigma-inst-por.nsh&quot;
+  !include /NONFATAL &quot;enigma-inst-hun.nsh&quot;
+
+LangString ProgramDesc ${LANG_ENGLISH} &quot;Enigma is a puzzle game inspired by Oxyd on the Atari ST and Rock'n'Roll on the Amiga. The object of the game is to find uncover pairs of identically colored Oxyd stones.\r\n\r\nSimple? Yes. Easy? Certainly not! Hidden traps, vast mazes, laser beams, and, most of all, countless hairy puzzles usually block your direct way to the Oxyd stones...\r\n\r\nThis wizard guides you through the installation of Enigma.&quot;
+LangString OldInstallSure ${LANG_ENGLISH} &quot;There's already a Enigma installation in the chosen directory.&quot;
+LangString OldInstallMaybe ${LANG_ENGLISH} &quot;The directory you chose is not empty.&quot;
+LangString OldInstallDesc ${LANG_ENGLISH} &quot;Do you want all of its contents to be deleted?&quot;
+LangString OldInstallDesc2 ${LANG_ENGLISH} &quot;Your configuration and scores are not affected.&quot;
+LangString DesktopIcon ${LANG_ENGLISH} &quot;Create desktop symbol&quot;
+LangString Documentation ${LANG_ENGLISH} &quot;Documentation&quot;
+LangString DeleteUserdata ${LANG_ENGLISH} &quot;Delete the Enigma user data with all your personal configuration and scores, too. Do not select this option while upgrading Enigma. Select it only if you want to get rid of all remanents of Enigma forever!&quot;
+
+LangString ProgramDesc ${LANG_GERMAN} &quot;Enigma ist ein R&#228;tselspiel inspiriert von Oxyd auf dem Atari ST und Rock'n'Roll auf dem Amiga. Das Ziel des Spieles ist es, Paare gleichfarbiger Oxydsteine aufzudecken.\r\n\r\nEinfach? Ja. Leicht? Sicherlich nicht! Versteckte Fallen, riesige Irrg&#228;rten, Laserstrahlen und nicht zuletzt zahllose haarige R&#228;tsel versperren Ihren Weg zu den Oxydsteinen ...\r\n\r\nDieser Assistent f&#252;hrt sie durch die Installation von Enigma.&quot;
+LangString OldInstallSure ${LANG_GERMAN} &quot;In dem von Ihnen gew&#228;hlten Ordner ist schon eine Enigma Installation.&quot;
+LangString OldInstallMaybe ${LANG_GERMAN} &quot;Das von Ihnen gew&#228;hlte Verzeichnis ist nicht leer.&quot;
+LangString OldInstallDesc ${LANG_GERMAN} &quot;Soll der Inhalt des Verzeichnisses gel&#246;scht werden?&quot;
+LangString OldInstallDesc2 ${LANG_GERMAN} &quot;Ihre Einstellungen und Scores bleiben dabei erhalten.&quot;
+LangString DesktopIcon ${LANG_GERMAN} &quot;Erstelle Programmverkn&#252;pfung auf dem Desktop&quot;
+LangString Documentation ${LANG_GERMAN} &quot;Dokumentation&quot; ; so k&#246;nnte man die Verkn&#252;pfung im Startmen&#252; nennen
+LangString DeleteUserdata ${LANG_GERMAN} &quot;L&#246;sche auch die Enigma Benutzerdaten mit allen pers&#246;nlichen Einstellungen und Scores. Selektieren sie nicht diese Option wenn Sie planen eine neue Enigma Version zu installieren. Nur wenn sie endg&#252;ltig Enigma mit allen Daten deinstallieren wollen, sollten Sie diese Option selektieren.&quot;                                    
\ No newline at end of file


Property changes on: branches/1.0/etc/enigma-inst-lang.nsh
___________________________________________________________________
Name: svn:eol-style
   + native

Added: branches/1.0/etc/enigma-inst-opt.ini
===================================================================
--- branches/1.0/etc/enigma-inst-opt.ini	2007-05-21 21:45:40 UTC (rev 746)
+++ branches/1.0/etc/enigma-inst-opt.ini	2007-05-21 22:41:11 UTC (rev 747)
@@ -0,0 +1,20 @@
+[Settings]
+NumFields=2
+
+[Field 1]
+Type=checkbox
+Text=Create a desktop icon
+State=1
+Left=0
+Right=-1
+Top=30
+Bottom=65
+
+[Field 2]
+Type=label
+Text=...
+Left=0
+Right=-1
+Top=80
+Bottom=130
+State=1


Property changes on: branches/1.0/etc/enigma-inst-opt.ini
___________________________________________________________________
Name: svn:eol-style
   + native

Added: branches/1.0/etc/enigma-inst-welcome.bmp
===================================================================
(Binary files differ)


Property changes on: branches/1.0/etc/enigma-inst-welcome.bmp
___________________________________________________________________
Name: svn:mime-type
   + image/bmp

Modified: branches/1.0/etc/enigma.nsi.in
===================================================================
--- branches/1.0/etc/enigma.nsi.in	2007-05-21 21:45:40 UTC (rev 746)
+++ branches/1.0/etc/enigma.nsi.in	2007-05-21 22:41:11 UTC (rev 747)
@@ -1,80 +1,329 @@
-; example2.nsi
-;
-; This script is based on example1.nsi, but adds uninstall support
-; and (optionally) start menu shortcuts.
-;
-; It will install notepad.exe into a directory that the user selects,
-;
+;Based on: NSIS Modern User Interface - &quot;Multilingual Example Script&quot; Written by Joost Verburg
 
-!define VERSION &quot;@VERSION@&quot;
+;===================================================
+;Include Modern UI
+  !include &quot;MUI.nsh&quot;
+;Include NSIS Logic Library
+  !include 'LogicLib.nsh'
+;Include Word Functions Header
+  !include &quot;WordFunc.nsh&quot;
+  !insertmacro WordReplace
+  !insertmacro WordAdd
+  !insertmacro un.WordReplace
+  !insertmacro un.WordAdd
 
-; Source directory
-!define SDIR &quot;.\&quot;
+;===================================================
+;General
 
-; The name of the installer
-Name &quot;Enigma&quot;
-Caption &quot;Enigma ${VERSION} Setup&quot;
+  !define NAME &quot;Enigma&quot;
+  !define COMPANY &quot;Enigma Devel&quot;
+  !define WEBSITE &quot;<A HREF="http://www.nongnu.org/enigma">http://www.nongnu.org/enigma</A>&quot;
+  !define VERSION &quot;@VERSION@&quot;
+  !define VERSION4 &quot;${VERSION}.0.0&quot; ; x.x.x.x
+  !define LEGALCOPYRIGHT &quot;Program is under GPL license&quot;
+  !define INSTALLER_REGISTRY_ROOT &quot;HKLM&quot;
+  !define INSTALLER_REGISTRY_KEY &quot;Software\Enigma&quot;
 
-; The file to write
-OutFile &quot;<A HREF="https://lists.berlios.de/mailman/listinfo/enigma-game-svn">Enigma- at VERSION</A>@.exe&quot;
-SetCompressor lzma
+  ; Source directory
+  !define SDIR &quot;.\&quot;
 
-; The default installation directory
-InstallDir $PROGRAMFILES\Enigma
-; Registry key to check for directory (so if you install again, it will 
-; overwrite the old one automatically)
-InstallDirRegKey HKLM SOFTWARE\Enigma &quot;Install_Dir&quot;
+  ;Name and file
+  Name &quot;${NAME} ${VERSION}&quot;
+  OutFile &quot;Enigma-${VERSION}.exe&quot;
+  SetCompressor /SOLID lzma
 
-; The text to prompt the user to enter a directory
-ComponentText &quot;This will install Enigma on your computer. Select which optional things you want installed.&quot;
-; The text to prompt the user to enter a directory
-DirText &quot;Choose a directory to install in to:&quot;
+  ;Default installation folder
+  InstallDir &quot;$PROGRAMFILES\Enigma&quot;
+  ;InstallDirRegKey ${INSTALLER_REGISTRY_ROOT} ${INSTALLER_REGISTRY_KEY} &quot;Install_Dir&quot; ; this is handled with in .oninit
+  
+  ;Vista redirects $SMPROGRAMS to all users without this
+  RequestExecutionLevel admin
 
-; The stuff to install
-Section &quot;Enigma (required)&quot;
+;===================================================
+;Variables
+
+  Var MUI_TEMP
+  Var STARTMENU_FOLDER
+
+;===================================================
+;Interface Settings
+
+  !define MUI_ABORTWARNING
+  !define MUI_WELCOMEFINISHPAGE_BITMAP &quot;enigma-inst-welcome.bmp&quot; ;164x314 bmp
+  !define MUI_UNWELCOMEFINISHPAGE_BITMAP &quot;enigma-inst-welcome.bmp&quot;
+  ; !define MUI_TEXT_WELCOME_INFO_TEXT &quot;text&quot;
+  !define MUI_WELCOMEPAGE_TEXT &quot;$(ProgramDesc)\r\n\r\n$(^ClickNext)&quot;
+  !define MUI_ICON &quot;${NSISDIR}\Contrib\Graphics\Icons\modern-install-blue-full.ico&quot;
+  !define MUI_UNICON &quot;${NSISDIR}\Contrib\Graphics\Icons\modern-uninstall-blue-full.ico&quot;
+
+;===================================================
+;Language Selection Dialog Settings
+
+  ;Remember the installer language
+  !define MUI_LANGDLL_REGISTRY_ROOT ${INSTALLER_REGISTRY_ROOT}
+  !define MUI_LANGDLL_REGISTRY_KEY ${INSTALLER_REGISTRY_KEY}
+  !define MUI_LANGDLL_REGISTRY_VALUENAME &quot;Installer Language&quot;
+  !define MUI_LANGDLL_ALWAYSSHOW
+
+;===================================================
+;Pages
+
+  !define MUI_PAGE_CUSTOMFUNCTION_PRE WelcomePagePre ; hack for link on welcomepage
+  !define MUI_PAGE_CUSTOMFUNCTION_SHOW WelcomePageShow
+  !insertmacro MUI_PAGE_WELCOME
+  ; !insertmacro MUI_PAGE_COMPONENTS ; There's currently only 1 component, so we don't need this
+  
+  !define MUI_PAGE_CUSTOMFUNCTION_LEAVE DirectoryPageLeave
+  !insertmacro MUI_PAGE_DIRECTORY
+  
+  ;Start Menu Folder Page Configuration
+  !define MUI_STARTMENUPAGE_REGISTRY_ROOT &quot;${INSTALLER_REGISTRY_ROOT}&quot;
+  !define MUI_STARTMENUPAGE_REGISTRY_KEY &quot;${INSTALLER_REGISTRY_KEY}&quot;
+  !define MUI_STARTMENUPAGE_REGISTRY_VALUENAME &quot;Start Menu Folder&quot;
+  !define MUI_STARTMENUPAGE_DEFAULTFOLDER &quot;Enigma&quot;
+  
+  !insertmacro MUI_PAGE_STARTMENU Application $STARTMENU_FOLDER
+
+  ;Page that asks for creating an icon on the desktop
+  Page custom CustomOptionsPage
+
+  !insertmacro MUI_PAGE_INSTFILES
+
+  ;finish page configuration
+  !define MUI_FINISHPAGE_RUN enigma.exe
+  ;MUI_FINISHPAGE_RUN_TEXT &quot;text&quot;
+  !define MUI_FINISHPAGE_RUN_NOTCHECKED
+
+  !insertmacro MUI_PAGE_FINISH
+  
+  !insertmacro MUI_UNPAGE_WELCOME
+  ; !insertmacro MUI_UNPAGE_CONFIRM
+  !insertmacro MUI_UNPAGE_DIRECTORY
+  UninstPage custom Un.CustomOptionsPage
+  !insertmacro MUI_UNPAGE_INSTFILES
+  !insertmacro MUI_UNPAGE_FINISH
+
+;===================================================
+;Languages
+
+  !include &quot;enigma-inst-lang.nsh&quot;
+
+
+;===================================================
+;Reserve Files
+  
+  ;If you are using solid compression, files that are required before
+  ;the actual installation should be stored first in the data block,
+  ;because this will make your installer start faster.
+  
+  ReserveFile &quot;enigma-inst-welcome.bmp&quot;
+  ReserveFile &quot;enigma-inst-opt.ini&quot;
+  !insertmacro MUI_RESERVEFILE_INSTALLOPTIONS
+  !insertmacro MUI_RESERVEFILE_LANGDLL
+
+;===================================================
+;Installer Sections
+
+Section &quot;Enigma&quot;
+SectionIn RO
+  ; install for all users
+  SetShellVarContext all
   ; Set output path to the installation directory.
   SetOutPath $INSTDIR
-
-  ; Put file there
+  RMDir /r &quot;$INSTDIR&quot; ; delete the inst. dir. with all its contents
+  ; Add files
   File /r &quot;${SDIR}\data&quot;
   File /r &quot;${SDIR}\images&quot;
   File /r &quot;${SDIR}\manual&quot;
   File /r &quot;${SDIR}\reference&quot;
   File    &quot;${SDIR}\*.*&quot;
+
   ; Write the installation path into the registry
-  WriteRegStr HKLM SOFTWARE\Enigma &quot;Install_Dir&quot; &quot;$INSTDIR&quot;
+  WriteRegStr ${INSTALLER_REGISTRY_ROOT} ${INSTALLER_REGISTRY_KEY} &quot;LastDirectory&quot; &quot;$INSTDIR&quot;
   ; Write the uninstall keys for Windows
-  WriteRegStr HKLM &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\Enigma&quot; &quot;DisplayName&quot; &quot;Enigma&quot;
-  WriteRegStr HKLM &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\Enigma&quot; &quot;UninstallString&quot; '&quot;$INSTDIR\uninstall.exe&quot;'
+  Var /GLOBAL UninstallRegKey
+  StrCpy $UninstallRegKey &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\Enigma&quot;
+  WriteRegStr HKLM $UninstallRegKey &quot;DisplayName&quot; &quot;Enigma&quot;
+  WriteRegStr HKLM $UninstallRegKey &quot;UninstallString&quot; '&quot;$INSTDIR\uninstall.exe&quot;'
+  WriteRegStr HKLM $UninstallRegKey &quot;InstallLocation&quot; &quot;$INSTDIR&quot;
+  WriteRegStr HKLM $UninstallRegKey &quot;Publisher&quot; &quot;${COMPANY}&quot;
+  WriteRegStr HKLM $UninstallRegKey &quot;URLInfoAbout&quot; &quot;${WEBSITE}&quot;
+  WriteRegStr HKLM $UninstallRegKey &quot;DisplayVersion&quot; &quot;${VERSION}&quot;
+  WriteRegDWORD HKLM $UninstallRegKey &quot;NoModify&quot; 1
+  WriteRegDWORD HKLM $UninstallRegKey &quot;NoRepair&quot; 1
+
   WriteUninstaller &quot;uninstall.exe&quot;
-SectionEnd
 
-; optional section
-Section &quot;Start Menu Shortcuts&quot;
-  CreateDirectory &quot;$SMPROGRAMS\Enigma&quot;
-  CreateShortCut &quot;$SMPROGRAMS\Enigma\Enigma.lnk&quot; &quot;$INSTDIR\enigma.exe&quot; &quot;&quot; &quot;$INSTDIR\enigma.exe&quot; 0
-  CreateShortCut &quot;$SMPROGRAMS\Enigma\Documentation.lnk&quot; &quot;$INSTDIR\index.html&quot; &quot;&quot; &quot;$INSTDIR\index.html&quot; 0
-  CreateShortCut &quot;$SMPROGRAMS\Enigma\Uninstall.lnk&quot; &quot;$INSTDIR\uninstall.exe&quot; &quot;&quot; &quot;$INSTDIR\uninstall.exe&quot; 0
+  !insertmacro MUI_STARTMENU_WRITE_BEGIN Application
+    CreateDirectory &quot;$SMPROGRAMS\$STARTMENU_FOLDER&quot;
+    CreateShortCut &quot;$SMPROGRAMS\$STARTMENU_FOLDER\Enigma.lnk&quot; &quot;$INSTDIR\enigma.exe&quot;
+    CreateShortCut &quot;$SMPROGRAMS\$STARTMENU_FOLDER\Documentation.lnk&quot; &quot;$INSTDIR\index.html&quot;
+    CreateShortCut &quot;$SMPROGRAMS\$STARTMENU_FOLDER\Uninstall.lnk&quot; &quot;$INSTDIR\uninstall.exe&quot;
+  !insertmacro MUI_STARTMENU_WRITE_END
+
+  ;Read a value from an InstallOptions INI file
+  !insertmacro MUI_INSTALLOPTIONS_READ $R1 &quot;enigma-inst-opt.ini&quot; &quot;Field 1&quot; &quot;State&quot;
+  
+  ;Create desktop shortcut if check box was checked
+  StrCmp $R1 &quot;1&quot; &quot;&quot; +2
+     CreateShortCut &quot;$DESKTOP\Enigma.lnk&quot; &quot;$INSTDIR\enigma.exe&quot; &quot;&quot; &quot;$INSTDIR\enigma.exe&quot; 0
+
+  ; the following code adds the version + inst. directory to the list of all Enigma installations
+  ReadRegStr $R2 ${INSTALLER_REGISTRY_ROOT} ${INSTALLER_REGISTRY_KEY} &quot;DirectoriesList&quot;
+  ${WordAdd} &quot;$R2&quot; &quot;|&quot; &quot;+${VERSION}:$INSTDIR&quot; $R3
+  WriteRegStr ${INSTALLER_REGISTRY_ROOT} ${INSTALLER_REGISTRY_KEY} &quot;DirectoriesList&quot; $R3
+
 SectionEnd
 
-; uninstall stuff
+;===================================================
+;Installer Functions
 
-UninstallText &quot;This will uninstall Enigma. Hit next to continue.&quot;
+Function .onInit
 
-; special uninstall section.
+  !insertmacro MUI_LANGDLL_DISPLAY
+  ;Extract InstallOptions INI files
+  !insertmacro MUI_INSTALLOPTIONS_EXTRACT &quot;enigma-inst-opt.ini&quot;
+
+  ReadRegStr $R4 ${INSTALLER_REGISTRY_ROOT} ${INSTALLER_REGISTRY_KEY} &quot;Install_Dir&quot; ; key used prior to version 1.01
+  ReadRegStr $R5 ${INSTALLER_REGISTRY_ROOT} ${INSTALLER_REGISTRY_KEY} &quot;LastDirectory&quot;
+
+  ;Get installation folder from registry if available
+  ${If} $R5 != &quot;&quot;
+    StrCpy $INSTDIR $R5
+  ${ElseIf} $R4 != &quot;&quot;
+    StrCpy $INSTDIR $R4
+  ${EndIf}
+
+FunctionEnd
+
+Function CustomOptionsPage
+  !insertmacro MUI_INSTALLOPTIONS_WRITE &quot;enigma-inst-opt.ini&quot; &quot;Field 1&quot; &quot;Text&quot; $(DesktopIcon)
+  !insertmacro MUI_INSTALLOPTIONS_WRITE &quot;enigma-inst-opt.ini&quot; &quot;Field 2&quot; &quot;Text&quot; $(^ClickInstall)
+  ${WordReplace} $(^ComponentsSubCaption) &quot;: &quot; &quot;&quot; &quot;+&quot; $R0
+  !insertmacro MUI_HEADER_TEXT $R0 &quot;$(^ComponentsSubText2_NoInstTypes)&quot;
+  !insertmacro MUI_INSTALLOPTIONS_DISPLAY &quot;enigma-inst-opt.ini&quot;
+FunctionEnd
+
+Function WelcomePagePre
+   !insertmacro MUI_INSTALLOPTIONS_WRITE &quot;ioSpecial.ini&quot; &quot;Field 3&quot; &quot;Bottom&quot; &quot;175&quot;
+   !insertmacro MUI_INSTALLOPTIONS_WRITE &quot;ioSpecial.ini&quot; &quot;Field 4&quot; &quot;Type&quot; &quot;Link&quot;
+   !insertmacro MUI_INSTALLOPTIONS_WRITE &quot;ioSpecial.ini&quot; &quot;Field 4&quot; &quot;Text&quot; &quot;www.enigma-game.org&quot;
+   !insertmacro MUI_INSTALLOPTIONS_WRITE &quot;ioSpecial.ini&quot; &quot;Field 4&quot; &quot;Left&quot; &quot;120&quot;
+   !insertmacro MUI_INSTALLOPTIONS_WRITE &quot;ioSpecial.ini&quot; &quot;Field 4&quot; &quot;Right&quot; &quot;315&quot;
+   !insertmacro MUI_INSTALLOPTIONS_WRITE &quot;ioSpecial.ini&quot; &quot;Field 4&quot; &quot;Top&quot; &quot;175&quot;
+   !insertmacro MUI_INSTALLOPTIONS_WRITE &quot;ioSpecial.ini&quot; &quot;Field 4&quot; &quot;Bottom&quot; &quot;185&quot;
+   !insertmacro MUI_INSTALLOPTIONS_WRITE &quot;ioSpecial.ini&quot; &quot;Field 4&quot; &quot;State&quot; ${WEBSITE}
+   !insertmacro MUI_INSTALLOPTIONS_WRITE &quot;ioSpecial.ini&quot; &quot;Settings&quot; &quot;Numfields&quot; &quot;4&quot;
+FunctionEnd
+
+Function WelcomePageShow
+  ; Thanks to pengyou ; Fix colors of added link control ; See <A HREF="http://forums.winamp.com/showthread.php?s=&amp;threadid=205674">http://forums.winamp.com/showthread.php?s=&amp;threadid=205674</A>
+  Push $0
+  GetDlgItem $0 $MUI_HWND 1203
+  SetCtlColors $0 &quot;0000FF&quot; &quot;FFFFFF&quot;
+  CreateFont $1 &quot;$(^Font)&quot; &quot;$(^FontSize)&quot; &quot;400&quot; /UNDERLINE
+  SendMessage $0 ${WM_SETFONT} $1 1 
+  Pop $0
+FunctionEnd
+
+Function DirectoryPageLeave
+   IfFileExists $INSTDIR\*.* FolderExists endfunction
+   FolderExists:
+      IfFileExists $INSTDIR\Enigma.exe FileDoesExist FileDoesNotexist
+      FileDoesExist:
+        MessageBox MB_YESNO|MB_DEFBUTTON2 &quot;$(OldInstallSure) $(OldInstallDesc) $(OldInstallDesc2)&quot; IDYES endfunction IDNO clickno
+      FileDoesNotexist:
+        MessageBox MB_YESNO|MB_DEFBUTTON2 &quot;$(OldInstallMaybe) $(OldInstallDesc)&quot; IDYES endfunction IDNO clickno
+   clickno:
+    Abort
+   endfunction:
+FunctionEnd
+
+;===================================================
+;Uninstaller Section
+
 Section &quot;Uninstall&quot;
-  ; remove registry keys
-  DeleteRegKey HKLM &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\Enigma&quot;
-  DeleteRegKey HKLM SOFTWARE\Enigma
-  ; remove files
-  ; Delete $INSTDIR\not.exe
-  ; MUST REMOVE UNINSTALLER, too
-  ;Delete $INSTDIR\uninstall.exe
-  ; remove shortcuts, if any.
-  Delete &quot;$SMPROGRAMS\Enigma\*.*&quot;
-  ; remove directories used.
-  RMDir &quot;$SMPROGRAMS\Enigma&quot;
+
+  ; uninstall for all users
+  SetShellVarContext all
+
+  ; remove start-menu items
+  !insertmacro MUI_STARTMENU_GETFOLDER Application $MUI_TEMP
+
+  Delete &quot;$SMPROGRAMS\$MUI_TEMP\Enigma.lnk&quot;
+  Delete &quot;$SMPROGRAMS\$MUI_TEMP\Documentation.lnk&quot;
+  Delete &quot;$SMPROGRAMS\$MUI_TEMP\Uninstall.lnk&quot;
+  
+  ;Delete empty start menu parent directories
+  StrCpy $MUI_TEMP &quot;$SMPROGRAMS\$MUI_TEMP&quot;
+  startMenuDeleteLoop:
+	ClearErrors
+    RMDir $MUI_TEMP
+    GetFullPathName $MUI_TEMP &quot;$MUI_TEMP\..&quot;
+    IfErrors startMenuDeleteLoopDone
+    StrCmp $MUI_TEMP $SMPROGRAMS startMenuDeleteLoopDone startMenuDeleteLoop
+  startMenuDeleteLoopDone:
+
+  ; remove desktop shortcut
+  Delete &quot;$DESKTOP\Enigma.lnk&quot;
+
+  ; read a value from an InstallOptions INI file
+  !insertmacro MUI_INSTALLOPTIONS_READ $R7 &quot;enigma-inst-opt.ini&quot; &quot;Field 1&quot; &quot;State&quot;
+
+  ; remove Enigma user data if check box was checked
+  SetShellVarContext current ; Enigma's user data is stored for the current user
+  StrCmp $R7 &quot;1&quot; &quot;&quot; +2
+      RMDir /r &quot;$APPDATA\Enigma&quot;
+  SetShellVarContext all ; get back to all users
+
+  ; the following code removes the version + inst. directory from the list of all Enigma installations
+  ReadRegStr $R8 ${INSTALLER_REGISTRY_ROOT} ${INSTALLER_REGISTRY_KEY} &quot;DirectoriesList&quot;
+  ;MessageBox MB_OK &quot;R8: $R8&quot;
+  ${un.WordAdd} &quot;$R8&quot; &quot;|&quot; &quot;-${VERSION}:$INSTDIR&quot; $R9
+  ;MessageBox MB_OK &quot;R9: $R9&quot;
+  WriteRegStr ${INSTALLER_REGISTRY_ROOT} ${INSTALLER_REGISTRY_KEY} &quot;DirectoriesList&quot; $R9
+
+  ; remove registry keys only if there's no other version of Enigma installed
+  StrCmp $R9 &quot;&quot; nonewinst donotdelete
+  nonewinst:
+  ReadRegStr $R6 ${INSTALLER_REGISTRY_ROOT} ${INSTALLER_REGISTRY_KEY} &quot;Install_Dir&quot;
+  StrCmp $R6 &quot;&quot; deleteit 0
+  StrCmp $R6 &quot;$INSTDIR&quot; deleteit donotdelete
+  deleteit:
+  DeleteRegKey ${INSTALLER_REGISTRY_ROOT} &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\Enigma&quot;
+  DeleteRegKey ${INSTALLER_REGISTRY_ROOT} ${INSTALLER_REGISTRY_KEY}
+  donotdelete:
+  
+  ; remove application directory with all its contents
   RMDir /r &quot;$INSTDIR&quot;
 SectionEnd
 
-; eof
+;===================================================
+;Uninstaller Functions
+
+Function un.onInit
+  !insertmacro MUI_UNGETLANGUAGE
+  ;Extract InstallOptions INI files
+  !insertmacro MUI_INSTALLOPTIONS_EXTRACT &quot;enigma-inst-opt.ini&quot;
+FunctionEnd
+
+Function Un.CustomOptionsPage
+  !insertmacro MUI_INSTALLOPTIONS_WRITE &quot;enigma-inst-opt.ini&quot; &quot;Field 1&quot; &quot;Text&quot; $(DeleteUserdata)
+  !insertmacro MUI_INSTALLOPTIONS_WRITE &quot;enigma-inst-opt.ini&quot; &quot;Field 2&quot; &quot;Text&quot; $(^ClickUninstall)
+  !insertmacro MUI_INSTALLOPTIONS_WRITE &quot;enigma-inst-opt.ini&quot; &quot;Field 1&quot; &quot;State&quot; &quot;0&quot; ; default: unchecked
+  ${un.WordReplace} $(^UnComponentsSubCaption) &quot;: &quot; &quot;&quot; &quot;+&quot; $R0
+  !insertmacro MUI_HEADER_TEXT $R0 &quot;$(^UnComponentsSubText2_NoInstTypes)&quot;
+  !insertmacro MUI_INSTALLOPTIONS_DISPLAY &quot;enigma-inst-opt.ini&quot;
+FunctionEnd
+
+;===================================================
+;Version Information
+
+  VIProductVersion &quot;${VERSION4}&quot;
+  VIAddVersionKey /LANG=0 &quot;ProductName&quot; &quot;${NAME} ${VERSION}&quot;
+  VIAddVersionKey /LANG=0 &quot;FileDescription&quot; &quot;${NAME} Installer&quot;
+  VIAddVersionKey /LANG=0 &quot;CompanyName&quot; &quot;${COMPANY}&quot;
+  VIAddVersionKey /LANG=0 &quot;FileVersion&quot; &quot;${VERSION}&quot;
+  VIAddVersionKey /LANG=0 &quot;LegalCopyright&quot; &quot;${LEGALCOPYRIGHT}&quot;
+
+;===================================================
\ No newline at end of file

Modified: branches/1.0/etc/mingw32-dist.sh.in
===================================================================
--- branches/1.0/etc/mingw32-dist.sh.in	2007-05-21 21:45:40 UTC (rev 746)
+++ branches/1.0/etc/mingw32-dist.sh.in	2007-05-21 22:41:11 UTC (rev 747)
@@ -212,6 +212,9 @@
 copy_doc
 
 cp $BDIR/etc/enigma.nsi $DDIR/enigma.nsi
+cp $BDIR/etc/enigma-inst-lang.nsh $DDIR/enigma-inst-lang.nsh
+cp $BDIR/etc/enigma-inst-opt.ini $DDIR/enigma-inst-opt.ini
+cp $BDIR/etc/enigma-inst-welcome.bmp $DDIR/enigma-inst-welcome.bmp
 cp -p $BDIR/src/enigma.exe $DDIR/enigma.exe
 
 copy_dlls


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000183.html">[Enigma-game-svn] r746 - in branches/1.0: . src
</A></li>
	<LI>Next message: <A HREF="000185.html">[Enigma-game-svn] r748 - in branches/1.0: . src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#184">[ date ]</a>
              <a href="thread.html#184">[ thread ]</a>
              <a href="subject.html#184">[ subject ]</a>
              <a href="author.html#184">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/enigma-game-svn">More information about the Enigma-game-svn
mailing list</a><br>
</body></html>
