<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Enigma-game-svn] r1793 - in trunk: data	data/levels/enigma_experimental src src/actors src/floors	src/items src/stones
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/enigma-game-svn/2009-September/index.html" >
   <LINK REL="made" HREF="mailto:enigma-game-svn%40lists.berlios.de?Subject=Re%3A%20%5BEnigma-game-svn%5D%20r1793%20-%20in%20trunk%3A%20data%0A%09data/levels/enigma_experimental%20src%20src/actors%20src/floors%0A%09src/items%20src/stones&In-Reply-To=%3C200909052326.n85NQF1B000602%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001221.html">
   <LINK REL="Next"  HREF="001223.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Enigma-game-svn] r1793 - in trunk: data	data/levels/enigma_experimental src src/actors src/floors	src/items src/stones</H1>
    <B>ral at BerliOS</B> 
    <A HREF="mailto:enigma-game-svn%40lists.berlios.de?Subject=Re%3A%20%5BEnigma-game-svn%5D%20r1793%20-%20in%20trunk%3A%20data%0A%09data/levels/enigma_experimental%20src%20src/actors%20src/floors%0A%09src/items%20src/stones&In-Reply-To=%3C200909052326.n85NQF1B000602%40sheep.berlios.de%3E"
       TITLE="[Enigma-game-svn] r1793 - in trunk: data	data/levels/enigma_experimental src src/actors src/floors	src/items src/stones">ral at mail.berlios.de
       </A><BR>
    <I>Sun Sep  6 01:26:15 CEST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="001221.html">[Enigma-game-svn] r1792 - in trunk: attic/images-stones data	data/gfx16 data/gfx32 data/gfx40 data/gfx48 data/gfx64
</A></li>
        <LI>Next message: <A HREF="001223.html">[Enigma-game-svn] r1794 - trunk/src/stones
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1222">[ date ]</a>
              <a href="thread.html#1222">[ thread ]</a>
              <a href="subject.html#1222">[ subject ]</a>
              <a href="author.html#1222">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: ral
Date: 2009-09-06 01:26:05 +0200 (Sun, 06 Sep 2009)
New Revision: 1793

Modified:
   trunk/data/api1init.lua
   trunk/data/levels/enigma_experimental/floors_1.xml
   trunk/data/models-2d.lua
   trunk/src/GridObject.cc
   trunk/src/GridObject.hh
   trunk/src/Inventory.cc
   trunk/src/Object.cc
   trunk/src/Object.hh
   trunk/src/WorldProxy.cc
   trunk/src/WorldProxy.hh
   trunk/src/actors.cc
   trunk/src/actors/Balls.cc
   trunk/src/actors/Balls.hh
   trunk/src/actors/BugActor.cc
   trunk/src/actors/BugActor.hh
   trunk/src/actors/HorseActor.cc
   trunk/src/actors/HorseActor.hh
   trunk/src/actors/KillerActor.cc
   trunk/src/actors/KillerActor.hh
   trunk/src/actors/Rotors.cc
   trunk/src/actors/Rotors.hh
   trunk/src/display.hh
   trunk/src/floors.cc
   trunk/src/floors.hh
   trunk/src/floors/BridgeFloor.cc
   trunk/src/floors/BridgeFloor.hh
   trunk/src/floors/FloodStream.cc
   trunk/src/floors/FloodStream.hh
   trunk/src/floors/SimpleFloors.cc
   trunk/src/floors/SimpleFloors.hh
   trunk/src/floors/SlopeFloor.cc
   trunk/src/floors/SlopeFloor.hh
   trunk/src/floors/StandardFloors.cc
   trunk/src/floors/StandardFloors.hh
   trunk/src/floors/ThiefFloor.cc
   trunk/src/floors/ThiefFloor.hh
   trunk/src/items.cc
   trunk/src/items.hh
   trunk/src/items/BlockerItem.cc
   trunk/src/items/CompatibilityItems.cc
   trunk/src/items/PipeItem.cc
   trunk/src/items/PipeItem.hh
   trunk/src/items/StripItem.cc
   trunk/src/lua.cc
   trunk/src/player.cc
   trunk/src/player.hh
   trunk/src/stones.cc
   trunk/src/stones.hh
   trunk/src/stones/BlockerStone.cc
   trunk/src/stones/BlockerStone.hh
   trunk/src/stones/BoulderStone.cc
   trunk/src/stones/BoxStone.cc
   trunk/src/stones/BoxStone.hh
   trunk/src/stones/BrakeStone.cc
   trunk/src/stones/ChameleonStone.cc
   trunk/src/stones/ChessStone.cc
   trunk/src/stones/ClusterStone.cc
   trunk/src/stones/ClusterStone.hh
   trunk/src/stones/CompatibilityStones.cc
   trunk/src/stones/CompatibilityStones.hh
   trunk/src/stones/FakeStone.cc
   trunk/src/stones/FakeStone.hh
   trunk/src/stones/FlatStone.cc
   trunk/src/stones/LaserStone.cc
   trunk/src/stones/LaserSwitch.cc
   trunk/src/stones/MailStone.cc
   trunk/src/stones/MonoFlopStone.cc
   trunk/src/stones/OxydStone.cc
   trunk/src/stones/OxydStone.hh
   trunk/src/stones/PuzzleStone.cc
   trunk/src/stones/SimpleStones.cc
   trunk/src/stones/TimerStone.cc
   trunk/src/world.cc
   trunk/src/world.hh
Log:
Trunk 1.1: internal reengineering
- abolish get_kind(), is_kind() with their mixture of class, variation and
    model name results
- simulate old API GetKind in api1init by addition of a GetClass function
- do no longer store kind as an object attribute
- resolve kind always via object validator
- prefer usage of getClass where possible
- introduce getModelName - currently used model of an object
    - support all static floors in all variations and most other objects
    - used by st_chameleon
    - used by default init_model()
    - objects with own init_model do not yet support this method
- all floors test level: add st_chameleon vs. floor test
Note:
- this patch affects most objects in essential parts - please report any
  unexpected behaviour changes


Modified: trunk/data/api1init.lua
===================================================================
--- trunk/data/api1init.lua	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/data/api1init.lua	2009-09-05 23:26:05 UTC (rev 1793)
@@ -701,8 +701,12 @@
 end
 
 function enigma.GetKind(obj)
-    local _newname = enigma._GetKind(obj)
+    local _newname = enigma.GetClass(obj)
     local _oldname = RenamingObjectsNew2Old[_newname]
+    
+    if _oldname == nil then
+        _oldname = RenamingObjectsNew2Old[enigma._GetKind(obj)]
+    end
 
     if _newname == &quot;st_key&quot; then
         local code = enigma._GetAttrib(obj, &quot;code&quot;)

Modified: trunk/data/levels/enigma_experimental/floors_1.xml
===================================================================
--- trunk/data/levels/enigma_experimental/floors_1.xml	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/data/levels/enigma_experimental/floors_1.xml	2009-09-05 23:26:05 UTC (rev 1793)
@@ -3,7 +3,7 @@
   &lt;el:protected&gt;
     &lt;el:info el:type=&quot;level&quot;&gt;
       &lt;el:identity el:title=&quot;All Floors as of Enigma 1.10&quot; el:subtitle=&quot;&quot; el:id=&quot;floors&quot;/&gt;
-      &lt;el:version el:score=&quot;1&quot; el:release=&quot;1&quot; el:revision=&quot;1&quot; el:status=&quot;experimental&quot;/&gt;
+      &lt;el:version el:score=&quot;1&quot; el:release=&quot;1&quot; el:revision=&quot;2&quot; el:status=&quot;experimental&quot;/&gt;
       &lt;el:author  el:name=&quot;Raoul Bourquin&quot; el:email=&quot;&quot;/&gt;
       &lt;el:copyright&gt;Copyright &#169; 2009 Raoul Bourquin&lt;/el:copyright&gt;
       &lt;el:license el:type=&quot;GPL v2.0 or above&quot; el:open=&quot;true&quot;/&gt;
@@ -196,6 +196,12 @@
         wo[no[&quot;here&quot;]] = floors[sender.x-5]
     end
 end
+
+wo[{0,9}] = {&quot;st_switch&quot;, target=&quot;chameleon&quot;}
+wo[{1,9}] = {&quot;it_document&quot;, text=&quot;Add st_chameleon on this row&quot;}
+function chameleon(value, sender)
+    wo:drawBorder(sender + 6*E, wo[&quot;Width&quot;] - 12, 1, {&quot;st_chameleon&quot;})
+end
  ]]&gt;&lt;/el:luamain&gt;
     &lt;el:i18n&gt;
       &lt;el:string el:key=&quot;title&quot;&gt;

Modified: trunk/data/models-2d.lua
===================================================================
--- trunk/data/models-2d.lua	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/data/models-2d.lua	2009-09-05 23:26:05 UTC (rev 1793)
@@ -573,7 +573,7 @@
 -- it_strip --
 do
     DefSubimages(&quot;it_strip&quot;, {modelname=&quot;it_strip&quot;, w=4, h=4, startindex=0})
-    DefAlias(&quot;it_strip&quot;, &quot;it_strip0&quot;)
+--    DefAlias(&quot;it_strip&quot;, &quot;it_strip0&quot;)
 end
 
 ----------------------------------------
@@ -847,21 +847,21 @@
 do
     DefSubimages(&quot;st_bluesand&quot;, {modelname=&quot;st_bluesandx&quot;,w=4,h=4})
     for i=0,15 do DefSolidStone(&quot;st_bluesand&quot;..i, &quot;st_bluesandx&quot;..(i+1)) end
-    DefSolidStone(&quot;st_bluesand&quot;, &quot;st_bluesandx1&quot;)
+--    DefSolidStone(&quot;st_bluesand&quot;, &quot;st_bluesandx1&quot;)
 end
 
 -- st_brick --
 do
     DefSubimages(&quot;st_brick&quot;, {modelname=&quot;st_brickx&quot;,w=4,h=4})
     for i=0,15 do DefSolidStone(&quot;st_brick&quot;..i, &quot;st_brickx&quot;..(i+1)) end
-    DefSolidStone(&quot;st_brick&quot;, &quot;st_brickx1&quot;)
+--    DefSolidStone(&quot;st_brick&quot;, &quot;st_brickx1&quot;)
 end
 
 -- st_panel --
 do
     DefSubimages(&quot;st_panel&quot;, {modelname=&quot;st_panelx&quot;,w=4,h=4})
     for i=0,15 do DefSolidStone(&quot;st_panel&quot;..i, &quot;st_panelx&quot;..(i+1)) end
-    DefSolidStone(&quot;st_panel&quot;, &quot;st_panelx1&quot;)
+--    DefSolidStone(&quot;st_panel&quot;, &quot;st_panelx1&quot;)
 end
 
 -- st_boulder --
@@ -1599,7 +1599,7 @@
 
 -- st_magic --
 do
-    DefAlias(&quot;st_magic_brick&quot;, &quot;st_brick&quot;)
+    DefAlias(&quot;st_magic_brick&quot;, &quot;st_brick0&quot;)
     DefAlias(&quot;st_magic_oxyda&quot;, &quot;st_oxyda&quot;)
     DefAlias(&quot;st_magic_oxydc&quot;, &quot;st_oxydc&quot;)
 end

Modified: trunk/src/GridObject.cc
===================================================================
--- trunk/src/GridObject.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/GridObject.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -1,6 +1,6 @@
 /*
  * Copyright (C) 2002,2003,2004,2005 Daniel Heck
- * Copyright (C) 2007 Ronald Lamprecht
+ * Copyright (C) 2007,2008,2009 Ronald Lamprecht
  *
  * This program is free software; you can redistribute it and/or
  * modify it under the terms of the GNU General Public License
@@ -88,14 +88,6 @@
         return pos.x &gt;= 0;
     }
     
-    display::Model *GridObject::set_anim (const std::string &amp;mname) 
-    {
-        set_model (mname);
-        display::Model *m = get_model();
-        m-&gt;set_callback(this);
-        return m;
-    }
-    
     bool GridObject::sound_event (const char *name, double vol)
     {
         return sound::EmitSoundEvent (name, get_pos().center(), getVolume(name, this, vol));
@@ -108,7 +100,7 @@
     
         va_start(arg_ptr, format);
     
-        fprintf(stderr, &quot;%p \&quot;%s\&quot; at %i/%i: &quot;, this, get_kind(), position.x, position.y);
+        fprintf(stderr, &quot;%p \&quot;%s\&quot; at %i/%i: &quot;, this, getKind().c_str(), position.x, position.y);
         vfprintf(stderr, format, arg_ptr);
         fputc('\n', stderr);
     
@@ -155,17 +147,20 @@
     }
     
     std::string GridObject::getModelName() const {
-        return get_kind();
+        return getClass();
     }
     
     void GridObject::init_model() {
-        DirectionBits c = getConnections();
-        if (c != NODIRBIT)
-            set_model(getModelName() + ecl::strf(&quot;%d&quot;, c));
-        else
-            set_model(getModelName());
+        set_model(getModelName());
     }
 
+    void GridObject::set_anim (const std::string &amp;mname) 
+    {
+        set_model (mname);
+        display::Model *m = get_model();
+        m-&gt;set_callback(this);
+    }
+    
     DirectionBits GridObject::getConnections() const {
         if (Value v = getAttr(&quot;$connections&quot;))
             return DirectionBits((int)v);

Modified: trunk/src/GridObject.hh
===================================================================
--- trunk/src/GridObject.hh	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/GridObject.hh	2009-09-05 23:26:05 UTC (rev 1793)
@@ -103,7 +103,6 @@
 
         // Helper functions
         bool sound_event (const char *name, double vol = 1.0);
-        display::Model *set_anim (const std::string &amp;mname);
 
         DirectionBits getConnections() const;
         virtual DirectionBits getFaces(bool actorInvisible = false) const;
@@ -111,11 +110,14 @@
         virtual double squareDistance(const Object *other) const;
         virtual bool isSouthOrEastOf(const Object *other) const;
 
+        virtual std::string getModelName() const;
+        virtual display::Model *get_model () = 0;
+
     protected:
         // GridObject interface
-        virtual std::string getModelName() const;
         virtual void set_model (const std::string &amp;mname) = 0;
-        virtual display::Model *get_model () = 0;
+        void set_anim (const std::string &amp;mname);
+
         virtual void kill_model (GridPos p) = 0;
 
         virtual void init_model();

Modified: trunk/src/Inventory.cc
===================================================================
--- trunk/src/Inventory.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/Inventory.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -192,7 +192,7 @@
 {
     size_t size_ = size();
     for (size_t i = start_idx; i&lt;size_; ++i) {
-        if (get_item(i)-&gt;is_kind(kind))
+        if (get_item(i)-&gt;isKind(kind))
             return static_cast&lt;int&gt; (i);
     }
     return -1;

Modified: trunk/src/Object.cc
===================================================================
--- trunk/src/Object.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/Object.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -106,34 +106,13 @@
     
     Object::~Object() {
         freeId(id);
-    //cerr &lt;&lt; &quot;obj del &quot; &lt;&lt; id &lt;&lt; &quot; - &quot; &lt;&lt; this-&gt;get_kind() &lt;&lt;&quot;\n&quot;;
+    //cerr &lt;&lt; &quot;obj del &quot; &lt;&lt; id &lt;&lt; &quot; - &quot; &lt;&lt; this-&gt;getKind() &lt;&lt;&quot;\n&quot;;
     }
     
     int Object::getId() const {
         return id;
-    }
+    }    
     
-    const char * Object::get_kind() const {      // To be made pure virtual
-        AttribMap::const_iterator i = attribs.find(&quot;kind&quot;);
-        ASSERT(i != attribs.end() &amp;&amp; i-&gt;second.getType() == Value::STRING, XLevelRuntime,
-                ecl::strf(&quot;Object: attribute kind not found - class '%s'&quot;, getClass().c_str()).c_str());
-        return i-&gt;second.get_string();
-    }
-    
-    // check kind of object
-    // kind_templ may contain wildcards ( ? and * )
-    bool Object::is_kind(const char *kind_templ) const {
-        return ecl::string_match(get_kind(), kind_templ);
-    }
-    
-    bool Object::is_kind(const string&amp; kind_templ) const {
-        return ecl::string_match(get_kind(), kind_templ.c_str());
-    }
-    
-    std::string Object::getClass() const {
-        return get_kind();  // should be abstract, but until end of the reengineering we need compatibility
-    }
-    
     std::string Object::getKind() const {
         return ObjectValidator::instance()-&gt;getKind(this);
     }
@@ -375,7 +354,7 @@
                             // we may need to translate the new API message to old API
                             obj_action = lua::NewMessageName(lua::LevelState(), *oit, action);
 //                            if (obj_action != action)
-//                                Log &lt;&lt; &quot;PerformAction renamed '&quot; &lt;&lt; action &lt;&lt; &quot;' to '&quot; &lt;&lt; obj_action &lt;&lt; &quot;' for receiver '&quot; &lt;&lt; (*oit)-&gt;get_kind() &lt;&lt; &quot;'\n&quot;;
+//                                Log &lt;&lt; &quot;PerformAction renamed '&quot; &lt;&lt; action &lt;&lt; &quot;' to '&quot; &lt;&lt; obj_action &lt;&lt; &quot;' for receiver '&quot; &lt;&lt; (*oit)-&gt;getKind() &lt;&lt; &quot;'\n&quot;;
                         }
                         // check if message is valid, otherwise ignore message
                         if (obj_action != &quot;nop&quot; &amp;&amp; (*oit)-&gt;validateMessage(obj_action, messageValue))
@@ -457,7 +436,7 @@
     
         va_start(arg_ptr, format);
     
-        fprintf(stderr, &quot;%p non-grid-\&quot;%s\&quot;: &quot;, this, get_kind());
+        fprintf(stderr, &quot;%p non-grid-\&quot;%s\&quot;: &quot;, this, getKind().c_str());
         vfprintf(stderr, format, arg_ptr);
         fputc('\n', stderr);
     

Modified: trunk/src/Object.hh
===================================================================
--- trunk/src/Object.hh	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/Object.hh	2009-09-05 23:26:05 UTC (rev 1793)
@@ -100,9 +100,6 @@
         
         /* ---------- depreceated methods ---------- */
 
-        bool is_kind(const char *kind) const;
-        bool is_kind(const string&amp; kind) const;
-        virtual const char *get_kind() const;
         const AttribMap &amp;get_attribs() const { return attribs; }  // just used by ObjectRepos::dump_info()        
 
         /* ---------- Helper routines ---------- */
@@ -121,7 +118,7 @@
          * both impleneted by the class &quot;ClusterStone&quot;. In this case we talk about a 
          * common &quot;familiy&quot;. 
          */
-        virtual std::string getClass() const;
+        virtual std::string getClass() const =0;
         
         /**
          * The most specific object category name. Many objects change their kind during
@@ -192,8 +189,8 @@
         Value getDefaultedAttr(const string &amp;key, Value defaultValue) const;
         
         
-        virtual Object *clone()=0;
-        virtual void dispose()=0;
+        virtual Object *clone() =0;
+        virtual void dispose() =0;
 
         virtual void warning(const char *format, ...) const;
         virtual ObjectType getObjectType() const;

Modified: trunk/src/WorldProxy.cc
===================================================================
--- trunk/src/WorldProxy.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/WorldProxy.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -42,6 +42,10 @@
     WorldProxy::WorldProxy() {
     }
 
+    std::string WorldProxy::getClass() const {
+        return &quot;WorldProxy&quot;;
+    }
+    
     Value WorldProxy::getAttr(const std::string &amp;key) const {
         if (key == &quot;AllowSingleOxyds&quot;) {
             return server::AllowSingleOxyds;

Modified: trunk/src/WorldProxy.hh
===================================================================
--- trunk/src/WorldProxy.hh	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/WorldProxy.hh	2009-09-05 23:26:05 UTC (rev 1793)
@@ -27,6 +27,7 @@
     public:
         static WorldProxy *instance();
         static void shutdown();
+        virtual std::string getClass() const;
         virtual Value getAttr(const string&amp; key) const;
         virtual void setAttr(const string&amp; key, const Value &amp;val);
         

Modified: trunk/src/actors/Balls.cc
===================================================================
--- trunk/src/actors/Balls.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/actors/Balls.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -245,7 +245,7 @@
     }
     
     void BasicBall::animcb() {
-        string kind=get_kind();
+        std::string kind = getModelBaseName();
     
         switch (state) {
             case SHATTERING:
@@ -294,6 +294,10 @@
         }
     }
     
+    std::string BasicBall::getModelBaseName() const {
+        return getKind();
+    }
+    
     void BasicBall::sink(double dtime) {
         double sink_speed  = 0.0;
         double raise_speed = 0.0;   // at this velocity don't sink; above: raise
@@ -313,7 +317,7 @@
             sinkDepth += sinkSpeed*dtime;
     
             if (sinkDepth &gt;= maxSinkDepth) {
-                set_model(string(get_kind())+&quot;-sunk&quot;);
+                set_model(getModelBaseName() + &quot;-sunk&quot;);
                 ai-&gt;vel = V2();     // stop!
                 sound_event (&quot;swamp&quot;);
                 change_state(BUBBLING);
@@ -341,7 +345,7 @@
         if (newstate == state)
             return;
     
-        std::string kind = get_kind();
+        std::string kind = getModelBaseName();
         iState oldstate = (iState)state;
         
         if (oldstate == JUMPING) {
@@ -438,7 +442,7 @@
         switch (state) {
             case NORMAL:
                 if (sinkDepth &gt; minSinkDepth &amp;&amp; sinkDepth &lt; maxSinkDepth) {
-                    set_sink_model(get_kind());
+                    set_sink_model(getModelBaseName());
                 }
                 else {
                     ActorInfo *ai = get_actorinfo();
@@ -472,7 +476,7 @@
     void BasicBall::set_shine_model (bool shinep)
     {
         if (shinep != lastshinep) {
-            string modelname = get_kind();
+            std::string modelname = getModelBaseName();
             if (shinep)
                 set_model (modelname + &quot;-shine&quot;);
             else
@@ -524,6 +528,7 @@
             m_halosprite.move (get_pos());
         }
     }
+    
 
 /* -------------------- Marble  -------------------- */
     Marble::Marble(int color) : BasicBall(traits[color]) {
@@ -537,10 +542,6 @@
         return &quot;ac_marble&quot;;
     }
 
-    const char *Marble::get_kind() const {
-        return getAttr(&quot;color&quot;) == BLACK ? &quot;ac_marble_black&quot; : &quot;ac_marble_white&quot;;
-    }
-
     int Marble::traitsIdx() const {
         return getAttr(&quot;color&quot;);
     }
@@ -562,10 +563,6 @@
         return &quot;ac_pearl&quot;;
     }
 
-    const char *Pearl::get_kind() const {
-        return &quot;ac_pearl_white&quot;;
-    }
-    
     void Pearl::sink(double dtime) {
         if (server::GameCompatibility != GAMET_ENIGMA) {
             if (m_actorinfo.field-&gt;floor-&gt;isKind(&quot;fl_swamp&quot;))  

Modified: trunk/src/actors/Balls.hh
===================================================================
--- trunk/src/actors/Balls.hh	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/actors/Balls.hh	2009-09-05 23:26:05 UTC (rev 1793)
@@ -85,6 +85,7 @@
         virtual void animcb();
 
     protected:
+        virtual std::string getModelBaseName() const;
         virtual void sink(double dtime);
 
     private:
@@ -126,7 +127,6 @@
         
         // Object interface.
         virtual std::string getClass() const;
-        virtual const char *get_kind() const;
         
     private:
         int traitsIdx() const;
@@ -142,7 +142,6 @@
         
         // Object interface.
         virtual std::string getClass() const;
-        virtual const char *get_kind() const;
         
     protected:
         virtual void sink(double dtime);

Modified: trunk/src/actors/BugActor.cc
===================================================================
--- trunk/src/actors/BugActor.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/actors/BugActor.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -34,10 +34,6 @@
         return &quot;ac_bug&quot;;
     }
 
-    const char *Bug::get_kind() const {
-        return &quot;ac_bug&quot;;
-    }
-
     bool Bug::is_dead() const {
         return false;
     }

Modified: trunk/src/actors/BugActor.hh
===================================================================
--- trunk/src/actors/BugActor.hh	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/actors/BugActor.hh	2009-09-05 23:26:05 UTC (rev 1793)
@@ -37,7 +37,6 @@
         
         // Object interface.
         virtual std::string getClass() const;
-        virtual const char *get_kind() const;
 
         // Actor interface
         virtual bool is_dead() const;

Modified: trunk/src/actors/HorseActor.cc
===================================================================
--- trunk/src/actors/HorseActor.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/actors/HorseActor.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -35,10 +35,6 @@
         return &quot;ac_horse&quot;;
     }
 
-    const char *Horse::get_kind() const {
-        return &quot;ac_horse&quot;;
-    }
-
     bool Horse::is_dead() const {
         return false;
     }

Modified: trunk/src/actors/HorseActor.hh
===================================================================
--- trunk/src/actors/HorseActor.hh	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/actors/HorseActor.hh	2009-09-05 23:26:05 UTC (rev 1793)
@@ -37,8 +37,6 @@
         
         // Object interface.
         virtual std::string getClass() const;
-        virtual const char *get_kind() const;
-//        virtual void setAttr(const string&amp; key, const Value &amp;val);
 
         // Actor interface
         virtual bool is_dead() const;

Modified: trunk/src/actors/KillerActor.cc
===================================================================
--- trunk/src/actors/KillerActor.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/actors/KillerActor.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -37,10 +37,6 @@
         return &quot;ac_killer&quot;;
     }
 
-    const char *Killer::get_kind() const {
-        return &quot;ac_killer&quot;;
-    }
-
     bool Killer::is_dead() const {
         return false;
     }

Modified: trunk/src/actors/KillerActor.hh
===================================================================
--- trunk/src/actors/KillerActor.hh	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/actors/KillerActor.hh	2009-09-05 23:26:05 UTC (rev 1793)
@@ -36,8 +36,6 @@
         
         // Object interface.
         virtual std::string getClass() const;
-        virtual const char *get_kind() const;
-//        virtual void setAttr(const string&amp; key, const Value &amp;val);
 
         // Actor interface
         virtual bool is_dead() const;

Modified: trunk/src/actors/Rotors.cc
===================================================================
--- trunk/src/actors/Rotors.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/actors/Rotors.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -108,10 +108,6 @@
         return &quot;ac_rotor&quot;;
     }
 
-    const char *Rotor::get_kind() const {
-        return &quot;ac_rotor&quot;;
-    }
-
     bool Rotor::on_collision (Actor *a) {
         if (a-&gt;is_on_floor())
             SendMessage(a, &quot;_shatter&quot;);
@@ -128,10 +124,6 @@
         return &quot;ac_top&quot;;
     }
 
-    const char *Top::get_kind() const {
-        return &quot;ac_top&quot;;
-    }
-
     bool Top::on_collision (Actor *a) {
         // tops shatter and collide independent on flying status of oponent 
         SendMessage(a, &quot;_shatter&quot;);

Modified: trunk/src/actors/Rotors.hh
===================================================================
--- trunk/src/actors/Rotors.hh	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/actors/Rotors.hh	2009-09-05 23:26:05 UTC (rev 1793)
@@ -61,7 +61,6 @@
         
         // Object interface.
         virtual std::string getClass() const;
-        virtual const char *get_kind() const;
 
         // Actor interface
         virtual bool on_collision(Actor *a);
@@ -77,7 +76,6 @@
         
         // Object interface.
         virtual std::string getClass() const;
-        virtual const char *get_kind() const;
 
         // Actor interface
         virtual bool on_collision(Actor *a);

Modified: trunk/src/actors.cc
===================================================================
--- trunk/src/actors.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/actors.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -229,7 +229,7 @@
     if (Value vy = getAttr(&quot;velocity_y&quot;)) {
         m_actorinfo.vel = V2(m_actorinfo.vel[0], vy);
     }
-    set_model(get_kind());
+    set_model(getKind());
     m_sprite.move(p);
     move();
 }

Modified: trunk/src/display.hh
===================================================================
--- trunk/src/display.hh	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/display.hh	2009-09-05 23:26:05 UTC (rev 1793)
@@ -39,7 +39,6 @@
     public:
         virtual ~ModelCallback() {}
         virtual void animcb() = 0;
-        virtual bool isDisplayable() {return true;}
     };
 
     class Animation {

Modified: trunk/src/floors/BridgeFloor.cc
===================================================================
--- trunk/src/floors/BridgeFloor.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/floors/BridgeFloor.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -95,8 +95,8 @@
             setState(0);
     }
 
-    void BridgeFloor::init_model()  {
-        set_model(model_basename() + ((state==OPEN) ? &quot;open&quot; : &quot;closed&quot;));
+    std::string BridgeFloor::getModelName() const {
+        return model_basename() + ((state==OPEN) ? &quot;open&quot; : &quot;closed&quot;);
     }
     
     void BridgeFloor::on_creation(GridPos p) {

Modified: trunk/src/floors/BridgeFloor.hh
===================================================================
--- trunk/src/floors/BridgeFloor.hh	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/floors/BridgeFloor.hh	2009-09-05 23:26:05 UTC (rev 1793)
@@ -54,7 +54,7 @@
         virtual void toggleState();
 
         // GridObject interface
-        virtual void init_model();
+        virtual std::string getModelName() const;
         virtual void on_creation(GridPos p);
                 
         // ModelCallback interface  - Animation callback

Modified: trunk/src/floors/FloodStream.cc
===================================================================
--- trunk/src/floors/FloodStream.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/floors/FloodStream.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -45,24 +45,6 @@
         }   
     }
 
-    // temporary hack for backward compatibility during reengineering
-    const char * FloodStream::get_kind() const {
-        if (getAttr(&quot;faces&quot;).to_string() == &quot;nesw&quot;)
-            switch (getTyp()) { 
-                case WATER : return &quot;fl_water_framed&quot;;
-                case WOOD :  return &quot;fl_wood_framed&quot;;
-                case HAY :   return &quot;fl_hay_framed&quot;;
-                case ROCK :  return &quot;fl_rock_framed&quot;;
-            }
-        else
-            switch (getTyp()) { 
-                case WATER : return &quot;fl_water&quot;;
-                case WOOD :  return &quot;fl_wood&quot;;
-                case HAY :   return &quot;fl_hay&quot;;
-                case ROCK :  return &quot;fl_rock&quot;;
-            }   
-    }
-        
     Value FloodStream::message(const Message &amp;m) {
         if (m.message == &quot;_checkflood&quot;) {
             Item *it = GetItem(get_pos());
@@ -86,14 +68,15 @@
             state = extState;
     }
     
-    void FloodStream::init_model()  {
-        bool isFramed = (getAttr(&quot;faces&quot;).to_string() == &quot;nesw&quot;);
+    std::string FloodStream::getModelName() const {
+        std::string modelbase = getClass();
+        if (getAttr(&quot;faces&quot;).to_string() == &quot;nesw&quot;)
+             modelbase += &quot;_framed&quot;;
         if (getTyp() == WOOD) {
             int modelnr = (objFlags &amp; OBJBIT_MODEL) &gt;&gt; 26;
-            set_model((std::string)get_kind() + ((modelnr == 0 )? &quot;&quot; : ecl::strf(&quot;%d&quot;, modelnr))); 
-        } else {
-            set_model(get_kind());
-        } 
+            modelbase += (modelnr == 0 ) ? &quot;&quot; : ecl::strf(&quot;%d&quot;, modelnr); 
+        }
+        return modelbase;
     }
     
     void FloodStream::on_creation(GridPos p) {

Modified: trunk/src/floors/FloodStream.hh
===================================================================
--- trunk/src/floors/FloodStream.hh	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/floors/FloodStream.hh	2009-09-05 23:26:05 UTC (rev 1793)
@@ -53,14 +53,13 @@
 
         // Object interface
         virtual std::string getClass() const;
-        virtual const char *get_kind() const;
         virtual Value message(const Message &amp;m);
         
         // StateObject interface
         virtual void setState(int extState);
 
         // GridObject interface
-        virtual void init_model();
+        virtual std::string getModelName() const;
         virtual void on_creation(GridPos p);
                 
         // Floor interface

Modified: trunk/src/floors/SimpleFloors.cc
===================================================================
--- trunk/src/floors/SimpleFloors.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/floors/SimpleFloors.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -69,10 +69,10 @@
         return &quot;fl_fake&quot;;
     }
     
-    void FakeFloor::init_model()  {
-        set_model(&quot;fl_fake_&quot; + getAttr(&quot;flavor&quot;).to_string());
+    std::string FakeFloor::getModelName() const {
+        return &quot;fl_fake_&quot; + getAttr(&quot;flavor&quot;).to_string();
     }
-
+    
 /* -------------------- Ice -------------------- */
 
     IceFloor::IceFloor() : Floor (&quot;fl_ice&quot;) {
@@ -92,8 +92,8 @@
         return &quot;fl_inverse&quot;;
     }
     
-    void InverseFloor::init_model()  {
-        set_model(&quot;fl_inverse_&quot; + getAttr(&quot;flavor&quot;).to_string());
+    std::string InverseFloor::getModelName() const {
+        return &quot;fl_inverse_&quot; + getAttr(&quot;flavor&quot;).to_string();
     }
 
 /* -------------------- Space -------------------- */
@@ -144,13 +144,6 @@
         return &quot;fl_yinyang&quot;;
     }
     
-    const char *YinyangFloor::get_kind() const {   //just for st_chameleon support
-        if (state == YIN)
-           return (objFlags &amp; OBJBIT_INVISIBLE) ? &quot;fl_yinyang_yin_invisible&quot; : &quot;fl_yinyang_yin&quot;;
-        else
-           return (objFlags &amp; OBJBIT_INVISIBLE) ? &quot;fl_yinyang_yang_invisible&quot; : &quot;fl_yinyang_yang&quot;;
-    }
-    
     void YinyangFloor::setAttr(const std::string &amp;key, const Value &amp;val) {
         if (key == &quot;invisible&quot;) {
             objFlags = (objFlags &amp; ~OBJBIT_INVISIBLE) | (val.to_bool() ? OBJBIT_INVISIBLE : 0);
@@ -168,9 +161,9 @@
         return Floor::getAttr(key);
     }
         
-    void YinyangFloor::init_model()  {
-        set_model(ecl::strf(&quot;fl_yinyang_%s%s&quot;, (state == YIN) ? &quot;yin&quot; : &quot;yang&quot;, 
-                objFlags &amp; OBJBIT_INVISIBLE ? &quot;_invisible&quot; : &quot;&quot;));
+    std::string YinyangFloor::getModelName() const {
+        return ecl::strf(&quot;fl_yinyang_%s%s&quot;, (state == YIN) ? &quot;yin&quot; : &quot;yang&quot;, 
+                objFlags &amp; OBJBIT_INVISIBLE ? &quot;_invisible&quot; : &quot;&quot;);
     }
     
     ecl::V2 YinyangFloor::process_mouseforce (Actor *a, ecl::V2 force) {

Modified: trunk/src/floors/SimpleFloors.hh
===================================================================
--- trunk/src/floors/SimpleFloors.hh	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/floors/SimpleFloors.hh	2009-09-05 23:26:05 UTC (rev 1793)
@@ -70,7 +70,7 @@
         virtual std::string getClass() const;
         
         // GridObject interface
-        virtual void init_model();
+        virtual std::string getModelName() const;
     };
 
     /** 
@@ -99,7 +99,7 @@
         virtual std::string getClass() const;
         
         // GridObject interface
-        virtual void init_model();
+        virtual std::string getModelName() const;
     };
 
     /** 
@@ -161,12 +161,11 @@
 
         // Object interface
         virtual std::string getClass() const;
-        virtual const char *get_kind() const;
         virtual void setAttr(const std::string &amp;key, const Value &amp;val);
         virtual Value getAttr(const std::string &amp;key) const;
         
         // GridObject interface
-        virtual void init_model();
+        virtual std::string getModelName() const;
                 
         // Floor interface
         virtual ecl::V2 process_mouseforce (Actor *a, ecl::V2 force);

Modified: trunk/src/floors/SlopeFloor.cc
===================================================================
--- trunk/src/floors/SlopeFloor.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/floors/SlopeFloor.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -77,12 +77,12 @@
         // ignore any state change attempts
     }
     
-    void SlopeFloor::init_model()  {
+    std::string SlopeFloor::getModelName() const {
         std::string shape = getAttr(&quot;shape&quot;).to_string();
         if (shape == &quot;&quot;)
-            set_model(&quot;fl_slope&quot;);
+            return &quot;fl_slope&quot;;
         else
-            set_model(std::string(&quot;fl_slope_&quot;) + shape);
+            return std::string(&quot;fl_slope_&quot;) + shape;
     }
     
     void SlopeFloor::add_force(Actor *a, ecl::V2 &amp;f) {

Modified: trunk/src/floors/SlopeFloor.hh
===================================================================
--- trunk/src/floors/SlopeFloor.hh	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/floors/SlopeFloor.hh	2009-09-05 23:26:05 UTC (rev 1793)
@@ -46,7 +46,7 @@
         virtual void setState(int extState);
 
         // GridObject interface
-        virtual void init_model();
+        virtual std::string getModelName() const;
                 
         // Floor interface
         virtual void add_force(Actor *, ecl::V2 &amp;);

Modified: trunk/src/floors/StandardFloors.cc
===================================================================
--- trunk/src/floors/StandardFloors.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/floors/StandardFloors.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -113,10 +113,10 @@
         // no external states
     }
     
-    void StandardFloor::init_model()  {
+    std::string StandardFloor::getModelName() const {
         bool isFramed = (getAttr(&quot;faces&quot;).to_string() == &quot;nesw&quot;);
-        set_model((StandardFloorNames[state].submodel.length() &gt; 0 ? StandardFloorNames[state].submodel :
-                StandardFloorNames[state].classname) +  (isFramed ? &quot;_framed&quot; : &quot;&quot;));
+        return ((StandardFloorNames[state].submodel.length() &gt; 0) ? StandardFloorNames[state].submodel :
+                StandardFloorNames[state].classname) +  (isFramed ? &quot;_framed&quot; : &quot;&quot;);
     }
     
     BOOT_REGISTER_START

Modified: trunk/src/floors/StandardFloors.hh
===================================================================
--- trunk/src/floors/StandardFloors.hh	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/floors/StandardFloors.hh	2009-09-05 23:26:05 UTC (rev 1793)
@@ -37,7 +37,7 @@
         virtual void setState(int extState);
 
         // GridObject interface
-        virtual void init_model();
+        virtual std::string getModelName() const;
     };
 } // namespace enigma
 

Modified: trunk/src/floors/ThiefFloor.cc
===================================================================
--- trunk/src/floors/ThiefFloor.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/floors/ThiefFloor.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -69,8 +69,12 @@
         Floor::on_creation(p);
     }
     
+    std::string ThiefFloor::getModelName() const {
+        return ecl::strf(&quot;fl_thief%d&quot;, ((objFlags &amp; OBJBIT_MODEL) &gt;&gt; 24) + 1);
+    }
+    
     void ThiefFloor::init_model() {
-        std::string basename = ecl::strf(&quot;fl_thief%d&quot;, ((objFlags &amp; OBJBIT_MODEL) &gt;&gt; 24) + 1);
+        std::string basename = getModelName();
         switch (state) {
             case IDLE:
             case CAPTURED:

Modified: trunk/src/floors/ThiefFloor.hh
===================================================================
--- trunk/src/floors/ThiefFloor.hh	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/floors/ThiefFloor.hh	2009-09-05 23:26:05 UTC (rev 1793)
@@ -58,6 +58,7 @@
         virtual void setState(int extState);
 
         // GridObject interface
+        virtual std::string getModelName() const;
         virtual void init_model();
         virtual void on_creation(GridPos p);
         virtual void actor_enter(Actor *a);

Modified: trunk/src/floors.cc
===================================================================
--- trunk/src/floors.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/floors.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -49,18 +49,6 @@
   fire_countdown(1)
 {}
 
-const char * Floor::get_kind() const {
-    return traits.name.c_str();
-}
-
-Floor *Floor::clone() {
-    return new Floor(*this);
-}
-
-void Floor::dispose() {
-    delete this;
-}
-
 Value Floor::message(const Message &amp;m) {
     // &quot;_init&quot;     : Start burning, if &quot;initfire&quot; is set.
     // &quot;heat&quot;     : Heat the item, heat-transform floor
@@ -314,8 +302,8 @@
             // non-Enigma-compatibility-mode it should, when its neighbor
             // is of the same kind and burns also.
             if (Floor *fl = GetFloor(move(p, sourcedir))) {
-                string sourcekind = fl-&gt;get_kind();
-                string mykind = this-&gt;get_kind();
+                string sourcekind = fl-&gt;getClass();
+                string mykind = this-&gt;getClass();
                 if (no_closing_stone &amp;&amp; sourcekind == mykind)
                     if (has_firetype(flft_fastfire))
                         return force_fire();
@@ -378,7 +366,7 @@
     if (!doHeatTransform || get_heattransform(false) == &quot;&quot;)
         return false;
     if (doHeatTransform &amp;&amp; get_heattransform(false) != &quot;&quot; &amp;&amp; !heating_animation) {
-        set_anim(((string) this-&gt;get_kind()) + &quot;_heating&quot;);
+        set_anim(getClass() + &quot;_heating&quot;);
         heating_animation = true;
     }
     return true;

Modified: trunk/src/floors.hh
===================================================================
--- trunk/src/floors.hh	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/floors.hh	2009-09-05 23:26:05 UTC (rev 1793)
@@ -88,9 +88,6 @@
                const char *firetransform_ = &quot;&quot;, const char *heattransform_ = &quot;&quot;);
 
         // Object interface
-        virtual const char *get_kind() const;
-        Floor *clone();
-        void dispose();
         virtual Value message(const Message &amp;m);
         virtual void setAttr(const string&amp; key, const Value &amp;val);
         virtual Value getAttr(const std::string &amp;key) const;

Modified: trunk/src/items/BlockerItem.cc
===================================================================
--- trunk/src/items/BlockerItem.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/items/BlockerItem.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -46,7 +46,7 @@
     Value BlockerItem::message(const Message &amp;m) {
         if (m.message == &quot;_init&quot;) { 
             if (Stone *st = GetStone(get_pos())) {
-                if (st-&gt;is_kind(&quot;st_boulder&quot;))
+                if (st-&gt;getClass() == &quot;st_boulder&quot;)
                     if (state == IDLE &amp;&amp; server::GameCompatibility != GAMET_PEROXYD)
                         setIState(UNLOCKED);
                     else if (state == NEW || server::GameCompatibility != GAMET_PEROXYD)
@@ -121,7 +121,7 @@
     
     void BlockerItem::stone_change(Stone *st) {
         if (st != NULL) {
-            if (st-&gt;is_kind(&quot;st_boulder&quot;)) { // boulder arrived
+            if (st-&gt;getClass() == &quot;st_boulder&quot;) { // boulder arrived
                 switch (state) {
                     case IDLE:
                         setIState(UNLOCKED);  // will grow when boulder moves away

Modified: trunk/src/items/CompatibilityItems.cc
===================================================================
--- trunk/src/items/CompatibilityItems.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/items/CompatibilityItems.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -68,11 +68,11 @@
             // before stones are created.
             if (server::GetDifficulty() == DIFFICULTY_EASY) {
                 if (Stone *st = GetStone (get_pos())) {
-                    if (st-&gt;is_kind (&quot;st_death&quot;) ||
-                        st-&gt;is_kind (&quot;st_flash&quot;) ||
-                        st-&gt;is_kind (&quot;st_thief&quot;))
+                    if (st-&gt;getClass() == &quot;st_death&quot; ||
+                        st-&gt;getClass() == &quot;st_flash&quot; ||
+                        st-&gt;getClass() == &quot;st_thief&quot;)
                     {
-                        SetStone (get_pos(), MakeStone (&quot;st_flat&quot;));
+                        SetStone (get_pos(), MakeStone(&quot;st_flat&quot;));
                     }
                     else
                         KillStone(get_pos());

Modified: trunk/src/items/PipeItem.cc
===================================================================
--- trunk/src/items/PipeItem.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/items/PipeItem.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -74,11 +74,7 @@
     std::string PipeItem::getClass() const {
         return &quot;it_pipe&quot;;
     }
-    
-    std::string PipeItem::getModelName() const {
-        return &quot;it_pipe_&quot;;
-    }
-    
+        
     int PipeItem::traitsIdx() const {
         static int idx[] = { 0, 0, 1, 2, 3, 4, 5, 0, 6, 7, 8, 0, 9, 0, 0, 0};
         return idx[getConnections()];

Modified: trunk/src/items/PipeItem.hh
===================================================================
--- trunk/src/items/PipeItem.hh	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/items/PipeItem.hh	2009-09-05 23:26:05 UTC (rev 1793)
@@ -35,9 +35,6 @@
 
         // Object interface
         virtual std::string getClass() const;
-
-        // Gridobject interface
-        virtual std::string getModelName() const;
         
         // Item interface
         

Modified: trunk/src/items/StripItem.cc
===================================================================
--- trunk/src/items/StripItem.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/items/StripItem.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -37,7 +37,7 @@
     }
     
     std::string StripItem::getModelName() const {
-        return getClass();
+        return getClass() +  ecl::strf(&quot;%d&quot;, getConnections());
     }
     
     void StripItem::init_model() {

Modified: trunk/src/items.cc
===================================================================
--- trunk/src/items.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/items.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -66,8 +66,7 @@
     SetItem(get_pos(), newitem);
 }
 
-const char *Item::get_kind() const
-{
+std::string Item::getClass() const {
     return get_traits().name;
 }
 
@@ -82,9 +81,9 @@
         return GridObject::getAttr(key);
     }
 
-string Item::get_inventory_model()
+std::string Item::get_inventory_model()
 {
-    return get_kind();
+    return getKind();
 }
 
 void Item::init_model()

Modified: trunk/src/items.hh
===================================================================
--- trunk/src/items.hh	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/items.hh	2009-09-05 23:26:05 UTC (rev 1793)
@@ -198,7 +198,7 @@
         void replace(std::string kind);
 
         /* ---------- Virtual functions ---------- */
-        const char *get_kind() const;
+        virtual std::string getClass() const;
         virtual Value getAttr(const std::string &amp;key) const;
 
         void init_model();

Modified: trunk/src/lua.cc
===================================================================
--- trunk/src/lua.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/lua.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -574,6 +574,28 @@
 }
 
 static int
+en_get_class(lua_State *L)
+{
+    Object *obj = to_object(L,1);
+
+    if (!obj) {
+        throwLuaError(L, &quot;GetClass: invalid object&quot;);
+        return 0;
+    }
+
+    try {
+        push_value(L, Value(obj-&gt;getClass()));
+    }  
+    catch (const XLevelRuntime &amp;e) {
+        throwLuaError (L, e.what());
+    }
+    catch (...) {
+        throwLuaError (L, &quot;uncaught exception&quot;);
+    }
+    return 1;
+}
+
+static int
 en_get_kind(lua_State *L)
 {
     Object *obj = to_object(L,1);
@@ -584,7 +606,7 @@
     }
 
     try {
-        push_value(L, Value(obj-&gt;get_kind()));
+        push_value(L, Value(obj-&gt;getKind()));
     }  
     catch (const XLevelRuntime &amp;e) {
         throwLuaError (L, e.what());
@@ -3406,6 +3428,7 @@
 
     {en_get_pos,            &quot;GetPos&quot;},
     {en_get_attrib,         &quot;GetAttrib&quot;},
+    {en_get_class,          &quot;GetClass&quot;},
     {en_get_kind,           &quot;GetKind&quot;},
     {en_is_same_object,     &quot;IsSameObject&quot;},
 

Modified: trunk/src/player.cc
===================================================================
--- trunk/src/player.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/player.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -261,7 +261,7 @@
 {
     if (Inventory *inv = GetInventory(a))
         if (Item *it = inv-&gt;get_item(0))
-            return it-&gt;is_kind(kind);
+            return it-&gt;isKind(kind);
     return false;
 }
 
@@ -581,23 +581,19 @@
     }
 }
 
-void player::PickupStoneAsItem (Actor *a, enigma::GridPos p) 
-{
-    if (Inventory *inv = MayPickup(a, GetField(p)-&gt;item, true)) {
-        if (Stone *stone = GetStone(p))  {
-            string kind = stone-&gt;get_kind();
-            if (kind[0] == 's') 
-                kind[0] = 'i';
-
-            if (Item *item = MakeItem(kind.c_str())) {
-                inv-&gt;add_item(item);
-                stone-&gt;transferIdentity(item);
-                KillStone(p);
-                player::RedrawInventory(inv);
-                sound::EmitSoundEvent (&quot;pickup&quot;, p.center());
-            }
+bool player::PickupAsItem(Actor *a, GridObject *obj, std::string kind) {
+    if (Item *item = MakeItem(kind.c_str())) {
+        if (Inventory *inv = MayPickup(a, item, true)) {
+            inv-&gt;add_item(item);
+            obj-&gt;transferIdentity(item);
+            player::RedrawInventory(inv);
+            sound::EmitSoundEvent(&quot;pickup&quot;, a-&gt;get_pos());
+            return true;
+        } else {
+            DisposeObject(item);
         }
     }
+    return false;
 }
 
 void player::ActivateFirstItem() 

Modified: trunk/src/player.hh
===================================================================
--- trunk/src/player.hh	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/player.hh	2009-09-05 23:26:05 UTC (rev 1793)
@@ -89,7 +89,7 @@
 
         void InhibitPickup (bool yesno);
         void PickupItem (Actor *a, enigma::GridPos p);
-        void PickupStoneAsItem (Actor *a, enigma::GridPos p);
+        bool PickupAsItem(Actor *a, GridObject *obj, std::string kind);
         void RotateInventory (int dir=1);
 
         void ActivateFirstItem();

Modified: trunk/src/stones/BlockerStone.cc
===================================================================
--- trunk/src/stones/BlockerStone.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/stones/BlockerStone.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -1,6 +1,6 @@
 /*
  * Copyright (C) 2002,2003,2004 Daniel Heck
- * Copyright (C) 2008 Ronald Lamprecht
+ * Copyright (C) 2008,2009 Ronald Lamprecht
  *
  * This program is free software; you can redistribute it and/or
  * modify it under the terms of the GNU General Public License
@@ -25,10 +25,14 @@
 
 namespace enigma {
     
-    BlockerStone::BlockerStone(bool solid) : Stone (solid ? &quot;st_blocker&quot; : &quot;st_blocker_new&quot;) {
+    BlockerStone::BlockerStone(bool solid) {
         state = solid ? SOLID : GROWING; 
     }
 
+    std::string BlockerStone::getClass() const {
+        return &quot;st_blocker&quot;;
+    }
+    
     BlockerStone * BlockerStone::clone() {
         BlockerStone * dup = new BlockerStone(*this);
         NameObject(dup, &quot;$BlockerStone#&quot;);  // auto name object to avoid problems with object values

Modified: trunk/src/stones/BlockerStone.hh
===================================================================
--- trunk/src/stones/BlockerStone.hh	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/stones/BlockerStone.hh	2009-09-05 23:26:05 UTC (rev 1793)
@@ -48,6 +48,7 @@
         BlockerStone(bool solid);
         
         // Object interface
+        virtual std::string getClass() const;
         virtual BlockerStone *clone();
         virtual void dispose();
         virtual Value message(const Message &amp;m);

Modified: trunk/src/stones/BoulderStone.cc
===================================================================
--- trunk/src/stones/BoulderStone.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/stones/BoulderStone.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -139,7 +139,7 @@
 
     void BoulderStone::on_floor_change() {
         Floor *fl = GetFloor(get_pos());
-        if (fl-&gt;is_kind(&quot;fl_abyss&quot;)) {
+        if (fl-&gt;getClass() == &quot;fl_abyss&quot;) {
             state = FALLING;
             init_model();
         }
@@ -160,7 +160,7 @@
         if (state == FALLING)
             return;
 
-        if (impulse.sender &amp;&amp; impulse.sender-&gt;is_kind(&quot;st_rotator&quot;)) {
+        if (impulse.sender &amp;&amp; impulse.sender-&gt;getClass() == &quot;st_rotator&quot;) {
             setDir(impulse.dir);  // activate
         }
         move_stone(impulse.dir);  // due to rotator and impulsestone

Modified: trunk/src/stones/BoxStone.cc
===================================================================
--- trunk/src/stones/BoxStone.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/stones/BoxStone.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 2008 Ronald Lamprecht
+ * Copyright (C) 2008,2009 Ronald Lamprecht
  *
  * This program is free software; you can redistribute it and/or
  * modify it under the terms of the GNU General Public License
@@ -49,22 +49,6 @@
         return &quot;st_box&quot;;
     }
     
-    const char *BoxStone::get_kind() const {
-        BoxStoneTyp typ = (BoxStoneTyp)((objFlags &amp; OBJBIT_SUBTYP) &gt;&gt; 25);
-        switch (typ) {
-            case WOOD:
-                return &quot;st_box_wood&quot;;
-            case WOOD1:
-                return &quot;st_box_wood_h&quot;;
-            case WOOD2:
-                return &quot;st_box_wood_v&quot;;
-            case HAY:
-                return &quot;st_box_hay&quot;;
-            case ROCK:
-                return &quot;st_box_rock&quot;;
-        }
-    }
-
     Value BoxStone::getAttr(const std::string &amp;key) const {
         if (key == &quot;flavor&quot;) {
             BoxStoneTyp typ = (BoxStoneTyp)((objFlags &amp; OBJBIT_SUBTYP) &gt;&gt; 25);
@@ -173,7 +157,7 @@
         if (server::GameCompatibility != GAMET_ENIGMA &amp;&amp; IsLevelBorder(p))
             return;
         if (Floor *oldfl = GetFloor(p)) {
-            const std::string &amp;k = oldfl-&gt;get_kind();
+            std::string k = oldfl-&gt;getClass();
             if (objFlags &amp; OBJBIT_BLOCKFIRE)
                 SendMessage(oldfl, &quot;stopfire&quot;);
             if (k == &quot;fl_abyss&quot; || k == &quot;fl_water&quot; || k == &quot;fl_swamp&quot;) {

Modified: trunk/src/stones/BoxStone.hh
===================================================================
--- trunk/src/stones/BoxStone.hh	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/stones/BoxStone.hh	2009-09-05 23:26:05 UTC (rev 1793)
@@ -58,7 +58,6 @@
         virtual BoxStone* clone();
         virtual void dispose();
         virtual std::string getClass() const;
-        virtual const char *get_kind() const;  // for backward compatibility
         virtual Value getAttr(const std::string &amp;key) const;
         virtual Value message(const Message &amp;m);
         

Modified: trunk/src/stones/BrakeStone.cc
===================================================================
--- trunk/src/stones/BrakeStone.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/stones/BrakeStone.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -47,7 +47,7 @@
         Stone::on_creation(p);
 
         Item    *it = GetItem(p);
-        if (it &amp;&amp; it-&gt;is_kind(&quot;it_blocker&quot;)) {
+        if (it &amp;&amp; it-&gt;getClass() == &quot;it_blocker&quot;) {
             KillItem(p);
         }
     }
@@ -70,7 +70,8 @@
         double dist = ecl::length(a-&gt;get_pos() - p.center());
 
         if (dist &lt; BRAKE_RADIUS) {
-            player::PickupStoneAsItem(a, p);
+            if (player::PickupAsItem(a, this, &quot;it_brake&quot;))
+                KillStone(p);
         }
     }
     

Modified: trunk/src/stones/ChameleonStone.cc
===================================================================
--- trunk/src/stones/ChameleonStone.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/stones/ChameleonStone.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -41,7 +41,7 @@
     
     void ChameleonStone::init_model()  {
         if (Floor *fl = GetFloor(get_pos())) {
-            set_model(fl-&gt;get_kind());
+            set_model(fl-&gt;getModelName());
         } else
             ASSERT(false, XLevelRuntime, &quot;Chameleon Stone: Floor must be set before stone&quot;);
     }

Modified: trunk/src/stones/ChessStone.cc
===================================================================
--- trunk/src/stones/ChessStone.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/stones/ChessStone.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -151,9 +151,9 @@
     void ChessStone::on_floor_change() {
         Floor *fl = GetFloor(get_pos());
         if (fl != NULL) {
-            if (fl-&gt;is_kind(&quot;fl_abyss&quot;))
+            if (fl-&gt;getClass() == &quot;fl_abyss&quot;)
                 try_state(FALLING);
-            if (fl-&gt;is_kind(&quot;fl_swamp&quot;))
+            if (fl-&gt;getClass() ==&quot;fl_swamp&quot;)
                 try_state(SINKING);
         }
     }

Modified: trunk/src/stones/ClusterStone.cc
===================================================================
--- trunk/src/stones/ClusterStone.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/stones/ClusterStone.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -30,10 +30,6 @@
         return getAttr(&quot;$class&quot;).to_string();
     }
     
-    const char *ClusterStone::get_kind() const {
-        return getClass().c_str();
-    }
-    
     void ClusterStone::setAttr(const string&amp; key, const Value &amp;val) {
         if (key == &quot;connections&quot; || key == &quot;faces&quot; || key == &quot;cluster&quot;) {
             Stone::setAttr(key, val);
@@ -64,7 +60,7 @@
     }
     
     std::string ClusterStone::getModelName() const {
-        return getClass();
+        return getClass() +  ecl::strf(&quot;%d&quot;, getConnections());
     }
 
     bool ClusterStone::is_removable() const {

Modified: trunk/src/stones/ClusterStone.hh
===================================================================
--- trunk/src/stones/ClusterStone.hh	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/stones/ClusterStone.hh	2009-09-05 23:26:05 UTC (rev 1793)
@@ -35,7 +35,6 @@
         
         // Object interface
         virtual std::string getClass() const;
-        virtual const char *get_kind() const;  // for backward compatibility
         virtual void setAttr(const string&amp; key, const Value &amp;val);
         virtual Value message(const Message &amp;m);
         

Modified: trunk/src/stones/CompatibilityStones.cc
===================================================================
--- trunk/src/stones/CompatibilityStones.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/stones/CompatibilityStones.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -45,9 +45,13 @@
 
 /* -------------------- DummyStone -------------------- */
 
-    DummyStone::DummyStone() : Stone(&quot;st_dummy&quot;){
+    DummyStone::DummyStone() {
     }
     
+    std::string DummyStone::getClass() const {
+        return &quot;st_dummy&quot;;
+    }
+    
     StoneResponse DummyStone::collision_response(const StoneContact &amp;/*sc*/) {
         static int lastCode = -1;
         int        code     = getAttr(&quot;code&quot;);

Modified: trunk/src/stones/CompatibilityStones.hh
===================================================================
--- trunk/src/stones/CompatibilityStones.hh	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/stones/CompatibilityStones.hh	2009-09-05 23:26:05 UTC (rev 1793)
@@ -43,6 +43,9 @@
     public:
         DummyStone();
     
+        // Object interface
+        virtual std::string getClass() const;
+
         // Stone interface
         virtual StoneResponse collision_response(const StoneContact &amp;sc);
     };

Modified: trunk/src/stones/FakeStone.cc
===================================================================
--- trunk/src/stones/FakeStone.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/stones/FakeStone.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -32,16 +32,6 @@
         return &quot;st_fake&quot;;
     }
     
-    const char *FakeStone::get_kind() const {
-        std::string fl = getAttr(&quot;flavor&quot;).to_string();
-        if (fl == &quot;quake&quot;) return &quot;st_fake_quake&quot;;
-        else if (fl == &quot;oxyda&quot;) return &quot;st_fake_oxyda&quot;;
-        else if (fl == &quot;oxydb&quot;) return &quot;st_fake_oxydb&quot;;
-        else if (fl == &quot;oxydc&quot;) return &quot;st_fake_oxydc&quot;;
-        else if (fl == &quot;oxydd&quot;) return &quot;st_fake_oxydd&quot;;
-        else if (fl == &quot;oxyde&quot;) return &quot;st_fake_oxyde&quot;;
-    }
-    
     void FakeStone::setAttr(const string&amp; key, const Value &amp;val) {
         if (key == &quot;flavor&quot;) {
             std::string fl = val.to_string();

Modified: trunk/src/stones/FakeStone.hh
===================================================================
--- trunk/src/stones/FakeStone.hh	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/stones/FakeStone.hh	2009-09-05 23:26:05 UTC (rev 1793)
@@ -54,7 +54,6 @@
         
         // Object interface
         virtual std::string getClass() const;
-        virtual const char *get_kind() const;
         virtual void setAttr(const string&amp; key, const Value &amp;val);
         virtual Value getAttr(const std::string &amp;key) const;
         

Modified: trunk/src/stones/FlatStone.cc
===================================================================
--- trunk/src/stones/FlatStone.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/stones/FlatStone.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -137,7 +137,7 @@
                     state == FALLING;
                     init_model();
                 }
-                else if ((objFlags &amp; OBJBIT_MOVABLE) &amp;&amp; ((fl-&gt;is_kind(&quot;fl_swamp&quot;) || fl-&gt;is_kind(&quot;fl_water&quot;)))) {
+                else if ((objFlags &amp; OBJBIT_MOVABLE) &amp;&amp; (fl-&gt;getClass() == &quot;fl_swamp&quot; || fl-&gt;getClass() ==&quot;fl_water&quot;)) {
                     sound_event(&quot;drown&quot;);
                     client::Msg_Sparkle(p.center());
                     KillStone(p);

Modified: trunk/src/stones/LaserStone.cc
===================================================================
--- trunk/src/stones/LaserStone.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/stones/LaserStone.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -34,7 +34,7 @@
         }
     }
 
-    LaserStone::LaserStone(Direction dir) : Stone(&quot;st_laser&quot;) {
+    LaserStone::LaserStone(Direction dir) {
         setAttr(&quot;orientation&quot;, Value(dir));
     }
     

Modified: trunk/src/stones/LaserSwitch.cc
===================================================================
--- trunk/src/stones/LaserSwitch.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/stones/LaserSwitch.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -25,7 +25,7 @@
 
 namespace enigma {
 
-    LaserSwitch::LaserSwitch() : Stone(&quot;st_laserswitch&quot;) {
+    LaserSwitch::LaserSwitch() {
         state = NEW;
     }
 

Modified: trunk/src/stones/MailStone.cc
===================================================================
--- trunk/src/stones/MailStone.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/stones/MailStone.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -26,7 +26,7 @@
 //#include &quot;main.hh&quot;
 
 namespace enigma {
-    MailStone::MailStone(Direction dir) : Stone(&quot;st_mail&quot;) {
+    MailStone::MailStone(Direction dir) {
         setAttr(&quot;orientation&quot;, Value(dir));
     }
     

Modified: trunk/src/stones/MonoFlopStone.cc
===================================================================
--- trunk/src/stones/MonoFlopStone.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/stones/MonoFlopStone.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -26,7 +26,7 @@
 
 namespace enigma {
     
-    MonoFlopStone::MonoFlopStone(bool lightsensitive, bool isOn) : Stone(&quot;st_monoflop&quot;) {
+    MonoFlopStone::MonoFlopStone(bool lightsensitive, bool isOn) {
         if (lightsensitive)
             objFlags |= OBJBIT_LASER;
         state = isOn ? ON_PENDING : OFF_NEW;

Modified: trunk/src/stones/OxydStone.cc
===================================================================
--- trunk/src/stones/OxydStone.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/stones/OxydStone.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -840,11 +840,15 @@
     
     // Instance Methods
     
-    OxydStone::OxydStone(std::string flavor) : Stone(&quot;st_oxyd&quot;) {
+    OxydStone::OxydStone(std::string flavor) {
         setAttr(&quot;flavor&quot;, flavor);
         setAttr(&quot;oxydcolor&quot;, AUTO);
     }
     
+    std::string OxydStone::getClass() const {
+        return &quot;st_oxyd&quot;;
+    }
+
     OxydStone * OxydStone::clone() { 
         OxydStone *o = new OxydStone(*this); 
         levelOxyds.push_back(o);

Modified: trunk/src/stones/OxydStone.hh
===================================================================
--- trunk/src/stones/OxydStone.hh	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/stones/OxydStone.hh	2009-09-05 23:26:05 UTC (rev 1793)
@@ -81,6 +81,7 @@
         OxydStone(std::string flavor = &quot;b&quot;);
         
         // Object interface
+        virtual std::string getClass() const;
         virtual OxydStone * clone();
         virtual void dispose();
         virtual Value message(const Message &amp;m);

Modified: trunk/src/stones/PuzzleStone.cc
===================================================================
--- trunk/src/stones/PuzzleStone.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/stones/PuzzleStone.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -433,7 +433,7 @@
 
         for (PuzzleList::iterator itr = cluster.begin(); itr != cluster.end(); ++itr) {
             if (Floor *fl = GetFloor(move((*itr)-&gt;get_pos(), dir))) {
-                if (!((fl-&gt;is_kind(&quot;fl_abyss&quot;) &amp;&amp; isComplete) || (fl-&gt;is_kind(&quot;fl_water&quot;) &amp;&amp; (isComplete || waterSink)))) {
+                if (!((fl-&gt;getClass() == &quot;fl_abyss&quot; &amp;&amp; isComplete) || (fl-&gt;getClass() == &quot;fl_water&quot; &amp;&amp; (isComplete || waterSink)))) {
                     createBridge = false;
                     break;
                 }

Modified: trunk/src/stones/SimpleStones.cc
===================================================================
--- trunk/src/stones/SimpleStones.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/stones/SimpleStones.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -228,7 +228,7 @@
     
     void PlopStone::on_floor_change() {
         if (Floor *fl = GetFloor(get_pos())) {
-            const std::string &amp;k = fl-&gt;get_kind();
+            std::string k = fl-&gt;getClass();
             if (k==&quot;fl_water&quot; || k==&quot;fl_abyss&quot; || k == &quot;fl_swamp&quot;) {
                 sound_event(&quot;drown&quot;);
                 client::Msg_Sparkle(get_pos().center());

Modified: trunk/src/stones/TimerStone.cc
===================================================================
--- trunk/src/stones/TimerStone.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/stones/TimerStone.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -26,7 +26,7 @@
 
 namespace enigma {
     
-    TimerStone::TimerStone() : Stone(&quot;st_timer&quot;) {
+    TimerStone::TimerStone() {
         state = ON;
     }
     

Modified: trunk/src/stones.cc
===================================================================
--- trunk/src/stones.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/stones.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -100,13 +100,10 @@
     return default_traits;
 }
 
-const char *Stone::get_kind() const
-{
+std::string Stone::getClass() const {
     const StoneTraits &amp;tr = get_traits();
-    if (tr.id != st_INVALID)
-        return tr.name;
-    else
-        return Object::get_kind();
+    ASSERT(tr.id != st_INVALID, XLevelRuntime, &quot;Stone with invalid traits based class name&quot;);
+    return tr.name;
 }
 
 StoneResponse Stone::collision_response(const StoneContact &amp;) {

Modified: trunk/src/stones.hh
===================================================================
--- trunk/src/stones.hh	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/stones.hh	2009-09-05 23:26:05 UTC (rev 1793)
@@ -172,7 +172,7 @@
 
         /* ---------- Virtual functions ---------- */
         virtual Stone *clone() = 0;
-        const char *get_kind() const;
+        virtual std::string getClass() const;
 
         /* ---------- Stone interface (properties) ---------- */
 

Modified: trunk/src/world.cc
===================================================================
--- trunk/src/world.cc	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/world.cc	2009-09-05 23:26:05 UTC (rev 1793)
@@ -1838,7 +1838,7 @@
     if (dst == NULL &amp;&amp; dstloc.layer == GRID_ITEMS) {
         GridLoc altloc(GRID_STONES, dstloc.pos);
         dst = GetObject(altloc);
-        if (dst &amp;&amp; !(dst-&gt;is_kind(&quot;st_blocker&quot;)))
+        if (dst &amp;&amp; !(dst-&gt;isKind(&quot;st_blocker&quot;)))
             // just use blocker stone instead of blocker item as substitution
             dst = NULL;
     }
@@ -1850,26 +1850,26 @@
         return; // ignore signal
     }
 //    Log &lt;&lt; ecl::strf(&quot;AddSignal: Valid signal destination src=%i/%i-%d (%s) dest=%i/%i-%d (%s) msg='%s'\n&quot;,
-//        srcloc.pos.x, srcloc.pos.y, srcloc.layer, src-&gt;get_kind(), dstloc.pos.x, dstloc.pos.y, dstloc.layer, dst-&gt;get_kind(), msg.c_str());
+//        srcloc.pos.x, srcloc.pos.y, srcloc.layer, src-&gt;getKind(), dstloc.pos.x, dstloc.pos.y, dstloc.layer, dst-&gt;getKind(), msg.c_str());
     
     Value dstValue(dst);
     
-    if (dst-&gt;is_kind(&quot;st_blocker&quot;) || dst-&gt;is_kind(&quot;st_blocker_new&quot;) ||
-            dst-&gt;is_kind(&quot;it_blocker&quot;)) {
+    if (dst-&gt;isKind(&quot;st_blocker&quot;) || dst-&gt;isKind(&quot;st_blocker_new&quot;) ||
+            dst-&gt;isKind(&quot;it_blocker&quot;)) {
         if (!dst-&gt;getAttr(&quot;name&quot;)) {
             NameObject(dst, ecl::strf(&quot;$!oxyd!blocker%d&quot;, dst-&gt;getId()));
         }
         dstValue = dst-&gt;getAttr(&quot;name&quot;);
     }
     
-    if (dst-&gt;is_kind(&quot;it_meditation_hill&quot;) || dst-&gt;is_kind(&quot;it_meditaion_bump&quot;) ||
-            dst-&gt;is_kind(&quot;it_meditation_hollow&quot;) || dst-&gt;is_kind(&quot;it_meditation_dent&quot;)) {
+    if (dst-&gt;isKind(&quot;it_meditation_hill&quot;) || dst-&gt;isKind(&quot;it_meditaion_bump&quot;) ||
+            dst-&gt;isKind(&quot;it_meditation_hollow&quot;) || dst-&gt;isKind(&quot;it_meditation_dent&quot;)) {
         if (!dst-&gt;getAttr(&quot;name&quot;))
             NameObject(dst, ecl::strf(&quot;$!oxyd!hillhollow%d&quot;, dst-&gt;getId()));
         dstValue = dst-&gt;getAttr(&quot;name&quot;);
     }
     
-    if (src-&gt;is_kind(&quot;st_actorimpulse&quot;)) {
+    if (src-&gt;isKind(&quot;st_actorimpulse&quot;)) {
         ObjectList ol = src-&gt;getDefaultedAttr(&quot;$!oxyd!destinations&quot;, Value(Value::GROUP));
         ol.push_back(dstValue);
         src-&gt;setAttr(&quot;$!oxyd!destinations&quot;, ol);
@@ -1895,7 +1895,7 @@
     // activate which key hole
     if (src-&gt;getObjectType() == Object::ITEM) {
         ItemID src_id = get_id(dynamic_cast&lt;Item *&gt;(src));
-        if (src_id == it_key &amp;&amp; dst-&gt;is_kind(&quot;st_key&quot;)) {
+        if (src_id == it_key &amp;&amp; dst-&gt;isKind(&quot;st_key&quot;)) {
             dst-&gt;setAttr(&quot;code&quot;, src-&gt;getAttr(&quot;code&quot;));
             return;
         }
@@ -2405,7 +2405,6 @@
     public:
         ObjectRepos();
         ~ObjectRepos();
-        void add_templ(Object *o);
         void add_templ (const string &amp;name, Object *o);
         bool has_templ(const string &amp;name);
         Object *make(const string &amp;name);
@@ -2437,14 +2436,6 @@
         objmap[kind] = o;
 }
 
-void ObjectRepos::add_templ (Object *o) {
-    string kind = o-&gt;get_kind();
-    if (has_templ(kind))
-        enigma::Log &lt;&lt; &quot;add_templ: redefinition of object `&quot; &lt;&lt;kind&lt;&lt; &quot;'.\n&quot;;
-    else
-        objmap[kind] = o;
-}
-
 bool ObjectRepos::has_templ(const string &amp;name) {
     return objmap.find(name) != objmap.end();
 }
@@ -2503,11 +2494,7 @@
     } else {
         int count = 0;
         for (std::list&lt;BootKindObject *&gt;::iterator itr = templates.begin(); itr != templates.end(); ++itr) {
-            if ((*itr)-&gt;kind.empty()) {
-                Register((*itr)-&gt;object);
-            } else {
-                Register((*itr)-&gt;kind.c_str(), (*itr)-&gt;object);                
-            }
+            Register((*itr)-&gt;kind, (*itr)-&gt;object);
             delete (*itr);
             count++;
         }
@@ -2515,39 +2502,22 @@
     }
 }
 
-void Register (const string &amp;kind, Object *obj) {
+void Register(const std::string &amp;kind, Object *obj) {
     if (!repos)
         repos = new ObjectRepos;
-    if (kind.empty())
-        repos-&gt;add_templ(obj-&gt;get_kind(), obj);
-    else
-        repos-&gt;add_templ(kind, obj);
+    ASSERT(!kind.empty(), XLevelRuntime, &quot;Registration of object without kind&quot;);
+    repos-&gt;add_templ(kind, obj);
 }
 
 
-void Register (Object *obj) {
-    Register (obj-&gt;get_kind(), obj);
-}
+//void RegisterActor (Actor *actor) 
+//{
+//    Register(static_cast&lt;Object*&gt;(actor));
+//    ActorID id = get_id(actor);
+//    ASSERT (id != ac_INVALID, XLevelRuntime,
+//        &quot;RegisterActor: trying to register with invalid ID&quot;);
+//}
 
-void Register (const string &amp;kind, Floor *obj)
-{
-    Object *o = obj;
-    Register(kind, o);
-}
-
-void Register (const string &amp;kind, Stone *obj) {
-    Object *o = obj;
-    Register(kind, o);
-}
-
-void RegisterActor (Actor *actor) 
-{
-    Register(static_cast&lt;Object*&gt;(actor));
-    ActorID id = get_id(actor);
-    ASSERT (id != ac_INVALID, XLevelRuntime,
-        &quot;RegisterActor: trying to register with invalid ID&quot;);
-}
-
 void Repos_Shutdown() {
     delete repos;
 }
@@ -2581,6 +2551,9 @@
     return dynamic_cast&lt;Floor*&gt;(MakeObject(kind));
 }
 
+Item * MakeItem(const char *kind) {
+    return dynamic_cast&lt;Item*&gt;(MakeObject(kind));
+}
 Stone * MakeStone (const char *kind) {
     return dynamic_cast&lt;Stone*&gt;(MakeObject(kind));
 }
@@ -2601,33 +2574,12 @@
                               double mousefactor, bool burnable,
                               const std::string &amp;firetransform)
 {
-    Register(new Floor(kind.c_str(), friction, mousefactor,
-             flf_default, burnable ? flft_burnable : flft_default,
-             firetransform.c_str(), &quot;&quot;));
+    // TBD
 }
 
 void DumpObjectInfo() {
     repos-&gt;dump_info();
 }
 
-/* ------------------- Item repository ------------------- */
 
-void Register (const string &amp;kind, Item *obj) 
-{
-    Object *o = obj;
-    Register(kind, o);
-}
-
-void RegisterItem (Item *item) 
-{
-    Register(static_cast&lt;Object*&gt;(item));
-    ItemID id = get_id(item);
-    ASSERT(id != it_INVALID, XLevelRuntime,
-        &quot;RegisterItem: trying to register with invalid ID&quot;);
-}
-
-
-Item * MakeItem(const char *kind) {
-    return dynamic_cast&lt;Item*&gt;(MakeObject(kind));
-}
 } // namespace enigma

Modified: trunk/src/world.hh
===================================================================
--- trunk/src/world.hh	2009-09-03 23:21:26 UTC (rev 1792)
+++ trunk/src/world.hh	2009-09-05 23:26:05 UTC (rev 1793)
@@ -331,6 +331,7 @@
 
     Object *MakeObject (const char *kind);
     Floor  *MakeFloor (const char *kind);
+    Item   *MakeItem (const char *kind);
     Stone  *MakeStone (const char *kind);
     Actor  *MakeActor (const char *kind);
 
@@ -348,18 +349,10 @@
 
     /* Register a new object. */
     void BootRegister(Object *obj, const char * kind = NULL, bool isRegistration = true);
-    void Register (Object *obj);
     void Register (const string &amp;kind, Object *obj);
-    void Register (const string &amp;kind, Floor *obj);
-    void Register (const string &amp;kind, Stone *obj);
-    void RegisterActor (Actor *ac);
+//    void RegisterActor (Actor *ac);
 
 
-
-    void Register (const string &amp;kind, Item *obj);
-    void RegisterItem (Item *it);
-    Item   *MakeItem (const char *kind);
-
     /* Shutdown object repository */
     void Repos_Shutdown();
 


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001221.html">[Enigma-game-svn] r1792 - in trunk: attic/images-stones data	data/gfx16 data/gfx32 data/gfx40 data/gfx48 data/gfx64
</A></li>
	<LI>Next message: <A HREF="001223.html">[Enigma-game-svn] r1794 - trunk/src/stones
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1222">[ date ]</a>
              <a href="thread.html#1222">[ thread ]</a>
              <a href="subject.html#1222">[ subject ]</a>
              <a href="author.html#1222">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/enigma-game-svn">More information about the Enigma-game-svn
mailing list</a><br>
</body></html>
