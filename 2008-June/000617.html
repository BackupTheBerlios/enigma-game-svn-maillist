<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Enigma-game-svn] r1183 - in trunk: data data/gfx32 data/gfx40	data/gfx48 data/schemas src
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/enigma-game-svn/2008-June/index.html" >
   <LINK REL="made" HREF="mailto:enigma-game-svn%40lists.berlios.de?Subject=Re%3A%20%5BEnigma-game-svn%5D%20r1183%20-%20in%20trunk%3A%20data%20data/gfx32%20data/gfx40%0A%09data/gfx48%20data/schemas%20src&In-Reply-To=%3C200806182141.m5ILfkPV010746%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000616.html">
   <LINK REL="Next"  HREF="000618.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Enigma-game-svn] r1183 - in trunk: data data/gfx32 data/gfx40	data/gfx48 data/schemas src</H1>
    <B>ral at mail.berlios.de</B> 
    <A HREF="mailto:enigma-game-svn%40lists.berlios.de?Subject=Re%3A%20%5BEnigma-game-svn%5D%20r1183%20-%20in%20trunk%3A%20data%20data/gfx32%20data/gfx40%0A%09data/gfx48%20data/schemas%20src&In-Reply-To=%3C200806182141.m5ILfkPV010746%40sheep.berlios.de%3E"
       TITLE="[Enigma-game-svn] r1183 - in trunk: data data/gfx32 data/gfx40	data/gfx48 data/schemas src">ral at mail.berlios.de
       </A><BR>
    <I>Wed Jun 18 23:41:46 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000616.html">[Enigma-game-svn] r1182 - in feature_branches/hp_lotm: images input	input/lotm
</A></li>
        <LI>Next message: <A HREF="000618.html">[Enigma-game-svn] r1184 - in trunk/src: . stones
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#617">[ date ]</a>
              <a href="thread.html#617">[ thread ]</a>
              <a href="subject.html#617">[ subject ]</a>
              <a href="author.html#617">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: ral
Date: 2008-06-18 23:41:18 +0200 (Wed, 18 Jun 2008)
New Revision: 1183

Added:
   trunk/data/gfx32/st-mirrortempl_0017.png
   trunk/data/gfx32/st-mirrortempl_0018.png
   trunk/data/gfx32/st-mirrortempl_0019.png
   trunk/data/gfx32/st-mirrortempl_0020.png
   trunk/data/gfx40/st-mirrortempl_0017.png
   trunk/data/gfx40/st-mirrortempl_0018.png
   trunk/data/gfx40/st-mirrortempl_0019.png
   trunk/data/gfx40/st-mirrortempl_0020.png
   trunk/data/gfx48/st-mirrortempl_0017.png
   trunk/data/gfx48/st-mirrortempl_0018.png
   trunk/data/gfx48/st-mirrortempl_0019.png
   trunk/data/gfx48/st-mirrortempl_0020.png
Modified:
   trunk/data/api1init.lua
   trunk/data/models-2d.lua
   trunk/data/schemas/objects.xml
   trunk/src/Makefile.am
   trunk/src/enigma.cc
   trunk/src/enigma.hh
   trunk/src/laser.cc
   trunk/src/ox_extra.cc
   trunk/src/ox_magnum.cc
   trunk/src/ox_oxyd1.cc
   trunk/src/ox_peroxyd.cc
   trunk/src/stones.hh
Log:
Trunk 1.1: new API reengineering Mirror 
- renaming to st_mirror, st_mirror_slab, st_mirror_triangle, st_mirror_sheets
  slab and sheets are both planar, sheets are always semi-transparent and
  let a parallel beam pass, a slab lets a parallel beam not pass
- attribute &quot;orientation&quot; is attribute &quot;state&quot; with standard direction notation
- attribute &quot;counterclock&quot; detemines rotation direction
- standard behaviour on messages turn, turnback, orientate
- actor turns into direction given by counterclock, 
  if actor reveals a wrench it performs a turnback
- boulder trigger fixed to a single mirror turn


Modified: trunk/data/api1init.lua
===================================================================
--- trunk/data/api1init.lua	2008-06-17 20:54:25 UTC (rev 1182)
+++ trunk/data/api1init.lua	2008-06-18 21:41:18 UTC (rev 1183)
@@ -121,6 +121,40 @@
     st_laserflop = &quot;st-lasertimeswitch&quot;,
     st_lightpassenger = &quot;st-lightpassenger&quot;,
     st_lightpassenger_off = &quot;st-lightpassenger_off&quot;,
+    
+    st_mirror_slab_n = &quot;st-mirror-p|&quot;,
+    st_mirror_slab_e = &quot;st-mirror-p/&quot;,
+    st_mirror_slab_s = &quot;st-mirror-p-&quot;,
+    st_mirror_slab_w = &quot;st-mirror-p\\&quot;,
+    st_mirror_slab_nt = &quot;st-mirror-p|t&quot;,
+    st_mirror_slab_et = &quot;st-mirror-p/t&quot;,
+    st_mirror_slab_st = &quot;st-mirror-p-t&quot;,
+    st_mirror_slab_wt = &quot;st-mirror-p\\t&quot;,
+    st_mirror_slab_nm = &quot;st-mirror-p|m&quot;,
+    st_mirror_slab_em = &quot;st-mirror-p/m&quot;,
+    st_mirror_slab_sm = &quot;st-mirror-p-m&quot;,
+    st_mirror_slab_wm = &quot;st-mirror-p\\m&quot;,
+    st_mirror_slab_ntm = &quot;st-mirror-p|tm&quot;,
+    st_mirror_slab_etm = &quot;st-mirror-p/tm&quot;,
+    st_mirror_slab_stm = &quot;st-mirror-p-tm&quot;,
+    st_mirror_slab_wtm = &quot;st-mirror-p\\tm&quot;,
+    st_mirror_triangle_n = &quot;st-mirror-3^&quot;,
+    st_mirror_triangle_e = &quot;st-mirror-3&gt;&quot;,
+    st_mirror_triangle_s = &quot;st-mirror-3v&quot;,
+    st_mirror_triangle_w = &quot;st-mirror-3&lt;&quot;,
+    st_mirror_triangle_nt = &quot;st-mirror-3^t&quot;,
+    st_mirror_triangle_et = &quot;st-mirror-3&gt;t&quot;,
+    st_mirror_triangle_st = &quot;st-mirror-3vt&quot;,
+    st_mirror_triangle_wt = &quot;st-mirror-3&lt;t&quot;,
+    st_mirror_triangle_nm = &quot;st-mirror-3^m&quot;,
+    st_mirror_triangle_em = &quot;st-mirror-3&gt;m&quot;,
+    st_mirror_triangle_sm = &quot;st-mirror-3vm&quot;,
+    st_mirror_triangle_wm = &quot;st-mirror-3&lt;m&quot;,
+    st_mirror_triangle_ntm = &quot;st-mirror-3^tm&quot;,
+    st_mirror_triangle_etm = &quot;st-mirror-3&gt;tm&quot;,
+    st_mirror_triangle_stm = &quot;st-mirror-3vtm&quot;,
+    st_mirror_triangle_wtm = &quot;st-mirror-3&lt;tm&quot;,
+    
     st_monoflop = &quot;st-timeswitch&quot;,
     st_oxyd = &quot;st-oxyd&quot;,
     st_panel = &quot;st-wood_001&quot;,
@@ -208,8 +242,12 @@
         enigma._SetAttrib(obj, &quot;scissor&quot;, false)
         enigma._SetAttrib(obj, &quot;autoclose&quot;, true)
         return obj
+    elseif name == &quot;st-pmirror&quot; then
+        return enigma._MakeObject(&quot;st_mirror_slab_e&quot;)
+    elseif name == &quot;st-3mirror&quot; then
+        return enigma._MakeObject(&quot;st_mirror_triangle_s&quot;)
     end
-
+    
     newname = RenamingObjectsOld2New[name]
     
     if name == &quot;st-laser&quot; then
@@ -264,6 +302,9 @@
     if string.sub(_newname, 1, 8) == &quot;st_laser&quot; then
         return &quot;st-laser&quot;
     end
+    if _newname == &quot;it_mirror&quot; then
+        return &quot;st-mirror&quot;
+    end
     if _oldname ~= nil then
         return _oldname
     else
@@ -371,6 +412,15 @@
      if key == &quot;invisible&quot; then
          if val == 1 then _val = true else _val = false end
      end
+     if key == &quot;orientation&quot; then
+         _val = (6 - val) % 4
+     end
+     if key == &quot;transparent&quot; then
+         if val == 1 then _val = true else _val = false end
+     end
+     if key == &quot;movable&quot; then
+         if val == 1 then _val = true else _val = false end
+     end
      enigma._SetAttrib(obj, _key, _val)
 end
 
@@ -456,6 +506,15 @@
      if key == &quot;invisible&quot; then
          if val == false then val = 0 else val = 1 end
      end
+     if key == &quot;orientation&quot; then
+         val = (5 - val) % 4 + 1
+     end
+     if key == &quot;transparent&quot; then
+         if val == false then val = 0 else val = 1 end
+     end
+     if key == &quot;movable&quot; then
+         if val == false then val = 0 else val = 1 end
+     end
      return val
 end
 
@@ -506,7 +565,7 @@
     [&quot;st-stoneimpulse_movable__trigger&quot;] = &quot;signal&quot;,
     st_lightpassenger__trigger = &quot;toggle&quot;,
     st_lightpassenger__onoff = &quot;toggle&quot;,
-    [&quot;st-mirror__trigger&quot;] = &quot;turn&quot;,
+    st_mirror__trigger = &quot;turn&quot;,
     st_oxyd__trigger = &quot;open&quot;,
     [&quot;st-plain__trigger&quot;] = &quot;signal&quot;,
     [&quot;st-plain_hole__trigger&quot;] = &quot;signal&quot;,

Added: trunk/data/gfx32/st-mirrortempl_0017.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx32/st-mirrortempl_0017.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx32/st-mirrortempl_0018.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx32/st-mirrortempl_0018.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx32/st-mirrortempl_0019.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx32/st-mirrortempl_0019.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx32/st-mirrortempl_0020.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx32/st-mirrortempl_0020.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx40/st-mirrortempl_0017.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx40/st-mirrortempl_0017.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx40/st-mirrortempl_0018.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx40/st-mirrortempl_0018.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx40/st-mirrortempl_0019.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx40/st-mirrortempl_0019.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx40/st-mirrortempl_0020.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx40/st-mirrortempl_0020.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx48/st-mirrortempl_0017.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx48/st-mirrortempl_0017.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx48/st-mirrortempl_0018.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx48/st-mirrortempl_0018.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx48/st-mirrortempl_0019.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx48/st-mirrortempl_0019.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx48/st-mirrortempl_0020.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx48/st-mirrortempl_0020.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Modified: trunk/data/models-2d.lua
===================================================================
--- trunk/data/models-2d.lua	2008-06-17 20:54:25 UTC (rev 1182)
+++ trunk/data/models-2d.lua	2008-06-18 21:41:18 UTC (rev 1183)
@@ -1613,7 +1613,7 @@
 --      st-{3mirror,pmirror}-{m,s}{o,t}[1234]
 --
 -- {m,s} -&gt; movable or static
--- {o,t} -&gt; opaque or transparent
+-- {o,t,f} -&gt; opaque or pane transparent or full transparent (pane + side)
 --
 -- The numbers map to actual orientations as follows:
 --
@@ -1634,7 +1634,8 @@
     mirror3_opaque = FrameNames(&quot;st-mirrortempl&quot;, 1, 4)
     mirror3_transp = FrameNames(&quot;st-mirrortempl&quot;, 5, 8)
     mirrorp_opaque = FrameNames(&quot;st-mirrortempl&quot;, 9, 12)
-    mirrorp_transp = FrameNames(&quot;st-mirrortempl&quot;, 13, 16)
+    mirrorp_transp1 = FrameNames(&quot;st-mirrortempl&quot;, 13, 16)
+    mirrorp_transp2 = FrameNames(&quot;st-mirrortempl&quot;, 17, 20)
 
     make_mirror(&quot;st-3mirror-mo&quot;, &quot;st-mirror-movable&quot;, mirror3_opaque)
     make_mirror(&quot;st-3mirror-so&quot;, &quot;st-mirror-static&quot;,  mirror3_opaque)
@@ -1643,8 +1644,10 @@
 
     make_mirror(&quot;st-pmirror-mo&quot;, &quot;st-mirror-movable&quot;, mirrorp_opaque)
     make_mirror(&quot;st-pmirror-so&quot;, &quot;st-mirror-static&quot;,  mirrorp_opaque)
-    make_mirror(&quot;st-pmirror-mt&quot;, &quot;st-mirror-movable&quot;, mirrorp_transp)
-    make_mirror(&quot;st-pmirror-st&quot;, &quot;st-mirror-static&quot;,  mirrorp_transp)
+    make_mirror(&quot;st-pmirror-mt&quot;, &quot;st-mirror-movable&quot;, mirrorp_transp1)
+    make_mirror(&quot;st-pmirror-st&quot;, &quot;st-mirror-static&quot;,  mirrorp_transp1)
+    make_mirror(&quot;st-pmirror-mf&quot;, &quot;st-mirror-movable&quot;, mirrorp_transp2)
+    make_mirror(&quot;st-pmirror-sf&quot;, &quot;st-mirror-static&quot;,  mirrorp_transp2)
 end
 
 --------------------------

Modified: trunk/data/schemas/objects.xml
===================================================================
--- trunk/data/schemas/objects.xml	2008-06-17 20:54:25 UTC (rev 1182)
+++ trunk/data/schemas/objects.xml	2008-06-18 21:41:18 UTC (rev 1183)
@@ -41,6 +41,7 @@
     &lt;attr name=&quot;static&quot; type=&quot;bool&quot; default=&quot;false&quot; rw=&quot;rw&quot;/&gt;
     &lt;attr name=&quot;strength&quot; type=&quot;double&quot; default=&quot;1&quot; rw=&quot;rw&quot;/&gt;
     &lt;attr name=&quot;target&quot; type=&quot;tokens&quot; default=&quot;nil&quot; rw=&quot;rw&quot;/&gt;
+    &lt;attr name=&quot;transparent&quot; type=&quot;bool&quot; default=&quot;false&quot; rw=&quot;rw&quot;/&gt;
   &lt;/attributes&gt;
   &lt;messages&gt;
     &lt;msg name=&quot;close&quot; type=&quot;nil&quot;/&gt;
@@ -410,6 +411,27 @@
       &lt;msg name=&quot;_init&quot;/&gt;
       &lt;msg name=&quot;_model_reanimated&quot;/&gt;
     &lt;/object&gt;
+    &lt;object name=&quot;st_mirror&quot;&gt;
+      &lt;attr name=&quot;counterclock&quot;/&gt;
+      &lt;attr name=&quot;flavor&quot; default=&quot;slab&quot;/&gt;
+      &lt;attr name=&quot;movable&quot; rw=&quot;rw&quot;/&gt;
+      &lt;attr name=&quot;orientation&quot;/&gt;
+      &lt;attr name=&quot;transparent&quot;/&gt;
+      &lt;msg name=&quot;orientate&quot;/&gt;
+      &lt;msg name=&quot;signal&quot;/&gt;
+      &lt;msg name=&quot;turn&quot;/&gt;
+      &lt;msg name=&quot;turnback&quot;/&gt;
+      &lt;msg name=&quot;_trigger&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;st_mirror_sheets&quot;&gt;
+      &lt;attr name=&quot;flavor&quot; value=&quot;sheets&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;st_mirror_slab&quot;&gt;
+      &lt;attr name=&quot;flavor&quot; value=&quot;slab&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;st_mirror_triangle&quot;&gt;
+      &lt;attr name=&quot;flavor&quot; value=&quot;triangle&quot;/&gt;
+    &lt;/object&gt;
     &lt;object name=&quot;st_monoflop&quot;&gt;
       &lt;attr name=&quot;interval&quot; default=&quot;1.8&quot;/&gt;
       &lt;msg name=&quot;on&quot;/&gt;

Modified: trunk/src/Makefile.am
===================================================================
--- trunk/src/Makefile.am	2008-06-17 20:54:25 UTC (rev 1182)
+++ trunk/src/Makefile.am	2008-06-18 21:41:18 UTC (rev 1183)
@@ -221,6 +221,8 @@
 	stones/LaserSwitch.hh	\
 	stones/LightPassengerStone.cc	\
 	stones/LightPassengerStone.hh	\
+	stones/MirrorStone.cc	\
+	stones/MirrorStone.hh	\
 	stones/MonoFlopStone.cc	\
 	stones/MonoFlopStone.hh	\
 	stones/OxydStone.cc	\

Modified: trunk/src/enigma.cc
===================================================================
--- trunk/src/enigma.cc	2008-06-17 20:54:25 UTC (rev 1182)
+++ trunk/src/enigma.cc	2008-06-18 21:41:18 UTC (rev 1183)
@@ -84,6 +84,12 @@
     return rdir[d+1];
 }
 
+Direction next(Direction d) {
+    static Direction rdir[] = {WEST, SOUTH, EAST, NORTH, NODIR};
+    return rdir[d+1];
+}
+
+
 Direction
 direction_fromto(GridPos source, GridPos target)
 {
@@ -129,7 +135,6 @@
     return d;
 }
 
-
 /* -------------------- GridPos -------------------- */
 
 GridPos::GridPos(const ecl::V2&amp; p) 

Modified: trunk/src/enigma.hh
===================================================================
--- trunk/src/enigma.hh	2008-06-17 20:54:25 UTC (rev 1182)
+++ trunk/src/enigma.hh	2008-06-18 21:41:18 UTC (rev 1183)
@@ -115,6 +115,7 @@
     Direction reverse (Direction d);
     Direction rotate_cw (Direction d);
     Direction rotate_ccw (Direction d);
+    Direction next(Direction d);
 
     std::string to_suffix(Direction d);
     std::string toSuffix(Direction d);

Modified: trunk/src/laser.cc
===================================================================
--- trunk/src/laser.cc	2008-06-17 20:54:25 UTC (rev 1182)
+++ trunk/src/laser.cc	2008-06-18 21:41:18 UTC (rev 1183)
@@ -262,300 +262,6 @@
 }
 
 
-/* -------------------- MirrorStone -------------------- */
-namespace
-{
-    class MirrorStone
-        : public Stone, public PhotoCell
-    {
-    protected:
-        MirrorStone(const char *name, bool movable=false, bool transparent=false);
-
-        bool is_transparent() const { return getAttr(&quot;transparent&quot;) != 0; }
-
-        void set_orientation(int o) { setAttr(&quot;orientation&quot;, o); }
-        int get_orientation() { return getAttr(&quot;orientation&quot;); }
-
-        void emit_light(Direction dir) {
-            if (!has_dir(outdirs, dir))
-            {
-                outdirs = DirectionBits(outdirs | to_bits(dir));
-                LaserBeam::emit_from(get_pos(), dir);
-            }
-        }
-
-        void init_model();
-        void setAttr(const string&amp; key, const Value &amp;val);
-
-    private:
-
-        StoneTraits traits;
-
-	// Object interface.
-        virtual Value message(const Message &amp;m);
-
-        //GridObject interface
-        DirectionBits emissionDirections() const {
-            return outdirs;
-        }
-
-        // PhotoCell interface
-        void on_recalc_start() { outdirs = NODIRBIT; }
-        void on_recalc_finish() {}
-
-        // Stone interface
-        void actor_hit(const StoneContact &amp;sc);
-        void on_creation (GridPos p);
-        void on_removal (GridPos p);
-        bool is_transparent(Direction) const { return is_transparent(); }
-
-        // Private methods
-        void rotate_right();
-        
-        const StoneTraits &amp;get_traits() const { return traits; }
-        
-        // Variables
-        DirectionBits outdirs;    
-    };
-}
-
-MirrorStone::MirrorStone(const char *name, bool movable, bool transparent)
-: Stone(name), outdirs(NODIRBIT)
-{
-    setAttr(&quot;transparent&quot;, transparent);
-    setAttr(&quot;movable&quot;, movable);
-    setAttr(&quot;orientation&quot;, Value(1));
-    traits.name = &quot;st-mirror&quot;;
-    traits.id = st_INVALID;
-    traits.flags = stf_none;
-    traits.material = material_stone;
-    traits.restitution = 1.0;
-    //traits.movable is already set via setAttr(&quot;movable&quot;, ...);
-}
-
-void MirrorStone::init_model() {
-    string mname = get_kind();
-    mname += is_movable() ? &quot;-m&quot; : &quot;-s&quot;;
-    mname += is_transparent() ? &quot;t&quot; : &quot;o&quot;;
-    mname += char('0' + get_orientation());
-    set_model(mname);
-}
-
-Value MirrorStone::message(const Message &amp;m) {
-    if ((m.message == &quot;_trigger&quot; &amp;&amp; m.value.to_bool()) || m.message == &quot;turn&quot;) {
-        rotate_right();
-        return Value();
-    }
-    else if (m.message == &quot;signal&quot;) {
-        if (to_double(m.value) != 0) {
-            rotate_right();
-        }
-        return Value();
-    }
-    else if (m.message == &quot;mirror-north&quot;) {
-        set_orientation(3);
-        init_model();
-        MaybeRecalcLight(get_pos());
-        return Value();
-    }
-    else if (m.message == &quot;mirror-east&quot;) {
-        set_orientation(4);
-        init_model();
-        MaybeRecalcLight(get_pos());
-        return Value();
-    }
-    else if (m.message == &quot;mirror-south&quot;) {
-        set_orientation(1);
-        init_model();
-        MaybeRecalcLight(get_pos());
-        return Value();
-    }
-    else if (m.message == &quot;mirror-west&quot;) {
-        set_orientation(2);
-        init_model();
-        MaybeRecalcLight(get_pos());
-        return Value();
-    }
-    return Stone::message(m);
-}
-
-void MirrorStone::actor_hit(const StoneContact &amp;sc)
-{
-    if (is_movable())
-        maybe_push_stone(sc);
-    rotate_right();
-}
-
-void MirrorStone::on_creation (GridPos p)
-{
-    photo_activate();
-    Stone::on_creation(p);
-}
-
-void MirrorStone::on_removal(GridPos p)
-{
-    photo_deactivate();
-    Stone::on_removal(p);
-}
-
-void MirrorStone::rotate_right()
-{
-    set_orientation(1+(get_orientation() % 4));
-    init_model();
-    MaybeRecalcLight(get_pos());
-    sound_event (&quot;mirrorturn&quot;);
-}
-
-void MirrorStone::setAttr(const string&amp; key, const Value &amp;val) {
-    Stone::setAttr(key, val);
-    if (key == &quot;movable&quot;)
-        traits.movable = to_bool(val) ? MOVABLE_STANDARD : MOVABLE_PERSISTENT;
-}
-    
-
-/* -------------------- Plane Mirror -------------------- */
-namespace
-{
-    class PlaneMirror : public MirrorStone {
-        CLONEOBJ(PlaneMirror);
-    public:
-        PlaneMirror(char orientation='/', bool movable=false, bool transparent=false)
-        : MirrorStone(&quot;st-pmirror&quot;, movable, transparent)
-        {
-            SetOrientation(orientation);
-        }
-    private:
-        void SetOrientation(char o) {
-            const char *a = &quot; -\\|/&quot;;
-            MirrorStone::set_orientation(int (strchr(a,o)-a));
-        }
-        char GetOrientation() {
-            const char *a = &quot; -\\|/&quot;;
-            return a[MirrorStone::get_orientation()];
-        }
-        void processLight(Direction dir);
-    };
-}
-
-void PlaneMirror::processLight(Direction dir) 
-{
-    char orientation = GetOrientation();
-    bool transparent = is_transparent();
-
-    switch (orientation) {
-    case '|':
-        if (dir==EAST || dir==WEST) {
-            emit_light(reverse(dir));
-            if (transparent)
-                emit_light(dir);
-        }
-        else if ((dir == NORTH || dir == SOUTH) &amp;&amp; transparent &amp;&amp;
-                 server::GameCompatibility == GAMET_OXYD1) {
-            emit_light(dir);
-        }
-        break;
-    case '-':
-        if (dir==NORTH || dir==SOUTH) {
-            emit_light(reverse(dir));
-            if (transparent)
-                emit_light(dir);
-        }
-        else if ((dir == EAST || dir == WEST) &amp;&amp; transparent &amp;&amp;
-                 server::GameCompatibility == GAMET_OXYD1) {
-            emit_light(dir);
-        }
-        break;
-    case '/':
-        switch(dir) {
-        case EAST: emit_light(NORTH); break;
-        case SOUTH: emit_light(WEST); break;
-        case NORTH: emit_light(EAST); break;
-        case WEST: emit_light(SOUTH); break;
-        case NODIR: break;
-        }
-        if (transparent)
-            emit_light(dir);
-        break;
-    case '\\':
-        switch(dir) {
-        case EAST: emit_light(SOUTH); break;
-        case SOUTH: emit_light(EAST); break;
-        case NORTH: emit_light(WEST); break;
-        case WEST: emit_light(NORTH); break;
-        case NODIR: break;
-        }
-        if (transparent)
-            emit_light(dir);
-        break;
-    }
-}
-
-
-/* -------------------- TriangleMirror -------------------- */
-
-namespace
-{
-    // The orientations of the TriangleMirror have an unusual definition,
-    // but we cannot change them w/o changing many levels
-    //
-    //    Flat side of the triangle
-    //    points to :                            Orientation :
-    //
-    //    WEST                                   4
-    //    SOUTH                                  3
-    //    EAST                                   2
-    //    NORTH                                  1
-
-    class TriangleMirror : public MirrorStone {
-        CLONEOBJ(TriangleMirror);
-    public:
-        TriangleMirror(char orientation='v', bool movable=false, bool transparent=false)
-        : MirrorStone(&quot;st-3mirror&quot;, movable, transparent)
-        {
-            SetOrientation (orientation);
-        }
-    private:
-
-        void SetOrientation(char o) {
-            const char *a = &quot; v&lt;^&gt;&quot;;
-            MirrorStone::set_orientation( int (strchr(a,o)-a));
-        }
-
-        Direction GetOrientation() // orientation of the flat side of the mirror
-        {
-            const Direction a[] = {NODIR, NORTH, EAST, SOUTH, WEST};
-            return a[MirrorStone::get_orientation()];
-        }
-        void processLight(Direction dir);
-    };
-}
-
-void TriangleMirror::processLight(Direction beam_dir)
-    // note: 'beam_dir' is the direction where laserbeam goes to
-{
-    // direction where flat side of triangle points to
-    Direction flat_dir = GetOrientation();
-    Direction tip_dir  = reverse(flat_dir);
-
-    if (beam_dir == tip_dir) // beam hits the flat side
-        emit_light(flat_dir);
-    else if (beam_dir == flat_dir) {
-        // this is the &quot;complicated&quot; case where the light falls
-        // on the tip of the triangle
-        switch (beam_dir) {
-            case SOUTH: case NORTH:
-                emit_light(EAST); emit_light(WEST); break;
-            case WEST: case EAST:
-                emit_light(SOUTH); emit_light(NORTH); break;
-            case NODIR: break;
-        }
-    } else
-        emit_light(tip_dir);
-
-    if (is_transparent())
-        emit_light(beam_dir);
-}
-
 //----------------------------------------------------------------------
 // FUNCTIONS
 //----------------------------------------------------------------------
@@ -567,47 +273,8 @@
 }
 
 void InitLasers() {
-//    Register (new LaserStone);
-//    Register (&quot;st-laser-n&quot;, new LaserStone(NORTH));
-//    Register (&quot;st-laser-e&quot;, new LaserStone(EAST));
-//    Register (&quot;st-laser-s&quot;, new LaserStone(SOUTH));
-//    Register (&quot;st-laser-w&quot;, new LaserStone(WEST));
 
-    Register (new TriangleMirror);
-    Register (&quot;st-mirror-3v&quot;, new TriangleMirror('v'));
-    Register (&quot;st-mirror-3&lt;&quot;, new TriangleMirror('&lt;'));
-    Register (&quot;st-mirror-3^&quot;, new TriangleMirror('^'));
-    Register (&quot;st-mirror-3&gt;&quot;, new TriangleMirror('&gt;'));
-    Register (&quot;st-mirror-3vm&quot;, new TriangleMirror('v', true));
-    Register (&quot;st-mirror-3&lt;m&quot;, new TriangleMirror('&lt;', true));
-    Register (&quot;st-mirror-3^m&quot;, new TriangleMirror('^', true));
-    Register (&quot;st-mirror-3&gt;m&quot;, new TriangleMirror('&gt;', true));
-    Register (&quot;st-mirror-3vt&quot;, new TriangleMirror('v', false, true));
-    Register (&quot;st-mirror-3&lt;t&quot;, new TriangleMirror('&lt;', false, true));
-    Register (&quot;st-mirror-3^t&quot;, new TriangleMirror('^', false, true));
-    Register (&quot;st-mirror-3&gt;t&quot;, new TriangleMirror('&gt;', false, true));
-    Register (&quot;st-mirror-3vtm&quot;, new TriangleMirror('v', true, true));
-    Register (&quot;st-mirror-3&lt;tm&quot;, new TriangleMirror('&lt;', true, true));
-    Register (&quot;st-mirror-3^tm&quot;, new TriangleMirror('^', true, true));
-    Register (&quot;st-mirror-3&gt;tm&quot;, new TriangleMirror('&gt;', true, true));
 
-    Register (new PlaneMirror);
-    Register (&quot;st-mirror-p|&quot;, new PlaneMirror('|'));
-    Register (&quot;st-mirror-p/&quot;, new PlaneMirror('/'));
-    Register (&quot;st-mirror-p-&quot;, new PlaneMirror('-'));
-    Register (&quot;st-mirror-p\\&quot;, new PlaneMirror('\\'));
-    Register (&quot;st-mirror-p|m&quot;, new PlaneMirror('|', true));
-    Register (&quot;st-mirror-p/m&quot;, new PlaneMirror('/', true));
-    Register (&quot;st-mirror-p-m&quot;, new PlaneMirror('-', true));
-    Register (&quot;st-mirror-p\\m&quot;, new PlaneMirror('\\', true));
-    Register (&quot;st-mirror-p|t&quot;, new PlaneMirror('|', false, true));
-    Register (&quot;st-mirror-p/t&quot;, new PlaneMirror('/', false, true));
-    Register (&quot;st-mirror-p-t&quot;, new PlaneMirror('-', false, true));
-    Register (&quot;st-mirror-p\\t&quot;, new PlaneMirror('\\', false, true));
-    Register (&quot;st-mirror-p|tm&quot;, new PlaneMirror('|', true, true));
-    Register (&quot;st-mirror-p/tm&quot;, new PlaneMirror('/', true, true));
-    Register (&quot;st-mirror-p-tm&quot;, new PlaneMirror('-', true, true));
-    Register (&quot;st-mirror-p\\tm&quot;, new PlaneMirror('\\', true, true));
 }
 
 

Modified: trunk/src/ox_extra.cc
===================================================================
--- trunk/src/ox_extra.cc	2008-06-17 20:54:25 UTC (rev 1182)
+++ trunk/src/ox_extra.cc	2008-06-18 21:41:18 UTC (rev 1183)
@@ -189,20 +189,20 @@
     &quot;st-laser-3&quot;,        // OxydExtra stone 0x40
     UNUSED,              // OxydExtra stone 0x41
     UNUSED,              // OxydExtra stone 0x42
-    &quot;st-mirror-p-&quot;,      // OxydExtra stone 0x43
-    &quot;st-mirror-p\\&quot;,     // OxydExtra stone 0x44
+    &quot;st_mirror_slab_s&quot;,  // OxydExtra stone 0x43
+    &quot;st_mirror_slab_w&quot;,  // OxydExtra stone 0x44
     UNUSED,              // OxydExtra stone 0x45
-    &quot;st-mirror-p/&quot;,      // OxydExtra stone 0x46
+    &quot;st_mirror_slab_e&quot;,  // OxydExtra stone 0x46
     UNUSED,              // OxydExtra stone 0x47
     UNUSED,              // OxydExtra stone 0x48
     UNUSED,              // OxydExtra stone 0x49
     UNUSED,              // OxydExtra stone 0x4a
-    &quot;st-mirror-p-t&quot;,     // OxydExtra stone 0x4b
+    &quot;st_mirror_slab_st&quot;, // OxydExtra stone 0x4b
     UNUSED,              // OxydExtra stone 0x4c
-    &quot;st-mirror-3&gt;&quot;,      // OxydExtra stone 0x4d
-    &quot;st-mirror-3^&quot;,      // OxydExtra stone 0x4e
-    &quot;st-mirror-3&lt;&quot;,      // OxydExtra stone 0x4f
-    &quot;st-mirror-3v&quot;,      // OxydExtra stone 0x50
+    &quot;st_mirror_triangle_ec&quot;, // OxydExtra stone 0x4d
+    &quot;st_mirror_triangle_nc&quot;, // OxydExtra stone 0x4e
+    &quot;st_mirror_triangle_wc&quot;, // OxydExtra stone 0x4f
+    &quot;st_mirror_triangle_sc&quot;, // OxydExtra stone 0x50
     UNUSED,              // OxydExtra stone 0x51
     UNUSED,              // OxydExtra stone 0x52
     UNUSED,              // OxydExtra stone 0x53

Modified: trunk/src/ox_magnum.cc
===================================================================
--- trunk/src/ox_magnum.cc	2008-06-17 20:54:25 UTC (rev 1182)
+++ trunk/src/ox_magnum.cc	2008-06-18 21:41:18 UTC (rev 1183)
@@ -193,22 +193,22 @@
     &quot;st-laser-1&quot;,               // OxydMagnum stone 0x44  The laser-names are fake names!
     &quot;st-laser-2&quot;,               // OxydMagnum stone 0x45  Direction and state are generated by Enigma.
     &quot;st-laser-3&quot;,               // OxydMagnum stone 0x46
-    &quot;st-mirror-p|&quot;,             // OxydMagnum stone 0x47
-    &quot;st-mirror-p/&quot;,             // OxydMagnum stone 0x48
-    &quot;st-mirror-p-&quot;,             // OxydMagnum stone 0x49
-    &quot;st-mirror-p\\&quot;,            // OxydMagnum stone 0x4a
-    &quot;st-mirror-p|m&quot;,            // OxydMagnum stone 0x4b
-    &quot;st-mirror-p/m&quot;,            // OxydMagnum stone 0x4c
-    &quot;st-mirror-p-m&quot;,            // OxydMagnum stone 0x4d
-    &quot;st-mirror-p\\m&quot;,           // OxydMagnum stone 0x4e
-    &quot;st-mirror-p|t&quot;,            // OxydMagnum stone 0x4f
-    &quot;st-mirror-p/t&quot;,            // OxydMagnum stone 0x50
-    &quot;st-mirror-p-t&quot;,            // OxydMagnum stone 0x51
-    &quot;st-mirror-p\\t&quot;,           // OxydMagnum stone 0x52
-    &quot;st-mirror-3&gt;&quot;,             // OxydMagnum stone 0x53
-    &quot;st-mirror-3^&quot;,             // OxydMagnum stone 0x54
-    &quot;st-mirror-3&lt;&quot;,             // OxydMagnum stone 0x55
-    &quot;st-mirror-3v&quot;,             // OxydMagnum stone 0x56
+    &quot;st_mirror_slab_n&quot;,         // OxydMagnum stone 0x47
+    &quot;st_mirror_slab_e&quot;,         // OxydMagnum stone 0x48
+    &quot;st_mirror_slab_s&quot;,         // OxydMagnum stone 0x49
+    &quot;st_mirror_slab_w&quot;,         // OxydMagnum stone 0x4a
+    &quot;st_mirror_slab_nm&quot;,        // OxydMagnum stone 0x4b
+    &quot;st_mirror_slab_em&quot;,        // OxydMagnum stone 0x4c
+    &quot;st_mirror_slab_sm&quot;,        // OxydMagnum stone 0x4d
+    &quot;st_mirror_slab_wm&quot;,        // OxydMagnum stone 0x4e
+    &quot;st_mirror_slab_nt&quot;,        // OxydMagnum stone 0x4f
+    &quot;st_mirror_slab_et&quot;,        // OxydMagnum stone 0x50
+    &quot;st_mirror_slab_st&quot;,        // OxydMagnum stone 0x51
+    &quot;st_mirror_slab_wt&quot;,        // OxydMagnum stone 0x52
+    &quot;st_mirror_triangle_ec&quot;,    // OxydMagnum stone 0x53
+    &quot;st_mirror_triangle_nc&quot;,    // OxydMagnum stone 0x54
+    &quot;st_mirror_triangle_wc&quot;,    // OxydMagnum stone 0x55
+    &quot;st_mirror_triangle_sc&quot;,    // OxydMagnum stone 0x56
     &quot;st-puzzle2-es&quot;,            // Oxyd1 stone 0x57
     &quot;st-puzzle2-sw&quot;,            // Oxyd1 stone 0x58
     &quot;st-puzzle2-nw&quot;,            // Oxyd1 stone 0x59

Modified: trunk/src/ox_oxyd1.cc
===================================================================
--- trunk/src/ox_oxyd1.cc	2008-06-17 20:54:25 UTC (rev 1182)
+++ trunk/src/ox_oxyd1.cc	2008-06-18 21:41:18 UTC (rev 1183)
@@ -223,22 +223,22 @@
     &quot;st-laser-1&quot;,               // Oxyd1 stone 0x44  The laser-names are fake names!
     &quot;st-laser-2&quot;,               // Oxyd1 stone 0x45  Direction and state are generated by Enigma.
     &quot;st-laser-3&quot;,               // Oxyd1 stone 0x46
-    &quot;st-mirror-p|&quot;,             // Oxyd1 stone 0x47
-    &quot;st-mirror-p/&quot;,             // Oxyd1 stone 0x48
-    &quot;st-mirror-p-&quot;,             // Oxyd1 stone 0x49
-    &quot;st-mirror-p\\&quot;,            // Oxyd1 stone 0x4a
-    &quot;st-mirror-p|m&quot;,            // Oxyd1 stone 0x4b
-    &quot;st-mirror-p/m&quot;,            // Oxyd1 stone 0x4c
-    &quot;st-mirror-p-m&quot;,            // Oxyd1 stone 0x4d
-    &quot;st-mirror-p\\m&quot;,           // Oxyd1 stone 0x4e
-    &quot;st-mirror-p|t&quot;,            // Oxyd1 stone 0x4f
-    &quot;st-mirror-p/t&quot;,            // Oxyd1 stone 0x50
-    &quot;st-mirror-p-t&quot;,            // Oxyd1 stone 0x51
-    &quot;st-mirror-p\\t&quot;,           // Oxyd1 stone 0x52
-    &quot;st-mirror-3&gt;&quot;,             // Oxyd1 stone 0x53
-    &quot;st-mirror-3^&quot;,             // Oxyd1 stone 0x54
-    &quot;st-mirror-3&lt;&quot;,             // Oxyd1 stone 0x55
-    &quot;st-mirror-3v&quot;,             // Oxyd1 stone 0x56
+    &quot;st_mirror_slab_n&quot;,         // Oxyd1 stone 0x47
+    &quot;st_mirror_slab_e&quot;,         // Oxyd1 stone 0x48
+    &quot;st_mirror_slab_s&quot;,         // Oxyd1 stone 0x49
+    &quot;st_mirror_slab_w&quot;,         // Oxyd1 stone 0x4a
+    &quot;st_mirror_slab_nm&quot;,        // Oxyd1 stone 0x4b
+    &quot;st_mirror_slab_em&quot;,        // Oxyd1 stone 0x4c
+    &quot;st_mirror_slab_sm&quot;,        // Oxyd1 stone 0x4d
+    &quot;st_mirror_slab_wm&quot;,        // Oxyd1 stone 0x4e
+    &quot;st_mirror_slab_nt&quot;,        // Oxyd1 stone 0x4f
+    &quot;st_mirror_slab_et&quot;,        // Oxyd1 stone 0x50
+    &quot;st_mirror_slab_st&quot;,        // Oxyd1 stone 0x51
+    &quot;st_mirror_slab_wt&quot;,        // Oxyd1 stone 0x52
+    &quot;st_mirror_triangle_ec&quot;,    // Oxyd1 stone 0x53
+    &quot;st_mirror_triangle_nc&quot;,    // Oxyd1 stone 0x54
+    &quot;st_mirror_triangle_wc&quot;,    // Oxyd1 stone 0x55
+    &quot;st_mirror_triangle_sc&quot;,    // Oxyd1 stone 0x56
     &quot;st-puzzle2-es&quot;,            // Oxyd1 stone 0x57
     &quot;st-puzzle2-sw&quot;,            // Oxyd1 stone 0x58
     &quot;st-puzzle2-nw&quot;,            // Oxyd1 stone 0x59

Modified: trunk/src/ox_peroxyd.cc
===================================================================
--- trunk/src/ox_peroxyd.cc	2008-06-17 20:54:25 UTC (rev 1182)
+++ trunk/src/ox_peroxyd.cc	2008-06-18 21:41:18 UTC (rev 1183)
@@ -259,22 +259,22 @@
     &quot;st-laser-1&quot;,               // PerOxyd stone 0x3e  The laser-names are fake names!
     &quot;st-laser-2&quot;,               // PerOxyd stone 0x3f  Direction and state are generated by Enigma.
     &quot;st-laser-3&quot;,               // PerOxyd stone 0x40
-    &quot;st-mirror-p|&quot;,             // PerOxyd stone 0x41
-    &quot;st-mirror-p/&quot;,             // PerOxyd stone 0x42
-    &quot;st-mirror-p-&quot;,             // PerOxyd stone 0x43
-    &quot;st-mirror-p\\&quot;,            // PerOxyd stone 0x44
+    &quot;st_mirror_slab_n&quot;,         // PerOxyd stone 0x41
+    &quot;st_mirror_slab_e&quot;,         // PerOxyd stone 0x42
+    &quot;st_mirror_slab_s&quot;,         // PerOxyd stone 0x43
+    &quot;st_mirror_slab_w&quot;,         // PerOxyd stone 0x44
     UNUSED,                     // PerOxyd stone 0x45
-    &quot;st-mirror-p/m&quot;,            // PerOxyd stone 0x46
-    &quot;st-mirror-p-m&quot;,            // PerOxyd stone 0x47
-    &quot;st-mirror-p\\m&quot;,           // PerOxyd stone 0x48
-    &quot;st-mirror-p|t&quot;,            // PerOxyd stone 0x49
-    &quot;st-mirror-p/t&quot;,            // PerOxyd stone 0x4a
-    &quot;st-mirror-p-t&quot;,            // PerOxyd stone 0x4b
-    &quot;st-mirror-p\\t&quot;,           // PerOxyd stone 0x4c
-    &quot;st-mirror-3&gt;&quot;,             // PerOxyd stone 0x4d
-    &quot;st-mirror-3^&quot;,             // PerOxyd stone 0x4e
-    &quot;st-mirror-3&lt;&quot;,             // PerOxyd stone 0x4f
-    &quot;st-mirror-3v&quot;,             // PerOxyd stone 0x50
+    &quot;st_mirror_slab_em&quot;,        // PerOxyd stone 0x46
+    &quot;st_mirror_slab_sm&quot;,        // PerOxyd stone 0x47
+    &quot;st_mirror_slab_wm&quot;,        // PerOxyd stone 0x48
+    &quot;st_mirror_slab_nt&quot;,        // PerOxyd stone 0x49
+    &quot;st_mirror_slab_et&quot;,        // PerOxyd stone 0x4a
+    &quot;st_mirror_slab_st&quot;,        // PerOxyd stone 0x4b
+    &quot;st_mirror_slab_wt&quot;,        // PerOxyd stone 0x4c
+    &quot;st_mirror_triangle_ec&quot;,    // PerOxyd stone 0x4d
+    &quot;st_mirror_triangle_nc&quot;,    // PerOxyd stone 0x4e
+    &quot;st_mirror_triangle_wc&quot;,    // PerOxyd stone 0x4f
+    &quot;st_mirror_triangle_sc&quot;,    // PerOxyd stone 0x50
     &quot;st-puzzle-es&quot;,             // PerOxyd stone 0x51
     &quot;st-puzzle-sw&quot;,             // PerOxyd stone 0x52
     &quot;st-puzzle-nw&quot;,             // PerOxyd stone 0x53

Modified: trunk/src/stones.hh
===================================================================
--- trunk/src/stones.hh	2008-06-17 20:54:25 UTC (rev 1182)
+++ trunk/src/stones.hh	2008-06-18 21:41:18 UTC (rev 1183)
@@ -66,6 +66,7 @@
         st_knight,
         st_laserbreak,
         st_magic,
+        st_mirror,
         st_movebreak,
         st_oneway,
         st_oneway_black,


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000616.html">[Enigma-game-svn] r1182 - in feature_branches/hp_lotm: images input	input/lotm
</A></li>
	<LI>Next message: <A HREF="000618.html">[Enigma-game-svn] r1184 - in trunk/src: . stones
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#617">[ date ]</a>
              <a href="thread.html#617">[ thread ]</a>
              <a href="subject.html#617">[ subject ]</a>
              <a href="author.html#617">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/enigma-game-svn">More information about the Enigma-game-svn
mailing list</a><br>
</body></html>
