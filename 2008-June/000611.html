<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Enigma-game-svn] r1177 - in trunk: data data/gfx32 data/gfx40	data/gfx48 data/gfx64 data/levels/enigma_iv	data/levels/enigma_tutorial data/levels/lib	data/levels/patches doc/manual src src/gui
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/enigma-game-svn/2008-June/index.html" >
   <LINK REL="made" HREF="mailto:enigma-game-svn%40lists.berlios.de?Subject=Re%3A%20%5BEnigma-game-svn%5D%20r1177%20-%20in%20trunk%3A%20data%20data/gfx32%20data/gfx40%0A%09data/gfx48%20data/gfx64%20data/levels/enigma_iv%0A%09data/levels/enigma_tutorial%20data/levels/lib%0A%09data/levels/patches%20doc/manual%20src%20src/gui&In-Reply-To=%3C200806151508.m5FF8xAp019071%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000610.html">
   <LINK REL="Next"  HREF="000612.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Enigma-game-svn] r1177 - in trunk: data data/gfx32 data/gfx40	data/gfx48 data/gfx64 data/levels/enigma_iv	data/levels/enigma_tutorial data/levels/lib	data/levels/patches doc/manual src src/gui</H1>
    <B>andreasl at mail.berlios.de</B> 
    <A HREF="mailto:enigma-game-svn%40lists.berlios.de?Subject=Re%3A%20%5BEnigma-game-svn%5D%20r1177%20-%20in%20trunk%3A%20data%20data/gfx32%20data/gfx40%0A%09data/gfx48%20data/gfx64%20data/levels/enigma_iv%0A%09data/levels/enigma_tutorial%20data/levels/lib%0A%09data/levels/patches%20doc/manual%20src%20src/gui&In-Reply-To=%3C200806151508.m5FF8xAp019071%40sheep.berlios.de%3E"
       TITLE="[Enigma-game-svn] r1177 - in trunk: data data/gfx32 data/gfx40	data/gfx48 data/gfx64 data/levels/enigma_iv	data/levels/enigma_tutorial data/levels/lib	data/levels/patches doc/manual src src/gui">andreasl at mail.berlios.de
       </A><BR>
    <I>Sun Jun 15 17:08:59 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000610.html">[Enigma-game-svn] r1176 - feature_branches/hp_lotm/input/lotm
</A></li>
        <LI>Next message: <A HREF="000612.html">[Enigma-game-svn] r1178 - in feature_branches/hp_lotm: images/lotm	input input/lotm
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#611">[ date ]</a>
              <a href="thread.html#611">[ thread ]</a>
              <a href="subject.html#611">[ subject ]</a>
              <a href="author.html#611">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: andreasl
Date: 2008-06-15 17:08:41 +0200 (Sun, 15 Jun 2008)
New Revision: 1177

Added:
   trunk/data/gfx64/it-dummy.png
   trunk/data/levels/patches/pox_051.lua
Modified:
   trunk/data/gfx32/it-dummy.png
   trunk/data/gfx40/it-dummy.png
   trunk/data/gfx48/it-dummy.png
   trunk/data/levels/enigma_iv/ralf15_1.xml
   trunk/data/levels/enigma_tutorial/a_tut07.xml
   trunk/data/levels/lib/libluatools.xml
   trunk/data/models-2d.lua
   trunk/doc/manual/enigma.texi
   trunk/doc/manual/enigma_de.texi
   trunk/src/SoundEngine.cc
   trunk/src/SoundEngine.hh
   trunk/src/client.cc
   trunk/src/gui/HelpMenu.cc
Log:
Trunk: Minor improvements and bug fixes
 - #include SDL_mutex for Maemo-compatibility.
 - Add helptext for &quot;Shift+ESC&quot;
    - in F1 game help menu (still fits on 640x480/320x240),
    - manual (English, German).
 - &quot;assert&quot; to ensure correct helptext in HelpMenu.
 - Better resolution and 64x64 for it-dummy.
 - it_cross in a_tut07 to show original position of st_chess,
   and removed wrong document text.
 - Patch pox_051.
 - Uncommented (unused) reference to randseed in ralf15.
 - New luatools function: luatools.digits.
Todo:
 - Although the manuals have to be worked over to include
   the new options menu either way, it might be better to
   translate the &quot;Shift+ESC&quot;-helptext already now.


Modified: trunk/data/gfx32/it-dummy.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx40/it-dummy.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx48/it-dummy.png
===================================================================
(Binary files differ)

Added: trunk/data/gfx64/it-dummy.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx64/it-dummy.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Modified: trunk/data/levels/enigma_iv/ralf15_1.xml
===================================================================
--- trunk/data/levels/enigma_iv/ralf15_1.xml	2008-06-14 11:15:31 UTC (rev 1176)
+++ trunk/data/levels/enigma_iv/ralf15_1.xml	2008-06-15 15:08:41 UTC (rev 1177)
@@ -3,7 +3,7 @@
   &lt;el:protected&gt;
     &lt;el:info el:type=&quot;level&quot;&gt;
       &lt;el:identity el:title=&quot;U-Swap&quot; el:subtitle=&quot;&quot; el:id=&quot;ralf15&quot;/&gt;
-      &lt;el:version el:score=&quot;1&quot; el:release=&quot;1&quot; el:revision=&quot;0&quot; el:status=&quot;released&quot;/&gt;
+      &lt;el:version el:score=&quot;1&quot; el:release=&quot;1&quot; el:revision=&quot;2&quot; el:status=&quot;released&quot;/&gt;
       &lt;el:author  el:name=&quot;Ralf Westram&quot; el:email=&quot;<A HREF="https://lists.berlios.de/mailman/listinfo/enigma-game-svn">amgine at reallysoft.de</A>&quot; el:homepage=&quot;&quot;/&gt;
       &lt;el:copyright&gt;Copyright &#169; 2003 Ralf Westram&lt;/el:copyright&gt;
       &lt;el:license el:type=&quot;GPL v2.0 or above&quot; el:open=&quot;true&quot;/&gt;
@@ -33,11 +33,13 @@
    &quot;###o###########o####&quot;,
 }
 
-if not difficult then
-   seed = 947360
-else
-   seed = 8375
-end
+--- No rand-seed in Enigma 1.1 anymore, Andreas May 2008
+-- (wasn't used anyway)
+--if not difficult then
+--   seed = 947360
+--else
+--   seed = 8375
+--end
 
 function randstone(x,y)
    local r = random(1,7)

Modified: trunk/data/levels/enigma_tutorial/a_tut07.xml
===================================================================
--- trunk/data/levels/enigma_tutorial/a_tut07.xml	2008-06-14 11:15:31 UTC (rev 1176)
+++ trunk/data/levels/enigma_tutorial/a_tut07.xml	2008-06-15 15:08:41 UTC (rev 1177)
@@ -29,7 +29,7 @@
 ti[&quot;#&quot;] = ti[&quot; &quot;] .. {&quot;st-likeoxyda&quot;}
 ti[&quot;@&quot;] = ti[&quot;.&quot;] .. {&quot;#ac-blackball&quot;}
 ti[&quot;C&quot;] = ti[&quot;.&quot;] .. {&quot;st-chess_black&quot;}
-ti[&quot;c&quot;] = ti[&quot;.&quot;] .. {&quot;st-chess_black&quot;, &quot;it_cross&quot;}
+ti[&quot;c&quot;] = (ti[&quot;.&quot;] .. {&quot;st-chess_black&quot;}) .. {&quot;it_cross&quot;}
 ti[&quot;D&quot;] = ti[&quot; &quot;] .. {&quot;st-door_a&quot;, name=&quot;door#&quot;}
 ti[&quot;T&quot;] = ti[&quot;.&quot;] .. {&quot;it_trigger&quot;, name=&quot;trigger#&quot;, target=&quot;open_door&quot;}
 ti[&quot;B&quot;] = ti[&quot;.&quot;] .. {&quot;#ac-blackball&quot;, controllers=0, player=1, name=&quot;second_marble&quot;}
@@ -92,7 +92,7 @@
         &lt;el:english el:translate=&quot;true&quot;&gt;The stone with the horse's head is called ''chess stone''. Watch how the other marble hits one of them to move it. The angle is important.&lt;/el:english&gt;
       &lt;/el:string&gt; 
       &lt;el:string el:key=&quot;text2&quot;&gt;
-        &lt;el:english el:translate=&quot;true&quot;&gt;Now try to move these chess stones onto the triggers. They always move two steps plus one step, the crosses might give you some idea.&lt;/el:english&gt;
+        &lt;el:english el:translate=&quot;true&quot;&gt;Now try to move these chess stones onto the triggers. They always move two steps plus one step.&lt;/el:english&gt;
       &lt;/el:string&gt; 
     &lt;/el:i18n&gt;
   &lt;/el:protected&gt;

Modified: trunk/data/levels/lib/libluatools.xml
===================================================================
--- trunk/data/levels/lib/libluatools.xml	2008-06-14 11:15:31 UTC (rev 1176)
+++ trunk/data/levels/lib/libluatools.xml	2008-06-15 15:08:41 UTC (rev 1177)
@@ -131,7 +131,7 @@
 -- A wrapper of &quot;if&quot; to resemble the ternary ?:-function.
 -- Note that this function evaluates both IFTRUE as well as IFFALSE, e.g.
 --   luatools.cond(t == 0, 1/t, error(&quot;Division by zero&quot;))
--- will evaluate the error-function and thus hold for any T.
+-- will evaluate the error-function and thus halt for any T.
 -- Hence: Make sure there are no sideeffects in IFTRUE and IFFALSE!
 function luatools.cond(condition, iftrue, iffalse)
   if condition then
@@ -141,6 +141,59 @@
   end
 end
 
+-- digits returns a table whose elements are the digits of NUMBER
+-- in base BASE. BASE can be a number (e.g. 3 to get ternary)
+-- as well as a table (then the table entries with numerical
+-- keys will be used as digits).
+-- Examples:
+--   luatools.digits(13, 2) = {1, 0, 1, 1}
+--   luatools.digits(15, 16) = {15}
+--   luatools.digits(17, 3) = {2, 2, 1}
+--   luatools.digits(17, {2, &quot;b&quot;, 5}) = {5, 5, &quot;b&quot;}
+-- Hexadecimal would be:
+--   luatools.digits(x, {0,1,2,3,4,5,6,7,8,9,&quot;A&quot;,&quot;B&quot;,&quot;C&quot;,&quot;D&quot;,&quot;E&quot;,&quot;F&quot;})
+-- NUMBER is supposed to be a non-negative integer.
+function luatools.digits(number, base)
+  -- Check arguments and calculate fullbase and exponent
+  if type(number) ~= &quot;number&quot; then
+    error(&quot;digits: First argument not a number (&quot;..type(number)..&quot; instead).&quot;)
+  end
+  if (type(base) ~= &quot;number&quot;) and (type(base) ~= &quot;table&quot;) then
+    error(&quot;digits: Second argument not valid type (&quot;..type(base)..&quot;).&quot;)
+  end
+  if (number &lt; 0) or (number ~= math.ceil(number)) then
+    error(&quot;digits: First argument out of range (&quot;..number..&quot;).&quot;)
+  end
+  local fullbase = {}
+  local exponent = 0
+  if type(base) == &quot;number&quot; then
+    if (base &lt; 2) or (base ~= math.ceil(base)) then
+      error(&quot;digits: Second argument out of range (&quot;..base..&quot;).&quot;)
+    end
+    for j = 1, base do
+      table.insert(fullbase, j - 1)
+    end
+  else -- type(base) == &quot;table&quot;
+    if table.getn(base) &lt; 2 then
+      error(&quot;digits: Second argument has not enough elements.&quot;)
+    end
+    fullbase = base
+  end
+  exponent = table.getn(fullbase)
+  -- Decompose NUMBER
+  local remains = number
+  local result = {}
+  while remains &gt; 0 do
+    local d = luatools.mod(remains, exponent)
+    table.insert(result, fullbase[d + 1])
+    remains = (remains - d) / exponent
+    if remains ~= math.ceil(remains) then
+      error(&quot;digits: Internal error during calculation (remains = &quot;..remains..&quot;).&quot;)
+    end
+  end
+  return result
+end
+
 -- Return a random permutation of n elements.
 -- This function outputs a table with integer entries between
 -- 1 and n at positions 1 to n.

Added: trunk/data/levels/patches/pox_051.lua
===================================================================
--- trunk/data/levels/patches/pox_051.lua	2008-06-14 11:15:31 UTC (rev 1176)
+++ trunk/data/levels/patches/pox_051.lua	2008-06-15 15:08:41 UTC (rev 1177)
@@ -0,0 +1,30 @@
+set_item(&quot;it-floppy&quot;, 18, 5)
+set_item(&quot;it-floppy&quot;, 31, 36)
+set_item(&quot;it-floppy&quot;, 34, 32)
+set_item(&quot;it-floppy&quot;, 32, 28)
+set_item(&quot;it-floppy&quot;, 30, 10)
+set_item(&quot;it-floppy&quot;, 55, 15)
+set_stone(&quot;st-door-h&quot;, 9, 3, {name = &quot;safe_door&quot;})
+kill_item(9, 5)
+
+xpositions = {6, 7, 8, 10, 11, 12}
+floppystate = {}
+
+for j, x in pairs(xpositions) do
+  set_stone(&quot;st-floppy&quot;, x, 4, {action = &quot;callback&quot;, target = &quot;floppy_callback&quot;})
+end
+
+function floppy_callback(onoff, sender)
+  local x, y = enigma.GetPos(sender)
+  floppystate[x] = 1 - (floppystate[x] or 0)
+  local total = 0
+  for j, x in pairs(xpositions) do
+    total = total + (floppystate[x] or 0)
+  end
+  if total == 6 then
+    SendMessage(enigma.GetNamedObject(&quot;safe_door&quot;), &quot;open&quot;)
+  else
+    SendMessage(enigma.GetNamedObject(&quot;safe_door&quot;), &quot;close&quot;)
+  end
+end
+

Modified: trunk/data/models-2d.lua
===================================================================
--- trunk/data/models-2d.lua	2008-06-14 11:15:31 UTC (rev 1176)
+++ trunk/data/models-2d.lua	2008-06-15 15:08:41 UTC (rev 1177)
@@ -397,7 +397,6 @@
         &quot;it-cross&quot;,
         &quot;it-document&quot;,
         &quot;it-drop&quot;,
-        &quot;it-dummy&quot;,
         &quot;it-dynamite&quot;,
         &quot;it-flagblack&quot;,
         &quot;it-flagwhite&quot;,
@@ -465,6 +464,11 @@
     DefTiles(&quot;it-extinguisher&quot;, {&quot;it-extinguisher&quot;, &quot;it-extinguisher_medium&quot;, &quot;it-extinguisher_empty&quot;})
 end
 
+-- it-dummy
+do
+    DefTiles(&quot;it-dummy&quot;, {&quot;it-dummy&quot;, &quot;it-dummy_egg&quot;})
+end
+
 -- Oil --
 do
     DefSubimages(&quot;it-burnable_oil&quot;, {h=4})

Modified: trunk/doc/manual/enigma.texi
===================================================================
--- trunk/doc/manual/enigma.texi	2008-06-14 11:15:31 UTC (rev 1176)
+++ trunk/doc/manual/enigma.texi	2008-06-15 15:08:41 UTC (rev 1177)
@@ -522,6 +522,9 @@
 @item @key{ESC}
 Display game menu
 
<A HREF="https://lists.berlios.de/mailman/listinfo/enigma-game-svn">+ at item</A> @key{Shift-ESC}
+Quit game immediately
+
 @item @key{F1}
 Display help screen
 

Modified: trunk/doc/manual/enigma_de.texi
===================================================================
--- trunk/doc/manual/enigma_de.texi	2008-06-14 11:15:31 UTC (rev 1176)
+++ trunk/doc/manual/enigma_de.texi	2008-06-15 15:08:41 UTC (rev 1177)
@@ -581,6 +581,9 @@
 @item @key{ESC}
 Zeige das Spielmen@&quot;u
 
<A HREF="https://lists.berlios.de/mailman/listinfo/enigma-game-svn">+ at item</A> @key{Umschalt+ESC}
+Spiel sofort beenden
+
 @item @key{F1}
 Zeige den Hilfebildschirm
 

Modified: trunk/src/SoundEngine.cc
===================================================================
--- trunk/src/SoundEngine.cc	2008-06-14 11:15:31 UTC (rev 1176)
+++ trunk/src/SoundEngine.cc	2008-06-15 15:08:41 UTC (rev 1177)
@@ -23,6 +23,7 @@
 #include &quot;main.hh&quot;
 
 #include &quot;SDL_mixer.h&quot;
+#include &quot;SDL_mutex.h&quot;
 
 #include &lt;string&gt;
 #include &lt;cassert&gt;

Modified: trunk/src/SoundEngine.hh
===================================================================
--- trunk/src/SoundEngine.hh	2008-06-14 11:15:31 UTC (rev 1176)
+++ trunk/src/SoundEngine.hh	2008-06-15 15:08:41 UTC (rev 1177)
@@ -26,6 +26,7 @@
 #include &quot;SoundEffectManager.hh&quot;
 #include &quot;MusicManager.hh&quot;
 #include &quot;SDL_mixer.h&quot;
+#include &quot;SDL_mutex.h&quot;
 
 #include &lt;string&gt;
 #include &lt;vector&gt;

Modified: trunk/src/client.cc
===================================================================
--- trunk/src/client.cc	2008-06-14 11:15:31 UTC (rev 1176)
+++ trunk/src/client.cc	2008-06-15 15:08:41 UTC (rev 1177)
@@ -484,6 +484,7 @@
     N_(&quot;Left mouse button:&quot;),    N_(&quot;Activate/drop leftmost inventory item&quot;),
     N_(&quot;Right mouse button:&quot;),      N_(&quot;Rotate inventory items&quot;),
     N_(&quot;Escape:&quot;),                  N_(&quot;Show game menu&quot;),
+    N_(&quot;Shift+Escape:&quot;),            N_(&quot;Quit game immediately&quot;),
     N_(&quot;F1:&quot;),                      N_(&quot;Show this help&quot;),
     N_(&quot;F3:&quot;),                      N_(&quot;Kill current marble&quot;),
     N_(&quot;Shift+F3:&quot;),                N_(&quot;Restart the current level&quot;),
@@ -502,7 +503,7 @@
     server::Msg_Pause (true);
     video::TempInputGrab grab(false);
 
-    helptext_ingame[15] = app.state-&gt;getInt(&quot;NextLevelMode&quot;) == lev::NEXT_LEVEL_NOT_BEST
+    helptext_ingame[17] = app.state-&gt;getInt(&quot;NextLevelMode&quot;) == lev::NEXT_LEVEL_NOT_BEST
         ? _(&quot;Skip to next level for best score hunt&quot;)
         : _(&quot;Skip to next unsolved level&quot;);
 

Modified: trunk/src/gui/HelpMenu.cc
===================================================================
--- trunk/src/gui/HelpMenu.cc	2008-06-14 11:15:31 UTC (rev 1176)
+++ trunk/src/gui/HelpMenu.cc	2008-06-15 15:08:41 UTC (rev 1177)
@@ -22,6 +22,8 @@
 #include &quot;video.hh&quot;
 #include &quot;nls.hh&quot;
 
+#include &lt;cassert&gt;
+
 using namespace ecl;
 using namespace std;
 
@@ -37,7 +39,10 @@
         const video::VMInfo &amp;vminfo = *video::GetInfo();
         const int vshrink = vminfo.width &lt; 640 ? 1 : 0;
         
-        add(ok, Rect(vminfo.width-(vshrink?85:170),vminfo.height-(vshrink?30:60),vshrink?75:150,vshrink?20:40));
+        add(ok, Rect(vminfo.width  - (vshrink ? 85 : 170),
+                     vminfo.height - (vshrink ? 30 : 60),
+                     vshrink ? 75 : 150,
+                     vshrink ? 20 : 40));
     }
     
     bool HelpMenu::on_event (const SDL_Event &amp;e) 
@@ -64,10 +69,14 @@
         blit(gc, 0,0, enigma::GetImage(&quot;menu_bg&quot;, &quot;.jpg&quot;));
         Font *f = enigma::GetFont(cfg.fontname.c_str());
     
-        int x = (vminfo.width-(vshrink?320:640))/2;
+        int x = (vminfo.width - (vshrink ? 320 : 640))/2;
         int y = (cfg.y0/(vshrink?2:1)) + (vminfo.height - (vshrink?240:480))/2;
         for (int i = 0; helptext[i]; i += 2) 
         {
+            assert(helptext[i+1]);
+            // If assert stops here, and you've worked on the game
+            // help menu, check Client::show_help(): Here one of
+            // the text lines is redefined. Correct the line number.
             f-&gt;render (gc, cfg.x0/(vshrink?2:1) + x, y, _(helptext[i]));    // translate
             f-&gt;render (gc, cfg.x1/(vshrink?2:1) + x, y, _(helptext[i+1]));  // translate
             y += cfg.yskip/(vshrink?2:1);


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000610.html">[Enigma-game-svn] r1176 - feature_branches/hp_lotm/input/lotm
</A></li>
	<LI>Next message: <A HREF="000612.html">[Enigma-game-svn] r1178 - in feature_branches/hp_lotm: images/lotm	input input/lotm
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#611">[ date ]</a>
              <a href="thread.html#611">[ thread ]</a>
              <a href="subject.html#611">[ subject ]</a>
              <a href="author.html#611">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/enigma-game-svn">More information about the Enigma-game-svn
mailing list</a><br>
</body></html>
