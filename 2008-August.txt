From ral at mail.berlios.de  Fri Aug  1 22:34:51 2008
From: ral at mail.berlios.de (ral at BerliOS)
Date: Fri, 1 Aug 2008 22:34:51 +0200
Subject: [Enigma-game-svn] r1249 - in trunk: lib-src/oxydlib src
Message-ID: <200808012034.m71KYp4c010819@sheep.berlios.de>

Author: ral
Date: 2008-08-01 22:34:50 +0200 (Fri, 01 Aug 2008)
New Revision: 1249

Modified:
   trunk/lib-src/oxydlib/EnigmaNames.cpp
   trunk/src/floors.cc
   trunk/src/items.cc
Log:
Trunk 1.1: new API reengineering
- fix r1248:
  - it-tinyhollow flipping
  - it-burn* mismatches
  - tools missing defines


Modified: trunk/lib-src/oxydlib/EnigmaNames.cpp
===================================================================
--- trunk/lib-src/oxydlib/EnigmaNames.cpp	2008-07-29 22:04:16 UTC (rev 1248)
+++ trunk/lib-src/oxydlib/EnigmaNames.cpp	2008-08-01 20:34:50 UTC (rev 1249)
@@ -22,6 +22,9 @@
 
 #define PLAIN_SPEC_ONLY
 #define UNUSED "<unused>"
+#define IT_INVALID "it_invalid"
+#define IT_EXTERNAL IT_INVALID
+#define IT_MISSING IT_INVALID
 
 #include "../../src/ox_oxyd1.cc"
 #include "../../src/ox_extra.cc"

Modified: trunk/src/floors.cc
===================================================================
--- trunk/src/floors.cc	2008-07-29 22:04:16 UTC (rev 1248)
+++ trunk/src/floors.cc	2008-08-01 20:34:50 UTC (rev 1249)
@@ -213,7 +213,7 @@
 }
 
 bool Floor::force_fire() {
-    SetItem(get_pos(), MakeItem("it-burnable-ignited"));
+    SetItem(get_pos(), MakeItem("it-burnable_ignited"));
     fire_countdown = 0;
     return true;
 }
@@ -374,7 +374,7 @@
         SetFloor(p, MakeFloor(get_firetransform().c_str()));
     // Remember, at this point "this" may be destroyed.
     if(!GetFloor(p)->has_firetype(flft_noash))
-        SetItem(p, MakeItem("it-burnable-ash"));
+        SetItem(p, MakeItem("it-burnable_ash"));
     return true; // fire extinguished  
 }
 
@@ -403,7 +403,7 @@
     if(cont_fire)
         // continue burning
         //   -> put animation
-        SetItem(p, MakeItem("it-burnable-burning"));
+        SetItem(p, MakeItem("it-burnable_burning"));
     else
         stop_fire(false);
 }

Modified: trunk/src/items.cc
===================================================================
--- trunk/src/items.cc	2008-07-29 22:04:16 UTC (rev 1248)
+++ trunk/src/items.cc	2008-08-01 20:34:50 UTC (rev 1249)
@@ -875,7 +875,7 @@
 
 void HillHollow::transmute(Type newtype)
 {
-    static char *newmodel[] = { "it-hill", "it-hollow", "it-tinyhill", "it_tinyhollow" };
+    static char *newmodel[] = { "it-hill", "it-hollow", "it-tinyhill", "it-tinyhollow" };
     replace(newmodel[newtype]);
 }
 
@@ -2760,7 +2760,7 @@
             if (Item *it = GetItem(p)) {
                 SendMessage (it, "extinguish");
             } else {
-                SetItem (p, MakeItem("it-burnable-fireproof"));
+                SetItem (p, MakeItem("it-burnable_fireproof"));
             }
         }
 



From ral at mail.berlios.de  Sat Aug  2 15:26:55 2008
From: ral at mail.berlios.de (ral at mail.berlios.de)
Date: Sat, 2 Aug 2008 15:26:55 +0200
Subject: [Enigma-game-svn] r1250 - trunk/doc/reference
Message-ID: <200808021326.m72DQtJf008835@sheep.berlios.de>

Author: ral
Date: 2008-08-02 15:26:41 +0200 (Sat, 02 Aug 2008)
New Revision: 1250

Modified:
   trunk/doc/reference/enigma-ref.texi
Log:
Trunk 1.1: new API
- refman docu chapter Lua API overview and 4 big examples added 


Modified: trunk/doc/reference/enigma-ref.texi
===================================================================
--- trunk/doc/reference/enigma-ref.texi	2008-08-01 20:34:50 UTC (rev 1249)
+++ trunk/doc/reference/enigma-ref.texi	2008-08-02 13:26:41 UTC (rev 1250)
@@ -3173,6 +3173,7 @@
 @node Target - Action
 @subsection Target - Action
 
+ at cindex target action paradigm
 The "target action paradigm" is a classical object oriented method that allows
 you to easily plug together objects. One object is triggered by a function
 call or by an event like an actor hitting a stone, crossing over or applying an
@@ -3246,8 +3247,46 @@
 @node Callback Function
 @subsection Callback Function
 
+ at cindex callback function
+The most powerful extension to the @ref{Target - Action} paradigm that you can
+think of are callback functions. Instead of a target object as receiver of an
+action message you can supply an own @url{http://www.lua.org, Lua} function that
+is called whenever the action is triggered.
 
+ at example
+@{st_switch, target="my_magic", action="callback"@}
+@{st_switch, target="my_magic"@}
+ at end example
 
+The @samp{target} is the name of the function as a string. You may set the
+ at samp{action} to the string @samp{"callback"} for purpose of clarification,
+but it is not necessary as you see in the second example. The engine identifies
+the target to be of type of a Lua function and thus the action needs to be
+a callback. But you should note and remember that it is up to you to ensure that
+all object names and callback functions names are unique. 
+
+Let us look at the syntax of such a callback function
+
+ at example
+function my_magic(value, sender)
+    if value == true
+        wo[sender + @{1,0@}] = @{"it_coin_s"@}
+    end
+end
+ at end example
+
+The function is called with two arguments. The first one is a value. The type
+and contents depends on the issuing object, but in most cases it is a boolean
+value. You will find the value described in the objects description. The second
+argument is the reference of the calling object.
+
+In the example we check if the @ref{st_switch} did just toggle to ON. If this
+is given we take the switch, which is the sender, as a position and set a new
+@{it_coin} to the grid east of it - a small bank automate that supplies money. 
+
+The @ref{Advanced Lua Examples} will show examples of real powerful callback 
+functions with a line by line comment.
+
 @node Object State
 @subsection Object State
 
@@ -3447,39 +3486,1429 @@
 @node Lua API
 @chapter Lua API
 
-Read API Concept Draft
+Knowing the basic principles of an Enigma level's world you now just need
+the language glue to write your first level. Enigma levels are written in
+the language @url{http://www.lua.org, Lua}. This powerful language gives you
+the ability to write most complex, dynamical levels, while being nearly 
+transparent on writing basic standard levels. Indeed there is no reason to dig
+into this language at the very beginning.
 
+With the second Lua API version, as of Enigma 1.10, we designed an optimized
+way of describing levels in a very short and readable manner. Thus we do
+introduce you to this API by giving several examples from a basic level to most 
+thrilling dynamic real Enigma levels. You should be able to start your first
+experiments just after reading the first example with its explanations.
+
+For your convenience we do color the Lua code part. Predefined Lua variables and
+functions are colored in green. Enigma internal string constants as object kinds,
+attribute or message names are colored in blue. Level specific variable names
+and value constants are colored in magenta.
+
+After the examples and a short overview we do give details of the language
+specific API part as you can expect it for a reference manual. Please note
+that additional @ref{Advanced Features} are described in a seperate chapter.
+
+Until this chapter is finished please read the API Concept Draft, too!
+
 @menu
-* Lua Example:: 
-* Enigma Lua Types::   
-* Object Definitions and Tiles::
-* Lua Positions::
+* Basic Lua Examples:: 
+* API 2 Overview::   
+* Advanced Lua Examples:: 
+* Position::
+* Object::
+* Group::
+* NamedObjects::
+* Tile::
+* Tiles::
+* World::
 * World Creation and Resolver Chaining::
 * Custom Resolver::
 
 @end menu
 
- at c ----------------- Lua Example -------------------- 
+ at c ----------------- Lua Examples -------------------- 
 
- at node Lua Example
- at section Lua Example
+ at node Basic Lua Examples
+ at section Basic Lua Examples
 
- at c ----------------- Enigma Lua Types -------------------- 
+Let us look at two basic onescreener levels, that make use of all basic 
+techniques. While the first level is a little bit artifical, as it is designed 
+for demo purposes only, the second one is a quite dynamic real level out of
+the Enigma levelpacks.
 
- at node Enigma Lua Types
- at section Enigma Lua Types
+ at menu
+* Basic Example::             
+* Colored Turnstiles::         Enigma Levelpack VIII, level #?
+ at end menu
 
+ at c ----------------- Basic Example -------------------- 
+ at node Basic Example
+ at subsection Basic Example
 
+Let us view the sourcecode. We did add a line count in the first two columns
+for reference purpose within this section. These line count number are not part
+of the source code itself!
 
- at c -------------- Object Definitions and Tiles ----------------- 
+ at example
+ 1    <?xml version="1.0" encoding="UTF-8" standalone="no" ?>
+ 2    <el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
+ 3     <el:protected>
+ 4       <el:info el:type="level">
+ 5         <el:identity el:title="Basic Level" el:subtitle="" el:id="20080721ral513"/>
+ 6         <el:version el:score="1" el:release="1" el:revision="$Revision: 1170 $" el:status="experimental"/>
+ 7         <el:author  el:name="Ronald Lamprecht" el:email="ral@@users.berlios.de"/>
+ 8         <el:copyright>Copyright @copyright{} 2008 Ronald Lamprecht</el:copyright>
+ 9         <el:license el:type="GPL v2.0 or above" el:open="true"/>
+10         <el:compatibility el:enigma="@var{1.10}"/>
+11         <el:modes el:easy="true" el:single="true" el:network="false"/>
+12         <el:score el:easy="-" el:difficult="-"/>
+13       </el:info>
+14       <el:luamain><![CDATA[
+15
+16    @i{wo}["@b{ConserveLevel}"] = @var{true}
+17
+18    @i{ti}["@var{ }"] = @{"@b{fl-samba}"@}
+19    @i{ti}["@var{.}"] = @{"@b{fl-abyss}"@}
+20    @i{ti}["@var{~}"] = @{"@b{fl-water}"@}
+21    @i{ti}["@var{#}"] = @{"@b{st-rock1}"@}
+22    @i{ti}["@var{X}"] = @{"@b{st_oxyd}"@}
+23
+24    @i{ti}["@var{L}"] = @{"@b{st_laser}", @b{orientation}=@var{EAST}, @b{state}=@var{ON}@}
+25    @i{ti}["@var{M}"] = @{"@b{st_lightpassenger}", @b{interval}=@var{0.04}@}
+26
+27    @i{ti}["@var{P}}"] = @{"@b{st_polarswitch}", @b{name}="@var{polar}"@}
+28    @i{ti}["@var{T}"] = @{"@b{it_trigger}", @b{target}="@var{polar}"@}
+29
+30    @i{ti}["@var{^}"] = @{"@b{st_boulder}", "@var{boulder}", @b{orientation}=@var{NORTH}@}
+31    @i{ti}["@var{F}"] = @{"@b{st_fourswitch}", @b{target}="@var{boulder}", @b{action}="@var{orientate}"@}
+32
+33    @i{ti}["@var{D}"] = @{"@b{st-door-v}", "@var{door}"@}
+34    @i{ti}["@var{B}"] = @{"@b{it_blocker}", "@var{wall#}"@}
+35    @i{ti}["@var{S}"] = @{"@b{st_switch}", @b{target}=@{"@var{door}", "@var{wall#*}"@}@}
+36
+37    @i{ti}["@var{v}"] = @{"@b{it_vortex}", "@var{left}", @b{destination}="@var{right}"@}
+38    @i{ti}["@var{V}"] = @{"@b{it_vortex}", "@var{right}", @b{destination}="@var{left}"@}
+39
+40    @i{ti}["@var{O}"] = @{"@b{st_turnstile}", @b{flavor}="@var{red}"@}
+41    @i{ti}["@var{E}"] = @{"@b{st_turnstilearm}", @b{orientation}=@var{EAST}@}
+42    @i{ti}["@var{N}"] = @i{ti}["@var{.}"] .. @{"@b{st_turnstilearm_n}"@}
+43
+44    @i{ti}["@var{+}"] = @{"@b{fl-samba}", @b{checkerboard}=@var{0}@} .. ti(@{"@b{fl-wood}", @b{checkerboard}=@var{1}@})
+45
+46    @i{ti}["@var{1}"] = @{"#@b{ac-blackball}"@}
+47
+48    if @i{wo}["@b{IsDifficult}"] then
+49        @i{ti}["@var{=}"] = @i{ti}["@var{~}"]
+50    else
+51        @i{ti}["@var{=}"] = @i{ti}["@var{~}"] .. @{"@b{it_strip_ew}"@}
+52    end
+53
+54    w, h = @i{wo}(@i{ti}, "@var{ }", @{
+55        "@var{####################}",
+56        "@var{#      ....++++++~ #}",
+57        "@var{L   PM ..N.++~~~~OE#}",
+58        "@var{#######  T~++++++. #}",
+59        "@var{#     ^   ~++++++# #}",
+60        "@var{#         =++++++X X}",
+61        "@var{#         ~++++++# #}",
+62        "@var{#~~~~~~~~~~~~~+++X X}",
+63        "@var{#    ~   B   ~+++###}",
+64        "@var{F    ~   B   ~+++++#}",
+65        "@var{# 1  ~   B   #+++++#}",
+66        "@var{S   v~V  B   D+++++#}",
+67        "@var{####################}"}
+68    @})
+69
+70    @i{wo}:@b{shuffleOxyd}()
+71
+72     ]]></el:luamain>
+73        <el:i18n>
+74          <el:string el:key="title">
+75            <el:english el:translate="false"/>
+76          </el:string>
+77        </el:i18n>
+78      </el:protected>
+79    </el:level>
+ at end example
 
- at node Object Definitions and Tiles
- at section Object Definitions and Tiles
+The resulting level looks like this in the game
 
- at c ----------------- Lua Positions -------------------- 
+Let us now analyse the code line by line.
 
- at node Lua Positions
- at section Lua Positions
+Lines 1 to 14 are the XML metadata of the level as described in 
+ at ref{Level Basics}. The only line worth mentioning is
+ at example
+10         <el:compatibility el:enigma="@var{1.10}"/>
+ at end example
+
+You need to declare the level to be compatible to Enigma 1.10 or higher for
+the new API 2 as described in this reference manual. A value less than 1.10
+indicates compatiblity to a previous Enigma release that did use the old API 1,
+which should not be mixed up with the new API 2.
+
+The Lua part starts with line 15:
+ at example
+16    @i{wo}["@b{ConserveLevel}"] = @var{true}
+ at end example
+
+Like most levels it starts with setting @ref{Global Attributes}. The handle of 
+our world is @samp{wo}. This object reference is preset
+(@pxref{World as an Object}). Concerning Lua it is an @samp{userdata},
+but most of its usage syntax is identical to that of Lua tables. Thus we access
+an attribute by providing the desired attribute name in square brackets. As we
+give a literal attribute name, we have to put it in double quotes @samp{"}. In
+total this line requests the world to resurrect a killed actor as long as there
+are enough extralifes to conserve the running level (@pxref{ConserveLevel}).
+In fact @samp{true} is the default value. So we could have left this line out.
+But remember it is a demo level.
+
+The second part of a level are the tile definitions as explained in
+ at ref{World's Shape and Coordinates}. Let us start with the most simple ones:
+ at example
+18    @i{ti}["@var{ }"] = @{"@b{fl-samba}"@}
+19    @i{ti}["@var{.}"] = @{"@b{fl-abyss}"@}
+20    @i{ti}["@var{~}"] = @{"@b{fl-water}"@}
+21    @i{ti}["@var{#}"] = @{"@b{st-rock1}"@}
+22    @i{ti}["@var{X}"] = @{"@b{st_oxyd}"@}
+ at end example
+
+Again we use a handle @samp{ti} which is a preset object reference for the
+tile definition repository. Like the world it is a Lua @samp{userdata}. And
+we can access it like the world by giving the desired index in square brackets.
+These indices are free to your choice. They have to be of a common character length
+if they are referenced in the world map below. For a small level one character
+keys are sufficient. You can use any ASCII character that Lua is aware of. That
+means upper and lower case characters @samp{A-Z,a-z}, the numbers and special
+characters besides backslash @samp{\} and double quote @samp{"}.
+
+The assigned object definition are given as Lua anonymous tables, the curly braces,
+containing in the most simple case just the desired @ref{Object Kind}. As it
+is again a literal string, it has to be quoted. Without any further specification
+the objects are taken in their default configuaration as described in 
+ at ref{Floor Objects} and following chapters.
+
+ at example
+24    @i{ti}["@var{L}"] = @{"@b{st_laser}", @b{orientation}=@var{EAST}, @b{state}=@var{ON}@}
+25    @i{ti}["@var{M}"] = @{"@b{st_lightpassenger}", @b{interval}=@var{0.04}@}
+ at end example
+
+These two lines define objects with custom configuration. The @ref{st_laser}
+should send its beam to the east and should start being switched on. The
+ at ref{st_lightpassenger} should move a little bit faster than usually. Both
+times we just have to add comma separated additional attributes. The attribute
+names are not quoted as they are followed by an equal @samp{=} sign.
+
+ at example
+27    @i{ti}["@var{P}}"] = @{"@b{st_polarswitch}", @b{name}="@var{polar}"@}
+28    @i{ti}["@var{T}"] = @{"@b{it_trigger}", @b{target}="@var{polar}"@}
+ at end example
+
+An @ref{st_polarswitch} named for reference usage (@pxref{Object Naming}).
+The @ref{it_trigger} sets up a @ref{Target - Action}, the target being our
+polarswitch. The action attribute is omitted. It defaults to the message
+ at samp{toggle}. Thus any actor or stone on top of the trigger makes the
+polarswitch transparent, but switches it back to intransparency when leaving
+the trigger.
+
+ at example
+30    @i{ti}["@var{^}"] = @{"@b{st_boulder}", "@var{boulder}", @b{orientation}=@var{NORTH}@}
+31    @i{ti}["@var{F}"] = @{"@b{st_fourswitch}", @b{target}="@var{boulder}", @b{action}="@var{orientate}"@}
+ at end example
+
+Another pair of objects that are coupled by @ref{Target - Action}. The
+ at ref{st_boulder} starts trying to move to north. This time we name the object
+just by giving the name as the second comma separated string. We omitted the
+attribute identifier @samp{name =}. This is a shortcut for this most common
+attribute which requires the name to be given as the second value directly 
+after the objects kind.
+
+The @ref{st_fourswitch} references the boulder as its target. We need to give
+the action as well, as we want to make use of a special action that directly 
+steers the boulder according to the fourswitch orientation.
+
+ at example
+33    @i{ti}["@var{D}"] = @{"@b{st-door-v}", "@var{door}"@}
+34    @i{ti}["@var{B}"] = @{"@b{it_blocker}", "@var{wall#}"@}
+35    @i{ti}["@var{S}"] = @{"@b{st_switch}", @b{target}=@{"@var{door}", "@var{wall#*}"@}@}
+ at end example
+
+And another even more complex @ref{Target - Action}. We want a single 
+ at ref{st_switch} to toggle a @ref{st_door} as well as set of @ref{it_blocker}s
+at the same time. The gaming idea is that neither with switch on nor with switch
+off the marble can pass both obstacles. The gamer needs to steer the boulder
+through the blocker wall to pass these obstacles.
+
+The setup of the door is simple. We just need to name it to be able to reference
+it later on. We want to use several blocker objects and we need to name each 
+for reference purposes. We do this by appending a hash sign @samp{#} to its
+name as described in @ref{Object Naming}. Every blocker gets a unique name.
+The switch needs to list all these objects as its targets. This is done by
+an embedded anonymous table given by the curly braces and comma separated
+values. The first one is our door's name, the second one is a wildcarded string
+that describes all our blocker objects. The asterix stands for any suffix
+that may have been added behind the hash in the process of autonaming of our
+blockers.
+
+ at example
+37    @i{ti}["@var{v}"] = @{"@b{it_vortex}", "@var{left}", @b{destination}="@var{right}"@}
+38    @i{ti}["@var{V}"] = @{"@b{it_vortex}", "@var{right}", @b{destination}="@var{left}"@}
+ at end example
+
+We want to use two @ref{it_vortex} that are connected to each other allowing
+the marble to warp into both directions. We set up both vortices with a unique
+name and add the attribute @samp{destination} referencing the other vortex' name.
+
+Note that it is no problem to reference the right vortex in line 37 while it
+is named later on in line 38. We are still just defining tiles and not creating
+any objects at all.
+
+ at example
+40    @i{ti}["@var{O}"] = @{"@b{st_turnstile}", @b{flavor}="@var{red}"@}
+41    @i{ti}["@var{E}"] = @{"@b{st_turnstilearm}", @b{orientation}=@var{EAST}@}
+42    @i{ti}["@var{N}"] = @i{ti}["@var{.}"] .. @{"@b{st_turnstilearm_n}"@}
+ at end example
+
+Another object group is an @ref{st_turnstile} cluster with one arm disconnected.
+The first two definitions are straight forward. But in line 42 we preceed the
+arm's definition by another tile reference. It is the abyss tile defined in 
+line 19. By concatenation, the two dots @{..}, of a tile and a object
+definition we can define a new that is composed of both objects. In this case
+we define a turnstile arm on top of an abyss floor.
+
+You may be wondering why we did not define floors for the other stone and item
+tiles. We make use of the tile definition in line 18 that we will declare
+later as the default floor for our level. Thus any tile declaration that does
+not provide its own floor will set this default floor.
+
+ at example
+44    @i{ti}["@var{+}"] = @{"@b{fl-samba}", @b{checkerboard}=@var{0}@} .. ti(@{"@b{fl-wood}", @b{checkerboard}=@var{1}@})
+ at end example
+
+Just for fun we want to provide a checkerboard floor on the right side of our
+level. This can be done by usage of the @ref{checkerboard} attribute. Again
+we concatenate two object definitions for a single tile. Both are floors. That
+means for each grid position we try to set both floor types, but just one meets
+the checkboard condition and will be set.
+
+Please notice that we did convert one one the floor object definitions to a tile
+definition by the function call @samp{ti()}. This is necessary as Lua does not
+know how to concatenate two anonymous tables. One argument of the concatenation
+has to be a tile.
+
+ at example
+46    @i{ti}["@var{1}"] = @{"#@b{ac-blackball}"@}
+ at end example
+
+Finally we do need our marble. Unlike other objects it can be positioned 
+anywhere within a grid. The most common position is the center of the grid.
+This is simply done by preceeding the actor's kind by a hash sign @samp{#}.
+
+ at example
+48    if @i{wo}["@b{IsDifficult}"] then
+49        @i{ti}["@var{=}"] = @i{ti}["@var{~}"]
+50    else
+51        @i{ti}["@var{=}"] = @i{ti}["@var{~}"] .. @{"@b{it_strip_ew}"@}
+52    end
+ at end example
+
+We encourage every level author to provide an easy mode for the levels. This
+is an example how to define mode dependant tiles. Like in line 16 we access
+a world attribute. But this time it is a read access of @ref{IsDifficult}.
+In easy mode we want a @ref{it_strip} on top of water floor that allows the 
+marble to pass and press the trigger. In difficult mode the there should be
+no passage. Thus the special tile is identical to the water tile defined in
+line 20.
+
+ at example
+54    w, h = @i{wo}(@i{ti}, "@var{ }", @{
+55        "@var{####################}",
+56        "@var{#      ....++++++~ #}",
+57        "@var{L   PM ..N.++~~~~OE#}",
+58        "@var{#######  T~++++++. #}",
+59        "@var{#     ^   ~++++++# #}",
+60        "@var{#         =++++++X X}",
+61        "@var{#         ~++++++# #}",
+62        "@var{#~~~~~~~~~~~~~+++X X}",
+63        "@var{#    ~   B   ~+++###}",
+64        "@var{F    ~   B   ~+++++#}",
+65        "@var{# 1  ~   B   #+++++#}",
+66        "@var{S   v~V  B   D+++++#}",
+67        "@var{####################}"}
+68    @})
+ at end example
+
+After all tiles have been defined we can create our world simply by a map that
+uses our tile keys. The first argument is our handle @samp{ti}, that defines
+how the keys should be resolved. The second argument is the key of our default
+floor. The third argument is the map as a table of strings, one for every line.
+
+The world initialization returns the width and height of our world which are
+calcluated by the maps size.
+
+ at example
+70    @i{wo}:@b{shuffleOxyd}()
+ at end example
+
+After the world is created and all objects are set, we can do some final
+postprocessing before the level starts to run. The most common task is the
+shuffling of the oxyds, which is just a method call of @ref{shuffleOxyd} to 
+our mighty world object.
+
+ at c ----------------- Colored Turnstiles -------------------- 
+ at node Colored Turnstiles
+ at subsection Colored Turnstiles
+
+As this level is part of the Enigma levelpacks we recommend that you play
+the level first to get familar with the used objects and their behaviour.
+
+Now let us look at the essential Lua source code part of the level to understand
+how such an idea can be realized with the new API
+
+ at example
+ at i{ti}["@var{ }"] = @{"@b{fl-sahara}"@}
+ at i{ti}["@var{#}"] = @{"@b{st-rock6}"@}
+ at i{ti}["@var{@@}"] = @{"#@b{ac-blackball}"@}
+
+ at i{ti}["@var{N}"] = @{"@b{st_turnstilearm_n}"@}
+ at i{ti}["@var{S}"] = @{"@b{st_turnstilearm_s}"@}
+ at i{ti}["@var{E}"] = @{"@b{st_turnstilearm_e}"@}
+ at i{ti}["@var{W}"] = @{"@b{st_turnstilearm_w}"@}
+ at i{ti}["@var{R}"] = @{"@b{st_turnstile}", @b{action} = @{"@b{open}", "@b{close}"@}, @b{target} = @{"@var{red}#*", "@var{green}#*"@}@}
+ at i{ti}["@var{G}"] = @{"@b{st_turnstile}", @b{action} = @{"@b{close}", "@b{open}"@}, @b{target} = @{"@var{red}#*", "@var{green}#*"@},
+                           @b{flavor} = "@b{green}"@}
+ at i{ti}["@var{r}"] = @{"@b{it_blocker}", "@var{red}#"@} .. @i{ti}(@{"@b{fl-red}"@})
+ at i{ti}["@var{g}"] = @{"@b{it_blocker}", "@var{green}#"@} .. @i{ti}(@{"@b{fl-leaves}"@})
+
+ at i{ti}["@var{O}"] = @{"@b{st_oxyd}", @b{flavor} = "@b{d}", @b{oxydcolor} = @var{OXYD_GREEN}@}
+ at i{ti}["@var{o}"] = @{"@b{st_oxyd}", @b{flavor} = "@b{d}", @b{oxydcolor} = @var{OXYD_RED}@}
+  
+ at var{w}, @var{h} = @i{wo}(@i{ti}, "@var{ }", @{
+ -- 01234567890123456789
+   "@var{#O#####O############}",
+   "@var{#   r N g N rO##O#O#}",
+   "@var{#WRE#WGE# R ####g#r#}",
+   "@var{#   r N r S  r N   #}",
+   "@var{#g#g#WG #g##r# REr##}",
+   "@var{# # N S r    g S  gO}",
+   "@var{#@@g RE#g#gWGE###g###}",
+   "@var{# # S   g    r N  ro}",
+   "@var{#r#r#WGE#r##g#WGEg##}",
+   "@var{# N r S g N  r     #}",
+   "@var{#WGE# RE# RE####r#g#}",
+   "@var{#   g S r S go##o#o#}",
+   "@var{#o#####o############}"
+@})
+ at end example
+
+There are just four tile definitions that do all the dynamic actions. Let us
+look first at the blocker item definitions:
+
+ at example
+ at i{ti}["@var{r}"] = @{"@b{it_blocker}", "@var{red}#"@} .. @i{ti}(@{"@b{fl-red}"@})
+ at i{ti}["@var{g}"] = @{"@b{it_blocker}", "@var{green}#"@} .. @i{ti}(@{"@b{fl-leaves}"@})
+ at end example
+All blockers on red floors are autonamed with a name being composed of the
+prefix @samp{red#} and a unique random number being added by the engine as
+explained in @ref{Object Naming}. This allows us to address all these blockers
+later on.
+
+ at example
+ at i{ti}["@var{R}"] = @{"@b{st_turnstile}", @b{action} = @{"@b{open}", "@b{close}"@}, @b{target} = @{"@var{red}#*", "@var{green}#*"@}@}
+ at i{ti}["@var{G}"] = @{"@b{st_turnstile}", @b{action} = @{"@b{close}", "@b{open}"@}, @b{target} = @{"@var{red}#*", "@var{green}#*"@},
+                           @b{flavor} = "@b{green}"@}
+ at end example
+Whenever the marble hits and turns an @ref{st_turnstile} it performs its actions
+on the targets. Here the author makes clever usage of multitargets and 
+multiactions as described in @ref{Target - Action}. On every turn of a red
+turnstile all objects named @samp{red#*}, that are all our blockers on a red
+floor, will be send a message @samp{open}, whereas all blockes on a green floor,
+the second target group, receives the second action message @samp{close}. It is
+essential to choose the @samp{open}, @samp{close} messages instead of 
+ at samp{toggle}, as more than one red turnstile may be turned in sequence, but
+just the first red turn should "toggle" all blockers. The next toggling should
+occur on the first green turn following thereafter.
+
+Hope you got the basic idea of the new API. You may well start with you first
+level experiments. But you should return and read the following chapters with
+overview and advanced examples to write even more fancy levels.
+
+ at c ----------------- API 2 Overview -------------------- 
+
+ at node API 2 Overview
+ at section API 2 Overview
+
+Having analysed a first level it is time get an overview of the API 2 
+capabilities. Let us take a task driven appoach by listing the different
+possibilities and use cases by example.
+
+ at menu
+* Types Overview::         
+* Position Tasks::           
+* Attribute Tasks::           
+* Object Tasks::           
+* Group Tasks::           
+* Tiles and World Tasks::           
+ at end menu
+
+
+ at c ----------------- Types Overview -------------------- 
+ at node Types Overview
+ at subsection Types Overview
+
+But first we need to introduce you to the special Enigma value types besides
+the standard Lua types @samp{nil}, @samp{boolean}, @samp{string}, 
+ at samp{function} and @samp{table}:
+ 
+ at table @asis
+ at item @b{Types:}
+ at table @asis
+ at item @b{position:}@ @ @xref{Position}
+A position within the world that can be described by an x and y coordinate.
+ at item @b{object:}@ @ @xref{Object}
+An Enimga object like a stone, item, floor, other. Any object is a position, too.
+ at item @b{group:}@ @ @xref{Group}
+A list of objects.
+ at item @b{namedobjects:} @i{preset variable:} @code{@b{no}}; @ @ @xref{NamedObjects}
+The singleton type of the repository of all named objects.
+ at item @b{default:} @i{preset variable:} @code{@b{DEFAULT}}; @ @ @xref{Default}
+The singleton type of default values that can be used instead of Lua's @samp{nil}
+in anonymous table tile definitions.
+ at item @b{tile:}@ @ @xref{Tile}
+A description of one or several objects for a common grid position (floor, item,
+stone, actor)
+ at item @b{tiles:} @i{preset variable:} @code{@b{ti}}; @ @ @xref{Tiles}
+The singleton type of the repository of all tile instances.
+ at item @b{world:} @i{preset variable:} @code{@b{wo}}; @ @ @xref{World}
+The singleton type of the world that contains all objects.
+ at end table
+ at end table
+
+Please note the three handles @samp{no}, @samp{ti} and @samp{wo}. You have
+noticed two of them in the previous section @ref{Basic Lua Examples}. These
+are three variables, that are preset prior the level code gets executed.
+
+API 2 uses generally two character names for frequently used variables and
+functions to shorten the level code and to make it better readable. Authors 
+should try to use either single characters or names that are three characters or
+longer for private variable names.
+
+For the rest of this section let us assume that @samp{obj} is an object 
+reference of a stone, item or floor, which means that is of type @samp{object}.
+And let @samp{pos} be a valid variable of type @samp{position}.
+
+ at c ----------------- Position Tasks -------------------- 
+ at node Position Tasks
+ at subsection Position Tasks
+
+ at table @asis
+ at item @b{Creating Positions:}
+ at example
+ at var{pos} = @i{po}(@var{7}, @var{3})         -- using function "po()" to generate a position object
+ at var{pos} = @i{po}(@{@var{7}, @var{3}@})        -- using a table position constant as argument
+ at var{pos} = @var{obj}              -- every object is a valid position
+ at var{pos} = @i{po}(@var{12.3}, @var{3.7})    -- a position within a grid (for an actor) 
+ at end example
+Absolut positions are created by the function @samp{po()}. But the most common
+way should be the reinterpretation of an object as a position. This lets you
+set other objects relatively to given ones.
+
+ at item @b{Position Constants:}
+ at example
+@{@var{7}, at var{3}@}     -- a valid position for all arguments and operations (@pxref{Caveats}) 
+ at end example
+Anonymous tables with just two number values can be used in many cases directly as
+a position constant. In case of errors, e.g. when operators are not well defined
+like addition of two constants what result in an attempt of adding two Lua 
+tables, use the function @samp{po()} to convert the constant.
+
+ at item @b{Coordinate Access:}
+ at example
+ at var{x}, @var{y} = @var{pos}. at b{x}, @var{pos}. at b{y}
+ at var{x}, @var{y} = @var{pos}["@b{x}"], pos["@b{y}"]
+ at var{x}, @var{y} = @var{pos}:@b{xy}()
+ at var{x}, @var{y} = @var{obj}. at b{x}, @var{obj}. at b{y}
+ at var{x}, @var{y} = @var{obj}:@b{xy}()
+ at end example
+The x and y coordinate of a position or object can be read accessed like any
+object attribute. A position or object method call by @samp{xy()} returns
+both coordinate values at once. You can not set a position value by coordinate
+write access. Objects need to be set to a new world position. New positions
+can be calculated by position arithmetic.
+
+ at item @b{Position Calculation:}
+ at example
+ at var{pos} = @var{obj} + @{@var{2}, at var{7}@}
+ at var{dpos} = @var{obj1} - @var{obj2}
+ at var{dpos2} = @var{2} * @var{dpos}
+ at var{dpos3} = @var{dpos} / @var{2}
+ at end example
+Positions can be added or subtracted to get distance vectors. You can multiply
+and divide them with any number.
+
+ at item @b{Center positions for set actors}
+ at example
+ at var{pos_centered1} = @var{pos} + @{@var{0.5}, @var{0.5}@}
+ at var{pos_centered2} = #@var{pos}
+ at var{pos_centered3} = #@var{obj}
+ at end example
+Especially for positioning of actors you sometimes need the position of the
+center of a grid. Of course you can get it by addition of a constant position.
+But the @samp{#} operator applied on a position or an actor does the same in
+a simpler way.
+
+ at item @b{Round a position to a grid}
+ at example
+ at var{grid_pos} = @var{pos}:@b{grid}()
+ at var{grid_pos} = ((@var{pos1} - @var{pos2})/@var{2}):@b{grid}()
+ at end example
+A result of a position calculation needs sometimes to be rounded to integer grid
+coordinates. This is done by the @samp{grid()} method.
+
+ at item @b{Position comparison}
+ at example
+ at var{pos_centered1} == @var{pos_centered2}
+ at var{pos_centered1} ~= @var{pos_centered2}    -- Lua's inequality operator
+ at end example
+Position can be easily compared to equality.
+ at end table
+
+ at c ----------------- Attribute Tasks -------------------- 
+ at node Attribute Tasks
+ at subsection Attribute Tasks
+
+ at table @asis
+
+ at item @b{Single Attribute Setting:}
+ at example
+ at var{obj}["@b{destination}"] = @i{po}(@var{7}, at var{3})
+ at i{wo}["@b{Brittleness}"] = @var{7}
+ at end example
+Object attributes as well as global world attributes can be set like Lua table
+values. They can take values of special Enigma types like position, object or
+group.
+
+ at item @b{Multiple Attribute Setting:}
+ at example
+ at var{obj}:@b{set}(@{@b{target}=@var{mydoor}, @b{action}="@b{open}"@})
+ at end example
+You can multiple attributes on any object at once with the objects @samp{set()}
+method. The arguement is an anonymous Lua table with the attribute names as keys
+and assigned values of your choice.
+
+ at item @b{Requesting Attributes:}
+ at example
+ at var{value} = @var{obj}["@b{attr_name}"]
+ at var{value} = @i{wo}["@b{Brittleness}"]
+if @i{wo}["@b{IsDifficult}"] then ... end
+ at end example
+Attributes of objects and the world can be read like Lua table key values.
+
+ at item @b{Reset Attributes:}
+ at example
+ at var{obj}["@b{length}"] = nil       -- the default length, e.g. @samp{1}
+ at var{obj}["@b{color}"]  = nil       -- delete color attribute - no color
+ at var{obj}["@b{length}"] = @i{DEFAULT}   -- the default length, e.g. @samp{1}
+ at end example
+Any object attribute can be reset to its default value, what is the attributes
+"delete" operation, by assigning it the Lua @samp{nil} or the Enigma 
+ at samp{DEFAULT} value.
+
+ at end table
+
+ at c ----------------- Object Tasks -------------------- 
+ at node Object Tasks
+ at subsection Object Tasks
+
+ at table @asis
+ at item @b{Creating Objects:}
+ at example
+ at i{wo}[@var{pos}]  = @{"@b{st_chess}", @b{color}=@var{WHITE}, @b{name}="@var{Atrax}"@}   -- on grid pos
+ at i{wo}[#@var{pos}] = @{"@b{ac_bug}"@}              -- actor centered on grid pos
+ at i{wo}[@var{pos}]  = @{"#@b{ac_bug}"@}             -- actor centered on grid pos
+ at i{wo}[@var{pos}]  = @{"@b{ac_bug}", @var{0.3}, @var{0.7}@}    -- actor with offsets to pos
+ at i{wo}[@var{my_floor}] = @{"@b{it_magicwand}"@}    -- set an wand on top of a given foor object
+ at i{wo}[@var{pos}]  = @i{ti}["@var{x}"]                 -- tile based object definition
+ at end example
+Besides map based object creation, that you saw in the previous basic examples,
+you can create new objects on any world position directly. The world takes a
+position, that may well be an object, as key argument. The new object is
+described either by an anonymous Lua table, containing the kind string as first
+value and additional attributes as key value pairs appended, or by a tile object.
+
+ at item @b{Object Naming:}
+ at example
+ at i{no}["@var{Atrax}"] = @var{obj}
+ at i{wo}[@var{pos}] = @{"@b{st_chess}", @b{name}="@var{Atrax}"@}
+ at i{wo}[@var{pos}] = @{"@b{st_chess}", "@var{Atrax}", @b{color}=@var{WHITE}@}
+ at end example
+As explained in @ref{Object Naming}, the names are the only longtime valid
+object references. You can explicitly name an object by assigning it at the
+named object repository @samp{no} to the name as the key. But most times you
+just supply the objects name as an object attribute. If you supply the name
+attribute as the @b{second} value in the anonymous table you can omit the
+key @samp{name =} part as a common abreviation.
+
+ at item @b{Object Autonaming:}
+ at example
+ at i{wo}[@var{pos}] = @{"@b{st_chess}", @b{name}="@var{Atrax}#"@}
+ at end example
+As explained in @ref{Object Naming} you can append a hash sign @samp{#} to a
+name and use the resulting string for arbitrary number of similar objects. This
+is especially useful for building groups.
+
+ at item @b{Requesting Objects:}
+ at example
+ at var{obj} = @i{no}["@var{Atrax}"]       -- named object retrieval from repository
+ at var{obj} = @i{it}(@var{pos})
+ at var{obj} = @i{it}(@var{x}, at var{y})
+ at var{obj} = @i{st}(@var{pos})
+ at var{obj} = @i{wo}:@b{it}(@var{pos})
+ at var{my_item} = @i{it}(@var{my_floor})  -- get the item that is on top of the given floor
+ at end example
+The most common way is naming objects and the requesting the @samp{no} 
+repository for the object reference. If you know the position of the desired
+object you can use one of the functions or world methods @samp{fl}, @samp{it},
+ at samp{st} that take a position, an object as position, or just the two
+coordinates as arguments. Especially requesting one type of objects that is
+positioned at the same grid as another object, the stone on top of a floor, etc.
+can be very useful.
+
+ at item @b{Killing Objects:}
+ at example
+ at i{wo}[@var{pos}] = @{"@b{it_nil}"@}
+ at var{obj}:@b{kill}()
+ at end example
+You remove an object by setting another replacement object at the same
+position in the same layer. If you do not want to set a new object you can use
+the placebo objects @samp{fl_nil}, @samp{it_nil}, @samp{st_nil}. Another way is
+to call the @samp{kill()} method of an object or send it a @samp{kill} message.
+You can only remove objects that are set on the grid. Neither actors nor owned
+objects like items in a players inventory can be killed - they will simply
+ignore the attempt.
+
+ at item @b{Comparing Objects}
+ at example
+ at var{obj1} == @var{obj2}
+ at var{obj1} ~= @var{obj2}
+ at end example
+Objects can be directly compared on equality or inequality. It is a identity
+comparison that acknowledges that you have two references of the same object.
+
+ at item @b{Existence of an object}
+ at example
+ at var{obj}:@b{exists}()
+- at var{obj}                -- unary minus operator on object
+if - at var{obj} then ...
+ at end example
+Object references may get invalid due to objects being killed. In most cases
+this no problem as requests to invalid objects will simply be ignored. But if
+the level logic depends on the existence of an object you can call the 
+ at samp{exists()} method or simply preceed the reference by the unary minus 
+ at samp{-} operator. Both ways return a simple bool value stating if the object
+reference is still valid.
+
+ at item @b{Messages:}
+ at example
+ at var{my_boulder}:@b{message}("@b{orientate}", @var{WEST})
+ at var{my_boulder}:@b{orientate}(@var{EAST})
+ at var{my_door}:@b{open}()
+ at end example
+ at ref{Messages} are a main feature of Enigma. You can send them directly to any
+object by the @samp{message()} method or by using any message directly as a
+method call itself.
+
+ at item @b{Object Classification:}
+ at example
+ at var{obj}:@b{is}("@b{st_chess}")
+ at var{obj}:@b{is}("@b{st}")
+ at var{obj}:@b{is}("@b{st_chess_black}")
+ at end example
+You create objects by giving an @ref{Object Kind}. Later on you can check a
+given object for conformity to a given class or kind. Even though you can not
+create abstract kind objects like @samp{st}, you can check this way if an object
+is a stone. Checking for special subkinds may even evaluate the current state
+or other attributes of an object to report its current classification.
+
+ at end table
+
+ at c ----------------- Group Tasks -------------------- 
+ at node Group Tasks
+ at subsection Group Tasks
+
+ at table @asis
+ at item @b{Creating Groups:}
+ at example
+ at var{group} = @i{no}["@b{Atrax}#*"]           -- a group of all matching objects
+			        --   wildcards "*","?" allowed
+ at var{group} = @i{grp}(@var{obj1}, @var{obj2}, @var{obj3})
+ at var{group} = @i{grp}({@var{obj1}, @var{obj2}, @var{obj3}@})  -- a group of objects set up in a table
+ at end example
+Requesting objects from the named object repository will result in a group of
+objects if you make proper usage of wildcards. Appending an asterix @samp{*}
+to the autonaming hash will retrieve all objects that have been set with this
+name suffix. But you can create a group by the @samp{grp} function, too. Simply
+add the desired object reference as arguments, either single or as a table.
+
+ at item @b{Group Usage:}
+ at example
+ at var{floor_group}["@b{friction}"] = @var{3.2}      -- set attribute on all floors in the group
+ at var{door_group}:@b{message}("@b{open}")
+ at var{door_group}:@b{open}()
+ at var{stone_group}:@b{kill}()
+ at i{wo}[@var{floor_group}] = @{"@b{it_coin_m}"@}   -- add some money on all floor positions
+
+ at i{wo}[@var{pos}] = @{"@b{st_switch}", @b{target}=@var{door_group}, @b{action}="@b{open}"@}
+ at i{wo}[@var{pos}] = @{"@b{st_switch}", @b{target}="@var{door}#*", @b{action}="@b{close}"@}
+ at end example
+Many object operations can be applied to groups in the same manner. The 
+operations will be applied to all members of the group. You set attributes,
+send messages or call any method.
+
+The world object takes a group as key, too. You can set objects of a given
+definition to many positions at once.
+
+Another usage of groups is the application as an attribute value. E.g. you can
+define multiple targets by supplying a group.
+
+ at item @b{Group Operations:}
+ at example
+ at var{doors_lasers} = @var{doorgrp} + @var{lasergrp}       -- join of two groups
+ at var{lasergrp}     = @var{doors_lasers} - @var{doorgrp}   -- difference of two groups
+ at var{common_doors} = @var{doorgrp1} * @var{doorgrp2}      -- intersection of two groups
+ at end example
+Groups offer some standard operations known from handling with sets.
+
+ at item @b{Group Members:}
+ at example
+ at var{count} = #@var{mygroup}        -- number of objects in the group
+ at var{obj}   = @var{mygroup}[@var{5}]     -- 5th object of the group
+for @var{i} = @var{1}, #@var{mygroup} do @var{obj} = @var{mygroup}[@var{i}] ... end
+for @var{obj} in @var{mygroup} do ... end
+ at end example
+You can access the members of a group by numbered indices. The size of a group
+is reported by the standard Lua hash @samp{#} operator. If you need to iterate
+over the objects of a group you can write easily Lua for loops. You can either
+iterate with a counter or directly iterate the content objects.
+ at end table
+
+ at c ----------------- Tiles and World Tasks -------------------- 
+ at node Tiles and World Tasks
+ at subsection Tiles and World Tasks
+
+ at table @asis
+
+ at item @b{Tiles:}
+ at example
+ at i{ti}["@var{_}"] = @{"@b{fl_sahara}"@}
+ at i{ti}["@var{__}"] = @{"@b{fl_sahara}"@}
+ at i{ti}["@var{..}"] = @{"@b{fl_sand}"@}
+ at i{ti}["@var{##}"] = @{"@b{st_blocker}"@}
+ at i{ti}["@var{switch_template}"] = @{"@b{st_switch}"@}
+ at i{ti}["@var{..}"] = @{"@b{fl_abyss}"@}   -- redefinition causes error to avoid common mistakes
+ at i{ti}["@var{.w}"] = @i{ti}["@var{..}"] .. @{"@b{it_magicwand}"@}
+ at i{ti}["@var{ w}"] = @{"@b{fl_abyss}"@} .. @i{ti}(@{"@b{it_magicwand}"@})
+ at end example
+The tiles repository @samp{ti} is like a table, but specialized on storage of
+tile definitions. You can use any string as key. You can store the same 
+definition twice at different keys. But you are not allowed to redefine an
+already set key. This is pure protection of common error situations. A
+definition stored in the repository can be used in other definitions that
+follow. Referencing a tiles repository entry at a given key like @samp{ti[".."]}
+results in a tile value. Such tile values can be concatenated by the @samp{..}
+operator with other tile values and anonymous tables containing object 
+definitions. The last example is a concatenation of two prior not declared 
+object definitions. You can not concatenate two anonymous tables. Lua forbids 
+that. By converting any of the two tables by the @samp{ti()} to a tile value the 
+concatenation gets valid.
+
+ at item @b{World Initialization}
+ at example
+  @var{width}, @var{height} = @i{wo}(@i{ti}, "@var{__}", { -- second arg: default tile key that 
+  "@var{##__......}",                  --   defines the base, too - this example
+  "@var{##..__.w__}",                  --   is 2 chars per tile/grid 
+  "@var{##.. w__..}"
+  })
+ at end example
+The world is initialized by the @samp{wo()} call that is explained in details
+at @ref{World Creation and Resolver Chaining}. In the simple form you supply
+the @samp{ti} handle as the first argument. The second argument is the key of
+the default tile definition that defines the default floor to be set if a tile
+does not contain another floor object. At the same time this key defines by its
+length the standard key length as used in the following map, too. The third 
+argument is the map given as an anonymous table of strings. The worlds size is
+given by the maximum line length and the number of lines. These values are
+returned by the call.
+
+ at end table
+
+ at c ----------------- Advanced Lua Examples -------------------- 
+
+ at node Advanced Lua Examples
+ at section Advanced Lua Examples
+
+Now it is time to reveal the real power of the new API. Let us look again at
+two real levels. Investigate the levels first by playing and then join 
+in the line by line commentation of the source code to understand how to
+implement your own level ideas.
+
+ at menu
+* Color Maze::    Enigma levelpack VIII, level #19
+* Wired::           Enigma levelpack VIII, level #22
+ at end menu
+
+
+ at c ----------------- Color Maze -------------------- 
+ at node Color Maze
+ at subsection Color Maze
+
+Let us view the Lua source code part. We did add a line count in the first two
+columns for reference purpose within this section. These line count number are 
+not part of the source code itself!
+
+ at example
+01    @i{wo}["@b{ConserveLevel}"] = @var{false}
+02    @i{wo}["@b{FollowGrid}"] = @var{false}
+03    @i{wo}["@b{FollowMethod}"] = @var{FOLLOW_SCROLL}
+04    
+05    @i{ti}["@var{ }"] = @{"@b{fl-abyss_fake}"@} .. @i{ti}(@{"@b{st-glass1}"@})
+06    
+07    @i{ti}["@var{!}"] = @{"@b{fl-rough-blue}", "@var{blue#}", @var{_color}="@var{blue}"@}
+08    @i{ti}["@var{@@}"] = @{"@b{fl-bumps}", "@var{orange#}", @var{_color}="@var{orange}"@}
+09    @i{ti}["@var{#}"] = @{"@b{fl-rough-red}", "@var{red#}", @var{_color}="@var{red}"@}
+10    @i{ti}["@var{$}"] = @{"@b{fl-leavesb}", "@var{green#}", @var{_color}="@var{green}"@}
+11    
+12    @i{ti}["@var{b}"] = @i{ti}["@var{!}"] .. @{"@b{st-door-h-open}"@}
+13    @i{ti}["@var{B}"] = @i{ti}["@var{!}"] .. @{"@b{st-door-v-open}"@}
+14    @i{ti}["@var{o}"] = @i{ti}["@var{@@}"] .. @{"@b{st-door-h-open}"@}
+15    @i{ti}["@var{O}"] = @i{ti}["@var{@@}"] .. @{"@b{st-door-v-open}"@}
+16    @i{ti}["@var{r}"] = @i{ti}["@var{#}"] .. @{"@b{st-door-h-open}"@}
+17    @i{ti}["@var{R}"] = @i{ti}["@var{#}"] .. @{"@b{st-door-v-open}"@}
+18    @i{ti}["@var{g}"] = @i{ti}["@var{$}"] .. @{"@b{st-door-h-open}"@}
+19    @i{ti}["@var{G}"] = @i{ti}["@var{$}"] .. @{"@b{st-door-v-open}"@}
+20    
+21    @i{ti}["@var{d}"] = @{"@b{it-document}", @b{text}="@var{text1}"@}
+22    @i{ti}["@var{5}"] = @i{ti}["@var{b}"] .. @i{ti}["@var{d}"]
+23    @i{ti}["@var{6}"] = @i{ti}["@var{O}"] .. @i{ti}["@var{d}"]
+24    @i{ti}["@var{7}"] = @i{ti}["@var{r}"] .. @i{ti}["@var{d}"]
+25    @i{ti}["@var{8}"] = @i{ti}["@var{G}"] .. @i{ti}["@var{d}"]
+26    
+27    @i{ti}["@var{x}"] = @{"@b{it_sensor}", @b{invisible}=@var{true}, @b{target}="@var{gates}"@}
+28    @i{ti}["@var{*}"] = @i{ti}["@var{x}"] .. @{"#@b{ac-blackball}", "@var{me}"@}
+29    
+30    @i{ti}["@var{?}"] = @{"@b{st_oxyd_a}"@}
+31    
+32    @i{wo}(@i{ti}, "@var{ }", @{
+33    --      |         1    1   |2    2
+34    --      |1   5    0    5   |0    5
+35           "@var{                           }",
+36           "@var{ xO@@OxR#RxO@@OxB!BxR#RxB!Bx }", --01
+37           "@var{ b   r   g   g   b   g   r }", 
+38           "@var{ !   #   $   $   !   $   # }", 
+39           "@var{ b   r   g   g   b   g   r }", 
+40           "@var{ xR#RxB!BxO@@OxG$GxO@@OxO@@Ox }", --05
+41           "@var{ g   g   r   g   g   b   b }", 
+42           "@var{ $   $   #   $   $   !   ! }", 
+43           "@var{ g   g   r   g   g   b   b }", 
+44           "@var{ xR#RxO@@OxG$GxR#RxG$GxR#Rx }", 
+45           "@var{ g   b   b   o       b   r }", --10
+46           "@var{ $   !   !   @@       !   # }", 
+47           "@var{ g   b   5   o   ?   b   r }", --
+48           "@var{ xO@@OxO@@6*8$Gx   xG$GxR#Rx }", 
+49           "@var{ r   b   7   b   ?   o   o }", 
+50           "@var{ #   !   #   !       @@   @@ }", --15
+51           "@var{ r   b   r   b       o   o }", 
+52           "@var{ xG$GxB!BxR#RxO@@OxR#RxG$Gx }", 
+53           "@var{ g   o   o   g   g   o   b }", 
+54           "@var{ $   @@   @@   $   $   @@   ! }", 
+55           "@var{ g   o   o   g   g   o   b }", --20
+56           "@var{ xB!BxO@@OxR#RxR#RxO@@OxB!Bx }", 
+57           "@var{ o   r   g   g   b   b   g }", 
+58           "@var{ @@   #   $   $   !   !   $ }", 
+59           "@var{ o   r   g   g   b   b   g }", --
+60           "@var{ xR#RxB!BxB!BxR#RxO@@OxR#Rx }", --25
+61           "@var{                           }"@} -- 
+62    --      |         1    1   |2    2
+63    --      |1   5    0    5   |0    5
+64    )
+65    
+66    @var{last} = @b{it}(@i{no}["@var{me}"])   -- the last visited sensor
+67    @var{move} = @var{0}              -- the count of link moves
+68    @var{sequence} = @{@}         -- the sequence of the 4 colors that the user did choose
+69    
+70    function @var{gates}(@var{value}, @var{sender})
+71        if @var{last} ~= @var{sender} then
+72            local @var{middle} = @var{last} + (@var{sender} - @var{last})/@var{2}
+73            local @var{color} = @b{fl}(@var{middle})["@var{_color}"]
+74            if @var{color} == @var{nil} then return end  -- someone cheated, avoid throwing an exception
+75            @b{st}(@i{no}[@var{color}.."@var{#*}"]):@b{close}()
+76            @var{sequence}[@var{move}%@var{4}] = @var{color}
+77            if @var{move} >= @var{3} then
+78                @b{st}(@i{no}[@var{sequence}[(@var{move}+ at var{1})%@var{4}].."@var{#*}"]):@b{open}()
+79            end
+80            @var{move} = @var{move} + @var{1}
+81            @var{last} = @var{sender}
+82        end
+83    end
+ at end example
+
+Let us concentrate on new aspects not discussed in the previous 
+ at ref{Basic Lua Examples}.
+
+ at example
+01    @i{wo}["@b{ConserveLevel}"] = @var{false}
+02    @i{wo}["@b{FollowGrid}"] = @var{false}
+03    @i{wo}["@b{FollowMethod}"] = @var{FOLLOW_SCROLL}
+ at end example
+This level must forbid the user to resurrect a marble at the start position.
+At the same time the user should the area around the marble as complete as
+possible. Thus the scroll mode needs to be set, too. All this is done by
+setting special @ref{Global Attributes}.
+
+ at example
+05    @i{ti}["@var{ }"] = @{"@b{fl-abyss_fake}"@} .. @i{ti}(@{"@b{st-glass1}"@})
+32    @i{wo}(@i{ti}, "@var{ }", @{
+ at end example
+The unaccessible areas are filled with a transparent glass on top of a black
+floor as defined in line 5. The world initialization uses this tile definition
+as the default tile. This is o.k. as it contains a floor definition. Additional
+objects like the glass stone will never be set on default usage.
+
+ at example
+07    @i{ti}["@var{!}"] = @{"@b{fl-rough-blue}", "@var{blue#}", @var{_color}="@var{blue}"@}
+08    @i{ti}["@var{@@}"] = @{"@b{fl-bumps}", "@var{orange#}", @var{_color}="@var{orange}"@}
+09    @i{ti}["@var{#}"] = @{"@b{fl-rough-red}", "@var{red#}", @var{_color}="@var{red}"@}
+10    @i{ti}["@var{$}"] = @{"@b{fl-leavesb}", "@var{green#}", @var{_color}="@var{green}"@}
+ at end example
+Every floor object is autonamed for later group access purposes. Additinally
+every floor objects sets a user attribute prefixed in its name by an underscore
+ at samp{_}. This attribute stores a string that we need later on in the callback
+function.
+
+ at example
+12    @i{ti}["@var{b}"] = @i{ti}["@var{!}"] .. @{"@b{st-door-h-open}"@}
+13    @i{ti}["@var{B}"] = @i{ti}["@var{!}"] .. @{"@b{st-door-v-open}"@}
+ at end example
+The doors are set without being named, as we will target them by their position.
+
+ at example
+27    @i{ti}["@var{x}"] = @{"@b{it_sensor}", @b{invisible}=@var{true}, @b{target}="@var{gates}"@}
+ at end example
+The actors moves are detected by invisible @ref{it_sensor}s that are positioned
+on any intersection. The target is the @ref{Callback Function} @samp{gates}.
+The action can be ommited as the function name is a unique target.
+
+ at example
+66    @var{last} = @b{it}(@i{no}["@var{me}"])   -- the last visited sensor
+ at end example
+A Lua variable that stores the last sensor visited by the marble. This is
+initially the sensor beneath the start position of the marble. We do get the 
+marble by name, but do store the sensor item beneath it, that is an unnamed
+object.
+
+ at example
+67    @var{move} = @var{0}              -- the count of link moves
+68    @var{sequence} = @{@}         -- the sequence of the 4 colors that the user did choose
+ at end example
+These are the essential variables for our algorithm. The user is free in 
+selecting the sequence of the colored floors. We do initialize the sequence
+by an anonymous table that will be filled with the color names. An additional
+move counter will give us the current index into this table.
+
+ at example
+70    function @var{gates}(@var{value}, @var{sender})
+71        if @var{last} ~= @var{sender} then
+ at end example
+The callback function provides the sender, the @ref{it_sensor}, that caused
+the action. It is the current sensor. As the marble can return to the last
+sensor, we have to check that it is a new sensor before taking any actions.
+A simple object comparison suffices.
+
+ at example
+72            local @var{middle} = @var{last} + (@var{sender} - @var{last})/@var{2}
+73            local @var{color} = @b{fl}(@var{middle})["@var{_color}"]
+ at end example
+We need to know the color of the floor strip that the marble did pass. We do
+calculate the position of the middle of this floor strip by position calculation.
+We simply take the middle position between the last and the current intersection.
+Once we have the middle position we can get the floor object and retrieve the
+private user attribute with the color description.
+
+ at example
+74            if @var{color} == @var{nil} then return end  -- someone cheated, avoid throwing an exception
+ at end example
+In regular play we are guaranteed to get a color value. But just in case a
+gamer cheats he may have moved irregular without visiting neighboring sensors.
+Just avoid errors. The gamer can not score anyway.
+
+ at example
+75            @b{st}(@i{no}[@var{color}.."@var{#*}"]):@b{close}()
+ at end example
+Knowing the color we want to close all doors on same colored floor strips. We
+did autoname the floors by matching name prefixes. Thus we can retrieve all
+floors of a given color by concatenating the color string with the suffix 
+ at samp{#*} and requesting the named object repository. As we are interested in
+the doors we do request the stone above every floor. We provide a group of
+floors and get a group of stones. Not every floor has a door on top. That does
+not matter as only existing objects are added to the resulting stone group.
+Knowing the stones we just send them all a @samp{close} message.
+
+ at example
+76            @var{sequence}[@var{move}%@var{4}] = @var{color}
+ at end example
+We need to remember the sequence of colors. We just store the color name in
+the table at the index given by the move count modulo 4. Yes we could limit
+this statement to the first four moves. But who cares? The modulo operation
+is simpler than a conditional expression.
+
+ at example
+77            if @var{move} >= @var{3} then
+78                @b{st}(@i{no}[@var{sequence}[(@var{move}+ at var{1})%@var{4}].."@var{#*}"]):@b{open}()
+79            end
+ at end example
+On the first 3 moves we just do close doors and remember the color sequence.
+But starting with the 4th move we need to open the next color in sequence.
+We do retrieve the color string of the next color from the sequence table by
+a simple modulo calulation. Having the color name we do the same trick as in
+line 75. But this time we do send the @samp{open} messages to all affected doors.
+
+ at example
+80            @var{move} = @var{move} + @var{1}
+81            @var{last} = @var{sender}
+ at end example
+Finally we just have to increase the move count and to remember the current
+sender as the last visited sensor.
+
+That is all to code a quite complex dynamic level idea like "Color Maze".
+
+ at c ----------------- Wired -------------------- 
+ at node Wired
+ at subsection Wired
+You should have restarted this level several times to notice the design changes
+of the floor pattern and the border panel stones besides the dynamic wiring of
+the stones.
+
+Let us view the Lua source code part. We did add a line count in the first two
+columns for reference purpose within this section. These line count number are 
+not part of the source code itself!
+
+ at example
+01	  <el:compatibility el:enigma="1.10">
+02	    <el:dependency el:path="lib/libluatools" el:id="lib/libluatools" el:release="1" el:preload="true"/>
+03	  </el:compatibility>
+...
+04    @i{ti}["@var{ }"] = @{"@b{fl-sahara}", @b{friction} = @var{3.5}, @b{adhesion} = @var{4.0}@}
+05    @i{ti}["@var{a}"] = @{"@b{fl-light}", @b{friction} = @var{3.5}, @b{adhesion} = @var{4.0}@}
+06    @i{ti}["@var{b}"] = @{"@b{fl-white}", @b{friction} = @var{3.5}, @b{adhesion} = @var{4.0}@}
+07    @i{ti}["@var{c}"] = @{"@b{fl-lightgray}", @b{friction} = @var{3.5}, @b{adhesion} = @var{4.0}@}
+08    @i{ti}["@var{_}"] = @{"@b{fl-water}"@}
+09    @i{ti}["@var{@@}"] = @{"#@b{ac-blackball}"@}
+10    @i{ti}["@var{w}"] = @{"@b{st-plain_move}", "@var{wood}#"@}
+11    @i{ti}["@var{t}"] = @{"@b{it_trigger}", "@var{trigger}#"@}
+12    @i{ti}["@var{d}"] = @{"@b{st_blocker}", "@var{door}#"@}
+13    @i{ti}["@var{o}"] = @{"@b{st_oxyd}", @b{oxydcolor} = @var{OXYD_YELLOW}, @b{flavor} = "@var{a}"@}
+14    @i{ti}["@var{O}"] = @{"@b{st_oxyd}", @b{oxydcolor} = @var{OXYD_WHITE}, @b{flavor} = "@var{a}"@}
+15    @i{ti}["@var{1}"] = @{"@b{st_panel}", @b{cluster} = @var{1}@}
+16    @i{ti}["@var{2}"] = @{"@b{st_panel}", @b{cluster} = @var{2}@}
+17    @i{ti}["@var{S}"] = @{"@b{st_switch}", @b{target} = "@var{easy_mode_call}"@}
+18    
+19    @var{floors}  = @{@i{ti}["@var{ }"], @i{ti}["@var{a}"], @i{ti}["@var{b}"], @i{ti}["@var{c}"]@}
+20    @var{polynom} = @i{luatools}. at i{random_vector}(@var{10}, @var{4})
+21    
+22    function @var{myresolver}(@var{key}, @var{x}, @var{y})
+23      if @var{key} == "@var{ }" then 
+24	  return @var{floors}[@i{luatools}. at i{cubic_polynomial}(@var{polynom}, @var{x}, @var{y}) % (#@var{floors}) + @var{1}]
+25      elseif    (@var{key} == "@var{#}")
+26            or ((@var{key} == "@var{_}") and (@i{random}(@var{4}) == @var{1}))
+27            or ((@var{key} == "@var{S}") and @i{wo}["@b{IsDifficult}"]) then
+28        return @i{ti}["".. at i{random}(@var{2})]
+29      else
+30        return @i{ti}[@var{key}]
+31      end
+32    end
+33    
+34    @var{w}, @var{h} = @i{wo}(@var{myresolver}, "@var{ }", @{
+35     -- 01234567890123456789
+36       "@var{####################___________________}",
+37       "@var{#                  #_____###o###_______}",
+38       "@var{#   w   w t   t    #_____#d   d#_______}",
+39       "@var{#     w   w t   t  #___### ### ###_____}",
+40       "@var{#  w     t         #___#d d#_#d d#_____}",
+41       "@var{#                  ##### ###_### ###___}",
+42       "@var{S    w   w t @@ t        d#___#_#d d#___}",
+43       "@var{#                  #######_####### #___}",
+44       "@var{#  w     t         #_______O  d# # o___}",
+45       "@var{#     w   w t   t  #_______### ### #___}",
+46       "@var{#   w   w t   t    #_________#d   d#___}",
+47       "@var{#                  #_________###O###___}",
+48       "@var{####################___________________}"
+49    @})
+50    
+51    @var{door_p} = @i{luatools}. at i{permutation}(@var{12})
+52    @var{wire_p} = @i{luatools}. at i{permutation}(@var{12})
+53    @var{woods} = @i{no}["@var{wood}#*"]
+54    @var{triggers} = @i{no}["@var{trigger}#*"]
+55    @var{doors} = @i{no}["@var{door}#*"]
+56    
+57    for @var{j} = @var{1}, @var{12} do
+58      @var{triggers}[@var{j}]. at b{target} = @var{doors}[@var{door_p}[@var{j}]]
+59    end
+60    
+61    for @var{j} = @var{1}, @var{9} do
+62      @i{wo}:@b{add}(@{"@b{ot_wire}",
+63              @b{anchor1} = @var{woods}[@var{wire_p}[@var{j} + @var{3}]],
+64              @b{anchor2} = @var{woods}[@var{wire_p}[@var{j}%@var{3} + @var{1}]]@})
+65      @i{wo}:@b{add}(@{"@b{ot_wire}", @b{name} = "@var{obsolete_wire}#",
+66              @b{anchor1} = @var{woods}[@var{wire_p}[@var{j} + @var{3}]],
+67              @b{anchor2} = @var{woods}[@var{wire_p}[@var{j}%@var{9} + @var{4}]]@})
+68    end
+69    
+70    function @var{easy_mode_call}(@var{is_on}, @var{sender})
+71      if @var{is_on} then
+72        @i{no}["@var{obsolete_wire}#*"]:@b{kill}()
+73      else
+74        for @var{j} = @var{1}, @var{9} do
+75          @i{wo}:@b{add}(@{"@b{ot_wire}", @b{name} = "@var{obsolete_wire}#",
+76             	  @b{anchor1} = @var{woods}[@var{wire_p}[@var{j} + @var{3}]],
+77                @b{anchor2} = @var{woods}[@var{wire_p}[@var{j}%@var{9} + @var{4}]]@})
+78        end
+79      end
+80    end
+ at end example
+How is this versatility in design and action achieved as the last lines 69 to
+79 obviously deal just with the easy mode diffs? Let us analyse the lines
+that do the real work.
+
+ at example
+01	  <el:compatibility el:enigma="1.10">
+02	    <el:dependency el:path="lib/libluatools" el:id="lib/libluatools" el:release="1" el:preload="true"/>
+03	  </el:compatibility>
+ at end example
+We make use of some functions of the luatools library. Thus we need to preload it, 
+besides declaration of compatibility to Enigma 1.10.
+
+ at example
+04    @i{ti}["@var{ }"] = @{"@b{fl-sahara}", @b{friction} = @var{3.5}, @b{adhesion} = @var{4.0}@}
+05    @i{ti}["@var{a}"] = @{"@b{fl-light}", @b{friction} = @var{3.5}, @b{adhesion} = @var{4.0}@}
+06    @i{ti}["@var{b}"] = @{"@b{fl-white}", @b{friction} = @var{3.5}, @b{adhesion} = @var{4.0}@}
+07    @i{ti}["@var{c}"] = @{"@b{fl-lightgray}", @b{friction} = @var{3.5}, @b{adhesion} = @var{4.0}@}
+ at end example
+Four floor types that the dynamic floor is composed of. They all are unified
+in the @samp{friction} and @samp{adhesion} to provide smooth movement on the
+stylish floor.
+
+ at example
+10    @i{ti}["@var{w}"] = @{"@b{st-plain_move}", "@var{wood}#"@}
+11    @i{ti}["@var{t}"] = @{"@b{it_trigger}", "@var{trigger}#"@}
+12    @i{ti}["@var{d}"] = @{"@b{st_blocker}", "@var{door}#"@}
+ at end example
+The movable stone that will be wired, the target triggers and the doors to be
+opened. All are autonamed for group retrieval from the named object repository.
+
+ at example
+13    @i{ti}["@var{o}"] = @{"@b{st_oxyd}", @b{oxydcolor} = @var{OXYD_YELLOW}, @b{flavor} = "@var{a}"@}
+14    @i{ti}["@var{O}"] = @{"@b{st_oxyd}", @b{oxydcolor} = @var{OXYD_WHITE}, @b{flavor} = "@var{a}"@}
+ at end example
+A minor design aspect: selecting two unique colors for the @ref{st_oxyd}s.
+
+ at example
+15    @i{ti}["@var{1}"] = @{"@b{st_panel}", @b{cluster} = @var{1}@}
+16    @i{ti}["@var{2}"] = @{"@b{st_panel}", @b{cluster} = @var{2}@}
+ at end example
+The base of the prominent all time different looking @ref{st_panel} boarder 
+design. Two tiles with panel stones assigned to two different clusters. The
+engine will automatically join all neighboring stones of the same cluster to
+big unified blocks. Now we just need to assign these tiles to the different 
+grid positions.
+
+ at example
+17    @i{ti}["@var{S}"] = @{"@b{st_switch}", @b{target} = "@var{easy_mode_call}"@}
+ at end example
+The left boarder switch that will just be used in easy mode. It is blocked in
+line 27 to not appear in the regular mode. The target is the callback function
+of lines 71 to 81.
+
+ at example
+19    @var{floors}  = @{@i{ti}["@var{ }"], @i{ti}["@var{a}"], @i{ti}["@var{b}"], @i{ti}["@var{c}"]@}
+20    @var{polynom} = @i{luatools}. at i{random_vector}(@var{10}, @var{4})
+ at end example
+Preparations for the floor design. The four floor tiles are stored in a table
+for number based index access. Ten random numbers in the range 1 to 4 are
+stored in a table, which we will use as polynom coefficients later on.
+
+ at example
+22    function @var{myresolver}(@var{key}, @var{x}, @var{y})
+34    @var{w}, @var{h} = @i{wo}(@var{myresolver}, "@var{ }", @{
+ at end example
+Up to now we did look up the keys used in the map from our tiles repository
+ at samp{ti} that was the first argument of the world initialization call. But
+now we use a @ref{Custom Resolver} (@pxref{World Creation and Resolver Chaining}).
+The function starting in line 22 is called on every tile to be resolved. It has
+the task of delivering the appropriate tile.
+
+ at example
+23      if @var{key} == "@var{ }" then 
+24	  return @var{floors}[@i{luatools}. at i{cubic_polynomial}(@var{polynom}, @var{x}, @var{y}) % (#@var{floors}) + @var{1}]
+ at end example
+These two lines generate the always changing floor design. For every map key
+ at samp{ } we calculate the cubic polynomial that is randomized due to the
+coefficients. The resulting number is limited to the number of our four floors.
+This number is taken as the index into our @samp{floors} table and the resulting
+tile definition is returned.
+
+ at example
+25      elseif    (@var{key} == "@var{#}")
+26            or ((@var{key} == "@var{_}") and (@i{random}(@var{4}) == @var{1}))
+27            or ((@var{key} == "@var{S}") and @i{wo}["@b{IsDifficult}"]) then
+28        return @i{ti}["".. at i{random}(@var{2})]
+ at end example
+And now we cluster the boarder panels. First we need to decide where to put
+panels at all. The positions marked @samp{#} in the map are for sure. 
+Additionally we choose randomly every 4th @samp{_} postition to be a panel 
+instead of being a water floor. Finally we replace just in difficult mode
+the switch marked as @samp{S} by a panel stone. Now we need to assign to this
+grid position one of the two panel cluster tiles. We simply generate a random
+number out of 1 and 2. But we do need a string as the tiles key. We force Lua
+to convert the number to string by concatenating an empty string @samp{""} with
+the random number. Choosing the right panel variants to build up closed clusters
+is done by the enginge.
+
+ at example
+29      else
+30        return @i{ti}[@var{key}]
+ at end example
+Finally for all other keys that need no special treatment we just take the
+tile definition as stored in the tiles repository.
+
+ at example
+34    @var{w}, @var{h} = @i{wo}(@var{myresolver}, "@var{ }", @{
+35     -- 01234567890123456789
+36       "@var{####################___________________}",
+37       "@var{#                  #_____###o###_______}",
+38       "@var{#   w   w t   t    #_____#d   d#_______}",
+39       "@var{#     w   w t   t  #___### ### ###_____}",
+...
+ at end example
+The map uses the keys as interpreted by the custom resolver. Thus all mandatory
+panel stones are marked by @samp{#} and all may be water by @samp{_}. All spaces
+ at samp{ } do not stand for the sahara floor definition in the tiles repository,
+but are floor positions for our design floor set up in the custom resolver.
+Note that even the @samp{w} marked tiles will set a design floor, as the
+default floor is @samp{ }, too.
+
+ at example
+51    @var{door_p} = @i{luatools}. at i{permutation}(@var{12})
+52    @var{wire_p} = @i{luatools}. at i{permutation}(@var{12})
+ at end example
+Now let us shuffle the trigger/door assignment and the wire distribution. We
+do this by permutating 12 index numbers to be used for door and wire access.
+
+ at example
+53    @var{woods} = @i{no}["@var{wood}#*"]
+54    @var{triggers} = @i{no}["@var{trigger}#*"]
+55    @var{doors} = @i{no}["@var{door}#*"]
+ at end example
+Get the groups of movable stones, triggers and doors. It is essential to do this
+once and to store the resulting groups as we want to index the group members.
+Repeated access to the named object repository does not guarantee a stable
+sorting of the result groups. Thus we operate on the stable onece retrieved
+and stored groups. 
+
+ at example
+57    for @var{j} = @var{1}, @var{12} do
+58      @var{triggers}[@var{j}]. at b{target} = @var{doors}[@var{door_p}[@var{j}]]
+59    end
+ at end example
+A random assignment of the triggers to the doors. Every triggers gets a random
+indexed member of the door group as target. Note the alternative attribute
+member access on the trigger. Instead of embracing the attributes name in 
+square brackets and quoting the string constant as @samp{["target"]} the
+author did prefer to write @samp{.target}. That is a legal Lua alternative
+statement as long as the attribute's name is a legal Lua name (@pxref{Caveats}).
+
+ at example
+61    for @var{j} = @var{1}, @var{9} do
+62      @i{wo}:@b{add}(@{"@b{ot_wire}",
+63              @b{anchor1} = @var{woods}[@var{wire_p}[@var{j} + @var{3}]],
+64              @b{anchor2} = @var{woods}[@var{wire_p}[@var{j}%@var{3} + @var{1}]]@})
+ at end example
+Finally we need to add the @ref{ot_wire} between our movable stones. This can
+not be done within the map. We need to use the @ref{World Advanced Method} 
+ at samp{wo:add()}, which takes the two connected stones as two anchor attributes.
+We select the first 3 stones of our wood group as stones to be connected with
+3 other stones of the indices 4 to 12. Thus we take in every loop as the first
+anchor one of the stones 4 to 12 and connect it to one of the first 3 stones by
+a simple modulo operation. The first three stones now have three wires and are
+finished. The last 9 stones have just one wire.
+
+ at example
+65      @i{wo}:@b{add}(@{"@b{ot_wire}", @b{name} = "@var{obsolete_wire}#",
+66              @b{anchor1} = @var{woods}[@var{wire_p}[@var{j} + @var{3}]],
+67              @b{anchor2} = @var{woods}[@var{wire_p}[@var{j}%@var{9} + @var{4}]]@})
+68    end
+ at end example
+Now we wire these remaining 9 stones in sequence, in a closed circle. That gives
+each stone 2 additinal wires. We do this by connecting each of the stones 4 to
+11 with is successor and finally connecting stone 12 to stone 4, what is done
+by the modulo operation. This completes the level for the regular mode.
+As prepartion for the easy mode we do autoname these additional wires.
+
+ at example
+71    function @var{easy_mode_call}(@var{is_on}, @var{sender})
+72      if @var{is_on} then
+73        @i{no}["@var{obsolete_wire}#*"]:@b{kill}()
+ at end example
+Just for the easy mode we added a switch to remove and recreate the additional
+wires. As we named these obsolete wires we can simply kill all of them in a
+single call by applying the @samp{kill()} method to the group of these wires.
+
+ at example
+73      else
+74        for @var{j} = @var{1}, @var{9} do
+75          @i{wo}:@b{add}(@{"@b{ot_wire}", @b{name} = "@var{obsolete_wire}#",
+76             	  @b{anchor1} = @var{woods}[@var{wire_p}[@var{j} + @var{3}]],
+77                @b{anchor2} = @var{woods}[@var{wire_p}[@var{j}%@var{9} + @var{4}]]@})
+78        end
+79      end
+ at end example
+When the user switches off again, the wires should be recreated. That is done
+by the same code as lines 65 to 68. Note that is essential that we stored and
+kept the used wire permutation in the variable @samp{wire_p}.
+
+ at c ----------------- Position -------------------- 
+
+ at node Position
+ at section Position
+
+ at c ----------------- Object -------------------- 
+
+ at node Object
+ at section Object
+
+ at c ----------------- Group -------------------- 
+
+ at node Group
+ at section Group
+
+ at c ----------------- NamedObjects -------------------- 
+
+ at node NamedObjects
+ at section NamedObjects
+
+ at c ----------------- Tile -------------------- 
+
+ at node Tile
+ at section Tile
+
+ at c ----------------- Tiles -------------------- 
+
+ at node Tiles
+ at section Tiles
+
+ at c ----------------- World -------------------- 
+
+ at node World
+ at section World
+
 @c ----------------- World Creation and Resolver Chaining -------------------- 
 
 @node World Creation and Resolver Chaining



From raoul at mail.berlios.de  Sat Aug  2 20:20:12 2008
From: raoul at mail.berlios.de (raoul at BerliOS)
Date: Sat, 2 Aug 2008 20:20:12 +0200
Subject: [Enigma-game-svn] r1251 - trunk/doc/reference
Message-ID: <200808021820.m72IKCPF002418@sheep.berlios.de>

Author: raoul
Date: 2008-08-02 20:20:11 +0200 (Sat, 02 Aug 2008)
New Revision: 1251

Modified:
   trunk/doc/reference/enigma-ref.texi
Log:
-> Fixed refman for pdf generation


Modified: trunk/doc/reference/enigma-ref.texi
===================================================================
--- trunk/doc/reference/enigma-ref.texi	2008-08-02 13:26:41 UTC (rev 1250)
+++ trunk/doc/reference/enigma-ref.texi	2008-08-02 18:20:11 UTC (rev 1251)
@@ -3282,7 +3282,7 @@
 
 In the example we check if the @ref{st_switch} did just toggle to ON. If this
 is given we take the switch, which is the sender, as a position and set a new
-@{it_coin} to the grid east of it - a small bank automate that supplies money. 
+ at ref{it_coin} to the grid east of it - a small bank automate that supplies money. 
 
 The @ref{Advanced Lua Examples} will show examples of real powerful callback 
 functions with a line by line comment.
@@ -3576,7 +3576,7 @@
 24    @i{ti}["@var{L}"] = @{"@b{st_laser}", @b{orientation}=@var{EAST}, @b{state}=@var{ON}@}
 25    @i{ti}["@var{M}"] = @{"@b{st_lightpassenger}", @b{interval}=@var{0.04}@}
 26
-27    @i{ti}["@var{P}}"] = @{"@b{st_polarswitch}", @b{name}="@var{polar}"@}
+27    @i{ti}["@var{P}"] = @{"@b{st_polarswitch}", @b{name}="@var{polar}"@}
 28    @i{ti}["@var{T}"] = @{"@b{it_trigger}", @b{target}="@var{polar}"@}
 29
 30    @i{ti}["@var{^}"] = @{"@b{st_boulder}", "@var{boulder}", @b{orientation}=@var{NORTH}@}
@@ -3616,7 +3616,7 @@
 64        "@var{F    ~   B   ~+++++#}",
 65        "@var{# 1  ~   B   #+++++#}",
 66        "@var{S   v~V  B   D+++++#}",
-67        "@var{####################}"}
+67        "@var{####################}"@}
 68    @})
 69
 70    @i{wo}:@b{shuffleOxyd}()
@@ -3699,7 +3699,7 @@
 names are not quoted as they are followed by an equal @samp{=} sign.
 
 @example
-27    @i{ti}["@var{P}}"] = @{"@b{st_polarswitch}", @b{name}="@var{polar}"@}
+27    @i{ti}["@var{P}"] = @{"@b{st_polarswitch}", @b{name}="@var{polar}"@}
 28    @i{ti}["@var{T}"] = @{"@b{it_trigger}", @b{target}="@var{polar}"@}
 @end example
 
@@ -3771,7 +3771,7 @@
 Another object group is an @ref{st_turnstile} cluster with one arm disconnected.
 The first two definitions are straight forward. But in line 42 we preceed the
 arm's definition by another tile reference. It is the abyss tile defined in 
-line 19. By concatenation, the two dots @{..}, of a tile and a object
+line 19. By concatenation, the two dots @b{..}, of a tile and a object
 definition we can define a new that is composed of both objects. In this case
 we define a turnstile arm on top of an abyss floor.
 
@@ -3833,7 +3833,7 @@
 64        "@var{F    ~   B   ~+++++#}",
 65        "@var{# 1  ~   B   #+++++#}",
 66        "@var{S   v~V  B   D+++++#}",
-67        "@var{####################}"}
+67        "@var{####################}"@}
 68    @})
 @end example
 
@@ -4237,12 +4237,14 @@
 
 @table @asis
 @item @b{Creating Groups:}
+
 @example
 @var{group} = @i{no}["@b{Atrax}#*"]           -- a group of all matching objects
 			        --   wildcards "*","?" allowed
 @var{group} = @i{grp}(@var{obj1}, @var{obj2}, @var{obj3})
- at var{group} = @i{grp}({@var{obj1}, @var{obj2}, @var{obj3}@})  -- a group of objects set up in a table
+ at var{group} = @i{grp}(@{@var{obj1}, @var{obj2}, @var{obj3}@})  -- a group of objects set up in a table
 @end example
+
 Requesting objects from the named object repository will result in a group of
 objects if you make proper usage of wildcards. Appending an asterix @samp{*}
 to the autonaming hash will retrieve all objects that have been set with this



From ral at mail.berlios.de  Sat Aug  2 21:14:49 2008
From: ral at mail.berlios.de (ral at mail.berlios.de)
Date: Sat, 2 Aug 2008 21:14:49 +0200
Subject: [Enigma-game-svn] r1252 - team_levelpacks/team_test_new_api
Message-ID: <200808021914.m72JEnfl009998@sheep.berlios.de>

Author: ral
Date: 2008-08-02 21:14:42 +0200 (Sat, 02 Aug 2008)
New Revision: 1252

Added:
   team_levelpacks/team_test_new_api/ralD006_1.xml
Modified:
   team_levelpacks/team_test_new_api/raoulT05_1.xml
Log:
Test Level new API:
- refman basic demo level added
- stip testlevel extended


Added: team_levelpacks/team_test_new_api/ralD006_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/ralD006_1.xml	2008-08-02 18:20:11 UTC (rev 1251)
+++ team_levelpacks/team_test_new_api/ralD006_1.xml	2008-08-02 19:14:42 UTC (rev 1252)
@@ -0,0 +1,80 @@
+<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
+<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
+  <el:protected>
+    <el:info el:type="level">
+      <el:identity el:title="Basic Level" el:subtitle="" el:id="20080721ral513"/>
+      <el:version el:score="1" el:release="1" el:revision="$Revision$" el:status="experimental"/>
+      <el:author  el:name="Ronald Lamprecht" el:email="ral at users.berlios.de"/>
+      <el:copyright>Copyright ? 2008 Ronald Lamprecht</el:copyright>
+      <el:license el:type="GPL v2.0 or above" el:open="true"/>
+      <el:compatibility el:enigma="1.10"/>
+      <el:modes el:easy="true" el:single="true" el:network="false"/>
+      <el:score el:easy="-" el:difficult="-"/>
+    </el:info>
+    <el:luamain><![CDATA[
+
+wo["ConserveLevel"] = true
+
+ti[" "] = {"fl-samba"}
+ti["."] = {"fl-abyss"}
+ti["~"] = {"fl-water"}
+ti["#"] = {"st-rock1"}
+ti["X"] = {"st_oxyd"}
+
+ti["L"] = {"st_laser", orientation=EAST, state=ON}
+ti["M"] = {"st_lightpassenger", interval=0.04}
+
+ti["P"] = {"st_polarswitch", name="polar"}
+ti["T"] = {"it_trigger", target="polar"}
+
+ti["^"] = {"st_boulder", "boulder", orientation=NORTH}
+ti["F"] = {"st_fourswitch", target="boulder", action="orientate"}
+
+ti["D"] = {"st-door-v", "door"}
+ti["B"] = {"it_blocker", "wall#"}
+ti["S"] = {"st_switch", target={"door", "wall#*"}}
+
+ti["v"] = {"it_vortex", "left", destination="right"}
+ti["V"] = {"it_vortex", "right", destination="left"}
+
+ti["O"] = {"st_turnstile", flavor="red"}
+ti["E"] = {"st_turnstilearm", orientation=EAST}
+ti["N"] = ti["."] .. {"st_turnstilearm_n"}
+
+ti["+"] = {"fl-samba", checkerboard=0} .. ti({"fl-wood", checkerboard=1})
+
+ti["1"] = {"#ac-blackball"}
+
+if wo["IsDifficult"] then
+    ti["="] = ti["~"]
+else
+    ti["="] = ti["~"] .. {"it_strip_ew"}
+end
+
+w, h = wo(ti, " ", {
+    "####################",
+    "#      ....++++++~ #",
+    "L   PM ..N.++~~~~OE#",
+    "#######  T~++++++. #",
+    "#     ^   ~++++++# #",
+    "#         =++++++X X",
+    "#         ~++++++# #",
+    "#~~~~~~~~~~~~~+++X X",
+    "#    ~   B   ~+++###",
+    "F    ~   B   ~+++++#",
+    "# 1  ~   B   #+++++#",
+    "S   v~V  B   D+++++#",
+    "####################"
+})
+
+wo:shuffleOxyd()
+
+ ]]></el:luamain>
+    <el:i18n>
+      <el:string el:key="title">
+        <el:english el:translate="false"/>
+      </el:string>
+    </el:i18n>
+  </el:protected>
+</el:level>
+


Property changes on: team_levelpacks/team_test_new_api/ralD006_1.xml
___________________________________________________________________
Name: svn:keywords
   + Revision
Name: svn:eol-style
   + native

Modified: team_levelpacks/team_test_new_api/raoulT05_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/raoulT05_1.xml	2008-08-02 18:20:11 UTC (rev 1251)
+++ team_levelpacks/team_test_new_api/raoulT05_1.xml	2008-08-02 19:14:42 UTC (rev 1252)
@@ -16,6 +16,7 @@
     </el:info>
     <el:luamain><![CDATA[
 ti[" "] = {"fl-swamp"}
+ti["."] = {"fl-abyss"}
 
 ti["a"] = {"it_strip"}
 
@@ -38,6 +39,12 @@
 
 ti["q"] = {"it_strip_nesw"}
 
+ti["B"] = ti["."] .. {"it_strip_w"}
+ti["C"] = ti["."] .. {"it_strip_s"}
+ti["D"] = ti["."] .. {"it_strip_e"}
+ti["E"] = ti["."] .. {"it_strip_n"}
+
+
 ti["w"] = {"st-wood"}
 ti["v"] = {"st-plain_move"}
 
@@ -56,7 +63,20 @@
 "jhmf whmfw vhmfv   j",
 "jpqn wpqnw vpqnv   j",
 "jkoi wkoiw vkoiv   j",
-"kggggwwwwwgvvvvvgggi"
+"kggggwwwwwgvvvvvgggi",
+"                    ",
+"     w w w w w      ",
+"     C C C C C      ",
+" wDqqqqqqqqqqqqqBw  ",
+"   qqqqqqqqqqqqq    ",
+" wDqqqqqqqqqqqqqBw  ",
+"   qqqqqqqqqqqqq    ",
+" wDqqqqqqqqqqqqqBw  ",
+"   qqqqqqqqqqqqq    ",
+" wDqqqqqqqqqqqqqBw  ",
+"     E E E E E     ",
+"     w w w w w      ",
+"                    "
 })
   ]]></el:luamain>
     <el:i18n>



From ral at mail.berlios.de  Sat Aug  2 21:45:56 2008
From: ral at mail.berlios.de (ral at mail.berlios.de)
Date: Sat, 2 Aug 2008 21:45:56 +0200
Subject: [Enigma-game-svn] r1253 - homepage/input
Message-ID: <200808021945.m72JjuMk013782@sheep.berlios.de>

Author: ral
Date: 2008-08-02 21:45:47 +0200 (Sat, 02 Aug 2008)
New Revision: 1253

Modified:
   homepage/input/stat-other.html
   homepage/input/table-hcp.html
   homepage/input/table-rat.html
   homepage/input/table-solved.html
   homepage/input/table-wr.html
   homepage/input/userlist.html
Log:
Homepage:
- statistics July 2008


Modified: homepage/input/stat-other.html
===================================================================
--- homepage/input/stat-other.html	2008-08-02 19:14:42 UTC (rev 1252)
+++ homepage/input/stat-other.html	2008-08-02 19:45:47 UTC (rev 1253)
@@ -1,22 +1,22 @@
   <div class="stat-help">
     <h3>$$Other_Statistics$$</h3>
     <h4>$$Scores$$</h4>
-      79887 $$single_level_scores$$.
+      81371 $$single_level_scores$$.
     <h4>$$Ratings$$</h4>
-      14698 $$single_level_ratings$$ 4.91 $$and_distribution$$: 
+      14852 $$single_level_ratings$$ 4.92 $$and_distribution$$: 
       <table>
         <colgroup><col width="80"><col width="80"></colgroup>
         <tr><th>$$rating$$</th><th>$$count$$</th></tr>
-        <tr><td class="num">0</td><td class="num">96</td></tr>
-        <tr><td class="num">1</td><td class="num">283</td></tr>
-        <tr><td class="num">2</td><td class="num">785</td></tr>
-        <tr><td class="num">3</td><td class="num">2069</td></tr>
-        <tr><td class="num">4</td><td class="num">2767</td></tr>
-        <tr><td class="num">5</td><td class="num">3488</td></tr>
-        <tr><td class="num">6</td><td class="num">2442</td></tr>
-        <tr><td class="num">7</td><td class="num">1691</td></tr>
-        <tr><td class="num">8</td><td class="num">669</td></tr>
-        <tr><td class="num">9</td><td class="num">270</td></tr>
-        <tr><td class="num">10</td><td class="num">138</td></tr>
+        <tr><td class="num">0</td><td class="num">99</td></tr>
+        <tr><td class="num">1</td><td class="num">286</td></tr>
+        <tr><td class="num">2</td><td class="num">799</td></tr>
+        <tr><td class="num">3</td><td class="num">2077</td></tr>
+        <tr><td class="num">4</td><td class="num">2786</td></tr>
+        <tr><td class="num">5</td><td class="num">3513</td></tr>
+        <tr><td class="num">6</td><td class="num">2468</td></tr>
+        <tr><td class="num">7</td><td class="num">1714</td></tr>
+        <tr><td class="num">8</td><td class="num">687</td></tr>
+        <tr><td class="num">9</td><td class="num">278</td></tr>
+        <tr><td class="num">10</td><td class="num">145</td></tr>
       </table>
   </div>

Modified: homepage/input/table-hcp.html
===================================================================
--- homepage/input/table-hcp.html	2008-08-02 19:14:42 UTC (rev 1252)
+++ homepage/input/table-hcp.html	2008-08-02 19:45:47 UTC (rev 1253)
@@ -1,112 +1,115 @@
   <table>
-    <caption>$$Handicap_Statistics$$ $$June$$ 2008</caption>
+    <caption>$$Handicap_Statistics$$ $$July$$ 2008</caption>
     <colgroup><col width="130"><col width="220"></colgroup>
     <tr><th>$$solved_hcp$$</th><th class="left">$$user$$</th></tr>
-     <tr><td class="num">-143.7</td><td class="left">'Moneymaker'</td></tr>
-     <tr><td class="num"> -81.6</td><td class="left">'Johannes'</td></tr>
-     <tr><td class="num"> -81.5</td><td class="left">'Stupid'</td></tr>
-     <tr><td class="num"> -77.3</td><td class="left">'daydreamer'</td></tr>
-     <tr><td class="num"> -70.1</td><td class="left">'Great Scott'</td></tr>
-     <tr><td class="num"> -60.0</td><td class="left">'Duffy'</td></tr>
-     <tr><td class="num"> -58.5</td><td class="left">'Malla'</td></tr>
-     <tr><td class="num"> -55.6</td><td class="left">'ryujun'</td></tr>
-     <tr><td class="num"> -54.1</td><td class="left">'dev0'</td></tr>
-     <tr><td class="num"> -48.0</td><td class="left">'Django'</td></tr>
-     <tr><td class="num"> -47.1</td><td class="left">'Alexandros'</td></tr>
-     <tr><td class="num"> -42.6</td><td class="left">'Gloop'</td></tr>
-     <tr><td class="num"> -39.3</td><td class="left">'Taztunes'</td></tr>
-     <tr><td class="num"> -36.3</td><td class="left">'Safalra'</td></tr>
-     <tr><td class="num"> -31.6</td><td class="left">'Ludmian'</td></tr>
-     <tr><td class="num"> -30.8</td><td class="left">'B-Huff'</td></tr>
-     <tr><td class="num"> -30.6</td><td class="left">'Emmanuel'</td></tr>
-     <tr><td class="num"> -28.2</td><td class="left">'Zekobah'</td></tr>
-     <tr><td class="num"> -26.3</td><td class="left">'bojster'</td></tr>
-     <tr><td class="num"> -23.9</td><td class="left">'ged'</td></tr>
-     <tr><td class="num"> -22.1</td><td class="left">'hendrik'</td></tr>
-     <tr><td class="num"> -20.8</td><td class="left">'ABS'</td></tr>
-     <tr><td class="num"> -20.7</td><td class="left">'dpl'</td></tr>
-     <tr><td class="num"> -18.8</td><td class="left">'Raoul'</td></tr>
-     <tr><td class="num"> -15.5</td><td class="left">'Ronald'</td></tr>
-     <tr><td class="num"> -15.0</td><td class="left">'Ghatotkacha'</td></tr>
-     <tr><td class="num"> -11.7</td><td class="left">'Lukas'</td></tr>
-     <tr><td class="num"> -11.6</td><td class="left">'Daisy'</td></tr>
-     <tr><td class="num"> -10.9</td><td class="left">'HuB34'</td></tr>
-     <tr><td class="num">  -7.6</td><td class="left">'joseba'</td></tr>
-     <tr><td class="num">  -7.4</td><td class="left">'Iceshark7'</td></tr>
-     <tr><td class="num">  -3.6</td><td class="left">'Daniel'</td></tr>
-     <tr><td class="num">  -2.3</td><td class="left">'fabian'</td></tr>
-     <tr><td class="num">  -2.0</td><td class="left">'Hairball'</td></tr>
-     <tr><td class="num">  -0.9</td><td class="left">'Craven'</td></tr>
-     <tr><td class="num">  -0.6</td><td class="left">'JuSt'</td></tr>
-     <tr><td class="num">  -0.5</td><td class="left">'Wuzzy'</td></tr>
-     <tr><td class="num">   0.0</td><td class="left">'Freshman'</td></tr>
-     <tr><td class="num">   0.8</td><td class="left">'mrduke'</td></tr>
-     <tr><td class="num">   2.0</td><td class="left">'para_doks'</td></tr>
-     <tr><td class="num">   2.2</td><td class="left">'Tobias'</td></tr>
-     <tr><td class="num">   2.7</td><td class="left">'U-Punkt'</td></tr>
-     <tr><td class="num">   3.2</td><td class="left">'Guglielmo'</td></tr>
+     <tr><td class="num">-144.9</td><td class="left">'Moneymaker'</td></tr>
+     <tr><td class="num"> -81.1</td><td class="left">'Johannes'</td></tr>
+     <tr><td class="num"> -81.0</td><td class="left">'Stupid'</td></tr>
+     <tr><td class="num"> -77.5</td><td class="left">'daydreamer'</td></tr>
+     <tr><td class="num"> -69.8</td><td class="left">'Great Scott'</td></tr>
+     <tr><td class="num"> -59.6</td><td class="left">'Duffy'</td></tr>
+     <tr><td class="num"> -58.2</td><td class="left">'Malla'</td></tr>
+     <tr><td class="num"> -56.1</td><td class="left">'dev0'</td></tr>
+     <tr><td class="num"> -55.1</td><td class="left">'ryujun'</td></tr>
+     <tr><td class="num"> -50.5</td><td class="left">'Alexandros'</td></tr>
+     <tr><td class="num"> -47.7</td><td class="left">'Django'</td></tr>
+     <tr><td class="num"> -42.2</td><td class="left">'Gloop'</td></tr>
+     <tr><td class="num"> -38.9</td><td class="left">'Taztunes'</td></tr>
+     <tr><td class="num"> -35.8</td><td class="left">'Safalra'</td></tr>
+     <tr><td class="num"> -35.7</td><td class="left">'Emmanuel'</td></tr>
+     <tr><td class="num"> -31.8</td><td class="left">'Ludmian'</td></tr>
+     <tr><td class="num"> -30.5</td><td class="left">'B-Huff'</td></tr>
+     <tr><td class="num"> -27.8</td><td class="left">'Zekobah'</td></tr>
+     <tr><td class="num"> -26.0</td><td class="left">'bojster'</td></tr>
+     <tr><td class="num"> -23.7</td><td class="left">'ged'</td></tr>
+     <tr><td class="num"> -21.9</td><td class="left">'hendrik'</td></tr>
+     <tr><td class="num"> -20.5</td><td class="left">'dpl'</td></tr>
+     <tr><td class="num"> -20.5</td><td class="left">'ABS'</td></tr>
+     <tr><td class="num"> -18.4</td><td class="left">'Raoul'</td></tr>
+     <tr><td class="num"> -16.3</td><td class="left">'Daisy'</td></tr>
+     <tr><td class="num"> -15.0</td><td class="left">'Ronald'</td></tr>
+     <tr><td class="num"> -14.8</td><td class="left">'Ghatotkacha'</td></tr>
+     <tr><td class="num"> -11.4</td><td class="left">'Lukas'</td></tr>
+     <tr><td class="num"> -10.5</td><td class="left">'HuB34'</td></tr>
+     <tr><td class="num">  -7.7</td><td class="left">'joseba'</td></tr>
+     <tr><td class="num">  -7.3</td><td class="left">'Iceshark7'</td></tr>
+     <tr><td class="num">  -3.4</td><td class="left">'Daniel'</td></tr>
+     <tr><td class="num">  -2.1</td><td class="left">'fabian'</td></tr>
+     <tr><td class="num">  -1.7</td><td class="left">'Hairball'</td></tr>
+     <tr><td class="num">  -0.6</td><td class="left">'Craven'</td></tr>
+     <tr><td class="num">  -0.4</td><td class="left">'Wuzzy'</td></tr>
+     <tr><td class="num">  -0.4</td><td class="left">'JuSt'</td></tr>
+     <tr><td class="num">   0.0</td><td class="left">'U-Punkt'</td></tr>
+     <tr><td class="num">   0.3</td><td class="left">'Freshman'</td></tr>
+     <tr><td class="num">   1.0</td><td class="left">'mrduke'</td></tr>
+     <tr><td class="num">   2.1</td><td class="left">'para_doks'</td></tr>
+     <tr><td class="num">   2.4</td><td class="left">'Tobias'</td></tr>
+     <tr><td class="num">   3.5</td><td class="left">'Guglielmo'</td></tr>
      <tr><td class="num">   3.7</td><td class="left">'Kevin'</td></tr>
-     <tr><td class="num">   4.5</td><td class="left">'Andy'</td></tr>
-     <tr><td class="num">   4.6</td><td class="left">'serpent'</td></tr>
-     <tr><td class="num">   7.0</td><td class="left">'Austin'</td></tr>
-     <tr><td class="num">   8.6</td><td class="left">'shoki'</td></tr>
-     <tr><td class="num">  10.1</td><td class="left">'Tiza'</td></tr>
-     <tr><td class="num">  11.2</td><td class="left">'ShadowPhrogg32642342'</td></tr>
-     <tr><td class="num">  12.8</td><td class="left">'Andreas'</td></tr>
+     <tr><td class="num">   4.7</td><td class="left">'serpent'</td></tr>
+     <tr><td class="num">   4.8</td><td class="left">'Andy'</td></tr>
+     <tr><td class="num">   7.3</td><td class="left">'Austin'</td></tr>
+     <tr><td class="num">   8.7</td><td class="left">'shoki'</td></tr>
+     <tr><td class="num">  10.2</td><td class="left">'Tiza'</td></tr>
+     <tr><td class="num">  11.4</td><td class="left">'ShadowPhrogg32642342'</td></tr>
+     <tr><td class="num">  13.1</td><td class="left">'Andreas'</td></tr>
      <tr><td class="num">  13.6</td><td class="left">'alfred69'</td></tr>
      <tr><td class="num">  14.0</td><td class="left">'Chocolate Zero'</td></tr>
-     <tr><td class="num">  14.2</td><td class="left">'Mark P.'</td></tr>
-     <tr><td class="num">  14.6</td><td class="left">'AlephD'</td></tr>
-     <tr><td class="num">  14.8</td><td class="left">'Sim_Ed'</td></tr>
-     <tr><td class="num">  15.0</td><td class="left">'Agnieszka'</td></tr>
-     <tr><td class="num">  19.5</td><td class="left">'Alex'</td></tr>
-     <tr><td class="num">  21.5</td><td class="left">'Antonio EE'</td></tr>
+     <tr><td class="num">  14.4</td><td class="left">'Mark P.'</td></tr>
+     <tr><td class="num">  14.7</td><td class="left">'AlephD'</td></tr>
+     <tr><td class="num">  14.9</td><td class="left">'Sim_Ed'</td></tr>
+     <tr><td class="num">  15.2</td><td class="left">'Agnieszka'</td></tr>
+     <tr><td class="num">  15.6</td><td class="left">'Angolino'</td></tr>
+     <tr><td class="num">  19.7</td><td class="left">'Alex'</td></tr>
+     <tr><td class="num">  21.6</td><td class="left">'Antonio EE'</td></tr>
      <tr><td class="num">  22.4</td><td class="left">'Klaus'</td></tr>
-     <tr><td class="num">  22.6</td><td class="left">'Marc-Hendrik'</td></tr>
-     <tr><td class="num">  22.9</td><td class="left">'Chris'</td></tr>
-     <tr><td class="num">  23.3</td><td class="left">'Angolino'</td></tr>
-     <tr><td class="num">  23.7</td><td class="left">'Thomas'</td></tr>
-     <tr><td class="num">  24.0</td><td class="left">'Bent'</td></tr>
-     <tr><td class="num">  24.5</td><td class="left">'hdwow'</td></tr>
+     <tr><td class="num">  22.7</td><td class="left">'Marc-Hendrik'</td></tr>
+     <tr><td class="num">  23.0</td><td class="left">'Chris'</td></tr>
+     <tr><td class="num">  23.9</td><td class="left">'Thomas'</td></tr>
+     <tr><td class="num">  24.2</td><td class="left">'Feynman'</td></tr>
+     <tr><td class="num">  24.4</td><td class="left">'Bent'</td></tr>
+     <tr><td class="num">  24.6</td><td class="left">'hdwow'</td></tr>
      <tr><td class="num">  25.1</td><td class="left">'Gottseinsohn'</td></tr>
-     <tr><td class="num">  25.7</td><td class="left">'Hans-HD'</td></tr>
-     <tr><td class="num">  26.1</td><td class="left">'Ale'</td></tr>
-     <tr><td class="num">  27.3</td><td class="left">'Little_Mole'</td></tr>
+     <tr><td class="num">  25.8</td><td class="left">'Ale'</td></tr>
+     <tr><td class="num">  25.8</td><td class="left">'Hans-HD'</td></tr>
+     <tr><td class="num">  26.9</td><td class="left">'un_guru'</td></tr>
+     <tr><td class="num">  27.4</td><td class="left">'Little_Mole'</td></tr>
      <tr><td class="num">  27.5</td><td class="left">'J3FF'</td></tr>
-     <tr><td class="num">  28.7</td><td class="left">'biotopa'</td></tr>
-     <tr><td class="num">  29.3</td><td class="left">'oblo'</td></tr>
-     <tr><td class="num">  29.6</td><td class="left">'redsantz'</td></tr>
+     <tr><td class="num">  28.5</td><td class="left">'GiannuzzITA'</td></tr>
+     <tr><td class="num">  28.8</td><td class="left">'biotopa'</td></tr>
+     <tr><td class="num">  29.4</td><td class="left">'oblo'</td></tr>
+     <tr><td class="num">  29.7</td><td class="left">'redsantz'</td></tr>
      <tr><td class="num">  30.0</td><td class="left">'geembo_90'</td></tr>
-     <tr><td class="num">  30.8</td><td class="left">'Edgar_Flesk'</td></tr>
-     <tr><td class="num">  31.1</td><td class="left">'Melanie'</td></tr>
-     <tr><td class="num">  31.4</td><td class="left">'IChrisI'</td></tr>
+     <tr><td class="num">  30.9</td><td class="left">'Edgar_Flesk'</td></tr>
+     <tr><td class="num">  31.2</td><td class="left">'Melanie'</td></tr>
+     <tr><td class="num">  31.5</td><td class="left">'IChrisI'</td></tr>
      <tr><td class="num">  31.6</td><td class="left">'Vinksu'</td></tr>
-     <tr><td class="num">  31.8</td><td class="left">'erich'</td></tr>
      <tr><td class="num">  31.8</td><td class="left">'NorthForty'</td></tr>
-     <tr><td class="num">  31.9</td><td class="left">'Gorn'</td></tr>
-     <tr><td class="num">  32.2</td><td class="left">'Davacardo'</td></tr>
-     <tr><td class="num">  34.8</td><td class="left">'niebie'</td></tr>
-     <tr><td class="num">  34.9</td><td class="left">'MicWa'</td></tr>
-     <tr><td class="num">  35.0</td><td class="left">'WP319'</td></tr>
-     <tr><td class="num">  35.4</td><td class="left">'Kosby'</td></tr>
-     <tr><td class="num">  37.1</td><td class="left">'Rugby4ever'</td></tr>
-     <tr><td class="num">  38.2</td><td class="left">'mecke'</td></tr>
-     <tr><td class="num">  38.4</td><td class="left">'WesleyCrusher'</td></tr>
+     <tr><td class="num">  32.1</td><td class="left">'erich'</td></tr>
+     <tr><td class="num">  32.1</td><td class="left">'Gorn'</td></tr>
+     <tr><td class="num">  32.3</td><td class="left">'Davacardo'</td></tr>
+     <tr><td class="num">  34.9</td><td class="left">'niebie'</td></tr>
+     <tr><td class="num">  35.0</td><td class="left">'MicWa'</td></tr>
+     <tr><td class="num">  35.1</td><td class="left">'WP319'</td></tr>
+     <tr><td class="num">  35.6</td><td class="left">'Kosby'</td></tr>
+     <tr><td class="num">  37.2</td><td class="left">'Rugby4ever'</td></tr>
+     <tr><td class="num">  37.2</td><td class="left">'mecke'</td></tr>
+     <tr><td class="num">  38.5</td><td class="left">'WesleyCrusher'</td></tr>
      <tr><td class="num">  38.6</td><td class="left">'Drotten'</td></tr>
-     <tr><td class="num">  38.9</td><td class="left">'Archcorenth'</td></tr>
+     <tr><td class="num">  39.0</td><td class="left">'Archcorenth'</td></tr>
      <tr><td class="num">  39.2</td><td class="left">'Harry Lim'</td></tr>
-     <tr><td class="num">  39.4</td><td class="left">'B-man'</td></tr>
-     <tr><td class="num">  39.7</td><td class="left">'Nfol'</td></tr>
+     <tr><td class="num">  39.5</td><td class="left">'B-man'</td></tr>
+     <tr><td class="num">  39.8</td><td class="left">'Nfol'</td></tr>
      <tr><td class="num">  40.8</td><td class="left">'Tiger'</td></tr>
-     <tr><td class="num">  41.0</td><td class="left">'gringer'</td></tr>
-     <tr><td class="num">  41.4</td><td class="left">'Vlad'</td></tr>
+     <tr><td class="num">  41.2</td><td class="left">'gringer'</td></tr>
      <tr><td class="num">  41.4</td><td class="left">'Snaily'</td></tr>
+     <tr><td class="num">  41.6</td><td class="left">'Vlad'</td></tr>
      <tr><td class="num">  42.7</td><td class="left">'Momcat'</td></tr>
      <tr><td class="num">  42.8</td><td class="left">'Liam Sheehan'</td></tr>
-     <tr><td class="num">  43.2</td><td class="left">'Breezy'</td></tr>
      <tr><td class="num">  43.4</td><td class="left">'Uli'</td></tr>
+     <tr><td class="num">  43.4</td><td class="left">'Breezy'</td></tr>
      <tr><td class="num">  45.1</td><td class="left">'Tarim'</td></tr>
-     <tr><td class="num">  45.7</td><td class="left">'IntKecsk'</td></tr>
+     <tr><td class="num">  45.8</td><td class="left">'IntKecsk'</td></tr>
      <tr><td class="num">  46.0</td><td class="left">'tjRaven'</td></tr>
      <tr><td class="num">  47.1</td><td class="left">'ntaeijr'</td></tr>
      <tr><td class="num">  47.2</td><td class="left">'mhatta'</td></tr>
@@ -114,42 +117,43 @@
      <tr><td class="num">  49.3</td><td class="left">'Valkyrie2'</td></tr>
      <tr><td class="num">  49.4</td><td class="left">'rima'</td></tr>
      <tr><td class="num">  49.7</td><td class="left">'Sandra'</td></tr>
+     <tr><td class="num">  50.3</td><td class="left">'ReasonAnce'</td></tr>
      <tr><td class="num">  50.7</td><td class="left">'jdcampo'</td></tr>
      <tr><td class="num">  51.1</td><td class="left">'Jeffrey S'</td></tr>
-     <tr><td class="num">  51.4</td><td class="left">'brynn'</td></tr>
+     <tr><td class="num">  51.5</td><td class="left">'brynn'</td></tr>
      <tr><td class="num">  51.5</td><td class="left">'AkRa'</td></tr>
-     <tr><td class="num">  51.8</td><td class="left">'Slav'</td></tr>
+     <tr><td class="num">  51.9</td><td class="left">'Slav'</td></tr>
      <tr><td class="num">  52.0</td><td class="left">'Vaily'</td></tr>
-     <tr><td class="num">  53.1</td><td class="left">'Turbogurk'</td></tr>
-     <tr><td class="num">  53.2</td><td class="left">'Neophilus'</td></tr>
-     <tr><td class="num">  53.2</td><td class="left">'Cyphase'</td></tr>
-     <tr><td class="num">  55.5</td><td class="left">'krazy62'</td></tr>
+     <tr><td class="num">  52.2</td><td class="left">'Pascal'</td></tr>
+     <tr><td class="num">  53.2</td><td class="left">'Turbogurk'</td></tr>
+     <tr><td class="num">  53.3</td><td class="left">'Neophilus'</td></tr>
+     <tr><td class="num">  53.3</td><td class="left">'Cyphase'</td></tr>
+     <tr><td class="num">  55.6</td><td class="left">'krazy62'</td></tr>
      <tr><td class="num">  56.4</td><td class="left">'Adonica'</td></tr>
-     <tr><td class="num">  56.7</td><td class="left">'Kadu'</td></tr>
+     <tr><td class="num">  56.8</td><td class="left">'Kadu'</td></tr>
      <tr><td class="num">  59.0</td><td class="left">'Mecki'</td></tr>
-     <tr><td class="num">  59.6</td><td class="left">'Sopoforic'</td></tr>
+     <tr><td class="num">  59.7</td><td class="left">'Sopoforic'</td></tr>
      <tr><td class="num">  61.7</td><td class="left">'Asbel'</td></tr>
-     <tr><td class="num">  63.6</td><td class="left">'Meeve'</td></tr>
-     <tr><td class="num">  64.7</td><td class="left">'GiannuzzITA'</td></tr>
-     <tr><td class="num">  66.0</td><td class="left">'ael'</td></tr>
-     <tr><td class="num">  66.4</td><td class="left">'Fred_the_wise'</td></tr>
+     <tr><td class="num">  63.5</td><td class="left">'tasker'</td></tr>
+     <tr><td class="num">  63.8</td><td class="left">'Meeve'</td></tr>
+     <tr><td class="num">  66.1</td><td class="left">'ael'</td></tr>
+     <tr><td class="num">  66.3</td><td class="left">'Fred_the_wise'</td></tr>
      <tr><td class="num">  66.5</td><td class="left">'Samuel'</td></tr>
      <tr><td class="num">  66.8</td><td class="left">'schmusi20'</td></tr>
-     <tr><td class="num">  67.1</td><td class="left">'Sparkey'</td></tr>
+     <tr><td class="num">  67.2</td><td class="left">'Sparkey'</td></tr>
      <tr><td class="num">  67.4</td><td class="left">'Alf'</td></tr>
-     <tr><td class="num">  69.0</td><td class="left">'Magnus and Susi'</td></tr>
-     <tr><td class="num">  69.8</td><td class="left">'Zhura'</td></tr>
+     <tr><td class="num">  69.1</td><td class="left">'Magnus and Susi'</td></tr>
+     <tr><td class="num">  69.9</td><td class="left">'Zhura'</td></tr>
      <tr><td class="num">  70.2</td><td class="left">'xmouse'</td></tr>
-     <tr><td class="num">  70.7</td><td class="left">'tasker'</td></tr>
      <tr><td class="num">  71.7</td><td class="left">'Joona'</td></tr>
      <tr><td class="num">  72.1</td><td class="left">'AQZ'</td></tr>
      <tr><td class="num">  73.5</td><td class="left">'crypto_rsa'</td></tr>
-     <tr><td class="num">  73.9</td><td class="left">'Dvorhagen'</td></tr>
+     <tr><td class="num">  74.0</td><td class="left">'Dvorhagen'</td></tr>
      <tr><td class="num">  74.8</td><td class="left">'Eselchen'</td></tr>
-     <tr><td class="num">  74.9</td><td class="left">'Nicol?s'</td></tr>
-     <tr><td class="num">  74.9</td><td class="left">'jojo'</td></tr>
+     <tr><td class="num">  75.0</td><td class="left">'Nicol?s'</td></tr>
+     <tr><td class="num">  75.0</td><td class="left">'jojo'</td></tr>
      <tr><td class="num">  75.1</td><td class="left">'AsuCaga'</td></tr>
-     <tr><td class="num">  78.3</td><td class="left">'colonel crayon'</td></tr>
+     <tr><td class="num">  78.4</td><td class="left">'colonel crayon'</td></tr>
      <tr><td class="num">  79.3</td><td class="left">'Kroetchen'</td></tr>
      <tr><td class="num">  80.2</td><td class="left">'Agares'</td></tr>
      <tr><td class="num">  84.8</td><td class="left">'Miel56'</td></tr>

Modified: homepage/input/table-rat.html
===================================================================
--- homepage/input/table-rat.html	2008-08-02 19:14:42 UTC (rev 1252)
+++ homepage/input/table-rat.html	2008-08-02 19:45:47 UTC (rev 1253)
@@ -1,18 +1,18 @@
   <table>
-    <caption>$$Rating_Statistics$$ $$June$$ 2008</caption>
+    <caption>$$Rating_Statistics$$ $$July$$ 2008</caption>
     <colgroup><col width="80"><col width="80"><col width="220"></colgroup>
     <tr><th>$$count$$</th><th>$$average$$</th><th class="left">$$user$$</th></tr>    <tr><td class="num">1062</td><td class="num"> 5.06</td><td class="left">'ryujun'</td></tr>
     <tr><td class="num">1056</td><td class="num"> 4.83</td><td class="left">'Taztunes'</td></tr>
-    <tr><td class="num">998</td><td class="num"> 5.02</td><td class="left">'dev0'</td></tr>
+    <tr><td class="num">1006</td><td class="num"> 5.04</td><td class="left">'dev0'</td></tr>
     <tr><td class="num">887</td><td class="num"> 4.80</td><td class="left">'daydreamer'</td></tr>
     <tr><td class="num">871</td><td class="num"> 5.09</td><td class="left">'Stupid'</td></tr>
     <tr><td class="num">653</td><td class="num"> 5.01</td><td class="left">'Duffy'</td></tr>
+    <tr><td class="num">632</td><td class="num"> 4.78</td><td class="left">'U-Punkt'</td></tr>
     <tr><td class="num">628</td><td class="num"> 5.00</td><td class="left">'Moneymaker'</td></tr>
     <tr><td class="num">622</td><td class="num"> 4.22</td><td class="left">'shoki'</td></tr>
-    <tr><td class="num">618</td><td class="num"> 4.80</td><td class="left">'U-Punkt'</td></tr>
+    <tr><td class="num">562</td><td class="num"> 4.48</td><td class="left">'Alexandros'</td></tr>
     <tr><td class="num">552</td><td class="num"> 5.14</td><td class="left">'dpl'</td></tr>
     <tr><td class="num">534</td><td class="num"> 4.97</td><td class="left">'B-Huff'</td></tr>
-    <tr><td class="num">518</td><td class="num"> 4.42</td><td class="left">'Alexandros'</td></tr>
     <tr><td class="num">511</td><td class="num"> 5.30</td><td class="left">'Lukas'</td></tr>
     <tr><td class="num">487</td><td class="num"> 5.02</td><td class="left">'Ronald'</td></tr>
     <tr><td class="num">448</td><td class="num"> 5.08</td><td class="left">'Johannes'</td></tr>
@@ -33,7 +33,7 @@
     <tr><td class="num"> 85</td><td class="num"> 4.76</td><td class="left">'para_doks'</td></tr>
     <tr><td class="num"> 75</td><td class="num"> 4.52</td><td class="left">'Kroetchen'</td></tr>
     <tr><td class="num"> 72</td><td class="num"> 5.63</td><td class="left">'Wuzzy'</td></tr>
-    <tr><td class="num"> 62</td><td class="num"> 6.03</td><td class="left">'mecke'</td></tr>
+    <tr><td class="num"> 63</td><td class="num"> 6.06</td><td class="left">'mecke'</td></tr>
     <tr><td class="num"> 52</td><td class="num"> 6.56</td><td class="left">'Hairball'</td></tr>
     <tr><td class="num"> 51</td><td class="num"> 6.39</td><td class="left">'Little_Mole'</td></tr>
     <tr><td class="num"> 50</td><td class="num"> 5.26</td><td class="left">'Daniel'</td></tr>
@@ -43,19 +43,22 @@
     <tr><td class="num"> 39</td><td class="num"> 6.08</td><td class="left">'mrduke'</td></tr>
     <tr><td class="num"> 33</td><td class="num"> 3.39</td><td class="left">'Freshman'</td></tr>
     <tr><td class="num"> 33</td><td class="num"> 5.27</td><td class="left">'gringer'</td></tr>
+    <tr><td class="num"> 32</td><td class="num"> 5.97</td><td class="left">'ReasonAnce'</td></tr>
     <tr><td class="num"> 31</td><td class="num"> 7.61</td><td class="left">'AkRa'</td></tr>
     <tr><td class="num"> 30</td><td class="num"> 4.40</td><td class="left">'Archcorenth'</td></tr>
+    <tr><td class="num"> 30</td><td class="num"> 6.93</td><td class="left">'un_guru'</td></tr>
     <tr><td class="num"> 25</td><td class="num"> 4.88</td><td class="left">'Drotten'</td></tr>
     <tr><td class="num"> 25</td><td class="num"> 7.16</td><td class="left">'Mark P.'</td></tr>
     <tr><td class="num"> 19</td><td class="num"> 3.74</td><td class="left">'Eselchen'</td></tr>
+    <tr><td class="num"> 17</td><td class="num"> 7.18</td><td class="left">'Ale'</td></tr>
     <tr><td class="num"> 17</td><td class="num"> 5.53</td><td class="left">'Jeffrey S'</td></tr>
+    <tr><td class="num"> 16</td><td class="num"> 3.25</td><td class="left">'tasker'</td></tr>
     <tr><td class="num"> 16</td><td class="num"> 7.63</td><td class="left">'Ghatotkacha'</td></tr>
     <tr><td class="num"> 16</td><td class="num"> 3.88</td><td class="left">'Mecki'</td></tr>
-    <tr><td class="num"> 13</td><td class="num"> 7.69</td><td class="left">'Ale'</td></tr>
     <tr><td class="num"> 13</td><td class="num"> 5.23</td><td class="left">'Samuel'</td></tr>
+    <tr><td class="num"> 12</td><td class="num"> 8.08</td><td class="left">'Ludmian'</td></tr>
     <tr><td class="num"> 11</td><td class="num"> 6.36</td><td class="left">'ShadowPhrogg32642342'</td></tr>
     <tr><td class="num"> 10</td><td class="num"> 7.80</td><td class="left">'hdwow'</td></tr>
-    <tr><td class="num">  9</td><td class="num"> 8.22</td><td class="left">'Ludmian'</td></tr>
     <tr><td class="num">  8</td><td class="num"> 3.25</td><td class="left">'Vlad'</td></tr>
     <tr><td class="num">  8</td><td class="num"> 7.63</td><td class="left">'Antonio EE'</td></tr>
     <tr><td class="num">  7</td><td class="num"> 4.29</td><td class="left">'Snaily'</td></tr>
@@ -64,6 +67,7 @@
     <tr><td class="num">  4</td><td class="num"> 6.75</td><td class="left">'Agares'</td></tr>
     <tr><td class="num">  4</td><td class="num">10.00</td><td class="left">'Kevin'</td></tr>
     <tr><td class="num">  4</td><td class="num"> 5.75</td><td class="left">'joseba'</td></tr>
+    <tr><td class="num">  4</td><td class="num"> 5.75</td><td class="left">'Emmanuel'</td></tr>
     <tr><td class="num">  4</td><td class="num"> 1.00</td><td class="left">'Hans-HD'</td></tr>
     <tr><td class="num">  4</td><td class="num"> 6.50</td><td class="left">'serpent'</td></tr>
     <tr><td class="num">  4</td><td class="num"> 7.00</td><td class="left">'redsantz'</td></tr>
@@ -73,7 +77,6 @@
     <tr><td class="num">  3</td><td class="num"> 3.00</td><td class="left">'Rugby4ever'</td></tr>
     <tr><td class="num">  3</td><td class="num"> 4.33</td><td class="left">'krazy62'</td></tr>
     <tr><td class="num">  2</td><td class="num"> 6.50</td><td class="left">'tjRaven'</td></tr>
-    <tr><td class="num">  2</td><td class="num"> 6.00</td><td class="left">'Emmanuel'</td></tr>
     <tr><td class="num">  2</td><td class="num"> 0.00</td><td class="left">'mhatta'</td></tr>
     <tr><td class="num">  1</td><td class="num"> 5.00</td><td class="left">'ael'</td></tr>
     <tr><td class="num">  1</td><td class="num"> 6.00</td><td class="left">'Slav'</td></tr>

Modified: homepage/input/table-solved.html
===================================================================
--- homepage/input/table-solved.html	2008-08-02 19:14:42 UTC (rev 1252)
+++ homepage/input/table-solved.html	2008-08-02 19:45:47 UTC (rev 1253)
@@ -1,5 +1,5 @@
   <table>
-    <caption>$$Solved_Level_Statistics$$ $$June$$ 2008</caption>
+    <caption>$$Solved_Level_Statistics$$ $$July$$ 2008</caption>
     <colgroup><col width="130"><col width="130"><col width="130"><col width="240"></colgroup>
     <tr><th>$$difficult$$</th><th>$$easy$$</th><th>$$total$$</th><th class="left">$$user$$</th></tr>
     <tr><td class="num">1045/1045</td><td class="num">189/189</td><td class="num">100.00%</td><td class="left">'ryujun'</td></tr>
@@ -10,13 +10,13 @@
     <tr><td class="num">1016/1045</td><td class="num">182/189</td><td class="num"> 97.08%</td><td class="left">'Ronald'</td></tr>
     <tr><td class="num">1015/1045</td><td class="num">183/189</td><td class="num"> 97.08%</td><td class="left">'daydreamer'</td></tr>
     <tr><td class="num">1021/1045</td><td class="num">177/189</td><td class="num"> 97.08%</td><td class="left">'Malla'</td></tr>
+    <tr><td class="num">1009/1045</td><td class="num">182/189</td><td class="num"> 96.52%</td><td class="left">'dev0'</td></tr>
     <tr><td class="num">1014/1045</td><td class="num">175/189</td><td class="num"> 96.35%</td><td class="left">'Stupid'</td></tr>
-    <tr><td class="num">1001/1045</td><td class="num">179/189</td><td class="num"> 95.62%</td><td class="left">'dev0'</td></tr>
     <tr><td class="num"> 999/1045</td><td class="num">177/189</td><td class="num"> 95.30%</td><td class="left">'biotopa'</td></tr>
     <tr><td class="num"> 970/1045</td><td class="num">166/189</td><td class="num"> 92.06%</td><td class="left">'Andy'</td></tr>
+    <tr><td class="num"> 951/1045</td><td class="num">171/189</td><td class="num"> 90.92%</td><td class="left">'mecke'</td></tr>
+    <tr><td class="num"> 947/1045</td><td class="num">174/189</td><td class="num"> 90.84%</td><td class="left">'Daisy'</td></tr>
     <tr><td class="num"> 949/1045</td><td class="num">170/189</td><td class="num"> 90.68%</td><td class="left">'para_doks'</td></tr>
-    <tr><td class="num"> 945/1045</td><td class="num">172/189</td><td class="num"> 90.52%</td><td class="left">'Daisy'</td></tr>
-    <tr><td class="num"> 947/1045</td><td class="num">169/189</td><td class="num"> 90.44%</td><td class="left">'mecke'</td></tr>
     <tr><td class="num"> 922/1045</td><td class="num">154/189</td><td class="num"> 87.20%</td><td class="left">'mrduke'</td></tr>
     <tr><td class="num"> 933/1045</td><td class="num">125/189</td><td class="num"> 85.74%</td><td class="left">'Alex'</td></tr>
     <tr><td class="num"> 914/1045</td><td class="num">135/189</td><td class="num"> 85.01%</td><td class="left">'JuSt'</td></tr>
@@ -30,20 +30,20 @@
     <tr><td class="num"> 854/1045</td><td class="num">131/189</td><td class="num"> 79.82%</td><td class="left">'shoki'</td></tr>
     <tr><td class="num"> 874/1045</td><td class="num">103/189</td><td class="num"> 79.17%</td><td class="left">'Melanie'</td></tr>
     <tr><td class="num"> 950/1045</td><td class="num">  0/189</td><td class="num"> 76.99%</td><td class="left">'Tarim'</td></tr>
+    <tr><td class="num"> 946/1045</td><td class="num">  1/189</td><td class="num"> 76.74%</td><td class="left">'Ale'</td></tr>
     <tr><td class="num"> 804/1045</td><td class="num">142/189</td><td class="num"> 76.66%</td><td class="left">'Safalra'</td></tr>
-    <tr><td class="num"> 938/1045</td><td class="num">  1/189</td><td class="num"> 76.09%</td><td class="left">'Ale'</td></tr>
     <tr><td class="num"> 782/1045</td><td class="num">132/189</td><td class="num"> 74.07%</td><td class="left">'AlephD'</td></tr>
-    <tr><td class="num"> 773/1045</td><td class="num">116/189</td><td class="num"> 72.04%</td><td class="left">'U-Punkt'</td></tr>
+    <tr><td class="num"> 775/1045</td><td class="num">118/189</td><td class="num"> 72.37%</td><td class="left">'U-Punkt'</td></tr>
+    <tr><td class="num"> 758/1045</td><td class="num">123/189</td><td class="num"> 71.39%</td><td class="left">'Ludmian'</td></tr>
     <tr><td class="num"> 739/1045</td><td class="num">131/189</td><td class="num"> 70.50%</td><td class="left">'ABS'</td></tr>
     <tr><td class="num"> 740/1045</td><td class="num">123/189</td><td class="num"> 69.94%</td><td class="left">'dpl'</td></tr>
-    <tr><td class="num"> 739/1045</td><td class="num">119/189</td><td class="num"> 69.53%</td><td class="left">'Ludmian'</td></tr>
     <tr><td class="num"> 728/1045</td><td class="num">126/189</td><td class="num"> 69.21%</td><td class="left">'B-Huff'</td></tr>
     <tr><td class="num"> 755/1045</td><td class="num"> 96/189</td><td class="num"> 68.96%</td><td class="left">'brynn'</td></tr>
     <tr><td class="num"> 762/1045</td><td class="num"> 73/189</td><td class="num"> 67.67%</td><td class="left">'redsantz'</td></tr>
     <tr><td class="num"> 734/1045</td><td class="num"> 82/189</td><td class="num"> 66.13%</td><td class="left">'bojster'</td></tr>
     <tr><td class="num"> 782/1045</td><td class="num"> 33/189</td><td class="num"> 66.05%</td><td class="left">'Sim_Ed'</td></tr>
+    <tr><td class="num"> 680/1045</td><td class="num">130/189</td><td class="num"> 65.64%</td><td class="left">'Alexandros'</td></tr>
     <tr><td class="num"> 766/1045</td><td class="num"> 37/189</td><td class="num"> 65.07%</td><td class="left">'alfred69'</td></tr>
-    <tr><td class="num"> 648/1045</td><td class="num">128/189</td><td class="num"> 62.88%</td><td class="left">'Alexandros'</td></tr>
     <tr><td class="num"> 681/1045</td><td class="num"> 78/189</td><td class="num"> 61.51%</td><td class="left">'HuB34'</td></tr>
     <tr><td class="num"> 659/1045</td><td class="num"> 95/189</td><td class="num"> 61.10%</td><td class="left">'Marc-Hendrik'</td></tr>
     <tr><td class="num"> 633/1045</td><td class="num">110/189</td><td class="num"> 60.21%</td><td class="left">'Raoul'</td></tr>
@@ -62,13 +62,14 @@
     <tr><td class="num"> 533/1045</td><td class="num"> 82/189</td><td class="num"> 49.84%</td><td class="left">'Wuzzy'</td></tr>
     <tr><td class="num"> 506/1045</td><td class="num">108/189</td><td class="num"> 49.76%</td><td class="left">'Agnieszka'</td></tr>
     <tr><td class="num"> 613/1045</td><td class="num">  0/189</td><td class="num"> 49.68%</td><td class="left">'Little_Mole'</td></tr>
+    <tr><td class="num"> 499/1045</td><td class="num">111/189</td><td class="num"> 49.43%</td><td class="left">'Emmanuel'</td></tr>
     <tr><td class="num"> 500/1045</td><td class="num"> 92/189</td><td class="num"> 47.97%</td><td class="left">'Kosby'</td></tr>
-    <tr><td class="num"> 478/1045</td><td class="num">106/189</td><td class="num"> 47.33%</td><td class="left">'Emmanuel'</td></tr>
     <tr><td class="num"> 478/1045</td><td class="num">101/189</td><td class="num"> 46.92%</td><td class="left">'Austin'</td></tr>
     <tr><td class="num"> 504/1045</td><td class="num"> 62/189</td><td class="num"> 45.87%</td><td class="left">'Hans-HD'</td></tr>
     <tr><td class="num"> 519/1045</td><td class="num"> 37/189</td><td class="num"> 45.06%</td><td class="left">'Valkyrie2'</td></tr>
     <tr><td class="num"> 492/1045</td><td class="num"> 63/189</td><td class="num"> 44.98%</td><td class="left">'Antonio EE'</td></tr>
     <tr><td class="num"> 516/1045</td><td class="num"> 24/189</td><td class="num"> 43.76%</td><td class="left">'niebie'</td></tr>
+    <tr><td class="num"> 508/1045</td><td class="num"> 26/189</td><td class="num"> 43.27%</td><td class="left">'Feynman'</td></tr>
     <tr><td class="num"> 494/1045</td><td class="num"> 26/189</td><td class="num"> 42.14%</td><td class="left">'Daniel'</td></tr>
     <tr><td class="num"> 506/1045</td><td class="num"> 12/189</td><td class="num"> 41.98%</td><td class="left">'Duffy'</td></tr>
     <tr><td class="num"> 446/1045</td><td class="num"> 65/189</td><td class="num"> 41.41%</td><td class="left">'Tiza'</td></tr>
@@ -102,6 +103,7 @@
     <tr><td class="num"> 261/1045</td><td class="num"> 53/189</td><td class="num"> 25.45%</td><td class="left">'Andreas'</td></tr>
     <tr><td class="num"> 269/1045</td><td class="num"> 26/189</td><td class="num"> 23.91%</td><td class="left">'Mecki'</td></tr>
     <tr><td class="num"> 276/1045</td><td class="num"> 15/189</td><td class="num"> 23.58%</td><td class="left">'Thomas'</td></tr>
+    <tr><td class="num"> 258/1045</td><td class="num"> 27/189</td><td class="num"> 23.10%</td><td class="left">'un_guru'</td></tr>
     <tr><td class="num"> 245/1045</td><td class="num"> 36/189</td><td class="num"> 22.77%</td><td class="left">'B-man'</td></tr>
     <tr><td class="num"> 259/1045</td><td class="num">  7/189</td><td class="num"> 21.56%</td><td class="left">'geembo_90'</td></tr>
     <tr><td class="num"> 243/1045</td><td class="num"> 23/189</td><td class="num"> 21.56%</td><td class="left">'Snaily'</td></tr>
@@ -110,9 +112,11 @@
     <tr><td class="num"> 208/1045</td><td class="num"> 33/189</td><td class="num"> 19.53%</td><td class="left">'Uli'</td></tr>
     <tr><td class="num"> 203/1045</td><td class="num"> 34/189</td><td class="num"> 19.21%</td><td class="left">'ntaeijr'</td></tr>
     <tr><td class="num"> 214/1045</td><td class="num"> 19/189</td><td class="num"> 18.88%</td><td class="left">'Adonica'</td></tr>
+    <tr><td class="num"> 188/1045</td><td class="num"> 33/189</td><td class="num"> 17.91%</td><td class="left">'Pascal'</td></tr>
+    <tr><td class="num"> 209/1045</td><td class="num"> 11/189</td><td class="num"> 17.83%</td><td class="left">'GiannuzzITA'</td></tr>
     <tr><td class="num"> 206/1045</td><td class="num">  4/189</td><td class="num"> 17.02%</td><td class="left">'krazy62'</td></tr>
     <tr><td class="num"> 181/1045</td><td class="num"> 20/189</td><td class="num"> 16.29%</td><td class="left">'Vaily'</td></tr>
-    <tr><td class="num"> 152/1045</td><td class="num"> 32/189</td><td class="num"> 14.91%</td><td class="left">'Angolino'</td></tr>
+    <tr><td class="num"> 155/1045</td><td class="num"> 32/189</td><td class="num"> 15.15%</td><td class="left">'Angolino'</td></tr>
     <tr><td class="num"> 156/1045</td><td class="num"> 24/189</td><td class="num"> 14.59%</td><td class="left">'jdcampo'</td></tr>
     <tr><td class="num"> 125/1045</td><td class="num"> 55/189</td><td class="num"> 14.59%</td><td class="left">'Vlad'</td></tr>
     <tr><td class="num"> 149/1045</td><td class="num"> 30/189</td><td class="num"> 14.51%</td><td class="left">'Chris'</td></tr>
@@ -127,16 +131,17 @@
     <tr><td class="num"> 148/1045</td><td class="num">  5/189</td><td class="num"> 12.40%</td><td class="left">'Rugby4ever'</td></tr>
     <tr><td class="num"> 110/1045</td><td class="num"> 31/189</td><td class="num"> 11.43%</td><td class="left">'Cyphase'</td></tr>
     <tr><td class="num"> 124/1045</td><td class="num"> 15/189</td><td class="num"> 11.26%</td><td class="left">'Magnus and Susi'</td></tr>
+    <tr><td class="num"> 123/1045</td><td class="num"> 13/189</td><td class="num"> 11.02%</td><td class="left">'tasker'</td></tr>
     <tr><td class="num"> 131/1045</td><td class="num">  1/189</td><td class="num"> 10.70%</td><td class="left">'Asbel'</td></tr>
     <tr><td class="num"> 105/1045</td><td class="num"> 22/189</td><td class="num"> 10.29%</td><td class="left">'Neophilus'</td></tr>
     <tr><td class="num">  89/1045</td><td class="num"> 24/189</td><td class="num">  9.16%</td><td class="left">'Zhura'</td></tr>
+    <tr><td class="num">  98/1045</td><td class="num"> 13/189</td><td class="num">  9.00%</td><td class="left">'ReasonAnce'</td></tr>
     <tr><td class="num"> 101/1045</td><td class="num">  0/189</td><td class="num">  8.18%</td><td class="left">'Alf'</td></tr>
     <tr><td class="num">  84/1045</td><td class="num"> 15/189</td><td class="num">  8.02%</td><td class="left">'Eselchen'</td></tr>
     <tr><td class="num">  79/1045</td><td class="num"> 10/189</td><td class="num">  7.21%</td><td class="left">'Kroetchen'</td></tr>
     <tr><td class="num">  78/1045</td><td class="num"> 10/189</td><td class="num">  7.13%</td><td class="left">'Fred_the_wise'</td></tr>
     <tr><td class="num">  75/1045</td><td class="num"> 12/189</td><td class="num">  7.05%</td><td class="left">'schmusi20'</td></tr>
     <tr><td class="num">  67/1045</td><td class="num"> 19/189</td><td class="num">  6.97%</td><td class="left">'Dvorhagen'</td></tr>
-    <tr><td class="num">  83/1045</td><td class="num">  1/189</td><td class="num">  6.81%</td><td class="left">'tasker'</td></tr>
     <tr><td class="num">  57/1045</td><td class="num"> 26/189</td><td class="num">  6.73%</td><td class="left">'Meeve'</td></tr>
     <tr><td class="num">  65/1045</td><td class="num"> 16/189</td><td class="num">  6.56%</td><td class="left">'Slav'</td></tr>
     <tr><td class="num">  64/1045</td><td class="num"> 16/189</td><td class="num">  6.48%</td><td class="left">'AQZ'</td></tr>
@@ -145,7 +150,6 @@
     <tr><td class="num">  67/1045</td><td class="num">  7/189</td><td class="num">  6.00%</td><td class="left">'Joona'</td></tr>
     <tr><td class="num">  54/1045</td><td class="num"> 18/189</td><td class="num">  5.83%</td><td class="left">'Sopoforic'</td></tr>
     <tr><td class="num">  54/1045</td><td class="num"> 12/189</td><td class="num">  5.35%</td><td class="left">'Samuel'</td></tr>
-    <tr><td class="num">  56/1045</td><td class="num">  9/189</td><td class="num">  5.27%</td><td class="left">'GiannuzzITA'</td></tr>
     <tr><td class="num">  47/1045</td><td class="num"> 17/189</td><td class="num">  5.19%</td><td class="left">'crypto_rsa'</td></tr>
     <tr><td class="num">  44/1045</td><td class="num"> 16/189</td><td class="num">  4.86%</td><td class="left">'Agares'</td></tr>
     <tr><td class="num">  33/1045</td><td class="num"> 23/189</td><td class="num">  4.54%</td><td class="left">'Sparkey'</td></tr>

Modified: homepage/input/table-wr.html
===================================================================
--- homepage/input/table-wr.html	2008-08-02 19:14:42 UTC (rev 1252)
+++ homepage/input/table-wr.html	2008-08-02 19:45:47 UTC (rev 1253)
@@ -1,51 +1,50 @@
   <table>
-    <caption>$$Worldrecord_Statistics$$ $$June$$ 2008</caption>
+    <caption>$$Worldrecord_Statistics$$ $$July$$ 2008</caption>
     <colgroup><col width="80"><col width="80"><col width="470"></colgroup>
     <tr><th>$$total$$</th><th>$$shared$$</th><th class="left">$$user$$</th></tr>
-    <tr><td class="num">974</td><td class="num">245</td><td class="left">'Moneymaker'</td></tr>
-    <tr><td class="num">160</td><td class="num"> 92</td><td class="left">'Stupid'</td></tr>
-    <tr><td class="num">115</td><td class="num">107</td><td class="left">'Johannes'</td></tr>
-    <tr><td class="num">107</td><td class="num"> 85</td><td class="left">'daydreamer'</td></tr>
-    <tr><td class="num"> 59</td><td class="num"> 41</td><td class="left">'Duffy'</td></tr>
-    <tr><td class="num"> 55</td><td class="num"> 45</td><td class="left">'dev0'</td></tr>
-    <tr><td class="num"> 49</td><td class="num"> 37</td><td class="left">'ryujun'</td></tr>
-    <tr><td class="num"> 47</td><td class="num"> 46</td><td class="left">'Great Scott'</td></tr>
-    <tr><td class="num"> 44</td><td class="num"> 30</td><td class="left">'Malla'</td></tr>
-    <tr><td class="num"> 39</td><td class="num"> 30</td><td class="left">'Alexandros'</td></tr>
-    <tr><td class="num"> 35</td><td class="num"> 27</td><td class="left">'Zekobah'</td></tr>
-    <tr><td class="num"> 35</td><td class="num"> 33</td><td class="left">'Django'</td></tr>
+    <tr><td class="num">985</td><td class="num">239</td><td class="left">'Moneymaker'</td></tr>
+    <tr><td class="num">154</td><td class="num"> 90</td><td class="left">'Stupid'</td></tr>
+    <tr><td class="num">108</td><td class="num">101</td><td class="left">'Johannes'</td></tr>
+    <tr><td class="num"> 98</td><td class="num"> 76</td><td class="left">'daydreamer'</td></tr>
+    <tr><td class="num"> 63</td><td class="num"> 52</td><td class="left">'dev0'</td></tr>
+    <tr><td class="num"> 56</td><td class="num"> 39</td><td class="left">'Duffy'</td></tr>
+    <tr><td class="num"> 44</td><td class="num"> 31</td><td class="left">'Malla'</td></tr>
+    <tr><td class="num"> 44</td><td class="num"> 43</td><td class="left">'Great Scott'</td></tr>
+    <tr><td class="num"> 43</td><td class="num"> 30</td><td class="left">'Alexandros'</td></tr>
+    <tr><td class="num"> 40</td><td class="num"> 32</td><td class="left">'ryujun'</td></tr>
+    <tr><td class="num"> 32</td><td class="num"> 26</td><td class="left">'Zekobah'</td></tr>
+    <tr><td class="num"> 32</td><td class="num"> 30</td><td class="left">'Django'</td></tr>
     <tr><td class="num"> 31</td><td class="num"> 27</td><td class="left">'Iceshark7'</td></tr>
-    <tr><td class="num"> 30</td><td class="num"> 29</td><td class="left">'joseba'</td></tr>
-    <tr><td class="num"> 27</td><td class="num"> 26</td><td class="left">'Ghatotkacha'</td></tr>
-    <tr><td class="num"> 25</td><td class="num"> 17</td><td class="left">'Emmanuel'</td></tr>
-    <tr><td class="num"> 23</td><td class="num"> 18</td><td class="left">'ged'</td></tr>
-    <tr><td class="num"> 20</td><td class="num"> 19</td><td class="left">'Safalra'</td></tr>
-    <tr><td class="num"> 19</td><td class="num"> 17</td><td class="left">'B-Huff'</td></tr>
-    <tr><td class="num"> 17</td><td class="num"> 14</td><td class="left">'Ludmian'</td></tr>
-    <tr><td class="num"> 17</td><td class="num"> 17</td><td class="left">'bojster'</td></tr>
-    <tr><td class="num"> 16</td><td class="num"> 15</td><td class="left">'HuB34'</td></tr>
-    <tr><td class="num"> 15</td><td class="num"> 15</td><td class="left">'ABS'</td></tr>
-    <tr><td class="num"> 13</td><td class="num">  6</td><td class="left">'Ronald'</td></tr>
+    <tr><td class="num"> 30</td><td class="num"> 20</td><td class="left">'Emmanuel'</td></tr>
+    <tr><td class="num"> 28</td><td class="num"> 27</td><td class="left">'joseba'</td></tr>
+    <tr><td class="num"> 26</td><td class="num"> 25</td><td class="left">'Ghatotkacha'</td></tr>
+    <tr><td class="num"> 23</td><td class="num"> 19</td><td class="left">'ged'</td></tr>
+    <tr><td class="num"> 18</td><td class="num"> 16</td><td class="left">'B-Huff'</td></tr>
+    <tr><td class="num"> 17</td><td class="num"> 16</td><td class="left">'Safalra'</td></tr>
+    <tr><td class="num"> 16</td><td class="num"> 14</td><td class="left">'Ludmian'</td></tr>
+    <tr><td class="num"> 15</td><td class="num"> 14</td><td class="left">'HuB34'</td></tr>
+    <tr><td class="num"> 15</td><td class="num"> 15</td><td class="left">'bojster'</td></tr>
+    <tr><td class="num"> 13</td><td class="num"> 13</td><td class="left">'ABS'</td></tr>
+    <tr><td class="num"> 12</td><td class="num">  6</td><td class="left">'Ronald'</td></tr>
     <tr><td class="num"> 10</td><td class="num">  7</td><td class="left">'Chocolate Zero'</td></tr>
     <tr><td class="num">  9</td><td class="num">  5</td><td class="left">'ShadowPhrogg32642342'</td></tr>
     <tr><td class="num">  9</td><td class="num">  9</td><td class="left">'fabian'</td></tr>
     <tr><td class="num">  8</td><td class="num">  6</td><td class="left">'Gloop'</td></tr>
     <tr><td class="num">  8</td><td class="num">  8</td><td class="left">'dpl'</td></tr>
-    <tr><td class="num">  7</td><td class="num">  5</td><td class="left">'Taztunes'</td></tr>
+    <tr><td class="num">  7</td><td class="num">  5</td><td class="left">'Taztunes' + 'Angolino'</td></tr>
     <tr><td class="num">  7</td><td class="num">  6</td><td class="left">'Edgar_Flesk'</td></tr>
-    <tr><td class="num">  6</td><td class="num">  3</td><td class="left">'para_doks' + 'Breezy'</td></tr>
-    <tr><td class="num">  6</td><td class="num">  4</td><td class="left">'Lukas'</td></tr>
-    <tr><td class="num">  6</td><td class="num">  5</td><td class="left">'Guglielmo' + 'Angolino'</td></tr>
-    <tr><td class="num">  6</td><td class="num">  6</td><td class="left">'Tobias' + 'Wuzzy'</td></tr>
-    <tr><td class="num">  5</td><td class="num">  2</td><td class="left">'Hairball'</td></tr>
-    <tr><td class="num">  5</td><td class="num">  5</td><td class="left">'Raoul' + 'Cyphase' + 'Thomas' + 'Chris' + 'Ralf'</td></tr>
-    <tr><td class="num">  4</td><td class="num">  2</td><td class="left">'Bent'</td></tr>
-    <tr><td class="num">  4</td><td class="num">  4</td><td class="left">'U-Punkt' + 'J3FF'</td></tr>
-    <tr><td class="num">  3</td><td class="num">  2</td><td class="left">'mrduke' + 'colonel crayon' + 'Stephanie'</td></tr>
+    <tr><td class="num">  6</td><td class="num">  3</td><td class="left">'para_doks' + 'Breezy' + 'Daisy'</td></tr>
+    <tr><td class="num">  6</td><td class="num">  5</td><td class="left">'Guglielmo'</td></tr>
+    <tr><td class="num">  6</td><td class="num">  6</td><td class="left">'Tobias'</td></tr>
+    <tr><td class="num">  5</td><td class="num">  4</td><td class="left">'Lukas'</td></tr>
+    <tr><td class="num">  5</td><td class="num">  5</td><td class="left">'Thomas' + 'Chris' + 'Wuzzy' + 'Ralf'</td></tr>
+    <tr><td class="num">  4</td><td class="num">  2</td><td class="left">'Hairball'</td></tr>
+    <tr><td class="num">  4</td><td class="num">  4</td><td class="left">'U-Punkt' + 'Raoul' + 'J3FF' + 'Cyphase' + 'GiannuzzITA'</td></tr>
+    <tr><td class="num">  3</td><td class="num">  2</td><td class="left">'mrduke' + 'Bent' + 'Stephanie'</td></tr>
     <tr><td class="num">  3</td><td class="num">  3</td><td class="left">'geembo_90' + 'Tiza' + 'Neophilus' + 'Nicol?s' + 'Andy' + 'Sopoforic'</td></tr>
-    <tr><td class="num">  2</td><td class="num">  1</td><td class="left">'Daniel'</td></tr>
-    <tr><td class="num">  2</td><td class="num">  2</td><td class="left">'Drotten' + 'tjRaven' + 'Sim_Ed' + 'hendrik' + 'GiannuzzITA' + 'Austin' + 'Snaily' + 'Craven' + 'Antonio EE' + 'Ingo' + 'serpent'</td></tr>
-    <tr><td class="num">  1</td><td class="num">  0</td><td class="left">'Ale' + 'Sparkey' + 'Gorn' + 'Nat' + 'Daisy'</td></tr>
-    <tr><td class="num">  1</td><td class="num">  1</td><td class="left">'alfred69' + 'Agares' + 'ntaeijr' + 'Tiger' + 'Zak' + 'Slav' + 'niebie' + 'Andreas' + 'AlephD' + 'Samuel' + 'Mark P.' + 'oblo' + 'hdwow' + 'B-man' + 'Asbel' + 'Vlad' + 'Vaily' + 'JuSt'</td></tr>
-    <tr><td class="num">  0</td><td class="num">  0</td><td class="left">'AQZ' + 'tasker' + 'Miel56' + 'Zhura' + 'Alf' + 'Turbogurk' + 'Gottseinsohn' + 'Eselchen' + 'ael' + 'biotopa' + 'brynn' + 'IntKecsk' + 'Davacardo' + 'Adonica' + 'Joona' + 'Sandra' + 'schmusi20' + 'Kosby' + 'Magnus and Susi' + 'WP319' + 'Kevin' + 'xmouse' + 'erich' + 'Vinksu' + 'Uli' + 'Alex' + 'Fred_the_wise' + 'jdcampo' + 'Freshman' + 'Little_Mole' + 'Kroetchen' + 'crypto_rsa' + 'Harry Lim' + 'Sequoyah' + 'AkRa' + 'Momcat' + 'NorthForty' + 'Mecki' + 'The red O' + 'gringer' + 'Jeffrey S' + 'Nfol' + 'Marc-Hendrik' + 'Kadu' + 'shoki' + 'jojo' + 'WesleyCrusher' + 'rima' + 'Klaus' + 'Valkyrie2' + 'MicWa' + 'AsuCaga' + 'Rugby4ever' + 'Archcorenth' + 'Meeve' + 'mhatta' + 'Hans-HD' + 'mecke' + 'krazy62' + 'Dvorhagen' + 'Holger' + 'Ingo_K' + 'Ant' + 'Melanie' + 'IChrisI' + 'redsantz' + 'Markus' + 'Liam Sheehan' + 'Michael' + 'Tarim' + 'Agnieszka'</td></tr>
+    <tr><td class="num">  2</td><td class="num">  1</td><td class="left">'Daniel' + 'colonel crayon'</td></tr>
+    <tr><td class="num">  2</td><td class="num">  2</td><td class="left">'ReasonAnce' + 'Drotten' + 'tjRaven' + 'Sim_Ed' + 'hendrik' + 'Austin' + 'Snaily' + 'Craven' + 'Ingo' + 'serpent'</td></tr>
+    <tr><td class="num">  1</td><td class="num">  0</td><td class="left">'Ale' + 'Feynman' + 'Gorn' + 'Nat'</td></tr>
+    <tr><td class="num">  1</td><td class="num">  1</td><td class="left">'alfred69' + 'Agares' + 'Tiger' + 'Zak' + 'Slav' + 'niebie' + 'Andreas' + 'AlephD' + 'Samuel' + 'Mark P.' + 'oblo' + 'Pascal' + 'hdwow' + 'B-man' + 'Asbel' + 'Vlad' + 'Vaily' + 'Antonio EE' + 'JuSt'</td></tr>
+    <tr><td class="num">  0</td><td class="num">  0</td><td class="left">'AQZ' + 'tasker' + 'Miel56' + 'Zhura' + 'Alf' + 'Turbogurk' + 'Gottseinsohn' + 'ntaeijr' + 'Eselchen' + 'ael' + 'biotopa' + 'brynn' + 'IntKecsk' + 'Davacardo' + 'Adonica' + 'Joona' + 'Sandra' + 'schmusi20' + 'Kosby' + 'Magnus and Susi' + 'WP319' + 'Kevin' + 'xmouse' + 'erich' + 'Vinksu' + 'Uli' + 'Alex' + 'Fred_the_wise' + 'jdcampo' + 'Freshman' + 'Little_Mole' + 'Kroetchen' + 'crypto_rsa' + 'Harry Lim' + 'Sequoyah' + 'AkRa' + 'Momcat' + 'NorthForty' + 'Mecki' + 'The red O' + 'gringer' + 'Jeffrey S' + 'Nfol' + 'Marc-Hendrik' + 'Kadu' + 'shoki' + 'jojo' + 'WesleyCrusher' + 'rima' + 'Klaus' + 'Valkyrie2' + 'MicWa' + 'AsuCaga' + 'Rugby4ever' + 'Archcorenth' + 'Meeve' + 'mhatta' + 'Hans-HD' + 'mecke' + 'un_guru' + 'krazy62' + 'Dvorhagen' + 'Sparkey' + 'Holger' + 'Ingo_K' + 'Ant' + 'Melanie' + 'IChrisI' + 'redsantz' + 'Markus' + 'Liam Sheehan' + 'Michael' + 'Tarim' + 'Agnieszka'</td></tr>
   </table>

Modified: homepage/input/userlist.html
===================================================================
--- homepage/input/userlist.html	2008-08-02 19:14:42 UTC (rev 1252)
+++ homepage/input/userlist.html	2008-08-02 19:45:47 UTC (rev 1253)
@@ -51,6 +51,7 @@
     <li>erich</li>
     <li>Eselchen</li>
     <li>fabian</li>
+    <li>Feynman</li>
     <li>Fred_the_wise</li>
     <li>Freshman</li>
     <li>ged</li>
@@ -118,8 +119,10 @@
     <li>ntaeijr</li>
     <li>oblo</li>
     <li>para_doks</li>
+    <li>Pascal</li>
     <li>Ralf</li>
     <li>Raoul</li>
+    <li>ReasonAnce</li>
     <li>redsantz</li>
     <li>rima</li>
     <li>Ronald</li>
@@ -151,6 +154,7 @@
     <li>Tobias</li>
     <li>Turbogurk</li>
     <li>Uli</li>
+    <li>un_guru</li>
     <li>U-Punkt</li>
     <li>Vaily</li>
     <li>Valkyrie2</li>



From ral at mail.berlios.de  Sun Aug  3 21:37:43 2008
From: ral at mail.berlios.de (ral at BerliOS)
Date: Sun, 3 Aug 2008 21:37:43 +0200
Subject: [Enigma-game-svn] r1254 - trunk/src
Message-ID: <200808031937.m73Jbhrn004113@sheep.berlios.de>

Author: ral
Date: 2008-08-03 21:37:42 +0200 (Sun, 03 Aug 2008)
New Revision: 1254

Modified:
   trunk/src/stones_complex.cc
   trunk/src/world.cc
Log:
Trunk 1.1:
- fix old oneway/door collision problems:
  - a regular passing actor could tunnel neighboring stones at the moment
    the it passed the oneway/door
  - an unjoined oneway had rounded edges, that did reflect actors even
    on the free passable sides.


Modified: trunk/src/stones_complex.cc
===================================================================
--- trunk/src/stones_complex.cc	2008-08-02 19:45:47 UTC (rev 1253)
+++ trunk/src/stones_complex.cc	2008-08-03 19:37:42 UTC (rev 1254)
@@ -360,8 +360,16 @@
     DirectionBits dirs=contact_faces(sc);
     Direction o=get_orientation();
 
-    if (!sc.actor->is_flying() && actor_may_pass(sc.actor))
-        return has_dir(dirs,o) ? STONE_REBOUND : STONE_PASS;
+    if (!sc.actor->is_flying() && actor_may_pass(sc.actor)) {
+        StoneResponse result = STONE_PASS;
+        if ((o == WEST && (get_pos().x >= sc.actor->get_pos()[0])) ||
+                (o == SOUTH && (get_pos().y + 1 <= sc.actor->get_pos()[1])) ||
+                (o == EAST && (get_pos().x + 1 <= sc.actor->get_pos()[0])) ||
+                (o == NORTH && (get_pos().y >= sc.actor->get_pos()[1])))
+            result = STONE_REBOUND;
+        return result;
+//        return has_dir(dirs,o) ? STONE_REBOUND : STONE_PASS;
+    }
     else
         return STONE_REBOUND;
 }

Modified: trunk/src/world.cc
===================================================================
--- trunk/src/world.cc	2008-08-02 19:45:47 UTC (rev 1253)
+++ trunk/src/world.cc	2008-08-03 19:37:42 UTC (rev 1254)
@@ -844,10 +844,14 @@
     } else if (s0 && s1 && c0.response==STONE_REBOUND && c1.response==STONE_REBOUND) {
         // join stones to a block without rounded edges
         find_contact_with_stone(a, p1, c1, winFacesActorStone, false, s1);  // collision with straight neighbour only
+        if (c1.normal*(a->get_actorinfo()->vel) >= 0 /* &&  s1 has restituion 1.0 */)  // leaving a oneway or door
+            find_contact_with_stone(a, p0, c0, winFacesActorStone, true, s0);          // collide with diagonal stone
         find_contact_with_stone(a, p2, c2, winFacesActorStone, true, s2);   // register contact without collision
     } else if (s0 && s2 && c0.response==STONE_REBOUND && c2.response==STONE_REBOUND) {
         // join stones to a block without rounded edges
         find_contact_with_stone(a, p2, c2, winFacesActorStone, false, s2);  // contact with straight neighbour only
+        if (c2.normal*(a->get_actorinfo()->vel) >= 0 /* &&  s2 has restituion 1.0 */)  // leaving a oneway or door
+            find_contact_with_stone(a, p0, c0, winFacesActorStone, true, s0);          // collide with diagonal stone
         find_contact_with_stone(a, p1, c1, winFacesActorStone, true, s1);   // register contact without collision
     } else {
         // register single stone collisions and contacts



From ral at mail.berlios.de  Sun Aug  3 22:35:35 2008
From: ral at mail.berlios.de (ral at BerliOS)
Date: Sun, 3 Aug 2008 22:35:35 +0200
Subject: [Enigma-game-svn] r1255 - trunk/src
Message-ID: <200808032035.m73KZZcS008281@sheep.berlios.de>

Author: ral
Date: 2008-08-03 22:35:34 +0200 (Sun, 03 Aug 2008)
New Revision: 1255

Modified:
   trunk/src/world.cc
   trunk/src/world_internal.hh
Log:
Trunk 1.1:
- fix old actor stuck problem:
  - actors that did already check for collisions could move to grid positions
    on which meanwhile stones had been set, e.g. turnstile arms by green
    pivot
  - solution:
    - register critical positions
    - just do not move affected actors for one timestep

Modified: trunk/src/world.cc
===================================================================
--- trunk/src/world.cc	2008-08-03 19:37:42 UTC (rev 1254)
+++ trunk/src/world.cc	2008-08-03 20:35:34 UTC (rev 1255)
@@ -410,6 +410,7 @@
     for (unsigned i=0; i<changed_stones.size(); ++i)
         stone_change(changed_stones[i]);
     changed_stones.clear();
+    
 
     m_mouseforce.tick (dtime);
     for_each (forces.begin(), forces.end(),
@@ -1279,6 +1280,8 @@
         }
         
         handle_actor_contacts();
+        collisionCriticalPositions.clear();
+        registerCriticalPositions = true;
         for (unsigned i=0; i<nactors; ++i) {
             Actor     *a  = actorlist[i];
             ActorInfo &ai = * a->get_actorinfo();
@@ -1301,6 +1304,7 @@
             a->move();         // 'move' nevertheless, to pick up items etc
             a->think(dtime); 
         }
+        registerCriticalPositions = false;
 
         rest_time -= dt;
     }
@@ -1361,9 +1365,19 @@
     if (ai.pos[1] < 0) ai.pos[1] = 0.0;
     if (ai.pos[1] >= h) ai.pos[1] = h - 1e-12;
     
-    // disallow direct diagonal grid moves
+    
     GridPos oldGridPos(oldPos);
     GridPos newGridPos(ai.pos);
+    //
+    for (std::list<GridPos>::iterator itr = collisionCriticalPositions.begin(); itr != collisionCriticalPositions.end(); ++itr) {
+        if (*itr == newGridPos) {
+            ai.pos = oldPos;
+            newGridPos = oldGridPos;
+            break;
+        }
+    }
+    
+    // disallow direct diagonal grid moves
     if (oldGridPos.x != newGridPos.x && oldGridPos.y != newGridPos.y) {
         // split diagonal grid move in the middle of the path over the missed grid
         V2 newPos = ai.pos;
@@ -1979,6 +1993,8 @@
 void SetStone(GridPos p, Stone* st) {
     level->st_layer.set(p,st);
     level->changed_stones.push_back(p);
+    if (level->registerCriticalPositions)
+        level->collisionCriticalPositions.push_back(p);
 }
 
 void ReplaceStone (GridPos p, Stone* st) {

Modified: trunk/src/world_internal.hh
===================================================================
--- trunk/src/world_internal.hh	2008-08-03 19:37:42 UTC (rev 1254)
+++ trunk/src/world_internal.hh	2008-08-03 20:35:34 UTC (rev 1255)
@@ -319,7 +319,9 @@
         //! True if game is not running yet
         bool                 preparing_level;
 
-        vector<GridPos>      changed_stones;
+        std::vector<GridPos> changed_stones;
+        std::list<GridPos>   collisionCriticalPositions;  // stones set to positions after collision check
+        bool                 registerCriticalPositions;
 
         SoundDampingList     sound_dampings; // see SoundEffectManager for details
 



From ral at mail.berlios.de  Wed Aug  6 00:30:13 2008
From: ral at mail.berlios.de (ral at BerliOS)
Date: Wed, 6 Aug 2008 00:30:13 +0200
Subject: [Enigma-game-svn] r1256 - in trunk: data data/schemas src src/stones
Message-ID: <200808052230.m75MUDZA017806@sheep.berlios.de>

Author: ral
Date: 2008-08-06 00:30:09 +0200 (Wed, 06 Aug 2008)
New Revision: 1256

Added:
   trunk/src/stones/OneWayStone.cc
   trunk/src/stones/OneWayStone.hh
Modified:
   trunk/data/api1init.lua
   trunk/data/schemas/objects.xml
   trunk/src/Makefile.am
   trunk/src/ox_extra.cc
   trunk/src/ox_magnum.cc
   trunk/src/ox_oxyd1.cc
   trunk/src/ox_peroxyd.cc
   trunk/src/stones.hh
   trunk/src/stones_complex.cc
Log:
Trunk 1.1: new API reengineering
- oneway stone:
  - new name st_oneway, st_oneway_black/white
  - attribute state equals orientation
  - attribute color (nil, BLACK, WHITE) (like st_switch)
  - messages orientate, flip, signal
  - fix colorless oneway can be flipped by a marble with wand while jumping
  - fix bug and horse pass colorless oneway


Modified: trunk/data/api1init.lua
===================================================================
--- trunk/data/api1init.lua	2008-08-03 20:35:34 UTC (rev 1255)
+++ trunk/data/api1init.lua	2008-08-05 22:30:09 UTC (rev 1256)
@@ -170,6 +170,21 @@
     
     st_monoflop = "st-timeswitch",
     st_oxyd = "st-oxyd",
+    st_oneway = "st-oneway",
+    st_oneway_n = "st-oneway-n",
+    st_oneway_e = "st-oneway-e",
+    st_oneway_s = "st-oneway-s",
+    st_oneway_w = "st-oneway-w",
+    st_oneway_black = "st-oneway_black",
+    st_oneway_black_n = "st-oneway_black-n",
+    st_oneway_black_e = "st-oneway_black-e",
+    st_oneway_black_s = "st-oneway_black-s",
+    st_oneway_black_w = "st-oneway_black-w",
+    st_oneway_white = "st-oneway_white",
+    st_oneway_white_n = "st-oneway_white-n",
+    st_oneway_white_e = "st-oneway_white-e",
+    st_oneway_white_s = "st-oneway_white-s",
+    st_oneway_white_w = "st-oneway_white-w",
     st_panel = "st-wood_001",
     st_polarswitch = "st-polarswitch",
     st_rotator_cw = "st-rotator-right",

Modified: trunk/data/schemas/objects.xml
===================================================================
--- trunk/data/schemas/objects.xml	2008-08-03 20:35:34 UTC (rev 1255)
+++ trunk/data/schemas/objects.xml	2008-08-05 22:30:09 UTC (rev 1256)
@@ -579,6 +579,19 @@
       <msg name="close"/>
       <msg name="signal"/>
     </object>
+    <object name="st_oneway" states="4">
+      <attr name="color"/>
+      <attr name="orientation"/>
+      <msg name="flip"/>
+      <msg name="orientate"/>
+      <msg name="signal"/>
+    </object>
+    <object name="st_oneway_black">
+      <attr name="color" value="0"/>
+    </object>
+    <object name="st_oneway_white">
+      <attr name="color" value="1"/>
+    </object>
     <object name="st_oxyd_a">
       <attr name="flavor" value="a"/>
     </object>

Modified: trunk/src/Makefile.am
===================================================================
--- trunk/src/Makefile.am	2008-08-03 20:35:34 UTC (rev 1255)
+++ trunk/src/Makefile.am	2008-08-05 22:30:09 UTC (rev 1256)
@@ -241,6 +241,8 @@
 	stones/MirrorStone.hh	\
 	stones/MonoFlopStone.cc	\
 	stones/MonoFlopStone.hh	\
+	stones/OneWayStone.cc	\
+	stoned/OneWayStone.hh	\
 	stones/OxydStone.cc	\
 	stones/OxydStone.hh	\
 	stones/PolarSwitchStone.cc	\

Modified: trunk/src/ox_extra.cc
===================================================================
--- trunk/src/ox_extra.cc	2008-08-03 20:35:34 UTC (rev 1255)
+++ trunk/src/ox_extra.cc	2008-08-05 22:30:09 UTC (rev 1256)
@@ -165,10 +165,10 @@
     UNUSED,              // OxydExtra stone 0x2e
     "st_death",          // OxydExtra stone 0x2f
     "st_death_invisible", // OxydExtra stone 0x30
-    "st-oneway_black-w", // OxydExtra stone 0x31
+    "st_oneway_black_w", // OxydExtra stone 0x31
     UNUSED,              // OxydExtra stone 0x32
-    "st-oneway_black-n", // OxydExtra stone 0x33
-    "st-oneway_black-s", // OxydExtra stone 0x34
+    "st_oneway_black_n", // OxydExtra stone 0x33
+    "st_oneway_black_s", // OxydExtra stone 0x34
     UNUSED,              // OxydExtra stone 0x35
     UNUSED,              // OxydExtra stone 0x36
     UNUSED,              // OxydExtra stone 0x37

Modified: trunk/src/ox_magnum.cc
===================================================================
--- trunk/src/ox_magnum.cc	2008-08-03 20:35:34 UTC (rev 1255)
+++ trunk/src/ox_magnum.cc	2008-08-05 22:30:09 UTC (rev 1256)
@@ -170,14 +170,14 @@
     "st_fourswitch",            // OxydMagnum stone 0x33 (Level 51 and 100)
     "st_death",                 // OxydMagnum stone 0x34
     "st_death_invisible",       // OxydMagnum stone 0x35
-    "st-oneway_black-w",        // OxydMagnum stone 0x36
-    "st-oneway_black-e",        // OxydMagnum stone 0x37
-    "st-oneway_black-n",        // OxydMagnum stone 0x38
-    "st-oneway_black-s",        // OxydMagnum stone 0x39
-    "st-oneway_white-w",        // OxydMagnum stone 0x3a
-    "st-oneway_white-e",        // OxydMagnum stone 0x3b
-    "st-oneway_white-n",        // OxydMagnum stone 0x3c
-    "st-oneway_white-s",        // OxydMagnum stone 0x3d
+    "st_oneway_black_w",        // OxydMagnum stone 0x36
+    "st_oneway_black_e",        // OxydMagnum stone 0x37
+    "st_oneway_black_n",        // OxydMagnum stone 0x38
+    "st_oneway_black_s",        // OxydMagnum stone 0x39
+    "st_oneway_white_w",        // OxydMagnum stone 0x3a
+    "st_oneway_white_e",        // OxydMagnum stone 0x3b
+    "st_oneway_white_n",        // OxydMagnum stone 0x3c
+    "st_oneway_white_s",        // OxydMagnum stone 0x3d
     UNUSED,                     // OxydMagnum stone 0x3e
     UNUSED,                     // OxydMagnum stone 0x3f
     UNUSED,                     // OxydMagnum stone 0x40

Modified: trunk/src/ox_oxyd1.cc
===================================================================
--- trunk/src/ox_oxyd1.cc	2008-08-03 20:35:34 UTC (rev 1255)
+++ trunk/src/ox_oxyd1.cc	2008-08-05 22:30:09 UTC (rev 1256)
@@ -202,14 +202,14 @@
     0,                          // Oxyd1 stone 0x33 oscillator (properties set in oxyd.cc)
     "st_death",                 // Oxyd1 stone 0x34
     "st_death_invisible",       // Oxyd1 stone 0x35
-    "st-oneway_black-w",        // Oxyd1 stone 0x36
-    "st-oneway_black-e",        // Oxyd1 stone 0x37
-    "st-oneway_black-n",        // Oxyd1 stone 0x38
-    "st-oneway_black-s",        // Oxyd1 stone 0x39
-    "st-oneway_white-w",        // Oxyd1 stone 0x3a
-    "st-oneway_white-e",        // Oxyd1 stone 0x3b
-    "st-oneway_white-n",        // Oxyd1 stone 0x3c
-    "st-oneway_white-s",        // Oxyd1 stone 0x3d
+    "st_oneway_black_w",        // Oxyd1 stone 0x36
+    "st_oneway_black_e",        // Oxyd1 stone 0x37
+    "st_oneway_black_n",        // Oxyd1 stone 0x38
+    "st_oneway_black_s",        // Oxyd1 stone 0x39
+    "st_oneway_white_w",        // Oxyd1 stone 0x3a
+    "st_oneway_white_e",        // Oxyd1 stone 0x3b
+    "st_oneway_white_n",        // Oxyd1 stone 0x3c
+    "st_oneway_white_s",        // Oxyd1 stone 0x3d
     "st_window",                // Oxyd1 stone 0x3e
     "",                         // Oxyd1 stone 0x3f magic stone
     "",                         // Oxyd1 stone 0x40 magic stone

Modified: trunk/src/ox_peroxyd.cc
===================================================================
--- trunk/src/ox_peroxyd.cc	2008-08-03 20:35:34 UTC (rev 1255)
+++ trunk/src/ox_peroxyd.cc	2008-08-05 22:30:09 UTC (rev 1256)
@@ -237,14 +237,14 @@
     "",                         // PerOxyd stone 0x2e (?)
     "st_death",                 // PerOxyd stone 0x2f
     "st_death_invisible",       // PerOxyd stone 0x30
-    "st-oneway_black-w",        // PerOxyd stone 0x31
-    "st-oneway_black-e",        // PerOxyd stone 0x32
-    "st-oneway_black-n",        // PerOxyd stone 0x33
-    "st-oneway_black-s",        // PerOxyd stone 0x34
-    "st-oneway_white-w",        // PerOxyd stone 0x35
-    "st-oneway_white-e",        // PerOxyd stone 0x36
-    "st-oneway_white-n",        // PerOxyd stone 0x37
-    "st-oneway_white-s",        // PerOxyd stone 0x38
+    "st_oneway_black_w",        // PerOxyd stone 0x31
+    "st_oneway_black_e",        // PerOxyd stone 0x32
+    "st_oneway_black_n",        // PerOxyd stone 0x33
+    "st_oneway_black_s",        // PerOxyd stone 0x34
+    "st_oneway_white_w",        // PerOxyd stone 0x35
+    "st_oneway_white_e",        // PerOxyd stone 0x36
+    "st_oneway_white_n",        // PerOxyd stone 0x37
+    "st_oneway_white_s",        // PerOxyd stone 0x38
     "st-magic",                 // PerOxyd stone 0x39 ('st-magic')
     "st-magic",                 // PerOxyd stone 0x3a ('st-magic')
     "st-magic",                 // PerOxyd stone 0x3b ('st-magic')

Added: trunk/src/stones/OneWayStone.cc
===================================================================
--- trunk/src/stones/OneWayStone.cc	2008-08-03 20:35:34 UTC (rev 1255)
+++ trunk/src/stones/OneWayStone.cc	2008-08-05 22:30:09 UTC (rev 1256)
@@ -0,0 +1,138 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *  
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include "stones/OneWayStone.hh"
+//#include "main.hh"
+#include "player.hh"
+
+namespace enigma {
+    OneWayStone::OneWayStone(Value color, Direction dir) : Stone () {
+        state = dir;
+        setAttr("color", color);
+    }
+
+    std::string OneWayStone::getClass() const {
+        return "st_oneway";
+    }
+        
+    void OneWayStone::setAttr(const string& key, const Value &val) {
+        if (key == "color" && isDisplayable()) {
+            Stone::setAttr(key, val);
+            init_model();    // need to redisplay after attribute set
+            return;
+        } else if (key == "orientation") {
+            if (val >= minState() && val <= maxState())
+                setState(val);
+        }
+        Stone::setAttr(key, val);
+    }
+    
+    Value OneWayStone::getAttr(const std::string &key) const {
+        if (key == "orientation") {
+            return state;
+        } else
+            return Stone::getAttr(key);
+    }
+    
+    Value OneWayStone::message(const Message &m) {
+        if (m.message == "orientate") {
+            setAttr("state", m.value);   // enforce value check
+            return Value();
+        } else if (m.message == "signal" || m.message == "flip") {
+            setState(reverse((Direction)state));
+            return Value();
+        }
+        return Stone::message(m);
+    }
+            
+    int OneWayStone::maxState() const {
+        return 3;  // dir representing state
+    }
+
+    void OneWayStone::init_model() {
+        set_model(ecl::strf("st-oneway%s%s", colorName(), to_suffix((Direction)state).c_str()));
+    }
+    
+    bool OneWayStone::is_floating() const {
+        return true;
+    }
+    
+    StoneResponse OneWayStone::collision_response(const StoneContact &sc) {
+        Value c = getAttr("color");
+        Value accolor = sc.actor->getAttr("color");
+        
+        if (!sc.actor->is_flying() && (!c || c == accolor)) {
+            StoneResponse result = STONE_PASS;
+            if ((state == WEST && (get_pos().x >= sc.actor->get_pos()[0])) ||
+                    (state == SOUTH && (get_pos().y + 1 <= sc.actor->get_pos()[1])) ||
+                    (state == EAST && (get_pos().x + 1 <= sc.actor->get_pos()[0])) ||
+                    (state == NORTH && (get_pos().y >= sc.actor->get_pos()[1])))
+                result = STONE_REBOUND;
+            return result;
+        }
+        else
+            return STONE_REBOUND;
+    }
+    
+    void OneWayStone::actor_hit(const StoneContact &sc) {
+        Value c = getAttr("color");
+        
+        if (!c && player::WieldedItemIs (sc.actor, "it_magicwand")) {
+            setState(reverse((Direction)state));
+        }
+    }
+
+    int OneWayStone::iColor() const {
+        Value v = getAttr("color");
+        return v ? (int)v + 1 : 0;
+    }
+    
+    const char* OneWayStone::colorName() const {
+        switch (iColor()) {
+            case 1:
+                return "_black";
+            case 2:
+                return "_white";
+            default: ;
+         }
+        return "";
+    }
+    
+    DEF_TRAITS(OneWayStone, "st_oneway", st_oneway);
+    
+    BOOT_REGISTER_START
+        BootRegister(new OneWayStone(Value(), NORTH), "st_oneway");
+        BootRegister(new OneWayStone(Value(), NORTH), "st_oneway_n");
+        BootRegister(new OneWayStone(Value(), EAST),  "st_oneway_e");
+        BootRegister(new OneWayStone(Value(), SOUTH), "st_oneway_s");
+        BootRegister(new OneWayStone(Value(), WEST),  "st_oneway_w");
+        BootRegister(new OneWayStone(Value(BLACK),NORTH), "st_oneway_black");
+        BootRegister(new OneWayStone(Value(BLACK),NORTH), "st_oneway_black_n");
+        BootRegister(new OneWayStone(Value(BLACK),EAST),  "st_oneway_black_e");
+        BootRegister(new OneWayStone(Value(BLACK),SOUTH), "st_oneway_black_s");
+        BootRegister(new OneWayStone(Value(BLACK),WEST),  "st_oneway_black_w");
+        BootRegister(new OneWayStone(Value(WHITE),NORTH), "st_oneway_white");
+        BootRegister(new OneWayStone(Value(WHITE),NORTH), "st_oneway_white_n");
+        BootRegister(new OneWayStone(Value(WHITE),EAST),  "st_oneway_white_e");
+        BootRegister(new OneWayStone(Value(WHITE),SOUTH), "st_oneway_white_s");
+        BootRegister(new OneWayStone(Value(WHITE),WEST),  "st_oneway_white_w");
+    BOOT_REGISTER_END
+
+} // namespace enigma


Property changes on: trunk/src/stones/OneWayStone.cc
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/stones/OneWayStone.hh
===================================================================
--- trunk/src/stones/OneWayStone.hh	2008-08-03 20:35:34 UTC (rev 1255)
+++ trunk/src/stones/OneWayStone.hh	2008-08-05 22:30:09 UTC (rev 1256)
@@ -0,0 +1,63 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef ONEWAYSTONE_HH
+#define ONEWAYSTONE_HH
+
+#include "stones.hh"
+
+#include "stones_internal.hh"
+
+namespace enigma {
+
+    /** 
+     * state is orientation
+     */
+    class OneWayStone : public Stone {
+        CLONEOBJ(OneWayStone);
+        DECL_TRAITS;
+
+    public:
+        OneWayStone(Value color, Direction dir);
+        
+        // Object interface
+        virtual std::string getClass() const;
+        virtual void setAttr(const string& key, const Value &val);
+        virtual Value getAttr(const std::string &key) const;
+        virtual Value message(const Message &m);
+        
+        // StateObject interface
+        virtual int maxState() const;
+
+        // GridObject interface
+        virtual void init_model();
+        
+        // Stone interface
+        virtual bool is_floating() const;
+        virtual StoneResponse collision_response(const StoneContact &sc);
+        virtual void actor_hit(const StoneContact &sc);
+        
+    private:
+        int iColor() const;
+        const char* colorName() const;
+    };
+
+} // namespace enigma
+
+#endif


Property changes on: trunk/src/stones/OneWayStone.hh
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/src/stones.hh
===================================================================
--- trunk/src/stones.hh	2008-08-03 20:35:34 UTC (rev 1255)
+++ trunk/src/stones.hh	2008-08-05 22:30:09 UTC (rev 1256)
@@ -69,8 +69,6 @@
         st_mirror,
         st_movebreak,
         st_oneway,
-        st_oneway_black,
-        st_oneway_white,
         st_oxyd_0x18,
         st_peroxyd_0xb8,
         st_peroxyd_0xb9,
@@ -194,7 +192,7 @@
         virtual bool   is_removable() const { return true; }
 
         /*! Is this stone floating above the floor (e.g. actors may pass)? */
-        virtual bool   is_floating() const { return false; }
+        virtual bool is_floating() const { return false; }
         
         /*! Can laser beams pass through stone? Return is_floating() by default. */
         virtual bool   is_transparent (Direction d) const { 

Modified: trunk/src/stones_complex.cc
===================================================================
--- trunk/src/stones_complex.cc	2008-08-03 20:35:34 UTC (rev 1255)
+++ trunk/src/stones_complex.cc	2008-08-05 22:30:09 UTC (rev 1256)
@@ -242,139 +242,6 @@
     sound_event("moveslow");
 }
 
-
-/* -------------------- Oneway stones -------------------- */
-
-// These stone can only be passed in one direction.
-
-namespace
-{
-    class OneWayBase : public Stone {
-    protected:
-        OneWayBase(Direction dir);
-
-        void init_model();
-        virtual Value message(const Message &m);
-
-        void actor_hit (const StoneContact&);
-        StoneResponse collision_response(const StoneContact &sc);
-        bool is_floating() const { return true; }
-
-        Direction get_orientation() const {
-            return to_direction(getAttr("orientation"));
-        }
-        void set_orientation(Direction dir) {
-            setAttr("orientation", Value(dir));
-        }
-
-        virtual bool actor_may_pass (Actor *a) = 0;
-    };
-
-    class OneWayStone : public OneWayBase {
-    public:
-        OneWayStone(Direction dir=SOUTH) : OneWayBase(dir) {}
-    private:
-        CLONEOBJ(OneWayStone);
-        DECL_TRAITS;
-        virtual bool actor_may_pass (Actor *a) {
-            const ActorTraits &at = a->get_traits();
-            return at.id != ac_bug && at.id != ac_horse;
-        }
-    };
-    DEF_TRAITS(OneWayStone, "st-oneway", st_oneway);
-
-    class OneWayStone_black : public OneWayBase {
-    public:
-        OneWayStone_black(Direction dir=SOUTH)
-            : OneWayBase(dir) {}
-    private:
-        CLONEOBJ(OneWayStone_black);
-        DECL_TRAITS;
-        virtual bool actor_may_pass (Actor *a) {
-            Value accolor = a->getAttr("color");
-            return accolor && accolor == BLACK;
-        }
-        void actor_hit (const StoneContact&) {
-            // do nothing if hit by actor
-        }
-    };
-    DEF_TRAITS(OneWayStone_black, "st-oneway_black", st_oneway_black);
-
-    class OneWayStone_white : public OneWayBase {
-    public:
-        OneWayStone_white(Direction dir=SOUTH)
-            : OneWayBase(dir) {}
-    private:
-        CLONEOBJ(OneWayStone_white);
-        DECL_TRAITS;
-        virtual bool actor_may_pass (Actor *a) {
-            Value accolor = a->getAttr("color");
-            return accolor && accolor == WHITE;
-        }
-        void actor_hit (const StoneContact&) {
-            // do nothing if hit by actor
-        }
-    };
-    DEF_TRAITS(OneWayStone_white, "st-oneway_white", st_oneway_white);
-}
-
-OneWayBase::OneWayBase(Direction dir)
-{
-    set_orientation(dir);
-}
-
-void OneWayBase::init_model()
-{
-    string mname = get_kind();
-    mname += to_suffix(get_orientation());
-    set_model (mname);
-}
-
-Value OneWayBase::message(const Message &m) {
-    if (m.message == "direction" && m.value.getType() == Value::DOUBLE) {
-        set_orientation(to_direction(m.value));
-        init_model();
-        return Value();
-    }
-    else if (m.message == "signal" || m.message == "flip") {
-        Direction dir = get_orientation();
-        set_orientation(reverse(dir));
-        init_model();
-        return Value();
-    }
-    return Stone::message(m);
-}
-
-void OneWayBase::actor_hit(const StoneContact &sc) {
-    Direction o=get_orientation();
-
-    if (has_dir(contact_faces(sc), o)) {
-        if (player::WieldedItemIs (sc.actor, "it_magicwand")) {
-            set_orientation(reverse(o));
-            init_model();
-        }
-    }
-}
-
-StoneResponse OneWayBase::collision_response(const StoneContact &sc) {
-    DirectionBits dirs=contact_faces(sc);
-    Direction o=get_orientation();
-
-    if (!sc.actor->is_flying() && actor_may_pass(sc.actor)) {
-        StoneResponse result = STONE_PASS;
-        if ((o == WEST && (get_pos().x >= sc.actor->get_pos()[0])) ||
-                (o == SOUTH && (get_pos().y + 1 <= sc.actor->get_pos()[1])) ||
-                (o == EAST && (get_pos().x + 1 <= sc.actor->get_pos()[0])) ||
-                (o == NORTH && (get_pos().y >= sc.actor->get_pos()[1])))
-            result = STONE_REBOUND;
-        return result;
-//        return has_dir(dirs,o) ? STONE_REBOUND : STONE_PASS;
-    }
-    else
-        return STONE_REBOUND;
-}
-
-
 /* -------------------- Volcano -------------------- */
 namespace
 {
@@ -1862,23 +1729,6 @@
 
     Register(new MovableImpulseStone);
 
-    Register(new OneWayStone);
-    Register("st-oneway-n", new OneWayStone(NORTH));
-    Register("st-oneway-e", new OneWayStone(EAST));
-    Register("st-oneway-s", new OneWayStone(SOUTH));
-    Register("st-oneway-w", new OneWayStone(WEST));
-    Register(new OneWayStone_black);
-    Register("st-oneway_black-n", new OneWayStone_black(NORTH));
-    Register("st-oneway_black-e", new OneWayStone_black(EAST));
-    Register("st-oneway_black-s", new OneWayStone_black(SOUTH));
-    Register("st-oneway_black-w", new OneWayStone_black(WEST));
-    Register(new OneWayStone_white);
-    Register("st-oneway_white-n", new OneWayStone_white(NORTH));
-    Register("st-oneway_white-e", new OneWayStone_white(EAST));
-    Register("st-oneway_white-s", new OneWayStone_white(SOUTH));
-    Register("st-oneway_white-w", new OneWayStone_white(WEST));
-
-
     Register (new PullStone);
 
     Register( new VolcanoStone);



From raoul at mail.berlios.de  Thu Aug  7 14:34:18 2008
From: raoul at mail.berlios.de (raoul at BerliOS)
Date: Thu, 7 Aug 2008 14:34:18 +0200
Subject: [Enigma-game-svn] r1257 - team_levelpacks/team_test_new_api
Message-ID: <200808071234.m77CYILE001591@sheep.berlios.de>

Author: raoul
Date: 2008-08-07 14:34:17 +0200 (Thu, 07 Aug 2008)
New Revision: 1257

Modified:
   team_levelpacks/team_test_new_api/raoulT06_1.xml
Log:
-> Fixed testlevel



Modified: team_levelpacks/team_test_new_api/raoulT06_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/raoulT06_1.xml	2008-08-05 22:30:09 UTC (rev 1256)
+++ team_levelpacks/team_test_new_api/raoulT06_1.xml	2008-08-07 12:34:17 UTC (rev 1257)
@@ -18,26 +18,26 @@
 ti[" "] = {"fl-space"}
 ti["*"] = {"fl-wood"}
 
-ti["a"] = {"it_strip", friction=1, mousefactor=1}
+ti["a"] = {"it_strip", friction=1, adhesion=1}
 
-ti["b"] = {"it_strip_w", friction=1, mousefactor=1}
-ti["c"] = {"it_strip_s", friction=1, mousefactor=1}
-ti["d"] = {"it_strip_e", friction=1, mousefactor=1}
-ti["e"] = {"it_strip_n", friction=1, mousefactor=1}
+ti["b"] = {"it_strip_w", friction=1, adhesion=1}
+ti["c"] = {"it_strip_s", friction=1, adhesion=1}
+ti["d"] = {"it_strip_e", friction=1, adhesion=1}
+ti["e"] = {"it_strip_n", friction=1, adhesion=1}
 
-ti["f"] = {"it_strip_sw", friction=1, mousefactor=1}
-ti["g"] = {"it_strip_ew", friction=1, mousefactor=1}
-ti["h"] = {"it_strip_es", friction=1, mousefactor=1}
-ti["i"] = {"it_strip_nw", friction=1, mousefactor=1}
-ti["j"] = {"it_strip_ns", friction=1, mousefactor=1}
-ti["k"] = {"it_strip_ne", friction=1, mousefactor=1}
+ti["f"] = {"it_strip_sw", friction=1, adhesion=1}
+ti["g"] = {"it_strip_ew", friction=1, adhesion=1}
+ti["h"] = {"it_strip_es", friction=1, adhesion=1}
+ti["i"] = {"it_strip_nw", friction=1, adhesion=1}
+ti["j"] = {"it_strip_ns", friction=1, adhesion=1}
+ti["k"] = {"it_strip_ne", friction=1, adhesion=1}
 
-ti["m"] = {"it_strip_esw", friction=1, mousefactor=1}
-ti["n"] = {"it_strip_nsw", friction=1, mousefactor=1}
-ti["o"] = {"it_strip_new", friction=1, mousefactor=1}
-ti["p"] = {"it_strip_nes", friction=1, mousefactor=1}
+ti["m"] = {"it_strip_esw", friction=1, adhesion=1}
+ti["n"] = {"it_strip_nsw", friction=1, adhesion=1}
+ti["o"] = {"it_strip_new", friction=1, adhesion=1}
+ti["p"] = {"it_strip_nes", friction=1, adhesion=1}
 
-ti["q"] = {"it_strip_nesw", friction=1, mousefactor=1}
+ti["q"] = {"it_strip_nesw", friction=1, adhesion=1}
 
 ti["w"] = {"st-wood"}
 ti["v"] = {"st-plain_move"}



From andreasl at mail.berlios.de  Fri Aug  8 00:27:49 2008
From: andreasl at mail.berlios.de (andreasl at mail.berlios.de)
Date: Fri, 8 Aug 2008 00:27:49 +0200
Subject: [Enigma-game-svn] r1258 - in trunk/data: . levels/lib
Message-ID: <200808072227.m77MRniX023934@sheep.berlios.de>

Author: andreasl
Date: 2008-08-08 00:27:47 +0200 (Fri, 08 Aug 2008)
New Revision: 1258

Added:
   trunk/data/levels/lib/libmap.xml
Modified:
   trunk/data/api2init.lua
   trunk/data/levels/lib/libluatools.xml
Log:
Trunk (Libraries):
 - New map handling library libmap.xml with methods:
    - wo:newMap(defaultKey, arg1, arg2)
    - lib.map.concat_horizontally(map1, map2)  aka. map1 .. map2
    - lib.map.concat_vertically(map1, map2)    aka. map1 + map2
    - lib.map.fuse(arg1, arg2)                 aka. map1 * map2
    - lib.map.transform(map, op)               aka. map ^ op
    - lib.map.get(map, key)               aka. map[key]
    - lib.map.set(map, key, value)        aka. map[key] = value
    - lib.map.extend(map, key)            aka. map:extend(key)
    - lib.map.sub(map, arg1, arg2)        aka. map:sub(arg1, arg2)
    - lib.map.covers(map, pos)            aka. map:covers(pos)
    - lib.map.setDefaultKey(map, newkey)  aka. map:setDefaultKey(newkey)
    - lib.map.print(map, withXYCounts, left_separator, right_separator)
 - Removed (now obsolete) map handling functions from
   libluatools (only split_map_layers doesn't have
   a libmap-equivalent).
Note:
 - Maps are guaranteed to be complete, i.e. of
   rectangular shape. libluatools.complete_map
   hence became obsolete.
Todo:
 - Further differentiate libluatools.xml into
   liblua.xml and libmath.xml, possibly also
   libpermutations.xml
 - All levels using the map handling functions
   are temporarily broken.
 - drawMap etc. shall understand maps.


Modified: trunk/data/api2init.lua
===================================================================
--- trunk/data/api2init.lua	2008-08-07 12:34:17 UTC (rev 1257)
+++ trunk/data/api2init.lua	2008-08-07 22:27:47 UTC (rev 1258)
@@ -131,7 +131,6 @@
 SPOT_LIGHTPASSENGER =  16
 SPOT_TRAP           =  32
 
-
 -- Follower
 FOLLOW_NO     = 0
 FOLLOW_SCROLL = 1
@@ -140,13 +139,23 @@
 FOLLOW_FULLSCREEN = po(19, 12)
 FOLLOW_HALFSCREEN = po(9.5, 6)
 
+-- Read directions for maps
+MAP_DEFAULT = 0
+MAP_CW = 1
+MAP_180 = 2
+MAP_CCW = 3
+MAP_MIRROR_HORIZONTAL = 4
+MAP_MIRROR_VERTICAL = 5
+MAP_MIRROR_SLASH = 6
+MAP_MIRROR_BACKSLASH = 7
+
 ---------------------
 -- Utility Methods --
 ---------------------
 
 wo:_register("drawMap", 
     function (world, resolver, origin, ignore, map)
-        -- TODO check validity of arguements
+        -- TODO check validity of arguments
         local len = string.len(ignore)
         for y=1, #map do
             local linelen = string.len(map[y])
@@ -173,7 +182,7 @@
             dest = po(origin.x + arg2 - 1, origin.y + arg3 - 1)
             tile = arg4
         end
-        -- TODO check validity of arguements
+        -- TODO check validity of arguments
         for x = origin.x, dest.x do
             wo[{x, origin.y}] = tile
             if origin.y ~= dest.y then
@@ -197,7 +206,7 @@
             dest = po(origin.x + arg2 - 1, origin.y + arg3 - 1)
             tile = arg4
         end
-        -- TODO check validity of arguements
+        -- TODO check validity of arguments
         for x = origin.x, dest.x do
             for y = origin.y, dest.y do
                 wo[{x, y}] = tile

Modified: trunk/data/levels/lib/libluatools.xml
===================================================================
--- trunk/data/levels/lib/libluatools.xml	2008-08-07 12:34:17 UTC (rev 1257)
+++ trunk/data/levels/lib/libluatools.xml	2008-08-07 22:27:47 UTC (rev 1258)
@@ -5,7 +5,7 @@
       <el:identity el:title="" el:id="lib/libluatools"/>
       <el:version el:score="1" el:release="1" el:revision="3" el:status="released"/>
       <el:author  el:name="Enigma Team" el:email="" el:homepage=""/>
-      <el:copyright>Copyright ? 2007 Enigma Team</el:copyright>
+      <el:copyright>Copyright ? 2007, 2008 Enigma Team</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
       <el:compatibility el:enigma="1.00">
       </el:compatibility>
@@ -333,353 +333,6 @@
   return result
 end
 
----------------------------------------------------------------------
---  MAP  HANDLING
----------------------------------------------------------------------
-
--- A "map" is a table of strings, like it's used in most
--- graphical ways to describe a level, including API 2.
-
--- fuse_map_layers takes a list of maps or a table of maps
--- and returns a map, which is constructed from the others
--- in the following way:
---  Map1:  {"abc", "def"}
---  Map2:  {"ABC", "DEF"}
---  Map3:  {"123", "456"}
---  fuse_map_layers(Map1, Map2, Map3):
---         {"aA1bB2cC3", "dD4eE5fF6"}
--- Missing letters are replaced by " ".
--- This function can be used to combine several layers
--- (e.g. floors, stones, items, actors) into a common
--- (typically very large) map.
--- fuse_map_layers assumes that the input maps are all
--- using a key length of 1. Otherwise you should use
--- split_map_layers before applying fuse_map_layers.
-function luatools.fuse_map_layers(layer1, ...)
-  -- Understand arguments
-  local layers = {layer1, ...}
-  if table.getn(layers) == 1 then
-    layers = layer1
-  end
-  if type(layers) ~= "table" then
-    error("fuse_map_layers: Argument is not a table (map).")
-  end
-  -- Calculate new height and width
-  local max_lines, max_length = 0, 0
-  for _, layer in pairs(layers) do
-    if type(layer) ~= "table" then
-      error("fuse_map_layers: Argument is not a table.")
-    end
-    max_lines = math.max(max_lines, table.getn(layer))
-    for _, line in pairs(layer) do
-      if type(line) ~= "string" then
-        error("fuse_map_layers: Line in table (map) is not a string.")
-      end
-      max_length = math.max(max_length, string.len(line))
-    end
-  end
-  local result = {}
-  -- Create result
-  local result = {}
-  for y = 1, max_lines do
-    result[y] = ""
-    for x = 1, max_length do
-      for _, layer in pairs(layers) do
-        if layer[y] and (string.len(layer[y]) >= x ) then
-          result[y] = result[y] .. string.sub(layer[y], x, x)
-        else
-          result[y] = result[y] .. " "
-        end
-      end
-    end
-  end
-  return result
-end
-
--- split_map_layers takes a map, splits it into KEYLENGTH
--- layers and returns a table of layers. It's the opposite
--- to fuse_map_layers.
-function luatools.split_map_layers(keylength, map)
-  -- Analyse arguments
-  if type(keylength) ~= "number" then
-    error("split_map_layers: First argument should be a number (key length).")
-  end
-  if type(map) ~= "table" then
-    error("split_map_layers: Second argument should be a table (map).")
-  end
-  -- Split layers
-  local layers = {}
-  for j = 1, keylength do
-    layers[j] = {}
-  end
-  for y, line in pairs(map) do
-    if type(line) ~= "string" then
-      error("print_map: Line is not a string.")
-    end
-    for j = 1, keylength do
-      layers[j][y] = ""
-    end
-    for x = 1, string.len(line) do
-      local j = luatools.mod(x - 1, keylength) + 1
-      layers[j][y] = layers[j][y]..string.sub(line, x, x)
-    end
-  end
-  return layers
-end
-
--- concat_maps_horizontally takes a list of maps or a table of
--- maps and returns a map, which is constructed from the others
--- in the following way:
---  Map1:  {"abc", "def"}
---  Map2:  {"ABC", "DEF"}
---  Map3:  {"123", "456"}
---  concat_maps_horizontally(Map1, Map2, Map3):
---         {"abcABC123", "defDEF456"}
--- Missing letters are replaced by " ".
--- This function can be used to combine several rooms
--- or areas of a map to build a larger map.
--- Note that concat_maps_horizontally doesn't take an
--- offset value for a vertical shift of the maps!
-function luatools.concat_maps_horizontally(map1, ...)
-  -- Understand arguments
-  local maps = {map1, ...}
-  if table.getn(maps) == 1 then
-    maps = map1
-  end
-  if type(maps) ~= "table" then
-    error("concat_maps_horizontally: Argument is not a table (map).")
-  end
-  -- Find maximal line lengths and height
-  local lengths = {}
-  local height = 0
-  for j, map in pairs(maps) do
-    lengths[j] = 0
-    for y, line in pairs(map) do
-      lengths[j] = math.max(lengths[j], string.len(line))
-      height = math.max(height, y)
-    end
-  end
-  -- Concat to result
-  local result = {}
-  for y = 1, height do
-    result[y] = ""
-    for j, map in pairs(maps) do
-      result[y] = result[y] .. (map[y] or "")
-                    .. string.rep(" ", lengths[j] - string.len(map[y] or "")) 
-    end
-  end
-  return result
-end
-
--- concat_maps_vertically takes a list of maps or a table of
--- maps and returns a map, which is constructed from the others
--- in the following way:
---  Map1:  {"abc", "def"}
---  Map2:  {"ABC", "DEF"}
---  Map3:  {"123", "456"}
---  concat_maps_vertically(Map1, Map2, Map3):
---         {"abc", "def", "ABC", "DEF", "123", "456"}
--- This function can be used to combine several rooms
--- or areas of a map to build a larger map.
--- Note that concat_maps_vertically doesn't take an
--- offset value for a horizontal shift of the maps!
-function luatools.concat_maps_vertically(map1, ...)
-  -- Understand arguments
-  local maps = {map1, ...}
-  if table.getn(maps) == 1 then
-    maps = map1
-  end
-  if type(maps) ~= "table" then
-    error("concat_maps_vertically: Argument is not a table (map).")
-  end
-  -- Create result
-  local result = {}
-  for j, map in pairs(maps) do
-    for y, line in pairs(map) do
-      table.insert(result, line)
-    end
-  end
-  return result
-end
-  
--- get_key_in_map returns the key of MAP at position POSARG.
--- KEYLENGTH can be a number or a string (then its length is
--- considered to be the keylength). Returns nil if POSARG is
--- not described in map.
-function luatools.get_key_in_map(map, keylength, posarg)
-  if type(map) ~= "table" then
-    error("get_key_in_map: First argument is not a table (map).")
-  end
-  if ((type(keylength) ~= "string") and (type(keylength) ~= "number"))
-      or ((type(keylength) == "number") and (keylength ~= math.floor(keylength))) then
-    error("get_key_in_map: Second argument is not an integer or string (keylength).")
-  end
-  local kl = keylength
-  if type(kl) == "string" then
-    kl = string.len(kl)
-  end
-  local pos = posarg
-  if type(pos) ~= "userdata" then
-    pos = po(posarg)
-  end
-  local px, py = math.floor(pos.x), math.floor(pos.y)
-  if (type(px) ~= "number") and (type(py) ~= "number") then
-    error("get_key_in_map: Can't interpret third argument as position.")
-  end
-  if not map[py] then
-    return nil
-  end
-  if string.len(map[py]) < kl * px then
-    return nil
-  end
-  return string.sub(map[py], kl * (px - 1) + 1, kl * px)  
-end
-
--- insert_key_in_map inserts key KEY at position POSARG
--- into the map MAP, which is assumed to be a table of
--- strings, and returns the result. The key length of the
--- map is assumed to be the length of KEY, so partial keys
--- are not supported. Missing entries are filled with a
--- neccessary number of spaces.
-function luatools.insert_key_in_map(map, key, posarg)
-  if type(map) ~= "table" then
-    error("insert_key_in_map: First argument is not a table (map).")
-  end
-  if type(key) ~= "string" then
-    error("insert_key_in_map: Second argument is not a string (key).")
-  end
-  if key == "" then
-    error("insert_key_in_map: Second argument (key) is empty.")
-  end
-  local pos = posarg
-  if type(pos) ~= "userdata" then
-    pos = po(posarg)
-  end
-  local px, py = math.floor(pos.x), math.floor(pos.y)
-  if (type(px) ~= "number") and (type(py) ~= "number") then
-    error("insert_key_in_map: Can't interpret third argument as position.")
-  end
-  local keylength = string.len(key)
-  local result = {}
-  for y = 1, math.max(#map, py) do
-    if y ~= py then
-      result[y] = map[y] or ""
-    else
-      local delta = keylength * (px - 1) - string.len(map[y])
-      if delta >= 0 then
-        -- Line of map has to be expanded.
-        result[y] = (map[y] or "") .. string.rep(" ", delta) .. key
-      else
-        -- Insert key into map (old key is deleted).
-        result[y] = string.sub(map[y], 1, keylength * (px - 1)) .. key ..
-                      string.sub(map[y], keylength * px + 1, string.len(map[y]))
-      end
-    end
-  end
-  return result  
-end
-
--- complete_map returns a rectangularly completed version
--- of MAP, with " " as fillers.
-function luatools.complete_map(map)
-  if type(map) ~= "table" then
-    error("complete_map: Argument is not a table (map).")
-  end
-  local width = 0
-  local height = 0
-  local result = {}
-  for key, entry in pairs(map) do
-    height = math.max(height, tonumber(key) or 0)
-    if type(entry) == "string" then
-      width = math.max(width, string.len(entry))
-    else
-      -- Odd entry. Report if key is a number
-      -- (i.e. non-number user keys are allowed).
-      if type(key) == "number" then
-        error("complete_map: Line " .. key .. " in map is not a string, but "
-              .. type(entry) .. ".")
-      else
-        result[key] = luatools.deep_copy(entry)
-      end
-    end
-  end
-  for y = 1, height do
-    result[y] = map[y] or ""
-    result[y] = result[y] .. string.rep(" ", width - string.len(result[y]))
-  end
-  return result
-end
-
--- mirror_map_vertically returns MAP, mirrored along a
--- horizontal axis (i.e. North and South are inverted).
--- Missing entries are replaced with " ".
-function luatools.mirror_map_vertically(map)
-  if type(map) ~= "table" then
-    error("mirror_map_vertically: Argument is not a table (map).")
-  end
-  local completed = luatools.complete_map(map)
-  local result = {}
-  for key, entry in pairs(completed) do
-    if type(key) == "number" then
-      result[table.getn(completed) - key + 1] = entry
-    else
-      result[key] = luatools.deep_copy(entry)
-    end
-  end  
-  return result
-end
-
--- mirror_map_horizontally returns MAP, mirrored along
--- a vertical axis (i.e. East and West are inverted).
--- The keylength given by KEY (example tile key or number)
--- is respected.
-function luatools.mirror_map_horizontally(map, keylength)
-  if type(map) ~= "table" then
-    error("mirror_map_horizontally: Argument is not a table (map).")
-  end
-  if ((type(keylength) ~= "string") and (type(keylength) ~= "number"))
-      or ((type(keylength) == "number") and (keylength ~= math.floor(keylength))) then
-    error("mirror_map_horizontally: Second argument is not an integer or string (keylength).")
-  end
-  local kl = keylength
-  if type(kl) == "string" then
-    kl = string.len(kl)
-  end
-  local completed = luatools.complete_map(map)
-  local map_width = string.len(completed[1] or "") / kl
-  if math.ceil(map_width) ~= map_width then
-    error("mirror_map_horizontally: Map is odd (broken key length).")
-  end
-  local result = {}
-  for v, entry in pairs(completed) do
-    if type(v) == "number" then
-      for j = 1, map_width do
-        local x = kl * (map_width - j)
-        result[v] = (result[v] or "") .. string.sub(entry, x + 1, x + kl)
-      end
-    else
-      result[v] = luatools.deep_copy(entry)
-    end
-  end  
-  return result
-end
-
--- print_map uses the print command to print a map.
--- It should be used for debug reasons only.
--- SEP can be a separator like "|" to encase the map
--- on the left and on the right.
-function luatools.print_map(map, sep)
-  if type(map) ~= "table" then
-    error("print_map: Argument is not a table (map).")
-  end
-  for _, line in pairs(map) do
-    if type(line) ~= "string" then
-      error("print_map: Line is not a string.")
-    end
-    print((sep or "")..line..(sep or ""))
-  end
-end
-
     ]]></el:luamain>
     <el:i18n>
     </el:i18n>

Added: trunk/data/levels/lib/libmap.xml
===================================================================
--- trunk/data/levels/lib/libmap.xml	2008-08-07 12:34:17 UTC (rev 1257)
+++ trunk/data/levels/lib/libmap.xml	2008-08-07 22:27:47 UTC (rev 1258)
@@ -0,0 +1,409 @@
+<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
+<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
+  <el:protected>
+    <el:info el:type="library">
+      <el:identity el:title="" el:id="lib/libmap"/>
+      <el:version el:score="1" el:release="1" el:revision="1" el:status="released"/>
+      <el:author  el:name="Enigma Team" el:email="" el:homepage=""/>
+      <el:copyright>Copyright ? 2008 Enigma Team</el:copyright>
+      <el:license el:type="GPL v2.0 or above" el:open="true"/>
+      <el:compatibility el:enigma="1.10">
+      </el:compatibility>
+      <el:modes el:easy="false" el:single="false" el:network="false"/>
+      <el:comments>
+      </el:comments>
+      <el:score el:easy="-" el:difficult="-"/>
+    </el:info>
+    <el:luamain><![CDATA[
+
+---------------------------------------------------------------------
+-- libmap provides a metatable for maps, thus some general utilities
+-- for working with maps. It includes functions for joining maps
+-- in several ways, for queries and manipulation of single entries
+-- in the map.
+---------------------------------------------------------------------
+--
+-- libmap provides the following functions:
+--   wo:newMap(defaultKey, arg1, arg2)
+--   lib.map.concat_horizontally(map1, map2)  aka. map1 .. map2
+--   lib.map.concat_vertically(map1, map2)    aka. map1 + map2
+--   lib.map.fuse(arg1, arg2)                 aka. map1 * map2
+--   lib.map.transform(map, op)               aka. map ^ op
+--   lib.map.get(map, key)                    aka. map[key]
+--   lib.map.set(map, key, value)             aka. map[key] = value
+--   lib.map.extend(map, key)                 aka. map:extend(key)
+--   lib.map.sub(map, arg1, arg2)             aka. map:sub(arg1, arg2)
+--   lib.map.covers(map, pos)                 aka. map:covers(pos)
+--   lib.map.setDefaultKey(map, newkey)       aka. map:setDefaultKey(newkey)
+--   lib.map.print(map, withXYCounts, left_separator, right_separator)
+--                                            aka. map:print(...)
+-- Please consult the reference manual for details.
+--
+
+if not lib then
+  lib = {}
+end
+
+lib.map = {}
+
+function lib.map.concat_horizontally(map1, map2)
+  if    (type(map1) ~= "table") or (rawget(map1, "__type") ~= "map")
+     or (type(map2) ~= "table") or (rawget(map2, "__type") ~= "map") then
+    error("lib.map.concat_horizontally: Can only work on maps.")
+  end
+  if string.len(map1.defaultkey) ~= string.len(map2.defaultkey) then
+    error("lib.map.concat_horizontally: Default keys differ in length.")
+  end
+  local result = {}
+  for y = 1, math.max(map1.height, map2.height) do
+    result[y] = (rawget(map1, y) or string.rep(map1.defaultkey, map1.width))
+             .. (rawget(map2, y) or string.rep(map2.defaultkey, map2.width))
+  end
+  return wo:newMap(map1.defaultkey, result)  
+end
+
+function lib.map.concat_vertically(map1, map2)
+  if    (type(map1) ~= "table") or (rawget(map1, "__type") ~= "map")
+     or (type(map2) ~= "table") or (rawget(map2, "__type") ~= "map") then
+    error("lib.map.concat_vertically: Can only work on maps.")
+  end
+  if string.len(map1.defaultkey) ~= string.len(map2.defaultkey) then
+    error("lib.map.concat_vertically: Default keys differ in length.")
+  end
+  local result = {}
+  for y = 1, map1.height do
+    result[y] = rawget(map1, y)  -- rest of line will be filled by wo:newMap
+  end
+  -- As the default key for result will be set to the first
+  -- default key, we have to attach the missing lines of the
+  -- second map here now.
+  local rest = string.rep(map2.defaultkey, math.max(0, map1.width - map2.width))
+  for y = 1, map2.height do
+    result[y + map1.height] = rawget(map2, y) .. rest
+  end
+  return wo:newMap(map1.defaultkey, result)
+end
+
+function lib.map.fuse(arg1, arg2)
+  local map1, map2 = arg1, arg2
+  if type(arg1) == "string" then
+    map1 = wo:newMap(arg1)
+  end
+  if type(arg2) == "string" then
+    map2 = wo:newMap(arg2)
+  end
+  if    (type(map1) ~= "table") or (rawget(map1, "__type") ~= "map")
+     or (type(map2) ~= "table") or (rawget(map2, "__type") ~= "map") then
+    error("lib.map.fuse: Can only work on maps.")
+  end
+  local result = {}
+  for y = 1, math.max(map1.height, map2.height) do
+    result[y] = ""
+    for x = 1, math.max(map1.width, map2.width) do
+      result[y] = result[y] .. map1[{x - 1, y - 1}] .. map2[{x - 1, y - 1}]
+    end
+  end
+  return wo:newMap(map1.defaultkey .. map2.defaultkey, result)  
+end
+
+function lib.map.transform(map, op)
+  if (type(map) ~= "table") or (rawget(map, "__type") ~= "map") then
+    error("lib.map.transform: Can only work on maps.")
+  end
+  if (type(op) ~= "number") or (op < 0) or (op > 7) or (op ~= math.floor(op)) then
+    error("lib.map.transform: Unknown transformation request")
+  end
+  local w, h = map.width, map.height
+  local function rot(pos)
+    return ({
+      [MAP_DEFAULT]           = po({pos.x,         pos.y}),
+      [MAP_CW]                = po({pos.y,         h - 1 - pos.x}), --
+      [MAP_180]               = po({w - 1 - pos.x, h - 1 - pos.y}),
+      [MAP_CCW]               = po({w - 1 - pos.y, pos.x}),         --
+      [MAP_MIRROR_HORIZONTAL] = po({w - 1 - pos.x, pos.y}),
+      [MAP_MIRROR_VERTICAL]   = po({pos.x,         h - 1 - pos.y}),
+      [MAP_MIRROR_SLASH]      = po({pos.y,         pos.x}),
+      [MAP_MIRROR_BACKSLASH]  = po({w - 1 - pos.y, h - 1 - pos.x})  --
+    })[op]
+  end
+  local new_w, new_h = w, h
+  if    (op == MAP_CW) or (op == MAP_CCW) or (op == MAP_MIRROR_SLASH)
+     or (op == MAP_MIRROR_BACKSLASH) then
+    new_w, new_h = h, w
+  end
+  local result = {}
+  for y = 1, new_h do
+    result[y] = ""
+    for x = 1, new_w do
+      result[y] = result[y] .. map[rot(po({x - 1, y - 1}))]
+    end
+  end
+  return wo:newMap(map.defaultkey, result)  
+end
+
+function lib.map.sub(map, arg1, arg2)
+  if (type(map) ~= "table") or (rawget(map, "__type") ~= "map") then
+    error("lib.map.sub: Can only work on maps.")
+  end
+  local pos1, pos2 = arg1, arg2
+  if type(pos1) == "table" then
+    pos1 = po(pos1)
+  end
+  if type(pos2) == "table" then
+    pos2 = po(pos2)
+  end
+  pos1 = pos1:grid()
+  pos2 = pos2:grid()
+  if (pos2.x < 0) or (pos2.y < 0) then
+    error("lib.map.sub: Second position must be positive.")
+  end
+  local result = {}
+  for y = 1, pos2.y do
+    result[y] = string.sub(rawget(map, pos1.y + y) or "",
+                  pos1.x * map.keylength + 1,
+                  (pos1.x + pos2.x) * map.keylength) or ""
+    result[y] = result[y] .. string.rep(map.defaultkey,
+                  math.max(0, pos2.x - string.len(result[y]) / map.keylength))
+  end
+  return wo:newMap(map.defaultkey, result)  
+end
+
+function lib.map.covers(map, pos)
+  return (pos.x >= 0) and (pos.y >= 0)
+      and (pos.x < map.width) and (pos.y < map.height)
+end
+
+function lib.map.get(map, key)
+  if type(key) == "string" then
+    if (key == "type") or (key == "width") or (key == "height")
+       or (key == "defaultkey") or (key == "keylength") then
+      return rawget(map, "__"..key)
+    else  
+      return map.user_attributes[key]
+    end
+  else
+    local pos = key
+    if type(pos) == "table" then
+      pos = po(pos)
+    end
+    pos = pos:grid()
+    if map:covers(pos) then
+      local kl = rawget(map, "__keylength")
+      return string.sub(rawget(map, pos.y + 1), kl * pos.x + 1, (pos.x + 1) * kl)
+    else
+      return rawget(map, "__defaultkey")
+    end
+  end
+end
+
+function lib.map.set(map, key, value)
+  if type(key) == "string" then
+    if (key == "type") then
+      if tostring(value) ~= "map" then
+        error("lib.map.set: A map is a map is a map is a map, and not a "
+            .. tostring(value) .. "!")
+      else
+        return
+      end
+    elseif (key == "width") or (key == "height") then
+      error("lib.map.set: Use extend or sub to change the size of a map.")
+    elseif (key == "keylength") then
+      error("lib.map.set: Can't change keylength without default key.")
+    elseif (key == "defaultkey") then
+      map:setDefaultKey(value)
+      return
+    end
+    map.user_attributes[key] = value
+  else
+    if type(value) ~= "string" then
+      error("lib.map.set: Key must be of type string, is "..type(value)..".")
+    end
+    local kl = rawget(map, "__keylength")
+    if string.len(value) ~= kl then
+      error("lib.map.set: Key must be of the same length as default key "
+          .."(should be "..kl.. ", is "..string.len(value)..").")
+    end
+    local pos = key
+    if type(pos) == "table" then
+      pos = po(pos)
+    end
+    pos = pos:grid()
+    if (pos.x < 0) or (pos.y < 0) then
+      error("lib.map.set: Negative positions are not supported.")
+    end
+    map:extend(pos)
+    rawset(map, pos.y + 1,
+           string.sub(rawget(map, pos.y + 1), 1, pos.x * kl)
+        .. value
+        .. string.sub(rawget(map, pos.y + 1), (pos.x + 1) * kl + 1, -1))
+  end
+end
+
+function lib.map.extend(map, key)
+  if (type(map) ~= "table") or (rawget(map, "__type") ~= "map") then
+    error("lib.map.extend: Can only work on maps.")
+  end
+  local pos = key
+  if type(pos) == "table" then
+    pos = po(pos)
+  end
+  pos = pos:grid()
+  local w, h = rawget(map, "__width"), rawget(map, "__height")
+  local dk = rawget(map, "__defaultkey")
+  if pos.x >= w then
+    local attach = string.rep(dk, pos.x - w + 1)
+    for y = 1, h do
+      rawset(map, y, rawget(map, y) .. attach)
+    end
+    w = pos.x + 1
+  end
+  if pos.y >= h then
+    local line = string.rep(dk, w)
+    for y = h + 1, pos.y + 1 do
+      rawset(map, y, line)
+    end
+    h = pos.y + 1
+  end
+  rawset(map, "__width", w)
+  rawset(map, "__height", h)
+end
+
+function lib.map.print(map, withXYCounts, left_separator, right_separator)
+  if (type(map) ~= "table") or (rawget(map, "__type") ~= "map") then
+    error("lib.map.print: Can only print maps, sorry.")
+  end
+  local w, h = map.width, map.height
+  local kl = rawget(map, "__keylength")
+  if withXYCounts then
+    local line = string.rep(" ", kl) .. (left_separator or "")
+    for x = 0, w - 1 do
+      line = line .. string.rep(" ", math.max(0, kl - string.len(x)))
+                  .. string.sub(x, math.max(0, string.len(x) - kl) + 1, string.len(x))
+    end
+    line = line .. (right_separator or "")
+    print(line)
+  end
+  for y = 0, h - 1 do
+    local line = ""
+    if withXYCounts then
+      line =    string.rep(" ", math.max(0, kl - string.len(y)))
+             .. string.sub(y, math.max(0, string.len(y) - kl) + 1, string.len(y))      
+    end
+    line = line .. (left_separator or "") .. map[y + 1] .. (right_separator or "")
+    print(line)
+  end
+end
+
+function lib.map.setDefaultKey(map, newkey)
+  if (type(map) ~= "table") or (rawget(map, "__type") ~= "map") then
+    error("lib.map.setDefaultKey: Can only set default key of maps, sorry.")
+  end
+  if type(newkey) ~= "string" then
+    error("lib.map.setDefaultKey: Default key must be string, is "..type(newkey)..".")
+  end
+  if newkey == "" then
+    error("lib.map.setDefaultKey: Default key can't be empty.")
+  end
+  local new_width = map.width * map.keylength / string.len(newkey)
+  if new_width ~= math.ceil(new_width) then
+    error("lib.map.setDefaultKey: Map width doesn't fit to new default key.")
+  end
+  rawset(map, "__defaultkey", newkey)
+  rawset(map, "__keylength", string.len(newkey))
+  rawset(map, "__width", new_width)
+end
+
+lib.map.metatable = {
+  __concat = lib.map.concat_horizontally,
+  __add = lib.map.concat_vertically,
+  __mul = lib.map.fuse,
+  __pow = lib.map.transform,
+  __index = lib.map.get,
+  __newindex = lib.map.set,
+}
+
+wo:_register("newMap",
+  function(world, defaultKey, arg1, arg2)
+    local newmap = {user_attributes = {}}
+    -- Check arguments, create map if necessary.
+    if type(defaultKey) ~= "string" then
+      error("newMap: Default key is not of type string, but "..type(defaultKey)..".")
+    end
+    if defaultKey == "" then
+      error("newMap: Default key can't be empty.")
+    end
+    local width = 0
+    local height = 0
+    local kl = string.len(defaultKey)
+    if (type(arg1) == "table") and (type(arg2) == "nil") then
+      -- Interpret table as map.
+      for key, entry in pairs(arg1) do
+        if type(key) == "number" then
+          -- This line is going to be a real map entry.
+          height = math.max(height, key)
+          if type(entry) ~= "string" then
+            error("newMap: Line " .. key .. " is not a string, but "
+                  .. type(entry) .. ".")
+          end
+          local line_width = string.len(entry) / kl
+          if line_width ~= math.floor(line_width) then
+            error("newMap: Line " .. key .. " doesn't fit to key length.")
+          end
+          width = math.max(width, line_width)
+          newmap[key] = entry
+        elseif type(key) == "string" then
+          newmap.user_attributes[key] = entry
+        else
+          error("newMap: Strange type for a table key: " .. type(key) .. ".")
+        end
+      end
+      -- Now complete the map, make it rectangular.
+      for y = 1, height do
+        newmap[y] = newmap[y] or ""
+        newmap[y] = newmap[y]
+            .. string.rep(defaultKey, width - string.len(newmap[y]) / kl)
+      end
+    elseif type(arg1) == "number" and type(arg2) == "number" then
+      -- Create map from scratch.
+      if (arg1 < 1) or (arg2 < 1) or (arg1 ~= math.floor(arg1))
+          or (arg2 ~= math.floor(arg2)) then
+        error("newMap: Width or Height out of range ("..arg1..", "..arg2..").")
+      end
+      local line = string.rep(defaultKey, arg1)
+      for y = 1, arg2 do      
+        newmap[y] = line
+      end
+      width = arg1
+      height = arg2
+    elseif type(arg1) == "nil" and type(arg2) == "nil" then
+      -- Create 1x1-map from scratch.
+      return wo:newMap(defaultKey, 1, 1)
+    --elseif type(arg2) == "nil" then
+    --  -- Interpret arg1 as position.
+    --  return wo:newMap(defaultKey, pos.x + 1, pos.y + 1)
+    else
+      error("newMap: Syntax error. Can't understand arguments.")
+    end
+    -- Set additional values.
+    newmap.__type = "map"
+    newmap.__width = width
+    newmap.__height = height
+    newmap.__defaultkey = defaultKey
+    newmap.__keylength = string.len(defaultKey)
+    -- Set methods and finally metatable.
+    newmap.print = lib.map.print
+    newmap.covers = lib.map.covers
+    newmap.setDefaultKey = lib.map.setDefaultKey
+    newmap.extend = lib.map.extend
+    newmap.sub = lib.map.sub
+    setmetatable(newmap, lib.map.metatable)
+    return newmap
+  end
+)
+
+    ]]></el:luamain>
+    <el:i18n>
+    </el:i18n>
+  </el:protected>
+</el:level>
+



From raoul at mail.berlios.de  Fri Aug  8 17:23:39 2008
From: raoul at mail.berlios.de (raoul at BerliOS)
Date: Fri, 8 Aug 2008 17:23:39 +0200
Subject: [Enigma-game-svn] r1259 - in team_levelpacks: . team_test_new_api
	team_test_physics
Message-ID: <200808081523.m78FNdIH022057@sheep.berlios.de>

Author: raoul
Date: 2008-08-08 17:23:38 +0200 (Fri, 08 Aug 2008)
New Revision: 1259

Added:
   team_levelpacks/team_test_physics/
   team_levelpacks/team_test_physics/raoulP01.xml
   team_levelpacks/team_test_physics/raoulP02.xml
   team_levelpacks/team_test_physics/raoulP03.xml
   team_levelpacks/team_test_physics/raoulP04.xml
   team_levelpacks/team_test_physics/raoulP05.xml
   team_levelpacks/team_test_physics/raoulP06.xml
   team_levelpacks/team_test_physics/raoulP07.xml
Modified:
   team_levelpacks/team_test_new_api/ralD003_1.xml
   team_levelpacks/team_test_new_api/ralT037_1.xml
   team_levelpacks/team_test_new_api/ralT040_1.xml
Log:
-> Fixed some new api testlevels
-> Added physic test levels


Modified: team_levelpacks/team_test_new_api/ralD003_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/ralD003_1.xml	2008-08-07 22:27:47 UTC (rev 1258)
+++ team_levelpacks/team_test_new_api/ralD003_1.xml	2008-08-08 15:23:38 UTC (rev 1259)
@@ -20,7 +20,7 @@
 ti["~"] = {"fl-water"}
 ti[" "] = {"fl-plank"}
 ti["c"] = {"it-crack3", brittleness=0}
-ti["^"] = {"st-oneway-n"}
+ti["^"] = {"st_oneway_n"}
 ti["1"] = {"ac-blackball", 0, 0.5}
 
 ti["x"] = {"st_oxyd", "island#"}

Modified: team_levelpacks/team_test_new_api/ralT037_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/ralT037_1.xml	2008-08-07 22:27:47 UTC (rev 1258)
+++ team_levelpacks/team_test_new_api/ralT037_1.xml	2008-08-08 15:23:38 UTC (rev 1259)
@@ -3,7 +3,7 @@
   <el:protected>
     <el:info el:type="level">
       <el:identity el:title="Test Rubberband new API" el:subtitle="" el:id="20080211ral151"/>
-      <el:version el:score="1" el:release="1" el:revision="$Revision: 1035 $" el:status="experimental"/>
+      <el:version el:score="1" el:release="1" el:revision="$Revision: 1036 $" el:status="experimental"/>
       <el:author  el:name="Ronald Lamprecht" el:email="ral at users.berlios.de"/>
       <el:copyright>Copyright ? 2007 Ronald Lamprecht</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
@@ -24,8 +24,8 @@
 ti["w"] = {"st-wood", "you"}
 ti["r"] = {"it_rubberband", anchor2="you", length=4}
 ti["S"] = {"st_switch", target="killwood"}
-ti["T"] = {"st-turnstile"}
-ti["t"] = {"st-turnstile-n","it"}
+ti["T"] = {"st_turnstile"}
+ti["t"] = {"st_turnstilearm_n","it"}
 ti["R"] = {"it_rubberband", anchor2="it", length=4}
 ti["p"] = {"st-swap", "you"}
 ti["m"] = {"it_magnet_on", strength=-40}

Modified: team_levelpacks/team_test_new_api/ralT040_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/ralT040_1.xml	2008-08-07 22:27:47 UTC (rev 1258)
+++ team_levelpacks/team_test_new_api/ralT040_1.xml	2008-08-08 15:23:38 UTC (rev 1259)
@@ -28,10 +28,10 @@
 ti["t"] = {"st_switch", target="Laser", action="turn"}
 ti["b"] = {"st_switch", target="Laser", action="turnback"}
 
-ti["T"] = {"st-turnstile"}
-ti["e"] = {"st-turnstile-e"}
+ti["T"] = {"st_turnstile"}
+ti["e"] = {"st_turnstilearm_e"}
 
-ti["G"] = {"st-turnstile-green"}
+ti["G"] = {"st_turnstile_green"}
 ti["w"] = {"it_wrench"}
 
 

Added: team_levelpacks/team_test_physics/raoulP01.xml
===================================================================
--- team_levelpacks/team_test_physics/raoulP01.xml	2008-08-07 22:27:47 UTC (rev 1258)
+++ team_levelpacks/team_test_physics/raoulP01.xml	2008-08-08 15:23:38 UTC (rev 1259)
@@ -0,0 +1,95 @@
+<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
+<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
+  <el:protected>
+    <el:info el:type="level">
+      <el:identity el:title="Collisiontest 1" el:subtitle="" el:id="physictest_collision1"/>
+      <el:version el:score="1" el:release="1" el:revision="0" el:status="stable"/>
+      <el:author el:name="Raoul Bourquin" el:email="" el:homepage=""/>
+      <el:copyright>Copyright ? 2007 Raoul Bourquin</el:copyright>
+      <el:license el:type="GPL v2.0 or above" el:open="true"/>
+      <el:compatibility el:enigma="0.92">
+      </el:compatibility>
+      <el:modes el:easy="false" el:single="true" el:network="false"/>
+      <el:score el:easy="-" el:difficult="-"/>
+    </el:info>
+    <el:luamain><![CDATA[
+levelh = 13
+levelw = 20
+
+create_world(levelw, levelh)
+
+function renderLine( line, pattern)
+    for i=1, strlen(pattern) do
+        local c = strsub( pattern, i, i)
+          if c=="x" then
+            oxyd(i-1,line)
+        elseif c=="#" then
+            set_stone("st-glass",i-1,line)
+            set_floor("fl-sahara",i-1,line)
+        elseif c==" " then
+            set_floor("fl-sahara",i-1,line)
+        elseif c=="-" then
+            set_floor("fl-space",i-1,line)
+        elseif c==">" then
+            set_floor("fl-gradient",i-1,line, {type=3, friction=0})
+        elseif c=="<" then
+            set_floor("fl-gradient",i-1,line, {type=4, friction=0})
+        elseif c=="^" then
+            set_floor("fl-gradient",i-1,line, {type=2, friction=0})
+        elseif c=="v" then
+            set_floor("fl-gradient",i-1,line, {type=1, friction=0})
+        end
+    end
+end
+
+renderLine(00 , "####################")
+renderLine(01 , "#>----------------<#")
+renderLine(02 , "#>-----------------#")
+renderLine(03 , "#>----------------<#")
+renderLine(04 , "#>------>----------#")
+renderLine(05 , "#>->---------------#")
+renderLine(06 , "#>----------------<#")
+renderLine(07 , "#>----------------<#")
+renderLine(08 , "#>>>>>------------<#")
+renderLine(09 , "#>>>--->>---->-----#")
+renderLine(10 , "#>>----------------#")
+renderLine(11 , "#>>--->>------<<---#")
+renderLine(12 , "####################")
+
+set_actor("ac-blackball", 0.5,0.5, {player=0})
+set_actor("ac-whiteball", 1.5, 1.5, {controllers=0})
+set_actor("ac-whiteball", 18.5, 1.5, {controllers=0})
+set_actor("ac-whiteball", 1.5, 2.5, {controllers=0})
+set_actor("ac-whiteball", 10.5, 2.5, {controllers=0})
+set_actor("ac-whiteball", 1.5, 3.5, {controllers=0})
+set_actor("ac-whiteball-small", 10, 3.5, {controllers=0})
+set_actor("ac-whiteball", 1.5, 4.5, {controllers=0})
+set_actor("ac-whiteball-small", 8.5, 4.5, {controllers=0})
+set_actor("ac-whiteball", 1.5, 5.5, {controllers=0})
+set_actor("ac-whiteball", 3.5, 5.5, {controllers=0})
+set_actor("ac-whiteball", 1.5, 6.5, {controllers=0})
+set_actor("ac-whiteball", 10, 6.5, {controllers=0})
+set_actor("ac-whiteball", 18.5, 6.5, {controllers=0})
+set_actor("ac-whiteball", 1.5, 7.5, {controllers=0})
+set_actor("ac-whiteball", 5.5, 7.5, {controllers=0})
+set_actor("ac-whiteball", 18.5, 7.5, {controllers=0})
+set_actor("ac-whiteball", 1.5, 8.5, {controllers=0})
+set_actor("ac-whiteball", 18.5, 8.5, {controllers=0})
+set_actor("ac-whiteball", 1.5, 9.5, {controllers=0})
+set_actor("ac-whiteball", 3.5, 9.5, {controllers=0})
+set_actor("ac-whiteball", 5.5, 9.5, {controllers=0})
+set_actor("ac-whiteball", 7.5, 9.5, {controllers=0})
+set_actor("ac-whiteball", 9.5, 9.5, {controllers=0})
+set_actor("ac-whiteball", 11.5, 9.5, {controllers=0})
+set_actor("ac-whiteball", 13.5, 9.5, {controllers=0})
+set_actor("ac-whiteball", 15.5, 9.5, {controllers=0})
+set_actor("ac-whiteball", 1.5, 10.5, {controllers=0})
+set_actor("ac-whiteball", 1.5, 11.5, {controllers=0})
+    ]]></el:luamain>
+    <el:i18n>
+      <el:string el:key="title">
+        <el:english el:translate="false"/>
+      </el:string>
+    </el:i18n>
+  </el:protected>
+</el:level>


Property changes on: team_levelpacks/team_test_physics/raoulP01.xml
___________________________________________________________________
Name: svn:eol-style
   + native

Added: team_levelpacks/team_test_physics/raoulP02.xml
===================================================================
--- team_levelpacks/team_test_physics/raoulP02.xml	2008-08-07 22:27:47 UTC (rev 1258)
+++ team_levelpacks/team_test_physics/raoulP02.xml	2008-08-08 15:23:38 UTC (rev 1259)
@@ -0,0 +1,90 @@
+<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
+<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
+  <el:protected>
+    <el:info el:type="level">
+      <el:identity el:title="Collisiontest 2" el:subtitle="" el:id="physictest_collision2"/>
+      <el:version el:score="1" el:release="1" el:revision="0" el:status="stable"/>
+      <el:author el:name="Raoul Bourquin" el:email="" el:homepage=""/>
+      <el:copyright>Copyright ? 2007 Raoul Bourquin</el:copyright>
+      <el:license el:type="GPL v2.0 or above" el:open="true"/>
+      <el:compatibility el:enigma="0.92">
+      </el:compatibility>
+      <el:modes el:easy="false" el:single="true" el:network="false"/>
+      <el:score el:easy="-" el:difficult="-"/>
+    </el:info>
+    <el:luamain><![CDATA[
+levelh = 25
+levelw = 20
+
+create_world(levelw, levelh)
+
+function renderLine( line, pattern)
+    for i=1, strlen(pattern) do
+        local c = strsub( pattern, i, i)
+          if c=="x" then
+            oxyd(i-1,line)
+        elseif c=="#" then
+            set_stone("st-glass",i-1,line)
+            set_floor("fl-sahara",i-1,line)
+        elseif c=="X" then
+            set_stone("st-glass3",i-1,line)
+            set_floor("fl-sahara",i-1,line)
+        elseif c==" " then
+            set_floor("fl-sahara",i-1,line)
+        elseif c=="-" then
+            set_floor("fl-space",i-1,line)
+        elseif c==">" then
+            set_floor("fl-gradient",i-1,line, {type=3, friction=0})
+        elseif c=="<" then
+            set_floor("fl-gradient",i-1,line, {type=4, friction=0})
+        elseif c=="^" then
+            set_floor("fl-gradient",i-1,line, {type=2, friction=0})
+        elseif c=="v" then
+            set_floor("fl-gradient",i-1,line, {type=1, friction=0})
+        end
+    end
+end
+
+renderLine(00 , "####X##########X####")
+renderLine(01 , "#  vvv        vvv  #")
+renderLine(02 , "#  ---        ---  #")
+renderLine(03 , "#>-----<    >-----<#")
+renderLine(04 , "X>-----<    >-----<X")
+renderLine(05 , "#>-----<    >-----<#")
+renderLine(06 , "#  ---        ---  #")
+renderLine(07 , "#  ^^^        ^^^  #")
+renderLine(08 , "#                  #")
+renderLine(09 , "#                  #")
+renderLine(10 , "#                  #")
+renderLine(11 , "#                  #")
+renderLine(12 , "#                  #")
+renderLine(13 , "#  vvv        vvv  #")
+renderLine(14 , "#  ---        ---  #")
+renderLine(15 , "#>-----<    >-----<#")
+renderLine(16 , "X>-----<    >-----<X")
+renderLine(17 , "#>-----<    >-----<#")
+renderLine(18 , "#  ---        ---  #")
+renderLine(19 , "#  ^^^        ^^^  #")
+renderLine(20 , "#   X          X   #")
+renderLine(21 , "#                  #")
+renderLine(22 , "#                  #")
+renderLine(23 , "#                  #")
+renderLine(24 , "####################")
+
+set_actor("ac-blackball", 2.5,7.5, {player=0})
+set_actor("ac-whiteball-small", 1.5, 4.5, {controllers=0})
+set_actor("ac-whiteball-small", 4.5, 1.5, {controllers=0})
+set_actor("ac-whiteball-small", 15.5, 1.5, {controllers=0})
+set_actor("ac-whiteball-small", 18.5, 4.5, {controllers=0})
+set_actor("ac-whiteball-small", 1.5, 16.5, {controllers=0})
+set_actor("ac-whiteball-small", 4.5, 19.5, {controllers=0})
+set_actor("ac-whiteball-small", 15.5, 19.5, {controllers=0})
+set_actor("ac-whiteball-small", 18.5, 16.5, {controllers=0})
+    ]]></el:luamain>
+    <el:i18n>
+      <el:string el:key="title">
+        <el:english el:translate="false"/>
+      </el:string>
+    </el:i18n>
+  </el:protected>
+</el:level>


Property changes on: team_levelpacks/team_test_physics/raoulP02.xml
___________________________________________________________________
Name: svn:eol-style
   + native

Added: team_levelpacks/team_test_physics/raoulP03.xml
===================================================================
--- team_levelpacks/team_test_physics/raoulP03.xml	2008-08-07 22:27:47 UTC (rev 1258)
+++ team_levelpacks/team_test_physics/raoulP03.xml	2008-08-08 15:23:38 UTC (rev 1259)
@@ -0,0 +1,100 @@
+<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
+<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
+  <el:protected>
+    <el:info el:type="level">
+      <el:identity el:title="Collisiontest 3" el:subtitle="" el:id="physictest_collision3"/>
+      <el:version el:score="1" el:release="1" el:revision="0" el:status="stable"/>
+      <el:author el:name="Raoul Bourquin" el:email="" el:homepage=""/>
+      <el:copyright>Copyright ? 2007 Raoul Bourquin</el:copyright>
+      <el:license el:type="GPL v2.0 or above" el:open="true"/>
+      <el:compatibility el:enigma="0.92">
+      </el:compatibility>
+      <el:modes el:easy="true" el:single="true" el:network="false"/>
+      <el:score el:easy="-" el:difficult="-"/>
+    </el:info>
+    <el:luamain><![CDATA[
+levelh = 25
+levelw = 20
+
+create_world(levelw, levelh)
+
+if difficult then
+    f=0
+else
+    f=0.8
+end
+
+function renderLine( line, pattern)
+    for i=1, strlen(pattern) do
+        local c = strsub( pattern, i, i)
+          if c=="x" then
+            oxyd(i-1,line)
+        elseif c=="#" then
+            set_stone("st-glass",i-1,line)
+            set_floor("fl-sahara",i-1,line)
+        elseif c=="X" then
+            set_stone("st-glass3",i-1,line)
+            set_floor("fl-sahara",i-1,line)
+        elseif c==" " then
+            set_floor("fl-sahara",i-1,line)
+        elseif c=="-" then
+            set_floor("fl-space",i-1,line)
+        elseif c=="." then
+            set_floor("fl-space",i-1,line)
+            set_actor("ac-whiteball-small",i-1+0.5, line+0.5, {controllers=0})
+        elseif c==">" then
+            set_floor("fl-gradient",i-1,line, {type=3, friction=f})
+        elseif c=="<" then
+            set_floor("fl-gradient",i-1,line, {type=4, friction=f})
+        elseif c=="^" then
+            set_floor("fl-gradient",i-1,line, {type=2, friction=f})
+        elseif c=="v" then
+            set_floor("fl-gradient",i-1,line, {type=1, friction=f})
+        elseif c=="u" then
+            set_floor("fl-gradient",i-1,line, {type=1, friction=0})
+            set_actor("ac-whiteball-small",i-1+0.5, line+0.5, {controllers=0})
+        end
+    end
+end
+
+renderLine(00 , "####################")
+renderLine(01 , "#>>>>>>>>><<<<<<<<<#")
+renderLine(02 , "#>>>>>>>>><<<<<<<<<#")
+renderLine(03 , "#               v v#")
+renderLine(04 , "#               . .#")
+renderLine(05 , "#v v v  v       . -#")
+renderLine(06 , "#v v v  v       . .#")
+renderLine(07 , "#v v v  v       . -#")
+renderLine(08 , "#v v v  u       . .#")
+renderLine(09 , "#v v v  u       . -#")
+renderLine(10 , "#v v v  u       . .#")
+renderLine(11 , "#v v v  u       . -#")
+renderLine(12 , "#v v v  u       . .#")
+renderLine(13 , "#v v v  u       . -#")
+renderLine(14 , "#v v v  u       . .#")
+renderLine(15 , "#v v v  u       . -#")
+renderLine(16 , "#v v u  u       . .#")
+renderLine(17 , "#v v u  u       . -#")
+renderLine(18 , "#v v u  u       . .#")
+renderLine(19 , "#v v u  u       . -#")
+renderLine(20 , "#v u u  u       . .#")
+renderLine(21 , "#v u u  u       . -#")
+renderLine(22 , "#u u u  u       . .#")
+renderLine(23 , "#u u u  u       . ^#")
+renderLine(24 , "####################")
+
+set_actor("ac-blackball", 2.5,7.5, {player=0})
+set_actor("ac-whiteball-small", 1.5, 1.5, {controllers=0})
+set_actor("ac-whiteball-small", 18.5, 1.5, {controllers=0})
+set_actor("ac-whiteball-small", 1.5, 2.5, {controllers=0})
+set_actor("ac-whiteball-small", 18.5, 3.5, {controllers=0})
+set_actor("ac-whiteball-small", 18.5, 23.5, {controllers=0})
+set_actor("ac-whiteball-small", 16.5, 3.5, {controllers=0})
+    ]]></el:luamain>
+    <el:i18n>
+      <el:string el:key="title">
+        <el:english el:translate="false"/>
+      </el:string>
+    </el:i18n>
+  </el:protected>
+</el:level>


Property changes on: team_levelpacks/team_test_physics/raoulP03.xml
___________________________________________________________________
Name: svn:eol-style
   + native

Added: team_levelpacks/team_test_physics/raoulP04.xml
===================================================================
--- team_levelpacks/team_test_physics/raoulP04.xml	2008-08-07 22:27:47 UTC (rev 1258)
+++ team_levelpacks/team_test_physics/raoulP04.xml	2008-08-08 15:23:38 UTC (rev 1259)
@@ -0,0 +1,93 @@
+<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
+<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
+  <el:protected>
+    <el:info el:type="level">
+      <el:identity el:title="Collisiontest 4" el:subtitle="" el:id="physictest_collision4"/>
+      <el:version el:score="1" el:release="1" el:revision="0" el:status="stable"/>
+      <el:author el:name="Raoul Bourquin" el:email="" el:homepage=""/>
+      <el:copyright>Copyright ? 2007 Raoul Bourquin</el:copyright>
+      <el:license el:type="GPL v2.0 or above" el:open="true"/>
+      <el:compatibility el:enigma="0.92">
+      </el:compatibility>
+      <el:modes el:easy="true" el:single="true" el:network="false"/>
+      <el:score el:easy="-" el:difficult="-"/>
+    </el:info>
+    <el:luamain><![CDATA[
+levelh = 13
+levelw = 20
+
+create_world(levelw, levelh)
+
+forcex = 5
+forcey = 5
+
+spacefriction = 0
+
+function renderLine( line, pattern)
+    for i=1, strlen(pattern) do
+        local c = strsub( pattern, i, i)
+        if c=="#" then
+            set_stone("st-glass",i-1,line)
+            set_floor("fl-sahara",i-1,line)
+        elseif c==" " then
+            set_floor("fl-sahara",i-1,line)
+        elseif c=="-" then
+            set_floor("fl-space",i-1,line,{friction=spacefriction})
+        elseif c==">" then
+            set_floor("fl-space",i-1,line, {force_x = forcex, force_y = 0, friction=spacefriction})
+            set_actor("ac-whiteball-small", i-1+0.5, line+0.5, {controllers=0})
+        elseif c=="<" then
+            set_floor("fl-space",i-1,line, {force_x = -forcex, force_y = 0, friction=spacefriction})
+            set_actor("ac-whiteball-small", i-1+0.5, line+0.5, {controllers=0})
+        elseif c=="v" then
+            set_floor("fl-space",i-1,line, {force_x = 0, force_y = forcey, friction=spacefriction})
+            set_actor("ac-whiteball-small", i-1+0.5, line+0.5, {controllers=0})
+        elseif c=="^" then
+            set_floor("fl-space",i-1,line, {force_x = 0, force_y = -forcey, friction=spacefriction})
+            set_actor("ac-whiteball-small", i-1+0.5, line+0.5, {controllers=0})
+        elseif c=="0" then
+            set_floor("fl-space",i-1,line, {force_x = 0, force_y = 0, friction=spacefriction})
+            if not difficult then
+                set_actor("ac-whiteball", i-1+0.5, line+0.5, {controllers=0})
+            else
+                set_stone("st-glass",i-1,line)
+            end
+        elseif c=="1" then
+            set_floor("fl-space",i-1,line, {force_x = forcex, force_y = forcey, friction=spacefriction})
+            set_actor("ac-whiteball-small", i-1+0.5, line+0.5, {controllers=0})
+        elseif c=="2" then
+            set_floor("fl-space",i-1,line, {force_x = -forcex, force_y = forcey, friction=spacefriction})
+            set_actor("ac-whiteball-small", i-1+0.5, line+0.5, {controllers=0})
+        elseif c=="3" then
+            set_floor("fl-space",i-1,line, {force_x = -forcex, force_y = -forcey, friction=spacefriction})
+            set_actor("ac-whiteball-small", i-1+0.5, line+0.5, {controllers=0})
+        elseif c=="4" then
+            set_floor("fl-space",i-1,line, {force_x = forcex, force_y = -forcey, friction=spacefriction})
+            set_actor("ac-whiteball-small", i-1+0.5, line+0.5, {controllers=0})
+        end
+    end
+end
+
+renderLine(00 , "####################")
+renderLine(01 , "#                  #")
+renderLine(02 , "#    1---v---2     #")
+renderLine(03 , "#    -1--v--2-     #")
+renderLine(04 , "#    --1-v-2--     #")
+renderLine(05 , "#    ---1v2---     #")
+renderLine(06 , "#    >>>>0<<<<     #")
+renderLine(07 , "#    ---4^3---     #")
+renderLine(08 , "#    --4-^-3--     #")
+renderLine(09 , "#    -4--^--3-     #")
+renderLine(10 , "#    4---^---3     #")
+renderLine(11 , "#                  #")
+renderLine(12 , "####################")
+
+set_actor("ac-blackball", 2.5,7.5, {player=0})
+    ]]></el:luamain>
+    <el:i18n>
+      <el:string el:key="title">
+        <el:english el:translate="false"/>
+      </el:string>
+    </el:i18n>
+  </el:protected>
+</el:level>


Property changes on: team_levelpacks/team_test_physics/raoulP04.xml
___________________________________________________________________
Name: svn:eol-style
   + native

Added: team_levelpacks/team_test_physics/raoulP05.xml
===================================================================
--- team_levelpacks/team_test_physics/raoulP05.xml	2008-08-07 22:27:47 UTC (rev 1258)
+++ team_levelpacks/team_test_physics/raoulP05.xml	2008-08-08 15:23:38 UTC (rev 1259)
@@ -0,0 +1,87 @@
+<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
+<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
+  <el:protected>
+    <el:info el:type="level">
+      <el:identity el:title="Collisiontest 5" el:subtitle="" el:id="physictest_collision5"/>
+      <el:version el:score="1" el:release="1" el:revision="0" el:status="stable"/>
+      <el:author el:name="Raoul Bourquin" el:email="" el:homepage=""/>
+      <el:copyright>Copyright ? 2007 Raoul Bourquin</el:copyright>
+      <el:license el:type="GPL v2.0 or above" el:open="true"/>
+      <el:compatibility el:enigma="0.92">
+      </el:compatibility>
+      <el:modes el:easy="false" el:single="true" el:network="false"/>
+      <el:score el:easy="-" el:difficult="-"/>
+    </el:info>
+    <el:luamain><![CDATA[
+levelh = 13
+levelw = 20
+
+create_world(levelw, levelh)
+
+forcex = -2
+forcey = -2
+
+spacefriction = 0
+
+function renderLine( line, pattern)
+    for i=1, strlen(pattern) do
+        local c = strsub( pattern, i, i)
+        if c=="#" then
+            set_stone("st-glass",i-1,line)
+            set_floor("fl-sahara",i-1,line)
+        elseif c==" " then
+            set_floor("fl-sahara",i-1,line)
+        elseif c=="-" then
+            set_floor("fl-space",i-1,line,{friction=spacefriction})
+        elseif c==">" then
+            set_floor("fl-space",i-1,line, {force_x = forcex, force_y = 0, friction=spacefriction})
+            set_actor("ac-whiteball-small", i-1+0.5, line+0.5, {controllers=0})
+        elseif c=="<" then
+            set_floor("fl-space",i-1,line, {force_x = -forcex, force_y = 0, friction=spacefriction})
+            set_actor("ac-whiteball-small", i-1+0.5, line+0.5, {controllers=0})
+        elseif c=="v" then
+            set_floor("fl-space",i-1,line, {force_x = 0, force_y = forcey, friction=spacefriction})
+            set_actor("ac-whiteball-small", i-1+0.5, line+0.5, {controllers=0})
+        elseif c=="^" then
+            set_floor("fl-space",i-1,line, {force_x = 0, force_y = -forcey, friction=spacefriction})
+            set_actor("ac-whiteball-small", i-1+0.5, line+0.5, {controllers=0})
+        elseif c=="1" then
+            set_floor("fl-space",i-1,line, {force_x = forcex, force_y = forcey, friction=spacefriction})
+            set_actor("ac-whiteball-small", i-1+0.5, line+0.5, {controllers=0})
+        elseif c=="2" then
+            set_floor("fl-space",i-1,line, {force_x = -forcex, force_y = forcey, friction=spacefriction})
+            set_actor("ac-whiteball-small", i-1+0.5, line+0.5, {controllers=0})
+        elseif c=="3" then
+            set_floor("fl-space",i-1,line, {force_x = -forcex, force_y = -forcey, friction=spacefriction})
+            set_actor("ac-whiteball-small", i-1+0.5, line+0.5, {controllers=0})
+        elseif c=="4" then
+            set_floor("fl-space",i-1,line, {force_x = forcex, force_y = -forcey, friction=spacefriction})
+            set_actor("ac-whiteball-small", i-1+0.5, line+0.5, {controllers=0})
+
+        end
+    end
+end
+
+renderLine(00 , "####################")
+renderLine(01 , "#11111#      #22222#")
+renderLine(02 , "#11111#      #22222#")
+renderLine(03 , "#11111#      #22222#")
+renderLine(04 , "#11111#      #22222#")
+renderLine(05 , "#11111#      #22222#")
+renderLine(06 , "####################")
+renderLine(07 , "#44444#      #33333#")
+renderLine(08 , "#44444#      #33333#")
+renderLine(09 , "#44444#      #33333#")
+renderLine(10 , "#44444#      #33333#")
+renderLine(11 , "#44444#      #33333#")
+renderLine(12 , "####################")
+
+set_actor("ac-blackball", 10.5,3.5, {player=0})
+    ]]></el:luamain>
+    <el:i18n>
+      <el:string el:key="title">
+        <el:english el:translate="false"/>
+      </el:string>
+    </el:i18n>
+  </el:protected>
+</el:level>


Property changes on: team_levelpacks/team_test_physics/raoulP05.xml
___________________________________________________________________
Name: svn:eol-style
   + native

Added: team_levelpacks/team_test_physics/raoulP06.xml
===================================================================
--- team_levelpacks/team_test_physics/raoulP06.xml	2008-08-07 22:27:47 UTC (rev 1258)
+++ team_levelpacks/team_test_physics/raoulP06.xml	2008-08-08 15:23:38 UTC (rev 1259)
@@ -0,0 +1,91 @@
+<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
+<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
+  <el:protected>
+    <el:info el:type="level">
+      <el:identity el:title="Collisiontest 6" el:subtitle="" el:id="physictest_collision6"/>
+      <el:version el:score="1" el:release="1" el:revision="0" el:status="stable"/>
+      <el:author el:name="Raoul Bourquin" el:email="" el:homepage=""/>
+      <el:copyright>Copyright ? 2007 Raoul Bourquin</el:copyright>
+      <el:license el:type="GPL v2.0 or above" el:open="true"/>
+      <el:compatibility el:enigma="0.92">
+      </el:compatibility>
+      <el:modes el:easy="true" el:single="true" el:network="false"/>
+      <el:score el:easy="-" el:difficult="-"/>
+    </el:info>
+    <el:luamain><![CDATA[
+levelh = 13
+levelw = 20
+
+create_world(levelw, levelh)
+
+forcex = 2
+forcey = 2
+
+spacefriction = 0
+
+function renderLine( line, pattern)
+    for i=1, strlen(pattern) do
+        local c = strsub( pattern, i, i)
+        if c=="#" then
+            set_stone("st-glass",i-1,line)
+            set_floor("fl-sahara",i-1,line)
+        elseif c==" " then
+            set_floor("fl-sahara",i-1,line)
+        elseif c=="-" then
+            set_floor("fl-space",i-1,line,{friction=spacefriction})
+        elseif c==">" then
+            set_floor("fl-space",i-1,line, {force_x = forcex, force_y = 0, friction=spacefriction})
+            set_actor("ac-whiteball-small", i-1+0.5, line+0.5, {controllers=0})
+        elseif c=="<" then
+            set_floor("fl-space",i-1,line, {force_x = -forcex, force_y = 0, friction=spacefriction})
+            set_actor("ac-whiteball-small", i-1+0.5, line+0.5, {controllers=0})
+        elseif c=="v" then
+            set_floor("fl-space",i-1,line, {force_x = 0, force_y = forcey, friction=spacefriction})
+            set_actor("ac-whiteball-small", i-1+0.5, line+0.5, {controllers=0})
+        elseif c=="^" then
+            set_floor("fl-space",i-1,line, {force_x = 0, force_y = -forcey, friction=spacefriction})
+            set_actor("ac-whiteball-small", i-1+0.5, line+0.5, {controllers=0})
+        elseif c=="0" then
+            set_floor("fl-space",i-1,line, {force_x = 0, force_y = 0, friction=spacefriction})
+            if not difficult then
+                set_actor("ac-whiteball-small", i-1+0.5, line+0.5, {controllers=0})
+            end
+        elseif c=="1" then
+            set_floor("fl-space",i-1,line, {force_x = forcex, force_y = forcey, friction=spacefriction})
+            set_actor("ac-whiteball-small", i-1+0.5, line+0.5, {controllers=0})
+        elseif c=="2" then
+            set_floor("fl-space",i-1,line, {force_x = -forcex, force_y = forcey, friction=spacefriction})
+            set_actor("ac-whiteball-small", i-1+0.5, line+0.5, {controllers=0})
+        elseif c=="3" then
+            set_floor("fl-space",i-1,line, {force_x = -forcex, force_y = -forcey, friction=spacefriction})
+            set_actor("ac-whiteball-small", i-1+0.5, line+0.5, {controllers=0})
+        elseif c=="4" then
+            set_floor("fl-space",i-1,line, {force_x = forcex, force_y = -forcey, friction=spacefriction})
+            set_actor("ac-whiteball-small", i-1+0.5, line+0.5, {controllers=0})
+        end
+    end
+end
+
+renderLine(00 , "####################")
+renderLine(01 , "#1-----2#          #")
+renderLine(02 , "#-1---2-#          #")
+renderLine(03 , "#--1-2--#          #")
+renderLine(04 , "#---0---############")
+renderLine(05 , "#--4-3--#  #---v---#")
+renderLine(06 , "#-4---3-#  #---v---#")
+renderLine(07 , "#4-----3#  #---v---#")
+renderLine(08 , "############>>>0<<<#")
+renderLine(09 , "#          #---^---#")
+renderLine(10 , "#          #---^---#")
+renderLine(11 , "#          #---^---#")
+renderLine(12 , "####################")
+
+set_actor("ac-blackball", 10.5,6.5, {player=0})
+    ]]></el:luamain>
+    <el:i18n>
+      <el:string el:key="title">
+        <el:english el:translate="false"/>
+      </el:string>
+    </el:i18n>
+  </el:protected>
+</el:level>


Property changes on: team_levelpacks/team_test_physics/raoulP06.xml
___________________________________________________________________
Name: svn:eol-style
   + native

Added: team_levelpacks/team_test_physics/raoulP07.xml
===================================================================
--- team_levelpacks/team_test_physics/raoulP07.xml	2008-08-07 22:27:47 UTC (rev 1258)
+++ team_levelpacks/team_test_physics/raoulP07.xml	2008-08-08 15:23:38 UTC (rev 1259)
@@ -0,0 +1,98 @@
+<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
+<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
+  <el:protected>
+    <el:info el:type="level">
+      <el:identity el:title="Collisiontest 7" el:subtitle="" el:id="physictest_collision7"/>
+      <el:version el:score="1" el:release="1" el:revision="0" el:status="stable"/>
+      <el:author el:name="Raoul Bourquin" el:email="" el:homepage=""/>
+      <el:copyright>Copyright ? 2007 Raoul Bourquin</el:copyright>
+      <el:license el:type="GPL v2.0 or above" el:open="true"/>
+      <el:compatibility el:enigma="0.92">
+      </el:compatibility>
+      <el:modes el:easy="true" el:single="true" el:network="false"/>
+      <el:score el:easy="-" el:difficult="-"/>
+    </el:info>
+    <el:luamain><![CDATA[
+levelh = 25
+levelw = 20
+
+create_world(levelw, levelh)
+
+if difficult then
+    f=0
+else
+    f=0.8
+end
+
+function renderLine( line, pattern)
+    for i=1, strlen(pattern) do
+        local c = strsub( pattern, i, i)
+          if c=="x" then
+            oxyd(i-1,line)
+        elseif c=="#" then
+            set_stone("st-glass",i-1,line)
+            set_floor("fl-sahara",i-1,line)
+        elseif c=="X" then
+            set_stone("st-glass3",i-1,line)
+            set_floor("fl-sahara",i-1,line)
+        elseif c==" " then
+            set_floor("fl-sahara",i-1,line)
+        elseif c=="-" then
+            set_floor("fl-space",i-1,line)
+        elseif c=="." then
+            set_floor("fl-space",i-1,line)
+            set_actor("ac-whiteball-small",i-1+0.5, line+0.5, {controllers=0})
+        elseif c=="." then
+            set_floor("fl-space",i-1,line)
+            set_actor("ac-whiteball-small",i-1+0.5, line+0.5, {controllers=0})
+        elseif c==">" then
+            set_floor("fl-gradient",i-1,line, {type=3, friction=f})
+            set_actor("ac-whiteball-small",i-1+0.5, line+0.5, {controllers=0})
+        elseif c=="<" then
+            set_floor("fl-gradient",i-1,line, {type=4, friction=f})
+            set_actor("ac-whiteball-small",i-1+0.5, line+0.5, {controllers=0})
+        elseif c=="^" then
+            set_floor("fl-gradient",i-1,line, {type=2, friction=f})
+            set_actor("ac-whiteball-small",i-1+0.5, line+0.5, {controllers=0})
+        elseif c=="v" then
+            set_floor("fl-gradient",i-1,line, {type=1, friction=f})
+            set_actor("ac-whiteball-small",i-1+0.5, line+0.5, {controllers=0})
+        end
+    end
+end
+
+renderLine(00 , "####################")
+renderLine(01 , "#<<<<<<<<<<#    v ^#")
+renderLine(02 , "#               v ^#")
+renderLine(03 , "#>>>>><<<<<#    v ^#")
+renderLine(04 , "#               v ^#")
+renderLine(05 , "#   #           v ^#")
+renderLine(06 , "#   v           ^ ^#")
+renderLine(07 , "#   v           ^ ^#")
+renderLine(08 , "#   v           ^ ^#")
+renderLine(09 , "#>>>.<<<#       ^ ^#")
+renderLine(10 , "#   ^           ^ ^#")
+renderLine(11 , "#   ^          ## ##")
+renderLine(12 , "#   ^          v   #")
+renderLine(13 , "## ##          v   #")
+renderLine(14 , "#v v           v   #")
+renderLine(15 , "#v v       #>>>-<<<#")
+renderLine(16 , "#v v           ^   #")
+renderLine(17 , "#v v           ^   #")
+renderLine(18 , "#v v           ^   #")
+renderLine(19 , "#v ^           #   #")
+renderLine(20 , "#v ^               #")
+renderLine(21 , "#v ^    #>>>>><<<<<#")
+renderLine(22 , "#v ^               #")
+renderLine(23 , "#v ^    #>>>>>>>>>>#")
+renderLine(24 , "####################")
+
+set_actor("ac-blackball", 10.5,7.5, {player=0})
+    ]]></el:luamain>
+    <el:i18n>
+      <el:string el:key="title">
+        <el:english el:translate="false"/>
+      </el:string>
+    </el:i18n>
+  </el:protected>
+</el:level>


Property changes on: team_levelpacks/team_test_physics/raoulP07.xml
___________________________________________________________________
Name: svn:eol-style
   + native



From raoul at mail.berlios.de  Fri Aug 15 15:50:27 2008
From: raoul at mail.berlios.de (raoul at BerliOS)
Date: Fri, 15 Aug 2008 15:50:27 +0200
Subject: [Enigma-game-svn] r1272 - in trunk: data data/levels/enigma_cross
	data/levels/enigma_esprit data/levels/enigma_oxyd
	data/levels/enigma_peroxyd data/levels/enigma_vi
	data/levels/enigma_viii src/items
Message-ID: <200808151350.m7FDoRCE019944@sheep.berlios.de>

Author: raoul
Date: 2008-08-15 15:50:25 +0200 (Fri, 15 Aug 2008)
New Revision: 1272

Modified:
   trunk/data/api1init.lua
   trunk/data/levels/enigma_cross/newlevels_1.0.1.xml
   trunk/data/levels/enigma_cross/newlevels_1.1.0.xml
   trunk/data/levels/enigma_esprit/esprit37_3.xml
   trunk/data/levels/enigma_esprit/esprit69_1.xml
   trunk/data/levels/enigma_esprit/esprit79_1.xml
   trunk/data/levels/enigma_esprit/esprit88_1.xml
   trunk/data/levels/enigma_esprit/index.xml
   trunk/data/levels/enigma_oxyd/index.xml
   trunk/data/levels/enigma_oxyd/oxyd53_1.xml
   trunk/data/levels/enigma_peroxyd/index.xml
   trunk/data/levels/enigma_peroxyd/peroxyd82_1.xml
   trunk/data/levels/enigma_vi/duffy134_1.xml
   trunk/data/levels/enigma_vi/index.xml
   trunk/data/levels/enigma_viii/index.xml
   trunk/data/levels/enigma_viii/raywick05_1.xml
   trunk/src/items/WormHole.cc
   trunk/src/items/WormHole.hh
Log:
-> Fix include problems of r1270
-> Fix doorstones in deja-vu levels
-> Fix shogundots



Modified: trunk/data/api1init.lua
===================================================================
--- trunk/data/api1init.lua	2008-08-15 11:45:40 UTC (rev 1271)
+++ trunk/data/api1init.lua	2008-08-15 13:50:25 UTC (rev 1272)
@@ -1023,9 +1023,9 @@
 function keyb(x,y) set_item("it-key", x,y, {keycode=2.0}) end
 function keyc(x,y) set_item("it-key", x,y, {keycode=3.0}) end
 
-function shogundot1(x,y,attrs) set_item("it-shogun-s", x, y, attrs) end
-function shogundot2(x,y,attrs) set_item("it-shogun-m", x, y, attrs) end
-function shogundot3(x,y,attrs) set_item("it-shogun-l", x, y, attrs) end
+function shogundot1(x,y,attrs) set_item("it_shogun_s", x, y, attrs) end
+function shogundot2(x,y,attrs) set_item("it_shogun_m", x, y, attrs) end
+function shogundot3(x,y,attrs) set_item("it_shogun_l", x, y, attrs) end
 
 function Wormhole(x,y,targetx, targety, attribs)
     local attrs = attribs or {}

Modified: trunk/data/levels/enigma_cross/newlevels_1.0.1.xml
===================================================================
--- trunk/data/levels/enigma_cross/newlevels_1.0.1.xml	2008-08-15 11:45:40 UTC (rev 1271)
+++ trunk/data/levels/enigma_cross/newlevels_1.0.1.xml	2008-08-15 13:50:25 UTC (rev 1272)
@@ -1,7 +1,7 @@
 <?xml version="1.0" encoding="UTF-8" standalone="no" ?>
 <index xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="index.xsd">
 
-  <info enigma="1.00" group="Facets" location="15500" network="false" owner="Enigma Team" release="1" revision="12" title="Enigma 1.01 new"/>
+  <info enigma="1.00" group="Facets" location="15500" network="false" owner="Enigma Team" release="1" revision="13" title="Enigma 1.01 new"/>
 
   <attributes/>
 
@@ -34,7 +34,7 @@
     <level _seq="26" _title="Rotor Guards" _xpath="enigma_vi/duffy144_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy144" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="27" _title="Group Trip to Meditation" _xpath="enigma_vi/duffy136_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy136" rel="1" rev="2" score="1" target="time" unit="duration"/>
     <level _seq="28" _title="Oxyd Drilling" _xpath="enigma_vi/duffy140_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy140" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="29" _title="Pleasure Garden" _xpath="enigma_vi/duffy134_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy134" rel="1" rev="4" score="1" target="time" unit="duration"/>
+    <level _seq="29" _title="Pleasure Garden" _xpath="enigma_vi/duffy134_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy134" rel="1" rev="5" score="1" target="time" unit="duration"/>
     <level _seq="30" _title="Idempotency" _xpath="enigma_vi/duffy145_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy145" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="31" _title="Pontoon Bridges" _xpath="enigma_vi/duffy137_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy137" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="32" _title="Parish Fair" _xpath="enigma_vi/duffy143_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy143" rel="1" rev="2" score="1" target="time" unit="duration"/>

Modified: trunk/data/levels/enigma_cross/newlevels_1.1.0.xml
===================================================================
--- trunk/data/levels/enigma_cross/newlevels_1.1.0.xml	2008-08-15 11:45:40 UTC (rev 1271)
+++ trunk/data/levels/enigma_cross/newlevels_1.1.0.xml	2008-08-15 13:50:25 UTC (rev 1272)
@@ -1,7 +1,7 @@
 <?xml version="1.0" encoding="UTF-8" standalone="no" ?>
 <index xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="index.xsd">
 
-  <info enigma="1.00" group="Facets" location="15600" network="false" owner="Enigma Team" release="1" revision="10" title="Enigma 1.1 new"/>
+  <info enigma="1.00" group="Facets" location="15600" network="false" owner="Enigma Team" release="1" revision="11" title="Enigma 1.1 new"/>
 
   <attributes/>
 
@@ -97,7 +97,7 @@
     <level _seq="89" _title="The Green Hell" _xpath="enigma_viii/mecke22_1" author="mecke" ctrl="force" easy="true" id="mecke22" rel="1" rev="55" score="1" target="time" unit="duration"/>
     <level _seq="90" _title="Tilt Board" _xpath="enigma_viii/ulf06_2" author="Ulf Stegemann" ctrl="force" easy="true" id="20080529ulf118" rel="2" rev="116" score="2" target="time" unit="duration"/>
     <level _seq="91" _title="4 - 8 - 4" _xpath="enigma_viii/dpl03_3" author="Dominik Leipold" ctrl="force" easy="true" id="20070821dpl003" rel="3" rev="4" score="3" target="time" unit="duration"/>
-    <level _seq="92" _title="Impulsive Order" _xpath="enigma_viii/raywick05_1" author="Ray Wick" ctrl="force" easy="true" id="raywick5" rel="1" rev="4" score="1" target="time" unit="duration"/>
+    <level _seq="92" _title="Impulsive Order" _xpath="enigma_viii/raywick05_1" author="Ray Wick" ctrl="force" easy="true" id="raywick5" rel="1" rev="5" score="1" target="time" unit="duration"/>
     <level _seq="93" _title="Cross Mail" _xpath="enigma_viii/johann03_1" author="Johann Freymuth" ctrl="force" easy="false" id="johann03" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="94" _title="Color Maze" _xpath="enigma_viii/pulley16_3" author="Mark Pulley" ctrl="force" easy="false" id="pulley16" rel="3" rev="4" score="3" target="time" unit="duration"/>
     <level _seq="95" _title="Earthlink" _xpath="enigma_viii/pulley15_1" author="Mark Pulley" ctrl="force" easy="true" id="pulley15" rel="1" rev="0" score="1" target="time" unit="duration"/>

Modified: trunk/data/levels/enigma_esprit/esprit37_3.xml
===================================================================
--- trunk/data/levels/enigma_esprit/esprit37_3.xml	2008-08-15 11:45:40 UTC (rev 1271)
+++ trunk/data/levels/enigma_esprit/esprit37_3.xml	2008-08-15 13:50:25 UTC (rev 1272)
@@ -3,7 +3,7 @@
   <el:protected>
     <el:info el:type="level">
       <el:identity el:title="esprit 37" el:subtitle="esprit 37" el:id="ss_esp37"/>
-      <el:version el:score="3" el:release="3" el:revision="2" el:status="released"/>
+      <el:version el:score="3" el:release="3" el:revision="3" el:status="released"/>
       <el:author  el:name="Sven Siggelkow" el:email="" el:homepage=""/>
       <el:copyright>Copyright ? 2003 Sven Siggelkow</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
@@ -60,7 +60,7 @@
             puzzle(i-1,line, 10)  
             --set_item("it-magicwand",i-1,line)
         elseif c=="." then
-            set_stone("st-door_b", i-1,line, {type="v"})   
+            set_stone("st-door_b", i-1,line)   
         elseif c=="O" then
             oxyd(i-1,line)
         end

Modified: trunk/data/levels/enigma_esprit/esprit69_1.xml
===================================================================
--- trunk/data/levels/enigma_esprit/esprit69_1.xml	2008-08-15 11:45:40 UTC (rev 1271)
+++ trunk/data/levels/enigma_esprit/esprit69_1.xml	2008-08-15 13:50:25 UTC (rev 1272)
@@ -3,7 +3,7 @@
   <el:protected>
     <el:info el:type="level">
       <el:identity el:title="esprit 69" el:subtitle="esprit 69" el:id="ss_esp69"/>
-      <el:version el:score="1" el:release="1" el:revision="0" el:status="released"/>
+      <el:version el:score="1" el:release="1" el:revision="1" el:status="released"/>
       <el:author  el:name="Sven Siggelkow" el:email="" el:homepage=""/>
       <el:copyright>Copyright ? 2003 Sven Siggelkow</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
@@ -38,21 +38,21 @@
          set_floor("fl-wood",  i-1,  line)
          set_item("it-burnable_ignited", i-1,  line)
       elseif c=="1" then
-         set_stone("st-door_c", i-1,line, {name="door1", type="v"})
+         set_stone("st-door_c", i-1,line, {name="door1"})
       elseif c=="2" then
-         set_stone("st-door_c", i-1,line, {name="door2", type="v"})
+         set_stone("st-door_c", i-1,line, {name="door2"})
       elseif c=="3" then
-         set_stone("st-door_c", i-1,line, {name="door3", type="v"})
+         set_stone("st-door_c", i-1,line, {name="door3"})
       elseif c=="4" then
-         set_stone("st-door_c", i-1,line, {name="door4", type="v"})
+         set_stone("st-door_c", i-1,line, {name="door4"})
       elseif c=="5" then
-         set_stone("st-door_c", i-1,line, {name="door5", type="v"})
+         set_stone("st-door_c", i-1,line, {name="door5"})
       elseif c=="6" then
-         set_stone("st-door_c", i-1,line, {name="door6", type="v"})
+         set_stone("st-door_c", i-1,line, {name="door6"})
       elseif c=="7" then
-         set_stone("st-door_c", i-1,line, {name="door7", type="v"})
+         set_stone("st-door_c", i-1,line, {name="door7"})
       elseif c=="9" then
-         set_stone("st-door_c", i-1,line, {name="door9", type="v"})
+         set_stone("st-door_c", i-1,line, {name="door9"})
       elseif c =="a" then
          set_item("it-key_a", i-1,line)                  
       elseif c =="b" then
@@ -70,18 +70,18 @@
       elseif c =="C" then
          set_stone("st-key_c", i-1, line, {action="openclose", target="door3"})
       elseif c=="D" then
-     set_stone("st-switch",i-1,line, {action="openclose", target="door4"})         
+         set_stone("st-switch",i-1,line, {action="openclose", target="door4"})         
       elseif c=="F" then
-     set_stone("st-switch",i-1,line, {action="openclose", target="door6"})   
+         set_stone("st-switch",i-1,line, {action="openclose", target="door6"})   
       elseif c=="G" then
-     set_stone("st-switch",i-1,line, {action="openclose", target="door7"})
+         set_stone("st-switch",i-1,line, {action="openclose", target="door7"})
       elseif c=="r" then
-     set_actor("ac-rotor", i,line+1, {mouseforce=0, range=50, force=70})
+         set_actor("ac-rotor", i,line+1, {mouseforce=0, range=50, force=70})
       elseif c=="R" then
-     set_actor("ac-rotor", i,line+1, {mouseforce=0, range=6, force=20})
+         set_actor("ac-rotor", i,line+1, {mouseforce=0, range=6, force=20})
       elseif c=="O" then
-     oxyd(i-1,line)         
-        end
+         oxyd(i-1,line)         
+      end
     end  
 end
 --               012345678901234567890123456789012345678

Modified: trunk/data/levels/enigma_esprit/esprit79_1.xml
===================================================================
--- trunk/data/levels/enigma_esprit/esprit79_1.xml	2008-08-15 11:45:40 UTC (rev 1271)
+++ trunk/data/levels/enigma_esprit/esprit79_1.xml	2008-08-15 13:50:25 UTC (rev 1272)
@@ -3,7 +3,7 @@
   <el:protected>
     <el:info el:type="level">
       <el:identity el:title="esprit 79" el:subtitle="esprit 79" el:id="ss_esp79"/>
-      <el:version el:score="1" el:release="1" el:revision="0" el:status="released"/>
+      <el:version el:score="1" el:release="1" el:revision="1" el:status="released"/>
       <el:author  el:name="Sven Siggelkow" el:email="" el:homepage=""/>
       <el:copyright>Copyright ? 2003 Sven Siggelkow</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
@@ -41,15 +41,14 @@
       elseif c=="C" then
          set_stone("st-coinslot", i-1,line,{target="s1", action="callback"})
       elseif c=="1" then
-         set_stone("st-door_c", i-1,line, {name="door1", type="v"})
+         set_stone("st-door_c", i-1,line, {name="door1"})
       elseif c=="2" then
-         set_stone("st-door_c", i-1,line, {name="door2", type="v"})
+         set_stone("st-door_c", i-1,line, {name="door2"})
       elseif c=="R" then
-     --set_actor("ac-rotor", i-1+0.5,line+0.5, {mouseforce=1, range=25, force=40})
          set_actor("ac-rotor", i-1+0.5,line+0.5, {range=25, force=40})
       elseif c=="O" then
-     oxyd(i-1,line) 
-        end
+         oxyd(i-1,line) 
+      end
     end
 end
 --              01234567890123456789

Modified: trunk/data/levels/enigma_esprit/esprit88_1.xml
===================================================================
--- trunk/data/levels/enigma_esprit/esprit88_1.xml	2008-08-15 11:45:40 UTC (rev 1271)
+++ trunk/data/levels/enigma_esprit/esprit88_1.xml	2008-08-15 13:50:25 UTC (rev 1272)
@@ -3,7 +3,7 @@
   <el:protected>
     <el:info el:type="level">
       <el:identity el:title="The Locksmith" el:subtitle="esprit 88" el:id="ss_esp88"/>
-      <el:version el:score="1" el:release="1" el:revision="0" el:status="released"/>
+      <el:version el:score="1" el:release="1" el:revision="1" el:status="released"/>
       <el:author  el:name="Sven Siggelkow" el:email="" el:homepage=""/>
       <el:copyright>Copyright ? 2003 Sven Siggelkow</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
@@ -28,7 +28,7 @@
     for i=1, strlen(pattern) do
       local c = strsub( pattern, i, i)
       if c ==   "#" then
-         set_stone("st-door_b", i-1,line, {type="v"})
+         set_stone("st-door_b", i-1,line)
       elseif c=="A" then
          abyss(i-1,line)
       elseif c=="x" then
@@ -80,8 +80,8 @@
       elseif c=="q" then
          set_stone("st-key_c", i-1, line)
       elseif c=="O" then 
-     oxyd(i-1,line)  
-        end
+         oxyd(i-1,line)  
+      end
     end
 end
 --              012345678901234567890123456789012345678 

Modified: trunk/data/levels/enigma_esprit/index.xml
===================================================================
--- trunk/data/levels/enigma_esprit/index.xml	2008-08-15 11:45:40 UTC (rev 1271)
+++ trunk/data/levels/enigma_esprit/index.xml	2008-08-15 13:50:25 UTC (rev 1272)
@@ -1,7 +1,7 @@
 <?xml version="1.0" encoding="UTF-8" standalone="no" ?>
 <index xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="index.xsd">
 
-  <info enigma="1.00" group="D?j?-vu" location="20100" network="false" owner="Enigma Team" release="1" revision="2" title="Esprit"/>
+  <info enigma="1.00" group="D?j?-vu" location="20100" network="false" owner="Enigma Team" release="1" revision="3" title="Esprit"/>
 
   <attributes/>
 
@@ -41,7 +41,7 @@
     <level _seq="33" _title="esprit 34" _xpath="./esprit34_2" author="Sven Siggelkow" ctrl="force" easy="false" id="ss_esp34" rel="2" rev="0" score="2" target="time" unit="duration"/>
     <level _seq="34" _title="esprit 35" _xpath="./esprit35_1" author="Sven Siggelkow" ctrl="force" easy="false" id="ss_esp35" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="35" _title="esprit 36" _xpath="./esprit36_1" author="Sven Siggelkow" ctrl="force" easy="false" id="ss_esp36" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="36" _title="esprit 37" _xpath="./esprit37_3" author="Sven Siggelkow" ctrl="force" easy="true" id="ss_esp37" rel="3" rev="2" score="3" target="time" unit="duration"/>
+    <level _seq="36" _title="esprit 37" _xpath="./esprit37_3" author="Sven Siggelkow" ctrl="force" easy="true" id="ss_esp37" rel="3" rev="3" score="3" target="time" unit="duration"/>
     <level _seq="37" _title="esprit 38" _xpath="./esprit38_1" author="Sven Siggelkow" ctrl="force" easy="false" id="ss_esp38" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="38" _title="esprit 39" _xpath="./esprit39_1" author="Sven Siggelkow" ctrl="force" easy="false" id="ss_esp39" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="39" _title="- Meditation -" _xpath="./esprit40_2" author="anonymous" ctrl="force" easy="false" id="meditation7" rel="2" rev="0" score="2" target="time" unit="duration"/>
@@ -67,7 +67,7 @@
     <level _seq="59" _title="esprit 66" _xpath="./esprit66_1" author="Sven Siggelkow" ctrl="force" easy="false" id="ss_esp66" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="60" _title="esprit 67" _xpath="./esprit67_1" author="Martin Hawlisch" ctrl="force" easy="true" id="martin54" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="61" _title="esprit 68" _xpath="./esprit68_1" author="Sven Siggelkow" ctrl="force" easy="false" id="ss_esp68" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="62" _title="esprit 69" _xpath="./esprit69_1" author="Sven Siggelkow" ctrl="force" easy="false" id="ss_esp69" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="62" _title="esprit 69" _xpath="./esprit69_1" author="Sven Siggelkow" ctrl="force" easy="false" id="ss_esp69" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="63" _title="- Meditation -" _xpath="./esprit70_1" author="Sven Siggelkow" ctrl="force" easy="false" id="ss_esp70" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="64" _title="Wicked Road Holes" _xpath="./esprit72_1" author="Siegfried Fennig" ctrl="force" easy="false" id="level6e" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="65" _title="esprit 73" _xpath="./esprit73_1" author="Sven Siggelkow" ctrl="force" easy="false" id="ss_esp73" rel="1" rev="0" score="1" target="time" unit="duration"/>
@@ -75,7 +75,7 @@
     <level _seq="67" _title="esprit 75" _xpath="./esprit75_1" author="Sven Siggelkow" ctrl="force" easy="false" id="ss_esp75" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="68" _title="esprit 76" _xpath="./esprit76_1" author="Sven Siggelkow" ctrl="force" easy="false" id="ss_esp76" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="69" _title="esprit 77" _xpath="./esprit77_1" author="Sven Siggelkow" ctrl="force" easy="false" id="ss_esp77" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="70" _title="esprit 79" _xpath="./esprit79_1" author="Sven Siggelkow" ctrl="force" easy="false" id="ss_esp79" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="70" _title="esprit 79" _xpath="./esprit79_1" author="Sven Siggelkow" ctrl="force" easy="false" id="ss_esp79" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="71" _title="- Meditation -" _xpath="./esprit80_1" author="Sven Siggelkow" ctrl="force" easy="false" id="ss_esp80" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="72" _title="esprit 81" _xpath="./esprit81_1" author="Sven Siggelkow" ctrl="force" easy="false" id="ss_esp81" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="73" _title="esprit 82" _xpath="./esprit82_1" author="Sven Siggelkow" ctrl="force" easy="false" id="ss_esp82" rel="1" rev="0" score="1" target="time" unit="duration"/>
@@ -84,7 +84,7 @@
     <level _seq="76" _title="esprit 85" _xpath="./esprit85_1" author="Sven Siggelkow" ctrl="force" easy="false" id="ss_esp85" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="77" _title="esprit 86" _xpath="./esprit86_1" author="Sven Siggelkow" ctrl="force" easy="false" id="ss_esp86" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="78" _title="esprit 87" _xpath="./esprit87_2" author="Sven Siggelkow" ctrl="force" easy="true" id="ss_esp87" rel="2" rev="0" score="2" target="time" unit="duration"/>
-    <level _seq="79" _title="The Locksmith" _xpath="./esprit88_1" author="Sven Siggelkow" ctrl="force" easy="false" id="ss_esp88" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="79" _title="The Locksmith" _xpath="./esprit88_1" author="Sven Siggelkow" ctrl="force" easy="false" id="ss_esp88" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="80" _title="Death in the Caribbean" _xpath="./esprit89_1" author="Sven Siggelkow" ctrl="force" easy="false" id="ss_esp89" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="81" _title="- Meditation -" _xpath="./esprit90_1" author="Siegfried Fennig" ctrl="force" easy="false" id="meditation8" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="82" _title="esprit 91" _xpath="./esprit91_1" author="Sven Siggelkow" ctrl="force" easy="false" id="ss_esp91" rel="1" rev="0" score="1" target="time" unit="duration"/>

Modified: trunk/data/levels/enigma_oxyd/index.xml
===================================================================
--- trunk/data/levels/enigma_oxyd/index.xml	2008-08-15 11:45:40 UTC (rev 1271)
+++ trunk/data/levels/enigma_oxyd/index.xml	2008-08-15 13:50:25 UTC (rev 1272)
@@ -1,7 +1,7 @@
 <?xml version="1.0" encoding="UTF-8" standalone="no" ?>
 <index xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="index.xsd">
 
-  <info enigma="1.00" group="D?j?-vu" location="20200" network="false" owner="Enigma Team" release="1" revision="2" title="Oxyd"/>
+  <info enigma="1.00" group="D?j?-vu" location="20200" network="false" owner="Enigma Team" release="1" revision="3" title="Oxyd"/>
 
   <attributes/>
 
@@ -34,7 +34,7 @@
     <level _seq="26" _title="Take a Break" _xpath="./oxyd39_1" author="Siegfried Fennig" ctrl="force" easy="false" id="siegfried72" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="27" _title="Jump Pads" _xpath="./oxyd51_1" author="Siegfried Fennig" ctrl="force" easy="false" id="siegfried88" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="28" _title="Moonwalking" _xpath="./oxyd52_1" author="Ulf Stegemann" ctrl="force" easy="false" id="20060629ulf006" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="29" _title="Scrooge" _xpath="./oxyd53_1" author="Siegfried Fennig" ctrl="force" easy="false" id="siegfried100" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="29" _title="Scrooge" _xpath="./oxyd53_1" author="Siegfried Fennig" ctrl="force" easy="false" id="siegfried100" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="30" _title="Soaring High" _xpath="./oxyd54_1" author="Siegfried Fennig" ctrl="force" easy="false" id="siegfried101" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="31" _title="Oxyd 70" _xpath="./oxyd70_1" author="Raoul Bourquin" ctrl="force" easy="false" id="oxyd70" rel="1" rev="2" score="1" target="time" unit="duration"/>
     <level _seq="32" _title="Oxyd 77" _xpath="./oxyd77_1" author="Raoul Bourquin" ctrl="force" easy="false" id="oxyd77" rel="1" rev="0" score="1" target="time" unit="duration"/>

Modified: trunk/data/levels/enigma_oxyd/oxyd53_1.xml
===================================================================
--- trunk/data/levels/enigma_oxyd/oxyd53_1.xml	2008-08-15 11:45:40 UTC (rev 1271)
+++ trunk/data/levels/enigma_oxyd/oxyd53_1.xml	2008-08-15 13:50:25 UTC (rev 1272)
@@ -3,7 +3,7 @@
   <el:protected>
     <el:info el:type="level">
       <el:identity el:title="Scrooge" el:subtitle="Oxyd 53" el:id="siegfried100"/>
-      <el:version el:score="1" el:release="1" el:revision="0" el:status="released"/>
+      <el:version el:score="1" el:release="1" el:revision="1" el:status="released"/>
       <el:author  el:name="Siegfried Fennig" el:email="" el:homepage=""/>
       <el:copyright>Copyright ? 2003 Siegfried Fennig</el:copyright>
       <el:license el:type="GPL version 2" el:open="true"/>
@@ -295,18 +295,18 @@
     end
 end
 
-set_stone("st-door_a", 23, 6, {name="door1",  type="v"})
-set_stone("st-door_a", 24, 6, {name="door2",  type="v"})
-set_stone("st-door_a", 25, 6, {name="door3",  type="v"})
-set_stone("st-door_a", 26, 6, {name="door4",  type="v"})
-set_stone("st-door_a", 27, 6, {name="door5",  type="v"})
-set_stone("st-door_a", 28, 6, {name="door6",  type="v"})
-set_stone("st-door_a", 29, 6, {name="door7",  type="v"})
-set_stone("st-door_a", 30, 6, {name="door8",  type="v"})
-set_stone("st-door_a", 31, 6, {name="door9",  type="v"})
-set_stone("st-door_a", 32, 6, {name="door10", type="v"})
-set_stone("st-door_a", 33, 6, {name="door11", type="v"})
-set_stone("st-door_a", 34, 6, {name="door12", type="v"})
+set_stone("st-door_a", 23, 6, {name="door1"})
+set_stone("st-door_a", 24, 6, {name="door2"})
+set_stone("st-door_a", 25, 6, {name="door3"})
+set_stone("st-door_a", 26, 6, {name="door4"})
+set_stone("st-door_a", 27, 6, {name="door5"})
+set_stone("st-door_a", 28, 6, {name="door6"})
+set_stone("st-door_a", 29, 6, {name="door7"})
+set_stone("st-door_a", 30, 6, {name="door8"})
+set_stone("st-door_a", 31, 6, {name="door9"})
+set_stone("st-door_a", 32, 6, {name="door10"})
+set_stone("st-door_a", 33, 6, {name="door11"})
+set_stone("st-door_a", 34, 6, {name="door12"})
 
 switch1 = 0
 switch2 = 0

Modified: trunk/data/levels/enigma_peroxyd/index.xml
===================================================================
--- trunk/data/levels/enigma_peroxyd/index.xml	2008-08-15 11:45:40 UTC (rev 1271)
+++ trunk/data/levels/enigma_peroxyd/index.xml	2008-08-15 13:50:25 UTC (rev 1272)
@@ -1,7 +1,7 @@
 <?xml version="1.0" encoding="UTF-8" standalone="no" ?>
 <index xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="index.xsd">
 
-  <info enigma="1.00" group="D?j?-vu" location="20300" network="false" owner="Enigma Team" release="1" revision="1" title="PerOxyd"/>
+  <info enigma="1.00" group="D?j?-vu" location="20300" network="false" owner="Enigma Team" release="1" revision="2" title="PerOxyd"/>
 
   <attributes/>
 
@@ -41,7 +41,7 @@
     <level _seq="33" _title="One Single Try" _xpath="./peroxyd75_1" author="Siegfried Fennig" ctrl="force" easy="false" id="siegfried78" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="34" _title="Plumbing" _xpath="./peroxyd79_1" author="Siegfried Fennig" ctrl="force" easy="false" id="level7e" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="35" _title="- Meditation -" _xpath="./peroxyd80_1" author="Daniel Heck" ctrl="force" easy="false" id="daniel5" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="36" _title="Break the Circle" _xpath="./peroxyd82_1" author="Siegfried Fennig" ctrl="force" easy="false" id="siegfried102" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="36" _title="Break the Circle" _xpath="./peroxyd82_1" author="Siegfried Fennig" ctrl="force" easy="false" id="siegfried102" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="37" _title="Per.Oxyd 88" _xpath="./peroxyd88_1" author="Raoul Bourquin" ctrl="force" easy="false" id="peroxyd88" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="38" _title="No Safety Net" _xpath="./peroxyd96_1" author="Siegfried Fennig" ctrl="force" easy="false" id="siegfried90" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="39" _title="Pipe Dreams" _xpath="./peroxyd99_1" author="Siegfried Fennig" ctrl="force" easy="false" id="level1e" rel="1" rev="0" score="1" target="time" unit="duration"/>

Modified: trunk/data/levels/enigma_peroxyd/peroxyd82_1.xml
===================================================================
--- trunk/data/levels/enigma_peroxyd/peroxyd82_1.xml	2008-08-15 11:45:40 UTC (rev 1271)
+++ trunk/data/levels/enigma_peroxyd/peroxyd82_1.xml	2008-08-15 13:50:25 UTC (rev 1272)
@@ -3,7 +3,7 @@
   <el:protected>
     <el:info el:type="level">
       <el:identity el:title="Break the Circle" el:subtitle="Per.Oxyd 82" el:id="siegfried102"/>
-      <el:version el:score="1" el:release="1" el:revision="0" el:status="released"/>
+      <el:version el:score="1" el:release="1" el:revision="1" el:status="released"/>
       <el:author  el:name="Siegfried Fennig" el:email="" el:homepage=""/>
       <el:copyright>Copyright ? 2003 Siegfried Fennig</el:copyright>
       <el:license el:type="GPL version 2" el:open="true"/>
@@ -58,17 +58,17 @@
          set_stone("st-timeswitch",i-1,line, {action="openclose", target="door1"})
       elseif c == "2" then
 --         set_stone("st-door",i-1,line, {name="door1",  type="h"})
-         set_stone("st-door_a",i-1,line, {name="door1",  type="h"})
+         set_stone("st-door_a",i-1,line, {name="door1"})
       elseif c == "3" then
          set_stone("st-timeswitch",i-1,line, {action="openclose", target="door2"})
       elseif c == "4" then
 --         set_stone("st-door",i-1,line, {name="door2",  type="h"})
-         set_stone("st-door_a",i-1,line, {name="door2",  type="h"})
+         set_stone("st-door_a",i-1,line, {name="door2"})
       elseif c == "5" then
          set_stone("st-timeswitch",i-1,line, {action="openclose", target="door3"})
       elseif c == "6" then
 --         set_stone("st-door",i-1,line, {name="door3",  type="h"})
-         set_stone("st-door_a",i-1,line, {name="door3",  type="h"})
+         set_stone("st-door_a",i-1,line, {name="door3"})
       elseif c == "z" then
          set_item("it-wrench",i-1,line)
       elseif c == "f" then

Modified: trunk/data/levels/enigma_vi/duffy134_1.xml
===================================================================
--- trunk/data/levels/enigma_vi/duffy134_1.xml	2008-08-15 11:45:40 UTC (rev 1271)
+++ trunk/data/levels/enigma_vi/duffy134_1.xml	2008-08-15 13:50:25 UTC (rev 1272)
@@ -3,7 +3,7 @@
   <el:protected>
     <el:info el:type="level">
       <el:identity el:title="Pleasure Garden" el:subtitle="" el:id="duffy134"/>
-      <el:version el:score="1" el:release="1" el:revision="4" el:status="released"/>
+      <el:version el:score="1" el:release="1" el:revision="5" el:status="released"/>
       <el:author  el:name="Jacob Scott" el:email="" el:homepage=""/>
       <el:copyright>Copyright ? 2007 Jacob Scott</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
@@ -103,20 +103,20 @@
         elseif c == "z" then
             set_actor("ac-blackball", i-1,line, {player=0})
         elseif c == "a" then
-            set_stone("st-shogun", i-1, line, {holes=1})
+            set_stone("st-shogun-s", i-1, line)
             set_floor("fl-water",i-1,line)
         elseif c == "n" then
-            set_stone("st-shogun", i-1, line, {holes=2})
+            set_stone("st-shogun-m", i-1, line)
         elseif c == "O" then
-            set_stone("st-shogun", i-1, line, {holes=1})
+            set_stone("st-shogun-s", i-1, line)
         elseif c == "p" then
-            set_stone("st-shogun", i-1, line, {holes=2})
+            set_stone("st-shogun-m", i-1, line)
         elseif c == "q" then
-            set_stone("st-shogun", i-1, line, {holes=4})
+            set_stone("st-shogun-l", i-1, line)
         elseif c == "S" then
-            set_stone("st-shogun", i-1, line, {holes=4})
+            set_stone("st-shogun-l", i-1, line)
         elseif c == "r" then
-            set_stone("st-shogun", i-1, line, {holes=1})
+            set_stone("st-shogun-s", i-1, line)
         elseif c == "~" then
             mirror3(i-1,line,TRUE,FALSE, 1)
         elseif c == "H" then

Modified: trunk/data/levels/enigma_vi/index.xml
===================================================================
--- trunk/data/levels/enigma_vi/index.xml	2008-08-15 11:45:40 UTC (rev 1271)
+++ trunk/data/levels/enigma_vi/index.xml	2008-08-15 13:50:25 UTC (rev 1272)
@@ -1,7 +1,7 @@
 <?xml version="1.0" encoding="UTF-8" standalone="no" ?>
 <index xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="index.xsd">
 
-  <info enigma="1.00" group="Enigma" location="10700" network="false" owner="Enigma Team" release="1" revision="13" title="Enigma VI"/>
+  <info enigma="1.00" group="Enigma" location="10700" network="false" owner="Enigma Team" release="1" revision="14" title="Enigma VI"/>
 
   <attributes/>
 
@@ -100,7 +100,7 @@
     <level _seq="92" _title="Oxyd Drilling" _xpath="./duffy140_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy140" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="93" _title="Parish Fair" _xpath="./duffy143_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy143" rel="1" rev="2" score="1" target="time" unit="duration"/>
     <level _seq="94" _title="In the Middle" _xpath="./duffy141_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy141" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="95" _title="Pleasure Garden" _xpath="./duffy134_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy134" rel="1" rev="4" score="1" target="time" unit="duration"/>
+    <level _seq="95" _title="Pleasure Garden" _xpath="./duffy134_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy134" rel="1" rev="5" score="1" target="time" unit="duration"/>
     <level _seq="96" _title="Construction Workers" _xpath="./duffy142_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy142" rel="1" rev="3" score="1" target="time" unit="duration"/>
     <level _seq="97" _title="City Life" _xpath="./joona03_1" author="Joona Laire" ctrl="force" easy="true" id="20061119joona503" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="98" _title="Industrial Puzzles" _xpath="./raoul30_2" author="Raoul Bourquin" ctrl="force" easy="false" id="raoul30" rel="2" rev="6" score="2" target="time" unit="duration"/>

Modified: trunk/data/levels/enigma_viii/index.xml
===================================================================
--- trunk/data/levels/enigma_viii/index.xml	2008-08-15 11:45:40 UTC (rev 1271)
+++ trunk/data/levels/enigma_viii/index.xml	2008-08-15 13:50:25 UTC (rev 1272)
@@ -1,7 +1,7 @@
 <?xml version="1.0" encoding="UTF-8" standalone="no" ?>
 <index xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="index.xsd">
 
-  <info enigma="1.00" group="Enigma" location="10900" network="false" owner="Enigma Team" release="1" revision="4" title="Enigma VIII"/>
+  <info enigma="1.00" group="Enigma" location="10900" network="false" owner="Enigma Team" release="1" revision="5" title="Enigma VIII"/>
 
   <attributes/>
 
@@ -22,7 +22,7 @@
     <level _seq="14" _title="The Green Hell" _xpath="./mecke22_1" author="mecke" ctrl="force" easy="true" id="mecke22" rel="1" rev="55" score="1" target="time" unit="duration"/>
     <level _seq="15" _title="Tilt Board" _xpath="./ulf06_2" author="Ulf Stegemann" ctrl="force" easy="true" id="20080529ulf118" rel="2" rev="116" score="2" target="time" unit="duration"/>
     <level _seq="16" _title="4 - 8 - 4" _xpath="./dpl03_3" author="Dominik Leipold" ctrl="force" easy="true" id="20070821dpl003" rel="3" rev="4" score="3" target="time" unit="duration"/>
-    <level _seq="17" _title="Impulsive Order" _xpath="./raywick05_1" author="Ray Wick" ctrl="force" easy="true" id="raywick5" rel="1" rev="4" score="1" target="time" unit="duration"/>
+    <level _seq="17" _title="Impulsive Order" _xpath="./raywick05_1" author="Ray Wick" ctrl="force" easy="true" id="raywick5" rel="1" rev="5" score="1" target="time" unit="duration"/>
     <level _seq="18" _title="Cross Mail" _xpath="./johann03_1" author="Johann Freymuth" ctrl="force" easy="false" id="johann03" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="19" _title="Color Maze" _xpath="./pulley16_3" author="Mark Pulley" ctrl="force" easy="false" id="pulley16" rel="3" rev="4" score="3" target="time" unit="duration"/>
     <level _seq="20" _title="Earthlink" _xpath="./pulley15_1" author="Mark Pulley" ctrl="force" easy="true" id="pulley15" rel="1" rev="0" score="1" target="time" unit="duration"/>

Modified: trunk/data/levels/enigma_viii/raywick05_1.xml
===================================================================
--- trunk/data/levels/enigma_viii/raywick05_1.xml	2008-08-15 11:45:40 UTC (rev 1271)
+++ trunk/data/levels/enigma_viii/raywick05_1.xml	2008-08-15 13:50:25 UTC (rev 1272)
@@ -3,7 +3,7 @@
   <el:protected>
     <el:info el:type="level">
       <el:identity el:title="Impulsive Order" el:subtitle="" el:id="raywick5"/>
-      <el:version el:score="1" el:release="1" el:revision="4" el:status="released"/>
+      <el:version el:score="1" el:release="1" el:revision="5" el:status="released"/>
       <el:author  el:name="Ray Wick" el:email=""/>
       <el:copyright>Copyright ? 2008 Ray Wick</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
@@ -36,10 +36,10 @@
 ti["5"] = {"st-stoneimpulse", name="outer#"}
 ti["L"] = {"st_laser_s", name="laser1"}
 ti["M"] = {"st_mirror", transparent=true, orientation=0}
-ti["Z"] = {"st-shogun-sml"}
+ti["Z"] = {"st_shogun_sml"}
 ti["x"] = {"it-blackbomb"}
 ti["s"] = ti["G"] .. {"it-spring1"}
-ti["z"] = {"it-shogun-l", action="open", target="door1"}
+ti["z"] = {"it_shogun_l", action="open", target="door1"}
 ti["B"] = {"it_trigger", action_1="signal", action_0="nop", target="outer#*"}
 ti["C"] = {"it_trigger", action_1="signal", action_0="nop", target="inner#*"}
 ti["E"] = {"it_trigger", action="toggle", target="laser1"}

Modified: trunk/src/items/WormHole.cc
===================================================================
--- trunk/src/items/WormHole.cc	2008-08-15 11:45:40 UTC (rev 1271)
+++ trunk/src/items/WormHole.cc	2008-08-15 13:50:25 UTC (rev 1272)
@@ -23,6 +23,7 @@
 //#include "errors.hh"
 //#include "main.hh"
 //#include "server.hh"
+#include "client.hh"
 #include "world.hh"
 
 namespace enigma {

Modified: trunk/src/items/WormHole.hh
===================================================================
--- trunk/src/items/WormHole.hh	2008-08-15 11:45:40 UTC (rev 1271)
+++ trunk/src/items/WormHole.hh	2008-08-15 13:50:25 UTC (rev 1272)
@@ -23,6 +23,9 @@
 
 #include "enigma.hh"
 
+#include "world.hh"
+#include "errors.hh"
+
 namespace enigma {
     class WormHole : public Item, public ForceField, public TimeHandler {
     private:



From andreasl at mail.berlios.de  Sun Aug 17 01:22:18 2008
From: andreasl at mail.berlios.de (andreasl at mail.berlios.de)
Date: Sun, 17 Aug 2008 01:22:18 +0200
Subject: [Enigma-game-svn] r1273 - in homepage/input: . articles lotm
Message-ID: <200808162322.m7GNMICY005382@sheep.berlios.de>

Author: andreasl
Date: 2008-08-17 01:21:54 +0200 (Sun, 17 Aug 2008)
New Revision: 1273

Added:
   homepage/input/articles/apprentice_1.html
   homepage/input/articles/apprentice_1_de.html
   homepage/input/articles/infobox_apprentice.html
   homepage/input/articles/infobox_apprentice_de.html
   homepage/input/articles/infobox_apprentice_ru.html
   homepage/input/level_archive.html
   homepage/input/level_archive_de.html
Modified:
   homepage/input/articles/eoya_2007.html
   homepage/input/articles/eoya_2007_de.html
   homepage/input/articles/eoya_2007_ru.html
   homepage/input/faq_core.html
   homepage/input/faq_core_de.html
   homepage/input/faq_core_ru.html
   homepage/input/hp_archive.html
   homepage/input/hp_archive_de.html
   homepage/input/hp_archive_ru.html
   homepage/input/infobox.html
   homepage/input/infobox_de.html
   homepage/input/infobox_ru.html
   homepage/input/lotm/lotm_archive_data.lua
   homepage/input/lotm/read_lotm.lua
   homepage/input/output-files.lua
   homepage/input/top_news.html
   homepage/input/top_news_de.html
   homepage/input/top_news_ru.html
Log:
Homepage:
 - New article "The Apprentice, Part 1" ("Der Neuling")
 - New section "Level Archive" (sometimes called "Level Article Archive"),
     currently only reachable through "Homepage Archive".
 - Small addition to FAQ "screensaver"
 - Infobox: Announcement of "The Apprentice"
Todo:
 - Validation of the changed files.
 - The level archive currently doesn't allow a translation of the
     occasions (like "Best Onescreener", "April Fool's Day Joke").
     It's algorithms and data are in the LotM-lua-files - maybe
     we should change this or rename the files.
 - Russian Translation:
    - apprentice_1_ru (new from apprentice_1)
    - infobox_apprentice_ru
    - faq_core_ru (question "s2q1")
    - infobox_ru (at the top)
    - top_news_ru (at the bottom)
    - hp_archive_ru ("Articles sorted ..." and "The Apprentice")
    - level_archive_ru (new from level_archive)
    - output-files.lua (at the bottom):
       - html.level_archive
       - html.apprentice_1





Added: homepage/input/articles/apprentice_1.html
===================================================================
--- homepage/input/articles/apprentice_1.html	2008-08-15 13:50:25 UTC (rev 1272)
+++ homepage/input/articles/apprentice_1.html	2008-08-16 23:21:54 UTC (rev 1273)
@@ -0,0 +1,28 @@
+
+<h2>The Apprentice &mdash; &quot;You are welcome&quot;</h2>
+
+<p>
+Interested friends who ask me, what's about Enigma, what is it
+&quot;like&quot;, whether the game is &quot;worth the while&quot;, all these
+many levels &hellip; I say to them: Be glad, you still have all of them to
+play! The apprentice looks perplexed at the first twelve &quot;previews&quot;
+of the opened level pack and starts &quot;Welcome&quot;&mdash;and opens
+&quot;his&quot; first oxyds, still unsure in the handling of the marble that
+now is under his thumb. Was this all? Yes&mdash;Level finished. So easy?
+Yes&mdash;in some respect every level is a &quot;Welcome&quot;-level &hellip;
+with more or less obstacles! Light up the oxyds&mdash;and, as a diversion,
+meditate in &quot;meditation levels&quot;: make &quot;the&quot; marble
+&quot;stay&quot;. The preview shows the apprentice, still lucky about the
+solved &quot;Welcome&quot;, that every enclosed level differs in color,
+composition, shape &hellip;, and at the latest during the first contact with
+the &quot;death's-head&quot; it realises &quot;landscapes&quot; of varying
+challenge, menaces, that seem limitless in their evolution: Over 1000 levels!
+And then he sees: Yes&mdash;I &quot;know&quot; the level = x% solved, but there
+is still much to do&mdash;fortunately! And thanks to all those that made this
+possible. And maybe, some day, he starts to &quot;make it possible&quot; as
+well: You are welcome!
+</p>
+
+<p><i>
+Mecke
+</p></i>

Added: homepage/input/articles/apprentice_1_de.html
===================================================================
--- homepage/input/articles/apprentice_1_de.html	2008-08-15 13:50:25 UTC (rev 1272)
+++ homepage/input/articles/apprentice_1_de.html	2008-08-16 23:21:54 UTC (rev 1273)
@@ -0,0 +1,28 @@
+
+<h2>Der Neuling &mdash; &quot;You are welcome&quot;</h2>
+
+<p>
+Interessierten, die mich fragen, wie das mit Enigma &quot;so sei&quot;, ob das
+Spiel &quot;lohne&quot;, diese vielen Level &hellip; sage ich: Sei froh, du hast noch
+alle vor dir! Verdutzt schaut der Neuling auf die im aufgerufenen Levelpaket
+angezeigten ersten 12 &quot;Vorschauen&quot; und startet  &quot;Welcome&quot; -
+und &ouml;ffnet &quot;seine&quot; ersten Oxyds, noch unsicher im Umgang mit der in
+seiner &quot;Gewalt&quot; befindlichen Kugel.  War's das? Ja - Level geschafft.
+So einfach? Ja - jeder Level ist im Prinzip ein &quot;Welcome&quot;-Spiel &hellip;
+mit mehr oder weniger Hindernissen! Bring die Oxyds zum leuchten - und, als
+Abwechslung, meditiere in &quot;Meditationsleveln&quot;: bring &quot;die&quot;
+Kugel zum &quot;verweilen&quot;. Die Levelvorschau zeigt dem Neuling, noch
+gl&uuml;cklich &uuml;ber das gel&ouml;ste  &quot;Welcome&quot;, dass jeder
+angebotene Level sich in Farbe, Aufbau, Form &hellip; unterscheidet, und
+sp&auml;testens beim Erstkontakt mit einem &quot;Totenkopf&quot; realisiert es
+&quot;Landschaften&quot; mit unterschiedlichen Herausforderungen, Bedrohungen,
+die in ihrer Evolution dann grenzenlos erscheint: &uuml;ber 1000 Level! Und dann
+sieht er: Ja - ich &quot;kenne&quot; den Level = x% geloest, aber da liegt noch
+viel vor mir - zum Gl&uuml;ck! Und dank all jener, die das erm&ouml;glicht
+haben. Und vielleicht, irgendwann, ist er selbst dabei, mit zu
+&quot;erm&ouml;glichen&quot;: You are welcome!
+</p>
+
+<p><i>
+Mecke
+</p></i>

Modified: homepage/input/articles/eoya_2007.html
===================================================================
--- homepage/input/articles/eoya_2007.html	2008-08-15 13:50:25 UTC (rev 1272)
+++ homepage/input/articles/eoya_2007.html	2008-08-16 23:21:54 UTC (rev 1273)
@@ -205,7 +205,9 @@
 
 <p>And here they are:</p>
 
+<a name="best_onescreener">
 <h3>Best Onescreener 2007: &quot;Doors Galore&quot; by Ray Wick</h3>
+</a>
 
 <p>
   <img class="leftimage" src="$$imagedir$$/articles/eoya_2007_h.png" alt="Doors Galore, IV/9" border="0">
@@ -218,7 +220,9 @@
 winning margin over &quot;Plan Ahead&quot; (3.59) and &quot;Industrial
 Puzzles&quot; (3.50).</p>
 
+<a name="best_levelseries">
 <h3>Best Levelseries 2007: &quot;Gods of Enigma&quot; by moonpearl</h3>
+</a>
 
 <p>
   <img class="leftimage" src="$$imagedir$$/articles/eoya_2007_f.png" alt="Gods of Enigma, V/67" border="0">
@@ -242,8 +246,10 @@
   <img class="leftimage" src="$$imagedir$$/articles/longline.png" alt="" border="0">
 </p>
 
+<a name="best_design">
 <h3>Best Design 2007: &quot;The Aztec Temple&quot; by Dominik
 Lehmann</h3>
+</a>
 
 <p>
   <img class="leftimage" src="$$imagedir$$/articles/eoya_2007_i.png" alt="The Aztec Temple, VI/100" border="0">
@@ -257,8 +263,10 @@
 caverns, from now on the jungle will be a new possible setting for our level
 authors.</p>
 
+<a name="funniest_level">
 <h3>Funniest Levels 2007: &quot;Advancing&quot; and &quot;Mountain
 Climbing&quot; by Joseph Dunne</h3>
+</a>
 
 <p>
   <img class="leftimage" src="$$imagedir$$/articles/eoya_2007_d.png" alt="Advancing, VII/23" border="0">
@@ -282,7 +290,9 @@
   <img class="leftimage" src="$$imagedir$$/articles/longline.png" alt="" border="0">
 </p>
 
+<a name="best_yinyang">
 <h3>Best Yin-Yang Level 2007: &quot;Teamwork&quot; by Jacob Scott</h3>
+</a>
 
 <p>
   <img class="leftimage" src="$$imagedir$$/articles/eoya_2007_c.png" alt="Teamwork, III/18" border="0">
@@ -297,7 +307,9 @@
 
 <p>And now, to the most important category:</p>
 
+<a name="loty">
 <h3>Level of the Year 2007: &quot;Island Labyrinth&quot; by Jacob Scott!</h3>
+</a>
 
 <p>
   <img class="leftimage" src="$$imagedir$$/articles/eoya_2007_b.png" alt="Island Labyrinth, V/100" border="0">

Modified: homepage/input/articles/eoya_2007_de.html
===================================================================
--- homepage/input/articles/eoya_2007_de.html	2008-08-15 13:50:25 UTC (rev 1272)
+++ homepage/input/articles/eoya_2007_de.html	2008-08-16 23:21:54 UTC (rev 1273)
@@ -214,7 +214,9 @@
 
 <p>Und hier sind sie:</p>
 
+<a name="best_onescreener">
 <h3>Bester Onescreener 2007: &quot;Doors Galore&quot; von Ray Wick</h3>
+</a>
 
 <p>
   <img class="leftimage" src="$$imagedir$$/articles/eoya_2007_h.png" alt="Doors Galore, IV/9" border="0">
@@ -227,7 +229,9 @@
 Wick einen bemerkenswerten Vorsprung vor &quot;Plan Ahead&quot; (3,59) und
 &quot;Industrial Puzzles&quot; (3,50).</p>
 
+<a name="best_levelseries">
 <h3>Beste Levelserie 2007: &quot;Gods of Enigma&quot; von moonpearl</h3>
+</a>
 
 <p>
   <img class="leftimage" src="$$imagedir$$/articles/eoya_2007_f.png" alt="Gods of Enigma, V/67" border="0">
@@ -253,8 +257,10 @@
   <img class="leftimage" src="$$imagedir$$/articles/longline.png" alt="" border="0">
 </p>
 
+<a name="best_design">
 <h3>Bestes Design 2007: &quot;The Aztec Temple&quot; von Dominik
 Lehmann</h3>
+</a>
 
 <p>
   <img class="leftimage" src="$$imagedir$$/articles/eoya_2007_i.png" alt="The Aztec Temple, VI/100" border="0">
@@ -269,8 +275,10 @@
 wird von nun an der Dschungel ein neues m&ouml;gliches Setting f&uuml;r unsere
 Levelautoren sein.</p>
 
+<a name="funniest_level">
 <h3>Lustigste Levels 2007: &quot;Advancing&quot; und &quot;Mountain
 Climbing&quot; von Joseph Dunne</h3>
+</a>
 
 <p>
   <img class="leftimage" src="$$imagedir$$/articles/eoya_2007_d.png" alt="Advancing, VII/23" border="0">
@@ -295,8 +303,10 @@
   <img class="leftimage" src="$$imagedir$$/articles/longline.png" alt="" border="0">
 </p>
 
+<a name="best_yinyang">
 <h3>Bester Yin-Yang-Level 2007: &quot;Teamwork&quot; von Jacob
 Scott</h3>
+</a>
 
 <p>
   <img class="leftimage" src="$$imagedir$$/articles/eoya_2007_c.png" alt="Teamwork, III/18" border="0">
@@ -311,7 +321,9 @@
 
 <p>Und nun, die wichtigste Kategorie:</p>
 
+<a name="loty">
 <h3>Level des Jahres 2007: &quot;Island Labyrinth&quot; von Jacob Scott!</h3>
+</a>
 
 <p>
   <img class="leftimage" src="$$imagedir$$/articles/eoya_2007_b.png" alt="Island Labyrinth, V/100" border="0">

Modified: homepage/input/articles/eoya_2007_ru.html
===================================================================
--- homepage/input/articles/eoya_2007_ru.html	2008-08-15 13:50:25 UTC (rev 1272)
+++ homepage/input/articles/eoya_2007_ru.html	2008-08-16 23:21:54 UTC (rev 1273)
@@ -144,7 +144,9 @@
 
 <p>? ??? ? ???:</p>
 
+<a name="best_onescreener">
 <h3>?????? ???????????? ??????? 2007: &quot;Doors Galore&quot; ?? Ray Wick</h3>
+</a>
 
 <p>
   <img class="leftimage" src="$$imagedir$$/articles/eoya_2007_h.png" alt="Doors Galore, IV/9" border="0">
@@ -153,7 +155,9 @@
 
 <p>&quot;Doors Galore&quot; - ???? ?? ????? ???????????? ? &quot;????????&quot; ??????? ? Enigma, ???????????? ??????? ??????? ?????? ? ?????????????? ?????????. ? 3.89 ?? 5 ????????? ?????, Ray Wick ?????????? ?????????? ??????, ??????????? ?? &quot;Plan Ahead&quot; (3.59) ? &quot;Industrial Puzzles&quot; (3.50).</p>
 
+<a name="best_levelseries">
 <h3>?????? ????? ??????? 2007: &quot;Gods of Enigma&quot; ?? moonpearl</h3>
+</a>
 
 <p>
   <img class="leftimage" src="$$imagedir$$/articles/eoya_2007_f.png" alt="Gods of Enigma, V/67" border="0">
@@ -173,7 +177,9 @@
 <img class="leftimage" src="$$imagedir$$/articles/longline.png" alt="" border="0">
 </p>
 
+<a name="best_design">
 <h3>?????? ?????????? 2007: &quot;The Aztec Temple&quot; ?? Dominik Lehmann</h3>
+</a>
 
 <p>
   <img class="leftimage" src="$$imagedir$$/articles/eoya_2007_i.png" alt="The Aztec Temple, VI/100" border="0">
@@ -184,7 +190,9 @@
 ??????? ?????? ??? 2007, ? 4.19 ??????, &quot;The Aztec Temple&quot; ???????????? &quot;Mountain Climbing&quot; (3.80) ? &quot;Solar System&quot; (3.68), ? ?????????? ? ?????? Enigma ????? ?????????: ????? ??????????? ????????, ?????, ??????? ? ?????? ?????, ? ????? ??????? ??????? ??????
 ????? ????????? ?????????? ??? ????? ??????? ???????.</p>
 
+<a name="funniest_level">
 <h3>????? ???????? ?????? 2007: &quot;Advancing&quot; ? &quot;Mountain Climbing&quot; ?? Joseph Dunne</h3>
+</a>
 
 <p>
   <img class="leftimage" src="$$imagedir$$/articles/eoya_2007_d.png" alt="Advancing, VII/23" border="0">
@@ -203,7 +211,9 @@
 <img class="leftimage" src="$$imagedir$$/articles/longline.png" alt="" border="0">
 </p>
 
+<a name="best_yinyang">
 <h3>?????? ???-??? ??????? 2007: &quot;Teamwork&quot; ?? Jacob Scott</h3>
+</a>
 
 <p>
   <img class="leftimage" src="$$imagedir$$/articles/eoya_2007_c.png" alt="Teamwork, III/18" border="0">
@@ -214,7 +224,9 @@
 
 <p>? ??????, ????? ?????? ?????????:</p>
 
+<a name="loty">
 <h3>??????? ???? 2007: &quot;Island Labyrinth&quot; ?? Jacob Scott!</h3>
+</a>
 
 <p>
   <img class="leftimage" src="$$imagedir$$/articles/eoya_2007_b.png" alt="Island Labyrinth, V/100" border="0">

Added: homepage/input/articles/infobox_apprentice.html
===================================================================
--- homepage/input/articles/infobox_apprentice.html	2008-08-15 13:50:25 UTC (rev 1272)
+++ homepage/input/articles/infobox_apprentice.html	2008-08-16 23:21:54 UTC (rev 1273)
@@ -0,0 +1,6 @@
+    <div class="infobody">
+       <div class="info">
+         <h3>The Apprentice</h3>
+         <a href="$$apprentice_1$$">Part 1: <br>&quot;You are welcome&quot;</a>
+       </div>
+    </div>

Added: homepage/input/articles/infobox_apprentice_de.html
===================================================================
--- homepage/input/articles/infobox_apprentice_de.html	2008-08-15 13:50:25 UTC (rev 1272)
+++ homepage/input/articles/infobox_apprentice_de.html	2008-08-16 23:21:54 UTC (rev 1273)
@@ -0,0 +1,6 @@
+    <div class="infobody">
+       <div class="info">
+         <h3>Der Neuling</h3>
+         <a href="$$apprentice_1$$">Teil 1: <br>&quot;You are welcome&quot;</a>
+       </div>
+    </div>

Added: homepage/input/articles/infobox_apprentice_ru.html
===================================================================
--- homepage/input/articles/infobox_apprentice_ru.html	2008-08-15 13:50:25 UTC (rev 1272)
+++ homepage/input/articles/infobox_apprentice_ru.html	2008-08-16 23:21:54 UTC (rev 1273)
@@ -0,0 +1,6 @@
+    <div class="infobody">
+       <div class="info">
+         <h3>The Apprentice</h3>
+         <a href="$$apprentice_1$$">Part 1: <br>&quot;You are welcome&quot;</a>
+       </div>
+    </div>

Modified: homepage/input/faq_core.html
===================================================================
--- homepage/input/faq_core.html	2008-08-15 13:50:25 UTC (rev 1272)
+++ homepage/input/faq_core.html	2008-08-16 23:21:54 UTC (rev 1273)
@@ -109,7 +109,16 @@
 not noticed by the screen saver, and so it thinks you're not using
 your computer. You can either deactivate your screen saver, or try
 to toggle from window-mode to fullscreen-mode (see &quot;options
-menu&quot;).</p>
+menu&quot;).</p><p>
+If you are using GNOME, you can run this in a terminal window:
+<pre>
+gnome-screensaver-command --inhibit
+</pre>
+(it will not quit&mdash;just leave it running!) Then run Enigma. When you're done
+with Enigma, press Ctrl+C on the &quot;inhibit&quot; command, and your screen
+saver should be working again. Closing the terminal window should also stop the
+&quot;inhibit&quot; command.
+</p>
 
 
 <h4><a name="s2q2">Enigma doesn't start, it gives an error message of the kind

Modified: homepage/input/faq_core_de.html
===================================================================
--- homepage/input/faq_core_de.html	2008-08-15 13:50:25 UTC (rev 1272)
+++ homepage/input/faq_core_de.html	2008-08-16 23:21:54 UTC (rev 1273)
@@ -120,6 +120,17 @@
 Sie h&auml;tten Ihren Computer seit einiger Zeit nicht verwendet. Sie k&ouml;nnen
 entweder den Bildschirmschoner abschalten, oder versuchen vom Fenster- in den
 Vollbildmodus zu wechseln (siehe &quot;Options Men&uuml;&quot;).</p>
+<p>Falls Sie GNOME benutzen, k&ouml;nnen Sie folgenden Befehl in einem
+Terminalfenster starten:
+<pre>
+gnome-screensaver-command --inhibit
+</pre>
+(der Befehl wird nicht beendet - lassen Sie ihn einfach laufen!) Dann starten
+Sie Enigma. Wenn Sie Enigma wieder beendet haben, dr&uuml;cken Sie Ctrl+C im
+Fenster mit dem &quot;inhibit&quot;-Befehl, und Ihr Bildschirmschoner sollte
+wieder normal arbeiten. Auch einfaches Schlie&szlig;en des Terminalfensters
+sollte den &quot;inhibit&quot;-Befehl abbrechen.
+</p>
 
 
 <h4><a name="s2q2">Enigma startet nicht, es wird eine Fehlermeldung der Form

Modified: homepage/input/faq_core_ru.html
===================================================================
--- homepage/input/faq_core_ru.html	2008-08-15 13:50:25 UTC (rev 1272)
+++ homepage/input/faq_core_ru.html	2008-08-16 23:21:54 UTC (rev 1273)
@@ -101,6 +101,16 @@
 ?? ?????????????? ?????????? ??????, ? ??????? ?? ???????, ??? ?? ?? ??????????? ???????????.
 ?? ?????? ??? ????????? ??? ?????????? ??????, ??? ? ??????????
 ????????????? ?? ???????? ?????? ? ????????????? (??????? &quot;???? ????????&quot;).</p>
+<p>
+If you are using GNOME, you can run this in a terminal window:
+<pre>
+gnome-screensaver-command --inhibit
+</pre>
+(it will not quit&mdash;just leave it running!) Then run Enigma. When you're done
+with Enigma, press Ctrl+C on the &quot;inhibit&quot; command, and your screen
+saver should be working again. Closing the terminal window should also stop the
+&quot;inhibit&quot; command.
+</p>
 
 
 <h4><a name="s2q2">Enigma ?? ???????????, ??? ?????? ????????? ?????????

Modified: homepage/input/hp_archive.html
===================================================================
--- homepage/input/hp_archive.html	2008-08-15 13:50:25 UTC (rev 1272)
+++ homepage/input/hp_archive.html	2008-08-16 23:21:54 UTC (rev 1273)
@@ -7,6 +7,11 @@
 </p>
 
 <p>
+Articles sorted by level number can be found <a
+href="$$level_archive$$">here</a>.
+</p>
+
+<p>
 All news articles can be viewed <a href="$$news$$">here</a>.
 </p>
 
@@ -19,4 +24,7 @@
   </li>
   <li><a href="$$april_2008$$">April Fool's Day Joke 2008 - &quot;The Three Clouds&quot;</a>
   </li>
+  <li><a href="$$apprentice_1$$">The Apprentice, Part 1</a>
 </ul>
+
+

Modified: homepage/input/hp_archive_de.html
===================================================================
--- homepage/input/hp_archive_de.html	2008-08-15 13:50:25 UTC (rev 1272)
+++ homepage/input/hp_archive_de.html	2008-08-16 23:21:54 UTC (rev 1273)
@@ -7,6 +7,11 @@
 </p>
 
 <p>
+Artikel sortiert nach Levelnummer finden Sie <a
+href="$$level_archive$$">hier</a>.
+</p>
+
+<p>
 Alle News-Artikel k&ouml;nnen Sie <a href="$$news$$">hier</a> einsehen.
 </p>
 
@@ -19,5 +24,7 @@
   </li>
   <li><a href="$$april_2008$$">Aprilscherz 2008 - &quot;The Three Clouds&quot;</a>
   </li>
+  </li>
+  <li><a href="$$apprentice_1$$">Der Neuling, Teil 1</a>
 </ul>
 

Modified: homepage/input/hp_archive_ru.html
===================================================================
--- homepage/input/hp_archive_ru.html	2008-08-15 13:50:25 UTC (rev 1272)
+++ homepage/input/hp_archive_ru.html	2008-08-16 23:21:54 UTC (rev 1273)
@@ -6,6 +6,11 @@
 </p>
 
 <p>
+Articles sorted by level number can be found <a
+href="$$level_archive$$">here</a>.
+</p>
+
+<p>
 ??? ??????? ????? ???????? <a href="$$news$$">?????</a>.
 </p>
 
@@ -18,4 +23,6 @@
   </li>
   <li><a href="$$april_2008$$">??????????????? ????? 2008 - &quot;The Three Clouds&quot;</a>
   </li>
+  </li>
+  <li><a href="$$apprentice_1$$">The Apprentice, Part 1</a>
 </ul>

Modified: homepage/input/infobox.html
===================================================================
--- homepage/input/infobox.html	2008-08-15 13:50:25 UTC (rev 1272)
+++ homepage/input/infobox.html	2008-08-16 23:21:54 UTC (rev 1273)
@@ -1,11 +1,9 @@
     <div class="infobody">
        <div class="info">
-         <h3>Two addenda</h3>
-         We now have a comment from Jacob to his last LotM, you can read
-         it <a href="$$lotm_200805$$#jacob">here</a>. AND, we got a great map
-         of the Level of the Year 2007, <a href="$$lotm_200703$$">&quot;Island
-         Labyrinth&quot;</a>, from Shoki. You can download it
-         <a href="$$imagedir$$/lotm/lotm_200703_shoki.jpg">here</a>.
+         <h3>The Apprentice</h3>
+         Mecke started a new monthly column for our homepage, &quot;The
+         Apprentice&quot;! Read about his first adventure, his
+         experiences and thoughts <a href="$$apprentice_1$$">here</a>.
 
          <h3>Level of the Month</h3>
          <a href="$$lotm_current$$"><img src="$$lotm_current_image$$"

Modified: homepage/input/infobox_de.html
===================================================================
--- homepage/input/infobox_de.html	2008-08-15 13:50:25 UTC (rev 1272)
+++ homepage/input/infobox_de.html	2008-08-16 23:21:54 UTC (rev 1273)
@@ -1,5 +1,11 @@
     <div class="infobody">
        <div class="info">
+         <h3>Der Neuling</h3>
+         Mecke hat f&uuml;r uns eine neue monatliche Kolumne begonnen, den
+         &quot;Neuling&quot;! Lesen Sie <a
+         href="$$apprentice_1$$">hier</a> &uuml;ber sein erstes Abenteuer,
+         seine Erfahrungen und Gedanken.
+         
          <h3>Zwei Nachtr&auml;ge</h3>
          Wir haben nun einen Kommentar von Jacob zu seinem letzten LotM,
          Sie k&ouml;nnen ihn <a href="$$lotm_200805$$#jacob">hier</a> lesen.

Modified: homepage/input/infobox_ru.html
===================================================================
--- homepage/input/infobox_ru.html	2008-08-15 13:50:25 UTC (rev 1272)
+++ homepage/input/infobox_ru.html	2008-08-16 23:21:54 UTC (rev 1273)
@@ -1,10 +1,9 @@
     <div class="infobody">
        <div class="info">
-         <h3>??? ??????????</h3>
-         ?????? ? ??? ???? ??????????? ?? Jacob ? ??? ?????????? ??, ??????? ?? ?????? ????????
-         <a href="$$lotm_200805$$#jacob">?????</a>. ? ???, ?? ???????? ?? Shoki, ???????? ?????
-         ?????? ???? 2007, <a href="$$lotm_200703$$">&quot;Island
-         Labyrinth&quot;</a>. ?? ?????? ??????? ?? <a href="$$imagedir$$/lotm/lotm_200703_shoki.jpg">?????</a>.
+         <h3>The Apprentice</h3>
+         Mecke started a new monthly column for our homepage, &quot;The
+         Apprentice&quot;! Read about his first adventure, his
+         experiences and thoughts <a href="$$apprentice_1$$">here</a>.
 
          <h3>??????? ??????</h3>
          <a href="$$lotm_current$$"><img src="$$lotm_current_image$$"

Added: homepage/input/level_archive.html
===================================================================
--- homepage/input/level_archive.html	2008-08-15 13:50:25 UTC (rev 1272)
+++ homepage/input/level_archive.html	2008-08-16 23:21:54 UTC (rev 1273)
@@ -0,0 +1,10 @@
+
+<h2>Level Archive</h2>
+
+<p>
+Here you find all articles and article sections on this homepage dealing with
+levels, sorted by position:
+</p>
+
+$$parse_level_archive$$
+

Added: homepage/input/level_archive_de.html
===================================================================
--- homepage/input/level_archive_de.html	2008-08-15 13:50:25 UTC (rev 1272)
+++ homepage/input/level_archive_de.html	2008-08-16 23:21:54 UTC (rev 1273)
@@ -0,0 +1,10 @@
+
+<h2>Level Archiv</h2>
+
+<p>
+Hier finden Sie alle Artikel und Artikelteile auf dieser Homepage, die sich mit
+Levels besch&auml;ftigen, sortiert nach Position:
+</p>
+
+$$parse_level_archive$$
+

Modified: homepage/input/lotm/lotm_archive_data.lua
===================================================================
--- homepage/input/lotm/lotm_archive_data.lua	2008-08-15 13:50:25 UTC (rev 1272)
+++ homepage/input/lotm/lotm_archive_data.lua	2008-08-16 23:21:54 UTC (rev 1273)
@@ -148,6 +148,92 @@
   position_num   = "5069"
 }
 
+-- Further levels standing data
+-- (no need to change these)
+
+level_archive_data = {}
+
+level_archive_data[1] = {
+  link = "$$eoya_2007$$#best_onescreener",
+  occasion = "Best Onescreener 2007",
+  name = "Doors Galore",
+  author = "Ray Wick",
+  position = "IV/9",
+  position_num = "4009"
+}
+
+level_archive_data[2] = {
+  link = "$$eoya_2007$$#best_levelseries",
+  occasion = "Best Levelseries 2007",
+  name = "Gods of Enigma",
+  author = "moonpearl",
+  position = "V/67",
+  position_num = "5067"
+}
+
+level_archive_data[3] = {
+  link = "$$eoya_2007$$#best_levelseries",
+  occasion = "Best Levelseries 2007",
+  name = "Gods of Enigma II",
+  author = "moonpearl",
+  position = "V/69",
+  position_num = "5069"
+}
+
+level_archive_data[4] = {
+  link = "$$eoya_2007$$#best_design",
+  occasion = "Best Design 2007",
+  name = "The Aztec Temple",
+  author = "Dominik Lehmann",
+  position = "VI/100",
+  position_num = "6100"
+}
+
+level_archive_data[5] = {
+  link = "$$eoya_2007$$#funniest_level",
+  occasion = "Funniest Level 2007",
+  name = "Advancing",
+  author = "Joseph Dunne",
+  position = "VII/23",
+  position_num = "7023"
+}
+
+level_archive_data[6] = {
+  link = "$$eoya_2007$$#funniest_level",
+  occasion = "Funniest Level 2007",
+  name = "Mountain Climbing",
+  author = "Joseph Dunne",
+  position = "VII/22",
+  position_num = "7022"
+}
+
+level_archive_data[7] = {
+  link = "$$eoya_2007$$#best_yinyang",
+  occasion = "Best Yin-Yang Level 2007",
+  name = "Teamwork",
+  author = "Jacob Scott",
+  position = "III/18",
+  position_num = "3018"
+}
+
+level_archive_data[8] = {
+  link = "$$eoya_2007$$#loty",
+  occasion = "Level of the Year 2007",
+  name = "Island Labyrinth",
+  author = "Jacob Scott",
+  position = "V/100",
+  position_num = "5100"
+}
+
+level_archive_data[9] = {
+  link = "$$april_2008$$",
+  occasion = "April Fool's Day Joke 2008",
+  name = "The Three Clouds",
+  author = "Kate Lever",
+  position = "VII+/25",
+  position_num = "7925"
+}
+
 -- LotM variable data
 -- format: Level Title, current_rating, current_votes, additional text
 

Modified: homepage/input/lotm/read_lotm.lua
===================================================================
--- homepage/input/lotm/read_lotm.lua	2008-08-15 13:50:25 UTC (rev 1272)
+++ homepage/input/lotm/read_lotm.lua	2008-08-16 23:21:54 UTC (rev 1273)
@@ -94,3 +94,71 @@
   end
 end
 
+-- Returns a string representing NUMBER in Roman numerals.
+-- It works only for small numbers.
+function roman_numeral(number)
+  local rn = {"I", "II", "III", "IV", "V", "VI", "VII", "VIII", "IX", "X", "XI",
+              "XII", "XIII", "XIV", "XV", "XVI", "XVII", "XVIII", "XIX", "XX"} 
+  if rn[number] then
+    return rn[number]
+  else
+    error("roman_numeral: Number not defined. Please increase my 'rn'-table.")
+  end
+end
+
+-- Create the level article archive page.
+function parse_level_archive(lang)
+  -- Collect all data.
+  local ordered_data = {}
+  local function insert_by_occasion(entry)
+    local found = false
+    for _, first in ipairs(ordered_data) do
+      if first.position_num == entry.position_num then
+        found = true
+        first.full_link = first.full_link 
+          ..", <a href=\""..entry.link.."\">"..entry.occasion.."</a>"
+      end
+    end
+    if not found then
+      entry.full_link = "<a href=\""..entry.link.."\">"..entry.occasion.."</a>"
+      table.insert(ordered_data, entry)
+    end
+  end
+  for _, entry in pairs(lotm_archive_data) do
+    entry.occasion = "LotM "..entry.date.month.."/"..entry.date.year
+    entry.link = "$$"..lotm_macro_name(entry).."$$"
+    insert_by_occasion(entry)
+  end
+  for _, entry in pairs(level_archive_data) do
+    insert_by_occasion(entry)
+  end
+  -- Sort data.
+  table.sort(ordered_data, function (a, b)
+                             if a.position_num == b.position_num then
+                               return (a.occasion < b.occasion)
+                             else
+                               return (a.position_num < b.position_num)
+                             end
+                           end)
+  -- Create html.
+  local html_text = ""
+  local current_pack = -1
+  for _, entry in ipairs(ordered_data) do
+    local pack = math.floor(entry.position_num / 1000)
+    if pack ~= current_pack then
+      if current_pack ~= -1 then
+        html_text = html_text.."</ul>\n\n"
+      end
+      html_text = html_text.."<h4>Enigma "..roman_numeral(pack).."</h4>\n\n<ul>"
+      current_pack = pack
+    end
+    html_text = html_text.."<li>"..entry.position.."&nbsp;&nbsp;&nbsp;<i>"
+                  ..entry.name.."</i>&nbsp;&nbsp;&nbsp;"..entry.full_link.."</li>\n"
+  end
+  if current_pack ~= -1 then
+    html_text = html_text.."</ul>\n\n"
+  end
+  return html_text
+end
+
+

Modified: homepage/input/output-files.lua
===================================================================
--- homepage/input/output-files.lua	2008-08-15 13:50:25 UTC (rev 1272)
+++ homepage/input/output-files.lua	2008-08-16 23:21:54 UTC (rev 1273)
@@ -60,6 +60,9 @@
     parse_news_2 = function(v,s,l0)
         return parse_text(v, parse_news(newsdir,l0), l0, "news2")
       end,
+    parse_level_archive = function(v,s,l0)
+        return parse_text(v, parse_level_archive(l0), l0, "level_archive")
+      end,
     parse_lotm_by_rating = function(v,s,l0)
         return parse_text(v, parse_lotm("current_rating", true, l0), l0,
           add_lang_to_filename(v.outfile, l0))
@@ -468,6 +471,15 @@
     body = {"hp_archive", "top_news"}
 }
 
+html.level_archive = {
+    outfile = "level_archive.html",
+    title = "Level Archive",
+    title_de = "Level-Archiv",
+    title_ru = "Level Archive",
+    --es-- title_es = "Level Archive",
+    body = {"level_archive"}
+}
+
 ----------------------------------------------------------------------
 -- Special Articles
 ----------------------------------------------------------------------
@@ -507,3 +519,17 @@
     rightcolumn = {},
     body = {"articles/april_2008"},
 }    
+
+----------------------------------------------------------------------
+-- The Apprentice
+----------------------------------------------------------------------
+
+html.apprentice_1 = {
+    outfile = "apprentice_1.html",
+    title = "The Apprentice, Part 1",
+    title_de = "Der Neuling, Teil 1",
+    title_ru = "The Apprentice, Part 1",
+    rightcolumn = {"articles/infobox_apprentice"},
+    body = {"articles/apprentice_1"},
+}    
+

Modified: homepage/input/top_news.html
===================================================================
--- homepage/input/top_news.html	2008-08-15 13:50:25 UTC (rev 1272)
+++ homepage/input/top_news.html	2008-08-16 23:21:54 UTC (rev 1273)
@@ -41,4 +41,16 @@
          the Berlios server. This includes downloads from 0.92 up to 1.01.
          Thanks to all players who made this possible!
          
+         <h4><span class="date">2008-06-17:</span> Two addenda</h4>
+         We now have a comment from Jacob to his last LotM, you can read
+         it <a href="$$lotm_200805$$#jacob">here</a>. AND, we got a great map
+         of the Level of the Year 2007, <a href="$$lotm_200703$$">&quot;Island
+         Labyrinth&quot;</a>, from Shoki. You can download it
+         <a href="$$imagedir$$/lotm/lotm_200703_shoki.jpg">here</a>.
          
+         <h4><span class="date">2008-08-17:</span> The Apprentice</h4>
+         Mecke started a new monthly column for our homepage, &quot;The
+         Apprentice&quot;! Read about his first adventure, his
+         experiences and thoughts <a href="$$apprentice_1$$">here</a>.
+         
+

Modified: homepage/input/top_news_de.html
===================================================================
--- homepage/input/top_news_de.html	2008-08-15 13:50:25 UTC (rev 1272)
+++ homepage/input/top_news_de.html	2008-08-16 23:21:54 UTC (rev 1273)
@@ -44,4 +44,17 @@
          Dies umfasst Downloads von 0.92 bis 1.01. Vielen Dank an alle Spieler,
          die dies m&ouml;glich gemacht haben!
          
+         <h4><span class="date">17.6.2008:</span> Zwei Nachtr&auml;ge</h4>
+         Wir haben nun einen Kommentar von Jacob zu seinem letzten LotM,
+         Sie k&ouml;nnen ihn <a href="$$lotm_200805$$#jacob">hier</a> lesen.
+         UND, wir haben eine gro&szlig;artige Karte vom Level des Jahres 2007,
+         <a href="$$lotm_200703$$">&quot;Island Labyrinth&quot;</a>, von Shoki
+         bekommen. Sie k&ouml;nnen sie <a
+         href="$$imagedir$$/lotm/lotm_200703_shoki.jpg">hier</a> herunterladen.
          
+         <h4><span class="date">17.8.2008:</span> Der Neuling</h4>
+         Mecke hat f&uuml;r uns eine neue monatliche Kolumne begonnen, den
+         &quot;Neuling&quot;! Lesen Sie <a
+         href="$$apprentice_1$$">hier</a> &uuml;ber sein erstes Abenteuer,
+         seine Erfahrungen und Gedanken.
+         
\ No newline at end of file

Modified: homepage/input/top_news_ru.html
===================================================================
--- homepage/input/top_news_ru.html	2008-08-15 13:50:25 UTC (rev 1272)
+++ homepage/input/top_news_ru.html	2008-08-16 23:21:54 UTC (rev 1273)
@@ -34,3 +34,14 @@
          ? 2 ?? 3 ?????????????? ???????, Enigma ???????? ??????? ? 500.000 ???????? ? ??????? Berlios. ? ??? ?????? ???????? ? ?????? 0.92 ?? 1.01. ??????? ???? ???????, ????????? ??????? ??? ????? ?????????!
          
          
+         <h4><span class="date">2008-06-17:</span> ??? ??????????</h4>
+         ?????? ? ??? ???? ??????????? ?? Jacob ? ??? ?????????? ??, ??????? ?? ?????? ????????
+         <a href="$$lotm_200805$$#jacob">?????</a>. ? ???, ?? ???????? ?? Shoki, ???????? ?????
+         ?????? ???? 2007, <a href="$$lotm_200703$$">&quot;Island
+         Labyrinth&quot;</a>. ?? ?????? ??????? ?? <a href="$$imagedir$$/lotm/lotm_200703_shoki.jpg">?????</a>.
+
+         <h4><span class="date">2008-08-17:</span> The Apprentice</h4>
+         Mecke started a new monthly column for our homepage, &quot;The
+         Apprentice&quot;! Read about his first adventure, his
+         experiences and thoughts <a href="$$apprentice_1$$">here</a>.
+



From ral at mail.berlios.de  Thu Aug 14 23:58:02 2008
From: ral at mail.berlios.de (ral at BerliOS)
Date: Thu, 14 Aug 2008 23:58:02 +0200
Subject: [Enigma-game-svn] r1270 - trunk/src
Message-ID: <200808142158.m7ELw2Nk004840@sheep.berlios.de>

Author: ral
Date: 2008-08-14 23:58:01 +0200 (Thu, 14 Aug 2008)
New Revision: 1270

Modified:
   trunk/src/world.cc
Log:
Trunk 1.1: 
- fix collision physics: remaining rare case of stuck actors
  (as seen in Enigma IV#60 - bug report #7364 pull stone)


Modified: trunk/src/world.cc
===================================================================
--- trunk/src/world.cc	2008-08-14 21:55:26 UTC (rev 1269)
+++ trunk/src/world.cc	2008-08-14 21:58:01 UTC (rev 1270)
@@ -1106,7 +1106,7 @@
 
             // remove collision forces components from actor-actor collisions 
             // in direction of stone
-            double normal_component = sc.normal * ai.collforce;
+            double normal_component = sc.normal * ai.collforce;            
             if (normal_component < 0) {
                 ai.collforce -= normal_component * sc.normal;
             }
@@ -1116,8 +1116,18 @@
         }
     }
     else if (sc.is_contact) {
-        if (Stone *stone = GetStone(sc.stonepos))
+        if (Stone *stone = GetStone(sc.stonepos)) {
             stone->actor_contact(sc.actor);
+            
+            if (a->get_gridpos() != sc.stonepos) {
+                // remove collision forces components from actor-actor collisions 
+                // in direction of stone
+                double normal_component = sc.normal * ai.collforce;            
+                if (normal_component < 0) {
+                    ai.collforce -= normal_component * sc.normal;
+                }
+            } 
+        }
     }
 }
 



From ral at mail.berlios.de  Sun Aug 17 15:33:00 2008
From: ral at mail.berlios.de (ral at mail.berlios.de)
Date: Sun, 17 Aug 2008 15:33:00 +0200
Subject: [Enigma-game-svn] r1275 - trunk/doc/reference
Message-ID: <200808171333.m7HDX0SI013676@sheep.berlios.de>

Author: ral
Date: 2008-08-17 15:32:50 +0200 (Sun, 17 Aug 2008)
New Revision: 1275

Modified:
   trunk/doc/reference/enigma-ref.texi
Log:
Trunk 1.1: new API
- refman docu updates for r1274: added shogun, oneway, door


Modified: trunk/doc/reference/enigma-ref.texi
===================================================================
--- trunk/doc/reference/enigma-ref.texi	2008-08-17 13:06:51 UTC (rev 1274)
+++ trunk/doc/reference/enigma-ref.texi	2008-08-17 13:32:50 UTC (rev 1275)
@@ -3406,7 +3406,7 @@
 configuration without the objects changing unexpected on level initialization.
 
 The snapshot principle is a simple thumb rule that you can rely on in describing
-the level as snapshot of object at a given point of time. Every object has just
+the level as a snapshot of object at a given point of time. Every object has just
 to be configured as it should be at the given time. All interactions that would
 take place in a running game do not take place while setting objects during
 initialization.
@@ -3417,7 +3417,7 @@
 
 @example
 @{"st_switch", target="mydoor", state=ON@}
-@{"st_door_v", name="mydoor", state=OPEN@}
+@{"st_door", name="mydoor", state=OPEN@}
 @end example
 
 A laser that is initially on that illuminates a laserswitch needs an initially
@@ -3582,7 +3582,7 @@
 30    @i{ti}["@var{^}"] = @{"@b{st_boulder}", "@var{boulder}", @b{orientation}=@var{NORTH}@}
 31    @i{ti}["@var{F}"] = @{"@b{st_fourswitch}", @b{target}="@var{boulder}", @b{action}="@var{orientate}"@}
 32
-33    @i{ti}["@var{D}"] = @{"@b{st-door-v}", "@var{door}"@}
+33    @i{ti}["@var{D}"] = @{"@b{st_door_d}", "@var{door}", @b{faces}="@var{ew}"@}
 34    @i{ti}["@var{B}"] = @{"@b{it_blocker}", "@var{wall#}"@}
 35    @i{ti}["@var{S}"] = @{"@b{st_switch}", @b{target}=@{"@var{door}", "@var{wall#*}"@}@}
 36
@@ -3727,7 +3727,7 @@
 steers the boulder according to the fourswitch orientation.
 
 @example
-33    @i{ti}["@var{D}"] = @{"@b{st-door-v}", "@var{door}"@}
+33    @i{ti}["@var{D}"] = @{"@b{st_door_d}", "@var{door}", @b{faces}="@var{ew}"@}
 34    @i{ti}["@var{B}"] = @{"@b{it_blocker}", "@var{wall#}"@}
 35    @i{ti}["@var{S}"] = @{"@b{st_switch}", @b{target}=@{"@var{door}", "@var{wall#*}"@}@}
 @end example
@@ -5341,7 +5341,7 @@
 that this object will only be set on grid positions with an even sum of 
 @code{x + y} grid coordinates, where as a value of @samp{1} assures that the
 sum must be uneven. This way you can easily provide two different object
-declarations for a tile to generate an arbitrary chaped map of checkerboard
+declarations for a tile to generate an arbitrarily chaped map of checkerboard
 floors, items or stones.
 
 @table @asis
@@ -5366,7 +5366,7 @@
 to use the world's @samp{add} method.
 
 @table @asis
- at item @b{Type:} @ @ group of @code{ot_rubberband} objects
+ at item @b{Type:} @ @ group of @ref{ot_rubberband} objects
 @item @b{Default:} @ @ @code{nil}
 @item @b{Access:} @ @ read only
 @item @b{Support:} @ @ by actor and stone objects
@@ -5581,8 +5581,8 @@
 @node disconnect
 @subsection disconnect
 
-This message causes the receipent to disconnect from all @ref{fellows} by
-cutting all @ref{wires} and @ref{rubbers} that are connect to it.
+This message causes the recipient to disconnect from all @ref{fellows} by
+cutting all @ref{wires} and @ref{rubbers} that are connected to it.
 
 @table @asis
 @item @b{Value:} @ @ -
@@ -5853,7 +5853,7 @@
 
 A global variable that defines if the essential actors have to survive the
 finish of the game (@pxref{Ending Conditions}). With this attribute set to 
- at samp{false} a gamer can sacrify an essential actor to finish the level in the
+ at samp{false} a gamer can sacrifice an essential actor to finish the level in the
 same step in some subtle cases.
 
 @table @asis
@@ -5942,6 +5942,7 @@
 * it_magnet::          
 * it_rubberband::      
 * it_sensor::          Floor Switch for passing Actors
+* it_shogun::          Dot for Shogun Stones
 * it_strip::           Narrow Bridge
 * it_sword::
 * it_trap::            
@@ -6427,7 +6428,7 @@
 
 A portable @ref{ot_rubberband} that gets connected to the bearer on activation.
 
-As the rubberbands @samp{anchor1} is given by the activator itself, just the
+As the rubberband's @samp{anchor1} is given by the activator itself, just the
 @samp{anchor2} reference can be configured by this item. It can be any stone
 or actor reference. 
 
@@ -6439,7 +6440,7 @@
 
 The other attributes describe the force and length parameters of the 
 @ref{ot_rubberband}, that will be created on application of the item. In fact
-the items identity will be transfered to its successor 
+the item's identity will be transfered to its successor 
 (@pxref{Object Transformation}). After creation of the life rubberband the 
 action message will be send to the target. Note that it is actually the 
 @ref{ot_rubberband} as the successor that sends the message.
@@ -6453,7 +6454,7 @@
 connected to. The reference will be evaluated on item activation.
 @item @b{strength} @ @ @i{values}: number; @ @ @i{default}: @code{10.0}
 The force strength.
- at item @b{length} @ @ @i{values}: positiv number; @ @ @i{default}: @code{1.0}
+ at item @b{length} @ @ @i{values}: positive number; @ @ @i{default}: @code{1.0}
 The natural length above which forces are applied.
 @item @b{threshold} @ @ @i{values}: positiv number or zero; @ @ @i{default}: @code{0.0}
 The length smaller than the natural length below which inverted forces are applied.
@@ -6465,7 +6466,7 @@
 
 @item @b{Messages:} none
 @item @b{Action:} @ @ @xref{target}, @ @ @xref{action}
-On succesfull activation of this item the action message is send with a value of
+On succesful activation of this item the action message is send with a value of
 @samp{true}. Note that the parameter @samp{sender} will report the new 
 @ref{ot_rubberband}.
 @end table
@@ -6516,6 +6517,51 @@
 @end table
 
 
+ at c ----------------- Shogun Dot Item -------------------- 
+ at node it_shogun
+ at subsection it_shogun
+ at obindex it_shogun
+
+A dot like, blue animated sensor item for @ref{st_shogun} stones. The dot comes
+in three variations matching the different hole sizes of shogun stones.
+
+Shogun dots detect stacks of @ref{st_shogun} that contain all variations from
+small up to the size of the dot. Thus the small dot requires just a single small
+shogun stone, the middle sized dot requires a stack of a small shogun beneath
+a middle sized shogun stone, whereas the large dot requires a stack of all three
+shogun stones on top.
+
+There is no way to set the state of a dot manually. But the state can 
+nevertheless be read. At initialization a dot with a matching shogun stack on 
+top will start in state @samp{ON} without sending actions due to the 
+ at ref{Snapshot Principle}.
+
+ at table @asis
+ at item @b{Attributes:}
+ at table @asis
+ at item @b{state}, @ @ @i{values}: @code{OFF}, @code{ON}; @ @ @i{default}: @code{OFF}; @ @ @i{access}: @code{read only}  @ @ @xref{state}
+The current state of the dot - @samp{ON} for a matching @ref{st_shogun} stack
+on top, @samp{OFF} otherwise.
+ at item @b{flavor}, @ @ @i{values}: @code{"s"}, @code{"m"}, @code{"l"}; @ @ @i{default}: @code{"s"}
+A string describing the hole size. @code{"s"} for a small hole, @code{m} for
+a medium hole, @code{"l"} for a large hole.
+
+ at end table
+
+ at item @b{Messages:} none
+
+ at item @b{Action:}  @ @ @xref{target}, @ @ @xref{action}
+
+ at item @b{Variants:}
+ at table @asis
+ at item @b{it_shogun}: flavor = @code{"s"}
+ at item @b{it_shogun_s}: flavor = @code{"s"}
+ at item @b{it_shogun_m}: flavor = @code{"m"}
+ at item @b{it_shogun_l}: flavor = @code{"l"}
+ at end table
+
+ at end table
+
 @c ----------------- Strip Item -------------------- 
 @node it_strip
 @subsection it_strip
@@ -7100,6 +7146,7 @@
 * st_chess::           Movable Chess Knight Stone
 * st_coinslot::        Coin Driven Switch
 * st_death::           Skull Stone
+* st_door::            Door of various Flavors
 * st_floppy::          Floppy Driven Switch
 * st_fourswitch::      Four Direction Switch
 * st_key::             Key Driven Switch
@@ -7110,11 +7157,13 @@
 * st_lightpassenger::  Stone pushed by Light
 * st_mirror::          Mirrors of all flavors
 * st_monoflop::        Monoflop Switch
+* st_oneway::          Oneway Passage
 * st_oxyd::            Game Target Stone
 * st_polarswitch::     Transparency Switch for Light Beams
 * st_rotator::         Rotating Stone Impulser
 * st_rubberband::      Rubberband generator
 * st_scissors::        Scissors cutting rubberbands
+* st_shogun::          Stackable Hole Stones
 * st_switch::          Classical on/off Switch
 * st_timer::           Animated Timer
 * st_turnstile::       Turnstile Pivot
@@ -7500,6 +7549,94 @@
 @end table
 
 
+ at c ----------------- Door Stone -------------------- 
+ at node st_door
+ at subsection st_door
+ at obindex st_door
+
+Doors are stones that let actors pass or block them to enter the grid, depending
+on their state. Doors can be opened and closed by the standard set of messages.
+Doors do not open or close instantly. They need a small amount of time. Actors
+can pass only doors that are completly open.
+
+There are several flavors of doors. Where as the variants @code{"a"} to 
+ at code{"c"} represent grid filling block doors, does the flavor @code{"d"} 
+represent a faces based door, that opens or blocks just the given faces of the
+grid. Currently just the combinations of two parallel aligned door faces,
+aka horizontal and vertical doors, are supported.
+
+As door grids can be entered on unfaced sides you should block these faces by
+unpassable stones. If you do not block these entries or even allow marbles to
+warp into a door, the actors will be free to leave the doors even if they are
+closed. But marbles will shatter on the door grid when doors are closed. This
+behaviour is a legacy Enigma feature.
+
+Doors are stones that are even present if they are not visible in the @code{OPEN}
+state. This means you can not push or move any other stone through an open door.
+The @ref{st_blocker} is a quite compatible door alternative that allows stones
+to pass in its open state.
+
+All doors are floating and will not press @ref{it_triggers}. Thus you can detect
+passing actors by positioning a trigger beneath a door. Doors will neither press
+ at ref{fl_bridge} and will thus take no influence on the bridge.
+
+Laser light will pass any open door, but will be blocked by closed faces. Closed
+doors of type @code{"d"} let light pass if the faces are parallel aligned to
+the light without intervening the light.
+
+Just doors of type @code{"d"} allow an actor to knock on its closed faces.
+This causes an action that might open the door or do anything else. A common
+target is @ref{st_balls} that evaluated the color of the knocking actor.
+
+ at table @asis
+
+ at item @b{Attributes:}
+ at table @asis
+ at item @b{state}, @ @ @i{values}: @code{OPEN}, @code{CLOSED}; @ @ @i{default}: @code{CLOSED}; @ @ @xref{state}
+The open state of the door.
+
+ at item @b{flavor} @ @ @i{values}: @code{"a"}, @code{"b"}, @code{"c"}, @code{"d"}; @ @ @i{default}: @code{"d"}
+Representing different door types as described above. Block based flavors
+ at code{"a"}, @code{"b"}, @code{"c"} and the face based flavor @code{"d"}.
+
+ at item @b{faces} @ @ @i{values}: string; @ @ @i{default}: @code{"nesw"}
+Describes the door faces of the stone. The string is a substring of 
+ at code{"nesw"} listing the faces. The sequence of the sides, north, east, south,
+west, is guaranteed on read access but arbitrary on write access. Note that
+the supported face combinations depend on the flavor. All but flavor @code{"d"}
+do always provide all 4 faces. Flavor @code{"d"} currently supports the face
+combinations @code{"ns"} and @code{"ew"}, in other words horizontal and 
+vertical aligned door faces, with the first combination being the default.
+
+ at end table
+
+ at item @b{Messages:}
+ at table @asis
+ at item @b{open} @ @ @xref{open}
+Opens a closed door or reverses the process of a closing door.
+ at item @b{close} @ @ @xref{close}
+Closes an open door or reverses the process of an opening door.
+ at item @b{signal} @ @ @xref{signal}
+Opens at value @samp{1}, and closes at value @samp{0}.
+ at end table
+
+ at item @b{Action:}
+Just flavor @code{"d"} doors will perform an action on an actor touching a face
+of a closed door. The action value will be the actor object, which can be
+evaluated on its kind. This action value fits the @samp{hit} messages of
+objects like @ref{st_balls}.
+
+ at item @b{Variants:}
+ at table @asis
+ at item @b{st_door}: flavor = @code{"d"}
+ at item @b{st_door_a}: flavor = @code{"a"}
+ at item @b{st_door_b}: flavor = @code{"b"}
+ at item @b{st_door_c}: flavor = @code{"c"}
+ at item @b{st_door_d}: flavor = @code{"d"}
+ at end table
+
+ at end table
+
 @c ----------------- Floppy Stone -------------------- 
 @node st_floppy
 @subsection st_floppy
@@ -7524,7 +7661,7 @@
 
 @table @asis
 @item @b{signal} @ @ @xref{signal}
-Switches on at value @samp{1}, and off at values @samp{0}.
+Switches on at value @samp{1}, and off at value @samp{0}.
 @item @b{on} @ @ @xref{on}
 @item @b{off} @ @ @xref{off}
 @end table
@@ -8018,6 +8155,69 @@
 
 @end table
 
+ at c ----------------- Oneway Stone -------------------- 
+ at node st_oneway
+ at subsection st_oneway
+ at obindex st_oneway
+
+A stone with one special face, that allows actors just to pass from inside
+to outside but not vice versa. The other faces can generally be passed in both
+directions. As most times it is more important to be aware of the passages that
+are blocked, you may remember that the oneway's arrow points to the side that
+can not be entered.
+
+Three variants of the oneway do exist. A neutral, green-gray colored one that 
+lets any actor pass according to the above rules, and additionally a black and
+a white colored oneway. These last oneways will let pass only marbles of 
+matching color. All other actors will reflect from all four sides.
+
+All oneways can only be passed by actors moving on the floor. Jumping actors
+will bounce on every side.
+
+The @samp{orientation} of a neutral oneway can be flipped to the opposite
+direction by an actor hitting it with a revealed @ref{it_magicwand}. All
+oneway variations will change their orientation on messages @samp{signal} and
+ at samp{flip}.
+
+ at table @asis
+ at item @b{Attributes:}
+
+ at table @asis
+ at item @b{state}, @ @ @i{values}: @code{NORTH}, @code{EAST}, @code{SOUTH}, @code{WEST}; @ @ @i{default}: @code{NORTH} @ @ @xref{state}
+The orientation of the oneway as shown by the arrow.
+ at item @b{orientation}, @ @ @i{values}: @code{NORTH}, @code{EAST}, @code{SOUTH}, @code{WEST}; @ @ @i{default}: @code{NORTH}
+The orientation of the oneway as shown by the arrow.
+ at item @b{color} @ @ @i{values}: @code{nil}, @code{BLACK}, @code{WHITE}; @ @ @i{default}: @code{nil}
+The color of the oneway that needs to match the actor's color to allow passing.
+The default @samp{nil} color is a greengrey oneway that matches all actors,
+marbles of any color as well as all other actors.
+ at end table
+
+ at item @b{Messages:}
+
+ at table @asis
+ at item @b{orientate}, @ @ @i{value type}: direction
+Change the orientation to the given direction value. The @ref{st_fourswitch}
+provides a compatible action which allows you to set a oneway as
+target and this message as action.
+ at item @b{flip},
+Flip the orientation to the opposite direction.
+ at item @b{signal} @ @ @xref{signal}
+Flip the orientation to the opposite direction.
+ at end table
+
+ at item @b{Action:} none
+
+ at item @b{Variants:}
+
+ at table @asis
+ at item @b{st_oneway}
+ at item @b{st_oneway_black}: color = @code{BLACK}
+ at item @b{st_oneway_white}: color = @code{WHITE}
+ at end table
+
+ at end table
+
 @c ----------------- Oxyd Stone -------------------- 
 @node st_oxyd
 @subsection st_oxyd
@@ -8231,10 +8431,10 @@
 particular stone.
 
 If the attribute @samp{scissor} is @samp{true}, all rubberbands connected to
-the hitting actor are removed prior attaching the direct new connection.
+the hitting actor are removed prior to attaching the direct new connection.
 
 The rubberband stone is static by default. But an actor with a revealed 
- at ref{it_wand} can move it by hitting it. As the actor will get connected by
+ at ref{it_magicwand} can move it by hitting it. As the actor will get connected by
 an @ref{ot_rubberband} at the same time you will usually place an 
 @ref{st_scissors} near the target place as an opportunity for the marble to free
 itself again from the rubberband stone.
@@ -8276,11 +8476,92 @@
 @item @b{Messages:} none
 
 @item @b{Action:} @ @ @xref{target}, @ @ @xref{action}
-Send an action message with value @samp{true} on freeing an actor from its
+Sends an action message with value @samp{true} on freeing an actor from its
 rubberbands.
 
 @end table
 
+ at c ----------------- Shogun Stone -------------------- 
+ at node st_shogun
+ at subsection st_shogun
+ at obindex st_shogun
+
+Shogun stones are nestable stones like Fukuroma or Matryoshka dolls. The
+different basic variations are distinguishable by their central hole. Small, 
+medium and large ones do exist. In contrast to the Fukuroma dolls you can push 
+smaller variations beneath the larger ones but not vice versa. You can see 
+smaller shoguns pushed beneath larger ones through the upper, larger hole. 
+Thus the player is always aware of the stack of shogun stones positioned on a
+single grid.
+
+An actor or a stone impulse hitting a shogun stack will push the smallest shogun 
+out of the stack. The upper and larger shogun stones can only be moved out of
+a stack by a @ref{ot_wire} impulse. But larger shoguns stones can never be 
+pushed over smaller ones.
+
+ at ref{it_shogun} are a special trigger type for shogun stones represented by 
+animated blue dots. They just react on shogun stacks positioned on top of the
+dot items. All shogun sizes must be present from the smallest up to the size
+of the dot itself.
+
+Shogun stones press @ref{it_trigger}, too. But all other items that react on
+other stones being pushed over them will not react on shogun stones. E.g.
+ at ref{it_seed} will not grow, @ref{it_bomb} will not explode, @ref{it_coin} will
+not transform and @ref{it_cherry} will not smash.
+
+All shogun stones keep their identity even if they are pushed together onto a
+single grid. Thus each shogun can be connected independently to @ref{ot_wire}s
+or @ref{ot_rubberband}s. On initialization you can set a stack of shogun onto
+a grid by setting a single shogun stone with a combined flavor string. The
+largest shogun stone of a stack will be positioned onto the grid and all smaller
+ones being part of the stack will be contained by the largest one. You can name 
+the smaller shoguns of a stack by the additional attributes @samp{name_m} and 
+ at samp{name_s}. Every shogun, even those being part of a stack can individually
+be killed by sending a @ref{kill} message to it. By setting another stone or
+ at samp{st_nil} onto the grid currently being occupied by a shogun grid all shogun
+stones being part of the stack will be killed.
+
+ at table @asis
+ at item @b{Attributes:}
+ at table @asis
+ at item @b{flavor}, @ @ @i{values}: @code{"s"}, @code{"m"}, @code{"l"}, @code{"sm"}, @code{"sl"}, @code{"ml"}, @code{"sml"}; @ @ @i{default}: @code{"s"}; @ @ @i{access}: after initialization read only
+A string describing the hole sizes of this shogun stone and all smaller shogun
+stones that are positioned beneath this stone. @code{"s"} for a small hole, @code{m} for
+a medium hole, @code{"l"} for a large hole, plus combinations of these
+characters for stacks. On initialization all shoguns of this grid's stack will 
+be set according to this attribute, which can be prior set. After initialization
+this attribute is read only and reports the current stack configuration. The
+character sequence is guaranteed to be sorted from small to large on read access
+but is arbitrary on initial write access.
+
+ at item @b{name_m} @ @ @i{values}: string; @ @ @i{default}: @code{nil}
+Name of the middle sized shogun as subpart of a stack of a large shogun.
+
+ at item @b{name_s} @ @ @i{values}: string; @ @ @i{default}: @code{nil}
+Name of the small sized shogun as subpart of a stack of a large or middle sized
+shogun.
+
+ at end table
+
+ at item @b{Messages:} none
+
+ at item @b{Action:} none
+
+ at item @b{Variants:}
+
+ at table @asis
+ at item @b{st_shogun}: flavor = @code{"s"}
+ at item @b{st_shogun_s}: flavor = @code{"s"}
+ at item @b{st_shogun_m}: flavor = @code{"m"}
+ at item @b{st_shogun_sm}: flavor = @code{"sm"}
+ at item @b{st_shogun_l}: flavor = @code{"l"}
+ at item @b{st_shogun_sl}: flavor = @code{"sl"}
+ at item @b{st_shogun_ml}: flavor = @code{"ml"}
+ at item @b{st_shogun_sml}: flavor = @code{"sml"}
+ at end table
+
+ at end table
+
 @c ----------------- Switch Stone -------------------- 
 @node st_switch
 @subsection st_switch
@@ -8428,7 +8709,7 @@
 When green turnstiles push actors to a diagonal grid position they will push 
 away an @ref{st_turnstilearm}, and just this single kind of stone, if it is
 located on this target grid. This feature can be used to intertwine several
-turnstile as it can be seen in the level @samp{ZigZag}.
+turnstiles as it can be seen in the level @samp{ZigZag}.
 
 There are two other ways of coupling turnstiles. You can simply set another
 @samp{st_turnstile} as the target of a first one and perform a @samp{signal}
@@ -8447,6 +8728,8 @@
 @table @asis
 @item @b{Attributes:}
 @table @asis
+ at item @b{flavor} @ @ @i{values}: @code{"red"}, @code{"green"}; @ @ @i{default}: @code{"red"}
+The distinguishing color of the pivot that signals the behaviour.
 @item @b{counterclock} @ @ @i{values}: @code{true}, @code{false}; @ @ @i{default}: @code{false}
 The standard turning direction is clockwise. Use this attribute to revert the
 direction.
@@ -8462,11 +8745,11 @@
 
 @table @asis
 @item @b{signal} @ @ @xref{signal}
-Rotate the turnstile counterclockwise on @samp{1}, and clockwise at values @samp{0}.
+Rotates the turnstile counterclockwise on @samp{1}, and clockwise at values @samp{0}.
 @item @b{turn}
-Turn in turning direction as defined by attribute @samp{counterclock}.
+Turns in turning direction as defined by attribute @samp{counterclock}.
 @item @b{turnback}
-Turn in opposite turning direction as defined by attribute @samp{counterclock}.
+Turns in opposite turning direction as defined by attribute @samp{counterclock}.
 @end table
 
 @item @b{Action:} @ @ @xref{target}, @ @ @xref{action}
@@ -8497,7 +8780,7 @@
 @ref{st_puzzle} nor a puzzle to a pivot.
 
 An arm is connected to a pivot on a neighboring grid position solely by a 
-matching connection. It is no longer free movable. All its impulses will turn
+matching connection. It is no longer freely movable. All its impulses will turn
 the @ref{st_turnstile} cluster instead.
 
 A special move of an arm is due to actors being moved by another green 
@@ -8690,9 +8973,9 @@
 to them.
 
 The two connected objects are called anchors. The attribute @samp{anchor1} holds
-the first objects reference that must be an actor. The @samp{anchor2} references
+the first object's reference that must be an actor. The @samp{anchor2} references
 the second object that can either be another actor or a stone. Both objects
-must exist to @ref{add} an rubberband to the world. If the stone sinks, breaks
+must exist to @ref{add} a rubberband to the world. If the stone sinks, breaks
 or is killed otherwise the rubberband will be destroyed, too.
 
 Both anchor objects will update their attributes @ref{rubbers} and @ref{fellows}
@@ -8762,12 +9045,12 @@
 A wire is a purple wire connecting two stones that transfers every stone pushing
 impulse from one stone to the other and vice versa. Thus both stones will move
 on the impulse if they are movable at all and not blocked in the direction of
-the impulse. The impulses may origin from an actor hitting a stone, an 
+the impulse. The impulses may originate from an actor hitting a stone, an 
 @ref{it_puller}, an @ref{st_rotator}, an @ref{st_stoneimpulse}.
 
 A single stone can be wired to many other stones. All these @ref{fellows} will
 move on an impulse. But the impulses will not be propagated to further stones
-that are wired themsselves to any of the fellows. Just the direct wired stones
+that are wired themselves to any of the fellows. Just the direct wired stones
 will move.
 
 You can request the wires connected to a stone by the stones @ref{wires} 
@@ -9483,9 +9766,9 @@
 one of them a replacement will take place.
 
 The replacement will be one of the replacement tile keys resolved via the
-subresolver. The different keys will be chosen with a likelyhood according to
+subresolver. The different keys will be chosen with a likelihood according to
 the ratio of the given frequency numbers. If no frequency is supplied a default
-of @samp{1} is taken. Thus in the first example both keys are taken in an ratio
+of @samp{1} is taken. Thus in the first example both keys are taken in a ratio
 1:1, whereas in the second the ratio will be 2:1.
 
 When a superkey is given for a hit key this superkey will additionally be 
@@ -9681,7 +9964,7 @@
 The nearest object as described in @ref{Object Naming} provides a major feature
 for reducing the number of needed tile declarations. As the selection needs
 to be unique a rule had to be defined in case of equal distances. South wins, 
-then East, Stone are favored to Items, Floors and Actors.
+then east, stones are favored to items, floors and actors.
 
 In most cases level authors can arrange their objects to fit these rules. But
 sometimes the level design does not allow the straight forward usage of a
@@ -9697,7 +9980,7 @@
 "       # #    F#####",
 @end example
 
-In both cases the floppy switch that is located at the crossing of to blocker
+In both cases the floppy switch that is located at the crossing of two blocker
 doors will open the false one.
 
 But you can use a cluster concept like the one we introduced for
@@ -9847,7 +10130,7 @@
 
 It is the task of the configurator function to check the user supplied
 parameters thoroughly and to provide appropriate error messages on bad
-parameters. Do this with an lua error message call at level 2:
+parameters. Do this with a lua error message call at level 2:
 @example
 error("Resolver autotile rule " .. i.." is not a table", 2)
 @end example



From raoul at mail.berlios.de  Fri Aug 15 13:45:41 2008
From: raoul at mail.berlios.de (raoul at BerliOS)
Date: Fri, 15 Aug 2008 13:45:41 +0200
Subject: [Enigma-game-svn] r1271 - trunk/src
Message-ID: <200808151145.m7FBjf5B007644@sheep.berlios.de>

Author: raoul
Date: 2008-08-15 13:45:40 +0200 (Fri, 15 Aug 2008)
New Revision: 1271

Modified:
   trunk/src/Makefile.am
Log:
-> Fix makefile for WormHole.{hh,cc}



Modified: trunk/src/Makefile.am
===================================================================
--- trunk/src/Makefile.am	2008-08-14 21:58:01 UTC (rev 1270)
+++ trunk/src/Makefile.am	2008-08-15 11:45:40 UTC (rev 1271)
@@ -213,8 +213,8 @@
 	items/Trigger.hh	\
 	items/Vortex.cc		\
 	items/Vortex.hh		\
-	items/Wormhole.cc	\
-	items/Wormhole.hh	\
+	items/WormHole.cc	\
+	items/WormHole.hh	\
 	others/Other.cc		\
 	others/Other.hh		\
 	others/Rubberband.cc	\



From ral at mail.berlios.de  Thu Aug 14 23:55:27 2008
From: ral at mail.berlios.de (ral at BerliOS)
Date: Thu, 14 Aug 2008 23:55:27 +0200
Subject: [Enigma-game-svn] r1269 - trunk/src/items
Message-ID: <200808142155.m7ELtRw6004656@sheep.berlios.de>

Author: ral
Date: 2008-08-14 23:55:26 +0200 (Thu, 14 Aug 2008)
New Revision: 1269

Added:
   trunk/src/items/Magnet.hh
Log:
Trunk 1.1: new API reengineering
- fix r1268 - missing file added


Added: trunk/src/items/Magnet.hh
===================================================================
--- trunk/src/items/Magnet.hh	2008-08-14 21:51:05 UTC (rev 1268)
+++ trunk/src/items/Magnet.hh	2008-08-14 21:55:26 UTC (rev 1269)
@@ -0,0 +1,61 @@
+/*
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef MAGNETITEM_HH
+#define MAGNETITEM_HH
+
+#include "items.hh"
+
+#include "enigma.hh"
+#include "world.hh"
+
+namespace enigma {
+    class Magnet : public Item, public ForceField {
+    private:
+        enum iState {
+            OFF,
+            ON
+        };
+       
+    public:
+        CLONEOBJ(Magnet);
+        DECL_ITEMTRAITS_ARRAY(2, state);
+
+        Magnet(bool isOn);
+        
+        // Object interface
+        virtual std::string getClass() const;
+        virtual void setAttr(const std::string &key, const Value &val);
+        virtual Value message(const Message &m);
+
+        // GridObject interface
+        virtual void on_creation(GridPos p);
+        virtual void on_removal(GridPos p);
+        virtual void init_model();
+
+        // ForceField interface
+        virtual void add_force(Actor *a, V2 &f);
+        
+    private:
+        double correctedStrength;     // 0.6 * strength
+        double squareRange;
+    };
+    
+} // namespace enigma
+
+#endif


Property changes on: trunk/src/items/Magnet.hh
___________________________________________________________________
Name: svn:eol-style
   + native



From ral at mail.berlios.de  Thu Aug 14 23:51:06 2008
From: ral at mail.berlios.de (ral at BerliOS)
Date: Thu, 14 Aug 2008 23:51:06 +0200
Subject: [Enigma-game-svn] r1268 - in trunk/src: . items
Message-ID: <200808142151.m7ELp6Uw004367@sheep.berlios.de>

Author: ral
Date: 2008-08-14 23:51:05 +0200 (Thu, 14 Aug 2008)
New Revision: 1268

Added:
   trunk/src/items/Magnet.cc
   trunk/src/items/Sensor.cc
   trunk/src/items/Sensor.hh
   trunk/src/items/StripItem.cc
   trunk/src/items/StripItem.hh
   trunk/src/items/Trigger.cc
   trunk/src/items/Trigger.hh
   trunk/src/items/Vortex.cc
   trunk/src/items/Vortex.hh
   trunk/src/items/WormHole.cc
   trunk/src/items/WormHole.hh
Modified:
   trunk/src/Makefile.am
   trunk/src/items.cc
Log:
Trunk 1.1: new API reengineering
- desintegrated from items.cc:
    vortex, magnet, wormhole, sensor, trigger, strip

Modified: trunk/src/Makefile.am
===================================================================
--- trunk/src/Makefile.am	2008-08-13 22:02:20 UTC (rev 1267)
+++ trunk/src/Makefile.am	2008-08-14 21:51:05 UTC (rev 1268)
@@ -201,8 +201,20 @@
 	items/BlockerItem.hh	\
 	items/GlassesItem.cc	\
 	items/GlassesItem.hh	\
+	items/Magnet.cc		\
+	items/Magnet.hh		\
+	items/Sensor.cc		\
+	items/Sensor.hh		\
 	items/ShogunDot.cc	\
 	items/ShogunDot.hh	\
+	items/StripItem.cc	\
+	items/StripItem.hh	\
+	items/Trigger.cc	\
+	items/Trigger.hh	\
+	items/Vortex.cc		\
+	items/Vortex.hh		\
+	items/Wormhole.cc	\
+	items/Wormhole.hh	\
 	others/Other.cc		\
 	others/Other.hh		\
 	others/Rubberband.cc	\

Added: trunk/src/items/Magnet.cc
===================================================================
--- trunk/src/items/Magnet.cc	2008-08-13 22:02:20 UTC (rev 1267)
+++ trunk/src/items/Magnet.cc	2008-08-14 21:51:05 UTC (rev 1268)
@@ -0,0 +1,101 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *  
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include "items/Magnet.hh"
+#include "actors.hh"
+//#include "errors.hh"
+//#include "main.hh"
+//#include "server.hh"
+#include "world.hh"
+
+namespace enigma {
+    Magnet::Magnet(bool isOn) : Item(), correctedStrength (0.6 * 30), squareRange (1000 * 1000) {
+        state = isOn ? ON : OFF;
+    }
+
+    std::string Magnet::getClass() const {
+        return "it_magnet";
+    }
+    
+    void Magnet::setAttr(const std::string &key, const Value &val) {
+        if (key == "range") {
+            double range = (val.getType() == Value::NIL) ? server::MagnetRange : (double)val;
+            squareRange = range * range;
+        } else if (key == "strength") {
+            correctedStrength = 0.6 * ((val.getType() == Value::NIL) ? server::MagnetForce : (double)val);
+        }
+        Item::setAttr(key, val);
+    }
+    
+    Value Magnet::message(const Message &m) {
+        if (m.message == "_updateglobals" && m.value.to_string() == "it_magnet") {
+            if (getAttr("range").getType() == Value::DEFAULT) {
+                squareRange = server::MagnetRange * server::MagnetRange;
+            }
+            if (getAttr("strength").getType() == Value::DEFAULT) {
+                correctedStrength = 0.6 * server::MagnetForce;
+            }
+            return Value();
+        }
+        return Item::message(m);
+    }
+    void Magnet::init_model() {
+        set_model(ecl::strf("it-magnet%s", state == ON ? "-on" : "-off"));
+    }
+    
+    void Magnet::on_creation(GridPos p) {
+        if (getAttr("range").getType() == Value::DEFAULT) {
+            squareRange = server::MagnetRange * server::MagnetRange;
+        }
+        if (getAttr("strength").getType() == Value::DEFAULT) {
+            correctedStrength = 0.6 * server::MagnetForce;
+        }
+
+        AddForceField(this);
+        Item::on_creation(p);
+    }
+    
+    void Magnet::on_removal(GridPos p) {
+        Item::on_removal(p);
+        RemoveForceField(this);
+    }
+    
+    void Magnet::add_force(Actor *a, V2 &f) {
+        if (state == ON) {
+            V2 dv = get_pos().center() - a->get_pos_force();
+            double squareDist = square(dv);
+
+            if (squareDist >= 0.04 && squareDist < squareRange)
+                f += (correctedStrength / squareDist) * dv;
+        }
+    }
+    
+    ItemTraits Magnet::traits[2] = {
+        { "it_magnet_off", it_magnet_off, itf_static | itf_indestructible, 0.0 },
+        { "it_magnet_on",  it_magnet_on,  itf_static | itf_indestructible, 0.0 },
+    };
+    
+    BOOT_REGISTER_START
+        BootRegister(new Magnet(true), "it_magnet");
+        BootRegister(new Magnet(false), "it_magnet_off");
+        BootRegister(new Magnet(true), "it_magnet_on");
+    BOOT_REGISTER_END
+
+} // namespace enigma


Property changes on: trunk/src/items/Magnet.cc
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/items/Sensor.cc
===================================================================
--- trunk/src/items/Sensor.cc	2008-08-13 22:02:20 UTC (rev 1267)
+++ trunk/src/items/Sensor.cc	2008-08-14 21:51:05 UTC (rev 1268)
@@ -0,0 +1,105 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *  
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include "items/Sensor.hh"
+#include "actors.hh"
+//#include "errors.hh"
+//#include "main.hh"
+#include "server.hh"
+#include "world.hh"
+#include "items/GlassesItem.hh"
+
+namespace enigma {
+    Sensor::Sensor(bool inverse, bool isFilter) {
+        Object::setAttr("inverse", inverse);
+        if (isFilter) {
+            objFlags |= OBJBIT_ISFILTER;
+            Item::setAttr("invisible", true);
+        }
+    }
+    
+    Value Sensor::message(const Message &m) {
+        if (m.message == "_hit") {   // door knocking forward to black/whitballstone
+            setAttr("$hitactor", m.value);
+            performAction(true);
+            setAttr("$hitactor", (Object *)NULL);
+            return Value();
+        } else if (m.message == "_hitactor") {
+            return getAttr("$hitactor");
+        } else if (m.message == "_glasses") {
+            if (isDisplayable())
+                init_model();            
+        } else if (m.message == "signal" && (objFlags & OBJBIT_ISFILTER)) {
+            if (m.value == 1)
+                performAction(true);   // invertion done by Object
+            return Value();
+        }
+        return Item::message(m);
+    }
+    
+    void Sensor::setAttr(const string& key, const Value &val) {
+        if (key == "invisible") {
+            Item::setAttr(key, val);
+            if (isDisplayable())
+                init_model();
+            return;
+        }
+        Item::setAttr(key, val);
+    }
+    
+    void Sensor::init_model() {
+        if (getAttr("invisible").to_bool() && ((server::GlassesVisibility & Glasses::SENSOR) == 0))
+            set_model("invisible");
+        else
+            set_model("it_sensor");
+    }
+
+    void Sensor::animcb() {
+        init_model();
+    }
+
+    void Sensor::actor_enter(Actor *a) {
+        if (!getAttr("invisible").to_bool())
+            set_anim("it_sensor_hit");
+        performAction(true);
+    }
+    
+    int Sensor::traitsIdx() const {
+        int idx = getAttr("inverse").to_bool() ? 1 : 0;
+        if (objFlags & OBJBIT_ISFILTER)
+            idx +=2;
+        return idx;
+    }
+
+    ItemTraits Sensor::traits[4] = {
+        {"it_sensor",  it_sensor,  itf_static}, 
+        {"it_sensor_inverse",  it_inversesensor,  itf_static},
+        {"it_sensor_filter1", it_signalfilter1, itf_static | itf_invisible, 0.0},  // DAT only
+        {"it_sensor_filter0", it_signalfilter0, itf_static | itf_invisible, 0.0}   // DAT only
+    };
+    BOOT_REGISTER_START
+        BootRegister(new Sensor(true), "it_sensor");
+        BootRegister(new Sensor(false), "it_sensor_inverse");
+        BootRegister(new Sensor(true, true), "it_sensor_filter1");
+        BootRegister(new Sensor(false, true), "it_sensor_filter0");
+    BOOT_REGISTER_END
+
+} // namespace enigma
+    


Property changes on: trunk/src/items/Sensor.cc
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/items/Sensor.hh
===================================================================
--- trunk/src/items/Sensor.hh	2008-08-13 22:02:20 UTC (rev 1267)
+++ trunk/src/items/Sensor.hh	2008-08-14 21:51:05 UTC (rev 1268)
@@ -0,0 +1,60 @@
+/*
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef SENSORITEM_HH
+#define SENSORITEM_HH
+
+#include "items.hh"
+
+#include "enigma.hh"
+
+namespace enigma {
+    class Sensor : public Item {
+        CLONEOBJ(Sensor);
+        DECL_ITEMTRAITS_ARRAY(4, traitsIdx());
+    private:
+        enum ObjectPrivatFlagsBits {
+            OBJBIT_ISFILTER  =   1<<24    ///< sensor that filters signals, too
+        };
+    public:
+        static void setup();
+            
+        Sensor(bool inverse, bool isFilter = false);
+        
+        // Object interface
+        virtual Value message(const Message &m);
+        
+        // StateObject interface
+        virtual void setAttr(const string& key, const Value &val);
+        
+        // GridObject interface
+        virtual void init_model();
+
+        // ModelCallback interface
+        virtual void animcb();
+
+        // Item interface
+        virtual void actor_enter(Actor *a);
+    
+    private:
+        int traitsIdx() const;
+    };
+    
+} // namespace enigma
+
+#endif


Property changes on: trunk/src/items/Sensor.hh
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/items/StripItem.cc
===================================================================
--- trunk/src/items/StripItem.cc	2008-08-13 22:02:20 UTC (rev 1267)
+++ trunk/src/items/StripItem.cc	2008-08-14 21:51:05 UTC (rev 1268)
@@ -0,0 +1,138 @@
+/*
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *  
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include "items/StripItem.hh"
+#include "actors.hh"
+//#include "errors.hh"
+//#include "main.hh"
+#include "world.hh"
+
+namespace enigma {
+    StripItem::StripItem(std::string connections) {
+        setAttr("connections", connections);
+    }
+        
+    std::string StripItem::getClass() const {
+        return "it_strip";
+    }
+    
+    void StripItem::setState(int extState) {
+        // block state set
+    }
+    
+    std::string StripItem::getModelName() const {
+        return getClass();
+    }
+    
+    void StripItem::init_model() {
+        // need to bypass Item's implementation
+        GridObject::init_model();
+    }
+
+    bool StripItem::covers_floor(ecl::V2 pos, Actor *a) const {
+        if (GridPos(pos) != get_pos())
+            return false;
+
+        double velocity = 0;
+        if (a != NULL) 
+            velocity = ecl::length(a->get_actorinfo()->vel);
+            
+        // calculate the maximal horizontal or vertical distance from the center:
+        // gurantee that a large marble can touch a neighboring stone at speed 0,
+        // and a fast marble does not step off the strip on hitting a neighbor stone.
+        // A fast marble might not reach the stone in one timestep while being
+        // on top of the strip and is afterwards moved forward off the strip.
+        // Thus we must expand the strip with increasing speed of the actor - call
+        // it a relativistic effect :-)
+        // d = 1/2 - 19/64 - 0.02 + velocity/400 
+        //  = 1/2 - radius large marble - epsilon + velocity/(1/2.5 ms)
+        // we need to limit the speed to avoid a fast marble traversing the gap in
+        // two timesteps! 
+        double MAXDIST = 0.183125 + ecl::Clamp(velocity/400, 0.0, 0.125);
+        
+        double ycenter = get_pos().y + 0.5;
+        double xcenter = get_pos().x + 0.5;
+        DirectionBits cbits = getConnections();
+        
+        return (((fabs(pos[1] - ycenter) <= MAXDIST) && ((fabs(pos[0] - xcenter) <= MAXDIST)  ||
+                   ((pos[0] <= xcenter + MAXDIST) && (cbits & WESTBIT)) || ((pos[0] >= xcenter - MAXDIST) && (cbits & EASTBIT))))
+                || ((fabs(pos[0] - xcenter) <= MAXDIST) 
+                && (((pos[1] <= ycenter + MAXDIST) && (cbits & NORTHBIT)) || ((pos[1] >= ycenter - MAXDIST) && (cbits & SOUTHBIT)))))
+                ? true : false;
+    }
+    
+    double StripItem::getFriction(ecl::V2 pos, double defaultFriction, Actor *a) {
+        Value v = getAttr("friction");
+        if (v && covers_floor(pos, a))
+            return v;
+        else
+            return defaultFriction;
+    }
+    
+    ecl::V2 StripItem::calcMouseforce(Actor *a, ecl::V2 mouseForce, ecl::V2 floorForce) {
+        Value v = getAttr("adhesion");
+        if (v && covers_floor(a->get_pos(), a))
+            return mouseForce * (double)v ;
+        else
+            return floorForce;        
+    }
+        
+    int StripItem::traitsIdx() const {
+        return getConnections();
+    }
+
+    ItemTraits StripItem::traits[16] = {
+        {"it_strip",  it_strip,  itf_static},
+        {"it_strip_w",  it_strip_w,  itf_static},
+        {"it_strip_s",  it_strip_s,  itf_static},
+        {"it_strip_sw",  it_strip_sw,  itf_static},
+        {"it_strip_e",  it_strip_e,  itf_static},
+        {"it_strip_ew",  it_strip_ew,  itf_static},
+        {"it_strip_es",  it_strip_es,  itf_static},
+        {"it_strip_esw",  it_strip_esw,  itf_static},
+        {"it_strip_n",  it_strip_n,  itf_static},
+        {"it_strip_nw",  it_strip_nw,  itf_static},
+        {"it_strip_ns",  it_strip_ns,  itf_static},
+        {"it_strip_nsw",  it_strip_nsw,  itf_static},
+        {"it_strip_ne",  it_strip_ne,  itf_static},
+        {"it_strip_new",  it_strip_new,  itf_static},
+        {"it_strip_nes",  it_strip_nes,  itf_static},
+        {"it_strip_nesw",  it_strip_nesw,  itf_static}
+    };
+    
+    BOOT_REGISTER_START
+        BootRegister(new StripItem(""), "it_strip");
+        BootRegister(new StripItem("w"), "it_strip_w");
+        BootRegister(new StripItem("s"), "it_strip_s");
+        BootRegister(new StripItem("sw"), "it_strip_sw");
+        BootRegister(new StripItem("e"), "it_strip_e");
+        BootRegister(new StripItem("ew"), "it_strip_ew");
+        BootRegister(new StripItem("es"), "it_strip_es");
+        BootRegister(new StripItem("esw"), "it_strip_esw");
+        BootRegister(new StripItem("n"), "it_strip_n");
+        BootRegister(new StripItem("nw"), "it_strip_nw");
+        BootRegister(new StripItem("ns"), "it_strip_ns");
+        BootRegister(new StripItem("nsw"), "it_strip_nsw");
+        BootRegister(new StripItem("ne"), "it_strip_ne");
+        BootRegister(new StripItem("new"), "it_strip_new");
+        BootRegister(new StripItem("nes"), "it_strip_nes");
+        BootRegister(new StripItem("nesw"), "it_strip_nesw");
+    BOOT_REGISTER_END
+
+} // namespace enigma


Property changes on: trunk/src/items/StripItem.cc
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/items/StripItem.hh
===================================================================
--- trunk/src/items/StripItem.hh	2008-08-13 22:02:20 UTC (rev 1267)
+++ trunk/src/items/StripItem.hh	2008-08-14 21:51:05 UTC (rev 1268)
@@ -0,0 +1,57 @@
+/*
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef STRIPITEM_HH
+#define STRIPITEM_HH
+
+#include "items.hh"
+
+#include "enigma.hh"
+
+namespace enigma {
+    class StripItem : public Item {
+        CLONEOBJ(StripItem);
+        DECL_ITEMTRAITS_ARRAY(16, traitsIdx());
+        
+    public:
+        static void setup();
+                
+        StripItem(std::string connections);
+        
+        // Object interface
+        virtual std::string getClass() const;
+
+        // StateObject interface
+        virtual void setState(int extState);
+        
+        // GridObject interface
+        virtual std::string getModelName() const;
+        virtual void init_model();
+                
+        // Items interface
+        virtual bool covers_floor(ecl::V2 pos, Actor *a) const;
+        virtual double getFriction(ecl::V2 pos, double defaultFriction, Actor *a);
+        virtual ecl::V2 calcMouseforce(Actor *a, ecl::V2 mouseForce, ecl::V2 floorForce);
+        
+    private:
+        int traitsIdx() const;
+    };
+    
+} // namespace enigma
+
+#endif


Property changes on: trunk/src/items/StripItem.hh
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/items/Trigger.cc
===================================================================
--- trunk/src/items/Trigger.cc	2008-08-13 22:02:20 UTC (rev 1267)
+++ trunk/src/items/Trigger.cc	2008-08-14 21:51:05 UTC (rev 1268)
@@ -0,0 +1,137 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *  
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include "items/Trigger.hh"
+#include "actors.hh"
+//#include "errors.hh"
+//#include "main.hh"
+#include "server.hh"
+#include "world.hh"
+
+#include <vector>
+
+namespace enigma {
+    Trigger::Trigger() {
+        setAttr("invisible", false);
+    }
+    
+    Value Trigger::message (const Message &m) {
+        if (m.message == "signal" && (server::GameCompatibility != GAMET_ENIGMA || 
+                server::EnigmaCompatibility < 1.10)) {
+            performAction(m.value.to_bool());  // convert 1/0 values to true/false
+            return Value();
+        } else if (m.message == "_init") {
+            // the state count at init is wrong as some actors on the grid may
+            // already have existed on_creation, but all are reported via
+            // actor_enter due to actors on_creation.
+            // Thus we need to reset and recount the actors:
+            state = 0;
+            
+            // old Enigma versions did issue performAction what is incompatible
+            updateIState(countActors(),
+                    server::EnigmaCompatibility >= 1.10 || server::GameCompatibility != GAMET_ENIGMA); 
+            return Value();
+        } else if (m.message == "_jumping" ) {
+            updateIState(m.value.to_bool() ? -1 : +1);
+        }
+        return Item::message(m);
+    }
+        
+    int Trigger::externalState() const {
+        return state != 0 ? 1 : 0;
+    }
+    
+    void Trigger::setState(int extState) {
+        return;   // ignore any write attempts
+    }
+    
+    void Trigger::on_creation(GridPos p) {
+        state = 0;
+        updateIState(countActors(), true);
+        init_model();
+    }
+        
+    void Trigger::init_model() {
+        if (getAttr("invisible").to_bool())
+            set_model("invisible");
+        else if (state != 0)
+            set_model("it-trigger1");
+        else
+            set_model("it-trigger");
+    }
+    
+    void Trigger::actor_enter(Actor *a) {
+        if (!a->is_flying())
+            updateIState(+1, !server::WorldInitialized);
+    }
+    
+    void Trigger::actor_leave(Actor *a) {
+        if (!a->is_flying())
+            updateIState(-1, !server::WorldInitialized);
+    }
+    
+    void Trigger::stone_change(Stone *) {
+        updateIState(0);
+    }
+    
+    int Trigger::countActors() {
+        std::vector<Actor*> actors;
+        GetActorsInsideField (get_pos(), actors);
+        int count = 0;
+        for (std::vector<Actor*>::iterator it = actors.begin(); it != actors.end(); ++it)
+            if (!(*it)->is_flying()) count++;
+        return count;
+    }
+    
+    void Trigger::updateIState(int diffActors, bool refuseAction) {
+        int oldState = state;
+        
+        state += 2 * diffActors;
+        
+        Stone *st = GetStone(get_pos());
+        state &= ~1;  // delete stone pressure bit
+        if (st != NULL && (!st->is_floating() || st->is_kind("st-puzzle*"))) {
+            // Hack to make hollow puzzle stones press triggers
+            state |= 1;   // add stone pressure bit
+        }
+                
+//        Log << "Trigger update old state " << oldState << " - new state " << state << " refuse action " << refuseAction << "\n";
+    
+        if ((oldState == 0 && state != 0) || (oldState != 0 && state == 0)) {
+            init_model();
+            if (!refuseAction) {
+                if (state != 0) {
+                    sound_event ("triggerdown");
+                    performAction(true);
+                } else {
+                    sound_event ("triggerup");
+                    performAction(false);
+                }
+            }
+        }
+    }
+
+    DEF_ITEMTRAITSF(Trigger, "it_trigger", it_trigger, itf_static | itf_indestructible);
+
+    BOOT_REGISTER_START
+        BootRegister(new Trigger(), "it_trigger");
+    BOOT_REGISTER_END
+
+} // namespace enigma


Property changes on: trunk/src/items/Trigger.cc
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/items/Trigger.hh
===================================================================
--- trunk/src/items/Trigger.hh	2008-08-13 22:02:20 UTC (rev 1267)
+++ trunk/src/items/Trigger.hh	2008-08-14 21:51:05 UTC (rev 1268)
@@ -0,0 +1,72 @@
+/*
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef TRIGGERITEM_HH
+#define TRIGGERITEM_HH
+
+#include "items.hh"
+
+#include "enigma.hh"
+
+namespace enigma {
+    /**
+     * A switch that is triggered by actors crossing it on the floor and stones
+     * being pushed onto it. The external state is read only - value 1 (ON) is
+     * reported if the trigger is pressed either by an actor or a stone, a value
+     * 0 (OFF) otherwise.<p>
+     * Note that due to the Enigma 1.10 standards no actions will be performed
+     * on initialization or setting of a trigger, even if actors or a stone are
+     * positioned on the grid. But state and model are set according to the other
+     * objects.<p>
+     * The internal state stores the current number of actors and the presence
+     * of a stone. The stone is flagged as the least significant bit, the actor
+     * count is stored in the bits above, what is simply an addition of 2 times
+     * the actor count to the state. This coding simplifies requests and avoids
+     * usage of additional ivars for the complete logical state.
+     */
+    class Trigger : public Item {
+        CLONEOBJ(Trigger);
+        DECL_ITEMTRAITS;
+    public:
+        Trigger();
+        
+        // Object interface
+        virtual Value message (const Message &m);
+        
+        // StateObject interface
+        virtual int externalState() const;
+        virtual void setState(int extState);
+
+        // GridObject interface
+        virtual void on_creation(GridPos p);
+        virtual void init_model();
+        
+        // Item interface
+        virtual void actor_enter(Actor *a);
+        virtual void actor_leave(Actor *a);
+        virtual void stone_change(Stone *st);
+    private:
+        // Methods
+        int countActors();
+        void updateIState(int diffActors = 0, bool refuseAction = false);
+
+    };
+    
+} // namespace enigma
+
+#endif


Property changes on: trunk/src/items/Trigger.hh
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/items/Vortex.cc
===================================================================
--- trunk/src/items/Vortex.cc	2008-08-13 22:02:20 UTC (rev 1267)
+++ trunk/src/items/Vortex.cc	2008-08-14 21:51:05 UTC (rev 1268)
@@ -0,0 +1,272 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *  
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include "items/Vortex.hh"
+#include "actors.hh"
+#include "client.hh"
+#include "errors.hh"
+#include "server.hh"
+//#include "main.hh"
+#include "world.hh"
+
+namespace enigma {
+    Vortex::Vortex(bool open) : Item() {
+        state = open ? OPEN : CLOSED;
+        setAttr("$dest_idx", 0);
+        setAttr("$dest_vortex", (Object *)NULL);
+        setAttr("$grabbed_actor", (Object *)NULL);
+    }
+
+    Vortex::~Vortex() {
+        GameTimer.remove_alarm(this);
+        if (Actor *actor = dynamic_cast<Actor *>((Object *)getAttr("$grabbed_actor"))) {
+            // release an actor that is grabbed on behalf of this vortex - actor state FALLING_VORTEX
+            SendMessage(actor, "rise");
+        }
+    }
+
+    std::string Vortex::getClass() const {
+        return "it_vortex";
+    }
+    
+    Value Vortex::message(const Message &m) {
+        if (m.message == "_passed" && getAttr("autoclose").to_bool()) {
+            setState(0);
+            performAction(getAttr("$grabbed_actor"));
+            return Value();
+        }
+        return Item::message(m);
+    }
+
+    int Vortex::externalState() const {
+        return (state >= CLOSED && state <= CLOSING) ? 0 : 1 ;
+    }
+    
+    void Vortex::setState(int extState) {
+        if (isDisplayable()) {
+            if (extState == 1) {  // open
+                if (state == CLOSING) {
+                    state = OPENING;
+                    get_model()->reverse(); // reverse animation
+                }
+                else if (state == CLOSED) {
+                    state = OPENING;
+                    sound_event ("vortexopen");
+                    init_model();
+                }
+            } else if (extState == 0) { // close
+                if (state == OPENING) {
+                    state = CLOSING;
+                    get_model()->reverse(); // reverse animation
+                }
+                else if (state == OPEN) {
+                    state = CLOSING;
+                    sound_event ("vortexclose");
+                    init_model();
+                }
+            }
+        } else {
+            if (extState <= 1 && extState >= 0)
+                state = 1 - extState;
+        }
+    }
+        
+    void Vortex::toggleState() {
+        if (state == OPEN || state == OPENING)
+            setState(0);
+        else
+            setState(1);
+    }
+    
+    void Vortex::init_model() {
+        switch(state) {
+            case WARPING:
+            case OPEN:
+            case EMITTING:
+            case SWALLOWING:
+                set_model("it-vortex-open");
+                break;
+            case CLOSED: 
+                set_model("it-vortex-closed"); break;
+            case OPENING: 
+                set_anim("it-vortex-opening"); break;
+            case CLOSING: 
+                set_anim("it-vortex-closing"); break;
+        }
+    }
+    
+    void Vortex::on_removal(GridPos p) {
+        Item::on_removal(p);
+        ASSERT(state != WARPING && state != SWALLOWING && state != EMITTING,
+            XLevelRuntime, "Tried to kill a busy vortex. Please use another way.");
+    }
+    
+    void Vortex::animcb() {
+        if (state == CLOSING) {
+            state = CLOSED;
+            init_model();
+        }
+        else if (state == OPENING) {
+            state = OPEN;
+            init_model();
+        }
+    }
+    
+    bool Vortex::actor_hit (Actor *actor) {
+        if (state == OPEN && (length((actor->get_pos()) - get_pos().center()) < 0.25) && actor->can_be_warped())
+            prepare_for_warp (actor);
+        return false;
+    }
+    
+    void Vortex::alarm() {
+        if (state == WARPING) {
+            perform_warp();
+        } else if (state == EMITTING) {
+            emit_actor(dynamic_cast<Vortex *>((Object *)getAttr("$dest_vortex")));
+        } else if (state == SWALLOWING) {
+            state = WARPING;
+            sound_event ("hitfloor");
+            perform_warp();
+        } else
+            ASSERT (0, XLevelRuntime, "Vortex: alarm called with inconsistent state");
+    }
+    
+    void Vortex::prepare_for_warp (Actor *actor) {
+        SendMessage(actor, "fallvortex");
+        setAttr("$dest_idx", 0);
+        setAttr("$grabbed_actor", actor);
+        state = SWALLOWING;
+    
+        GameTimer.set_alarm(this, 0.4, false);
+    }
+    
+    void Vortex::emit_actor(Vortex *destVortex) {
+        if (destVortex == NULL)   // destination vortex got killed in meantime
+            destVortex = this;    // reemit from source vortex 
+        V2 v(destVortex->get_pos().center());
+        if (Actor *actor = dynamic_cast<Actor *>((Object *)getAttr("$grabbed_actor"))) {
+            WarpActor(actor, v[0], v[1], false);
+            SendMessage(actor, "rise");
+            if (destVortex != this) {
+                bool isScissor = to_bool(getDefaultedAttr("scissor", 
+                        (server::EnigmaCompatibility >= 1.10) || server::GameCompatibility != GAMET_ENIGMA));
+                if (isScissor)
+                    SendMessage(actor, "disconnect");
+            }
+        }
+        state = OPEN;
+        if (this != destVortex && getAttr("autoclose").to_bool())  // do not close source vortex if destination is currently blocked
+            setState(0);
+        if (this != destVortex)
+            performAction(getAttr("$grabbed_actor"));
+    
+        setAttr("$grabbed_actor", (Object *)NULL);
+    }
+
+    void Vortex::warp_to(const ecl::V2 &target) {
+        client::Msg_Sparkle (target);
+        if (Actor *actor = dynamic_cast<Actor *>((Object *)getAttr("$grabbed_actor"))) {
+            WarpActor(actor, target[0], target[1], false);
+            SendMessage(actor, "appear");
+            bool isScissor = to_bool(getDefaultedAttr("scissor", 
+                    (server::EnigmaCompatibility >= 1.10) || server::GameCompatibility != GAMET_ENIGMA));
+            if (isScissor)
+                SendMessage(actor, "disconnect");
+        }
+        state = OPEN;
+        if (getAttr("autoclose").to_bool())
+            setState(0);
+    
+        performAction(getAttr("$grabbed_actor"));
+        setAttr("$grabbed_actor", (Object *)NULL);
+    }
+
+    void Vortex::perform_warp() {
+        Actor *actor = dynamic_cast<Actor *>((Object *)getAttr("$grabbed_actor"));
+        if (actor == NULL)
+            return;
+    
+        ASSERT (state == WARPING, XLevelRuntime, "Vortex: perform_warp called with inconsistent state");
+    
+        V2 v_target;
+    
+        // is another target position defined?
+        int dest_idx = getAttr("$dest_idx");
+        if (Object::getDestinationByIndex(dest_idx, v_target)) {
+            GridPos  p_target(v_target);
+    
+            Vortex *v = dynamic_cast<Vortex*>(GetItem(p_target));
+    
+            if (v) {                // Destination is also a vortex
+                Stone *st = GetStone(p_target);
+    
+                if (st && st->is_sticky(actor)) {
+                    // is destination vortex blocked? redirect
+                    setAttr("$dest_idx", dest_idx + 1);
+                    client::Msg_Sparkle(v_target);
+                    WarpActor(actor, v_target[0], v_target[1], false);
+                    GameTimer.set_alarm(this, 0.4, false);
+                }
+                else {
+                    switch (v->state) {
+                        case OPEN:
+                        case OPENING:
+                            // destination is open
+                            emit_actor(v);
+                            break;
+        
+                        case CLOSED:
+                        case CLOSING:
+                            // destination is closed
+                            SendMessage(v, "open");
+                            setAttr("$dest_vortex", v);
+                            state = EMITTING;
+                            GameTimer.set_alarm(this, 0.4, false);
+                            break;
+                        case SWALLOWING:
+                        case WARPING:
+                        case EMITTING:
+                            // destination is busy -> don't warp actor, emit
+                            // it where it has started
+                            emit_actor(this);
+                    }
+                }
+            } else {
+                warp_to(v_target);
+            }
+        }
+        else {
+            // if no target defined, don't warp actor
+            emit_actor(this);
+        }
+    }
+
+    ItemTraits Vortex::traits[2] = {
+        {"it_vortex_closed", it_vortex_closed, itf_static | itf_fireproof, 0.0},
+        {"it_vortex_open", it_vortex_open,     itf_static | itf_fireproof, 0.0}
+    };
+
+    BOOT_REGISTER_START
+        BootRegister(new Vortex(true), "it_vortex");
+        BootRegister(new Vortex(false), "it_vortex_closed");
+        BootRegister(new Vortex(true), "it_vortex_open");
+    BOOT_REGISTER_END
+
+} // namespace enigma


Property changes on: trunk/src/items/Vortex.cc
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/items/Vortex.hh
===================================================================
--- trunk/src/items/Vortex.hh	2008-08-13 22:02:20 UTC (rev 1267)
+++ trunk/src/items/Vortex.hh	2008-08-14 21:51:05 UTC (rev 1268)
@@ -0,0 +1,81 @@
+/*
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef VORTEXITEM_HH
+#define VORTEXITEM_HH
+
+#include "items.hh"
+
+#include "enigma.hh"
+
+namespace enigma {
+    class Vortex : public Item, public TimeHandler {
+    private:
+        enum iState {
+            OPEN,          ///< TODO exchange OPEN, CLOSED to match external state 
+            CLOSED,        ///<
+            OPENING,       ///<
+            CLOSING,       ///<
+            WARPING,       ///< an open vortex occupied in process of sending a marble
+            EMITTING,      ///< an open vortex occupied, waiting for the destination to open
+            SWALLOWING     ///< an open vortex eats up a marble
+        };
+
+    public:
+        CLONEOBJ(Vortex);
+        DECL_ITEMTRAITS_ARRAY(2, is_open());
+        
+        Vortex(bool opened);
+        virtual ~Vortex();
+
+        // Object interface
+        virtual std::string getClass() const;
+        virtual Value message(const Message &m);
+
+        // StateObject interface
+        virtual int externalState() const;
+        virtual void setState(int extState);
+        virtual void toggleState();
+
+        // GridObject interface
+        virtual void init_model();
+        virtual void on_removal(GridPos p);
+        
+        // ModelCallback interface
+        virtual void animcb();
+
+        // Item interface
+        virtual bool actor_hit(Actor*);
+
+        // TimeHandler interface
+        virtual void alarm();
+
+    private:
+        void prepare_for_warp(Actor *actor);
+        void emit_actor(Vortex *destVortex);
+
+        void perform_warp();    // warp swallowed actor(s)
+        void warp_to(const ecl::V2 &target);
+
+        bool is_open() const { return externalState() == 1 ; }
+
+    };
+    
+} // namespace enigma
+
+#endif


Property changes on: trunk/src/items/Vortex.hh
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/items/WormHole.cc
===================================================================
--- trunk/src/items/WormHole.cc	2008-08-13 22:02:20 UTC (rev 1267)
+++ trunk/src/items/WormHole.cc	2008-08-14 21:51:05 UTC (rev 1268)
@@ -0,0 +1,157 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *  
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include "items/WormHole.hh"
+#include "actors.hh"
+//#include "errors.hh"
+//#include "main.hh"
+//#include "server.hh"
+#include "world.hh"
+
+namespace enigma {
+    WormHole::WormHole(bool isOn) : Item(), correctedStrength (0.6 * 30), squareRange (1000 * 1000) {
+        state = isOn ? ON_IDLE : OFF_IDLE;    // includes warping false
+    }
+    
+    std::string WormHole::getClass() const {
+        return "it_wormhole";
+    }
+    
+    void WormHole::setAttr(const std::string &key, const Value &val) {
+        if (key == "range") {
+            double range = (val.getType() == Value::NIL) ? server::WormholeRange : (double)val;
+            squareRange = range * range;
+        } else if (key == "strength") {
+            correctedStrength = 0.6 * ((val.getType() == Value::NIL) ? server::WormholeForce : (double)val);
+        }
+        Item::setAttr(key, val);
+    }
+    
+    Value WormHole::message(const Message &m) {
+        if (m.message == "_updateglobals" && m.value.to_string() == "it_wormhole") {
+            if (getAttr("range").getType() == Value::DEFAULT) {
+                squareRange = server::WormholeRange * server::WormholeRange;
+            }
+            if (getAttr("strength").getType() == Value::DEFAULT) {
+                correctedStrength = 0.6 * server::WormholeForce;
+            }
+            return Value(); 
+        }
+        return Item::message(m);
+    }
+
+    int WormHole::externalState() const {
+        return state % 2;
+    }
+    
+    void WormHole::setState(int extState) {
+        // switch force on and off
+        if (extState != state % 2) {          // react only on force changes
+            state = (state & ~1) + extState;  // keep other flags
+            if (isDisplayable()) {
+                if (extState == 1)
+                    AddForceField(this);
+                else
+                    RemoveForceField(this);
+            }
+        }
+    }
+    
+    void WormHole::on_creation (GridPos p) {
+        Item::on_creation (p);
+        if (getAttr("range").getType() == Value::DEFAULT) {
+            squareRange = server::WormholeRange * server::WormholeRange;
+        }
+        if (getAttr("strength").getType() == Value::DEFAULT) {
+            correctedStrength = 0.6 * server::WormholeForce;
+        }
+        if (state % 2 == 1)
+            AddForceField(this);
+    }
+
+    void WormHole::on_removal(GridPos p) {
+        GameTimer.remove_alarm(this);
+        state &= ~2;  // remove teleport engaged flag
+        if (state % 2 == 1)
+            RemoveForceField(this);
+        Item::on_removal(p);
+        ASSERT((state & 4) == 0, XLevelRuntime, "Tried to kill a busy wormhole. Please use another way.");
+    }
+    
+    void WormHole::init_model() {
+        if ((state & 3) == ON_IDLE)
+            set_anim("it-wormhole");
+        else
+            set_model("it-wormhole-off");
+    }
+    
+    bool WormHole::actor_hit(Actor *actor) {
+        ASSERT((state & 4) == 0, XLevelRuntime, "WormHole:: Recursion detected!");
+        if ((state & 2) == 0 && near_center_p(actor)) {   // may teleport
+            client::Msg_Sparkle (get_pos().center());
+            V2 targetpos;
+            if (getDestinationByIndex(0, targetpos)) {
+                sound_event ("warp");
+                double latency = getAttr("interval");
+                if(latency > 0) {
+                    state |= 2;  // mark engaged
+                    GameTimer.set_alarm(this, latency, false);
+                    init_model();
+                }
+                state |= 4;  // mark warping
+                bool isScissor = to_bool(getAttr("scissor")) || server::GameCompatibility != GAMET_ENIGMA;
+                if (isScissor)
+                    SendMessage(actor, "disconnect");
+                WarpActor(actor, targetpos[0], targetpos[1], false);
+                state &= ~4; // release warping
+            }
+        }
+        return false;
+    }
+    
+    void WormHole::add_force(Actor *a, V2 &f) {
+        V2 dv = get_pos().center() - a->get_pos_force();
+        double squareDist = square(dv);
+
+        if (squareDist >= 0.025 && squareDist < squareRange)
+            f += (correctedStrength / squareDist) * dv;
+    }
+    
+    void WormHole::alarm() {
+        state &= ~2;  // remove teleport engaged flag
+        init_model();
+    }
+    
+    bool WormHole::near_center_p(Actor *a) {
+        return (square(a->get_pos() - get_pos().center()) < 0.015625);  // 0.125 ^ 2
+    }
+    
+    ItemTraits WormHole::traits[2] = {
+        { "it_wormhole_off", it_wormhole_off, itf_static, 0.0 },
+        { "it_wormhole_on",  it_wormhole_on,  itf_static, 0.0 }
+    };
+
+    BOOT_REGISTER_START
+        BootRegister(new WormHole(true), "it_wormhole");
+        BootRegister(new WormHole(false), "it_wormhole_off");
+        BootRegister(new WormHole(true), "it_wormhole_on");
+    BOOT_REGISTER_END
+
+} // namespace enigma


Property changes on: trunk/src/items/WormHole.cc
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/items/WormHole.hh
===================================================================
--- trunk/src/items/WormHole.hh	2008-08-13 22:02:20 UTC (rev 1267)
+++ trunk/src/items/WormHole.hh	2008-08-14 21:51:05 UTC (rev 1268)
@@ -0,0 +1,77 @@
+/*
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef WORMHOLEITEM_HH
+#define WORMHOLEITEM_HH
+
+#include "items.hh"
+
+#include "enigma.hh"
+
+namespace enigma {
+    class WormHole : public Item, public ForceField, public TimeHandler {
+    private:
+        /**
+         * warping as bit 2 of state
+         */
+        enum iState {
+            OFF_IDLE,        ///< force off, ready to teleport
+            ON_IDLE,         ///< force on,  ready to teleport
+            OFF_ENGAGED,     ///< force off, rejecting teleport
+            ON_ENGAGED       ///< force on,  rejecting teleport
+        };
+        
+    public:
+        CLONEOBJ(WormHole);
+        DECL_ITEMTRAITS_ARRAY(2, state & 1);
+        
+        WormHole(bool isOn);
+        
+        // Object interface
+        virtual std::string getClass() const;
+        virtual void setAttr(const std::string &key, const Value &val);
+        virtual Value message(const Message &m);
+
+        // StateObject interface
+        virtual int externalState() const;
+        virtual void setState(int extState);
+
+        // GridObject interface
+        virtual void on_creation(GridPos p);
+        virtual void on_removal(GridPos p);
+        virtual void init_model();
+        
+        // Item interface
+        virtual bool actor_hit(Actor *a);
+
+        // ForceField interface
+        virtual void add_force(Actor *a, V2 &f);
+        
+        // TimeHandler interface
+        virtual void alarm();
+        
+    private:
+        bool near_center_p(Actor *a);
+
+        double correctedStrength;     ///< 0.6 * strength
+        double squareRange;           ///< range of the force squared
+    };
+    
+} // namespace enigma
+
+#endif


Property changes on: trunk/src/items/WormHole.hh
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/src/items.cc
===================================================================
--- trunk/src/items.cc	2008-08-13 22:02:20 UTC (rev 1267)
+++ trunk/src/items.cc	2008-08-14 21:51:05 UTC (rev 1268)
@@ -1425,153 +1425,6 @@
 }
 
 
-/* -------------------- Trigger -------------------- */
-    /**
-     * A switch that is triggered by actors crossing it on the floor and stones
-     * being pushed onto it. The external state is read only - value 1 (ON) is
-     * reported if the trigger is pressed either by an actor or a stone, a value
-     * 0 (OFF) otherwise.<p>
-     * Note that due to the Enigma 1.10 standards no actions will be performed
-     * on initialization or setting of a trigger, even if actors or a stone are
-     * positioned on the grid. But state and model are set according to the other
-     * objects.<p>
-     * The internal state stores the current number of actors and the presence
-     * of a stone. The stone is flagged as the least significant bit, the actor
-     * count is stored in the bits above, what is simply an addition of 2 times
-     * the actor count to the state. This coding simplifies requests and avoids
-     * usage of additional ivars for the complete logical state.
-     */
-    class Trigger : public Item {
-        CLONEOBJ(Trigger);
-        DECL_ITEMTRAITS;
-    public:
-        Trigger();
-        
-        // Object interface
-        virtual Value message (const Message &m);
-        
-        // StateObject interface
-        virtual int externalState() const;
-        virtual void setState(int extState);
-
-        // GridObject interface
-        virtual void on_creation(GridPos p);
-        virtual void init_model();
-        
-        // Item interface
-        virtual void actor_enter(Actor *a);
-        virtual void actor_leave(Actor *a);
-        virtual void stone_change(Stone *st);
-    private:
-        // Methods
-        int countActors();
-        void updateIState(int diffActors = 0, bool refuseAction = false);
-
-    };
-
-    DEF_ITEMTRAITSF(Trigger, "it_trigger", it_trigger, itf_static | itf_indestructible);
-    
-    Trigger::Trigger() {
-        setAttr("invisible", false);
-    }
-    
-    Value Trigger::message (const Message &m) {
-        if (m.message == "signal" && (server::GameCompatibility != GAMET_ENIGMA || 
-                server::EnigmaCompatibility < 1.10)) {
-            performAction(m.value.to_bool());  // convert 1/0 values to true/false
-            return Value();
-        } else if (m.message == "_init") {
-            // the state count at init is wrong as some actors on the grid may
-            // already have existed on_creation, but all are reported via
-            // actor_enter due to actors on_creation.
-            // Thus we need to reset and recount the actors:
-            state = 0;
-            
-            // old Enigma versions did issue performAction what is incompatible
-            updateIState(countActors(),
-                    server::EnigmaCompatibility >= 1.10 || server::GameCompatibility != GAMET_ENIGMA); 
-            return Value();
-        } else if (m.message == "_jumping" ) {
-            updateIState(m.value.to_bool() ? -1 : +1);
-        }
-        return Item::message(m);
-    }
-        
-    int Trigger::externalState() const {
-        return state != 0 ? 1 : 0;
-    }
-    
-    void Trigger::setState(int extState) {
-        return;   // ignore any write attempts
-    }
-    
-    void Trigger::on_creation(GridPos p) {
-        state = 0;
-        updateIState(countActors(), true);
-        init_model();
-    }
-        
-    void Trigger::init_model() {
-        if (getAttr("invisible").to_bool())
-            set_model("invisible");
-        else if (state != 0)
-            set_model("it-trigger1");
-        else
-            set_model("it-trigger");
-    }
-    
-    void Trigger::actor_enter(Actor *a) {
-        if (!a->is_flying())
-            updateIState(+1, !server::WorldInitialized);
-    }
-    
-    void Trigger::actor_leave(Actor *a) {
-        if (!a->is_flying())
-            updateIState(-1, !server::WorldInitialized);
-    }
-    
-    void Trigger::stone_change(Stone *) {
-        updateIState(0);
-    }
-    
-    int Trigger::countActors() {
-        vector<Actor*> actors;
-        GetActorsInsideField (get_pos(), actors);
-        int count = 0;
-        for (vector<Actor*>::iterator it = actors.begin(); it != actors.end(); ++it)
-            if (!(*it)->is_flying()) count++;
-        return count;
-    }
-    
-    void Trigger::updateIState(int diffActors, bool refuseAction) {
-        int oldState = state;
-        
-        state += 2 * diffActors;
-        
-        Stone *st = GetStone(get_pos());
-        state &= ~1;  // delete stone pressure bit
-        if (st != NULL && (!st->is_floating() || st->is_kind("st-puzzle*"))) {
-            // Hack to make hollow puzzle stones press triggers
-            state |= 1;   // add stone pressure bit
-        }
-                
-//        Log << "Trigger update old state " << oldState << " - new state " << state << " refuse action " << refuseAction << "\n";
-    
-        if ((oldState == 0 && state != 0) || (oldState != 0 && state == 0)) {
-            init_model();
-            if (!refuseAction) {
-                if (state != 0) {
-                    sound_event ("triggerdown");
-                    performAction(true);
-                } else {
-                    sound_event ("triggerup");
-                    performAction(false);
-                }
-            }
-        }
-    }
-
-
 /* -------------------- Seed -------------------- */
 namespace
 {
@@ -1673,603 +1526,6 @@
 }
 
 
-/* -------------------- Magnet -------------------- */
-
-    class Magnet : public Item, public ForceField {
-    private:
-        enum iState {
-            OFF,
-            ON
-        };
-       
-    public:
-        CLONEOBJ(Magnet);
-        DECL_ITEMTRAITS_ARRAY(2, state);
-
-        Magnet(bool isOn);
-        
-        // Object interface
-        virtual std::string getClass() const;
-        virtual void setAttr(const std::string &key, const Value &val);
-        virtual Value message(const Message &m);
-
-        // GridObject interface
-        virtual void on_creation(GridPos p);
-        virtual void on_removal(GridPos p);
-        virtual void init_model();
-
-        // ForceField interface
-        virtual void add_force(Actor *a, V2 &f);
-        
-    private:
-        double correctedStrength;     // 0.6 * strength
-        double squareRange;
-    };
-    
-    Magnet::Magnet(bool isOn) : Item(), correctedStrength (0.6 * 30), squareRange (1000 * 1000) {
-        state = isOn ? ON : OFF;
-    }
-
-    std::string Magnet::getClass() const {
-        return "it_magnet";
-    }
-    
-    void Magnet::setAttr(const std::string &key, const Value &val) {
-        if (key == "range") {
-            double range = (val.getType() == Value::NIL) ? server::MagnetRange : (double)val;
-            squareRange = range * range;
-        } else if (key == "strength") {
-            correctedStrength = 0.6 * ((val.getType() == Value::NIL) ? server::MagnetForce : (double)val);
-        }
-        Item::setAttr(key, val);
-    }
-    
-    Value Magnet::message(const Message &m) {
-        if (m.message == "_updateglobals" && m.value.to_string() == "it_magnet") {
-            if (getAttr("range").getType() == Value::DEFAULT) {
-                squareRange = server::MagnetRange * server::MagnetRange;
-            }
-            if (getAttr("strength").getType() == Value::DEFAULT) {
-                correctedStrength = 0.6 * server::MagnetForce;
-            }
-            return Value();
-        }
-        return Item::message(m);
-    }
-    void Magnet::init_model() {
-        set_model(ecl::strf("it-magnet%s", state == ON ? "-on" : "-off"));
-    }
-    
-    void Magnet::on_creation(GridPos p) {
-        if (getAttr("range").getType() == Value::DEFAULT) {
-            squareRange = server::MagnetRange * server::MagnetRange;
-        }
-        if (getAttr("strength").getType() == Value::DEFAULT) {
-            correctedStrength = 0.6 * server::MagnetForce;
-        }
-
-        AddForceField(this);
-        Item::on_creation(p);
-    }
-    
-    void Magnet::on_removal(GridPos p) {
-        Item::on_removal(p);
-        RemoveForceField(this);
-    }
-    
-    void Magnet::add_force(Actor *a, V2 &f) {
-        if (state == ON) {
-            V2 dv = get_pos().center() - a->get_pos_force();
-            double squareDist = square(dv);
-
-            if (squareDist >= 0.04 && squareDist < squareRange)
-                f += (correctedStrength / squareDist) * dv;
-        }
-    }
-    
-    ItemTraits Magnet::traits[2] = {
-        { "it_magnet_off", it_magnet_off, itf_static | itf_indestructible, 0.0 },
-        { "it_magnet_on",  it_magnet_on,  itf_static | itf_indestructible, 0.0 },
-    };
-
-
-/* -------------------- Wormhole -------------------- */
-
-/** \page it-wormhole Worm hole
-
-Worm holes teleport actors to another place.  They have a variable
-attracting force field.
-
-\subsection wormholea Attributes
-- \b targetx:       X coordinate of the destination
-- \b targety:       Y coordinate of the destination
-- \b strength:      Strength of the force field (default: 50)
-- \b range:         Range of the force field
-
-\subsection wormholee Example
-\verbatim
-set_item("it-wormhole", 1,1, {targetx=5.5, targety=10.5, strength=50, range=5})
-\endverbatim
-*/
-
-
-    class WormHole : public Item, public ForceField, public TimeHandler {
-    private:
-        /**
-         * warping as bit 2 of state
-         */
-        enum iState {
-            OFF_IDLE,        ///< force off, ready to teleport
-            ON_IDLE,         ///< force on,  ready to teleport
-            OFF_ENGAGED,     ///< force off, rejecting teleport
-            ON_ENGAGED       ///< force on,  rejecting teleport
-        };
-        
-    public:
-        CLONEOBJ(WormHole);
-        DECL_ITEMTRAITS_ARRAY(2, state & 1);
-        
-        WormHole(bool isOn);
-        
-        // Object interface
-        virtual std::string getClass() const;
-        virtual void setAttr(const std::string &key, const Value &val);
-        virtual Value message(const Message &m);
-
-        // StateObject interface
-        virtual int externalState() const;
-        virtual void setState(int extState);
-
-        // GridObject interface
-        virtual void on_creation(GridPos p);
-        virtual void on_removal(GridPos p);
-        virtual void init_model();
-        
-        // Item interface
-        virtual bool actor_hit(Actor *a);
-
-        // ForceField interface
-        virtual void add_force(Actor *a, V2 &f);
-        
-        // TimeHandler interface
-        virtual void alarm();
-        
-    private:
-        bool near_center_p(Actor *a);
-
-        double correctedStrength;     ///< 0.6 * strength
-        double squareRange;           ///< range of the force squared
-    };
-
-    WormHole::WormHole(bool isOn) : Item(), correctedStrength (0.6 * 30), squareRange (1000 * 1000) {
-        state = isOn ? ON_IDLE : OFF_IDLE;    // includes warping false
-    }
-    
-    std::string WormHole::getClass() const {
-        return "it_wormhole";
-    }
-    
-    void WormHole::setAttr(const std::string &key, const Value &val) {
-        if (key == "range") {
-            double range = (val.getType() == Value::NIL) ? server::WormholeRange : (double)val;
-            squareRange = range * range;
-        } else if (key == "strength") {
-            correctedStrength = 0.6 * ((val.getType() == Value::NIL) ? server::WormholeForce : (double)val);
-        }
-        Item::setAttr(key, val);
-    }
-    
-    Value WormHole::message(const Message &m) {
-        if (m.message == "_updateglobals" && m.value.to_string() == "it_wormhole") {
-            if (getAttr("range").getType() == Value::DEFAULT) {
-                squareRange = server::WormholeRange * server::WormholeRange;
-            }
-            if (getAttr("strength").getType() == Value::DEFAULT) {
-                correctedStrength = 0.6 * server::WormholeForce;
-            }
-            return Value(); 
-        }
-        return Item::message(m);
-    }
-
-    int WormHole::externalState() const {
-        return state % 2;
-    }
-    
-    void WormHole::setState(int extState) {
-        // switch force on and off
-        if (extState != state % 2) {          // react only on force changes
-            state = (state & ~1) + extState;  // keep other flags
-            if (isDisplayable()) {
-                if (extState == 1)
-                    AddForceField(this);
-                else
-                    RemoveForceField(this);
-            }
-        }
-    }
-    
-    void WormHole::on_creation (GridPos p) {
-        Item::on_creation (p);
-        if (getAttr("range").getType() == Value::DEFAULT) {
-            squareRange = server::WormholeRange * server::WormholeRange;
-        }
-        if (getAttr("strength").getType() == Value::DEFAULT) {
-            correctedStrength = 0.6 * server::WormholeForce;
-        }
-        if (state % 2 == 1)
-            AddForceField(this);
-    }
-
-    void WormHole::on_removal(GridPos p) {
-        GameTimer.remove_alarm(this);
-        state &= ~2;  // remove teleport engaged flag
-        if (state % 2 == 1)
-            RemoveForceField(this);
-        Item::on_removal(p);
-        ASSERT((state & 4) == 0, XLevelRuntime, "Tried to kill a busy wormhole. Please use another way.");
-    }
-    
-    void WormHole::init_model() {
-        if ((state & 3) == ON_IDLE)
-            set_anim("it-wormhole");
-        else
-            set_model("it-wormhole-off");
-    }
-    
-    bool WormHole::actor_hit(Actor *actor) {
-        ASSERT((state & 4) == 0, XLevelRuntime, "WormHole:: Recursion detected!");
-        if ((state & 2) == 0 && near_center_p(actor)) {   // may teleport
-            client::Msg_Sparkle (get_pos().center());
-            V2 targetpos;
-            if (getDestinationByIndex(0, targetpos)) {
-                sound_event ("warp");
-                double latency = getAttr("interval");
-                if(latency > 0) {
-                    state |= 2;  // mark engaged
-                    GameTimer.set_alarm(this, latency, false);
-                    init_model();
-                }
-                state |= 4;  // mark warping
-                bool isScissor = to_bool(getAttr("scissor")) || server::GameCompatibility != GAMET_ENIGMA;
-                if (isScissor)
-                    SendMessage(actor, "disconnect");
-                WarpActor(actor, targetpos[0], targetpos[1], false);
-                state &= ~4; // release warping
-            }
-        }
-        return false;
-    }
-    
-    void WormHole::add_force(Actor *a, V2 &f) {
-        V2 dv = get_pos().center() - a->get_pos_force();
-        double squareDist = square(dv);
-
-        if (squareDist >= 0.025 && squareDist < squareRange)
-            f += (correctedStrength / squareDist) * dv;
-    }
-    
-    void WormHole::alarm() {
-        state &= ~2;  // remove teleport engaged flag
-        init_model();
-    }
-    
-    bool WormHole::near_center_p(Actor *a) {
-        return (square(a->get_pos() - get_pos().center()) < 0.015625);  // 0.125 ^ 2
-    }
-    
-    ItemTraits WormHole::traits[2] = {
-        { "it_wormhole_off", it_wormhole_off, itf_static, 0.0 },
-        { "it_wormhole_on",  it_wormhole_on,  itf_static, 0.0 }
-    };
-
-
-
-/* -------------------- Vortex -------------------- */
-
-/** \page it-vortex Vortex
-
-Vortexes teleport actors to another place.
-
-They may be opened or closed. Is a vortex is closed, the actor cannot enter.
-
-
-\subsection vortexm Messages
-- \b open       opens the vortex
-- \b close      closes the vortex
-- \b trigger, openclose
-- \b signal     signal value: 1 -> "open"; 0 -> "close"
-*/
-
-    class Vortex : public Item, public TimeHandler {
-    private:
-        enum iState {
-            OPEN,          ///< TODO exchange OPEN, CLOSED to match external state 
-            CLOSED,        ///<
-            OPENING,       ///<
-            CLOSING,       ///<
-            WARPING,       ///< an open vortex occupied in process of sending a marble
-            EMITTING,      ///< an open vortex occupied, waiting for the destination to open
-            SWALLOWING     ///< an open vortex eats up a marble
-        };
-
-    public:
-        CLONEOBJ(Vortex);
-        DECL_ITEMTRAITS_ARRAY(2, is_open());
-        
-        Vortex(bool opened);
-        virtual ~Vortex();
-
-        // Object interface
-        virtual std::string getClass() const;
-        virtual Value message(const Message &m);
-
-        // StateObject interface
-        virtual int externalState() const;
-        virtual void setState(int extState);
-        virtual void toggleState();
-
-        // GridObject interface
-        virtual void init_model();
-        virtual void on_removal(GridPos p);
-        
-        // ModelCallback interface
-        virtual void animcb();
-
-        // Item interface
-        virtual bool actor_hit(Actor*);
-
-        // TimeHandler interface
-        virtual void alarm();
-
-    private:
-        void prepare_for_warp(Actor *actor);
-        void emit_actor(Vortex *destVortex);
-
-        void perform_warp();    // warp swallowed actor(s)
-        void warp_to(const V2 &target);
-
-        bool is_open() const { return externalState() == 1 ; }
-
-    };
-
-    ItemTraits Vortex::traits[2] = {
-        {"it_vortex_closed", it_vortex_closed, itf_static | itf_fireproof, 0.0},
-        {"it_vortex_open", it_vortex_open,     itf_static | itf_fireproof, 0.0}
-    };
-
-    Vortex::Vortex(bool open) : Item() {
-        state = open ? OPEN : CLOSED;
-        setAttr("$dest_idx", 0);
-        setAttr("$dest_vortex", (Object *)NULL);
-        setAttr("$grabbed_actor", (Object *)NULL);
-    }
-
-    Vortex::~Vortex() {
-        GameTimer.remove_alarm(this);
-        if (Actor *actor = dynamic_cast<Actor *>((Object *)getAttr("$grabbed_actor"))) {
-            // release an actor that is grabbed on behalf of this vortex - actor state FALLING_VORTEX
-            SendMessage(actor, "rise");
-        }
-    }
-
-    std::string Vortex::getClass() const {
-        return "it_vortex";
-    }
-    
-    Value Vortex::message(const Message &m) {
-        if (m.message == "_passed" && getAttr("autoclose").to_bool()) {
-            setState(0);
-            performAction(getAttr("$grabbed_actor"));
-            return Value();
-        }
-        return Item::message(m);
-    }
-
-    int Vortex::externalState() const {
-        return (state >= CLOSED && state <= CLOSING) ? 0 : 1 ;
-    }
-    
-    void Vortex::setState(int extState) {
-        if (isDisplayable()) {
-            if (extState == 1) {  // open
-                if (state == CLOSING) {
-                    state = OPENING;
-                    get_model()->reverse(); // reverse animation
-                }
-                else if (state == CLOSED) {
-                    state = OPENING;
-                    sound_event ("vortexopen");
-                    init_model();
-                }
-            } else if (extState == 0) { // close
-                if (state == OPENING) {
-                    state = CLOSING;
-                    get_model()->reverse(); // reverse animation
-                }
-                else if (state == OPEN) {
-                    state = CLOSING;
-                    sound_event ("vortexclose");
-                    init_model();
-                }
-            }
-        } else {
-            if (extState <= 1 && extState >= 0)
-                state = 1 - extState;
-        }
-    }
-        
-    void Vortex::toggleState() {
-        if (state == OPEN || state == OPENING)
-            setState(0);
-        else
-            setState(1);
-    }
-    
-    void Vortex::init_model() {
-        switch(state) {
-            case WARPING:
-            case OPEN:
-            case EMITTING:
-            case SWALLOWING:
-                set_model("it-vortex-open");
-                break;
-            case CLOSED: 
-                set_model("it-vortex-closed"); break;
-            case OPENING: 
-                set_anim("it-vortex-opening"); break;
-            case CLOSING: 
-                set_anim("it-vortex-closing"); break;
-        }
-    }
-    
-    void Vortex::on_removal(GridPos p) {
-        Item::on_removal(p);
-        ASSERT(state != WARPING && state != SWALLOWING && state != EMITTING,
-            XLevelRuntime, "Tried to kill a busy vortex. Please use another way.");
-    }
-    
-    void Vortex::animcb() {
-        if (state == CLOSING) {
-            state = CLOSED;
-            init_model();
-        }
-        else if (state == OPENING) {
-            state = OPEN;
-            init_model();
-        }
-    }
-    
-    bool Vortex::actor_hit (Actor *actor) {
-        if (state == OPEN && (length((actor->get_pos()) - get_pos().center()) < 0.25) && actor->can_be_warped())
-            prepare_for_warp (actor);
-        return false;
-    }
-    
-    void Vortex::alarm() {
-        if (state == WARPING) {
-            perform_warp();
-        } else if (state == EMITTING) {
-            emit_actor(dynamic_cast<Vortex *>((Object *)getAttr("$dest_vortex")));
-        } else if (state == SWALLOWING) {
-            state = WARPING;
-            sound_event ("hitfloor");
-            perform_warp();
-        } else
-            ASSERT (0, XLevelRuntime, "Vortex: alarm called with inconsistent state");
-    }
-    
-    void Vortex::prepare_for_warp (Actor *actor) {
-        SendMessage(actor, "fallvortex");
-        setAttr("$dest_idx", 0);
-        setAttr("$grabbed_actor", actor);
-        state = SWALLOWING;
-    
-        GameTimer.set_alarm(this, 0.4, false);
-    }
-    
-    void Vortex::emit_actor(Vortex *destVortex) {
-        if (destVortex == NULL)   // destination vortex got killed in meantime
-            destVortex = this;    // reemit from source vortex 
-        V2 v(destVortex->get_pos().center());
-        if (Actor *actor = dynamic_cast<Actor *>((Object *)getAttr("$grabbed_actor"))) {
-            WarpActor(actor, v[0], v[1], false);
-            SendMessage(actor, "rise");
-            if (destVortex != this) {
-                bool isScissor = to_bool(getDefaultedAttr("scissor", 
-                        (server::EnigmaCompatibility >= 1.10) || server::GameCompatibility != GAMET_ENIGMA));
-                if (isScissor)
-                    SendMessage(actor, "disconnect");
-            }
-        }
-        state = OPEN;
-        if (this != destVortex && getAttr("autoclose").to_bool())  // do not close source vortex if destination is currently blocked
-            setState(0);
-        if (this != destVortex)
-            performAction(getAttr("$grabbed_actor"));
-    
-        setAttr("$grabbed_actor", (Object *)NULL);
-    }
-
-    void Vortex::warp_to(const V2 &target) {
-        client::Msg_Sparkle (target);
-        if (Actor *actor = dynamic_cast<Actor *>((Object *)getAttr("$grabbed_actor"))) {
-            WarpActor(actor, target[0], target[1], false);
-            SendMessage(actor, "appear");
-            bool isScissor = to_bool(getDefaultedAttr("scissor", 
-                    (server::EnigmaCompatibility >= 1.10) || server::GameCompatibility != GAMET_ENIGMA));
-            if (isScissor)
-                SendMessage(actor, "disconnect");
-        }
-        state = OPEN;
-        if (getAttr("autoclose").to_bool())
-            setState(0);
-    
-        performAction(getAttr("$grabbed_actor"));
-        setAttr("$grabbed_actor", (Object *)NULL);
-    }
-
-    void Vortex::perform_warp() {
-        Actor *actor = dynamic_cast<Actor *>((Object *)getAttr("$grabbed_actor"));
-        if (actor == NULL)
-            return;
-    
-        ASSERT (state == WARPING, XLevelRuntime, "Vortex: perform_warp called with inconsistent state");
-    
-        V2 v_target;
-    
-        // is another target position defined?
-        int dest_idx = getAttr("$dest_idx");
-        if (Object::getDestinationByIndex(dest_idx, v_target)) {
-            GridPos  p_target(v_target);
-    
-            Vortex *v = dynamic_cast<Vortex*>(GetItem(p_target));
-    
-            if (v) {                // Destination is also a vortex
-                Stone *st = GetStone(p_target);
-    
-                if (st && st->is_sticky(actor)) {
-                    // is destination vortex blocked? redirect
-                    setAttr("$dest_idx", dest_idx + 1);
-                    client::Msg_Sparkle(v_target);
-                    WarpActor(actor, v_target[0], v_target[1], false);
-                    GameTimer.set_alarm(this, 0.4, false);
-                }
-                else {
-                    switch (v->state) {
-                        case OPEN:
-                        case OPENING:
-                            // destination is open
-                            emit_actor(v);
-                            break;
-        
-                        case CLOSED:
-                        case CLOSING:
-                            // destination is closed
-                            SendMessage(v, "open");
-                            setAttr("$dest_vortex", v);
-                            state = EMITTING;
-                            GameTimer.set_alarm(this, 0.4, false);
-                            break;
-                        case SWALLOWING:
-                        case WARPING:
-                        case EMITTING:
-                            // destination is busy -> don't warp actor, emit
-                            // it where it has started
-                            emit_actor(this);
-                    }
-                }
-            } else {
-                warp_to(v_target);
-            }
-        }
-        else {
-            // if no target defined, don't warp actor
-            emit_actor(this);
-        }
-    }
-
-
 /* -------------------- YinYang item -------------------- */
 namespace
 {
@@ -2841,117 +2097,6 @@
 }
 
 
-/* -------------------- Sensors -------------------- */
-
-
-/* Basically behave like regular triggers, but they are invisible and can be
-   activated only once. */
-    class Sensor : public Item {
-        CLONEOBJ(Sensor);
-        DECL_ITEMTRAITS_ARRAY(4, traitsIdx());
-    private:
-        enum ObjectPrivatFlagsBits {
-            OBJBIT_ISFILTER  =   1<<24    ///< sensor that filters signals, too
-        };
-    public:
-        static void setup();
-            
-        Sensor(bool inverse, bool isFilter = false);
-        
-        // Object interface
-        virtual Value message(const Message &m);
-        
-        // StateObject interface
-        virtual void setAttr(const string& key, const Value &val);
-        
-        // GridObject interface
-        virtual void init_model();
-
-        // ModelCallback interface
-        virtual void animcb();
-
-        // Item interface
-        virtual void actor_enter(Actor *a);
-    
-    private:
-        int traitsIdx() const;
-    };
-    
-    void Sensor::setup() {
-        RegisterItem(new Sensor(false));
-        RegisterItem(new Sensor(true));
-        RegisterItem(new Sensor(true, true));
-        RegisterItem(new Sensor(false, true));
-    }
-    
-    Sensor::Sensor(bool inverse, bool isFilter) {
-        Object::setAttr("inverse", inverse);
-        if (isFilter) {
-            objFlags |= OBJBIT_ISFILTER;
-            Item::setAttr("invisible", true);
-        }
-    }
-    
-    Value Sensor::message(const Message &m) {
-        if (m.message == "_hit") {   // door knocking forward to black/whitballstone
-            setAttr("$hitactor", m.value);
-            performAction(true);
-            setAttr("$hitactor", (Object *)NULL);
-            return Value();
-        } else if (m.message == "_hitactor") {
-            return getAttr("$hitactor");
-        } else if (m.message == "_glasses") {
-            if (isDisplayable())
-                init_model();            
-        } else if (m.message == "signal" && (objFlags & OBJBIT_ISFILTER)) {
-            if (m.value == 1)
-                performAction(true);   // invertion done by Object
-            return Value();
-        }
-        return Item::message(m);
-    }
-    
-    void Sensor::setAttr(const string& key, const Value &val) {
-        if (key == "invisible") {
-            Item::setAttr(key, val);
-            if (isDisplayable())
-                init_model();
-            return;
-        }
-        Item::setAttr(key, val);
-    }
-    
-    void Sensor::init_model() {
-        if (getAttr("invisible").to_bool() && ((server::GlassesVisibility & Glasses::SENSOR) == 0))
-            set_model("invisible");
-        else
-            set_model("it_sensor");
-    }
-
-    void Sensor::animcb() {
-        init_model();
-    }
-
-    void Sensor::actor_enter(Actor *) {
-        if (!getAttr("invisible").to_bool())
-            set_anim("it_sensor_hit");
-        performAction(true);
-    }
-    
-    int Sensor::traitsIdx() const {
-        int idx = getAttr("inverse").to_bool() ? 1 : 0;
-        if (objFlags & OBJBIT_ISFILTER)
-            idx +=2;
-        return idx;
-    }
-
-    ItemTraits Sensor::traits[4] = {
-        {"it_sensor",  it_sensor,  itf_static}, 
-        {"it_sensor_inverse",  it_inversesensor,  itf_static},
-        {"it_sensor_filter1", it_signalfilter1, itf_static | itf_invisible, 0.0},  // DAT only
-        {"it_sensor_filter0", it_signalfilter0, itf_static | itf_invisible, 0.0}   // DAT only
-    };
-
 /* -------------------- EasyKillStone -------------------- */
 
 /*
@@ -3433,148 +2578,6 @@
     
     DEF_ITEMTRAITSF(DeathItem, "it_death", it_death, itf_static | itf_indestructible);
 
-/* -------------------- Strip Items  -------------------- */
-    class StripItem : public Item {
-        CLONEOBJ(StripItem);
-        DECL_ITEMTRAITS_ARRAY(16, traitsIdx());
-        
-    public:
-        static void setup();
-                
-        StripItem(std::string connections);
-        
-        // Object interface
-        virtual std::string getClass() const;
-
-        // StateObject interface
-        virtual void setState(int extState);
-        
-        // GridObject interface
-        virtual std::string getModelName() const;
-        virtual void init_model();
-                
-        // Items interface
-        virtual bool covers_floor(ecl::V2 pos, Actor *a) const;
-        virtual double getFriction(ecl::V2 pos, double defaultFriction, Actor *a);
-        virtual ecl::V2 calcMouseforce(Actor *a, ecl::V2 mouseForce, ecl::V2 floorForce);
-        
-    private:
-        int traitsIdx() const;
-    };
-    
-    
-    void StripItem::setup() {
-        RegisterItem(new StripItem(""));
-        RegisterItem(new StripItem("w"));
-        RegisterItem(new StripItem("s"));
-        RegisterItem(new StripItem("sw"));
-        RegisterItem(new StripItem("e"));
-        RegisterItem(new StripItem("ew"));
-        RegisterItem(new StripItem("es"));
-        RegisterItem(new StripItem("esw"));
-        RegisterItem(new StripItem("n"));
-        RegisterItem(new StripItem("nw"));
-        RegisterItem(new StripItem("ns"));
-        RegisterItem(new StripItem("nsw"));
-        RegisterItem(new StripItem("ne"));
-        RegisterItem(new StripItem("new"));
-        RegisterItem(new StripItem("nes"));
-        RegisterItem(new StripItem("nesw"));
-    }
-    
-    StripItem::StripItem(std::string connections) {
-        setAttr("connections", connections);
-    }
-        
-    std::string StripItem::getClass() const {
-        return "it_strip";
-    }
-    
-    void StripItem::setState(int extState) {
-        // block state set
-    }
-    
-    std::string StripItem::getModelName() const {
-        return getClass();
-    }
-    
-    void StripItem::init_model() {
-        // need to bypass Item's implementation
-        GridObject::init_model();
-    }
-
-    bool StripItem::covers_floor(ecl::V2 pos, Actor *a) const {
-        if (GridPos(pos) != get_pos())
-            return false;
-
-        double velocity = 0;
-        if (a != NULL) 
-            velocity = ecl::length(a->get_actorinfo()->vel);
-            
-        // calculate the maximal horizontal or vertical distance from the center:
-        // gurantee that a large marble can touch a neighboring stone at speed 0,
-        // and a fast marble does not step off the strip on hitting a neighbor stone.
-        // A fast marble might not reach the stone in one timestep while being
-        // on top of the strip and is afterwards moved forward off the strip.
-        // Thus we must expand the strip with increasing speed of the actor - call
-        // it a relativistic effect :-)
-        // d = 1/2 - 19/64 - 0.02 + velocity/400 
-        //  = 1/2 - radius large marble - epsilon + velocity/(1/2.5 ms)
-        // we need to limit the speed to avoid a fast marble traversing the gap in
-        // two timesteps! 
-        double MAXDIST = 0.183125 + ecl::Clamp(velocity/400, 0.0, 0.125);
-        
-        double ycenter = get_pos().y + 0.5;
-        double xcenter = get_pos().x + 0.5;
-        DirectionBits cbits = getConnections();
-        
-        return (((fabs(pos[1] - ycenter) <= MAXDIST) && ((fabs(pos[0] - xcenter) <= MAXDIST)  ||
-                   ((pos[0] <= xcenter + MAXDIST) && (cbits & WESTBIT)) || ((pos[0] >= xcenter - MAXDIST) && (cbits & EASTBIT))))
-                || ((fabs(pos[0] - xcenter) <= MAXDIST) 
-                && (((pos[1] <= ycenter + MAXDIST) && (cbits & NORTHBIT)) || ((pos[1] >= ycenter - MAXDIST) && (cbits & SOUTHBIT)))))
-                ? true : false;
-    }
-    
-    double StripItem::getFriction(ecl::V2 pos, double defaultFriction, Actor *a) {
-        Value v = getAttr("friction");
-        if (v && covers_floor(pos, a))
-            return v;
-        else
-            return defaultFriction;
-    }
-    
-    ecl::V2 StripItem::calcMouseforce(Actor *a, ecl::V2 mouseForce, ecl::V2 floorForce) {
-        Value v = getAttr("adhesion");
-        if (v && covers_floor(a->get_pos(), a))
-            return mouseForce * (double)v ;
-        else
-            return floorForce;        
-    }
-        
-    int StripItem::traitsIdx() const {
-        return getConnections();
-    }
-
-    ItemTraits StripItem::traits[16] = {
-        {"it_strip",  it_strip,  itf_static},
-        {"it_strip_w",  it_strip_w,  itf_static},
-        {"it_strip_s",  it_strip_s,  itf_static},
-        {"it_strip_sw",  it_strip_sw,  itf_static},
-        {"it_strip_e",  it_strip_e,  itf_static},
-        {"it_strip_ew",  it_strip_ew,  itf_static},
-        {"it_strip_es",  it_strip_es,  itf_static},
-        {"it_strip_esw",  it_strip_esw,  itf_static},
-        {"it_strip_n",  it_strip_n,  itf_static},
-        {"it_strip_nw",  it_strip_nw,  itf_static},
-        {"it_strip_ns",  it_strip_ns,  itf_static},
-        {"it_strip_nsw",  it_strip_nsw,  itf_static},
-        {"it_strip_ne",  it_strip_ne,  itf_static},
-        {"it_strip_new",  it_strip_new,  itf_static},
-        {"it_strip_nes",  it_strip_nes,  itf_static},
-        {"it_strip_nesw",  it_strip_nesw,  itf_static}
-    };
-
-
 /* -------------------- it-surprise -------------------- */
 namespace
 {
@@ -3828,9 +2831,6 @@
     RegisterItem (new Key);
     RegisterItem (new Landmine);
     RegisterItem (new MagicWand);
-    Register ("it_magnet", new Magnet(false));
-    RegisterItem (new Magnet(true));
-    RegisterItem (new Magnet(false));
     RegisterItem (new Odometer);
     RegisterItem (new OnePKillStone);
     RegisterItem (new OxydBridge);
@@ -3844,32 +2844,23 @@
     RegisterItem (new SeedWood);
     RegisterItem (new SeedNowood);
     RegisterItem (new SeedVolcano);
-    Sensor::setup();
     RegisterItem (new Spade);
     RegisterItem (new Spoon);
     RegisterItem (new Spring1);
     RegisterItem (new Spring2);
     RegisterItem (new Springboard);
     RegisterItem (new Squashed);
-    StripItem::setup();
     RegisterItem (new SurpriseItem);
     RegisterItem (new Sword(false));
     Register ("it_sword_new", new Sword(true));
     RegisterItem (new TinyHill);
     RegisterItem (new TinyHollow);
-    RegisterItem (new Trigger);
     RegisterItem (new TwoPKillStone);
     RegisterItem (new Umbrella(false));
     Register ("it_umbrella_new", new Umbrella(true));
-    Register ("it_vortex", new Vortex(true));
-    RegisterItem (new Vortex(false));
-    RegisterItem (new Vortex(true));
     RegisterItem (new Weight);
     RegisterItem (new WhiteBomb);
     RegisterItem (new Wrench);
-    RegisterItem (new WormHole(false));
-    RegisterItem (new WormHole(true));
-    Register ("it_wormhole", new WormHole(true));
     RegisterItem (new YinYang);
 }
 



From ral at mail.berlios.de  Sun Aug 17 15:06:52 2008
From: ral at mail.berlios.de (ral at BerliOS)
Date: Sun, 17 Aug 2008 15:06:52 +0200
Subject: [Enigma-game-svn] r1274 - in trunk: data data/schemas src/items
	src/stones
Message-ID: <200808171306.m7HD6qk0011150@sheep.berlios.de>

Author: ral
Date: 2008-08-17 15:06:51 +0200 (Sun, 17 Aug 2008)
New Revision: 1274

Modified:
   trunk/data/api2init.lua
   trunk/data/schemas/objects.xml
   trunk/src/items/ShogunDot.cc
   trunk/src/items/ShogunDot.hh
   trunk/src/stones/ShogunStone.cc
   trunk/src/stones/ShogunStone.hh
Log:
Trunk 1.1: new API reengineering
- shogun:
  - usage of "flavor" attribute instead of "state", values "s",.."sml"
  - usage of "state" attribute for shogun dot state (read only)
  - adjust shogun item hit behaviour for oxyd*


Modified: trunk/data/api2init.lua
===================================================================
--- trunk/data/api2init.lua	2008-08-16 23:21:54 UTC (rev 1273)
+++ trunk/data/api2init.lua	2008-08-17 13:06:51 UTC (rev 1274)
@@ -131,11 +131,6 @@
 SPOT_LIGHTPASSENGER =  16
 SPOT_TRAP           =  32
 
--- shogun
-SHOGUN_S =  4
-SHOGUN_M =  8
-SHOGUN_L = 16
-
 -- follower
 FOLLOW_NO     = 0
 FOLLOW_SCROLL = 1

Modified: trunk/data/schemas/objects.xml
===================================================================
--- trunk/data/schemas/objects.xml	2008-08-16 23:21:54 UTC (rev 1273)
+++ trunk/data/schemas/objects.xml	2008-08-17 13:06:51 UTC (rev 1274)
@@ -173,18 +173,18 @@
       <msg name="_hit"/>
     </object>
     <object name="it_shogun">
-      <attr name="state" max="16" default="4"/>
+      <attr name="flavor"/>
       <msg name="_shogun"/>
       <msg name="_init"/>
     </object>
     <object name="it_shogun_s">
-      <attr name="state" value="4"/>
+      <attr name="flavor" value="s"/>
     </object>
     <object name="it_shogun_m">
-      <attr name="state" value="8"/>
+      <attr name="flavor" value="m"/>
     </object>
     <object name="it_shogun_l">
-      <attr name="state" value="16"/>
+      <attr name="flavor" value="l"/>
     </object>
     <object name="it_rubberband">
       <attr name="anchor2"/>
@@ -716,31 +716,31 @@
       <msg name="_init"/>
     </object>
     <object name="st_shogun">
+      <attr name="flavor"/>
       <attr name="name_m"/>
       <attr name="name_s"/>
-      <attr name="state" max="16" default="4"/>
       <msg name="_shogun"/>
     </object>
     <object name="st_shogun_s">
-      <attr name="state" value="4"/>
+      <attr name="flavor" value="s"/>
     </object>
     <object name="st_shogun_m">
-      <attr name="state" value="8"/>
+      <attr name="flavor" value="m"/>
     </object>
     <object name="st_shogun_sm">
-      <attr name="state" value="12"/>
+      <attr name="flavor" value="sm"/>
     </object>
     <object name="st_shogun_l">
-      <attr name="state" value="16"/>
+      <attr name="flavor" value="l"/>
     </object>
     <object name="st_shogun_sl">
-      <attr name="state" value="20"/>
+      <attr name="flavor" value="sl"/>
     </object>
     <object name="st_shogun_ml">
-      <attr name="state" value="24"/>
+      <attr name="flavor" value="ml"/>
     </object>
     <object name="st_shogun_sml">
-      <attr name="state" value="28"/>
+      <attr name="flavor" value="sml"/>
     </object>
     <object name="st_switch">
       <attr name="color"/>

Modified: trunk/src/items/ShogunDot.cc
===================================================================
--- trunk/src/items/ShogunDot.cc	2008-08-16 23:21:54 UTC (rev 1273)
+++ trunk/src/items/ShogunDot.cc	2008-08-17 13:06:51 UTC (rev 1274)
@@ -25,28 +25,59 @@
 
 namespace enigma {
 
-    ShogunDot::ShogunDot(int initState) {
-        state = initState;
+    ShogunDot::ShogunDot(int holes) {
+        objFlags |= holes << 24;
     }
 
     std::string ShogunDot::getClass() const {
         return "it_shogun";
     }
     
+    void ShogunDot::setAttr(const string& key, const Value &val) {
+        if (key == "flavor") {
+            std::string flavor = val.to_string();
+            int holes = 0;
+            if (flavor == "s")
+                holes = ShogunStone::S;
+            else if (flavor == "m")
+                holes = ShogunStone::M;
+            else if (flavor == "l")
+                holes = ShogunStone::L;
+            else
+                ASSERT(false, XLevelRuntime, ecl::strf("ShogunDot: illegal 'flavor' of '%s'", flavor.c_str()).c_str());
+            objFlags &= ~OBJBIT_HOLES;
+            objFlags |= holes << 24;
+            if (isDisplayable()) {
+                init_model();
+                state = SendMessage(GetStone(get_pos()), "_shogun", requiredShogunHoles()).to_bool() ? ON : OFF;
+                // no action is performed due to snapshot principle 
+            }
+            return;
+        }
+        Item::setAttr(key, val);
+    }
+    
+    Value ShogunDot::getAttr(const string &key) const {
+        if (key == "flavor") {
+            int holes = getHoles();
+            return holes == ShogunStone::L ? "l" : (state == ShogunStone::M ? "m" : "s");
+        } else
+            return Item::getAttr(key);
+    }
+    
     Value ShogunDot::message(const Message &m) {
         if (m.message =="_init" ) {
-            if (SendMessage(GetStone(get_pos()), "_shogun", (state/2 -1)*4).to_bool()) {
-                objFlags |= OBJBIT_ACTIVE;
-                if (server::EnigmaCompatibility < 1.10)
-                    performAction(true);
+            state = (SendMessage(GetStone(get_pos()), "_shogun", requiredShogunHoles()).to_bool()) ? ON : OFF;
+            if (server::EnigmaCompatibility < 1.10 && state == ON) {
+                performAction(true);
             }
         } else if (m.message =="_shogun" && server::WorldInitialized) {
-            if (!(objFlags & OBJBIT_ACTIVE) && ((state/2 -1)*4 == (int)m.value)) {  // shoguns s, sm, sml for dots s, m, l
+            if (state == OFF && (requiredShogunHoles() == (int)m.value)) {  
+                state = ON;
                 performAction(true);
-                objFlags |= OBJBIT_ACTIVE;
-            } else if ((objFlags & OBJBIT_ACTIVE) && ((state/2 -1)*4 != (int)m.value)) {  // shoguns s, sm, sml for dots s, m, l
+            } else if (state == ON && (requiredShogunHoles() != (int)m.value)) {
+                state = OFF;
                 performAction(false);
-                objFlags &= ~OBJBIT_ACTIVE;
             }
             return Value();
         }
@@ -54,22 +85,28 @@
     }
     
     void ShogunDot::setState(int extState) {
-        ASSERT(extState == 16 || extState == 8 || extState == 4, XLevelRuntime,"");
-        state = extState;
-        if (isDisplayable()) {
-            init_model();
-        }
+        // deny any write access 
     }
     
     void ShogunDot::on_creation(GridPos p) {
         if (server::WorldInitialized &&
-                SendMessage(GetStone(get_pos()), "_shogun", (state/2 -1)*4).to_bool())
-            objFlags |= OBJBIT_ACTIVE;
+                SendMessage(GetStone(get_pos()), "_shogun", requiredShogunHoles()).to_bool())
+            state = ON;
         Item::on_creation(p);
     }
     
+    int ShogunDot::getHoles() const {
+        return (objFlags & OBJBIT_HOLES) >> 24;
+    }
+    
+    int ShogunDot::requiredShogunHoles() const {  // currently shoguns s, sm, sml for dots s, m, l
+        static int smallestHole = ShogunStone::S;
+        return (getHoles()/smallestHole * 2 - 1) * smallestHole;
+    }
+    
     int ShogunDot::traitsIdx() const {
-        return state == 16 ? 2 : (state == 8 ? 1 : 0);
+        int holes = getHoles();
+        return holes == ShogunStone::L ? 2 : (holes == ShogunStone::M ? 1 : 0);
     }
     
 

Modified: trunk/src/items/ShogunDot.hh
===================================================================
--- trunk/src/items/ShogunDot.hh	2008-08-16 23:21:54 UTC (rev 1273)
+++ trunk/src/items/ShogunDot.hh	2008-08-17 13:06:51 UTC (rev 1274)
@@ -31,14 +31,21 @@
         DECL_ITEMTRAITS_ARRAY(3, traitsIdx());
 
     private:
+        enum iState {
+            OFF,     ///< inactive, no matching shogun stack on top
+            ON       ///< active, matching shogun stack on top
+        };
+        
         enum ObjectPrivatFlagsBits {
-            OBJBIT_ACTIVE =   1<<24,   ///< 
+            OBJBIT_HOLES =   127<<24,   ///< holes as defined in stones/ShogunStone.hh
         };
     public:
-        ShogunDot(int initState);
+        ShogunDot(int holes);
 
         // Object interface
         virtual std::string getClass() const;
+        virtual void setAttr(const string& key, const Value &val);
+        virtual Value getAttr(const std::string &key) const;
         virtual Value message(const Message &m);
 
         // GridObject interface
@@ -48,6 +55,8 @@
         virtual void setState(int extState);
 
     private:
+        int getHoles() const;
+        int requiredShogunHoles() const;
         int traitsIdx() const;
     };
     

Modified: trunk/src/stones/ShogunStone.cc
===================================================================
--- trunk/src/stones/ShogunStone.cc	2008-08-16 23:21:54 UTC (rev 1273)
+++ trunk/src/stones/ShogunStone.cc	2008-08-17 13:06:51 UTC (rev 1274)
@@ -24,8 +24,8 @@
 #include "world.hh"
 
 namespace enigma {
-    ShogunStone::ShogunStone(int initState) : Stone () {
-        state = initState;
+    ShogunStone::ShogunStone(int holes) : Stone () {
+        objFlags |= holes << 24;
     }
     
     ShogunStone* ShogunStone::clone() {
@@ -46,6 +46,41 @@
         return "st_shogun";
     }
     
+    void ShogunStone::setAttr(const string& key, const Value &val) {
+        if (key == "flavor") {
+            ASSERT(!isDisplayable(), XLevelRuntime, "ShogunStone: attempt to reflavor an existing shogun");
+            std::string flavor = val.to_string();
+            int holes = 0;
+            if (flavor.find('n') != std::string::npos)  holes += ShogunStone::N;
+            if (flavor.find('t') != std::string::npos)  holes += ShogunStone::T;
+            if (flavor.find('s') != std::string::npos)  holes += ShogunStone::S;
+            if (flavor.find('m') != std::string::npos)  holes += ShogunStone::M;
+            if (flavor.find('l') != std::string::npos)  holes += ShogunStone::L;
+            if (flavor.find('g') != std::string::npos)  holes += ShogunStone::G;
+            if (flavor.find('u') != std::string::npos)  holes += ShogunStone::U;
+            ASSERT(holes != 0, XLevelRuntime, ecl::strf("ShogunStone: illegal 'flavor' of '%s'", flavor.c_str()).c_str());
+            objFlags &= ~OBJBIT_HOLES;
+            objFlags |= holes << 24;
+            return;
+        }
+        Stone::setAttr(key, val);
+    }
+    
+    Value ShogunStone::getAttr(const string &key) const {
+        if (key == "flavor") {
+            std::string result;
+            int holes = getHoles();
+            if (holes & ShogunStone::N) result += "n";
+            if (holes & ShogunStone::T) result += "t";
+            if (holes & ShogunStone::S) result += "s";
+            if (holes & ShogunStone::M) result += "m";
+            if (holes & ShogunStone::L) result += "l";
+            if (holes & ShogunStone::G) result += "g";
+            if (holes & ShogunStone::U) result += "u";
+            return result;
+        } else
+            return Stone::getAttr(key);
+    }
     Value ShogunStone::message(const Message &m) {
         if (m.message == "kill") {
             if (yieldShogun()) {
@@ -54,18 +89,17 @@
             }
             return Value();
         } else if (m.message =="_shogun") {
-            return m.value == state;
+            return m.value == getHoles();
         }
             return Stone::message(m);
     }
 
     void ShogunStone::setState(int extState) {
-        if (!isDisplayable())
-            Stone::setState(extState & 28);   // just not yet set shoguns with legal values
+        // reject any write attempts
     }
     
     void ShogunStone::init_model() {
-        set_model(ecl::strf("st-shogun%d", state/4));
+        set_model(ecl::strf("st-shogun%d", getHoles()/S));
     }
     
     void ShogunStone::setOwnerPos(GridPos po) {
@@ -79,20 +113,20 @@
         if (subShogun != NULL)
             // swap or pull based new grid positioning of a shogun stack
             subShogun->setOwnerPos(p);
-        else if (state != ownHole()) {
+        else if (getHoles() != ownHole()) {
             // initial set of a new shogun stack
-            int subState = state & ~ownHole();
-            if (subState & 8) {
+            int subHoles = getHoles() & ~ownHole();
+            if (subHoles & M) {
                 ShogunStone *s = dynamic_cast<ShogunStone *>(MakeObject("st_shogun_m"));
                 subShogun = s;
                 s->superShogun = this;
                 s->setOwnerPos(p);
-                s->state = subState;
-                subState &= ~8;
+                s->addSubHoles(subHoles);
+                subHoles &= ~M;
                 if (Value v = getAttr("name_m"))
                     NameObject(s, v.to_string());
             }
-            if (subState & 4) {
+            if (subHoles & S) {
                 ShogunStone *s = dynamic_cast<ShogunStone *>(MakeObject("st_shogun_s"));
                 if (subShogun == NULL) {
                     subShogun = s;
@@ -106,7 +140,7 @@
                 s->setOwnerPos(p);
             }
         }
-        SendMessage(GetItem(p), "_shogun", state);
+        SendMessage(GetItem(p), "_shogun", getHoles());
     }
     
     void ShogunStone::on_removal(GridPos p) {
@@ -130,7 +164,7 @@
         if (st != NULL) {
             nss = dynamic_cast<ShogunStone *>(st);
             if (nss != NULL)
-                fitsNeighborShogun = (nss->state & (2*ownHole() -1)) == 0;
+                fitsNeighborShogun = (nss->getHoles() & (2*ownHole() -1)) == 0;
         }
         
         if ((st == NULL) || fitsNeighborShogun) {  // can we move?
@@ -143,33 +177,63 @@
             // then put to new position
             if (st == NULL) {
                 SetStone(newPos, this);
-                SendMessage(GetItem(newPos), "_shogun", state);
+                SendMessage(GetItem(newPos), "_shogun", getHoles());
             } else {
                 // register our hole to all super shoguns
                 ShogunStone *s = nss;
                 for (; s->subShogun != NULL; s = s->subShogun) {
-                    s->state |= ownHole();
+                    s->addSubHoles(ownHole());
                 }
                 // register ourself to smallest shogun
-                s->state |= ownHole();
+                s->addSubHoles(ownHole());
                 s->subShogun = this;
                 superShogun = s;
 
                 nss->init_model();     // display new hole         
-                SendMessage(GetItem(newPos), "_shogun", nss->state);
+                SendMessage(GetItem(newPos), "_shogun", nss->getHoles());
                 setOwnerPos(newPos);   // the stone is owned at the new position
             }
             
             server::IncMoveCounter();
             ShatterActorsInsideField(newPos);
+            if (server::GameCompatibility != GAMET_ENIGMA) {
+                if (Item *it = GetItem(newPos)) {
+                    ItemID id = get_id(it);
+                    if ((server::GameCompatibility != GAMET_OXYD1 && server::GameCompatibility != GAMET_OXYDMAGNUM) ||
+                            (id != it_cherry && id != it_blackbomb && id != it_whitebomb))
+                        it->on_stonehit(this);
+                }
+            }
         }
         propagateImpulse(impulse);
     }
     
-    int ShogunStone::ownHole() {
-        return (state >= 16) ? 16 : ((state >= 8) ? 8 : 4);
+    int ShogunStone::getHoles() const {
+        return (objFlags & OBJBIT_HOLES) >> 24;
     }
     
+    int ShogunStone::ownHole() const {
+        int holes = getHoles();
+        for (int check = ShogunStone::U; check > 0; check = check >> 1)
+            if (holes & check)
+                return check;
+        ASSERT(false, XLevelRuntime, "ShogunStone: internal error - no holes");
+    }
+    
+    void ShogunStone::addSubHoles(int holes) {
+        objFlags |= holes <<24;
+    }
+    
+    void ShogunStone::removeSubHoles(int holes) {
+        objFlags &= ~(holes <<24);
+    }
+    
+    void ShogunStone::removeAllSubHoles() {
+        int hole = ownHole();
+        objFlags &= ~OBJBIT_HOLES;
+        objFlags |= hole <<24;
+    }
+    
     bool ShogunStone::yieldShogun() {
         if (isDisplayable() && subShogun == NULL) {
             YieldStone(get_pos());
@@ -180,9 +244,9 @@
             YieldStone(oldPos);
             subShogun->superShogun = NULL;
             SetStone(oldPos, subShogun);
-            SendMessage(GetItem(oldPos), "_shogun", subShogun->state);
+            SendMessage(GetItem(oldPos), "_shogun", subShogun->getHoles());
             subShogun = NULL;
-            state = ownHole();
+            removeAllSubHoles();
         } else {
             // a sub shogun
             ShogunStone *oss = dynamic_cast<ShogunStone *>(GetStone(getOwnerPos()));
@@ -191,24 +255,24 @@
             
             ASSERT(superShogun != NULL, XLevelRuntime, "Shogun: missing super shogun");
             superShogun->subShogun = subShogun;
-            superShogun->state &= ~ownHole();
+            superShogun->removeSubHoles(ownHole());
             if (ShogunStone *superSuperShogun = superShogun->superShogun) {
-                superSuperShogun->state &= ~ownHole();
+                superSuperShogun->removeSubHoles(ownHole());
                 superSuperShogun->init_model();
-                SendMessage(GetItem(getOwnerPos()), "_shogun", superSuperShogun->state);
+                SendMessage(GetItem(getOwnerPos()), "_shogun", superSuperShogun->getHoles());
             } else
                 superShogun->init_model();
-                SendMessage(GetItem(getOwnerPos()), "_shogun", superShogun->state);
+                SendMessage(GetItem(getOwnerPos()), "_shogun", superShogun->getHoles());
             if (subShogun != NULL) subShogun->superShogun = superShogun;
             superShogun = NULL;
             subShogun = NULL;
-            state = ownHole();
+            removeAllSubHoles();
         }
         return true;
     }
     
     FreezeStatusBits ShogunStone::get_freeze_bits() {
-        return (state == 4) ? FREEZEBIT_STANDARD : FREEZEBIT_NO_STONE;
+        return (getHoles() == S) ? FREEZEBIT_STANDARD : FREEZEBIT_NO_STONE;
     }
     
     DEF_TRAITSM(ShogunStone, "st_shogun", st_shogun, MOVABLE_IRREGULAR);

Modified: trunk/src/stones/ShogunStone.hh
===================================================================
--- trunk/src/stones/ShogunStone.hh	2008-08-16 23:21:54 UTC (rev 1273)
+++ trunk/src/stones/ShogunStone.hh	2008-08-17 13:06:51 UTC (rev 1274)
@@ -38,16 +38,23 @@
             S         =  4,   ///<  Small
             M         =  8,   ///<  Medium
             L         = 16,   ///<  Large
-            G         = 32,   ///<  Giant
-            U         = 64    ///<  Universal
+            G         = 32,   ///<  Giant - not yet existing
+            U         = 64    ///<  Universal - not yet existing
         };
-
-        ShogunStone(int initState);
+        
+    private:
+        enum ObjectPrivatFlagsBits {
+            OBJBIT_HOLES =   127<<24,   ///< holes as defined in stones/ShogunStone.hh
+        };
+    public:
+        ShogunStone(int holes);
         ShogunStone* clone();
         void dispose();
         
         // Object interface
         virtual std::string getClass() const;
+        virtual void setAttr(const string& key, const Value &val);
+        virtual Value getAttr(const std::string &key) const;
         virtual Value message(const Message &m);
         
         // StateObject interface
@@ -67,7 +74,11 @@
         ShogunStone *superShogun;
         ShogunStone *subShogun;
         
-        int ownHole();
+        int getHoles() const;
+        int ownHole() const;
+        void addSubHoles(int holes);
+        void removeSubHoles(int holes);
+        void removeAllSubHoles();
         bool yieldShogun();
     };
 



From R.Lamprecht at T-Online.de  Sun Aug 17 21:15:21 2008
From: R.Lamprecht at T-Online.de (Ronald Lamprecht)
Date: Sun, 17 Aug 2008 21:15:21 +0200
Subject: [Enigma-game-svn] r1260 (repost)
Message-ID: <48A878C9.6030309@T-Online.de>

Author: ral
Date: 2008-08-09 16:04:03 +0200 (Sat, 09 Aug 2008)
New Revision: 1260

Modified:
    trunk/src/GridObject.cc
    trunk/src/GridObject.hh
Log:
Trunk 1.1: new API reengineering
- fix Laser calc on critical object deletions
   (Enigma III#55 did crash app on lightening of right Laserswitch)


Modified: trunk/src/GridObject.cc
===================================================================
--- trunk/src/GridObject.cc	2008-08-08 15:23:38 UTC (rev 1259)
+++ trunk/src/GridObject.cc	2008-08-09 14:04:03 UTC (rev 1260)
@@ -222,6 +222,7 @@
      // GridObject laser light support

      std::list<GridObject *> GridObject::photoSensorList;
+    std::list<GridObject *>::iterator GridObject::postRecalcItr;

      void GridObject::preLaserRecalc() {
          for (list<GridObject *>::iterator itr = 
photoSensorList.begin(); itr != photoSensorList.end(); ++itr) {
@@ -231,9 +232,9 @@
      }

      void GridObject::postLaserRecalc() {
-        for (list<GridObject *>::iterator itr = 
photoSensorList.begin(); itr != photoSensorList.end(); ) {
-            list<GridObject *>::iterator witr = itr;  // work iterator 
for possible deletion of object
-            ++itr;                                    // main iterator 
does no longer point to critical object
+        for (postRecalcItr = photoSensorList.begin(); postRecalcItr != 
photoSensorList.end(); ) {
+            list<GridObject *>::iterator witr = postRecalcItr;  // work 
iterator for possible deletion of object
+            ++postRecalcItr;                          // main iterator 
does no longer point to critical object
              uint32_t flags = (*witr)->objFlags;
              DirectionBits newDirs = (DirectionBits)(flags & 
OBJBIT_LIGHTNEWDIRS);
              DirectionBits oldDirs = (DirectionBits)((flags & 
OBJBIT_LIGHTOLDDIRS) >> 4);
@@ -245,6 +246,7 @@

      void GridObject::prepareLevel() {
          photoSensorList.clear();
+        postRecalcItr = photoSensorList.end();
      }

      void GridObject::processLight(Direction dir) {
@@ -266,8 +268,12 @@

      void GridObject::deactivatePhoto() {
          std::list<GridObject *>::iterator itr = 
std::find(photoSensorList.begin(), photoSensorList.end(), this);
-        if (itr != photoSensorList.end())
+        if (itr != photoSensorList.end()) {
+            if (postRecalcItr == itr)  //  deactivation on 
lightDirChanged that interflicts postLaserRecalc
+                // this object can no longer do as the postLaserRecalc 
iterator, proceed to next one
+                ++postRecalcItr;
              photoSensorList.erase(itr);
+        }
          objFlags &= ~OBJBIT_PHOTOACTIV;

      }

Modified: trunk/src/GridObject.hh
===================================================================
--- trunk/src/GridObject.hh	2008-08-08 15:23:38 UTC (rev 1259)
+++ trunk/src/GridObject.hh	2008-08-09 14:04:03 UTC (rev 1260)
@@ -149,6 +149,7 @@
          static void prepareLevel();
      private:
          static std::list<GridObject *> photoSensorList;
+        static std::list<GridObject *>::iterator postRecalcItr;

      public:
          virtual void processLight(Direction d);   // direction of 
laserbeam


From R.Lamprecht at T-Online.de  Sun Aug 17 21:19:17 2008
From: R.Lamprecht at T-Online.de (Ronald Lamprecht)
Date: Sun, 17 Aug 2008 21:19:17 +0200
Subject: [Enigma-game-svn] r1261 (repost)
Message-ID: <48A879B5.7020105@T-Online.de>

Author: ral
Date: 2008-08-10 22:20:46 +0200 (Sun, 10 Aug 2008)
New Revision: 1261

Added:
    trunk/src/stones/Door.cc
    trunk/src/stones/Door.hh
Modified:
    trunk/data/api1init.lua
    trunk/data/schemas/objects.xml
    trunk/src/Makefile.am
    trunk/src/ox_extra.cc
    trunk/src/ox_magnum.cc
    trunk/src/ox_oxyd1.cc
    trunk/src/ox_peroxyd.cc
    trunk/src/stones.hh
    trunk/src/stones/CoinSlot.cc
    trunk/src/stones_complex.cc
Log:
Trunk 1.1: new API reengineering - Door
- renaming to "st_door", "st_door_a" to "st_door_d"
- attribute "flavor": "a" to "d", where "d" is h/v door
- attribute "faces" for flavor "d": "ns","ew" for h/v - logic prepared
     for arbitrary face combinations, just models missing
- full StateObject support - state as OPEN, CLOSED; messages open, close,
     toggle, signal
- fixed collision problems (edges and OPENING)
- fixed door on bridge problem (level "Gateway")


Modified: trunk/data/api1init.lua
===================================================================
--- trunk/data/api1init.lua	2008-08-09 14:04:03 UTC (rev 1260)
+++ trunk/data/api1init.lua	2008-08-10 20:20:46 UTC (rev 1261)
@@ -123,6 +123,9 @@
      st_coinslot = "st-coinslot",
      st_death = "st-death",
      st_death_invisible = "st-death_invisible",
+    st_door_a = "st-door_a",
+    st_door_b = "st-door_b",
+    st_door_c = "st-door_c",
      st_floppy = "st-floppy",
      st_fourswitch = "st-fourswitch",
      st_knight = "st-knight",
@@ -286,6 +289,24 @@
          local obj = enigma._MakeObject("st_scissors")
          enigma._SetAttrib(obj, "inverse", true)
          return obj
+    elseif name == "st-door-h" or name == "st-door" then
+        local obj = enigma._MakeObject("st_door_d")
+        enigma._SetAttrib(obj, "faces", "ns")
+        return obj
+    elseif name == "st-door-h-open" then
+        local obj = enigma._MakeObject("st_door_d")
+        enigma._SetAttrib(obj, "faces", "ns")
+        enigma._SetAttrib(obj, "state", 1)
+        return obj
+    elseif name == "st-door-v" then
+        local obj = enigma._MakeObject("st_door_d")
+        enigma._SetAttrib(obj, "faces", "ew")
+        return obj
+    elseif name == "st-door-h-open" then
+        local obj = enigma._MakeObject("st_door_d")
+        enigma._SetAttrib(obj, "faces", "ew")
+        enigma._SetAttrib(obj, "state", 1)
+        return obj
      end

      newname = RenamingObjectsOld2New[name]
@@ -331,6 +352,14 @@
              return "it-key_a"
          end
      end
+    if _newname == "st_door" then
+        local flavor = enigma._GetAttrib(obj, "flavor")
+        if flavor == "d" then
+            return "st-door"
+        else
+            return "st-door_" .. flavor
+        end
+    end
      if _newname == "it_sensor" then
          local code = enigma._GetAttrib(obj, "inverse")
          if code == false then
@@ -467,6 +496,10 @@
       if key == "movable" then
           if val == 1 then _val = true else _val = false end
       end
+     if key == "type" and _obj_name == "st-door" then
+         _key = "faces"
+         if val == "h" then _val = "ns" else _val = "ew" end
+     end
       enigma._SetAttrib(obj, _key, _val)
  end

@@ -510,6 +543,11 @@
       if key == "on" then
           _key = "state"
       end
+     if key == "type" and _obj_name == "st-door" then
+         faces = enigma._GetAttrib(obj, "faces")
+         if faces == "ns" then val = "h" else val = "v" end
+         return val
+     end

       local val = enigma._GetAttrib(obj, _key)

@@ -607,6 +645,7 @@
      st_blocker_new__openclose = "toggle",
      st_blocker_new__trigger = "toggle",
      st_boulder__direction = "orientate",
+    st_door__openclose = "toggle",
      ["st-fart__trigger"] = "toggle",
      st_fourswitch__trigger = "toggle",
      st_floppy__onoff = "toggle",

Modified: trunk/data/schemas/objects.xml
===================================================================
--- trunk/data/schemas/objects.xml	2008-08-09 14:04:03 UTC (rev 1260)
+++ trunk/data/schemas/objects.xml	2008-08-10 20:20:46 UTC (rev 1261)
@@ -60,6 +60,7 @@
      <msg name="disconnect" type="nil"/>
      <msg name="flip" type="nil"/>
      <msg name="hit" type="object"/>
+    <msg name="ignite" type="nil"/>
      <msg name="inner_pull" type="dir"/>
      <msg name="kill" type="nil"/>
      <msg name="move" type="pos"/>
@@ -469,6 +470,25 @@
      <object name="st_death_invisible">
        <attr name="invisible" value="true"/>
      </object>
+    <object name="st_door">
+      <attr name="faces" default="nesw"/>
+      <attr name="flavor"/>
+      <msg name="close"/>
+      <msg name="open"/>
+      <msg name="signal"/>
+    </object>
+    <object name="st_door_a">
+      <attr name="flavor" value="a"/>
+    </object>
+    <object name="st_door_b">
+      <attr name="flavor" value="b"/>
+    </object>
+    <object name="st_door_c">
+      <attr name="flavor" value="c"/>
+    </object>
+    <object name="st_door_d">
+      <attr name="flavor" value="d"/>
+    </object>
      <object name="st_floppy">
        <msg name="on"/>
        <msg name="off"/>

Modified: trunk/src/Makefile.am
===================================================================
--- trunk/src/Makefile.am	2008-08-09 14:04:03 UTC (rev 1260)
+++ trunk/src/Makefile.am	2008-08-10 20:20:46 UTC (rev 1261)
@@ -223,6 +223,8 @@
  	stones/ConnectiveStone.hh	\
  	stones/DeathStone.cc	\
  	stones/DeathStone.hh	\
+	stones/Door.cc		\
+	stones/Door.hh		\
  	stones/FloppySwitch.cc   \
  	stones/FloppySwitch.hh   \
  	stones/FourSwitch.cc	\

Modified: trunk/src/ox_extra.cc
===================================================================
--- trunk/src/ox_extra.cc	2008-08-09 14:04:03 UTC (rev 1260)
+++ trunk/src/ox_extra.cc	2008-08-10 20:20:46 UTC (rev 1261)
@@ -231,8 +231,8 @@
      UNUSED,              // OxydExtra stone 0x70
      UNUSED,              // OxydExtra stone 0x71
      UNUSED,              // OxydExtra stone 0x72
-    "st-door-h",         // OxydExtra stone 0x73
-    "st-door-v",         // OxydExtra stone 0x74
+    "st_door_d",         // OxydExtra stone 0x73
+    "st_door_d_ew",      // OxydExtra stone 0x74
      UNUSED,              // OxydExtra stone 0x75
      "st-invisible",      // OxydExtra stone 0x76
      UNUSED,              // OxydExtra stone 0x77

Modified: trunk/src/ox_magnum.cc
===================================================================
--- trunk/src/ox_magnum.cc	2008-08-09 14:04:03 UTC (rev 1260)
+++ trunk/src/ox_magnum.cc	2008-08-10 20:20:46 UTC (rev 1261)
@@ -231,12 +231,12 @@
      "st-mail-w",                // OxydMagnum stone 0x70
      "st-mail-e",                // OxydMagnum stone 0x71
      "st-mail-s",                // OxydMagnum stone 0x72
-    "st-door-h",                // OxydMagnum stone 0x73
-    "st-door-v",                // OxydMagnum stone 0x74
+    "st_door_d",                // OxydMagnum stone 0x73
+    "st_door_d_ew",             // OxydMagnum stone 0x74
      "st-metal",                 // OxydMagnum stone 0x75
      "st-invisible",             // OxydMagnum stone 0x76
      UNUSED,                     // OxydMagnum stone 0x77
-    "st-door-v-open",           // OxydMagnum stone 0x78 
(st-door-h-open was wrong, look at level #32)
+    "st_door_d_ew_open",        // OxydMagnum stone 0x78 
(st-door-h-open was wrong, look at level #32)
      UNUSED,                     // OxydMagnum stone 0x79
      "st_laserflop_on",          // OxydMagnum stone 0x7a (Level 66, 
this is a solid stone)
      UNUSED,                     // OxydMagnum stone 0x7b

Modified: trunk/src/ox_oxyd1.cc
===================================================================
--- trunk/src/ox_oxyd1.cc	2008-08-09 14:04:03 UTC (rev 1260)
+++ trunk/src/ox_oxyd1.cc	2008-08-10 20:20:46 UTC (rev 1261)
@@ -166,14 +166,14 @@
      0,                          // Oxyd1 stone 0x00
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      "st-fakeoxyd",              // Oxyd1 stone 0x11
-    "st-door_c",                // Oxyd1 stone 0x12
+    "st_door_c",                // Oxyd1 stone 0x12
      "st_brick_es",              // Oxyd1 stone 0x13
      "st_brick_sw",              // Oxyd1 stone 0x14
      "st_brick_ne"  ,            // Oxyd1 stone 0x15
      "st_brick_nw",              // Oxyd1 stone 0x16
      "st-plain_hole",            // Oxyd1 stone 0x17
      "st-oxyd-0x18",             // Oxyd1 stone 0x18
-    "st-door_c-open",           // Oxyd1 stone 0x19
+    "st_door_c_open",           // Oxyd1 stone 0x19
      "st-grate1",                // Oxyd1 stone 0x1a
      "st-grate2",                // Oxyd1 stone 0x1b
      "st-bug",                   // Oxyd1 stone 0x1c
@@ -263,12 +263,12 @@
      "st-mail-w",                // Oxyd1 stone 0x70
      "st-mail-e",                // Oxyd1 stone 0x71
      "st-mail-s",                // Oxyd1 stone 0x72
-    "st-door-h",                // Oxyd1 stone 0x73
-    "st-door-v",                // Oxyd1 stone 0x74
+    "st_door_d",                // Oxyd1 stone 0x73
+    "st_door_d_ew",             // Oxyd1 stone 0x74
      "st-metal",                 // Oxyd1 stone 0x75
      "st-invisible",             // Oxyd1 stone 0x76
-    "st-door-h-open",           // Oxyd1 stone 0x77
-    "st-door-v-open",           // Oxyd1 stone 0x78
+    "st_door_d_open",           // Oxyd1 stone 0x77
+    "st_door_d_ew_open",        // Oxyd1 stone 0x78
      UNUSED,                     // Oxyd1 stone 0x79
      "st_laserflop_on",          // Oxyd1 stone 0x7a (only used in 
level #23)
      UNUSED,                     // Oxyd1 stone 0x7b

Modified: trunk/src/ox_peroxyd.cc
===================================================================
--- trunk/src/ox_peroxyd.cc	2008-08-09 14:04:03 UTC (rev 1260)
+++ trunk/src/ox_peroxyd.cc	2008-08-10 20:20:46 UTC (rev 1261)
@@ -303,12 +303,12 @@
      "st-mail-w",                // PerOxyd stone 0x70
      "st-mail-e",                // PerOxyd stone 0x71
      "st-mail-s",                // PerOxyd stone 0x72
-    "st-door-h",                // PerOxyd stone 0x73
-    "st-door-v",                // PerOxyd stone 0x74
+    "st_door_d",                // PerOxyd stone 0x73
+    "st_door_d_ew",             // PerOxyd stone 0x74
      "st-metal",                 // PerOxyd stone 0x75
      "st-stonebrush",            // PerOxyd stone 0x76
-    "st-door-h-open",           // PerOxyd stone 0x77
-    "st-door-v-open",           // PerOxyd stone 0x78
+    "st_door_d_open",           // PerOxyd stone 0x77
+    "st_door_d_ew_open",        // PerOxyd stone 0x78
      "st-white1",                // PerOxyd stone 0x79 (Can be either 
st-white1 or st-white4)
      "st-black1",                // PerOxyd stone 0x7a (Can be either 
st-black1 or st-black4)
      "st-metal_hole",            // PerOxyd stone 0x7b (because it 
looks similar ...; only link level 79)

Modified: trunk/src/stones/CoinSlot.cc
===================================================================
--- trunk/src/stones/CoinSlot.cc	2008-08-09 14:04:03 UTC (rev 1260)
+++ trunk/src/stones/CoinSlot.cc	2008-08-10 20:20:46 UTC (rev 1261)
@@ -155,7 +155,7 @@
          bool actionValue = false;
          bool doInit = false;

-        Log << "Coinslot state change from " << state << " to " << 
newIState << "\n";
+//        Log << "Coinslot state change from " << state << " to " << 
newIState << "\n";
          switch (state) {
              case OFF :
                  ASSERT(newIState != ON, XLevelRuntime, "Coinslot - 
illegal state change from OFF to ON");

Added: trunk/src/stones/Door.cc
===================================================================
--- trunk/src/stones/Door.cc	2008-08-09 14:04:03 UTC (rev 1260)
+++ trunk/src/stones/Door.cc	2008-08-10 20:20:46 UTC (rev 1261)
@@ -0,0 +1,202 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include "stones/Door.hh"
+#include "errors.hh"
+//#include "main.hh"
+#include "laser.hh"
+
+namespace enigma {
+    Door::Door(std::string flavor, int initState, std::string faces) : 
Stone () {
+        state = initState;
+        setAttr("flavor", flavor);
+        setAttr("faces", faces);
+    }
+
+    std::string Door::getClass() const {
+        return "st_door";
+    }
+
+    void Door::setAttr(const string& key, const Value &val) {
+        if (key == "flavor") {
+            Stone::setAttr(key, val);
+            if (val.to_string() != "d")
+                Stone::setAttr("faces", ALL_DIRECTIONS);
+            if (isDisplayable() && state <= OPEN)
+                init_model();    // need to redisplay after attribute set
+            return;
+        } else if (key == "faces" && getAttr("flavor").to_string() == 
"d") {
+            Stone::setAttr(key, val);
+            std::string faces = Stone::getAttr(key).to_string();
+            ASSERT(faces == "ns" || faces == "ew", XLevelRuntime, "Door 
type d supports only face 'ns' and 'ew'");
+        }
+        Stone::setAttr(key, val);
+    }
+
+    Value Door::message(const Message &m) {
+        if (m.message == "ignite" && getAttr("flavor").to_string() == 
"c" && server::GameCompatibility == GAMET_OXYD1) {
+            if (isDisplayable())
+                KillStone(get_pos());  // TODO animation & sound
+            return Value();
+        } else
+            return Stone::message(m);
+    }
+
+    int Door::externalState() const {
+        return (state == OPEN) ? 1 : 0;
+    }
+
+    void Door::setState(int extState) {
+        if (isDisplayable()) {
+            if (extState == 1 && (state == CLOSED || state == CLOSING))
+                set_iState(OPENING);
+            else if (extState == 0 && (state == OPEN || state == OPENING))
+                set_iState(CLOSING);
+        } else
+            state = extState;
+    }
+
+    void Door::toggleState() {
+        set_iState((state == OPEN || state == OPENING) ? CLOSING : 
OPENING);
+    }
+
+    void Door::init_model() {
+        string mname = model_basename();
+        if (state == CLOSED)
+            mname += "-closed";
+        else if (state==OPEN)
+            mname += "-open";
+        set_model(mname);
+    }
+
+    void Door::animcb() {
+        if (state == OPENING)
+            set_iState(OPEN);
+        else if (state == CLOSING)
+            set_iState(CLOSED);
+    }
+
+    bool Door::is_floating() const {
+        return true;
+    }
+
+    bool Door::is_transparent(Direction d) const {
+        if (state == OPEN)
+            return true;
+        else {
+            DirectionBits faces = (DirectionBits)(ALL_DIRECTIONS ^ 
getConnections());
+            return !has_dir(faces, d) && !has_dir(faces, reverse(d));
+        }
+    }
+
+    StoneResponse Door::collision_response(const StoneContact &sc) {
+        Direction cf = contact_face(sc);
+        if (state == OPEN)
+            return STONE_PASS;
+        else {
+            DirectionBits faces = (DirectionBits)(ALL_DIRECTIONS ^ 
getConnections());
+            StoneResponse result = STONE_PASS;
+            if ((has_dir(faces, WEST) && (get_pos().x >= 
sc.actor->get_pos()[0])) ||
+                    (has_dir(faces, SOUTH) && (get_pos().y + 1 <= 
sc.actor->get_pos()[1])) ||
+                    (has_dir(faces, EAST) && (get_pos().x + 1 <= 
sc.actor->get_pos()[0])) ||
+                    (has_dir(faces, NORTH) && (get_pos().y >= 
sc.actor->get_pos()[1])))
+                result = STONE_REBOUND;
+            return result;
+        }
+    }
+
+    void Door::actor_hit(const StoneContact &sc) {
+        if (getAttr("flavor").to_string() == "d") {
+            // door knocking
+            Item *it = GetItem(get_pos());
+            if (it != NULL && server::GameCompatibility != GAMET_PEROXYD
+                    && (server::GameCompatibility != GAMET_ENIGMA || 
server::EnigmaCompatibility < 1.10 ))
+                SendMessage(it, "_hit", sc.actor);
+            else
+                performAction(sc.actor);
+        }
+    }
+
+    const char *Door::collision_sound() {
+        return (getAttr("flavor").to_string() == "d") ? "electric" : 
Stone::collision_sound();
+    }
+
+    FreezeStatusBits Door::get_freeze_bits() {
+        return FREEZEBIT_NO_STONE;
+    }
+
+    std::string Door::model_basename() {
+        std::string flavor = getAttr("flavor").to_string();
+        if (flavor != "d")
+            return std::string("st-door_") + flavor;
+        else
+            return (getConnections() == (WESTBIT | EASTBIT)) ? 
"st-doorh": "st-doorv";
+    }
+
+    void Door::set_iState(int newState) {
+        if (isDisplayable()) {
+            std::string basename = model_basename();
+            switch (newState) {
+                case OPEN:
+                    set_model(basename+"-open");
+                    MaybeRecalcLight(get_pos());
+                    break;
+                case CLOSED:
+                    set_model(basename+"-closed");
+                    ShatterActorsInsideField (get_pos());
+                    MaybeRecalcLight(get_pos()); // maybe superfluous
+                    break;
+                case OPENING:
+                    sound_event((getAttr("flavor").to_string() == "d") 
? "dooropen" : "");
+                    if (state == CLOSING)
+                        get_model()->reverse();
+                    else
+                        set_anim(basename+"-opening");
+                    break;
+                case CLOSING:
+                    sound_event((getAttr("flavor").to_string() == "d") 
? "doorclose" : "");
+                    if (state == OPENING)
+                        get_model()->reverse();
+                    else
+                        set_anim(basename+"-closing");
+                    ShatterActorsInsideField (get_pos());
+                    MaybeRecalcLight(get_pos());
+                    break;
+            }
+        }
+        state = newState;
+    }
+
+
+    DEF_TRAITS(Door, "st_door", st_door);
+
+    BOOT_REGISTER_START
+        BootRegister(new Door("d", 0, "ns"), "st_door");
+        BootRegister(new Door("d", 0, "ns"), "st_door_d");
+        BootRegister(new Door("a", 0), "st_door_a");
+        BootRegister(new Door("b", 0), "st_door_b");
+        BootRegister(new Door("c", 0), "st_door_c");
+        BootRegister(new Door("c", 1), "st_door_c_open");
+        BootRegister(new Door("d", 1, "ns"), "st_door_d_open");
+        BootRegister(new Door("d", 0, "ew"), "st_door_d_ew");
+        BootRegister(new Door("d", 1, "ew"), "st_door_d_ew_open");
+    BOOT_REGISTER_END
+
+} // namespace enigma


Property changes on: trunk/src/stones/Door.cc
___________________________________________________________________
Name: svn:eol-style
    + native

Added: trunk/src/stones/Door.hh
===================================================================
--- trunk/src/stones/Door.hh	2008-08-09 14:04:03 UTC (rev 1260)
+++ trunk/src/stones/Door.hh	2008-08-10 20:20:46 UTC (rev 1261)
@@ -0,0 +1,78 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef DOOR_HH
+#define DOOR_HH
+
+#include "stones.hh"
+
+#include "stones_internal.hh"
+
+namespace enigma {
+
+    /**
+     *
+     */
+    class Door : public Stone {
+        CLONEOBJ(Door);
+        DECL_TRAITS;
+
+    private:
+        enum iState {
+            CLOSED,    ///<
+            OPEN,      ///<
+            CLOSING,   ///<
+            OPENING,   ///<
+        };
+
+    public:
+        Door(std::string flavor, int initState, std::string faces = 
"nesw");
+
+        // Object interface
+        virtual std::string getClass() const;
+        virtual void setAttr(const string& key, const Value &val);
+        virtual Value message(const Message &m);
+
+        // StateObject interface
+        virtual int externalState() const;
+        virtual void setState(int extState);
+        virtual void toggleState();
+
+        // GridObject interface
+        virtual void init_model();
+
+        // ModelCallback interface  - Animation callback
+        virtual void animcb();
+
+        // Stone interface
+        virtual bool is_floating() const;
+        virtual bool is_transparent(Direction d) const;
+        virtual StoneResponse collision_response(const StoneContact &sc);
+        virtual void actor_hit(const StoneContact &sc);
+        virtual const char *collision_sound();
+        virtual FreezeStatusBits get_freeze_bits();
+
+    private:
+        std::string model_basename();
+        void set_iState(int newState);
+    };
+
+} // namespace enigma
+
+#endif


Property changes on: trunk/src/stones/Door.hh
___________________________________________________________________
Name: svn:eol-style
    + native

Modified: trunk/src/stones.hh
===================================================================
--- trunk/src/stones.hh	2008-08-09 14:04:03 UTC (rev 1260)
+++ trunk/src/stones.hh	2008-08-10 20:20:46 UTC (rev 1261)
@@ -53,6 +53,7 @@
          st_coinslot,
          st_death,
          st_death_invisible,
+        st_door,
          st_easymode,
          st_explosion,
          st_fakeoxyda,
@@ -189,13 +190,13 @@
          }

          /*! Can a swap-stone or pull-stone swap this stone? */
-        virtual bool   is_removable() const { return true; }
+        virtual bool is_removable() const { return true; }

          /*! Is this stone floating above the floor (e.g. actors may 
pass)? */
          virtual bool is_floating() const { return false; }

          /*! Can laser beams pass through stone? Return is_floating() 
by default. */
-        virtual bool   is_transparent (Direction d) const {
+        virtual bool is_transparent(Direction d) const {
              return is_floating();
          }


Modified: trunk/src/stones_complex.cc
===================================================================
--- trunk/src/stones_complex.cc	2008-08-09 14:04:03 UTC (rev 1260)
+++ trunk/src/stones_complex.cc	2008-08-10 20:20:46 UTC (rev 1261)
@@ -962,233 +962,6 @@
  }


-
-/* -------------------- DoorBase -------------------- */
-
-// Base class for everything that behaves like a door, i.e., it has
-// four states OPEN, CLOSED, OPENING, CLOSING.
-namespace
-{
-    class DoorBase : public Stone {
-    protected:
-        enum State { OPEN, CLOSED, OPENING, CLOSING } state;
-
-        DoorBase(const char *name, State initstate=CLOSED)
-        : Stone(name), state(initstate)
-        {}
-
-        State get_state() const { return state; }
-        void set_state(State st) { state=st; }
-
-        void change_state(State newstate) ;
-        virtual Value message(const Message &m);
-    private:
-        // DoorBase interface
-        virtual string model_basename() { return get_kind(); }
-        virtual void init_model();
-        virtual string opening_sound() const { return ""; }
-        virtual string closing_sound() const { return ""; }
-
-        // Private methods
-
-        StoneResponse collision_response(const StoneContact &sc);
-
-        void animcb();
-
-        // Stone interface
-        virtual bool is_transparent (Direction) const
-        { return state==OPEN; }
-
-        virtual bool is_sticky (const Actor *) const
-        { return false; }
-
-    private:
-        FreezeStatusBits get_freeze_bits() { return FREEZEBIT_NO_STONE; 
}
-    };
-}
-
-Value DoorBase::message(const Message &m) {
-    State newstate = state;
-
-    if (m.message == "open") {
-        newstate = OPENING;
-    } else if (m.message == "close") {
-        newstate = CLOSING;
-    } else if (m.message == "openclose" || m.message == "toggle") {
-        newstate = (state==OPEN || state==OPENING) ? CLOSING : OPENING;
-    } else if (m.message == "signal") {
-        newstate = m.value.to_bool() ? OPENING : CLOSING;
-    } else {
-        return Stone::message(m);
-    }
-
-    if (newstate==OPENING && (state==CLOSED || state==CLOSING))
-        change_state(OPENING);
-    else if (newstate==CLOSING && (state==OPEN || state==OPENING))
-        change_state(CLOSING);
-    return Value();
-}
-
-void DoorBase::init_model() {
-    string mname = model_basename();
-    if (state == CLOSED)
-        mname += "-closed";
-    else if (state==OPEN)
-        mname += "-open";
-    set_model(mname);
-}
-
-void DoorBase::animcb() {
-    if (state == OPENING)
-        change_state(OPEN);
-    else if (state == CLOSING)
-        change_state(CLOSED);
-}
-
-StoneResponse
-DoorBase::collision_response(const StoneContact &/*sc*/)
-{
-    return (state == OPEN) ? STONE_PASS:STONE_REBOUND;
-}
-
-void DoorBase::change_state(State newstate)
-{
-    string basename = model_basename();
-
-    switch (newstate) {
-    case OPEN:
-        set_model(basename+"-open");
-        MaybeRecalcLight(get_pos());
-        break;
-    case CLOSED:
-        set_model(basename+"-closed");
-        ShatterActorsInsideField (get_pos());
-        MaybeRecalcLight(get_pos()); // maybe superfluous
-        break;
-    case OPENING:
-        sound_event (opening_sound().c_str());
-        if (state == CLOSING)
-            get_model()->reverse();
-        else
-            set_anim(basename+"-opening");
-        break;
-    case CLOSING:
-        sound_event (closing_sound().c_str());
-        if (state == OPENING)
-            get_model()->reverse();
-        else
-            set_anim(basename+"-closing");
-        ShatterActorsInsideField (get_pos());
-        MaybeRecalcLight(get_pos());
-        break;
-    }
-    set_state(newstate);
-}
-
-
-/* -------------------- Door -------------------- */
-
-// Attributes:
-//
-// :type        h or v for a door that opens horizontally or vertically
-namespace
-{
-    class Door : public DoorBase {
-        CLONEOBJ(Door);
-    public:
-        Door(const char *type="h", bool open=false)
-        : DoorBase("st-door", open ? OPEN : CLOSED)
-        {
-            setAttr("type", type);
-        }
-    private:
-        virtual string opening_sound() const { return "dooropen"; }
-        virtual string closing_sound() const { return "doorclose"; }
-        virtual const char *collision_sound() { return "electric"; }
-        string get_type() const {
-            string type(getDefaultedAttr("type", "h"));
-            return type;
-        }
-
-        bool is_transparent (Direction) const;
-        bool is_floating () const {
-            return true;        // don't let door press buttons
-        }
-
-        void actor_hit(const StoneContact &sc)
-        {
-            Log << "door knocking\n";
-            // door knocking
-            Item *it = GetItem(get_pos());
-            if (it != NULL && server::GameCompatibility != GAMET_PEROXYD
-                    && (server::GameCompatibility != GAMET_ENIGMA || 
server::EnigmaCompatibility < 1.10 ))
-                SendMessage(it, "_hit", sc.actor);
-            else
-                performAction(sc.actor);
-        }
-
-        string model_basename() { return string("st-door")+get_type(); }
-        StoneResponse collision_response(const StoneContact &sc);
-    };
-
-    class Door_a : public DoorBase {
-        CLONEOBJ(Door_a);
-    public:
-        Door_a() : DoorBase("st-door_a") {}
-    };
-
-    class Door_b : public DoorBase {
-        CLONEOBJ(Door_b);
-    public:
-        Door_b() : DoorBase("st-door_b") {}
-    };
-
-    class Door_c : public DoorBase {
-        CLONEOBJ(Door_c);
-    public:
-        Door_c() : DoorBase("st-door_c") {}
-        Value message(const Message &m) {
-            if (m.message == "ignite" && server::GameCompatibility == 
GAMET_OXYD1) {
-                KillStone(get_pos());  // TODO animation & sound
-                return Value();
-            } else {
-                return DoorBase::message(m);
-            }
-        }
-    };
-
-    class Door_c_open : public DoorBase {  // a hack for oxyd 
compatibility tests
-        CLONEOBJ(Door_c_open);
-    public:
-        Door_c_open() : DoorBase("st-door_c", OPEN) {}
-    };
-}
-
-bool Door::is_transparent (Direction dir) const {
-    if (get_type() == "h")
-        return state==OPEN || dir==EAST || dir==WEST;
-    else
-        return state==OPEN || dir==NORTH || dir==SOUTH;
-}
-
-StoneResponse
-Door::collision_response(const StoneContact &sc)
-{
-    Direction cf = contact_face(sc);
-    if (state == OPEN)
-        return STONE_PASS;
-    else if (state == CLOSING)
-        return STONE_REBOUND;
-    else {
-        string t = get_type();
-        return ((t == "v" && (cf==WEST || cf==EAST)) ||
-                (t == "h" && (cf==SOUTH || cf==NORTH)))
-            ? STONE_REBOUND
-            : STONE_PASS;
-    }
-}
-
-
  /* -------------------- ShogunStone -------------------- */

  // Attributes:
@@ -1713,16 +1486,6 @@

  void Init_complex()
  {
-    Register(new Door);
-    Register("st-door-h", new Door("h"));
-    Register("st-door-v", new Door("v"));
-    Register("st-door-h-open", new Door("h", true));
-    Register("st-door-v-open", new Door("v", true));
-    Register(new Door_a);
-    Register(new Door_b);
-    Register(new Door_c);
-    Register("st-door_c-open", new Door_c_open);
-
      Register(new HollowStoneImpulseStone);

      MailStone::setup();


From R.Lamprecht at T-Online.de  Sun Aug 17 21:20:26 2008
From: R.Lamprecht at T-Online.de (Ronald Lamprecht)
Date: Sun, 17 Aug 2008 21:20:26 +0200
Subject: [Enigma-game-svn] r1264 (repost)
Message-ID: <48A879FA.5010601@T-Online.de>

Author: ral
Date: 2008-08-12 21:27:30 +0200 (Tue, 12 Aug 2008)
New Revision: 1264

Modified:
    trunk/src/GridObject.hh
    trunk/src/lua.cc
    trunk/src/stones/Door.cc
Log:
Trunk 1.1: new API reengineering
- fix Door: set attribute "flavor" did set false faces.
- add new group method "shuffle()"


Modified: trunk/src/GridObject.hh
===================================================================
--- trunk/src/GridObject.hh	2008-08-12 13:31:52 UTC (rev 1263)
+++ trunk/src/GridObject.hh	2008-08-12 19:27:30 UTC (rev 1264)
@@ -54,7 +54,7 @@

          void creation(GridPos p) {
              pos = p;
-            on_creation (p);
+            on_creation(p);
          }
          void removal(GridPos p) {
              on_removal(p);

Modified: trunk/src/lua.cc
===================================================================
--- trunk/src/lua.cc	2008-08-12 13:31:52 UTC (rev 1263)
+++ trunk/src/lua.cc	2008-08-12 19:27:30 UTC (rev 1264)
@@ -2637,6 +2637,25 @@
      }
  }

+static int shuffleGroup(lua_State *L) {
+    // group
+    ObjectList oldSort = toObjectList(L, 1);
+    ObjectList newSort;
+    std::vector<Object *> shuffleVector;
+    for (ObjectList::iterator itr = oldSort.begin(); itr != 
oldSort.end(); ++itr)
+        shuffleVector.push_back(*itr);
+    int members = shuffleVector.size();
+    for (int i = members - 1; i > 0; i--) {
+        int j = IntegerRand(0, i);
+        Object * obj = shuffleVector[j];
+        shuffleVector[j] = shuffleVector[i];
+        shuffleVector[i] = obj;
+    }
+    for (std::vector<Object *>::iterator itr = shuffleVector.begin(); 
itr != shuffleVector.end(); ++itr)
+        newSort.push_back(*itr);
+    return pushNewGroup(L, newSort);
+}
+
  MethodMap defaultMethodeMap;

  static int pushNewDefault(lua_State *L) {
@@ -2840,6 +2859,7 @@
  static CFunction groupMethods[] = {
      {groupMessage,                  "message"},
      {killObject,                    "kill"},
+    {shuffleGroup,                  "shuffle"},
      {0,0}
  };


Modified: trunk/src/stones/Door.cc
===================================================================
--- trunk/src/stones/Door.cc	2008-08-12 13:31:52 UTC (rev 1263)
+++ trunk/src/stones/Door.cc	2008-08-12 19:27:30 UTC (rev 1264)
@@ -38,7 +38,7 @@
          if (key == "flavor") {
              Stone::setAttr(key, val);
              if (val.to_string() != "d")
-                Stone::setAttr("faces", ALL_DIRECTIONS);
+                Stone::setAttr("faces", "nesw");
              if (isDisplayable() && state <= OPEN)
                  init_model();    // need to redisplay after attribute set
              return;


From R.Lamprecht at T-Online.de  Sun Aug 17 21:21:17 2008
From: R.Lamprecht at T-Online.de (Ronald Lamprecht)
Date: Sun, 17 Aug 2008 21:21:17 +0200
Subject: [Enigma-game-svn] r1266 (repost)
Message-ID: <48A87A2D.5090608@T-Online.de>

Author: ral
Date: 2008-08-13 23:44:47 +0200 (Wed, 13 Aug 2008)
New Revision: 1266

Added:
    trunk/src/items/ShogunDot.cc
    trunk/src/items/ShogunDot.hh
    trunk/src/stones/ShogunStone.cc
    trunk/src/stones/ShogunStone.hh
Modified:
    trunk/data/api1init.lua
    trunk/data/api2init.lua
    trunk/data/models-2d.lua
    trunk/data/schemas/objects.xml
    trunk/src/Makefile.am
    trunk/src/items.cc
    trunk/src/ox_extra.cc
    trunk/src/ox_magnum.cc
    trunk/src/ox_oxyd1.cc
    trunk/src/ox_peroxyd.cc
    trunk/src/stones.cc
    trunk/src/stones_complex.cc
    trunk/src/world.cc
Log:
Trunk 1.1: new API reengineering - Shogun
- complete rewrite of shogun stone and item:
   - rename to "st_shogun", "st_shogun_s", ..., "st_shogun_sml"
            "it_shogun", "it_shugun_s", ..., "it_shogun_l"
   - the "state" attribute keeps the stack info - a sum of
       SHOGUN_S, SHOGUN_M, SHOGUN_L constants.
       it is always readable, but writeable only prior to setting onto grid
   - on grid set a shogun stack expands to seperate shogun objects, all
       positioned on the same grid. The largest shogun is retrieved by
       position access.
   - the stone attributes "name_s" and "name_m" can be used to name 
subshoguns
   - the identity of shogun stones is now preserved:
     - rubberbands and wires will keep connected to moving shoguns and even
         survive a shogun stack membership
     - user attributes will survive, too
     - even single shogun objects in a stack can be killed by a "kill" 
message
   - shogun dots will observe the snapshot princple for 1.10 but keep the
       old init behaviour for old levels
- other fixes:
   - crash fix on old API floor killing
   - improve world destruction by disposing all objects prior deleting grid
       fields
   - sort order destruction and clearings
   - fix coin item getClass
   - fix YieldedGridStone for swap and puller stone: disconnect yielded 
stone
       from wires and rubberbands in case of an unexpected disposal.


Modified: trunk/data/api1init.lua
===================================================================
--- trunk/data/api1init.lua	2008-08-13 12:01:32 UTC (rev 1265)
+++ trunk/data/api1init.lua	2008-08-13 21:44:47 UTC (rev 1266)
@@ -64,6 +64,9 @@
      it_magnet_on = "it-magnet-on",
      it_magnet_off = "it-magnet-off",
      it_rubberband = "it-rubberband",
+    it_shogun_s = "it-shogun-s",
+    it_shogun_m = "it-shogun-m",
+    it_shogun_l = "it-shogun-l",
      it_strip_ew = "it-hstrip",
      it_strip_ns = "it-vstrip",
      it_sword = "it-sword",
@@ -196,6 +199,14 @@
      st_rotator_ccw_movable = "st-rotator_move-left",
      st_rubberband = "st-rubberband",
      st_scissors = "st-scissors",
+    st_shogun = "st-shogun",
+    st_shogun_s = "st-shogun-s",
+    st_shogun_m = "st-shogun-m",
+    st_shogun_sm = "st-shogun-sm",
+    st_shogun_l = "st-shogun-l",
+    st_shogun_sl = "st-shogun-sl",
+    st_shogun_ml = "st-shogun-ml",
+    st_shogun_sml = "st-shogun-sml",
      st_switch = "st-switch",
      st_switch_black = "st-switch_black",
      st_switch_white = "st-switch_white",

Modified: trunk/data/api2init.lua
===================================================================
--- trunk/data/api2init.lua	2008-08-13 12:01:32 UTC (rev 1265)
+++ trunk/data/api2init.lua	2008-08-13 21:44:47 UTC (rev 1266)
@@ -131,7 +131,12 @@
  SPOT_LIGHTPASSENGER =  16
  SPOT_TRAP           =  32

--- Follower
+-- shogun
+SHOGUN_S =  4
+SHOGUN_M =  8
+SHOGUN_L = 16
+
+-- follower
  FOLLOW_NO     = 0
  FOLLOW_SCROLL = 1
  FOLLOW_FLIP   = 2

Modified: trunk/data/models-2d.lua
===================================================================
--- trunk/data/models-2d.lua	2008-08-13 12:01:32 UTC (rev 1265)
+++ trunk/data/models-2d.lua	2008-08-13 21:44:47 UTC (rev 1266)
@@ -613,9 +613,9 @@

  -- it-shogun --
  do
-    NewAnim("it-shogun-s", {img="it-shogun-small", h=3, speed=160, 
pingpong=1, loop=1})
-    NewAnim("it-shogun-m", {img="it-shogun-med",   h=3, speed=160, 
pingpong=1, loop=1})
-    NewAnim("it-shogun-l", {img="it-shogun-big",   h=3, speed=160, 
pingpong=1, loop=1})
+    NewAnim("it_shogun_s", {img="it-shogun-small", h=3, speed=160, 
pingpong=1, loop=1})
+    NewAnim("it_shogun_m", {img="it-shogun-med",   h=3, speed=160, 
pingpong=1, loop=1})
+    NewAnim("it_shogun_l", {img="it-shogun-big",   h=3, speed=160, 
pingpong=1, loop=1})
  end

  -- it-springboard --

Modified: trunk/data/schemas/objects.xml
===================================================================
--- trunk/data/schemas/objects.xml	2008-08-13 12:01:32 UTC (rev 1265)
+++ trunk/data/schemas/objects.xml	2008-08-13 21:44:47 UTC (rev 1266)
@@ -37,6 +37,8 @@
      <attr name="min" type="double" default="0" rw="rw"/>
      <attr name="movable" type="bool" default="false" rw="rw"/>
      <attr name="name" type="string" default="nil" rw="rw"/>
+    <attr name="name_m" type="string" default="nil" rw="rw"/>
+    <attr name="name_s" type="string" default="nil" rw="rw"/>
      <attr name="nopaction" type="bool" default="false" rw="rw"/>
      <attr name="noshuffle" type="bool" default="false" rw="rw"/>
      <attr name="orientation" type="int" default="0" min="0" max="3" 
rw="rw"/>
@@ -85,6 +87,7 @@
      <msg name="_model_reanimated" type="nil"/>
      <msg name="_passed" type="nil"/>            <!-- check type-->
      <msg name="_performaction" type="nil"/>
+    <msg name="_shogun" type="int"/>
      <msg name="_spitter" type="nil"/>
      <msg name="_start" type="nil"/>
      <msg name="_trigger" type="bool"/>
@@ -169,6 +172,20 @@
        <msg name="_glasses"/>
        <msg name="_hit"/>
      </object>
+    <object name="it_shogun">
+      <attr name="state" max="16" default="4"/>
+      <msg name="_shogun"/>
+      <msg name="_init"/>
+    </object>
+    <object name="it_shogun_s">
+      <attr name="state" value="4"/>
+    </object>
+    <object name="it_shogun_m">
+      <attr name="state" value="8"/>
+    </object>
+    <object name="it_shogun_l">
+      <attr name="state" value="16"/>
+    </object>
      <object name="it_rubberband">
        <attr name="anchor2"/>
        <attr name="strength" default="10"/>
@@ -693,6 +710,38 @@
        <attr name="scissor" default="true"/>
      </object>
      <object name="st_scissors"/>
+    <object name="st_shogun">
+      <attr name="state" max="16"/>
+      <msg name="_shogun"/>
+      <msg name="_init"/>
+    </object>
+    <object name="st_shogun">
+      <attr name="name_m"/>
+      <attr name="name_s"/>
+      <attr name="state" max="16" default="4"/>
+      <msg name="_shogun"/>
+    </object>
+    <object name="st_shogun_s">
+      <attr name="state" value="4"/>
+    </object>
+    <object name="st_shogun_m">
+      <attr name="state" value="8"/>
+    </object>
+    <object name="st_shogun_sm">
+      <attr name="state" value="12"/>
+    </object>
+    <object name="st_shogun_l">
+      <attr name="state" value="16"/>
+    </object>
+    <object name="st_shogun_sl">
+      <attr name="state" value="20"/>
+    </object>
+    <object name="st_shogun_ml">
+      <attr name="state" value="24"/>
+    </object>
+    <object name="st_shogun_sml">
+      <attr name="state" value="28"/>
+    </object>
      <object name="st_switch">
        <attr name="color"/>
        <attr name="instant"/>

Modified: trunk/src/Makefile.am
===================================================================
--- trunk/src/Makefile.am	2008-08-13 12:01:32 UTC (rev 1265)
+++ trunk/src/Makefile.am	2008-08-13 21:44:47 UTC (rev 1266)
@@ -201,6 +201,8 @@
  	items/BlockerItem.hh	\
  	items/GlassesItem.cc	\
  	items/GlassesItem.hh	\
+	items/ShogunDot.cc	\
+	items/ShogunDot.hh	\
  	others/Other.cc		\
  	others/Other.hh		\
  	others/Rubberband.cc	\
@@ -255,6 +257,8 @@
  	stones/RubberbandStone.hh	\
  	stones/ScissorsStone.cc	\
  	stones/ScissorsStone.hh	\
+	stones/ShogunStone.cc	\
+	stones/ShogunStone.hh	\
  	stones/Switch.cc	\
  	stones/Switch.hh	\
  	stones/TimerStone.cc	\

Added: trunk/src/items/ShogunDot.cc
===================================================================
--- trunk/src/items/ShogunDot.cc	2008-08-13 12:01:32 UTC (rev 1265)
+++ trunk/src/items/ShogunDot.cc	2008-08-13 21:44:47 UTC (rev 1266)
@@ -0,0 +1,89 @@
+/*
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include "items/ShogunDot.hh"
+#include "stones/ShogunStone.hh"
+#include "errors.hh"
+//#include "main.hh"
+#include "world.hh"
+
+namespace enigma {
+
+    ShogunDot::ShogunDot(int initState) {
+        state = initState;
+    }
+
+    std::string ShogunDot::getClass() const {
+        return "it_shogun";
+    }
+
+    Value ShogunDot::message(const Message &m) {
+        if (m.message =="_init" ) {
+            if (SendMessage(GetStone(get_pos()), "_shogun", (state/2 
-1)*4).to_bool()) {
+                objFlags |= OBJBIT_ACTIVE;
+                if (server::EnigmaCompatibility < 1.10)
+                    performAction(true);
+            }
+        } else if (m.message =="_shogun" && server::WorldInitialized) {
+            if (!(objFlags & OBJBIT_ACTIVE) && ((state/2 -1)*4 == 
(int)m.value)) {  // shoguns s, sm, sml for dots s, m, l
+                performAction(true);
+                objFlags |= OBJBIT_ACTIVE;
+            } else if ((objFlags & OBJBIT_ACTIVE) && ((state/2 -1)*4 != 
(int)m.value)) {  // shoguns s, sm, sml for dots s, m, l
+                performAction(false);
+                objFlags &= ~OBJBIT_ACTIVE;
+            }
+            return Value();
+        }
+        return Item::message(m);
+    }
+
+    void ShogunDot::setState(int extState) {
+        ASSERT(extState == 16 || extState == 8 || extState == 4, 
XLevelRuntime,"");
+        state = extState;
+        if (isDisplayable()) {
+            init_model();
+        }
+    }
+
+    void ShogunDot::on_creation(GridPos p) {
+        if (server::WorldInitialized &&
+                SendMessage(GetStone(get_pos()), "_shogun", (state/2 
-1)*4).to_bool())
+            objFlags |= OBJBIT_ACTIVE;
+        Item::on_creation(p);
+    }
+
+    int ShogunDot::traitsIdx() const {
+        return state == 16 ? 2 : (state == 8 ? 1 : 0);
+    }
+
+
+    ItemTraits ShogunDot::traits[3] = {
+        { "it_shogun_s", it_shogun_s, itf_static, 0.0 },
+        { "it_shogun_m", it_shogun_m, itf_static, 0.0 },
+        { "it_shogun_l", it_shogun_l, itf_static, 0.0 }
+    };
+
+    BOOT_REGISTER_START
+        BootRegister(new ShogunDot(4), "it_shogun");
+        BootRegister(new ShogunDot(4), "it_shogun_s");
+        BootRegister(new ShogunDot(8), "it_shogun_m");
+        BootRegister(new ShogunDot(16), "it_shogun_l");
+    BOOT_REGISTER_END
+
+} // namespace enigma


Property changes on: trunk/src/items/ShogunDot.cc
___________________________________________________________________
Name: svn:eol-style
    + native

Added: trunk/src/items/ShogunDot.hh
===================================================================
--- trunk/src/items/ShogunDot.hh	2008-08-13 12:01:32 UTC (rev 1265)
+++ trunk/src/items/ShogunDot.hh	2008-08-13 21:44:47 UTC (rev 1266)
@@ -0,0 +1,56 @@
+/*
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef SHOGUNDOTITEM_HH
+#define SHOGUNDOTITEM_HH
+
+#include "items.hh"
+
+#include "enigma.hh"
+
+namespace enigma {
+    /**
+     */
+    class ShogunDot : public Item {
+        CLONEOBJ(ShogunDot);
+        DECL_ITEMTRAITS_ARRAY(3, traitsIdx());
+
+    private:
+        enum ObjectPrivatFlagsBits {
+            OBJBIT_ACTIVE =   1<<24,   ///<
+        };
+    public:
+        ShogunDot(int initState);
+
+        // Object interface
+        virtual std::string getClass() const;
+        virtual Value message(const Message &m);
+
+        // GridObject interface
+        virtual void on_creation(GridPos p);
+
+        // StateObject interface
+        virtual void setState(int extState);
+
+    private:
+        int traitsIdx() const;
+    };
+
+} // namespace enigma
+
+#endif


Property changes on: trunk/src/items/ShogunDot.hh
___________________________________________________________________
Name: svn:eol-style
    + native

Modified: trunk/src/items.cc
===================================================================
--- trunk/src/items.cc	2008-08-13 12:01:32 UTC (rev 1265)
+++ trunk/src/items.cc	2008-08-13 21:44:47 UTC (rev 1266)
@@ -665,7 +665,7 @@
      }

      std::string Coin::getClass() const {
-        return "Coin";
+        return "it_coin";
      }

      void Coin::setState(int extState) {
@@ -1673,83 +1673,6 @@
  }


-/* -------------------- Shogun dot -------------------- */
-
-/** \page it-shogun Shogun Dot
-
-\subsection shogundota Attributes
-- \b size:            1..3  (smallest..largest)
-- \b target, \b action:   as usual
-*/
-namespace
-{
-    class ShogunDot : public Item {
-        CLONEOBJ(ShogunDot);
-        DECL_ITEMTRAITS_ARRAY(3, subtype);
-    public:
-        static void setup() {
-            RegisterItem (new ShogunDot(SMALL));
-            RegisterItem (new ShogunDot(MEDIUM));
-            RegisterItem (new ShogunDot(LARGE));
-        }
-    private:
-        enum SubType { SMALL, MEDIUM, LARGE };
-        ShogunDot(SubType size);
-
-        virtual Value message(const Message &m);
-        void stone_change(Stone *st);
-
-        // Variables.
-        bool activated;
-        SubType subtype;
-    };
-
-    ItemTraits ShogunDot::traits[3] = {
-        { "it-shogun-s", it_shogun_s, itf_static, 0.0 },
-        { "it-shogun-m", it_shogun_m, itf_static, 0.0 },
-        { "it-shogun-l", it_shogun_l, itf_static, 0.0 }
-    };
-}
-
-ShogunDot::ShogunDot (SubType size)
-: activated(false), subtype(size)
-{
-}
-
-void ShogunDot::stone_change(Stone *st) {
-    if (activated) {
-        if (st == 0) {
-            warning("stone_change: Stone disappeared w/o sending me a 
proper message!");
-            activated = false;
-            performAction(false);
-        }
-    }
-}
-
-Value ShogunDot::message(const Message &m) {
-    if (m.message == "noshogun") {
-        if (activated) {
-            activated = false;
-            performAction(false);
-        }
-        return Value();
-    } else {
-        const char *s = m.message.c_str();
-        bool size_matches =
-            (strncmp(s, "shogun", 6) == 0)    &&
-            ((s[6]-'1')              == subtype) &&
-            (s[7] == 0);
-
-        if (size_matches != activated) {
-            activated = size_matches;
-            performAction(activated);
-            return Value();
-        }
-    }
-    return Item::message(m);
-}
-
-
  /* -------------------- Magnet -------------------- */

      class Magnet : public Item, public ForceField {
@@ -3922,7 +3845,6 @@
      RegisterItem (new SeedNowood);
      RegisterItem (new SeedVolcano);
      Sensor::setup();
-    ShogunDot::setup();
      RegisterItem (new Spade);
      RegisterItem (new Spoon);
      RegisterItem (new Spring1);

Modified: trunk/src/ox_extra.cc
===================================================================
--- trunk/src/ox_extra.cc	2008-08-13 12:01:32 UTC (rev 1265)
+++ trunk/src/ox_extra.cc	2008-08-13 21:44:47 UTC (rev 1266)
@@ -218,7 +218,7 @@
      UNUSED,              // OxydExtra stone 0x63
      "st_coinslot_instant", // OxydExtra stone 0x64
      "st-thief",          // OxydExtra stone 0x65
-    "st-shogun-s",       // OxydExtra stone 0x66
+    "st_shogun_s",       // OxydExtra stone 0x66
      UNUSED,              // OxydExtra stone 0x67
      UNUSED,              // OxydExtra stone 0x68
      UNUSED,              // OxydExtra stone 0x69
@@ -351,7 +351,7 @@
      UNUSED,                  // OxydExtra item 0x28
      UNUSED,                  // OxydExtra item 0x29
      "it_sensor",                  // OxydExtra item 0x2a
-    "it-shogun-s",                // OxydExtra item 0x2b
+    "it_shogun_s",                // OxydExtra item 0x2b
      UNUSED,                  // OxydExtra item 0x2c
      "it_vortex_open",             // OxydExtra item 0x2d
      UNUSED,                  // OxydExtra item 0x2e

Modified: trunk/src/ox_magnum.cc
===================================================================
--- trunk/src/ox_magnum.cc	2008-08-13 12:01:32 UTC (rev 1265)
+++ trunk/src/ox_magnum.cc	2008-08-13 21:44:47 UTC (rev 1266)
@@ -224,7 +224,7 @@
      "st-flash",                 // OxydMagnum stone 0x69
      "st_coinslot_instant",      // OxydMagnum stone 0x6a
      "st-thief",                 // OxydMagnum stone 0x6b
-    "st-shogun-s",              // OxydMagnum stone 0x6c
+    "st_shogun_s",              // OxydMagnum stone 0x6c
      "st-stoneimpulse",          // OxydMagnum stone 0x6d
      "st_laserflop",             // OxydMagnum stone 0x6e
      "st-mail-n",                // OxydMagnum stone 0x6f
@@ -334,7 +334,7 @@
      "it_magnet_off",    // OxydMagnum item 0x29
      "it_inversesensor", // OxydMagnum item 0x2a
      "it_sensor",        // OxydMagnum item 0x2b
-    "it-shogun-s",      // OxydMagnum item 0x2c
+    "it_shogun_s",      // OxydMagnum item 0x2c
      "it_vortex_open",   // OxydMagnum item 0x2d
      "it_vortex_closed", // OxydMagnum item 0x2e
      "it_wormhole_on",   // OxydMagnum item 0x2f

Modified: trunk/src/ox_oxyd1.cc
===================================================================
--- trunk/src/ox_oxyd1.cc	2008-08-13 12:01:32 UTC (rev 1265)
+++ trunk/src/ox_oxyd1.cc	2008-08-13 21:44:47 UTC (rev 1266)
@@ -256,7 +256,7 @@
      "st-flash",                 // Oxyd1 stone 0x69
      "st_coinslot_instant",      // Oxyd1 stone 0x6a
      "st-thief",                 // Oxyd1 stone 0x6b
-    "st-shogun-s",              // Oxyd1 stone 0x6c
+    "st_shogun_s",              // Oxyd1 stone 0x6c
      "st-stoneimpulse",          // Oxyd1 stone 0x6d
      "st_laserflop",             // Oxyd1 stone 0x6e
      "st-mail-n",                // Oxyd1 stone 0x6f
@@ -350,7 +350,7 @@
      "it_magnet_off",              // 0x29
      "it_inversesensor",           // 0x2a
      "it_sensor",                  // 0x2b
-    "it-shogun-s",                // 0x2c
+    "it_shogun_s",                // 0x2c
      "it_vortex_open",             // 0x2d
      "it_vortex_closed",           // 0x2e
      "it_wormhole_on",             // 0x2f

Modified: trunk/src/ox_peroxyd.cc
===================================================================
--- trunk/src/ox_peroxyd.cc	2008-08-13 12:01:32 UTC (rev 1265)
+++ trunk/src/ox_peroxyd.cc	2008-08-13 21:44:47 UTC (rev 1266)
@@ -283,20 +283,20 @@
      "st-puzzle-hollow",         // PerOxyd stone 0x5c
      "st-laserbreak",            // PerOxyd stone 0x5d
      "st-coffee",                // PerOxyd stone 0x5e
-    "st-shogun",                // PerOxyd stone 0x5f (oxyd with a 
hole, movable ... strange stone! st-shogun as workaround, only link 
level 74)
+    "st_shogun",                // PerOxyd stone 0x5f (oxyd with a 
hole, movable ... strange stone! st-shogun as workaround, only link 
level 74)
      "st-disco-dark",            // PerOxyd stone 0x60
      "st-disco-medium",          // PerOxyd stone 0x61
      "st-bombs",                 // PerOxyd stone 0x62
      "st-flash",                 // PerOxyd stone 0x63
      "st_coinslot_instant",      // PerOxyd stone 0x64
      "st-thief",                 // PerOxyd stone 0x65
-    "st-shogun-s",              // PerOxyd stone 0x66
-    "st-shogun-m",              // PerOxyd stone 0x67
-    "st-shogun-l",              // PerOxyd stone 0x68
-    "st-shogun-sml",            // PerOxyd stone 0x69
-    "st-shogun-ml",             // PerOxyd stone 0x6a
-    "st-shogun-sl",             // PerOxyd stone 0x6b
-    "st-shogun-sm",             // PerOxyd stone 0x6c
+    "st_shogun_s",              // PerOxyd stone 0x66
+    "st_shogun_m",              // PerOxyd stone 0x67
+    "st_shogun_l",              // PerOxyd stone 0x68
+    "st_shogun_sml",            // PerOxyd stone 0x69
+    "st_shogun_ml",             // PerOxyd stone 0x6a
+    "st_shogun_sl",             // PerOxyd stone 0x6b
+    "st_shogun_sm",             // PerOxyd stone 0x6c
      "st-stoneimpulse",          // PerOxyd stone 0x6d
      "st_laserflop",             // PerOxyd stone 0x6e
      "st-mail-n",                // PerOxyd stone 0x6f
@@ -422,8 +422,8 @@
      "it_magnet_off",              // 0x28
      "it_sensor_filter0",          // 0x29
      "it_sensor_filter1",          // 0x2a
-    "it-shogun-s",                // 0x2b
-    "it-shogun-l",                // 0x2c
+    "it_shogun_s",                // 0x2b
+    "it_shogun_l",                // 0x2c
      "it_vortex_open",             // 0x2d
      "it_vortex_closed",           // 0x2e
      "it_wormhole_on",             // 0x2f XXX

Added: trunk/src/stones/ShogunStone.cc
===================================================================
--- trunk/src/stones/ShogunStone.cc	2008-08-13 12:01:32 UTC (rev 1265)
+++ trunk/src/stones/ShogunStone.cc	2008-08-13 21:44:47 UTC (rev 1266)
@@ -0,0 +1,227 @@
+/*
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include "stones/ShogunStone.hh"
+#include "errors.hh"
+//#include "main.hh"
+#include "server.hh"
+#include "world.hh"
+
+namespace enigma {
+    ShogunStone::ShogunStone(int initState) : Stone () {
+        state = initState;
+    }
+
+    ShogunStone* ShogunStone::clone() {
+        return new ShogunStone(*this);
+    }
+
+    void ShogunStone::dispose() {
+         if (subShogun != NULL) {
+            SendMessage(subShogun, "disconnect");
+            DisposeObject(subShogun);
+         }
+         subShogun = NULL;
+         superShogun = NULL;
+         delete this;
+    }
+
+    std::string ShogunStone::getClass() const {
+        return "st_shogun";
+    }
+
+    Value ShogunStone::message(const Message &m) {
+        if (m.message == "kill") {
+            if (yieldShogun()) {
+                SendMessage(this, "disconnect");
+                DisposeObject(this);
+            }
+            return Value();
+        } else if (m.message =="_shogun") {
+            return m.value == state;
+        }
+            return Stone::message(m);
+    }
+
+    void ShogunStone::setState(int extState) {
+        if (!isDisplayable())
+            Stone::setState(extState & 28);   // just not yet set 
shoguns with legal values
+    }
+
+    void ShogunStone::init_model() {
+        set_model(ecl::strf("st-shogun%d", state/4));
+    }
+
+    void ShogunStone::setOwnerPos(GridPos po) {
+        Stone::setOwnerPos(po);
+        if (subShogun != NULL)
+            subShogun->setOwnerPos(po);
+    }
+
+    void ShogunStone::on_creation(GridPos p) {
+        Stone::on_creation(p);
+        if (subShogun != NULL)
+            // swap or pull based new grid positioning of a shogun stack
+            subShogun->setOwnerPos(p);
+        else if (state != ownHole()) {
+            // initial set of a new shogun stack
+            int subState = state & ~ownHole();
+            if (subState & 8) {
+                ShogunStone *s = dynamic_cast<ShogunStone 
*>(MakeObject("st_shogun_m"));
+                subShogun = s;
+                s->superShogun = this;
+                s->setOwnerPos(p);
+                s->state = subState;
+                subState &= ~8;
+                if (Value v = getAttr("name_m"))
+                    NameObject(s, v.to_string());
+            }
+            if (subState & 4) {
+                ShogunStone *s = dynamic_cast<ShogunStone 
*>(MakeObject("st_shogun_s"));
+                if (subShogun == NULL) {
+                    subShogun = s;
+                    s->superShogun = this;
+                } else {
+                    subShogun->subShogun = s;
+                    s->superShogun = subShogun;
+                }
+                if (Value v = getAttr("name_s"))
+                    NameObject(s, v.to_string());
+                s->setOwnerPos(p);
+            }
+        }
+        SendMessage(GetItem(p), "_shogun", state);
+    }
+
+    void ShogunStone::on_removal(GridPos p) {
+        SendMessage(GetItem(p), "_shogun", 0);
+        if (subShogun != NULL)
+            subShogun->setOwnerPos(GridPos(-1,-1));
+        Stone::on_removal(p);
+    }
+
+    void ShogunStone::on_impulse(const Impulse& impulse) {
+        static char * soundevent = "movesmall";
+
+        if (!impulse.byWire && subShogun != NULL) {
+            subShogun->on_impulse(impulse);
+            return;
+        }
+        GridPos newPos = move(getOwnerPos(), impulse.dir);
+        Stone * st = GetStone(newPos);
+        ShogunStone *nss = NULL;
+        bool fitsNeighborShogun = false;
+        if (st != NULL) {
+            nss = dynamic_cast<ShogunStone *>(st);
+            if (nss != NULL)
+                fitsNeighborShogun = (nss->state & (2*ownHole() -1)) == 0;
+        }
+
+        if ((st == NULL) || fitsNeighborShogun) {  // can we move?
+            // first remove from current position
+            if (!yieldShogun())
+                return;            // being swapped or pulled
+
+            sound_event(soundevent);
+
+            // then put to new position
+            if (st == NULL) {
+                SetStone(newPos, this);
+                SendMessage(GetItem(newPos), "_shogun", state);
+            } else {
+                // register our hole to all super shoguns
+                ShogunStone *s = nss;
+                for (; s->subShogun != NULL; s = s->subShogun) {
+                    s->state |= ownHole();
+                }
+                // register ourself to smallest shogun
+                s->state |= ownHole();
+                s->subShogun = this;
+                superShogun = s;
+
+                nss->init_model();     // display new hole
+                SendMessage(GetItem(newPos), "_shogun", nss->state);
+                setOwnerPos(newPos);   // the stone is owned at the new 
position
+            }
+
+            server::IncMoveCounter();
+            ShatterActorsInsideField(newPos);
+        }
+        propagateImpulse(impulse);
+    }
+
+    int ShogunStone::ownHole() {
+        return (state >= 16) ? 16 : ((state >= 8) ? 8 : 4);
+    }
+
+    bool ShogunStone::yieldShogun() {
+        if (isDisplayable() && subShogun == NULL) {
+            YieldStone(get_pos());
+            SendMessage(GetItem(get_pos()), "_shogun", 0);
+        } else if (isDisplayable()) {
+            // top most shogun moved by wire or killed
+            GridPos oldPos = get_pos();
+            YieldStone(oldPos);
+            subShogun->superShogun = NULL;
+            SetStone(oldPos, subShogun);
+            SendMessage(GetItem(oldPos), "_shogun", subShogun->state);
+            subShogun = NULL;
+            state = ownHole();
+        } else {
+            // a sub shogun
+            ShogunStone *oss = dynamic_cast<ShogunStone 
*>(GetStone(getOwnerPos()));
+            if (oss == NULL)   // we are swapped or pulled and impulsed 
by wire
+                return false;        // forget impulse
+
+            ASSERT(superShogun != NULL, XLevelRuntime, "Shogun: missing 
super shogun");
+            superShogun->subShogun = subShogun;
+            superShogun->state &= ~ownHole();
+            if (ShogunStone *superSuperShogun = superShogun->superShogun) {
+                superSuperShogun->state &= ~ownHole();
+                superSuperShogun->init_model();
+                SendMessage(GetItem(getOwnerPos()), "_shogun", 
superSuperShogun->state);
+            } else
+                superShogun->init_model();
+                SendMessage(GetItem(getOwnerPos()), "_shogun", 
superShogun->state);
+            if (subShogun != NULL) subShogun->superShogun = superShogun;
+            superShogun = NULL;
+            subShogun = NULL;
+            state = ownHole();
+        }
+        return true;
+    }
+
+    FreezeStatusBits ShogunStone::get_freeze_bits() {
+        return (state == 4) ? FREEZEBIT_STANDARD : FREEZEBIT_NO_STONE;
+    }
+
+    DEF_TRAITSM(ShogunStone, "st_shogun", st_shogun, MOVABLE_IRREGULAR);
+
+    BOOT_REGISTER_START
+        BootRegister(new ShogunStone(4), "st_shogun");
+        BootRegister(new ShogunStone(4), "st_shogun_s");
+        BootRegister(new ShogunStone(8), "st_shogun_m");
+        BootRegister(new ShogunStone(12), "st_shogun_sm");
+        BootRegister(new ShogunStone(16), "st_shogun_l");
+        BootRegister(new ShogunStone(20), "st_shogun_sl");
+        BootRegister(new ShogunStone(24), "st_shogun_ml");
+        BootRegister(new ShogunStone(28), "st_shogun_sml");
+    BOOT_REGISTER_END
+
+} // namespace enigma


Property changes on: trunk/src/stones/ShogunStone.cc
___________________________________________________________________
Name: svn:eol-style
    + native

Added: trunk/src/stones/ShogunStone.hh
===================================================================
--- trunk/src/stones/ShogunStone.hh	2008-08-13 12:01:32 UTC (rev 1265)
+++ trunk/src/stones/ShogunStone.hh	2008-08-13 21:44:47 UTC (rev 1266)
@@ -0,0 +1,76 @@
+/*
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef SHOGUNSTONE_HH
+#define SHOGUNSTONE_HH
+
+#include "stones.hh"
+
+#include "stones_internal.hh"
+
+namespace enigma {
+
+    /**
+     *
+     */
+    class ShogunStone : public Stone {
+        DECL_TRAITS;
+
+    public:
+        enum Hole {
+            N         =  1,   ///<  Nano - not yet existing
+            T         =  2,   ///<  Tiny - not yet existing
+            S         =  4,   ///<  Small
+            M         =  8,   ///<  Medium
+            L         = 16,   ///<  Large
+            G         = 32,   ///<  Giant
+            U         = 64    ///<  Universal
+        };
+
+        ShogunStone(int initState);
+        ShogunStone* clone();
+        void dispose();
+
+        // Object interface
+        virtual std::string getClass() const;
+        virtual Value message(const Message &m);
+
+        // StateObject interface
+        virtual void setState(int extState);
+
+        // GridObject interface
+        virtual void init_model();
+        virtual void setOwnerPos(GridPos po);
+        virtual void on_creation(GridPos p);
+        virtual void on_removal(GridPos p);
+
+        // Stone interface
+        virtual void on_impulse(const Impulse& impulse);
+        virtual FreezeStatusBits get_freeze_bits();
+
+    private:
+        ShogunStone *superShogun;
+        ShogunStone *subShogun;
+
+        int ownHole();
+        bool yieldShogun();
+    };
+
+} // namespace enigma
+
+#endif


Property changes on: trunk/src/stones/ShogunStone.hh
___________________________________________________________________
Name: svn:eol-style
    + native

Modified: trunk/src/stones.cc
===================================================================
--- trunk/src/stones.cc	2008-08-13 12:01:32 UTC (rev 1265)
+++ trunk/src/stones.cc	2008-08-13 21:44:47 UTC (rev 1266)
@@ -133,18 +133,22 @@
     Note: This should be used by on_impulse() to perform a move.
  */
  bool Stone::move_stone(GridPos newPos, const char *soundevent) {
-    GridPos p      = get_pos();
-
-    if (!GetStone(newPos)) {
-        sound_event (soundevent);
-
-        MoveStone(p, newPos);
-        server::IncMoveCounter();
-
-        on_move();
-        if (Item *it = GetItem(newPos)) it->on_stonehit(this);
-
-        return true;
+    if (isDisplayable()) {
+        GridPos p      = get_pos();
+
+        if (!GetStone(newPos)) {
+            sound_event (soundevent);
+
+            MoveStone(p, newPos);
+            server::IncMoveCounter();
+
+            on_move();
+            if (Item *it = GetItem(newPos))
+                it->on_stonehit(this);
+
+            return true;
+        }
+        return false;
      }
      return false;
  }
@@ -447,6 +451,7 @@

  void YieldedGridStone::dispose()
  {
+    SendMessage(stone, "disconnect");
      stone->dispose();
      delete model;
      stone = 0;

Modified: trunk/src/stones_complex.cc
===================================================================
--- trunk/src/stones_complex.cc	2008-08-13 12:01:32 UTC (rev 1265)
+++ trunk/src/stones_complex.cc	2008-08-13 21:44:47 UTC (rev 1266)
@@ -962,160 +962,6 @@
  }


-/* -------------------- ShogunStone -------------------- */
-
-// Attributes:
-//
-// :holes            1..7
-namespace
-{
-    class ShogunStone : public Stone {
-        CLONEOBJ(ShogunStone);
-        DECL_TRAITS;
-
-        enum Holes { SMALL = 1, MEDIUM = 2, LARGE = 4};
-        static Holes smallest_hole(Holes s);
-        void set_holes(Holes h) { setAttr("holes", h); }
-
-    public:
-        ShogunStone(int holes=SMALL) {
-            set_holes(static_cast<Holes>(holes));
-        }
-    private:
-        Holes get_holes() const;
-        void notify_item();
-
-        virtual Value message(const Message &m) {
-            if (m.message == "_init") { // request from ShogunDot (if 
set _after_ ShogunStone)
-                notify_item();
-                return Value();
-            }
-            return Stone::message(m);
-        }
-
-        void add_hole(Holes h) {
-            setAttr("holes", get_holes() | h);
-            init_model();
-            notify_item();
-        }
-
-        void on_creation (GridPos p) {
-            init_model();
-            notify_item();
-        }
-
-        void on_removal(GridPos p) {
-            Stone::on_removal(p);
-            if (Item *it = GetItem(p))
-                SendMessage(it, "noshogun");
-        }
-
-        void on_impulse(const Impulse& impulse);
-
-        void init_model() {
-            set_model(ecl::strf("st-shogun%d", int(get_holes())));
-        }
-
-        void actor_hit (const StoneContact &sc) {
-            maybe_push_stone (sc);
-        }
-
-        FreezeStatusBits get_freeze_bits() {
-            return (get_holes() == SMALL) ? FREEZEBIT_STANDARD : 
FREEZEBIT_NO_STONE;
-        }
-    };
-    DEF_TRAITSM(ShogunStone, "st-shogun", st_shogun, MOVABLE_IRREGULAR);
-}
-
-ShogunStone::Holes ShogunStone::get_holes() const {
-    int h = getAttr("holes");
-    if (h>=1 && h<=7)
-        return Holes(h);
-    else {
-        warning("Wrong 'holes' attribute (%i)", h);
-        return SMALL;
-    }
-}
-
-ShogunStone::Holes ShogunStone::smallest_hole(Holes s) {
-    if (s & SMALL) return SMALL;
-    if (s & MEDIUM) return MEDIUM;
-    if (s & LARGE) return LARGE;
-    throw XLevelRuntime ("ShogunStone: internal error");
-}
-
-void ShogunStone::notify_item ()
-{
-    if (Item *it = GetItem(get_pos())) {
-        switch (get_holes()) {
-        case SMALL:                    SendMessage(it, "shogun1"); break;
-        case (MEDIUM | SMALL):         SendMessage(it, "shogun2"); break;
-        case (LARGE | MEDIUM | SMALL): SendMessage(it, "shogun3"); break;
-        default:                       SendMessage(it, "noshogun"); break;
-        }
-    }
-}
-
-void ShogunStone::on_impulse(const Impulse& impulse) {
-    GridPos destpos     = move(get_pos(), impulse.dir);
-    Holes holes         = get_holes();
-    Holes smallest      = smallest_hole(holes);
-    ShogunStone *target = 0;
-
-    if (Stone *st = GetStone(destpos)) {
-        target = dynamic_cast<ShogunStone*>(st);
-
-        /* If the stone at `p' is not a shogun stone or if smallest hole
-           does not fit into target, do not transfer the smallest hole. */
-        if (!target || smallest >= smallest_hole(target->get_holes()))
-            return;
-    }
-
-    /* It's important to remove the old stone before setting the new
-       one: otherwise it is possible to activate two triggers with one
-       shogun stone when shifting from one shogun target to a second
-       adjacent shogun target. */
-
-    GridPos my_pos = get_pos();
-    string  old_name;
-
-    // Remove/modify source stone:
-    if (Holes newholes = Holes(holes & ~smallest)) {
-        set_holes(newholes);
-        init_model();
-        notify_item();
-    }
-    else {
-        if (Value v = getAttr("name")) old_name = v.get_string(); // 
store name of disappearing stone
-        SendMessage(GetItem(my_pos), "noshogun");
-        KillStone(my_pos);
-    }
-
-    // Modify/create target stone:
-    if (target) {
-        target->add_hole(smallest);
-//         target->sound_event("st-magic");
-//         sound::PlaySound("st-magic", my_pos.center()); // object 
already disappeared
-    }
-    else {                       // create new
-        target = new ShogunStone(smallest);
-        int targetId = target->getId();
-        SetStone(destpos, target);
-        // Shogunstone might have disappeared via some triggered action.
-        // Most important example: Last box in a sokoban.
-        if (Stone *st = GetStone(destpos))
-            if (st->getId() == targetId)
-                st->on_move();
-    }
-
-    if (!old_name.empty())
-        NameObject(target, old_name);
-
-    server::IncMoveCounter();
-    sound::EmitSoundEvent ("movesmall", my_pos.center());
-}
-
-
  /* -------------------- Stone impulse stones -------------------- */

  // Messages:
@@ -1535,15 +1381,6 @@
      Register("st-puzzle2-esw", new PuzzleStone(8, true));
      Register("st-puzzle2-nesw", new PuzzleStone(16, true));

-    Register(new ShogunStone);
-    Register("st-shogun-s", new ShogunStone(1));
-    Register("st-shogun-m", new ShogunStone(2));
-    Register("st-shogun-sm", new ShogunStone(3));
-    Register("st-shogun-l", new ShogunStone(4));
-    Register("st-shogun-sl", new ShogunStone(5));
-    Register("st-shogun-ml", new ShogunStone(6));
-    Register("st-shogun-sml", new ShogunStone(7));
-
      Register(new StoneImpulseStone);

  }

Modified: trunk/src/world.cc
===================================================================
--- trunk/src/world.cc	2008-08-13 12:01:32 UTC (rev 1265)
+++ trunk/src/world.cc	2008-08-13 21:44:47 UTC (rev 1266)
@@ -103,9 +103,13 @@

  Field::~Field()
  {
+    // the field should be empty at this point, but for security 
reasons ...
+    DisposeObject(stone);
+    stone = NULL;
+    DisposeObject(item);
+    item = NULL;
      DisposeObject(floor);
-    DisposeObject(item);
-    DisposeObject(stone);
+    floor = NULL;
  }


@@ -230,13 +234,25 @@

  World::~World()
  {
-    fields = FieldArray(0,0);
-    for_each(actorlist.begin(), actorlist.end(), mem_fun(&Actor::dispose));
+    // remove wires, rubberbands first, as they disconnect from other 
objects
      while (!others.empty()) {
          Other *ot = others.back();
          others.pop_back();
          ot->dispose();
      }
+    // dispose all grid objects without removing them to avoid side effects
+    // keep the field array still valid for arbitrary access
+    for (FieldArray::iterator itr = fields.begin(); itr != 
fields.end(); ++itr) {
+        DisposeObject((*itr).stone);
+        (*itr).stone = NULL;
+        DisposeObject((*itr).item);
+        (*itr).item = NULL;
+        DisposeObject((*itr).floor);
+        (*itr).floor = NULL;
+    }
+    // reset the fields
+    fields = FieldArray(0,0);
+    for_each(actorlist.begin(), actorlist.end(), mem_fun(&Actor::dispose));
  }

  bool World::is_border(const GridPos &p) {
@@ -1558,9 +1574,9 @@
  void WorldPrepareLevel ()
  {
      GameTimer.clear();
-    GridObject::prepareLevel();
-    LaserBeam::prepareLevel();
-    Resize (20, 13);
+    Resize (20, 13);             // delete old world with all its objects
+    GridObject::prepareLevel();  // clear lists of no longer existing 
objects
+    LaserBeam::prepareLevel();   // clear lists of no longer existing 
objects
  }

  bool WorldInitLevel()
@@ -1953,7 +1969,8 @@
  void KillFloor(GridPos p)
  {
      level->fl_layer.kill(p);
-    lua::SetDefaultFloor(lua::LevelState(), p.x, p.y);
+    if (server::EnigmaCompatibility >= 1.10)
+        lua::SetDefaultFloor(lua::LevelState(), p.x, p.y);
  }

  Floor *GetFloor(GridPos p)


From andreasl at mail.berlios.de  Wed Aug 20 19:35:21 2008
From: andreasl at mail.berlios.de (andreasl at mail.berlios.de)
Date: Wed, 20 Aug 2008 19:35:21 +0200
Subject: [Enigma-game-svn] r1276 - in homepage: images/articles input
	input/articles input/lotm
Message-ID: <200808201735.m7KHZLrq003439@sheep.berlios.de>

Author: andreasl
Date: 2008-08-20 19:35:16 +0200 (Wed, 20 Aug 2008)
New Revision: 1276

Added:
   homepage/images/articles/level_andreas11_a.png
   homepage/images/articles/level_andreas11_b.png
   homepage/input/articles/level_andreas11.html
Modified:
   homepage/input/articles/apprentice_1.html
   homepage/input/lotm/lotm_archive_data.lua
   homepage/input/output-files.lua
Log:
Homepage:
 - First independent level article: "Patterns of Impulse"
 - Corrections to apprentice_1 by Clifford
Note:
 - Column titles/structure are not final
Todo:
 - Russian and German translation
 - Upload of andreas11_a
 - Note about independent level articles, e.g. in infobox
 - Validation


Added: homepage/images/articles/level_andreas11_a.png
===================================================================
(Binary files differ)


Property changes on: homepage/images/articles/level_andreas11_a.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: homepage/images/articles/level_andreas11_b.png
===================================================================
(Binary files differ)


Property changes on: homepage/images/articles/level_andreas11_b.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Modified: homepage/input/articles/apprentice_1.html
===================================================================
--- homepage/input/articles/apprentice_1.html	2008-08-17 13:32:50 UTC (rev 1275)
+++ homepage/input/articles/apprentice_1.html	2008-08-20 17:35:16 UTC (rev 1276)
@@ -1,26 +1,27 @@
 
-<h2>The Apprentice &mdash; &quot;You are welcome&quot;</h2>
+<h2>The Apprentice &mdash; &quot;We welcome you&quot;</h2>
 
 <p>
-Interested friends who ask me, what's about Enigma, what is it
-&quot;like&quot;, whether the game is &quot;worth the while&quot;, all these
-many levels &hellip; I say to them: Be glad, you still have all of them to
+Interested friends ask me, what is Enigma like? Is a game with all those many
+levels worthwhile? &hellip; I say to them: Be glad, you still have all of them to
 play! The apprentice looks perplexed at the first twelve &quot;previews&quot;
-of the opened level pack and starts &quot;Welcome&quot;&mdash;and opens
-&quot;his&quot; first oxyds, still unsure in the handling of the marble that
-now is under his thumb. Was this all? Yes&mdash;Level finished. So easy?
+of the opened level pack and begins playing &quot;Welcome&quot;&mdash;and opens
+&quot;his&quot; first oxyds, still unsure of the handling of the marble that
+is now under his thumb. Was that it!? Yes&mdash;Level finished. That easy?
 Yes&mdash;in some respect every level is a &quot;Welcome&quot;-level &hellip;
-with more or less obstacles! Light up the oxyds&mdash;and, as a diversion,
-meditate in &quot;meditation levels&quot;: make &quot;the&quot; marble
-&quot;stay&quot;. The preview shows the apprentice, still lucky about the
+with more or fewer obstacles! Light up the oxyds&mdash;and, as a diversion,
+meditate in &quot;meditation levels&quot;: make the marble
+&quot;stay put&quot;. The preview shows the apprentice, still basking in the
+glow of the
 solved &quot;Welcome&quot;, that every enclosed level differs in color,
-composition, shape &hellip;, and at the latest during the first contact with
-the &quot;death's-head&quot; it realises &quot;landscapes&quot; of varying
-challenge, menaces, that seem limitless in their evolution: Over 1000 levels!
-And then he sees: Yes&mdash;I &quot;know&quot; the level = x% solved, but there
-is still much to do&mdash;fortunately! And thanks to all those that made this
-possible. And maybe, some day, he starts to &quot;make it possible&quot; as
-well: You are welcome!
+composition, shape &hellip;, and during his first contact with
+the &quot;death's-head&quot; he experiences &quot;landscapes&quot; that present
+varying degrees of challenge, perils, that seem limitless in their evolution:
+Over 1000 levels!
+And then he realises: Yes&mdash;I know that completing this level means x% of
+them solved, but there is still much to do&mdash;fortunately! And thanks to all
+those that made this possible. And maybe, some day, he starts to &quot;make it
+possible&quot; as well: We welcome you!
 </p>
 
 <p><i>

Added: homepage/input/articles/level_andreas11.html
===================================================================
--- homepage/input/articles/level_andreas11.html	2008-08-17 13:32:50 UTC (rev 1275)
+++ homepage/input/articles/level_andreas11.html	2008-08-20 17:35:16 UTC (rev 1276)
@@ -0,0 +1,245 @@
+<div class="lotm">
+
+In our first independent level article, we want to talk about and look behind
+the curtains of &quot;Patterns of Impulse&quot; (IV/44). Have fun with a
+comment from Alain and one from the author!
+
+<h2 class="lotm">My level of the moment</h2>
+
+<div class="quote">
+I recently came across &quot;Patterns of Impulse&quot;,
+which is not the kind of levels I like usually (not calm enough for me)
+but trying to solve it gave me a very good surprise, that I will try to
+explain here:
+</div>
+
+<div class="quote">
+After having laughed at the show made by the impulse stones moving frantically
+(look also at &quot;Stay There!&quot; or &quot;Bendixxon&quot;, the last one
+witout impulse-stones), I suddenly
+discovered the mystical truth about this level:
+<span style="blue">It illustrates almost perfectly L. Boltzmann's kinetic
+theory of thermodynamics</span>!
+</div>
+
+<div class="quote">
+Howzsat? Well, just imagine the impulse-stones are moving particles
+(the free path anyway is not much: less than one unit length, wiz the
+length of a cell in the landscape) which constitute an amorph solid at
+the beginning of the level: Nothing moves so that the initial
+temperature is the absolute zero. Then comes Blackball who caresses
+slightly one of the impulse stones, and suddenly everything explodes!
+This can be interpreted as the solid suddenly melting (the fluid is not
+compressible enough to be a gas, but rather a liquid) and if ever
+Blackball tries to swim into this liquid, a brownian motion crashes
+him, so he'd better stay in one of the shelters. Finally after some
+time (and some help from Blackball here and there) the fluid cools down
+and freezes again, keeping a cristallike structure (more on this later)
+and freeing a path (hopefully) to the oxyd stones &hellip;
+</div>
+
+<div class="quote">
+Usually, playing an Enigma level is being always active, and often
+rapid, which requires a lot of concentration and does not really let
+the player see what happens. But for this level, during the cooling of
+the fluid, one can observe several interesting phenomena:
+</div>
+
+<div class="quote">
+When two impulse stones meet, say one moving to the right and the other
+to the left, they endure a shock like real particles, but the shock is
+perfectly elastic: After the shock, every one of the separating
+particles comes back to where it came, so that the total momentum is
+conserved. But if only one of the particles is moving, it gives its
+momentum to the other one, but instead of stopping, it comes back
+either: <br>
+The total momentum is doubled! We could call this a more-than-elastic
+shock. The &quot;worst&quot; case is when an impulse-stone hits the central
+stone of a group of three, which after the shock begin to move all of three,
+plus the initial moving stone, which comes back, so that the momentum
+is quadrupled!
+</div>
+
+<div class="lotmpic">
+<img src="$$imagedir$$/articles/level_andreas11_a.png"
+alt="cubic crystal" border="0">
+</div>
+
+<div class="quote">
+When the stones don't move anymore, they tend by themselves to be
+arranged in a regular pattern, which we may call a cristal, and looks
+typically like this.
+</div>
+
+<div class="quote">
+I propose to call this crystal structure the
+cubic system because it looks like a cubic crystal viewed from above. In this
+crystal, the distance between two neighbours is twice the unit length. But there
+is a more compact, a rarer, crystal structure which is stable (temperature
+zero), which I compare to the diamond structure.
+</div>
+
+<div class="lotmpic">
+<img src="$$imagedir$$/articles/level_andreas11_b.png"
+alt="diamond crystal" border="0">
+</div>
+
+<div class="quote">
+(one particle is
+missing on the lower line: impossible to move another here without touching one
+of the stones of the middle line, which would &hellip; arrgh!)
+</div>
+
+<div class="quote">
+In this crystal
+structure, every particle has 4 neighbours like in the cubic structure,
+&nbsp;but the distance between neighbours is the square root of 2, times the
+unit length: About 70% of the preceding. Actually there is a still more compact
+stable structure, where the space is completely filled with impulse-stones, but
+to build it would require much more pressure than Blackball could furnish. In
+this structure that I would be tempted to call the &quot;neutron star
+structure&quot;, the 
+distance between neighbours is simply the unit length, then 70% of the diamond
+and half of the cubic structure.
+</div>
+
+<div class="quote">
+There is more to say about these
+structures: Imagine a row of impulse-stones in an otherwize empty terrain, each
+occupying a cell with odd abscissa: Cells 1, 3, 5, etc. Then along comes
+Blackball at position 0 who pushes impulse-stone at 1 to position 2: The
+impulse-stone excites the one at 3, who goes to 4 and sends it back to position
+1. Then&nbsp; the stone at 4 sends the one at 5 to 6, which makes it resume its
+equilibrium position at 3, etc.: What we see is the propagation of a pressure
+wave in this pattern, which I would call a phonon. I have also observed some
+kind of cavitation (bubbles of void moving in the fluid), and temperature
+fluctuation. One can even see the ice cristal grow in a still moving fluid, and
+sometimes partly melting. Also when two parts of the liquid freeze in
+incompatible cristal structure, a default appears in the cristal which can
+propagate in the solid &hellip;
+</div>
+
+<div class="quote">
+All of this while waiting that the situation calms down!
+</div>
+
+<div class="quote">
+Thinking to the moving switches of &quot;How solid?&quot;, &quot;The Flagstone
+Reaper&quot; and &quot;The Dark Outside&quot; I begin to realize that Andreas
+has a dangerous gift to give life to strange 
+creatures (half-robot and half-alien) and observe their independant evolution,
+not unlike the hero from a Mary Shelley book &hellip;
+</div>
+
+<div class="quote">
+Brrr!
+</div>
+
+<div class="author">Alain</div>
+
+<div class="quote">
+The first version of &quot;Patterns of Impulse&quot; I still have on my hard
+drives dates back to May the 30th, 2005. In my internal nummeration, it was
+number 21, and hence a relatively late level, but first things first &hellip;
+</div>
+
+<div class="quote">
+As a child, I played Oxyd 1 completely through. It was a great experience, and
+I think it formed my character in quite a way, as it taught me that patience
+and hard work really do pay off. But after I completed level 100, and didn't
+find anyone to play through the link games completely, I quickly
+forgot about Oxyd, as I didn't know about the follow-up games.
+</div>
+
+<div class="quote">
+Years passed, so did the games I played. I switched from Windows to mainly
+Linux, when I started to study. And then, on some happy day in 2004 or
+2005, I found Enigma 0.81 through the linux distribution SuSE by random. It
+immediately caught my attention, and I started playing. But I was also curious,
+was it still in development? Many projects get abandonded over the years. Not
+so with Enigma. I quickly found version 0.92 on the internet, and as I wasn't
+able to compile it, I played it on Windows. But I wanted more&mdash;and looked at
+the level files. They seemed easy to understand, and the BlackBallEditor helped
+me to write some first simple experiments.
+</div>
+
+<div class="quote">
+The first one, my number 1, really was just an experiment. Number 2 already grew
+more interesting: It used reversed friction, like in the &quot;Nightmare&quot
+series, but without death stones. It was one of those levels which solved
+themselfes. Then I got the idea to realise Lissajous curves in a level. Indeed,
+my first motivation was similar to what I later realised as
+&quot;Lissajous&quot;, but with a rotor instead of a moving death stone. As I
+wasn't good enough to program this, I simply copied some code from Nat's
+&quot;When Gravity Fails&quot; and created my first real level, which would
+later be called &quot;Lissajous' Revenge&quot; (yes, the revenge was first,
+I chose the titles later). What followed, were &quot;Spaceleast&quot;
+(6) and &quot;Spaceless&quot; (7), &quot;Laser Castle&quot; (8), &quot;Friend
+or Foe?&quot; (9), &quot;Laser Path&quot; (11), &quot;Robin's Wood&quot; (13),
+&quot;Tropical Island&quot; (14: Yes, &quot;Robin's Wood&quot; and
+&quot;Tropical Island&quot; both came from the same idea of realising some
+theme in Enigma), &quot;Turn Around&quot; (15),
+&quot;Lissajous&quot; (17, finally), &quot;Moure-Switches&quot; (19, I wanted
+to create a code-puzzle level) and lots of ideas, that never made it to mature
+levels. At some point I decided to write 16 levels to be published&mdash;16 being
+the square of my favourite number. This would be the first time for me to really
+publish something I programmed. Counting the levels above, we get 11.
+</div>
+
+<div class="quote">
+Then came &quot;Patterns of Impulse&quot;, as number 21. I don't really know
+how this idea developped. It surely wasn't planned, and I think, I just played
+around a bit, putting some movable impulse stones together, randomly, but with
+some respect to symmetry, just to see how they would interact. I love
+(mathematically) chaotic behaviour, this was already the driving force for
+&quot;Laser Castle&quot;, and would later lead to &quot;Orbitting&quot; and
+&quot;Chess, Bugs &amp; Rock'n'Roll&quot;. Chaos has the fascinating habit of
+creating order out of itself, order of a more primordial kind than what we
+normally understand about this concept. Patterns emerge from chaos&mdash;and
+exactly this was what happened with the impulse stones. It was fascinating. 
+</div>
+
+<div class="quote">
+By the way, I dug up the first version of &quot;Pattern of Impulse&quot; and
+dressed it for Enigma 1.01. You can download it <a
+href="http://download.berlios.de/enigma-game/andreas11_a.xml">here</a>.
+</div>
+
+<div class="quote">
+There already were oxyd stones, I had put some into the edges of the level. At
+first, they just were there to appease BlackBallEd, which wouldn't let me save
+the level without setting oxyd stones. But then I tried to reach the oxyds
+through the evolving chaos. And failed. After watching the moving impulse
+stones, it became an interesting challenge to open the oxyd stones as well.
+Though I noticed, that the level wasn't perfect yet. It needed some control,
+just a little bit. I wanted to force the gamer to control the chaos, to keep it
+quiet. A good dexterity-player would open the stones just by sneaking through
+the ubiquitous chaos&mdash;that wasn't what I saw to be the more interesting
+challenge.
+</div>
+
+<div class="quote">
+So I removed four of the impulse stones (chosen to meet the design), and added
+the doors to shut the oxyds by adding triggers and stones in the (invisible)
+screens above and below. I used this technique before, in &quot;Laser
+Castle&quot;, and combined it here with timer stones to make sure that the
+doors would wait a moment before opening the way to the oxyds again. It worked
+out well. I thought about a title. I wanted to point out at the patterns
+visible in the activated level. At that time I read about a show in the Star
+Trek series called &quot;Patterns of Force&quot;, which I never saw, and which
+is considered one of the worst Star Trek shows ever; but I stuck to the title.
+I quickly settled with &quot;Patterns of Impulse&quot; perfectly describing the
+level, as I think.
+</div>
+
+<div class="quote">
+I added an easy mode and on July 1st, 2005, I send &quot;Patterns of
+Impulse&quot; and 15 other levels  to the devel mailing list, with the good
+feeling that work has been done and now I'd be through with Enigma and could go
+on with other things. If it wasn't for this persistent discussion about ratings
+&hellip;
+</div>
+
+<div class="author">Andreas Lochmann</div>
+
+</div>

Modified: homepage/input/lotm/lotm_archive_data.lua
===================================================================
--- homepage/input/lotm/lotm_archive_data.lua	2008-08-17 13:32:50 UTC (rev 1275)
+++ homepage/input/lotm/lotm_archive_data.lua	2008-08-20 17:35:16 UTC (rev 1276)
@@ -234,6 +234,15 @@
   position_num = "7925"
 }
 
+level_archive_data[10] = {
+  link = "$$level_andreas11$$",
+  occasion = "Independent Level Article 8/2008",
+  name = "Patterns of Impulse",
+  author = "Andreas Lochmann",
+  position = "IV/44",
+  position_num = "4044"
+}
+
 -- LotM variable data
 -- format: Level Title, current_rating, current_votes, additional text
 

Modified: homepage/input/output-files.lua
===================================================================
--- homepage/input/output-files.lua	2008-08-17 13:32:50 UTC (rev 1275)
+++ homepage/input/output-files.lua	2008-08-20 17:35:16 UTC (rev 1276)
@@ -533,3 +533,16 @@
     body = {"articles/apprentice_1"},
 }    
 
+----------------------------------------------------------------------
+-- Independent Level Articles
+----------------------------------------------------------------------
+
+html.level_andreas11 = {
+    outfile = "level_andreas11.html",
+    title = "Patterns of Impulse",
+    title_de = "Patterns of Impulse",
+    title_ru = "Patterns of Impulse",
+    rightcolumn = {},
+    body = {"articles/level_andreas11"},
+}    
+



From ral at mail.berlios.de  Wed Aug 20 20:45:44 2008
From: ral at mail.berlios.de (ral at BerliOS)
Date: Wed, 20 Aug 2008 20:45:44 +0200
Subject: [Enigma-game-svn] r1277 - in trunk: data src
Message-ID: <200808201845.m7KIjiFQ010774@sheep.berlios.de>

Author: ral
Date: 2008-08-20 20:45:43 +0200 (Wed, 20 Aug 2008)
New Revision: 1277

Modified:
   trunk/data/api2init.lua
   trunk/src/ObjectValidator.cc
   trunk/src/lua.cc
Log:
Trunk 1.1: Error handling improvements
- global Lua variables "res" and "lib" with error handler for access of
  not existing entries
- object validator added exception handling for semantical errors in 
  declarations.
- improved error messages for errors thrown within resolver implementations


Modified: trunk/data/api2init.lua
===================================================================
--- trunk/data/api2init.lua	2008-08-20 17:35:16 UTC (rev 1276)
+++ trunk/data/api2init.lua	2008-08-20 18:45:43 UTC (rev 1277)
@@ -216,10 +216,34 @@
 )
 
 ---------------
+-- Libraries --
+---------------
+
+lib = {}
+setmetatable(lib, {__index = 
+    function (table, key)
+        if type(key) == "string" then
+            error("Library function named '"..key.."' not existing. A typo or a missing library dependency may cause this fault.", 2)
+        else
+            error("Library function access with a key of type '"..type(key).."'. A name is mandatory.", 2)
+        end
+    end 
+})
+
+---------------
 -- Resolvers --
 ---------------
 
 res = {}
+setmetatable(res, {__index = 
+    function (table, key)
+        if type(key) == "string" then
+            error("Resolver named '"..key.."' not existing. A typo or a missing library dependency may cause this fault.", 2)
+        else
+            error("Resolver access with a key of type '"..type(key).."'. A name is mandatory.", 2)
+        end
+    end 
+})
 
 function res.random_implementation(context, evaluator, key, x, y)
     for hit_itr, hit_pair in ipairs(context[4]) do

Modified: trunk/src/ObjectValidator.cc
===================================================================
--- trunk/src/ObjectValidator.cc	2008-08-20 17:35:16 UTC (rev 1276)
+++ trunk/src/ObjectValidator.cc	2008-08-20 18:45:43 UTC (rev 1277)
@@ -105,25 +105,33 @@
     void ObjectValidator::init() {
         ASSERT(doc != NULL, XFrontend, "ObjectValidator try to init without given document");
         
+        std::string errMessage;
         DOMNodeList *elemList;
         DOMElement *baseElem;
         
-        baseElem = dynamic_cast<DOMElement *>(doc->getElementsByTagName(Utf8ToXML("attributes").x_str())->item(0));
-        elemList = baseElem->getElementsByTagName(Utf8ToXML("attr").x_str());
-        for (int i = 0, l = elemList->getLength(); i < l; i++) {
-            scanAttributeElement(dynamic_cast<DOMElement *>(elemList->item(i)));
+        try{
+            baseElem = dynamic_cast<DOMElement *>(doc->getElementsByTagName(Utf8ToXML("attributes").x_str())->item(0));
+            elemList = baseElem->getElementsByTagName(Utf8ToXML("attr").x_str());
+            for (int i = 0, l = elemList->getLength(); i < l; i++) {
+                scanAttributeElement(dynamic_cast<DOMElement *>(elemList->item(i)));
+            }
+            
+            baseElem = dynamic_cast<DOMElement *>(doc->getElementsByTagName(Utf8ToXML("messages").x_str())->item(0));
+            elemList = baseElem->getElementsByTagName(Utf8ToXML("msg").x_str());
+            for (int i = 0, l = elemList->getLength(); i < l; i++) {
+                scanMessageElement(dynamic_cast<DOMElement *>(elemList->item(i)));
+            }
+            
+            elemList = doc->getElementsByTagName(Utf8ToXML("object").x_str());
+            for (int i = 0, l = elemList->getLength(); i < l; i++) {
+                scanObjectElement(dynamic_cast<DOMElement *>(elemList->item(i)));
+            }
+        } catch (...) {
+            errMessage = "Exception on parse of object declarations\n";
         }
-        
-        baseElem = dynamic_cast<DOMElement *>(doc->getElementsByTagName(Utf8ToXML("messages").x_str())->item(0));
-        elemList = baseElem->getElementsByTagName(Utf8ToXML("msg").x_str());
-        for (int i = 0, l = elemList->getLength(); i < l; i++) {
-            scanMessageElement(dynamic_cast<DOMElement *>(elemList->item(i)));
+        if (!errMessage.empty()) {
+            throw XFrontend("Cannot init object declarations file: \nError: " + errMessage);
         }
-        
-        elemList = doc->getElementsByTagName(Utf8ToXML("object").x_str());
-        for (int i = 0, l = elemList->getLength(); i < l; i++) {
-            scanObjectElement(dynamic_cast<DOMElement *>(elemList->item(i)));
-        }
     }
     
     void ObjectValidator::shutdown() {

Modified: trunk/src/lua.cc
===================================================================
--- trunk/src/lua.cc	2008-08-20 17:35:16 UTC (rev 1276)
+++ trunk/src/lua.cc	2008-08-20 18:45:43 UTC (rev 1277)
@@ -1960,7 +1960,7 @@
         lua_pushvalue(L, -4);       // duplicate y
         int retval=lua_pcall(L, 3, 1, 0);     // resolver(key,x,y) ->  tile
         if (retval!=0) {
-            throwLuaError(L, "Error within tile key resolver");
+            throwLuaError(L, ecl::strf("Error within tile key resolver: \n  %s", lua_tostring(L, -1)).c_str());
             return 0;
         }
         // check result - must be tile or table or nil
@@ -1979,7 +1979,7 @@
         lua_pushvalue(L, -6);       // duplicate y
         int retval=lua_pcall(L, 5, 1, 0);     // resolver(context,evaluator,key,x,y) ->  tile
         if (retval!=0) { 
-            throwLuaError(L, "Error within tile key resolver");
+            throwLuaError(L, ecl::strf("Error within tile key resolver: \n  %s", lua_tostring(L, -1)).c_str());
             return 0;
         }
         // check result - must be tile or table or nil



From ral at mail.berlios.de  Thu Aug 21 00:53:42 2008
From: ral at mail.berlios.de (ral at mail.berlios.de)
Date: Thu, 21 Aug 2008 00:53:42 +0200
Subject: [Enigma-game-svn] r1278 - team_levelpacks/team_test_new_api
Message-ID: <200808202253.m7KMrgAT029241@sheep.berlios.de>

Author: ral
Date: 2008-08-21 00:53:31 +0200 (Thu, 21 Aug 2008)
New Revision: 1278

Added:
   team_levelpacks/team_test_new_api/ralT061_1.xml
Modified:
   team_levelpacks/team_test_new_api/ralT055_1.xml
   team_levelpacks/team_test_new_api/ralT060_1.xml
Log:
Test Level new API:
- add test level swap and pull stones 


Modified: team_levelpacks/team_test_new_api/ralT055_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/ralT055_1.xml	2008-08-20 18:45:43 UTC (rev 1277)
+++ team_levelpacks/team_test_new_api/ralT055_1.xml	2008-08-20 22:53:31 UTC (rev 1278)
@@ -33,6 +33,8 @@
 ti["F"] = ti["~"] .. {"st-firebreak_move"}
 ti["P"] = ti["~"] .. {"st-plain_move"}
 
+ti["S"] = ti["~"] .. {"st_swap"}
+
 ti["1"] = {"#ac-blackball"} 
 
 
@@ -45,11 +47,11 @@
 " s ~~~           .  ",
 "   ~~~           .  ",
 "   ~~W              ",
-"   ~~B              ",
-"   ~~F              ",
-"   ~~P              ",
-"   ~~~              ",
-"                    "
+"   ~~B         Sw   ",
+"   ~~F         Sb   ",
+"   ~~P         Sf   ",
+"   ~~~         Sp   ",
+"               ~    "
 })
 
 function flood(value, sender)

Modified: team_levelpacks/team_test_new_api/ralT060_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/ralT060_1.xml	2008-08-20 18:45:43 UTC (rev 1277)
+++ team_levelpacks/team_test_new_api/ralT060_1.xml	2008-08-20 22:53:31 UTC (rev 1278)
@@ -57,7 +57,6 @@
 ti["@"] = {"#ac-blackball"} 
 ti["."] = {"#ac-whiteball", "white"} 
 
-
 w, h = wo(ti, " ", {
 "                    ",
 "                x  X",

Added: team_levelpacks/team_test_new_api/ralT061_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/ralT061_1.xml	2008-08-20 18:45:43 UTC (rev 1277)
+++ team_levelpacks/team_test_new_api/ralT061_1.xml	2008-08-20 22:53:31 UTC (rev 1278)
@@ -0,0 +1,76 @@
+<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
+<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
+  <el:protected>
+    <el:info el:type="level">
+      <el:identity el:title="Test Pull,Swap,Brake new API" el:subtitle="" el:id="20080818ral371"/>
+      <el:version el:score="1" el:release="1" el:revision="$Revision: 1267 $" el:status="experimental"/>
+      <el:author  el:name="Ronald Lamprecht" el:email="ral at users.berlios.de"/>
+      <el:copyright>Copyright ? 2008 Ronald Lamprecht</el:copyright>
+      <el:license el:type="GPL v2.0 or above" el:open="true"/>
+      <el:compatibility el:enigma="1.10">
+      </el:compatibility>
+      <el:modes el:easy="false" el:single="true" el:network="false"/>
+      <el:comments>
+      </el:comments>
+      <el:score el:easy="-" el:difficult="-"/>
+    </el:info>
+    <el:luamain><![CDATA[
+wo["ConserveLevel"] = true
+wo["ShowMoves"] = true
+
+ti[" "] = {"fl-sahara"}
+ti["#"] = {"st-rock1"}
+
+ti["P"] = {"st_pull"}
+ti["p"] = {"st_pull", "pull"}
+
+ti["S"] = {"st_swap"}
+ti["s"] = {"st_swap", "swap"}
+
+ti["B"] = {"st-brake"}
+ti["R"] = {"st_rotator", movable=true}
+ti["w"] = {"st-wood", "wood1"}
+ti["W"] = {"st-wood", "wood2"}
+ti["c"] = {"it_coin_s"}
+
+ti["g"] = {"st-grate1"}
+
+ti["L"] = {"st_laser_e", state=ON}
+ti["l"] = {"st_polarswitch"}
+
+ti["f"] = {"st_polarswitch", "pol1"}
+ti["F"] = {"st_polarswitch", "pol2"}
+
+ti["t"] = {"it_trigger", target="pol1"}
+ti["T"] = {"it_trigger", target="pol2"}
+
+ti["@"] = {"#ac-blackball"} 
+ti["."] = {"#ac-whiteball", "white"} 
+
+
+w, h = wo(ti, " ", {
+"              L fF c",
+"Ll                  ",
+"     P      S   tT  ",
+"                    ",
+"  #     PB    S  g  ",
+"  #                 ",
+"  #                 ",
+"          R         ",
+"   s   @       p    ",
+"        cc          ",
+"   W           w    ",
+"                    ",
+" .                  "
+})
+
+wo:add({"ot_wire", anchor1="pull", anchor2="wood1"})
+wo:add({"ot_wire", anchor1="swap", anchor2="wood2"})
+  ]]></el:luamain>
+    <el:i18n>
+	 <el:string el:key="title">
+	   <el:english el:translate="false"/>
+	 </el:string>
+   </el:i18n>
+  </el:protected>
+</el:level>


Property changes on: team_levelpacks/team_test_new_api/ralT061_1.xml
___________________________________________________________________
Name: Revision
   + 
Name: svn:eol-style
   + native



From ral at mail.berlios.de  Thu Aug 21 01:00:18 2008
From: ral at mail.berlios.de (ral at BerliOS)
Date: Thu, 21 Aug 2008 01:00:18 +0200
Subject: [Enigma-game-svn] r1279 - in trunk: data data/schemas src src/stones
Message-ID: <200808202300.m7KN0IeS004143@sheep.berlios.de>

Author: ral
Date: 2008-08-21 01:00:11 +0200 (Thu, 21 Aug 2008)
New Revision: 1279

Added:
   trunk/src/stones/PullStone.cc
   trunk/src/stones/PullStone.hh
   trunk/src/stones/SwapStone.cc
   trunk/src/stones/SwapStone.hh
   trunk/src/stones/YieldingStone.cc
   trunk/src/stones/YieldingStone.hh
Modified:
   trunk/data/api1init.lua
   trunk/data/schemas/objects.xml
   trunk/src/Makefile.am
   trunk/src/actors.cc
   trunk/src/actors.hh
   trunk/src/ox_peroxyd.cc
   trunk/src/stones.cc
   trunk/src/stones_complex.cc
   trunk/src/stones_internal.hh
   trunk/src/stones_simple.cc
Log:
Trunk 1.1: new API reengineering
- replace YieldedGridStone by Stone subclass YieldingStone
  - fix crashing on stones that suicide on set or move
- pull stone reengineering:
  - renamed to st_pull
  - preserve identity on moves:
    - can now be used with rubberband and wires
    - can be named and attributed
  - ensure that pull does not press triggers on both affected grids
    while moving
  - made light transparent
- swap stone reengineering:
  - renamed to st_swap
  - preserve identity on moves:
    - can now be used with rubberband and wires
    - can be named and attributed
  - ensure that swap does not press triggers on both affected grids
    while moving
- fix brake on shattering actors on pull stone swaps
- fix plain_move and firebreak: 
  - fall on changing floors


Modified: trunk/data/api1init.lua
===================================================================
--- trunk/data/api1init.lua	2008-08-20 22:53:31 UTC (rev 1278)
+++ trunk/data/api1init.lua	2008-08-20 23:00:11 UTC (rev 1279)
@@ -193,6 +193,7 @@
     st_oneway_white_w = "st-oneway_white-w",
     st_panel = "st-wood_001",
     st_polarswitch = "st-polarswitch",
+    st_pull = "st-pull",
     st_rotator_cw = "st-rotator-right",
     st_rotator_ccw = "st-rotator-left",
     st_rotator_cw_movable = "st-rotator_move-right",
@@ -207,6 +208,7 @@
     st_shogun_sl = "st-shogun-sl",
     st_shogun_ml = "st-shogun-ml",
     st_shogun_sml = "st-shogun-sml",
+    st_swap = "st-swap",
     st_switch = "st-switch",
     st_switch_black = "st-switch_black",
     st_switch_white = "st-switch_white",

Modified: trunk/data/schemas/objects.xml
===================================================================
--- trunk/data/schemas/objects.xml	2008-08-20 22:53:31 UTC (rev 1278)
+++ trunk/data/schemas/objects.xml	2008-08-20 23:00:11 UTC (rev 1279)
@@ -79,14 +79,15 @@
     <msg name="_brush" type="nil"/>
     <msg name="_capture" type="nil"/>
     <msg name="_explosion" type="nil"/>
+    <msg name="_freeze" type="nil"/>
     <msg name="_glasses" type="nil"/>
     <msg name="_hit" type="object"/>
     <msg name="_init" type="nil"/>
     <msg name="_jumping" type="bool"/>
-    <msg name="_performaction" type="nil"/>
     <msg name="_model_reanimated" type="nil"/>
     <msg name="_passed" type="nil"/>            <!-- check type-->
     <msg name="_performaction" type="nil"/>
+    <msg name="_revive" type="nil"/>
     <msg name="_shogun" type="int"/>
     <msg name="_spitter" type="nil"/>
     <msg name="_start" type="nil"/>
@@ -692,6 +693,11 @@
       <msg name="off"/>
       <msg name="signal"/>
     </object>
+    <object name="st_pull">
+      <attr name="state" rw="r"/>
+      <msg name="_freeze"/>
+      <msg name="_revive"/>
+    </object>
     <object name="st_rotator">
       <attr name="counterclock"/>
       <attr name="movable" rw="rw"/>
@@ -742,6 +748,9 @@
     <object name="st_shogun_sml">
       <attr name="flavor" value="sml"/>
     </object>
+    <object name="st_swap">
+      <attr name="state" rw="r"/>
+    </object>
     <object name="st_switch">
       <attr name="color"/>
       <attr name="instant"/>

Modified: trunk/src/Makefile.am
===================================================================
--- trunk/src/Makefile.am	2008-08-20 22:53:31 UTC (rev 1278)
+++ trunk/src/Makefile.am	2008-08-20 23:00:11 UTC (rev 1279)
@@ -263,6 +263,8 @@
 	stones/OxydStone.hh	\
 	stones/PolarSwitchStone.cc	\
 	stones/PolarSwitchStone.hh	\
+	stones/PullStone.cc	\
+	stones/PullStone.hh	\
 	stones/RotatorStone.cc	\
 	stones/RotatorStone.hh	\
 	stones/RubberbandStone.cc	\
@@ -271,6 +273,8 @@
 	stones/ScissorsStone.hh	\
 	stones/ShogunStone.cc	\
 	stones/ShogunStone.hh	\
+	stones/SwapStone.cc	\
+	stones/SwapStone.hh	\
 	stones/Switch.cc	\
 	stones/Switch.hh	\
 	stones/TimerStone.cc	\
@@ -278,7 +282,9 @@
 	stones/Turnstile.cc	\
 	stones/Turnstile.hh	\
 	stones/WindowStone.cc	\
-	stones/WindowStone.hh
+	stones/WindowStone.hh	\
+	stones/YieldingStone.cc	\
+	stones/YieldingStone.hh
 
 datadir = @datadir@
 

Modified: trunk/src/actors.cc
===================================================================
--- trunk/src/actors.cc	2008-08-20 22:53:31 UTC (rev 1278)
+++ trunk/src/actors.cc	2008-08-20 23:00:11 UTC (rev 1279)
@@ -268,6 +268,11 @@
     if (m.message == "_init") {
         startingpos = get_pos();
         return Value();
+    } else if (m.message == "_freeze") {
+        m_actorinfo.frozen_vel = m_actorinfo.vel;
+        m_actorinfo.vel = ecl::V2();
+    } else if (m.message == "_revive") {
+        m_actorinfo.vel = m_actorinfo.frozen_vel;        
     }
     return StateObject::message(m);
 }

Modified: trunk/src/actors.hh
===================================================================
--- trunk/src/actors.hh	2008-08-20 22:53:31 UTC (rev 1278)
+++ trunk/src/actors.hh	2008-08-20 23:00:11 UTC (rev 1279)
@@ -76,6 +76,7 @@
         GridPos gridpos;        // Grid position for pos
         const Field *field;     // Field of pos
         ecl::V2 vel;            // Velocity
+        ecl::V2 frozen_vel;     // Velocity backup for forzen actors
         ecl::V2 pos_force;      // Extrapolated position for global force calc
         ecl::V2 forceacc;       // Force accumulator
         double charge;          // Electric charge

Modified: trunk/src/ox_peroxyd.cc
===================================================================
--- trunk/src/ox_peroxyd.cc	2008-08-20 22:53:31 UTC (rev 1278)
+++ trunk/src/ox_peroxyd.cc	2008-08-20 23:00:11 UTC (rev 1279)
@@ -335,7 +335,7 @@
     "st-rock8",                 // PerOxyd stone 0x90
     "st_rotator_ccw_movable",   // PerOxyd stone 0x91
     "st_rotator_cw_movable",    // PerOxyd stone 0x92
-    "st-swap",                  // PerOxyd stone 0x93
+    "st_swap",                  // PerOxyd stone 0x93
     "st-spitter",               // PerOxyd stone 0x94
     0,                          // PerOxyd stone 0x95 (dynamite holder, will implememnt it)(levels: 41 184 200)
     "st_rubberband",            // PerOxyd stone 0x96

Added: trunk/src/stones/PullStone.cc
===================================================================
--- trunk/src/stones/PullStone.cc	2008-08-20 22:53:31 UTC (rev 1278)
+++ trunk/src/stones/PullStone.cc	2008-08-20 23:00:11 UTC (rev 1279)
@@ -0,0 +1,145 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *  
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include "stones/PullStone.hh"
+#include "errors.hh"
+//#include "main.hh"
+#include "server.hh"
+#include "world.hh"
+
+namespace enigma {
+    PullStone::PullStone() : YieldingStone() {
+    }
+    
+    PullStone::~PullStone() {
+        GameTimer.remove_alarm(this);
+    }
+    
+    PullStone* PullStone::clone() {
+        return new PullStone(*this);
+    }
+    
+    std::string PullStone::getClass() const {
+        return "st_pull";
+    }
+
+    void PullStone::setState(int extState) {
+        // reject any write attempts
+    }
+    
+    void PullStone::init_model() {
+        set_model("st-pull");
+    }
+    
+    bool PullStone::is_floating() const {
+        // a moving pull stone should press just one of the two affected grids at each
+        // point of time. The vanishing part is the proxy of the other exchanged stone.
+        // Thus it inherits the floating behaviour from it. 
+        return (state == VANISHING && 
+                (yieldedStone == NULL || yieldedStone->is_floating())); 
+    }
+    
+    bool PullStone::is_sticky(const Actor *a) const {
+        return true;   // independent of floating behaviour
+    }
+    
+    bool PullStone::is_removable() const {
+        return state == IDLE;
+    }
+    
+    bool PullStone::is_transparent(Direction d) const {
+        return true;
+    }
+    
+    void PullStone::on_impulse(const Impulse& impulse) {
+        if (state != IDLE)
+            return;
+
+        GridPos oldPos = get_pos();
+        GridPos newPos = move(oldPos, reverse(impulse.dir));
+        Stone *otherStone = GetStone(newPos);
+    
+        if (!IsInsideLevel(newPos) || (otherStone && (!otherStone->is_removable() || 
+                (IsLevelBorder(newPos) && server::GameCompatibility != GAMET_ENIGMA)))) {
+            propagateImpulse(impulse);
+            return;                 // avoid unremoveable and border stones
+        }
+        
+        PullStone *vanishStone = dynamic_cast<PullStone *>(MakeObject("st_pull"));
+        vanishStone->state = VANISHING;
+        
+        YieldStone(oldPos);
+        SetStone(oldPos, vanishStone);
+        vanishStone->yieldStone(otherStone);
+        vanishStone->set_model(std::string("st-pull") + to_suffix(impulse.dir));
+        GameTimer.set_alarm(vanishStone, 0.09, false);
+        
+        SetStone(newPos, this);
+        state = APPEARING;
+        set_model(std::string("st-pull") + to_suffix(reverse(impulse.dir)));
+        GameTimer.set_alarm(this, 0.09, false);
+
+        // search for affected actors
+        std::vector<Actor*> found_actors;
+        const double   range_one_field = 1.415; // approx. 1 field [ > sqrt(1+1) ]
+        GetActorsInRange(newPos.center(), range_one_field, found_actors);
+        std::vector<Actor*>::iterator e = found_actors.end();
+        ObjectList actors;
+        for (std::vector<Actor*>::iterator i = found_actors.begin(); i != e; ++i) {
+            Actor *actor = *i;
+            GridPos actor_pos(actor->get_pos());
+    
+            if (actor_pos == newPos) { // if the actor is in the dest field
+                actors.push_back(actor);
+                SendMessage(actor, "_freeze");
+
+                ecl::V2 mid_dest = actor->get_pos();
+                mid_dest[0] = ecl::Clamp<double> (mid_dest[0], oldPos.x+0.01, oldPos.x+0.99);
+                mid_dest[1] = ecl::Clamp<double> (mid_dest[1], oldPos.y+0.01, oldPos.y+0.99);
+                WarpActor(actor, mid_dest[0], mid_dest[1], false);                
+            }
+        }
+        vanishStone->setAttr("$frozen_actors", actors);
+
+        sound_event("moveslow");
+        propagateImpulse(impulse);
+    }
+    
+    void PullStone::alarm() {
+        if (state == APPEARING) {
+            state = IDLE;
+            if (isDisplayable())
+                init_model();
+        } else if (state == VANISHING) {
+            ObjectList actors = getAttr("$frozen_actors");
+            for (ObjectList::iterator itr = actors.begin(); itr != actors.end(); ++itr)
+                SendMessage(*itr, "_revive");
+            setStone();
+        } else
+            ASSERT(false, XLevelRuntime, "PullStone: alarm called with inconsistent state");
+    }
+        
+    DEF_TRAITSM(PullStone, "st_pull", st_pull, MOVABLE_IRREGULAR);
+    
+    BOOT_REGISTER_START
+        BootRegister(new PullStone(), "st_pull");
+    BOOT_REGISTER_END
+
+} // namespace enigma


Property changes on: trunk/src/stones/PullStone.cc
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/stones/PullStone.hh
===================================================================
--- trunk/src/stones/PullStone.hh	2008-08-20 22:53:31 UTC (rev 1278)
+++ trunk/src/stones/PullStone.hh	2008-08-20 23:00:11 UTC (rev 1279)
@@ -0,0 +1,72 @@
+/*
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef PULLSTONE_HH
+#define PULLSTONE_HH
+
+#include "stones/YieldingStone.hh"
+
+#include "stones_internal.hh"
+#include "util.hh"
+
+namespace enigma {
+
+    /** 
+     * 
+     */
+    class PullStone : public YieldingStone, public TimeHandler {
+        DECL_TRAITS;
+        
+    private:
+        enum iState {
+            IDLE,       ///<  
+            APPEARING,  ///< 
+            VANISHING   ///< 
+        };
+        
+    public:
+        PullStone();
+        ~PullStone();
+        PullStone* clone();
+        
+        // Object interface
+        virtual std::string getClass() const;
+        
+        // StateObject interface
+        virtual void setState(int extState);
+
+        // GridObject interface
+        virtual void init_model();
+        
+        // Stone interface
+        virtual bool is_floating() const;
+        virtual bool is_sticky(const Actor *a) const;
+        virtual bool is_removable() const;
+        virtual bool is_transparent(Direction d) const;
+        virtual void on_impulse(const Impulse& impulse);
+        
+        // TimeHandler interface
+        virtual void alarm();
+
+    private:
+        
+    };
+
+} // namespace enigma
+
+#endif


Property changes on: trunk/src/stones/PullStone.hh
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/stones/SwapStone.cc
===================================================================
--- trunk/src/stones/SwapStone.cc	2008-08-20 22:53:31 UTC (rev 1278)
+++ trunk/src/stones/SwapStone.cc	2008-08-20 23:00:11 UTC (rev 1279)
@@ -0,0 +1,118 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *  
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include "stones/SwapStone.hh"
+#include "errors.hh"
+//#include "main.hh"
+#include "server.hh"
+#include "world.hh"
+
+namespace enigma {
+    SwapStone::SwapStone() : YieldingStone() {
+    }
+    
+    SwapStone::~SwapStone() {
+        GameTimer.remove_alarm(this);
+    }
+    
+    SwapStone* SwapStone::clone() {
+        return new SwapStone(*this);
+    }
+    
+    std::string SwapStone::getClass() const {
+        return "st_swap";
+    }
+
+    void SwapStone::setState(int extState) {
+        // reject any write attempts
+    }
+    
+    void SwapStone::init_model() {
+        set_model("st-swap");
+    }
+    
+    bool SwapStone::is_floating() const {
+        // a moving swap stone should press just one of the two affected grids at each
+        // point of time. The vanishing part is the proxy of the other exchanged stone.
+        // Thus it inherits the floating behaviour from it. 
+        return (state == VANISHING && 
+                (yieldedStone == NULL || yieldedStone->is_floating())); 
+    }
+    
+    bool SwapStone::is_sticky(const Actor *a) const {
+        return true;   // independent of floating behaviour
+    }
+    
+    bool SwapStone::is_removable() const {
+        return state == IDLE;
+    }
+    
+    void SwapStone::on_impulse(const Impulse& impulse) {
+        if (state != IDLE)
+            return;
+
+        GridPos oldPos = get_pos();
+        GridPos newPos = move(oldPos, impulse.dir);
+        Stone *otherStone = GetStone(newPos);
+    
+        if (!IsInsideLevel(newPos) || !otherStone || !otherStone->is_removable() || 
+                (IsLevelBorder(newPos) && server::GameCompatibility != GAMET_ENIGMA)) {
+            propagateImpulse(impulse);
+            return;                 // avoid unremoveable and border stones
+        }
+        
+        SwapStone *vanishStone = dynamic_cast<SwapStone *>(MakeObject("st_swap"));
+        vanishStone->state = VANISHING;
+        
+        YieldStone(oldPos);
+        SetStone(oldPos, vanishStone);
+        vanishStone->yieldStone(otherStone);
+        vanishStone->set_model(std::string("st-swap") + to_suffix(reverse(impulse.dir)));
+        GameTimer.set_alarm(vanishStone, 0.1, false);
+        
+        SetStone(newPos, this);
+        state = APPEARING;
+        set_model(std::string("st-swap") + to_suffix(impulse.dir));
+        GameTimer.set_alarm(this, 0.1, false);
+
+
+        sound_event("moveslow");
+        server::IncMoveCounter(1);
+        propagateImpulse(impulse);
+    }
+    
+    void SwapStone::alarm() {
+        if (state == APPEARING) {
+            state = IDLE;
+            if (isDisplayable())
+                init_model();
+        } else if (state == VANISHING) {
+            setStone();
+        } else
+            ASSERT(false, XLevelRuntime, "SwapStone: alarm called with inconsistent state");
+    }
+        
+    DEF_TRAITSM(SwapStone, "st_swap", st_swap, MOVABLE_IRREGULAR);
+    
+    BOOT_REGISTER_START
+        BootRegister(new SwapStone(), "st_swap");
+    BOOT_REGISTER_END
+
+} // namespace enigma


Property changes on: trunk/src/stones/SwapStone.cc
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/stones/SwapStone.hh
===================================================================
--- trunk/src/stones/SwapStone.hh	2008-08-20 22:53:31 UTC (rev 1278)
+++ trunk/src/stones/SwapStone.hh	2008-08-20 23:00:11 UTC (rev 1279)
@@ -0,0 +1,71 @@
+/*
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef SWAPSTONE_HH
+#define SWAPSTONE_HH
+
+#include "stones/YieldingStone.hh"
+
+#include "stones_internal.hh"
+#include "util.hh"
+
+namespace enigma {
+
+    /** 
+     * 
+     */
+    class SwapStone : public YieldingStone, public TimeHandler {
+        DECL_TRAITS;
+        
+    private:
+        enum iState {
+            IDLE,       ///<  
+            APPEARING,  ///< 
+            VANISHING   ///< 
+        };
+        
+    public:
+        SwapStone();
+        ~SwapStone();
+        SwapStone* clone();
+        
+        // Object interface
+        virtual std::string getClass() const;
+        
+        // StateObject interface
+        virtual void setState(int extState);
+
+        // GridObject interface
+        virtual void init_model();
+        
+        // Stone interface
+        virtual bool is_floating() const;
+        virtual bool is_sticky(const Actor *a) const;
+        virtual bool is_removable() const;
+        virtual void on_impulse(const Impulse& impulse);
+        
+        // TimeHandler interface
+        virtual void alarm();
+
+    private:
+        
+    };
+
+} // namespace enigma
+
+#endif


Property changes on: trunk/src/stones/SwapStone.hh
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/stones/YieldingStone.cc
===================================================================
--- trunk/src/stones/YieldingStone.cc	2008-08-20 22:53:31 UTC (rev 1278)
+++ trunk/src/stones/YieldingStone.cc	2008-08-20 23:00:11 UTC (rev 1279)
@@ -0,0 +1,69 @@
+/*
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *  
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include "stones/YieldingStone.hh"
+#include "errors.hh"
+//#include "main.hh"
+#include "world.hh"
+
+namespace enigma {
+    void YieldingStone::dispose() {
+         if (yieldedStone != NULL) {
+            SendMessage(yieldedStone, "disconnect");
+            DisposeObject(yieldedStone);
+         }
+         if (yieldedModel != NULL)
+            delete yieldedModel;
+         yieldedStone = NULL;
+         yieldedModel = NULL;
+         delete this;
+    }
+
+    void YieldingStone::yieldStone(Stone *st) {
+        if (st != NULL) {
+            ASSERT(yieldedStone == NULL, XLevelRuntime, "YieldingStone: internal error of double yielding"); 
+            yieldedStone = st;
+            GridPos pos = st->get_pos();
+            yieldedModel = display::YieldModel(GridLoc(GRID_STONES, pos));
+            YieldStone(pos);
+            yieldedStone->setOwnerPos(get_pos());   // the stone id owned at the new position
+        }
+    }
+    
+    void YieldingStone::setStone() {
+        GridPos pos = get_pos();
+        SendMessage(this, "disconnect");
+        YieldStone(pos);
+        if (yieldedStone != NULL) {
+            int id = yieldedStone->getId();
+            SetStone(pos, yieldedStone);
+            if (Object::getObject(id) != NULL) { // not killed?
+                display::SetModel(GridLoc(GRID_STONES, pos), yieldedModel);
+                yieldedStone->on_move();    // continue animations -- this is buggy if the stone has another
+                                            // model on the new position like st-chameleon
+                if (Object::getObject(id) != NULL)   // not killed?
+                    SendMessage(yieldedStone, "_model_reanimated");  // temp fix: reset bad models
+            }
+            yieldedStone = NULL;
+            yieldedModel = NULL;
+        }
+        DisposeObject(this);
+    }
+
+} // namespace enigma


Property changes on: trunk/src/stones/YieldingStone.cc
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/stones/YieldingStone.hh
===================================================================
--- trunk/src/stones/YieldingStone.hh	2008-08-20 22:53:31 UTC (rev 1278)
+++ trunk/src/stones/YieldingStone.hh	2008-08-20 23:00:11 UTC (rev 1279)
@@ -0,0 +1,44 @@
+/*
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef YIELDINGSTONE_HH
+#define YIELDINGSTONE_HH
+
+#include "stones.hh"
+
+namespace enigma {
+
+    /** 
+     * 
+     */
+    class YieldingStone : public Stone {
+        
+    public:
+        void dispose();
+        
+    protected:
+        Stone *yieldedStone;
+        display::Model *yieldedModel;
+        
+        void yieldStone(Stone *st);
+        void setStone();
+    };
+
+} // namespace enigma
+
+#endif


Property changes on: trunk/src/stones/YieldingStone.hh
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/src/stones.cc
===================================================================
--- trunk/src/stones.cc	2008-08-20 22:53:31 UTC (rev 1278)
+++ trunk/src/stones.cc	2008-08-20 23:00:11 UTC (rev 1279)
@@ -419,46 +419,6 @@
 }
 
 
-/* -------------------- YieldedGridStone -------------------- */
-
-YieldedGridStone::YieldedGridStone(Stone *st)
-: stone(st)
-{
-    GridPos pos = stone->get_pos();
-    model       = display::YieldModel(GridLoc(GRID_STONES, pos));
-    YieldStone(pos);
-    st->setOwnerPos(pos);   // the stone remains owned at the old position
-}
-
-YieldedGridStone::~YieldedGridStone() 
-{
-    ASSERT(!stone, XLevelRuntime,
-        "YieldedGridStone: destructor called though stone still exists");
-    ASSERT(!model, XLevelRuntime,
-        "YieldedGridStone: destructor called though model still exists");
-}
-
-void YieldedGridStone::set_stone(GridPos pos) 
-{
-    SetStone(pos, stone);
-    display::SetModel(GridLoc(GRID_STONES, stone->get_pos()), model);
-    stone->on_move();    // continue animations -- this is buggy if the stone has another
-                         // model on the new position like st-chameleon
-    SendMessage(stone, "_model_reanimated");  // temp fix: reset bad models
-    stone = 0;
-    model = 0;
-}
-
-void YieldedGridStone::dispose() 
-{
-    SendMessage(stone, "disconnect");
-    stone->dispose();
-    delete model;
-    stone = 0;
-    model = 0;
-}
-
-
 /* -------------------- Oxyd compatibility stones -------------------- */
 
 namespace
@@ -812,8 +772,8 @@
             }
             return Stone::message(m);
         }
-        void on_move() {
-            Stone::on_move();
+        void on_floor_change() {
+//            Stone::on_move();
             GridPos p = get_pos();
             if (Floor *fl = GetFloor (p)) {
                 if (fl->is_kind("fl-abyss")) {

Modified: trunk/src/stones_complex.cc
===================================================================
--- trunk/src/stones_complex.cc	2008-08-20 22:53:31 UTC (rev 1278)
+++ trunk/src/stones_complex.cc	2008-08-20 23:00:11 UTC (rev 1279)
@@ -39,209 +39,6 @@
 
 namespace enigma { 
 
-/* -------------------- PullStone -------------------- */
-
-// When pushed this stone acts like pulled.
-// When pushed by an actor it exchanges its position with the actor.
-
-namespace
-{
-    struct PulledActor {
-        // Variables
-        Actor *actor;
-        V2     speed;
-
-        // Constructor
-        PulledActor(Actor *actor_, const V2& speed_)
-        : actor(actor_), speed(speed_)
-        {
-        }
-
-    };
-
-    class PullInfo {
-        list<PulledActor>  actors;
-        YieldedGridStone  *ystone;
-
-    public:
-        PullInfo(Stone *st)
-        : ystone(st ? new YieldedGridStone(st) : 0)
-        {}
-        ~PullInfo() { delete ystone; }
-
-        void add_actor(Actor *actor, const V2& speed) {
-            actors.push_back(PulledActor(actor, speed));
-        }
-
-        list<PulledActor>& get_actors() { return actors; }
-
-        void set_stone(GridPos pos) { if (ystone) ystone->set_stone(pos); }
-        void dispose() { if (ystone) ystone->dispose(); }
-    };
-
-
-    class PullStone : public Stone, public TimeHandler {
-        DECL_TRAITS;
-        // Variables.
-        enum State { IDLE, MOVING, VANISHED } state;
-        Direction  m_movedir;
-        PullInfo  *pull_info;   // information about moved objects (only valid during pull)
-
-    public:
-        PullStone();
-        ~PullStone();
-
-    private:
-        // Object interface.
-        PullStone *clone();
-        void       dispose();
-        
-        // Stone interface.
-        void actor_hit(const StoneContact &sc) {
-            if (state == IDLE)
-                maybe_push_stone(sc);
-        }
-        void on_impulse(const Impulse& impulse);
-        bool is_removable() const {
-            return state == IDLE;
-        }
-
-        // TimeHandler interface.
-        void alarm();
-
-        // Functions.
-        void change_state(State new_state);
-        void set_move_state(bool appearing, Direction move_dir);
-
-    };
-    DEF_TRAITSM(PullStone, "st-pull", st_pull, MOVABLE_IRREGULAR);    
-}
-
-PullStone::PullStone()
-: state(IDLE), m_movedir(NODIR) , pull_info(0)
-{}
-
-PullStone::~PullStone() {
-    GameTimer.remove_alarm(this);
-    delete pull_info;
-}
-
-PullStone *PullStone::clone() {
-    PullStone *other = new PullStone(*this);
-    other->pull_info = 0;
-    return other;
-}
-
-void PullStone::dispose() {
-    if (state == MOVING && pull_info != 0)
-        pull_info->dispose();
-    delete this;
-}
-
-void PullStone::set_move_state (bool appearing, Direction move_dir) {
-    if (appearing) {
-        m_movedir = move_dir;
-        // only the half-stone on the new field gets an alarm
-        // wherein it completes the move
-        GameTimer.set_alarm(this, 0.09, false);
-    }
-    else
-        m_movedir = reverse(move_dir);
-    change_state(MOVING);
-}
-
-void PullStone::change_state (State new_state) {
-    switch (new_state) {
-    case IDLE: set_model("st-pull"); break;
-    case MOVING: {
-            string mname = string("st-pull") + to_suffix(m_movedir);
-            set_model(mname);
-            break;
-        }
-    case VANISHED: break;
-    }
-    state = new_state;
-}
-
-void PullStone::alarm() {
-    ASSERT(state == MOVING, XLevelRuntime, "PullStone: alarm called with inconsistent state");
-    GridPos oldpos = move (get_pos(), reverse(m_movedir));
-
-    // remove the disappearing half of the PullStone :
-    PullStone *oldStone = dynamic_cast<PullStone*>(GetStone(oldpos));
-    ASSERT(oldStone, XLevelRuntime, "PullStone: oldStone non-existent in alarm");
-    oldStone->change_state(VANISHED);
-    KillStone(oldpos);
-
-    if (pull_info) {            // have other objects been moved ?
-        pull_info->set_stone(oldpos); // re-sets any pulled stone
-
-        // set pulled actor(s):
-        list<PulledActor>::iterator e = pull_info->get_actors().end();
-        for (list<PulledActor>::iterator i = pull_info->get_actors().begin(); i != e; ++i) {
-            PulledActor& pulled = *i;
-            pulled.actor->get_actorinfo()->vel = pulled.speed;
-        }
-        delete pull_info;
-        pull_info = 0;
-    }
-
-    change_state(IDLE);
-}
-
-void PullStone::on_impulse(const Impulse& impulse) 
-{
-    if (state != IDLE)
-        return;
-
-    Direction       move_dir    = reverse(impulse.dir);
-    const GridPos&  oldPos      = get_pos();
-    GridPos         newPos      = move(oldPos, move_dir);
-    Stone          *other_stone = GetStone(newPos);
-
-    if (!IsInsideLevel(newPos) || (other_stone && (!other_stone->is_removable() || 
-        (IsLevelBorder(newPos) && server::GameCompatibility != GAMET_ENIGMA)))) {
-        return;                 // avoid unremoveable and border stones
-    }
-
-    PullStone *newStone = this->clone();    // TODO never ever clone a world's object!! reengineering!
-
-    if (other_stone) {
-        // yield other_stone:
-        newStone->pull_info = new PullInfo(other_stone);
-    }
-    else {
-        newStone->pull_info = new PullInfo(0);
-    }
-
-    // search for affected actors
-    vector<Actor*> found_actors;
-    const double   range_one_field = 1.415; // approx. 1 field [ > sqrt(1+1) ]
-    GetActorsInRange(newPos.center(), range_one_field, found_actors);
-    vector<Actor*>::iterator e = found_actors.end();
-    for (vector<Actor*>::iterator i = found_actors.begin(); i != e; ++i) {
-        Actor     *actor     = *i;
-        GridPos    actor_pos(actor->get_pos());
-
-        if (actor_pos == newPos) { // if the actor is in the dest field
-            V2 vel = actor->get_vel();
-            V2 mid_dest = actor->get_pos();
-
-            mid_dest[0] = ecl::Clamp<double> (mid_dest[0], oldPos.x+0.01, oldPos.x+0.99);
-            mid_dest[1] = ecl::Clamp<double> (mid_dest[1], oldPos.y+0.01, oldPos.y+0.99);
-            WarpActor(actor, mid_dest[0], mid_dest[1], false);
-
-            newStone->pull_info->add_actor(actor, vel);
-        }
-    }
-
-    SetStone(newPos, newStone);
-    newStone->set_move_state(true, move_dir);
-    set_move_state(false, move_dir);
-
-    sound_event("moveslow");
-}
-
 /* -------------------- Volcano -------------------- */
 namespace
 {
@@ -1338,8 +1135,6 @@
 
     Register(new MovableImpulseStone);
 
-    Register (new PullStone);
-
     Register( new VolcanoStone);
     Register("st-volcano_inactive", new VolcanoStone(VolcanoStone::INACTIVE));
     Register("st-volcano_active", new VolcanoStone(VolcanoStone::ACTIVE));

Modified: trunk/src/stones_internal.hh
===================================================================
--- trunk/src/stones_internal.hh	2008-08-20 22:53:31 UTC (rev 1278)
+++ trunk/src/stones_internal.hh	2008-08-20 23:00:11 UTC (rev 1279)
@@ -52,30 +52,6 @@
        stone. */
     bool maybe_push_stone (const StoneContact &sc);
 
-/* -------------------- YieldedGridStone -------------------- */
-
-    // allows to completely remove a Stone and its model
-    // for a short time
-    //
-    // - "delays" animation
-    //
-    // @@@ FIXME: alarms have to be disabled as well
-
-    class YieldedGridStone {
-        Stone   *stone;
-        display::Model *model;
-
-        YieldedGridStone(const YieldedGridStone&);
-        YieldedGridStone& operator = (const YieldedGridStone&);
-    public:
-
-        YieldedGridStone(Stone *st);
-        ~YieldedGridStone();
-
-        void set_stone(enigma::GridPos pos);
-        void dispose();
-    };
-
 } // namespace enigma
 
 #endif

Modified: trunk/src/stones_simple.cc
===================================================================
--- trunk/src/stones_simple.cc	2008-08-20 22:53:31 UTC (rev 1278)
+++ trunk/src/stones_simple.cc	2008-08-20 23:00:11 UTC (rev 1279)
@@ -374,147 +374,6 @@
     DEF_TRAITS(ChameleonStone, "st-chameleon", st_chameleon);
 }
 
-
-/* -------------------- SwapStone -------------------- */
-
-namespace
-{
-    class SwapStone : public Stone, public TimeHandler {
-        DECL_TRAITS;    
-    public:
-        SwapStone();
-        ~SwapStone();
-    private:
-        // Object interface
-        SwapStone *clone();
-        void       dispose();
-
-        // GridObject interface
-        void init_model();
-        void on_removal(GridPos p);
-
-        // Stone interface
-        void on_impulse (const Impulse &impulse);
-        bool is_removable() const { return state == IDLE; }
-        void actor_hit (const StoneContact &sc);
-
-        // TimeHandler interface
-        void alarm();
-
-        // Variables :
-        enum State { IDLE, COME, GO } state;
-        YieldedGridStone *in_exchange_with;
-        Direction         move_dir;
-    };
-    DEF_TRAITSM(SwapStone, "st-swap", st_swap, MOVABLE_IRREGULAR);
-}
-
-SwapStone::SwapStone()
-: state(IDLE),
-  in_exchange_with(0),
-  move_dir(NODIR)
-{}
-
-SwapStone::~SwapStone() {
-    GameTimer.remove_alarm(this);
-}
-
-SwapStone *SwapStone::clone() {
-    SwapStone *other        = new SwapStone(*this);
-    other->in_exchange_with = 0;
-    return other;
-}
-
-void SwapStone::dispose() {
-    if (state == COME && in_exchange_with != 0) {
-        in_exchange_with->dispose();
-        delete in_exchange_with;
-    }
-    delete this;
-}
-
-void SwapStone::on_removal(GridPos p) {
-    if (state == COME) {
-        GameTimer.remove_alarm(this);
-        GridPos oldPos = move(get_pos(), reverse(move_dir));
-        SwapStone *other = dynamic_cast<SwapStone *>(GetStone(oldPos));
-        if (other != NULL) {
-            other->state = IDLE;
-            other->init_model();
-        }
-    }
-    GridObject::on_removal(p);
-}
-
-/* Animation finished; put the "swapped" stone to its new position. */
-void SwapStone::alarm()
-{
-    GridPos oldPos = move(get_pos(), reverse(move_dir));
-
-    // Set the swapped stone (this also kills the old (inactive) swap stone)
-    in_exchange_with->set_stone(oldPos);
-    delete in_exchange_with;
-    in_exchange_with = 0;
-
-    state = IDLE;
-    init_model();
-//    sound_event ("moveslow");
-}
-
-void SwapStone::on_impulse(const Impulse& impulse) 
-{
-    if (state == IDLE) {
-        GridPos oldp = get_pos();
-        GridPos newp = move(oldp, impulse.dir);
-
-        // never swap beyond the world and for non enigma modes do not swap to
-        // border as well.
-        if (IsInsideLevel(newp) &&
-                (server::GameCompatibility == GAMET_ENIGMA || !IsLevelBorder(newp))) {
-            Stone *other = GetStone(newp);
-            if (other && other->is_removable()) {
-                SwapStone *newStone = new SwapStone;
-                newStone->state            = COME;
-                newStone->in_exchange_with = new YieldedGridStone(other); // yields 'other'
-                newStone->move_dir         = impulse.dir;
-
-                GameTimer.set_alarm(newStone, 0.1, false);
-
-                SetStone(newp, newStone);
-
-                state    = GO;
-                move_dir = impulse.dir;
-                init_model();
-
-                sound_event ("moveslow");
-                server::IncMoveCounter(1);
-            }
-        }
-    }
-}
-
-void SwapStone::actor_hit(const StoneContact &sc) {
-    Direction dir = get_push_direction (sc);
-    if (dir != NODIR) {
-        send_impulse(get_pos(), dir);
-    }
-}
-
-void SwapStone::init_model() {
-    static const char *models_come[] = { "st-swap-w", "st-swap-s", "st-swap-e", "st-swap-n" };
-    static const char *models_go[] =   { "st-swap-e", "st-swap-n", "st-swap-w", "st-swap-s" };
-
-    const char *model = 0;
-    switch (state) {
-    case IDLE: model = "st-swap"; break;
-    case COME: model = models_come[move_dir]; break;
-    case GO:   model = models_go[move_dir]; break;
-    }
-
-    set_model(model);
-}
-
-
 /* -------------------- BlockStone -------------------- */
 
 namespace
@@ -1658,6 +1517,10 @@
 
         bool is_sticky(const Actor *) const 
         { return false; }
+        
+        void on_move() {
+            // we are not floating, but we do not shatter actors when swapped or pulled
+        }
     };
     DEF_TRAITSM(BrakeStone, "st-brake", st_brake, MOVABLE_BREAKABLE);
 }
@@ -1823,7 +1686,7 @@
                 Stone::actor_hit(sc);
         }
 
-        void on_move() {
+        void on_floor_change() {
             GridPos p = get_pos();
             if (Floor *fl = GetFloor (p)) {
                 if (fl->is_kind("fl-abyss")) {
@@ -1901,8 +1764,6 @@
     Register(new Stone_break("st-break_gray"));
     Register(new Stone_movebreak);
     Register(new Stonebrush);
-    Register(new SwapStone);
-
     Register(new ThiefStone);
 
     Register(new RandomWoodenStone); // random flavor



From andreasl at mail.berlios.de  Thu Aug 21 03:05:21 2008
From: andreasl at mail.berlios.de (andreasl at mail.berlios.de)
Date: Thu, 21 Aug 2008 03:05:21 +0200
Subject: [Enigma-game-svn] r1280 - in trunk: data data/levels/lib src
Message-ID: <200808210105.m7L15L5P012828@sheep.berlios.de>

Author: andreasl
Date: 2008-08-21 03:05:17 +0200 (Thu, 21 Aug 2008)
New Revision: 1280

Modified:
   trunk/data/api2init.lua
   trunk/data/levels/lib/libluatools.xml
   trunk/data/levels/lib/libmap.xml
   trunk/src/lua.cc
Log:
Trunk:
 - For createWorld, the default key can be admitted, if
   the map has an entry "defaultkey" (e.g. via libmap).
 - Fix wrong error message for undefined tiles in
   resolvers.
 - libluatools:
    - Better support for positions in manhattan_distance.
    - luatools.combinations allows base number instead of base.
 - libmap:
    - Adapt to new lib-metatable-services via:
        setmetatable(lib.map, getmetatable(lib))
    - Use "map.type" to ask for type.
    - Use better names for map transformation constants.
    - Adapt lib.map.sub to syntax of drawRect
    - New function: lib.map.paste copies maps into other maps.
    - New function: lib.map.replace replaces all instances of
        one tile key by another (e.g. an "ignore" tile key).
    - Better support for various arguments in several functions.
    - Rename "setDefaultKey" to "set_default_key"
 - Add support of transformation ("read direction") constants
   and for libmap-maps in wo:drawMap


Modified: trunk/data/api2init.lua
===================================================================
--- trunk/data/api2init.lua	2008-08-20 23:00:11 UTC (rev 1279)
+++ trunk/data/api2init.lua	2008-08-21 01:05:17 UTC (rev 1280)
@@ -140,23 +140,69 @@
 FOLLOW_HALFSCREEN = po(9.5, 6)
 
 -- Read directions for maps
-MAP_DEFAULT = 0
-MAP_CW = 1
-MAP_180 = 2
-MAP_CCW = 3
-MAP_MIRROR_HORIZONTAL = 4
-MAP_MIRROR_VERTICAL = 5
+MAP_IDENT = 0
+MAP_ROT_CW = 1
+MAP_ROT_180 = 2
+MAP_ROT_CCW = 3
+MAP_MIRROR_BACKSLASH = 4
+MAP_MIRROR_HORIZONTAL = 5
 MAP_MIRROR_SLASH = 6
-MAP_MIRROR_BACKSLASH = 7
+MAP_MIRROR_VERTICAL = 7
+MAP_COUNT = 7
 
 ---------------------
 -- Utility Methods --
 ---------------------
 
 wo:_register("drawMap", 
-    function (world, resolver, origin, ignore, map)
+    function (world, resolver, anchor, ignorearg, maparg, readarg)
         -- TODO check validity of arguments
+        -- world, resolver, (position|object|table), string, (table|map), [int]
+        -- world, resolver, (position|object|table), map, [int]
+        -- Analyse arguments 3 to 6
+        local origin = anchor
+        if type(origin) == "table" then
+            origin = po(origin)
+        end
+        local ignore = ignorearg
+        local map = maparg
+        local readdir = readarg or MAP_IDENT
+        if (ignorearg.type == "map") then
+            map = ignorearg
+            ignore = map.defaultkey
+            readdir = maparg or MAP_IDENT
+        elseif     (type(map.defaultkey) == "string")
+               and (string.len(map.defaultkey) ~= string.len(ignore)) then
+            error("drawmap: Ignore key and default key differ in length.", 2)
+        end
         local len = string.len(ignore)
+        if    (type(readdir) ~= "number") or (readdir % 1 ~= 0)
+           or (readdir < MAP_IDENT) or (readdir > MAP_COUNT) then
+            error("drawmap: Unknown read direction.", 2)
+        end
+        -- Prepare read direction rotation
+        local w, h = 0, 0
+        local function rot(x, y)
+            -- The difference of this function to the one in libmap
+            -- results among others from different coordinate origins
+            -- and different application of rot.
+            return ({[MAP_IDENT]             = {x,         y},
+                     [MAP_ROT_CW]            = {h + 1 - y, x},
+                     [MAP_ROT_180]           = {w + 1 - x, h + 1 - y},
+                     [MAP_ROT_CCW]           = {y,         w + 1 - x},
+                     [MAP_MIRROR_HORIZONTAL] = {w + 1 - x, y},
+                     [MAP_MIRROR_VERTICAL]   = {x,         h + 1 - y},
+                     [MAP_MIRROR_SLASH]      = {y,         x},
+                     [MAP_MIRROR_BACKSLASH]  = {h + 1 - y, w + 1 - x} })[readdir]
+        end
+        if readdir ~= MAP_IDENT then
+          -- Calculate height and width for rotation if neccessary
+          h = #map
+          for y = 1, h do
+            w = math.max(w, string.len(map[y])/len)
+          end
+        end
+        -- Draw map
         for y=1, #map do
             local linelen = string.len(map[y])
             if math.fmod(linelen, len) ~= 0 then
@@ -165,9 +211,20 @@
             for x = 1, linelen/len do
                 local key = string.sub(map[y], len*(x-1)+1, len*x)
                 if key ~= ignore then
-                    world[origin + {x-1, y-1}] =  
-                            world:_evaluate(resolver, key, origin.x + x - 1, 
-                                    origin.y + y-1)
+                    local p = {origin.x - 1, origin.y - 1}
+                    if readdir == MAP_IDENT then
+                      p = {p[1] + x, p[2] + y}
+                    else
+                      p = {p[1] + (rot(x,y))[1], p[2] + (rot(x,y))[2]}
+                    end
+                    tile = world:_evaluate(resolver, key, p[1], p[2])
+                    if tile then
+                        world[p] = tile
+                    else
+                        error("drawmap: undefined tile '" .. key .. "' at "
+                              .. p[1] .. ", " .. p[2] .. "(in submap at "
+                              .. x .. ", ".. y .. ")")
+                    end
                 end
             end
         end

Modified: trunk/data/levels/lib/libluatools.xml
===================================================================
--- trunk/data/levels/lib/libluatools.xml	2008-08-20 23:00:11 UTC (rev 1279)
+++ trunk/data/levels/lib/libluatools.xml	2008-08-21 01:05:17 UTC (rev 1280)
@@ -33,6 +33,7 @@
 -- deep_copy returns a copy of SOURCE, where table entries are
 -- not copied as memory references, but complete ("deep copy").
 -- Metatables are transfered, but not deep-copied.
+-- TODO: use rawset/rawget instead.
 function luatools.deep_copy(source)
  if type(source) ~= "table" then
    return source
@@ -146,8 +147,16 @@
     return math.abs(x1 - x2) + math.abs(y1 - y2)
   end
   if x1 and y1 then
-    -- x1 and y1 are positions
-    return math.abs(x1.x - y1.x) + math.abs(x1.y - y1.y)
+    -- x1 and y1 are positions, possibly tables.
+    local p1 = x1
+    local p2 = y1
+    if type(p1) == "table" then
+      p1 = po(p1)
+    end
+    if type(p2) == "table" then
+      p2 = po(p2)
+    end
+    return math.abs(p1.x - p2.x) + math.abs(p1.y - p2.y)
   end
   error("manhattan_distance: Too less arguments.")  
 end
@@ -162,6 +171,12 @@
 -- values as it should. The following function returns (given
 -- an integer) another integer between 0 and MODUL-1.
 function luatools.mod(value, modul)
+  if (type(value) ~= "number") or (type(modul) ~= "number") then
+    error("luatools.mod: Arguments are not two numbers.")
+  end
+  if modul <= 0 then
+    error("luatools.mod: Second argument (modul) must be positive.")
+  end
   if value < 0 then
     -- No, the following call to luatools.mod is not a real
     -- recursion, it's only for the case where VALUE is a
@@ -248,10 +263,26 @@
 -- of depth DEPTH.
 function luatools.combinations(depth, digits)
   local all_combinations = {{}}
+  local digs = digits
+  if (type(depth) ~= "number") or (depth < 1) or (depth ~= math.floor(depth)) then
+    error("combinations: First argument (depth) not a number or out of range.")
+  end
+  if type(digits) == "number" then
+    if (digits < 1) or (digits ~= math.floor(digits)) then
+      error("combinations: Second argument (digits) out of range.")
+    end
+    digs = {}
+    for j = 1, digits do
+      digs[j] = j
+    end
+  end
+  if type(digs) ~= "table" then
+    error("combinations: Second argument (digits) should be number or table.")
+  end
   for _ = 1, depth do
     local next_step = {}
     for _, old_combination in pairs(all_combinations) do
-      for _, new_digit in pairs(digits) do
+      for _, new_digit in pairs(digs) do
         local new_combination = luatools.deep_copy(old_combination)
         table.insert(new_combination, new_digit)
         table.insert(next, new_combination)
@@ -295,6 +326,9 @@
   if type(n) ~= "number" then
     error("permutation: Expected number, got "..type(n).."!")
   end
+  if (n < 1) or (n ~= math.floor(n)) then
+    error("permutation: Argument must be positive integer.")
+  end
   local sequence = {}
   for j = 1, n do
     table.insert(sequence, j)

Modified: trunk/data/levels/lib/libmap.xml
===================================================================
--- trunk/data/levels/lib/libmap.xml	2008-08-20 23:00:11 UTC (rev 1279)
+++ trunk/data/levels/lib/libmap.xml	2008-08-21 01:05:17 UTC (rev 1280)
@@ -29,30 +29,28 @@
 --   lib.map.concat_vertically(map1, map2)    aka. map1 + map2
 --   lib.map.fuse(arg1, arg2)                 aka. map1 * map2
 --   lib.map.transform(map, op)               aka. map ^ op
---   lib.map.get(map, key)                    aka. map[key]
---   lib.map.set(map, key, value)             aka. map[key] = value
---   lib.map.extend(map, key)                 aka. map:extend(key)
---   lib.map.sub(map, arg1, arg2)             aka. map:sub(arg1, arg2)
---   lib.map.covers(map, pos)                 aka. map:covers(pos)
---   lib.map.setDefaultKey(map, newkey)       aka. map:setDefaultKey(newkey)
+--   lib.map.get(map, posarg)                 aka. map[posarg]
+--   lib.map.set(map, posarg, value)            aka. map[posarg] = value
+--   lib.map.extend(map, posarg)                aka. map:extend(posarg)
+--   lib.map.sub(map, arg1, arg2)               aka. map:sub(arg1, arg2)
+--   lib.map.paste(map1, map2, posarg, ignore)  aka. map1:paste(map2, posarg, ignore)
+--   lib.map.covers(map, pos)                   aka. map:covers(pos)
+--   lib.map.set_default_key(map, newkey)       aka. map:set_default_key(newkey)
 --   lib.map.print(map, withXYCounts, left_separator, right_separator)
 --                                            aka. map:print(...)
 -- Please consult the reference manual for details.
 --
 
-if not lib then
-  lib = {}
-end
-
 lib.map = {}
+setmetatable(lib.map, getmetatable(lib))
 
 function lib.map.concat_horizontally(map1, map2)
-  if    (type(map1) ~= "table") or (rawget(map1, "__type") ~= "map")
-     or (type(map2) ~= "table") or (rawget(map2, "__type") ~= "map") then
-    error("lib.map.concat_horizontally: Can only work on maps.")
+  if    (type(map1) ~= "table") or (map1.type ~= "map")
+     or (type(map2) ~= "table") or (map2.type ~= "map") then
+    error("lib.map.concat_horizontally: Can only work on maps.", 2)
   end
   if string.len(map1.defaultkey) ~= string.len(map2.defaultkey) then
-    error("lib.map.concat_horizontally: Default keys differ in length.")
+    error("lib.map.concat_horizontally: Default keys differ in length.", 2)
   end
   local result = {}
   for y = 1, math.max(map1.height, map2.height) do
@@ -63,12 +61,12 @@
 end
 
 function lib.map.concat_vertically(map1, map2)
-  if    (type(map1) ~= "table") or (rawget(map1, "__type") ~= "map")
-     or (type(map2) ~= "table") or (rawget(map2, "__type") ~= "map") then
-    error("lib.map.concat_vertically: Can only work on maps.")
+  if    (type(map1) ~= "table") or (map1.type ~= "map")
+     or (type(map2) ~= "table") or (map2.type ~= "map") then
+    error("lib.map.concat_vertically: Can only work on maps.", 2)
   end
   if string.len(map1.defaultkey) ~= string.len(map2.defaultkey) then
-    error("lib.map.concat_vertically: Default keys differ in length.")
+    error("lib.map.concat_vertically: Default keys differ in length.", 2)
   end
   local result = {}
   for y = 1, map1.height do
@@ -92,9 +90,9 @@
   if type(arg2) == "string" then
     map2 = wo:newMap(arg2)
   end
-  if    (type(map1) ~= "table") or (rawget(map1, "__type") ~= "map")
-     or (type(map2) ~= "table") or (rawget(map2, "__type") ~= "map") then
-    error("lib.map.fuse: Can only work on maps.")
+  if    (type(map1) ~= "table") or (map1.type ~= "map")
+     or (type(map2) ~= "table") or (map2.type ~= "map") then
+    error("lib.map.fuse: Can only work on maps.", 2)
   end
   local result = {}
   for y = 1, math.max(map1.height, map2.height) do
@@ -107,45 +105,47 @@
 end
 
 function lib.map.transform(map, op)
-  if (type(map) ~= "table") or (rawget(map, "__type") ~= "map") then
-    error("lib.map.transform: Can only work on maps.")
+  if (type(map) ~= "table") or (map.type ~= "map") then
+    error("lib.map.transform: Can only work on maps.", 2)
   end
   if (type(op) ~= "number") or (op < 0) or (op > 7) or (op ~= math.floor(op)) then
-    error("lib.map.transform: Unknown transformation request")
+    error("lib.map.transform: Unknown transformation request.", 2)
   end
   local w, h = map.width, map.height
-  local function rot(pos)
-    return ({
-      [MAP_DEFAULT]           = po({pos.x,         pos.y}),
-      [MAP_CW]                = po({pos.y,         h - 1 - pos.x}), --
-      [MAP_180]               = po({w - 1 - pos.x, h - 1 - pos.y}),
-      [MAP_CCW]               = po({w - 1 - pos.y, pos.x}),         --
-      [MAP_MIRROR_HORIZONTAL] = po({w - 1 - pos.x, pos.y}),
-      [MAP_MIRROR_VERTICAL]   = po({pos.x,         h - 1 - pos.y}),
-      [MAP_MIRROR_SLASH]      = po({pos.y,         pos.x}),
-      [MAP_MIRROR_BACKSLASH]  = po({w - 1 - pos.y, h - 1 - pos.x})  --
-    })[op]
+  local function rot(x, y)
+    return ({[MAP_IDENT]             = {x,         y},
+             [MAP_ROT_CW]            = {y,         h - 1 - x},
+             [MAP_ROT_180]           = {w - 1 - x, h - 1 - y},
+             [MAP_ROT_CCW]           = {w - 1 - y, x},
+             [MAP_MIRROR_HORIZONTAL] = {w - 1 - x, y},
+             [MAP_MIRROR_VERTICAL]   = {x,         h - 1 - y},
+             [MAP_MIRROR_SLASH]      = {y,         x},
+             [MAP_MIRROR_BACKSLASH]  = {w - 1 - y, h - 1 - x}     })[op]
   end
   local new_w, new_h = w, h
-  if    (op == MAP_CW) or (op == MAP_CCW) or (op == MAP_MIRROR_SLASH)
-     or (op == MAP_MIRROR_BACKSLASH) then
+  if    (op == MAP_ROT_CW) or (op == MAP_ROT_CCW)
+     or (op == MAP_MIRROR_SLASH) or (op == MAP_MIRROR_BACKSLASH) then
     new_w, new_h = h, w
   end
   local result = {}
   for y = 1, new_h do
     result[y] = ""
     for x = 1, new_w do
-      result[y] = result[y] .. map[rot(po({x - 1, y - 1}))]
+      result[y] = result[y] .. map[rot({x - 1, y - 1})]
     end
   end
   return wo:newMap(map.defaultkey, result)  
 end
 
-function lib.map.sub(map, arg1, arg2)
-  if (type(map) ~= "table") or (rawget(map, "__type") ~= "map") then
-    error("lib.map.sub: Can only work on maps.")
+function lib.map.sub(map, origin, arg2, arg3)
+  if (type(map) ~= "table") or (map.type ~= "map") then
+    error("lib.map.sub: Can only work on maps.", 2)
   end
   local pos1, pos2 = arg1, arg2
+  if type(arg2) == "number" and type(arg3) == "number" then
+    -- arg2 and arg3 are width and height
+    pos2 = po(pos1.x + arg2 - 1, pos1.y + arg3 - 1)
+  end
   if type(pos1) == "table" then
     pos1 = po(pos1)
   end
@@ -154,123 +154,204 @@
   end
   pos1 = pos1:grid()
   pos2 = pos2:grid()
-  if (pos2.x < 0) or (pos2.y < 0) then
-    error("lib.map.sub: Second position must be positive.")
+  if (pos2.x < pos1.x) or (pos2.y < pos1.y) then
+    error("lib.map.sub: Rectangular area not cleanly defined (first argument "
+        .. "is not top left-hand corner).", 2)
   end
   local result = {}
-  for y = 1, pos2.y do
-    result[y] = string.sub(rawget(map, pos1.y + y) or "",
-                  pos1.x * map.keylength + 1,
-                  (pos1.x + pos2.x) * map.keylength) or ""
-    result[y] = result[y] .. string.rep(map.defaultkey,
-                  math.max(0, pos2.x - string.len(result[y]) / map.keylength))
+  for y = pos1.y, pos2.y do
+    if y < map.height then
+      result[y] = string.sub(rawget(map, y) or "",
+                    pos1.x * map.keylength + 1,
+                    (pos2.x + 1) * map.keylength) or ""
+    end
   end
   return wo:newMap(map.defaultkey, result)  
 end
 
-function lib.map.covers(map, pos)
-  return (pos.x >= 0) and (pos.y >= 0)
-      and (pos.x < map.width) and (pos.y < map.height)
+function lib.map.paste(map1, map2, posarg)
+  if (type(map1) ~= "table") or (map1.type ~= "map") then
+    error("lib.map.paste: Needs two maps.", 2)
+  end
+  if (type(map2) ~= "table") or (map2.type ~= "map") then
+    error("lib.map.paste: Needs two maps.", 2)
+  end
+  if (usertype(posarg) == "object") or (usertype(posarg) == "position") then
+    local kl = rawget(map2, "__keylength")
+    local dk = rawget(map2, "__defaultkey")
+    print(posarg.x..", "..posarg.y)
+    for y = 1, map2.height do
+      local line = rawget(map2, y)
+      for x = 1, map2.width do
+        tile = string.sub(line, kl * (x - 1) + 1, x * kl)
+        if tile ~= dk then
+          map1[{posarg.x + x - 1, posarg.y + y - 1}] = tile
+        end
+      end
+    end
+  elseif usertype(posarg) == "group" then
+    for obj in posarg do
+      lib.map.paste(map1, map2, obj)
+    end
+  elseif type(posarg) == "table" then
+    lib.map.paste(map1, map2, po(posarg))
+  end
 end
 
-function lib.map.get(map, key)
-  if type(key) == "string" then
-    if (key == "type") or (key == "width") or (key == "height")
-       or (key == "defaultkey") or (key == "keylength") then
-      return rawget(map, "__"..key)
-    else  
-      return map.user_attributes[key]
+function lib.map.replace(map, tile1, tile2arg)
+  if (type(map) ~= "table") or (map.type ~= "map") then
+    error("lib.map.replace: Can only work on maps.", 2)
+  end
+  local kl = rawget(map, "__keylength")
+  local tile2 = tile2arg or rawget(map, "__defaultkey")
+  if    (type(tile1) ~= "string") or (type(tile2) ~= "string")
+     or (string.len(tile1) ~= kl) or (string.len(tile2) ~= kl) then
+    error("lib.map.replace: Tiles do not have the same length as default key.")
+  end
+  for y = 1, map.height do
+    local line = rawget(map, y)
+    for x = 1, map.width do
+      tile = string.sub(line, kl * (x - 1) + 1, x * kl)
+      if tile == tile1 then
+        map[{x-1, y-1}] = tile2
+      end
     end
+  end
+end
+
+function lib.map.covers(map, pos)
+  if type(pos) == "table" then
+    return (pos[1] >= 0) and (pos[2] >= 0)
+        and (pos[1] < map.width) and (pos[2] < map.height)
   else
-    local pos = key
-    if type(pos) == "table" then
-      pos = po(pos)
-    end
-    pos = pos:grid()
+    return (pos.x >= 0) and (pos.y >= 0)
+        and (pos.x < map.width) and (pos.y < map.height)
+  end
+end
+
+function lib.map.get(map, posarg)
+  if type(posarg) == "number" then
+    return rawget(map, posarg)
+  elseif (usertype(posarg) == "position") or (usertype(posarg) == "object") then
+    local pos = posarg:grid()
     if map:covers(pos) then
       local kl = rawget(map, "__keylength")
       return string.sub(rawget(map, pos.y + 1), kl * pos.x + 1, (pos.x + 1) * kl)
     else
       return rawget(map, "__defaultkey")
     end
+  elseif usertype(posarg) == "group" then
+    local result = {}
+    for obj in posarg do
+      table.insert(result, lib.map.get(map, obj))
+    end
+    return result
+  elseif type(posarg) == "table" then
+    if map:covers(posarg) then
+      local kl = rawget(map, "__keylength")
+      return string.sub(rawget(map, posarg[2] + 1), kl * posarg[1] + 1, (posarg[1] + 1) * kl)
+    else
+      return rawget(map, "__defaultkey")
+    end
+  elseif type(posarg) == "string" then
+    if (posarg == "type") then
+      return getmetatable(map)._type
+    elseif (posarg == "width") or (posarg == "height")
+       or (posarg == "defaultkey") or (posarg == "keylength") then
+      return rawget(map, "__"..posarg)
+    else  
+      return (rawget(map, "user_attributes"))[posarg]
+    end
+  else
+    error("lib.map.get: Can't understand position argument.")
   end
 end
 
-function lib.map.set(map, key, value)
-  if type(key) == "string" then
-    if (key == "type") then
+function lib.map.set(map, posarg, value)
+  if type(posarg) == "string" then
+    if (posarg == "type") then
       if tostring(value) ~= "map" then
         error("lib.map.set: A map is a map is a map is a map, and not a "
-            .. tostring(value) .. "!")
+            .. tostring(value) .. "!", 2)
       else
         return
       end
-    elseif (key == "width") or (key == "height") then
-      error("lib.map.set: Use extend or sub to change the size of a map.")
-    elseif (key == "keylength") then
-      error("lib.map.set: Can't change keylength without default key.")
-    elseif (key == "defaultkey") then
-      map:setDefaultKey(value)
+    elseif (posarg == "width") or (posarg == "height") then
+      error("lib.map.set: Use extend or sub to change the size of a map.", 2)
+    elseif (posarg == "keylength") then
+      error("lib.map.set: Can't change keylength without default key.", 2)
+    elseif (posarg == "defaultkey") then
+      map:set_default_key(value)
       return
     end
-    map.user_attributes[key] = value
+    map.user_attributes[posarg] = value
   else
     if type(value) ~= "string" then
-      error("lib.map.set: Key must be of type string, is "..type(value)..".")
+      error("lib.map.set: Key must be of type string, is "..type(value)..".", 2)
     end
     local kl = rawget(map, "__keylength")
     if string.len(value) ~= kl then
       error("lib.map.set: Key must be of the same length as default key "
-          .."(should be "..kl.. ", is "..string.len(value)..").")
+          .."(should be "..kl.. ", is "..string.len(value)..").", 2)
     end
-    local pos = key
-    if type(pos) == "table" then
-      pos = po(pos)
+    if (usertype(posarg) == "position") or (usertype(posarg) == "object") then
+      local pos = posarg:grid()
+      if (pos.x < 0) or (pos.y < 0) then
+        error("lib.map.set: Negative positions are not supported.", 2)
+      end
+      map:extend(pos)
+      rawset(map, pos.y + 1,
+             string.sub(rawget(map, pos.y + 1), 1, pos.x * kl)
+          .. value
+          .. string.sub(rawget(map, pos.y + 1), (pos.x + 1) * kl + 1, -1))
+    elseif usertype(posarg) == "group" then
+      for obj in posarg do
+        map:extend(obj)
+        rawset(map, obj.y + 1,
+             string.sub(rawget(map, obj.y + 1), 1, obj.x * kl)
+          .. value
+          .. string.sub(rawget(map, obj.y + 1), (obj.x + 1) * kl + 1, -1))
+      end
+    elseif type(posarg) == "table" then
+      lib.map.set(map, po(posarg), value)
     end
-    pos = pos:grid()
-    if (pos.x < 0) or (pos.y < 0) then
-      error("lib.map.set: Negative positions are not supported.")
-    end
-    map:extend(pos)
-    rawset(map, pos.y + 1,
-           string.sub(rawget(map, pos.y + 1), 1, pos.x * kl)
-        .. value
-        .. string.sub(rawget(map, pos.y + 1), (pos.x + 1) * kl + 1, -1))
   end
 end
 
-function lib.map.extend(map, key)
-  if (type(map) ~= "table") or (rawget(map, "__type") ~= "map") then
-    error("lib.map.extend: Can only work on maps.")
+function lib.map.extend(map, posarg)
+  if (type(map) ~= "table") or (map.type ~= "map") then
+    error("lib.map.extend: Can only work on maps.", 2)
   end
-  local pos = key
+  local pos = posarg
   if type(pos) == "table" then
     pos = po(pos)
   end
-  pos = pos:grid()
   local w, h = rawget(map, "__width"), rawget(map, "__height")
-  local dk = rawget(map, "__defaultkey")
   if pos.x >= w then
+    pos = pos:grid()  
+    local dk = rawget(map, "__defaultkey")
     local attach = string.rep(dk, pos.x - w + 1)
     for y = 1, h do
       rawset(map, y, rawget(map, y) .. attach)
     end
     w = pos.x + 1
+    rawset(map, "__width", w)
   end
   if pos.y >= h then
+    pos = pos:grid()
+    local dk = rawget(map, "__defaultkey")
     local line = string.rep(dk, w)
     for y = h + 1, pos.y + 1 do
       rawset(map, y, line)
     end
     h = pos.y + 1
+    rawset(map, "__height", h)
   end
-  rawset(map, "__width", w)
-  rawset(map, "__height", h)
 end
 
 function lib.map.print(map, withXYCounts, left_separator, right_separator)
-  if (type(map) ~= "table") or (rawget(map, "__type") ~= "map") then
-    error("lib.map.print: Can only print maps, sorry.")
+  if (type(map) ~= "table") or (map.type ~= "map") then
+    error("lib.map.print: Can only print maps, sorry.", 2)
   end
   local w, h = map.width, map.height
   local kl = rawget(map, "__keylength")
@@ -294,19 +375,20 @@
   end
 end
 
-function lib.map.setDefaultKey(map, newkey)
-  if (type(map) ~= "table") or (rawget(map, "__type") ~= "map") then
-    error("lib.map.setDefaultKey: Can only set default key of maps, sorry.")
+function lib.map.set_default_key(map, newkey)
+  if (type(map) ~= "table") or (map.type ~= "map") then
+    error("lib.map.set_default_key: Can only set default key of maps, sorry.", 2)
   end
   if type(newkey) ~= "string" then
-    error("lib.map.setDefaultKey: Default key must be string, is "..type(newkey)..".")
+    error("lib.map.set_default_key: Default key must be string, is "
+          .. type(newkey)..".", 2)
   end
   if newkey == "" then
-    error("lib.map.setDefaultKey: Default key can't be empty.")
+    error("lib.map.set_default_key: Default key can't be empty.", 2)
   end
   local new_width = map.width * map.keylength / string.len(newkey)
   if new_width ~= math.ceil(new_width) then
-    error("lib.map.setDefaultKey: Map width doesn't fit to new default key.")
+    error("lib.map.set_default_key: Map width doesn't fit to new default key.", 2)
   end
   rawset(map, "__defaultkey", newkey)
   rawset(map, "__keylength", string.len(newkey))
@@ -320,6 +402,7 @@
   __pow = lib.map.transform,
   __index = lib.map.get,
   __newindex = lib.map.set,
+  _type = "map"
 }
 
 wo:_register("newMap",
@@ -327,10 +410,11 @@
     local newmap = {user_attributes = {}}
     -- Check arguments, create map if necessary.
     if type(defaultKey) ~= "string" then
-      error("newMap: Default key is not of type string, but "..type(defaultKey)..".")
+      error("newMap: Default key is not of type string, but "
+            .. type(defaultKey) .. ".", 2)
     end
     if defaultKey == "" then
-      error("newMap: Default key can't be empty.")
+      error("newMap: Default key can't be empty.", 2)
     end
     local width = 0
     local height = 0
@@ -343,18 +427,18 @@
           height = math.max(height, key)
           if type(entry) ~= "string" then
             error("newMap: Line " .. key .. " is not a string, but "
-                  .. type(entry) .. ".")
+                  .. type(entry) .. ".", 2)
           end
           local line_width = string.len(entry) / kl
           if line_width ~= math.floor(line_width) then
-            error("newMap: Line " .. key .. " doesn't fit to key length.")
+            error("newMap: Line " .. key .. " doesn't fit to key length.", 2)
           end
           width = math.max(width, line_width)
           newmap[key] = entry
         elseif type(key) == "string" then
           newmap.user_attributes[key] = entry
         else
-          error("newMap: Strange type for a table key: " .. type(key) .. ".")
+          error("newMap: Strange type for a table key: " .. type(key) .. ".", 2)
         end
       end
       -- Now complete the map, make it rectangular.
@@ -367,7 +451,7 @@
       -- Create map from scratch.
       if (arg1 < 1) or (arg2 < 1) or (arg1 ~= math.floor(arg1))
           or (arg2 ~= math.floor(arg2)) then
-        error("newMap: Width or Height out of range ("..arg1..", "..arg2..").")
+        error("newMap: Width or Height out of range ("..arg1..", "..arg2..").", 2)
       end
       local line = string.rep(defaultKey, arg1)
       for y = 1, arg2 do      
@@ -382,10 +466,9 @@
     --  -- Interpret arg1 as position.
     --  return wo:newMap(defaultKey, pos.x + 1, pos.y + 1)
     else
-      error("newMap: Syntax error. Can't understand arguments.")
+      error("newMap: Syntax error. Can't understand arguments.", 2)
     end
     -- Set additional values.
-    newmap.__type = "map"
     newmap.__width = width
     newmap.__height = height
     newmap.__defaultkey = defaultKey
@@ -393,9 +476,11 @@
     -- Set methods and finally metatable.
     newmap.print = lib.map.print
     newmap.covers = lib.map.covers
-    newmap.setDefaultKey = lib.map.setDefaultKey
+    newmap.set_default_key = lib.map.set_default_key
     newmap.extend = lib.map.extend
     newmap.sub = lib.map.sub
+    newmap.paste = lib.map.paste
+    newmap.replace = lib.map.replace
     setmetatable(newmap, lib.map.metatable)
     return newmap
   end

Modified: trunk/src/lua.cc
===================================================================
--- trunk/src/lua.cc	2008-08-20 23:00:11 UTC (rev 1279)
+++ trunk/src/lua.cc	2008-08-21 01:05:17 UTC (rev 1280)
@@ -2044,17 +2044,32 @@
 static int createWorld(lua_State *L) {
     // world, resolver, default key, map
     // world, (ti|function|table), string, table
+    // world, (ti|function|table), string, number, number
+    // world, (ti|function|table), libmap-map
     if (server::WorldSized) {
         throwLuaError(L, "World recreation not allowed");
         return 0;
     }
     
+    // Is third argument a table? If so, check for an entry called
+    // "defaultkey" and insert it into the stack at position 3.
+    // This is consistent with libmap, as a metamethod will be
+    // triggered, but can be used more generally as well.
+    if (is_table(L, 3)) {
+        lua_getfield(L, 3, "defaultkey");
+        if (not lua_isstring(L, -1))
+            throwLuaError(L, "World create with false argument types");
+        lua_insert(L, 3);
+    }
+    
+    // check arguments
     int width = 0;
     int height = 0;
     int keyLength = 1;
     std::string defaultKey;
-    if (!((is_tiles(L, 2)||lua_isfunction(L, 2)||is_table(L, 2)) && lua_isstring(L, 3) && 
-            (is_table(L, 4) || (lua_isnumber(L, 4) && lua_isnumber(L, 5))))) {
+    if (!(   (is_tiles(L, 2) || lua_isfunction(L, 2) || is_table(L, 2))
+          &&  lua_isstring(L, 3)
+          && (is_table(L, 4) || (lua_isnumber(L, 4) && lua_isnumber(L, 5))))) {
         throwLuaError(L, "World create with false argument types");
         return 0;
     }
@@ -2149,8 +2164,9 @@
 }
 
 static int dispatchWorldWriteAccess(lua_State *L) {
+    // [string] = value
     // [object|position|table] = table|tile
-    // [string] = value
+    // [object|position|table] = nil (=> error)
     if (lua_isstring(L, 2)) {
         std::string name = lua_tostring(L, 2);
         // TODO check string
@@ -2226,8 +2242,12 @@
         else // is tile
             setObjectByTile(L, x, y);
         return 0;
+    } else if ((is_object(L, 2) || is_position(L, 2) || is_table(L, 2) || is_group(L, 2)) && 
+            lua_isnil(L, 3)) {
+        throwLuaError(L, "World write access with nil value (undefined tile?)");
+        return 0;
     } else {
-        throwLuaError(L, "World write access with bad index");
+        throwLuaError(L, "World write access with bad index or bad value");
         return 0;
     }
 }



From andreasl at mail.berlios.de  Fri Aug 22 03:10:04 2008
From: andreasl at mail.berlios.de (andreasl at mail.berlios.de)
Date: Fri, 22 Aug 2008 03:10:04 +0200
Subject: [Enigma-game-svn] r1281 - in homepage/input: . articles
Message-ID: <200808220110.m7M1A4oj010291@sheep.berlios.de>

Author: andreasl
Date: 2008-08-22 03:09:49 +0200 (Fri, 22 Aug 2008)
New Revision: 1281

Added:
   homepage/input/articles/level_andreas11_de.html
Modified:
   homepage/input/articles/apprentice_1.html
   homepage/input/articles/apprentice_1_de.html
   homepage/input/articles/level_andreas11.html
   homepage/input/hp_archive.html
   homepage/input/hp_archive_de.html
   homepage/input/hp_archive_ru.html
   homepage/input/infobox.html
   homepage/input/infobox_de.html
   homepage/input/infobox_ru.html
   homepage/input/schema.html
Log:
Homepage:
 - German translation of Alain's article "Patterns of Impulse"
 - Add to infobox: "Independent article"   
 - Validation (incl. correction of DOCTYPE)   
Todo:
 - Russian translation of "Independent article" in infobox.
 - Upload


Modified: homepage/input/articles/apprentice_1.html
===================================================================
--- homepage/input/articles/apprentice_1.html	2008-08-21 01:05:17 UTC (rev 1280)
+++ homepage/input/articles/apprentice_1.html	2008-08-22 01:09:49 UTC (rev 1281)
@@ -26,4 +26,4 @@
 
 <p><i>
 Mecke
-</p></i>
+</i></p>

Modified: homepage/input/articles/apprentice_1_de.html
===================================================================
--- homepage/input/articles/apprentice_1_de.html	2008-08-21 01:05:17 UTC (rev 1280)
+++ homepage/input/articles/apprentice_1_de.html	2008-08-22 01:09:49 UTC (rev 1281)
@@ -25,4 +25,4 @@
 
 <p><i>
 Mecke
-</p></i>
+</i></p>

Modified: homepage/input/articles/level_andreas11.html
===================================================================
--- homepage/input/articles/level_andreas11.html	2008-08-21 01:05:17 UTC (rev 1280)
+++ homepage/input/articles/level_andreas11.html	2008-08-22 01:09:49 UTC (rev 1281)
@@ -1,22 +1,24 @@
 <div class="lotm">
 
+<p>
 In our first independent level article, we want to talk about and look behind
 the curtains of &quot;Patterns of Impulse&quot; (IV/44). Have fun with a
 comment from Alain and one from the author!
+</p>
 
 <h2 class="lotm">My level of the moment</h2>
 
 <div class="quote">
 I recently came across &quot;Patterns of Impulse&quot;,
-which is not the kind of levels I like usually (not calm enough for me)
-but trying to solve it gave me a very good surprise, that I will try to
+which is not the kind of level I usually like (too frenetic for me)
+but trying to solve it gave me a very nice surprise that I will try to
 explain here:
 </div>
 
 <div class="quote">
-After having laughed at the show made by the impulse stones moving frantically
+After having laughed at the show made by the frantically moving impulse stones
 (look also at &quot;Stay There!&quot; or &quot;Bendixxon&quot;, the last one
-witout impulse-stones), I suddenly
+without impulse-stones), I suddenly
 discovered the mystical truth about this level:
 <span style="blue">It illustrates almost perfectly L. Boltzmann's kinetic
 theory of thermodynamics</span>!
@@ -34,7 +36,7 @@
 Blackball tries to swim into this liquid, a brownian motion crashes
 him, so he'd better stay in one of the shelters. Finally after some
 time (and some help from Blackball here and there) the fluid cools down
-and freezes again, keeping a cristallike structure (more on this later)
+and freezes again, keeping a crystal-like structure (more on this later)
 and freeing a path (hopefully) to the oxyd stones &hellip;
 </div>
 
@@ -52,7 +54,7 @@
 particles comes back to where it came, so that the total momentum is
 conserved. But if only one of the particles is moving, it gives its
 momentum to the other one, but instead of stopping, it comes back
-either: <br>
+as well: <br>
 The total momentum is doubled! We could call this a more-than-elastic
 shock. The &quot;worst&quot; case is when an impulse-stone hits the central
 stone of a group of three, which after the shock begin to move all of three,
@@ -67,7 +69,7 @@
 
 <div class="quote">
 When the stones don't move anymore, they tend by themselves to be
-arranged in a regular pattern, which we may call a cristal, and looks
+arranged in a regular pattern, which we may call a crystal, and looks
 typically like this.
 </div>
 
@@ -105,7 +107,7 @@
 
 <div class="quote">
 There is more to say about these
-structures: Imagine a row of impulse-stones in an otherwize empty terrain, each
+structures: Imagine a row of impulse-stones in an otherwise empty terrain, each
 occupying a cell with odd abscissa: Cells 1, 3, 5, etc. Then along comes
 Blackball at position 0 who pushes impulse-stone at 1 to position 2: The
 impulse-stone excites the one at 3, who goes to 4 and sends it back to position
@@ -113,9 +115,9 @@
 equilibrium position at 3, etc.: What we see is the propagation of a pressure
 wave in this pattern, which I would call a phonon. I have also observed some
 kind of cavitation (bubbles of void moving in the fluid), and temperature
-fluctuation. One can even see the ice cristal grow in a still moving fluid, and
+fluctuation. One can even see the ice crystal grow in a still moving fluid, and
 sometimes partly melting. Also when two parts of the liquid freeze in
-incompatible cristal structure, a default appears in the cristal which can
+incompatible crystal structure, a fault appears in the crystal which can
 propagate in the solid &hellip;
 </div>
 
@@ -126,8 +128,8 @@
 <div class="quote">
 Thinking to the moving switches of &quot;How solid?&quot;, &quot;The Flagstone
 Reaper&quot; and &quot;The Dark Outside&quot; I begin to realize that Andreas
-has a dangerous gift to give life to strange 
-creatures (half-robot and half-alien) and observe their independant evolution,
+has the dangerous gift of giving life to strange 
+creatures (half-robot and half-alien) and observing their independent evolution,
 not unlike the hero from a Mary Shelley book &hellip;
 </div>
 
@@ -180,7 +182,7 @@
 &quot;Tropical Island&quot; both came from the same idea of realising some
 theme in Enigma), &quot;Turn Around&quot; (15),
 &quot;Lissajous&quot; (17, finally), &quot;Moure-Switches&quot; (19, I wanted
-to create a code-puzzle level) and lots of ideas, that never made it to mature
+to create a code-puzzle level) and lots of ideas that never made it to mature
 levels. At some point I decided to write 16 levels to be published&mdash;16 being
 the square of my favourite number. This would be the first time for me to really
 publish something I programmed. Counting the levels above, we get 11.

Added: homepage/input/articles/level_andreas11_de.html
===================================================================
--- homepage/input/articles/level_andreas11_de.html	2008-08-21 01:05:17 UTC (rev 1280)
+++ homepage/input/articles/level_andreas11_de.html	2008-08-22 01:09:49 UTC (rev 1281)
@@ -0,0 +1,260 @@
+<div class="lotm">
+
+<p>
+In unserem ersten unabh&auml;ngigen Levelartikel, reden wir &uuml;ber und schauen hinter
+die Kulissen von &quot;Patterns of Impulse&quot; (IV/44). Viel Spa&szlig; mit
+einem Kommentar von Alain und einem vom Autor!
+</p>
+
+<h2 class="lotm">Mein Level des Augenblicks</h2>
+
+<div class="quote">
+K&uuml;rzlich stolperte ich &uuml;ber &quot;Patterns of Impulse&quot;, der nicht zu den
+Levels geh&ouml;rt, die ich &uuml;blicherweise mag (zu hektisch f&uuml;r mich), aber der
+Versuch, ihn zu l&ouml;sen, gab mir einen sehr sch&ouml;nen Moment der &Uuml;berraschung, den
+ich hier erkl&auml;ren m&ouml;chte:
+</div>
+
+<div class="quote">
+Nachdem ich mich &uuml;ber die Show der sich frenetisch bewegenden Impulssteine
+ausgelacht habe (man vergleiche mir &quot;Stay There!&quot; oder
+&quot;Bendixxon&quot;, letzterer ohne Impulssteine), entdeckte ich pl&ouml;tzlich
+die mysteri&ouml;se Wahrheit hinter diesem Level: <span style="blue">Er illustriert
+geradezu perfekt L. Boltzmanns kinetische Theorie der Thermodynamik</span>!
+</div>
+
+<div class="quote">
+Wiedasdennbitte? Naja, stellen Sie sich einfach die Impulssteine als sich
+bewegende Partikel vor (die freie Wegl&auml;nge ist zugegebenerma&szlig;en nicht gro&szlig;:
+weniger als eine L&auml;ngeneinheit, also die Zellenl&auml;nge in einer Landschaft), aus
+denen ein amorpher Festk&ouml;rper zu Beginn des Levels zusammengesetzt ist: Nichts
+bewegt sich, so dass die anf&auml;ngliche Temperatur absolut Null betr&auml;gt. Dann
+kommt unsere schwarze Murmel, die einen der Impulssteine nur leicht streicheln
+muss, damit pl&ouml;tzlich alles explodiert! Dies kann interpretiert werden als ein
+pl&ouml;tzliches Schmelzen des Festk&ouml;rpers (das Fluid ist nicht kompressibel
+genug, um als Gas zu gelten, daher eher als Fl&uuml;ssigkeit), and sollte unsere
+Murmel je versuchen, in dieser Fl&uuml;ssigkeit zu schwimmen, wird eine Brownsche
+Bewegung sie zerquetschen, sie bleibt also besser in Deckung. Schlie&szlig;lich, nach
+einer gewissen Zeit (und etwas Hilfe durch die Murmel hier und da), k&uuml;hlt sich
+das Fluid ab und friert wieder ein, wobei es eine kristalline Struktur einnimmt
+(dazu sp&auml;ter) und (hoffentlich) einen Weg zu den Oxydsteinen frei gibt &hellip;
+</div>
+
+<div class="quote">
+Normalerweise bedingt das Spielen eines Enigmalevels, st&auml;ndig aktiv zu sein,
+und oft ziemlich schnell, was viel Konzentration ben&ouml;tigt und den Spieler nicht
+wirklich sehen l&auml;sst, was alles geschieht. Aber f&uuml;r diesen Level, kann man
+w&auml;hrend des Abk&uuml;hlvorgangs der Fl&uuml;ssigkeit einige interessante Ph&auml;nomene
+beobachten:
+</div>
+
+<div class="quote">
+Wenn sich zwei Impulssteine treffen, sagen wir, einer bewegt sich nach rechts
+und der andere nach links, dann sto&szlig;en sie aneinander wie reale Partikel, aber
+der Sto&szlig; ist vollkommen elastisch: Nach dem Sto&szlig; bewegt sich jedes der sich
+wieder voneinander entfernenden Partikel in seine Ausgangsrichtung, so dass der
+Gesamtimpuls erhalten bleibt. Wenn sich aber nur eines der Partikel bewegt,
+gibt es nicht nur seinen Impuls weiter, sondern, anstatt anzuhalten, bewegt
+sich selbst wieder zur&uuml;ck:<br>
+Der Gesamtimpuls wird verdoppelt! Wir k&ouml;nnten dies einen mehr-als-elastischen
+Sto&szlig; nennen. Der &quot;schlimmste&quot; Fall tritt ein, wenn ein Impulsstein
+den zentralen Stein einer Gruppe aus drei Steinen trifft, aus dem sich nach dem
+Sto&szlig; alle drei Steine bewegen, zuz&uuml;glich dem anf&auml;nglich bewegten Stein, der
+reflektiert wird, so dass der Gesamtimpuls vervierfacht wird!
+</div>
+
+<div class="lotmpic">
+<img src="$$imagedir$$/articles/level_andreas11_a.png"
+alt="Kubischer Kristall" border="0">
+</div>
+
+<div class="quote">
+Wenn sich die Steine garnicht mehr bewegen, neigen sie dazu, sich von selbst in
+regelm&auml;&szlig;igen Mustern anzuordnen, die wir als Kristalle bezeichnen k&ouml;nnen, und
+die typischerweise so aussehen wie hier.
+</div>
+
+<div class="quote">
+Ich schlage vor, diese Kristallstruktur als kubisches System zu bezeichnen, da
+es wie ein kubischer Kristall in der Draufsicht aussieht. In diesem Kristall
+ist der Abstand zwischen zwei Nachbarn das Doppelte einer L&auml;ngeneinheit. Aber
+es gibt eine kompaktere, seltenere Kristallstruktur, die stabil ist (Temperatur
+Null), die ich mit einer Diamantstruktur vergleichen m&ouml;chte.
+</div>
+
+<div class="lotmpic">
+<img src="$$imagedir$$/articles/level_andreas11_b.png"
+alt="Diamantstruktur" border="0">
+</div>
+
+<div class="quote">
+(ein Teilchen fehlt auf der unteren Linie: Es ist unm&ouml;glich, ein weiteres dort
+hin zu bewegen, ohne einen der Steine aus der mittleren Reihe zu ber&uuml;hren, was
+wiederum &hellip; arrgh!)
+</div>
+
+<div class="quote">
+In dieser Kristallstruktur hat jedes Teilchen vier Nachbarn, wie in der
+kubischen Struktur, &nbsp;aber der Abstand zwischen den Nachbarn ist die
+Quadratwurzel aus 2, mal der Einheitsl&auml;nge: Etwa 70% des Vorangegangenen.
+Tats&auml;chlich gibt es eine noch kompaktere stabile Struktur, die den Raum
+komplett mit Impulssteinen ausf&uuml;llt, aber sie zu bauen w&uuml;rde viel mehr Druck
+bed&uuml;rfen, als unsere Murmel imstade ist, auszu&uuml;ben. In dieser Struktur, die ich
+gerne &quot;Neutronenstern-Struktur&quot; nennen m&ouml;chte, ist der Abstand zu den
+Nachbarn einfach eine Einheitsl&auml;nge, dann 70% der Diamant- und die H&auml;lfte der
+kubischen Struktur.
+</div>
+
+<div class="quote">
+Es gibt noch mehr &uuml;ber diese Strukturen zu berichten: Stellen Sie sich eine
+Reihe von Impulssteinen in einem ansonsten leeren Bereich vor, von denen jede
+eine Zelle mit ungerader Abszisse belegt: Zellen 1, 3, 5 usw. Dann kommt unsere
+Murmel an Position 0 und dr&uuml;ckt den Impulsstein bei 1 auf Position 2: Die
+Impulssteine regen den auf 3 an, der wandert zu 4 und sendet ihn zur&uuml;ck auf
+Position 1. Dann&nbsp; sendet der Stein auf 4 den auf 5 nach 6, der ihn wieder
+auf seine Gleichgewichtsposition bei 3 bringt, usw.: Was wir sehen, ist die
+Fortpflanzung einer Druckwelle in diesem Muster, was ich ein Phonon nennen
+w&uuml;rde. Ich habe auch eine Form von Kavitation beobachtet (Blasen der Leere, die
+sich in einem Fluid bewegen), und Temperaturfluktuationen. Man kann sogar sehen,
+wie der Eiskristall in einem noch bewegten Fluid w&auml;chst, und manchmal
+stellenweise wieder schmilzt. Auch wenn zwei Teile der Fl&uuml;ssigkeit in
+inkompatiblen Kristallstrukturen erstarren, erscheint eine Bruchstelle im
+Kristall, die sich im Festk&ouml;rper fortbewegen kann &hellip;
+</div>
+
+<div class="quote">
+Dies alles, w&auml;hrend man darauf wartet, dass sich die Situation beruhigt!
+</div>
+
+<div class="quote">
+Wenn ich an die bewegten Schalter aus &quot;How solid?&quot;, &quot;The
+Flagstone Reaper&quot; und &quot;The Dark Outside&quot; denke, beginne ich zu
+realisieren, dass Andreas die gef&auml;hrliche Gabe besitzt, seltsamen Kreaturen
+(halb robotisch und halb au&szlig;erirdisch) Leben einzuhauchen und ihre unabh&auml;ngige
+Evolution zu beobachten, nicht sehr verschieden einem Helden aus einem Mary
+Shelley Buch &hellip;
+</div>
+
+<div class="quote">
+Brrr!
+</div>
+
+<div class="author">Alain</div>
+
+<div class="quote">
+Die erste Version von &quot;Patterns of Impulse&quot;, die ich noch immer auf
+meinen Festplatten habe, datiert auf den 30. Mai 2005. In meiner internen
+Nummerierung, war er Nummer 21, und dementsprechend ein sehr sp&auml;ter Level, aber
+eins nach dem anderen &hellip;
+</div>
+
+<div class="quote">
+Als Kind spielte ich Oxyd 1 vollst&auml;ndig durch. Es war eine gro&szlig;artige
+Erfahrung, und ich denke, es formte auch meinen Charakter auf eine bestimmte
+Art und Weise, insofern als es mich lehrte, dass sich Geduld und harte Arbeit
+tats&auml;chlich auszahlen. Aber nachdem ich Level 100 vollendete, und niemanden
+fand, der mit mir die Linkgames vollst&auml;ndig durchspielte, verga&szlig; ich Oxyd
+schnell, da ich nichts von seinen Nachfolgern wusste.
+</div>
+
+<div class="quote">
+Die Jahre gingen vor&uuml;ber, ebenso wie die Spiele, die ich spielte. Ich wechselte
+von Windows zu haupts&auml;chlich Linux, als ich anfing zu studieren. Und dann, an
+einem gl&uuml;cklichen Tag in 2004 oder 2005, fand ich Enigma 0.81 zuf&auml;llig durch die
+Linuxdistribution SuSE. Sofort fesselte es meine Aufmerksamkeit, und ich begann
+zu spielen. Aber ich war auch neugierig, war dieses Spiel noch immer in
+Entwicklung? Viele Projekte werden &uuml;ber die Jahre aufgegeben. Aber nicht
+Enigma. Schnell fand ich Version 0.92 im Internet, und da ich sie nicht
+kompilieren konnte, spielte ich unter Windows. Aber ich wollte mehr - und
+analysierte die Leveldateien. Sie schienen einfach zu verstehen, und der
+BlackBallEditor half mir, ein paar erste einfache Experimente zu schreiben.
+</div>
+
+<div class="quote">
+Das erste, meine Nummer 1, war wirklich nur ein Experiment. Nummer 2 war da
+schon interessanter: Sie verwendete inverse Reibung, wie die
+&quot;Nightmare&quot;-Serie, aber ohne Totenkopfsteine. Es war einer jener
+Levels, die sich selbst l&ouml;sen. Dann hatte ich die Idee, Lissajous-Kurven in
+einem Level zu realisieren. Tats&auml;chlich war meine erste Motivation &auml;hnlich dem,
+was ich sp&auml;ter als &quot;Lissajous&quot; realisierte, aber mit einem Rotor
+statt einem beweglichen Totenkopfstein. Da ich das noch nicht programmieren
+konnte, kopierte ich einfach etwas aus Nat's &quot;When Gravity Fails&quot; und
+erzeugte so meinen ersten echten Level, der sp&auml;ter &quot;Lissajous'
+Revenge&quot; genannt werden sollte (ja, die Revenge kam zuerst, ich w&auml;hlte die
+Titel im Nachhinein). Was folgte, waren &quot;Spaceleast&quot;
+(6) und &quot;Spaceless&quot; (7), &quot;Laser Castle&quot; (8), &quot;Friend
+or Foe?&quot; (9), &quot;Laser Path&quot; (11), &quot;Robin's Wood&quot; (13),
+&quot;Tropical Island&quot; (14: Ja, &quot;Robin's Wood&quot; und
+&quot;Tropical Island&quot; entstammten beide derselben Idee, irgendein Thema
+in Enigma zu realisieren), &quot;Turn Around&quot; (15),
+&quot;Lissajous&quot; (17, schlie&szlig;lich), &quot;Moure-Switches&quot; (19, Ich
+wollte mal einen Code-R&auml;tsellevel schreiben) und viele Ideen, die es nie zu
+ausgewachsenen Levels gebracht haben. An irgendeinem Punkt entschied ich mich
+dazu, 16 Levels zu schreiben und zu ver&ouml;ffentlichen - 16 als Quadratzahl meiner
+Lieblingszahl. Das w&auml;re f&uuml;r mich tats&auml;chlich das erste Mal, dass ich etwas, was
+was ich programmiert habe, ver&ouml;ffentliche. Z&auml;hlen wir die Levels oben,
+kommen wir auf 11.
+</div>
+
+<div class="quote">
+Dann kam &quot;Patterns of Impulse&quot;, als Nummer 21. Ich wei&szlig; nicht mehr
+recht, wie sich die Idee entwickelte. Es war sicherlich nicht geplant, und ich
+denke, ich habe nur ein wenig rumgespielt, ein paar bewegliche Impulssteine
+&uuml;ber den Bildschirm verteilt, zuf&auml;llig, aber symmetrisch, nur um zu sehen, wie
+sie interagieren w&uuml;rden. Ich liebe (mathematisch) chaotisches Verhalten, das
+war bereits die treibende Kraft hinter &quot;Laser Castle&quot; und w&uuml;rde
+sp&auml;ter zu &quot;Orbitting&quot; und &quot;Chess, Bugs &amp; Rock'n'Roll&quot;
+f&uuml;hren. Chaos hat die faszinierende Eigenart, Ordnung aus sich selbst heraus zu
+erzeugen, Ordnung einer viel urspr&uuml;nglicheren Art, als wir normalerweise unter
+diesem Begriff verstehen. Muster entspringen dem Chaos - und exakt das war es,
+was mit den Impulssteinen geschah. Es war faszinierend.
+</div>
+
+<div class="quote">
+Ich habe &uuml;brigens diese erste Version von &quot;Patterns of Impulse&quot;
+herausgekramt und f&uuml;r Enigma 1.01 aufbereitet. Sie k&ouml;nnen sie <a
+href="http://download.berlios.de/enigma-game/andreas11_a.xml">hier</a>
+herunterladen. 
+</div>
+
+<div class="quote">
+Da waren bereits Oxydsteine, ich hatte welche in die Ecken des Levels gepackt.
+Zun&auml;chst nur, um BlackBallEd ruhig zu stellen, der mich sonst den Level nicht
+h&auml;tte speichern lassen. Aber dann versuchte ich, die Oxydsteine durch das sich
+entwickelnde Chaos hindurch zu erreichen. Und versagte. Nachdem ich den sich
+bewegenden Impulssteinen zusah, wurde es eine interessante Herausforderung,
+auch die Oxydsteine zu &ouml;ffnen. Obwohl ich feststellen musste, dass der Level
+noch nicht perfekt war. Ich brauchte mehr Kontrolle, nur ein wenig mehr. Ich
+wollte den Spieler dazu zwingen, das Chaos zu kontrollieren, es ruhig zu
+halten. Ein guter Geschicklichkeits-Spieler w&uuml;rde die Steine einfach &ouml;ffnen,
+indem er sich durch das allgegenw&auml;rtige Chaos schleicht - das war nicht, was
+ich als die interessantere Herausforderung sah.
+</div>
+
+<div class="quote">
+Also entfernte ich vier der Impulssteine (ausgew&auml;hlt nach Design&uuml;berlegungen),
+und f&uuml;gte die T&uuml;ren hinzu, um die Oxydsteine wegzusperren, indem ich Trigger un
+Steine in den (unsichtbaren) Bildschirmen ober- und unterhalb einbaute. Ich
+hatte diese Technik bereits zuvor verwendet, in &quot;Laser Castle&quot;, und
+kombinierte sie hier mit Timersteinen, um sicherzustellen, dass die T&uuml;ren einen
+Moment warten w&uuml;rden, bevor sie den Weg zu den Oxyds wieder &ouml;ffnen. Es
+funktionierte gro&szlig;artig. Ich dachte &uuml;ber den Titel nach. Zu der Zeit hatte ich
+etwas &uuml;ber eine Star-Trek-Folge namens &quot;Patterns of Force&quot gelesen, zu
+deutsch &quot;Schablonen der Gewalt&quot;. Ich habe die Folge nie gesehen, und
+sie wird als eine der schlechtesten Star-Trek-Folgen &uuml;berhaupt bezeichnet, aber
+der Titel setzte sich in meinem Kopf fest. Ich freundete mich schnell mit
+&quot;Patterns of Impulse&quot; an, der den Level perfekt beschreibt, wie ich
+meine. 
+</div>
+
+<div class="quote">
+Ich f&uuml;gte einen Easymode hinzu, und am 1. Juli 2005 schickte ich &quot;Patterns
+of Impulse&quot; und 15 weitere Levels an die Entwickler-Mailingliste, mit dem
+guten Gef&uuml;hl, Arbeit getan zu haben, und nun mit Enigma durch zu sein, und mich
+anderen Dingen zuwenden zu k&ouml;nnen. W&auml;re da nicht diese anhaltende Diskussion
+&uuml;ber Level-Bewertungen gewesen &hellip;
+</div>
+
+<div class="author">Andreas Lochmann</div>
+
+</div>

Modified: homepage/input/hp_archive.html
===================================================================
--- homepage/input/hp_archive.html	2008-08-21 01:05:17 UTC (rev 1280)
+++ homepage/input/hp_archive.html	2008-08-22 01:09:49 UTC (rev 1281)
@@ -25,6 +25,7 @@
   <li><a href="$$april_2008$$">April Fool's Day Joke 2008 - &quot;The Three Clouds&quot;</a>
   </li>
   <li><a href="$$apprentice_1$$">The Apprentice, Part 1</a>
+  </li>
 </ul>
 
 

Modified: homepage/input/hp_archive_de.html
===================================================================
--- homepage/input/hp_archive_de.html	2008-08-21 01:05:17 UTC (rev 1280)
+++ homepage/input/hp_archive_de.html	2008-08-22 01:09:49 UTC (rev 1281)
@@ -24,7 +24,7 @@
   </li>
   <li><a href="$$april_2008$$">Aprilscherz 2008 - &quot;The Three Clouds&quot;</a>
   </li>
+  <li><a href="$$apprentice_1$$">Der Neuling, Teil 1</a>
   </li>
-  <li><a href="$$apprentice_1$$">Der Neuling, Teil 1</a>
 </ul>
 

Modified: homepage/input/hp_archive_ru.html
===================================================================
--- homepage/input/hp_archive_ru.html	2008-08-21 01:05:17 UTC (rev 1280)
+++ homepage/input/hp_archive_ru.html	2008-08-22 01:09:49 UTC (rev 1281)
@@ -23,6 +23,6 @@
   </li>
   <li><a href="$$april_2008$$">??????????????? ????? 2008 - &quot;The Three Clouds&quot;</a>
   </li>
+  <li><a href="$$apprentice_1$$">The Apprentice, Part 1</a>
   </li>
-  <li><a href="$$apprentice_1$$">The Apprentice, Part 1</a>
 </ul>

Modified: homepage/input/infobox.html
===================================================================
--- homepage/input/infobox.html	2008-08-21 01:05:17 UTC (rev 1280)
+++ homepage/input/infobox.html	2008-08-22 01:09:49 UTC (rev 1281)
@@ -12,6 +12,13 @@
            <a href="$$lotm_current$$">&quot;$$lotm_current_name$$&quot;</a>
          </div>
 
+         <h3>Independent Article</h3>
+         <a href="$$level_andreas11$$"><img src="images/articles/level_andreas11_a.png"
+         alt="Patterns of Impulse" border="0"></a>
+         <div class="imagetitle">
+           <a href="$$lotm_current$$">&quot;Patterns of Impulse&quot;</a>
+         </div>
+         
          <!--
          <h3>April Fool's Day '08</h3>
          <a href="$$april_2008$$"><img src="$$imagedir$$/articles/april_2008.png"

Modified: homepage/input/infobox_de.html
===================================================================
--- homepage/input/infobox_de.html	2008-08-21 01:05:17 UTC (rev 1280)
+++ homepage/input/infobox_de.html	2008-08-22 01:09:49 UTC (rev 1281)
@@ -6,14 +6,6 @@
          href="$$apprentice_1$$">hier</a> &uuml;ber sein erstes Abenteuer,
          seine Erfahrungen und Gedanken.
          
-         <h3>Zwei Nachtr&auml;ge</h3>
-         Wir haben nun einen Kommentar von Jacob zu seinem letzten LotM,
-         Sie k&ouml;nnen ihn <a href="$$lotm_200805$$#jacob">hier</a> lesen.
-         UND, wir haben eine gro&szlig;artige Karte vom Level des Jahres 2007,
-         <a href="$$lotm_200703$$">&quot;Island Labyrinth&quot;</a>, von Shoki
-         bekommen. Sie k&ouml;nnen sie <a
-         href="$$imagedir$$/lotm/lotm_200703_shoki.jpg">hier</a> herunterladen.
-
          <h3>Level des Monats</h3>
          <a href="$$lotm_current$$"><img src="$$lotm_current_image$$"
          alt="$$lotm_expansion$$" border="0"></a>
@@ -21,6 +13,13 @@
            <a href="$$lotm_current$$">&quot;$$lotm_current_name$$&quot;</a>
          </div>
 
+         <h3>Unabh&auml;ngiger Artikel</h3>
+         <a href="$$level_andreas11$$"><img src="images/articles/level_andreas11_a.png"
+         alt="Patterns of Impulse" border="0"></a>
+         <div class="imagetitle">
+           <a href="$$lotm_current$$">&quot;Patterns of Impulse&quot;</a>
+         </div>
+         
          <!--
          <h3>Aprilscherz '08</h3>
          <a href="$$april_2008$$"><img src="$$imagedir$$/articles/april_2008.png"

Modified: homepage/input/infobox_ru.html
===================================================================
--- homepage/input/infobox_ru.html	2008-08-21 01:05:17 UTC (rev 1280)
+++ homepage/input/infobox_ru.html	2008-08-22 01:09:49 UTC (rev 1281)
@@ -12,6 +12,13 @@
            <a href="$$lotm_current$$">&quot;$$lotm_current_name$$&quot;</a>
          </div>
 
+         <h3>Independent Article</h3>
+         <a href="$$level_andreas11$$"><img src="images/articles/level_andreas11_a.png"
+         alt="Patterns of Impulse" border="0"></a>
+         <div class="imagetitle">
+           <a href="$$lotm_current$$">&quot;Patterns of Impulse&quot;</a>
+         </div>
+         
          <!--
          <h3>?????? ?????? '08</h3>
          <a href="$$april_2008$$"><img src="$$imagedir$$/articles/april_2008.png"

Modified: homepage/input/schema.html
===================================================================
--- homepage/input/schema.html	2008-08-21 01:05:17 UTC (rev 1280)
+++ homepage/input/schema.html	2008-08-22 01:09:49 UTC (rev 1281)
@@ -1,5 +1,5 @@
 <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
-   "http://www.w3.org/TR/REC-html40/loose.dtd">
+   "http://www.w3.org/TR/html4/loose.dtd">
 <html lang="en">
 
 <head>



From ged at mail.berlios.de  Sat Aug 23 11:58:14 2008
From: ged at mail.berlios.de (ged at mail.berlios.de)
Date: Sat, 23 Aug 2008 11:58:14 +0200
Subject: [Enigma-game-svn] r1282 - in homepage/input: . articles
Message-ID: <200808230958.m7N9wE8h025319@sheep.berlios.de>

Author: ged
Date: 2008-08-23 11:58:04 +0200 (Sat, 23 Aug 2008)
New Revision: 1282

Added:
   homepage/input/articles/apprentice_1_ru.html
   homepage/input/articles/level_andreas11_ru.html
Modified:
   homepage/input/articles/infobox_apprentice_ru.html
   homepage/input/hp_archive_ru.html
   homepage/input/infobox_ru.html
   homepage/input/output-files.lua
Log:
Homepage:
- Added Russian translation of new pages and additions (level_andreas11.html translated by Ludmian Sedai.)

Added: homepage/input/articles/apprentice_1_ru.html
===================================================================
--- homepage/input/articles/apprentice_1_ru.html	2008-08-22 01:09:49 UTC (rev 1281)
+++ homepage/input/articles/apprentice_1_ru.html	2008-08-23 09:58:04 UTC (rev 1282)
@@ -0,0 +1,27 @@
+
+<h2>????? ?????????? &mdash; &quot;????? ??????????&quot;</h2>
+
+<p>
+?????? ?????????? ???? ?? Enigma, ?? ??? ??? &quot;??????&quot;,
+??? &quot;????? ?? ? ??? ??????&quot;, ?? ??? ??? ?????????????? ??????&hellip;
+? ?????? ??: ?????????, ??? ???? ??? ?????? ????????? ??????? ? ?????? ?? ???!
+??????? ?????????? ??????? ?? ?????? ?????? &quot;???????&quot; ?????????
+?????? ???????, ????????? ??????? &quot;Welcome&quot; (&quot;????? ??????????&quot;)
+&mdash; ? ????????? &quot;????&quot; ?????? ??????, ??? ??? ??????? ????????? ?
+?????????????? ??? ???????. ??? ???? ?? &mdash; ??????? ???????. ??? ??????? ?? &mdash;
+? ????????? ???? ?????? ??????? &mdash; ??? ??????? &quot;Welcome&quot;&hellip; ??????
+?????????? ??????????? ??????????! ???????? ?????? ??? ??? ???????????? ????????????? ??
+&quot;??????? ??? ?????????&quot;: ????????? &quot;?????&quot; &quot;????????????&quot;.
+????? ?????????? ???????, ??????? ??? ??? ????????, ??? ?????? ??????? &quot;Welcome&quot;,
+??? ? ??????? ?? ??????? ????????? ???????? ??????????, ??????????, ?????&hellip;
+?, ???????, ?????? ??????? ? &quot;???????&quot; ??????????, ??? &quot;??????&quot;
+????? ????????? ??????????? ? ?????, ???????, ???????, ??? ??????? ? ????????: ?????
+1000 ???????! ? ????? ?? ?????: ?? &mdash; ? &quot;????&quot;, ??? ????? x% ???????, ??
+??? ?????? ????????? ??????? &mdash; ? ???????! ? ?????????? ???? ???, ??? ????????
+??? ? ?????. ?, ????? ????, ??????? ?? ????????????? ? ???, ??? &quot;????????? ??? ? ?????&quot;
+&mdash; ??????? ??????!
+</p>
+
+<p><i>
+Mecke
+</p></i>

Modified: homepage/input/articles/infobox_apprentice_ru.html
===================================================================
--- homepage/input/articles/infobox_apprentice_ru.html	2008-08-22 01:09:49 UTC (rev 1281)
+++ homepage/input/articles/infobox_apprentice_ru.html	2008-08-23 09:58:04 UTC (rev 1282)
@@ -1,6 +1,6 @@
     <div class="infobody">
        <div class="info">
-         <h3>The Apprentice</h3>
-         <a href="$$apprentice_1$$">Part 1: <br>&quot;You are welcome&quot;</a>
+         <h3>????? ??????????</h3>
+         <a href="$$apprentice_1$$">????? 1: <br>&quot;????? ??????????&quot;</a>
        </div>
     </div>

Added: homepage/input/articles/level_andreas11_ru.html
===================================================================
--- homepage/input/articles/level_andreas11_ru.html	2008-08-22 01:09:49 UTC (rev 1281)
+++ homepage/input/articles/level_andreas11_ru.html	2008-08-23 09:58:04 UTC (rev 1282)
@@ -0,0 +1,245 @@
+<div class="lotm">
+
+? ????? ?????? ??????, ??????????? ??????, ??? ?? ???????? ??????? ??????,
+?? ?????? ?? ?????????? ?? ?????? &quot;Patterns of Impulse&quot; (IV/44),
+?????????, ??? ???????, ?? ?????? ????? ??????. ?? ?????????? ???
+??????????? ?? Alain ? ?? ?????? ??????. ????????? ??????!
+
+<h2 class="lotm">??? ??????? ???????</h2>
+
+<div class="quote">
+??????? ??? ??????? ?? ????? ??????? &quot;Patterns of Impulse&quot;.
+?????? ??? ?? ????? ???????? ???????? ?????? (???????? ??????? ??? ????),
+?? ??????????? ??? ??????, ? ??? ??????? ???????. ????????? ?????????,
+??? ? ???? ? ????.
+</div>
+
+<div class="quote">
+??????????? ??? ??????????????, ??????? ???????? ???????? ???????????????
+?????????? ????? (???????? ????? &quot;Stay There!&quot; ??? &quot;Bendixxon&quot;,
+? ????????? ?????? ??? ?????????? ??????), ? ????? ?????? ??????????? ?????? ?? ??????:
+<span style="blue">?? ???????? ????? ????????? ???????????? ???????????-????????????
+?????? ?????????!</span>!
+</div>
+
+<div class="quote">
+????-????? ??, ??????????? ????, ??? ?????????? ????? - ??? ???????,
+??????????? ? ???????? (????? ?????????? ??????? ? ????? ?????? ????????
+- ?????? ?????????? ??????? - ????? ??????? ??????? ??????), ??????? ?
+?????? ?????? ???????? ???????? ??????? ????: ?????? ?? ?????????, ???
+??? ?????????????? ??????????? ????? ??????????? ????. ????? ????????
+?????, ??????? ?????? ???????? ?????? ?? ??????, ? ??? ?????????? ?????!
+??? ????? ??????????????????? ????????? ???????: ??????? ???? ????? ????
+(???????????? ???????? ???????????? ????????? ??? ????, ???, ??????,
+????????), ? ???? ????? ??????? ????? ? ???? ????????, ???????????
+???????? ????????? ?? ???? ???? ???????, ??? ??? ??? ????? ?????????? ?
+????? ?? ???????. ???????, ?????? ?????-?? ????? (? ?? ??? ?????? ??????)
+???????? ???????? ? ????? ?????????,  ???????? ??????????????? ?????????
+(????????? ?? ???? ???????? ????) ? (? ??????) ?????????? ???? ?
+??????-??????? &hellip;
+</div>
+
+<div class="quote">
+?????? ???? ? Enigma ??????? ?? ?????? ????????? ???????????, ? ?????
+??????????? ??????, ??? ? ???? ??????? ??????? ???????????? ????????????
+? ?? ????????? ??????, ??? ?? ????? ???? ??????????. ?? ? ???? ??????,
+???? ???????? ????????, ?? ????? ????????? ????????? ?????????? ???????:
+</div>
+
+<div class="quote">
+????? ???????????? ??? ?????????? ????? (????????, ???? ???????? ???????,
+? ?????? - ??????), ??? ????????? ???? ? ?????, ??? ? ???????? ???????,
+?? ??? ????????? ??????? ????: ????? ????? ?????? ?? ?????? ????????????
+????, ?????? ??? ??????, ??? ??? ????? ????????? ???????????. ?? ????
+???????? ?????? ???? ?? ??????, ??? ???????? ???? ??????? ??????, ?? ??????
+????, ????? ????????????, ??? ???? ????????????. <br>
+????? ????????? ???????????! ?? ????? ??????? ??? &quot;?????-???-?????????-???????&quot;
+??????. ??? &quot;????&quot;, ????? ?????????? ?????? ???????????? ?
+??????????? ?????? ?????? ?? ???? ??????: ????? ????? ??? ??? ????? ????????
+?????????, ? ?????? ?????? ???????????? ?????, ??? ??? ??????? ????????????.
+</div>
+
+<div class="lotmpic">
+<img src="$$imagedir$$/articles/level_andreas11_a.png"
+alt="???????? ?????????? ???????? ? ??????? ????????" border="0">
+</div>
+
+<div class="quote">
+????? ????? ????????? ?????????, ???, ??? ???????, ???????? ?????????? ????
+(???-?? ????? ????????????? ?? ??????).
+</div>
+
+<div class="quote">
+? ????????? ???????? ??? ????????? ?????????? ?????????, ?????? ??? ??? ????????
+?????? ???????? ? ?????????? ?????????, ???? ?? ???? ????????? ??????. ? ????
+????????? ?????????? ????? ????? ????????? ????????? ????? ???? ?????????
+????????. ?? ???? ? ????? ??????????, ? ????? ??????, ????????? ?????????,
+??????? ???????? ?????????? ??? ????; ??? ??? ?????????? ??????? ??????.
+</div>
+
+<div class="lotmpic">
+<img src="$$imagedir$$/articles/level_andreas11_b.png"
+alt="???????? ? ???????? ??????" border="0">
+</div>
+
+<div class="quote">
+(???? ??????? ? ?????? ???? ???????????: ?????????? ????????? ???? ?????? ???
+????, ????? ?? ?????? ???? ?? ?????? ???????????? ????, ? ??? ?? ??????? ?
+&hellip; ?-?-?-?!)
+</div>
+
+<div class="quote">
+? ???? ?????? ????? ? ?????? ???????? ??????????? ?????? ???????? ???????, ???
+??? ?????????? ????????, ?? ?????????? ????? ???? ????? ??????????? ????? ?? 2
+????????? ????????. ???????? 70% ?? ?????????? ? ?????? ??????. ??????-??
+?????????? ? ????? ?????????? ?????????? ?????????, ??? ??? ????????????
+????????? ??????????? ???????, ?? ????? ?????????? ??, ????? ??????? ????????,
+??????? ?????? ?? ?? ?????. ? ???? ?????????, ??????? ??? ????? ??????? ???????
+&quot;?????????? ?????????? ??????&quot;, ?????????? ????? ????????? ?????
+?????? ?????????? ???????, 70% ?? ??????? ?????? ? ???????? ??????? ???????.
+</div>
+
+<div class="quote">
+?? ???? ?????????? ????? ??????? ??? ??? ???: ??????????? ???? ??? ??????????
+??????, ????????????? ?? ????????? ?????? (???? ?? ??????? ???? ??????) ?????????.
+?????? ??????? ???????? ??????? ? ???????? ?????????: 1, 3, 5 ? ?. ?. ????? ? ?????
+0 ?????????? ?????, ??????? ?????????? ?????? ? ??????? 1 ?? ??????? 2. ????
+?????????? ?????? ???????? ? ???????? ?????????, ??????? ????????? ?? ??????? 3.
+??? ????????? ?? ??????? 4, ? ?????? ?????? ?????????? ??????? ?? ??????? 1. ?????
+?????? ? ??????????? 4 ??????? ????????? ?????? ? ??????? 5 ?? ??????? 6, ? ??? ?
+???? ??????? ?????????? ??? ????? ?? ??????? 3, ? ?. ?. ????? ?? ?????????
+??????????????? ????? ????????, ??????? ? ?? ?????? ???????. ? ????? ????????
+?????? ???? ??????? (????????, ?????????????? ? ????????) ? ????????? ???????????.
+????? ???? ?????????, ??? ? ??? ???????? ???????? ?????????, ? ?????? ? ????????
+????, ????????? ????. ????? ????? ??? ????? ???????? ?????????, ??????? ????????????
+??????????????? ?????????, ??? ????????????? ? ?????????? ?????????, ??????? ?????
+???????????????? ? ??????? ???? &hellip;
+</div>
+
+<div class="quote">
+? ??? ??? ??????????, ???? ?? ?????, ????? ????? ???????????!
+</div>
+
+<div class="quote">
+???????? ??????????? ? ???????? ?????????????? ?? ??????? &quot;How solid?&quot;,
+&quot;The Flagstone Reaper&quot; ? &quot;The Dark Outside&quot;, ? ???????
+??????????, ??? ? Andreas'? ???? ??????? ??? ???????? ? ????? ???????? ????????
+(?????????? ???????, ?????????? ???????????), ???????? ????? ?? ?? ???????????????
+?????????, ?????? ????? ?????? ???? ????? &hellip;
+</div>
+
+<div class="quote">
+?-?-?-?-?!
+</div>
+
+<div class="author">Alain</div>
+
+<div class="quote">
+?????? ?????? &quot;Patterns of Impulse&quot;, ??????? ??? ??? ???????? ? ????
+?? ??????? ?????, ?????????? 30 ??? 2005 ????. ???????? ???? ???????????
+?????????, ????? ?????? ??? ???????? ????? 21. ????? ???????, ??? ?????????? ???????
+???????, ?? ??? ???? ?? ??????? &hellip;
+</div>
+
+<div class="quote">
+???????? ? ????????? ?????? Oxyd 1. ??? ??? ????????? ????, ?, ??? ???????, ??
+? ??????? ??????? ??????????????? ???????????? ????? ?????????, ??????, ???
+???????? ? ???????? ???? ? ??????? ???????????????. ?? ????? ????, ??? ? ??????
+????? ??????? ? ?? ????? ??????, ? ??? ?? ? ??? ??????? ? ?????? ??? ???? ???????,
+? ?????? ????? ?? Oxyd, ????????? ? ????? ?? ???? ? ?????? ????? ???? ?????.
+</div>
+
+<div class="quote">
+??? ????, ? ????? ? ?????? ????. ? ? ???????? ??????? ? Windows ?? Linux, ?????
+????? ?????. ? ?????, ? ???? ?????????? ???? ???? ? 2004 ??? ? 2005, ? ????????
+????? Enigma 0.81 ? ???????????? SuSE. ??? ????? ?? ????????? ??? ????????, ? ?
+????? ? ??? ??????. ?? ??? ????? ????? ?????????, ???????????? ?? ?????? ??? ???.
+?????? ??????? ?? ?????? ??????? ? ???????? ???????. ?? ?? Enigma. ? ?????? ?????
+? ????????? ?????? 0.92, ? ??? ??? ? ?? ???? ??????? ??, ? ????? ? ??? ??? Windows.
+?? ??? ???????? ????????, ? ? ???????? ?? ????? ???????. ??????????? ? ??? ????
+????????, ? BlackBallEditor ????? ??? ??????? ????????? ??????? ??????? ???????.
+</div>
+
+<div class="quote">
+?????? ?? ???, ??? ????? 1, ? ??????? ??? ?? ????? ??? ?????????????. ????? 2
+??? ??? ????????????. ??? ?????????????? ???????? ??????, ??? ? ?????
+&quot;Nightmare&quot;, ?? ??? ???????????? ??????. ??? ??? ???? ?? ??? ???????,
+??????? ???? ???? ??????. ????? ??? ? ?????? ?????? ????? ???????????? ? ??????
+?????? ???????. ??????-??, ??? ?????? ??????? ??? ????? ?? ???, ??????? ?????
+???? ???????? ??? &quot;Lissajous&quot;, ?? ??? ??? ????? ?????? ???????????????
+???????????? ??????. ??? ??? ? ???? ???? ??? ???????????? ????? ??? ?????????
+????????? ??????, ? ?????? ?????????? ????? ???? ?? ?????? Nat'?
+&quot;When Gravity Fails&quot; ? ?????? ???? ?????? ???????, ??????? ?????
+??????? ???????? &quot;Lissajous' Revenge&quot;(&quot;????? ???????&quot;)
+(??, ??????? ???? &quot;?????&quot;, ? ?????? ???????? ?????). ?? ??? ???????????
+&quot;Spaceleast&quot; (6) ? &quot;Spaceless&quot; (7), &quot;Laser Castle&quot; (8),
+&quot;Friend or Foe?&quot; (9), &quot;Laser Path&quot; (11), &quot;Robin's Wood&quot; (13),
+&quot;Tropical Island&quot; (14: ??, ? ?????? &quot;Robin's Wood&quot; ?
+&quot;Tropical Island&quot; ????? ???? ????), &quot;Turn Around&quot; (15),
+&quot;Lissajous&quot; (17, ???????), &quot;Moure-Switches&quot; (19, ??? ????????
+??????? ???????, ? ??????? ??????????? ???? ?? ???????? ?? ????), ? ????????? ????,
+??????? ??????? ?? ???? ??????????? ? ???? ??????????? ???????. ? ?????-?? ??????
+? ????? ???????? 16 ???????, ??????? ????? ???? ?? ???????? ? ???? (16 &mdash;
+??? ??????? ????? ???????? ?????). ??? ??? ?????? ???, ????? ? ??????????? ???-??,
+??? ??? ???????. ?????? ????????????? ???? ??????, ?? ??????? 11 ???????.
+</div>
+
+<div class="quote">
+????? ??? &quot;Patterns of Impulse&quot;, ????? 21. ? ?? ????, ??? ??? ??????
+??? ????. ? ?? ?????????? ?????? ???? ???????; ??-?????, ? ?????? ???????????,
+?????????? ????????? ?????????? ????? ? ????????? ???????, ?? ?? ??????? ?
+?????????, ????? ??????????, ??? ??? ????? ?????????????????. ? ????? ???????????
+????????? (? ?????????????? ?????? ?????), ??? ??? ????? ???????? ????? ???
+&quot;Laser Castle&quot; ? ????? ?????? ??? &quot;Orbitting&quot; ?
+&quot;Chess, Bugs &amp; Rock'n'Roll&quot;. ? ????? ???? ???????????? ????????
+????????? ??????? ?? ?????? ????, ??????? ????? ???????????, ??? ?? ??????
+????? ? ????, ?????????? ??? ?????. ?? ????? ????????? ????????????? ?????????,
+? ?????? ??? ??????????? ? ??????????? ???????. ??? ???? ????????????.
+</div>
+
+<div class="quote">
+??????, ? ???????? ?????? ?????? &quot;Pattern of Impulse&quot; ? ???????????
+??, ????? ??? ???? ?????????? ? ??????? Enigma 1.01. ?? ?????? ??????? ??
+<a href="http://download.berlios.de/enigma-game/andreas11_a.xml">?????</a>.
+</div>
+
+<div class="quote">
+??? ??? ???? ?????-??????, ? ???????? ????????? ?? ????? ??????. ??????? ???
+??? ???? ?????? ??? ????, ????? ????????? BlackBallEd, ??????? ?? ????????
+??? ????????? ??????? ??? ???????. ?? ????? ? ????????? ????????? ?? ???????
+?????? ????????????????? ????. ? ?? ????. ?????????? ?? ????????????
+??????????? ???????, ? ?????, ??? ??????? ?????-?????? ? ???????? ??????
+????? ???? ?????????? ????????. ???? ? ???????, ??? ??????? ??? ??? ?????
+?? ????????????. ??? ??????????? ???? ??????? ????????. ? ????? ?????????
+?????? ?????????????? ????, ??????????? ???. ?????????? ?????? ????? ??????
+?? ?????, ?????? ??????????? ?????? ?????????? ????, ?? ????? ?????????? ???
+???????? ?????? ???????.
+</div>
+
+<div class="quote">
+??? ??? ? ????? ?????? ?????????? ????? (??????? ? ??????????? ??? ????????
+????????????? ???????) ? ???????? ?????, ??????????? ??????, ??????? ?????
+???????? ? ????? ?? ????????? ??????? ?????? ? ?????. ? ??? ??????????? ????
+????? ? &quot;Laser Castle&quot;, ? ????????? ??? ????? ? ?????????, ?????
+???? ?????????, ??? ??????? ????????? ?????, ?????? ??? ????? ????? ???????
+???? ? ???????. ??? ?????? ?????????. ? ???? ??????????? ????????. ???
+???????? ???????? ???????? ?????? ?? ?????, ??????? ????? ???????? ??
+??????????? ? ???????? ??????. ????? ? ??? ??? ???????? ?? ????? ?? ?????
+??????? Star Trek ??? ????????? &quot;????? ????&quot; (&quot;Patterns of Force&quot;),
+??????? ? ??????? ?? ????? ? ??????? ????????? ????? ?? ?????? ????? ?? ???
+??????? ????? ???????; ?? ? ????? ???????????? ????????. ? ?????? ?????? ?
+???????? ?????????????? ???????? &quot;Patterns of Impulse&quot;, ???????,
+?? ????? ??????, ????????? ????????? ???????.
+</div>
+
+<div class="quote">
+? ??????? ?????? ??????? ? 15 ???? 2005 ???? ? ???????? &quot;Patterns of
+Impulse&quot; ? ??? 15 ??????? ? ???????? ? ???????? ????????, ??? ??????
+??? ???????, ? Enigma ??? ???? ????????? ? ?????? ? ???? ???????? ???????
+??????. ???? ?? ?? ??? ???????????????? ?????????? ?????????
+&hellip;
+</div>
+
+<div class="author">Andreas Lochmann</div>
+
+</div>

Modified: homepage/input/hp_archive_ru.html
===================================================================
--- homepage/input/hp_archive_ru.html	2008-08-22 01:09:49 UTC (rev 1281)
+++ homepage/input/hp_archive_ru.html	2008-08-23 09:58:04 UTC (rev 1282)
@@ -2,12 +2,12 @@
 <h2>????? ???????? ????????</h2>
 
 <p>
-<a href="$$lotm$$">?????</a> ?? ?????? ????? ????????? ???? ?????? ?? ??????? ??????.
+<a href="$$lotm$$">?????</a> ?? ?????? ????? ??? ?????? ?? ??????? ??????.
 </p>
 
 <p>
-Articles sorted by level number can be found <a
-href="$$level_archive$$">here</a>.
+??????????????? ?? ?????? ?????? ?????? ????? ?????
+<a href="$$level_archive$$">?????</a>.
 </p>
 
 <p>
@@ -23,6 +23,6 @@
   </li>
   <li><a href="$$april_2008$$">??????????????? ????? 2008 - &quot;The Three Clouds&quot;</a>
   </li>
-  <li><a href="$$apprentice_1$$">The Apprentice, Part 1</a>
+  <li><a href="$$apprentice_1$$">????? ??????????, ????? 1</a>
   </li>
 </ul>

Modified: homepage/input/infobox_ru.html
===================================================================
--- homepage/input/infobox_ru.html	2008-08-22 01:09:49 UTC (rev 1281)
+++ homepage/input/infobox_ru.html	2008-08-23 09:58:04 UTC (rev 1282)
@@ -1,9 +1,9 @@
     <div class="infobody">
        <div class="info">
-         <h3>The Apprentice</h3>
-         Mecke started a new monthly column for our homepage, &quot;The
-         Apprentice&quot;! Read about his first adventure, his
-         experiences and thoughts <a href="$$apprentice_1$$">here</a>.
+         <h3>????? ??????????</h3>
+         Mecke ??????? ?????? ??? ????? ??????????? ??????? ??? ????? ???????? ???????? &mdash;
+	 &quot;????? ??????????&quot;! ? ?????? ??? ???????????, ??? ????? ? ???????????? ???????
+	 <a href="$$apprentice_1$$">?????</a>.
 
          <h3>??????? ??????</h3>
          <a href="$$lotm_current$$"><img src="$$lotm_current_image$$"
@@ -12,7 +12,7 @@
            <a href="$$lotm_current$$">&quot;$$lotm_current_name$$&quot;</a>
          </div>
 
-         <h3>Independent Article</h3>
+         <h3>????????? ??????</h3>
          <a href="$$level_andreas11$$"><img src="images/articles/level_andreas11_a.png"
          alt="Patterns of Impulse" border="0"></a>
          <div class="imagetitle">

Modified: homepage/input/output-files.lua
===================================================================
--- homepage/input/output-files.lua	2008-08-22 01:09:49 UTC (rev 1281)
+++ homepage/input/output-files.lua	2008-08-23 09:58:04 UTC (rev 1282)
@@ -475,7 +475,7 @@
     outfile = "level_archive.html",
     title = "Level Archive",
     title_de = "Level-Archiv",
-    title_ru = "Level Archive",
+    title_ru = "????? ?????? ?? ???????",
     --es-- title_es = "Level Archive",
     body = {"level_archive"}
 }
@@ -528,7 +528,7 @@
     outfile = "apprentice_1.html",
     title = "The Apprentice, Part 1",
     title_de = "Der Neuling, Teil 1",
-    title_ru = "The Apprentice, Part 1",
+    title_ru = "????? ??????????, ????? 1",
     rightcolumn = {"articles/infobox_apprentice"},
     body = {"articles/apprentice_1"},
 }    



From andreasl at mail.berlios.de  Sat Aug 23 14:20:39 2008
From: andreasl at mail.berlios.de (andreasl at mail.berlios.de)
Date: Sat, 23 Aug 2008 14:20:39 +0200
Subject: [Enigma-game-svn] r1283 - in homepage/input: . articles
Message-ID: <200808231220.m7NCKdKx025582@sheep.berlios.de>

Author: andreasl
Date: 2008-08-23 14:20:31 +0200 (Sat, 23 Aug 2008)
New Revision: 1283

Modified:
   homepage/input/articles/apprentice_1_ru.html
   homepage/input/infobox.html
   homepage/input/infobox_de.html
   homepage/input/infobox_ru.html
Log:
Homepage:
 - Correct link from infobox to level_andreas11
 - Validation
Todo:
 - Upload of homepage
 - Upload of andreas11_a.xml


Modified: homepage/input/articles/apprentice_1_ru.html
===================================================================
--- homepage/input/articles/apprentice_1_ru.html	2008-08-23 09:58:04 UTC (rev 1282)
+++ homepage/input/articles/apprentice_1_ru.html	2008-08-23 12:20:31 UTC (rev 1283)
@@ -24,4 +24,4 @@
 
 <p><i>
 Mecke
-</p></i>
+</i></p>

Modified: homepage/input/infobox.html
===================================================================
--- homepage/input/infobox.html	2008-08-23 09:58:04 UTC (rev 1282)
+++ homepage/input/infobox.html	2008-08-23 12:20:31 UTC (rev 1283)
@@ -16,7 +16,7 @@
          <a href="$$level_andreas11$$"><img src="images/articles/level_andreas11_a.png"
          alt="Patterns of Impulse" border="0"></a>
          <div class="imagetitle">
-           <a href="$$lotm_current$$">&quot;Patterns of Impulse&quot;</a>
+           <a href="$$level_andreas11$$">&quot;Patterns of Impulse&quot;</a>
          </div>
          
          <!--

Modified: homepage/input/infobox_de.html
===================================================================
--- homepage/input/infobox_de.html	2008-08-23 09:58:04 UTC (rev 1282)
+++ homepage/input/infobox_de.html	2008-08-23 12:20:31 UTC (rev 1283)
@@ -17,7 +17,7 @@
          <a href="$$level_andreas11$$"><img src="images/articles/level_andreas11_a.png"
          alt="Patterns of Impulse" border="0"></a>
          <div class="imagetitle">
-           <a href="$$lotm_current$$">&quot;Patterns of Impulse&quot;</a>
+           <a href="$$level_andreas11$$">&quot;Patterns of Impulse&quot;</a>
          </div>
          
          <!--

Modified: homepage/input/infobox_ru.html
===================================================================
--- homepage/input/infobox_ru.html	2008-08-23 09:58:04 UTC (rev 1282)
+++ homepage/input/infobox_ru.html	2008-08-23 12:20:31 UTC (rev 1283)
@@ -16,7 +16,7 @@
          <a href="$$level_andreas11$$"><img src="images/articles/level_andreas11_a.png"
          alt="Patterns of Impulse" border="0"></a>
          <div class="imagetitle">
-           <a href="$$lotm_current$$">&quot;Patterns of Impulse&quot;</a>
+           <a href="$$level_andreas11$$">&quot;Patterns of Impulse&quot;</a>
          </div>
          
          <!--



From andreasl at mail.berlios.de  Sat Aug 23 18:58:56 2008
From: andreasl at mail.berlios.de (andreasl at mail.berlios.de)
Date: Sat, 23 Aug 2008 18:58:56 +0200
Subject: [Enigma-game-svn] r1284 - in trunk/data/levels: enigma_iii
	enigma_tutorial enigma_vi enigma_vii enigma_viii lib
Message-ID: <200808231658.m7NGwuQh022814@sheep.berlios.de>

Author: andreasl
Date: 2008-08-23 18:58:35 +0200 (Sat, 23 Aug 2008)
New Revision: 1284

Added:
   trunk/data/levels/enigma_viii/andreas48_2.xml
   trunk/data/levels/lib/liblua.xml
   trunk/data/levels/lib/libmath.xml
Removed:
   trunk/data/levels/enigma_viii/andreas48_1.xml
   trunk/data/levels/lib/libluatools.xml
Modified:
   trunk/data/levels/enigma_iii/andreas04_1.xml
   trunk/data/levels/enigma_iii/index.xml
   trunk/data/levels/enigma_tutorial/a_tut07.xml
   trunk/data/levels/enigma_tutorial/index.xml
   trunk/data/levels/enigma_vi/andreas31_1.xml
   trunk/data/levels/enigma_vi/index.xml
   trunk/data/levels/enigma_vii/andreas46_3.xml
   trunk/data/levels/enigma_vii/index.xml
   trunk/data/levels/enigma_viii/andreas47_1.xml
   trunk/data/levels/enigma_viii/andreas49_1.xml
   trunk/data/levels/enigma_viii/index.xml
   trunk/data/levels/lib/libmap.xml
   trunk/data/levels/lib/libsoko-endphase.xml
   trunk/data/levels/lib/libsoko.xml
Log:
Trunk:
 - Split libluatools into libmath and liblua.
 - Adapt levels to new libraries.
 - New version of "Fashions Pass" (release 2)
Note:
 - libsoko will still not work, due to an API-conflict


Modified: trunk/data/levels/enigma_iii/andreas04_1.xml
===================================================================
--- trunk/data/levels/enigma_iii/andreas04_1.xml	2008-08-23 12:20:31 UTC (rev 1283)
+++ trunk/data/levels/enigma_iii/andreas04_1.xml	2008-08-23 16:58:35 UTC (rev 1284)
@@ -3,12 +3,12 @@
   <el:protected>
     <el:info el:type="level">
       <el:identity el:title="Laser Castle" el:subtitle="" el:id="andreas04"/>
-      <el:version el:score="1" el:release="1" el:revision="3" el:status="released"/>
+      <el:version el:score="1" el:release="1" el:revision="4" el:status="released"/>
       <el:author  el:name="Andreas Lochmann" el:email="" el:homepage=""/>
       <el:copyright>Copyright ? 2006 Andreas Lochmann</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
       <el:compatibility el:enigma="1.10">
-        <el:dependency el:path="lib/libluatools" el:id="lib/libluatools" el:release="1" el:preload="true"/>
+        <el:dependency el:path="lib/libmap" el:id="lib/libmap" el:release="1" el:preload="true"/>
       </el:compatibility>
       <el:modes el:easy="true" el:single="true" el:network="false"/>
       <el:comments>
@@ -20,8 +20,6 @@
     <el:luamain><![CDATA[
 -- Originally created with the help of BBE 1.05
 
-isPreview = wo["CreatingPreview"]
-
 ti["    "]={"fl-water"}
 ti["!   "]={"fl-water"}
 ti["#   "]={"fl-leaves"}
@@ -72,7 +70,7 @@
 ti[" -  "]={"st_laser", "la_n", orientation = NORTH, state = OFF}
 ti[" .  "]={"st_laser", "la_s", orientation = SOUTH, state = OFF}
 ti[" 0  "]={"st_laser", "la_e", orientation = EAST, state = OFF}
-ti[" 5  "]={"st-door-v", "castle_door"}
+ti[" 5  "]={"st_door", "castle_door", faces="ew"}
 ti[" 6  "]={"st-stoneimpulse-hollow"}
 ti["  1 "]={"it_trigger", target = {"fo_a", "fo_c"}}
 ti["  2 "]={"it_trigger", target = {"fo_a"}}
@@ -85,7 +83,11 @@
 ti["  ' "]={"it-seed"}
 ti["  ( "]={"it-extralife"}
 ti["  & "]={"it-document", text = "text1"}
-ti["   !"]=luatools.cond(isPreview, {}, {"#ac-blackball", mouseforce = 1})
+if wo["CreatingPreview"] then
+  ti["   !"] = {}
+else
+  ti["   !"] = {"#ac-blackball", mouseforce = 1}
+end
 ti["   #"]={"ac-top", range = 10, force = 10, gohome = false}
 
 level={"!!!!!!!!!!!!!!!!!!!!",
@@ -297,7 +299,8 @@
         "             %%)'%  ",
         "              %%%%  "}
 
-map = luatools.fuse_map_layers(level, stmap, itmap, acmap)
+map =   wo:newMap(" ", level) * wo:newMap(" ", stmap)
+      * wo:newMap(" ", itmap) * wo:newMap(" ", acmap)
 w, h = wo(res.composer(ti), "    ", map)
 
 if not wo["IsDifficult"] then
@@ -306,7 +309,7 @@
 
 wo["SlopeForce"] = 30
 
-if isPreview then
+if wo["CreatingPreview"] then
   wo[{4, 11.3}] = {"ac-blackball"}
   wo["FollowGrid"] = false
   wo["FollowMethod"] = FOLLOW_SCROLL

Modified: trunk/data/levels/enigma_iii/index.xml
===================================================================
--- trunk/data/levels/enigma_iii/index.xml	2008-08-23 12:20:31 UTC (rev 1283)
+++ trunk/data/levels/enigma_iii/index.xml	2008-08-23 16:58:35 UTC (rev 1284)
@@ -69,7 +69,7 @@
     <level _seq="61" _title="Fool the Warden" _xpath="./duffy37_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy37" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="62" _title="Don't Touch" _xpath="./raoul07_2" author="Raoul Bourquin" ctrl="force" easy="true" id="raoul07" rel="2" rev="1" score="2" target="time" unit="duration"/>
     <level _seq="63" _title="Emergency Exit" _xpath="./ss05_1" author="Sven Siggelkow" ctrl="force" easy="false" id="ss5" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="64" _title="Laser Castle" _xpath="./andreas04_1" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas04" rel="1" rev="3" score="1" target="time" unit="duration"/>
+    <level _seq="64" _title="Laser Castle" _xpath="./andreas04_1" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas04" rel="1" rev="4" score="1" target="time" unit="duration"/>
     <level _seq="65" _title="The Safe" _xpath="./siegfried77_1" author="Siegfried Fennig" ctrl="force" easy="false" id="siegfried77" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="66" _title="Block its way!" _xpath="./wb05_2" author="Jon 'WB' Sneyers" ctrl="force" easy="true" id="wb5" rel="2" rev="1" score="2" target="time" unit="duration"/>
     <level _seq="67" _title="Bump Ahead" _xpath="./illmind01_1" author="illmind" ctrl="force" easy="false" id="illmind01" rel="1" rev="0" score="1" target="time" unit="duration"/>

Modified: trunk/data/levels/enigma_tutorial/a_tut07.xml
===================================================================
--- trunk/data/levels/enigma_tutorial/a_tut07.xml	2008-08-23 12:20:31 UTC (rev 1283)
+++ trunk/data/levels/enigma_tutorial/a_tut07.xml	2008-08-23 16:58:35 UTC (rev 1284)
@@ -3,12 +3,12 @@
   <el:protected>
     <el:info el:type="level">
       <el:identity el:title="Chess Stones" el:subtitle="" el:id="c_tut01"/>
-      <el:version el:score="1" el:release="1" el:revision="2" el:status="released"/>
+      <el:version el:score="1" el:release="1" el:revision="3" el:status="released"/>
       <el:author  el:name="Raoul Bourquin, ShadowPhrogg32642342, Andreas Lochmann" el:email="" el:homepage=""/>
       <el:copyright>Copyright ? 2008 Raoul Bourquin, Andreas Lochmann</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
       <el:compatibility el:enigma="1.10">
-        <el:dependency el:path="lib/libluatools" el:id="lib/libluatools" el:release="1" el:preload="true"/>
+        <el:dependency el:path="lib/libmath" el:id="lib/libmath" el:release="1" el:preload="true"/>
       </el:compatibility>
       <el:modes el:easy="false" el:single="true" el:network="false"/>
       <el:comments>
@@ -74,7 +74,7 @@
   sender:set({target = ""})
 end
 
-trigger_to_doors = luatools.permutation(8)
+trigger_to_doors = lib.math.permutation(8)
 doors = no["door#*"]
 triggers = no["trigger#*"]
 

Modified: trunk/data/levels/enigma_tutorial/index.xml
===================================================================
--- trunk/data/levels/enigma_tutorial/index.xml	2008-08-23 12:20:31 UTC (rev 1283)
+++ trunk/data/levels/enigma_tutorial/index.xml	2008-08-23 16:58:35 UTC (rev 1284)
@@ -69,7 +69,7 @@
     <level _seq="61" _title="Is It Easy?" _xpath="enigma_i/martin06_1" author="Martin Hawlisch" ctrl="force" easy="false" id="martin06" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="62" _title="Beam0r" _xpath="enigma_ii/peter01_1" author="Peter Santo" ctrl="force" easy="false" id="peter_001" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="63" _title="Slalom Skiing" _xpath="enigma_ii/martin93_1" author="Martin Hawlisch" ctrl="force" easy="true" id="martin93" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="64" _title="Chess Stones" _xpath="./a_tut07" author="Raoul Bourquin, ShadowPhrogg32642342, Andreas Lochmann" ctrl="force" easy="false" id="c_tut01" rel="1" rev="2" score="1" target="time" unit="duration"/>
+    <level _seq="64" _title="Chess Stones" _xpath="./a_tut07" author="Raoul Bourquin, ShadowPhrogg32642342, Andreas Lochmann" ctrl="force" easy="false" id="c_tut01" rel="1" rev="3" score="1" target="time" unit="duration"/>
     <level _seq="65" _title="Bye!" _xpath="./a_tut06" author="Andreas Lochmann" ctrl="force" easy="false" id="a_tut06" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="66" _title="Advanced Tutorial" _xpath="./adv_tutorial" author="Jacob Scott" ctrl="force" easy="false" id="m_tutor/adv_tutorial" rel="1" rev="0" score="1" target="time" unit="duration"/>
   </levels>

Modified: trunk/data/levels/enigma_vi/andreas31_1.xml
===================================================================
--- trunk/data/levels/enigma_vi/andreas31_1.xml	2008-08-23 12:20:31 UTC (rev 1283)
+++ trunk/data/levels/enigma_vi/andreas31_1.xml	2008-08-23 16:58:35 UTC (rev 1284)
@@ -3,12 +3,12 @@
   <el:protected>
     <el:info el:type="level">
       <el:identity el:title="Chess, Bugs &amp; Rock'n'Roll" el:subtitle="" el:id="andreas31"/>
-      <el:version el:score="1" el:release="1" el:revision="2" el:status="released"/>
+      <el:version el:score="1" el:release="1" el:revision="3" el:status="released"/>
       <el:author  el:name="Andreas Lochmann" el:email="" el:homepage=""/>
       <el:copyright>Copyright ? 2006, 2008 Andreas Lochmann</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
       <el:compatibility el:enigma="1.10">
-        <el:dependency el:path="lib/libluatools" el:id="lib/libluatools" el:release="1" el:preload="true"/>
+        <el:dependency el:path="lib/libmap" el:id="lib/libmap" el:release="1" el:preload="true"/>
       </el:compatibility>
       <el:modes el:easy="false" el:single="true" el:network="false"/>
       <el:comments>
@@ -142,7 +142,7 @@
         "!                  T                  !",
         "!!!!#!!!!!!!!!!!!!!!!!!!!!!!!!!!!!#!!!!"}
 
-map = luatools.fuse_map_layers(level, stmap, acmap)
+map = wo:newMap(" ", level) * wo:newMap(" ", stmap) * wo:newMap(" ", acmap)
 w, h = wo(res.composer(myresolver), "   ", map)
 
 wo:shuffleOxyd()

Modified: trunk/data/levels/enigma_vi/index.xml
===================================================================
--- trunk/data/levels/enigma_vi/index.xml	2008-08-23 12:20:31 UTC (rev 1283)
+++ trunk/data/levels/enigma_vi/index.xml	2008-08-23 16:58:35 UTC (rev 1284)
@@ -52,7 +52,7 @@
     <level _seq="44" _title="Dancing on Light Beams" _xpath="./andreas28_1" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas28" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="45" _title="Wormhole Madness!" _xpath="./edward24_1" author="Edward" ctrl="force" easy="false" id="edward24" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="46" _title="Alcatraz" _xpath="./ralf14_1" author="Ralf Westram" ctrl="force" easy="true" id="ralf14" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="47" _title="Chess, Bugs &amp; Rock'n'Roll" _xpath="./andreas31_1" author="Andreas Lochmann" ctrl="force" easy="false" id="andreas31" rel="1" rev="2" score="1" target="time" unit="duration"/>
+    <level _seq="47" _title="Chess, Bugs &amp; Rock'n'Roll" _xpath="./andreas31_1" author="Andreas Lochmann" ctrl="force" easy="false" id="andreas31" rel="1" rev="3" score="1" target="time" unit="duration"/>
     <level _seq="48" _title="Oiltrace" _xpath="./raoul25_1" author="Raoul Bourquin" ctrl="force" easy="false" id="raoul25" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="49" _title="Simple Space" _xpath="./ulf02_1" author="Ulf Stegemann" ctrl="force" easy="false" id="20060628ulf002" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="50" _title="Hot Meditation" _xpath="./ral08_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20060527ral010" rel="1" rev="42" score="1" target="time" unit="duration"/>

Modified: trunk/data/levels/enigma_vii/andreas46_3.xml
===================================================================
--- trunk/data/levels/enigma_vii/andreas46_3.xml	2008-08-23 12:20:31 UTC (rev 1283)
+++ trunk/data/levels/enigma_vii/andreas46_3.xml	2008-08-23 16:58:35 UTC (rev 1284)
@@ -3,12 +3,13 @@
   <el:protected>
     <el:info el:type="level">
       <el:identity el:title="Tinker, Tailor" el:subtitle="" el:id="andreas46"/>
-      <el:version el:score="2" el:release="4" el:revision="4" el:status="released"/>
+      <el:version el:score="2" el:release="4" el:revision="5" el:status="released"/>
       <el:author el:name="Andreas Lochmann" el:email="" el:homepage=""/>
       <el:copyright>Copyright ? 2007 Andreas Lochmann</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
       <el:compatibility el:enigma="1.10">
-        <el:dependency el:path="lib/libluatools" el:id="lib/libluatools" el:release="1" el:preload="true"/>
+        <el:dependency el:path="lib/libmath" el:id="lib/libmath" el:release="1" el:preload="true"/>
+        <el:dependency el:path="lib/liblua" el:id="lib/liblua" el:release="1" el:preload="true"/>
       </el:compatibility>
       <el:modes el:easy="true" el:single="true" el:network="false"/>
       <el:score el:easy="2:18" el:difficult="5:10"/>
@@ -74,7 +75,7 @@
 function connect(obj1, obj2, restrict)
   wo:add({"ot_rubberband", anchor1 = obj1, anchor2 = obj2,
           strength = strength or maxstrength,
-          max = luatools.cond(restrict and wo["IsDifficult"], 2.5, nil)})
+          max = lib.lua.cond(restrict and wo["IsDifficult"], 2.5, nil)})
   -- Save partner of actor: When call_scissors is called, the
   -- rubberband will've already been removed, so ["fellows"]
   -- doesn't work anymore for the marble.
@@ -123,7 +124,7 @@
   pattern_count = pattern_count + 1
   if pattern_count < 8 then
     -- create new permutation with one horse less
-    local p = luatools.cyclic_permutation(8 - pattern_count)
+    local p = lib.math.cyclic_permutation(8 - pattern_count)
     for j = 8 - pattern_count + 1, 8 do
       p[j] = j
     end
@@ -131,7 +132,7 @@
       Goal[fixpoint_permutation[j]] = fixpoint_permutation[p[j]]
     end
     -- create temporary goals for the horses to untangle
-    local TemporaryGoal = luatools.permutation(8)
+    local TemporaryGoal = lib.math.permutation(8)
     for j = 1, 8 do
       no["parahorse%"..j]:set(
           {destination = {no["parafloor%"..TemporaryGoal[j]]}})
@@ -162,11 +163,11 @@
   end
 end
 
-Goal = luatools.cyclic_permutation(8)
+Goal = lib.math.cyclic_permutation(8)
 connect(no["marble"], no["scissors_central"], true)
 
 if wo["IsDifficult"] then
-  fixpoint_permutation = luatools.permutation(8)
+  fixpoint_permutation = lib.math.permutation(8)
 else
   fixpoint_permutation = {}
   for j = 1, 8 do

Modified: trunk/data/levels/enigma_vii/index.xml
===================================================================
--- trunk/data/levels/enigma_vii/index.xml	2008-08-23 12:20:31 UTC (rev 1283)
+++ trunk/data/levels/enigma_vii/index.xml	2008-08-23 16:58:35 UTC (rev 1284)
@@ -61,7 +61,7 @@
     <level _seq="53" _title="Re-entry Circuit" _xpath="./pulley05_1" author="Mark Pulley" ctrl="force" easy="false" id="pulley05" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="54" _title="Not Fast Enough" _xpath="./jet04_3" author="James Taylor, Ronald Lamprecht" ctrl="force" easy="true" id="20070413jet001" rel="3" rev="3" score="3" target="time" unit="duration"/>
     <level _seq="55" _title="Give Way" _xpath="./just20_1" author="JuSt" ctrl="force" easy="false" id="just20" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="56" _title="Give more Way" _xpath="./just21_2" author="JuSt" ctrl="force" easy="true" id="just21" rel="2" rev="3" score="2" target="time" unit="duration"/>
+    <level _seq="56" _title="Give more Way" _xpath="./just21_2" author="JuSt" ctrl="force" easy="true" id="just21" rel="2" rev="2" score="2" target="time" unit="duration"/>
     <level _seq="57" _title="Give Way 4 two" _xpath="./just22_2" author="JuSt" ctrl="force" easy="true" id="just22" rel="2" rev="2" score="2" target="time" unit="duration"/>
     <level _seq="58" _title="Lost in Time and Space" _xpath="./just23_1" author="JuSt" ctrl="force" easy="false" id="just23" rel="1" rev="2" score="1" target="time" unit="duration"/>
     <level _seq="59" _title="Alternatives?" _xpath="./just24_1" author="JuSt" ctrl="force" easy="true" id="just24" rel="1" rev="1" score="1" target="time" unit="duration"/>
@@ -94,7 +94,7 @@
     <level _seq="86" _title="Lady in Red" _xpath="./just30_1" author="Just" ctrl="force" easy="true" id="just30" rel="1" rev="3" score="1" target="time" unit="duration"/>
     <level _seq="87" _title="Crawling the Abyss" _xpath="./sph02_1" author="ShadowPhrogg32642342" ctrl="force" easy="true" id="sph02" rel="1" rev="5" score="1" target="time" unit="duration"/>
     <level _seq="88" _title="Bold Boulder" _xpath="./ral14_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20061124ral279" rel="1" rev="96" score="1" target="time" unit="duration"/>
-    <level _seq="89" _title="Tinker, Tailor" _xpath="./andreas46_3" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas46" rel="4" rev="4" score="2" target="time" unit="duration"/>
+    <level _seq="89" _title="Tinker, Tailor" _xpath="./andreas46_3" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas46" rel="4" rev="5" score="2" target="time" unit="duration"/>
     <level _seq="90" _title="Elbow Society" _xpath="./andreas45_2" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas45" rel="2" rev="5" score="2" target="time" unit="duration"/>
     <level _seq="91" _title="Watchmaker" _xpath="./huesing01_1" author="Johannes H?sing" ctrl="force" easy="false" id="huesing01" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="92" _title="Map it out II" _xpath="./manuel01_1" author="Manuel Eisentraut" ctrl="force" easy="true" id="manuel01" rel="1" rev="0" score="1" target="time" unit="duration"/>

Modified: trunk/data/levels/enigma_viii/andreas47_1.xml
===================================================================
--- trunk/data/levels/enigma_viii/andreas47_1.xml	2008-08-23 12:20:31 UTC (rev 1283)
+++ trunk/data/levels/enigma_viii/andreas47_1.xml	2008-08-23 16:58:35 UTC (rev 1284)
@@ -3,12 +3,12 @@
   <el:protected>
     <el:info el:type="level">
       <el:identity el:title="The Show Jumper" el:subtitle="" el:id="andreas47"/>
-      <el:version el:score="1" el:release="1" el:revision="3" el:status="released"/>
+      <el:version el:score="1" el:release="1" el:revision="4" el:status="released"/>
       <el:author el:name="Andreas Lochmann" el:email="" el:homepage=""/>
       <el:copyright>Copyright ? 2008 Andreas Lochmann</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
       <el:compatibility el:enigma="1.10">
-        <el:dependency el:path="lib/libluatools" el:id="lib/libluatools" el:release="1" el:preload="true"/>
+        <el:dependency el:path="lib/libmath" el:id="lib/libmath" el:release="1" el:preload="true"/>
       </el:compatibility>
       <el:modes el:easy="true" el:single="true" el:network="false"/>
       <el:score el:easy="1:06" el:difficult="3:56"/>
@@ -150,7 +150,7 @@
 for y, line in pairs(floor_plus) do
   for x, ways in pairs(line) do
     if ways >= 0 then
-      local dirs = luatools.digits(ways, 2)
+      local dirs = lib.math.digits(ways, 2)
       local rx, ry = 2*x+y-4, 2*y-x+3
       add_dirs(rx, ry, dirs)
     end
@@ -160,7 +160,7 @@
 for y, line in pairs(floor_percent) do
   for x, ways in pairs(line) do
     if ways >= 0 then
-      local dirs = luatools.digits(ways, 2)
+      local dirs = lib.math.digits(ways, 2)
       local rx, ry = 2*x-y+5, 2*y+x-8
       add_dirs(rx, ry, dirs)
     end

Deleted: trunk/data/levels/enigma_viii/andreas48_1.xml
===================================================================
--- trunk/data/levels/enigma_viii/andreas48_1.xml	2008-08-23 12:20:31 UTC (rev 1283)
+++ trunk/data/levels/enigma_viii/andreas48_1.xml	2008-08-23 16:58:35 UTC (rev 1284)
@@ -1,448 +0,0 @@
-<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
-<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
-  <el:protected>
-    <el:info el:type="level">
-      <el:identity el:title="Fashions Pass" el:subtitle="But dynamite is forever" el:id="andreas48"/>
-      <el:version el:score="1" el:release="1" el:revision="2" el:status="released"/>
-      <el:author el:name="Andreas Lochmann" el:email="" el:homepage=""/>
-      <el:copyright>Copyright ? 2008 Andreas Lochmann</el:copyright>
-      <el:license el:type="GPL v2.0 or above" el:open="true"/>
-      <el:compatibility el:enigma="1.10">
-        <el:dependency el:path="lib/natmaze" el:id="lib/natmaze" el:release="1" el:preload="true"/>
-        <el:dependency el:path="lib/libluatools" el:id="lib/libluatools" el:release="1" el:preload="true"/>
-      </el:compatibility>
-      <el:modes el:easy="false" el:single="true" el:network="false"/>
-      <el:comments>
-        <el:dedication>Thanks to Nat for his maze-library!</el:dedication>
-      </el:comments>
-      <el:score el:easy="-" el:difficult="26:33"/>
-    </el:info>
-    <el:luamain><![CDATA[
-
---------------------------------------------
--- CONSTANTS
---------------------------------------------
-
-spot_constants = {SPOT_DEATH,
-                  SPOT_TRAP,
-                  SPOT_SENSOR,
-                  SPOT_ACTORIMPULSE,
-                  SPOT_HOLLOW}
-
-designs =
-  {{"fl-samba",     "fl-water", "st-bluegray",   "st-bluegray_hole",   OXYD_CYAN},
-   {"fl-rock",      "fl-abyss", "st-camouflage", "st-camouflage_hole", OXYD_GREEN},
-   {"fl-sahara",    "fl-abyss", "st-greenbrown", "st-greenbrown_hole", OXYD_YELLOW},
-   {"fl-black",     "fl-water", "st-marble",     "st-marble_hole",     OXYD_PURPLE},
-   {"fl-bluegreen", "fl-abyss", "st-metal",      "st-metal_hole",      OXYD_BLUE},
-   {"fl-brick",     "fl-water", "st-rock1",      "st-rock1_hole",      OXYD_RED},
-   {"fl-gravel",    "fl-abyss", "st-rock2",      "st-rock2_hole",      OXYD_BLACK},
-   {"fl-metal",     "fl-water", "st-rock3",      "st-rock3_hole",      OXYD_WHITE}}
-
-vortex_goals = {}
-maze_maps = {}
-mazes = {}
-
---------------------------------------------
--- MOST IMPORTANT RANDOM DECISIONS
---------------------------------------------
-
-design_permutation = luatools.permutation(#designs)
-spot_permutation = luatools.permutation(#spot_constants)
-monoflop_permutation = luatools.permutation(5)
-final_spot_1 = random(2) + 1
-final_spot_2 = random(2) + 3
-wo["ExtralifeGlasses"] = spot_constants[spot_permutation[1]]
-
---------------------------------------------
--- TILE DEFINITIONS (CENTRAL AND OXYD ROOM)
---------------------------------------------
-
-ti["  "] = {"fl-water"}
-ti[" 0"] = {"fl-stone"}
-ti["@0"] = {"#ac-blackball"} .. ti({"fl-stone", "start_position"})
-ti["L0"] = {"st_laser", orientation = EAST, state = ON} .. ti[" 0"]
-ti["P0"] = {"st_polarswitch"} .. ti[" 0"]
-ti["v0"] = {"it_vortex", autoclose = true, state = CLOSED, name = "vortex#"} .. ti[" 0"]
-ti["M0"] = {"st_monoflop", target = "monoflop_call", name = "monoflop#"} .. ti[" 0"]
-ti["e0"] = {"it_extralife"} .. ti[" 0"]
-ti["W0"] = {"st_turnstilearm_w"} .. ti[" 0"]
-ti["S0"] = {"st_turnstilearm_s"} .. ti[" 0"]
-ti["T0"] = {"st_turnstile"} .. ti[" 0"]
-ti["B0"] = {"st-stone_break"} .. ti[" 0"]
-ti["s0"] = {"it-spade"} .. ti[" 0"]
-
-for j = 1, 5 do
-  ti[j.."0"] = {"st_oxyd", oxydcolor = designs[design_permutation[j]][5]} .. ti[" 0"]
-end
-
-ti["panel1"] = ti({"st_panel", cluster = 1}) .. ti[" 0"]
-ti["panel2"] = ti({"st_panel", cluster = 2}) .. ti[" 0"]
-ti["water"] = ti({"fl-water"})
-
---------------------------------------------
--- TILE DEFINITIONS (MAZES)
---------------------------------------------
-
-for j = 1, 5 do
-  local design = designs[design_permutation[j]]
-  local spot = spot_constants[spot_permutation[j]]
-
-  ti["_"..j] = ti({design[1]})
-
-  if spot == SPOT_SENSOR then
-    ti[" "..j] = ti["_"..j] .. ti({"it_blocker", name = "sensor_door#"})
-  else
-    ti[" "..j] = ti["_"..j]
-  end
-  
-  if spot == SPOT_ACTORIMPULSE then
-    ti["#"..j] = ti["_"..j] .. ti({design[2]})
-  else
-    ti["#"..j] = ti["_"..j] .. ti({design[3]})
-  end
-  
-  if spot == SPOT_HOLLOW then
-    ti["."..j] = ti["_"..j] .. ti({design[4]})
-  else
-    ti["."..j] = ti["_"..j]
-  end
-
-  if spot == SPOT_DEATH then
-    ti["*"..j] = ti["_"..j] .. ti({"st_death", invisible = true})
-  elseif spot == SPOT_TRAP then
-    ti["*"..j] = ti["_"..j] .. ti({"it_trap"})
-  elseif spot == SPOT_SENSOR then
-    ti["*"..j] = ti["_"..j]
-      .. ti({"it_sensor", invisible = true, action = "close", target = "sensor_door#*"})
-  elseif spot == SPOT_ACTORIMPULSE then
-    ti["*"..j] = ti["_"..j] .. ti({"st_actorimpulse", invisible = true, strength = 1000})
-  elseif spot == SPOT_HOLLOW then
-    ti["*"..j] = ti["_"..j] .. ti({design[4]}) .. ti({"it-booze-broken"})
-  end
-
-  if spot == SPOT_SENSOR then
-    ti["g"..j] = ti["_"..j] .. ti({"it_sensor", target = "sensor_door#*",
-                   action = "open"})
-  else
-    ti["g"..j] = ti["_"..j]
-  end
-  
-  ti["M"..j] = {"st_monoflop", target = "vortex_"..spot,
-                 action_1 = "open", action_0 = "close"} .. ti["_"..j]
-  ti["v"..j] = {"it_vortex", autoclose = true, state = CLOSED,
-                 name = "vortex_"..spot, destination = "start_position"} .. ti["_"..j]
-  ti["O"..j] = {"st_oxyd", oxydcolor = design[5]} .. ti["_"..j]
-  ti["d"..j] = {"it-dynamite"} .. ti["_"..j]
-  ti["G"..j] = {"it_glasses", state = spot_constants[spot_permutation[(j%5) + 1]]}
-               .. ti["_"..j]
-  ti["H"..j] = {"it_glasses", state = spot_constants[spot_permutation[((j+1)%5) + 1]]}
-               .. ti["_"..j]
-  ti["E"..j] = {"it_extralife"} .. ti["_"..j]
-  ti["A"..j] = {"st_oneway", orientation = EAST} .. ti["_"..j]
-  ti["-"..j] = ti[" 0"]
-
-  if (j == 4) or (j == 5) then
-    ti["+"..j] = ti["#"..j]
-    ti["k"..j] = ti["_"..j]
-    ti["D"..j] = ti["_"..j] .. {"st_blocker", "keydoor"..j}
-  else
-    ti["+"..j] = ti["_"..j]
-    ti["K"..j] = ti["_"..j]
-    ti["D"..j] = ti["_"..j]
-  end
-end    
-
-ti["k1"] = ti["_1"] .. {"it_floppy"}
-ti["k2"] = ti["_2"] .. {"it_key", code = "good_key"}
-ti["k3"] = ti["_3"] .. {"it_key", code = "bad_key"}
-ti["K4"] = ti["_4"] .. {"st_floppy", target = "keydoor4"}
-ti["K5"] = ti["_5"] .. {"st_key", code = "good_key", target = "keydoor5"}
-
---------------------------------------------
--- RESOLVER (RANDOM ELEMENTS)
---------------------------------------------
-
-panel_randomicity = {["~"] = 15, ["%"] = 2, ["$"] = 1}
-
-function main_resolver(key, x, y)
-  local mainkey = string.sub(key, 1, 1)
-  local number = tonumber(string.sub(key, 2, 2))
-  if panel_randomicity[mainkey] then
-    if random(panel_randomicity[mainkey]) == 1 then
-      return ti["panel"..random(2)]
-    else
-      return ti["water"]
-    end
-  elseif mainkey == "*" and random(3) == 1 then
-    return ti["#"..number]
-  elseif mainkey == "." and random(3) == 1 then
-    return ti["_"..number]
-  elseif mainkey == "g" then
-    table.insert(vortex_goals, po({x + 0.5, y + 0.5}))
-    return ti["g"..number]
-  end
-  return ti[key]
-end
-
---------------------------------------------
--- MAP AND MAZE TOOLS
---------------------------------------------
-
-function replace_key_in_map(j, oldkey, newkey, pos)
-  if luatools.get_key_in_map(maze_maps[j], oldkey, pos) == oldkey then
-    maze_maps[j] = luatools.insert_key_in_map(maze_maps[j], newkey, pos)
-  end
-end
-
-function glue_maze_into_map(j, maze, height, width, offset)
-  for y = 0, height - 1 do
-    for x = 0, width - 1 do
-      local pos = 2*po({x, y}) + offset
-      local east = luatools.cond(maze:can_go_east(x,y), ".", "*")
-      local south = luatools.cond(maze:can_go_south(x,y), ".", "*")
-      replace_key_in_map(j, " ", east,  pos + {1,0})
-      replace_key_in_map(j, " ", south, pos + {0,1})
-      replace_key_in_map(j, " ", "#",   pos + {1,1})
-    end
-  end
-end
-
---------------------------------------------
--- CENTRAL ROOM
---------------------------------------------
-
-central_room = {
--- |        ++        |        ++        |        ++        |
-  "~~~~~~~%%%%%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%%%%$",
-  "~~~~~%%%%%%%%%%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%%%%%$$",
-  "~~~%%%%     %%%%%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%%%%%%%%$$",
-  "~~%%%   M v    %%%%%~~~~%%%%%%%%%%~~~~~~~~~~%%%%%%%%%$$$$",
-  "~~%%  v     M    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%$$$$$$$",
-  "~~%%               %%%%%%%      %%%%%%%%%%%%%%%%%$WT $$$$",
-  "~~%% M   @    v             LP                     S     ",
-  "~~%%               %%%%%%%      %%%%%%%%%%%%%%%%%$$$$$$$$",
-  "~~%%  v     M    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%$$$$$$$",
-  "~~%%%   M v    %%%%%~~~~%%%%%%%%%%~~~~~~~~~~%%%%%%%%%$$$$",
-  "~~~%%%%     %%%%%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%%%%%%%%$$",
-  "~~~~~%%%%%%%%%%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%%%%%$$",
-  "~~~~~~~%%%%%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%%%%$"}
-
---------------------------------------------
--- FIRST FIVE MAZES
---------------------------------------------
-
-maze_map = {
-"###O################################O##",
-"#_____                             ___#",
-"#_M___                             _d_O",
-"O__v__                             ___#",
-"#___g_                                #",
-"#_____                                #",
-"#                                     #",
-"#                                     #",
-"#                                     #",
-"#                                     #",
-"#                                     #",
-"#                                     #",
-"#                                     #",
-"#                                     #",
-"#                                     #",
-"#                                     #",
-"#                                     #",
-"#                                     #",
-"#                                     #",
-"#                                _____#",
-"#                                _++D+#",
-"#___                             _+k__O",
-"O_d_                             _K___#",
-"#___                             _+___#",
-"##O################################O###"}
-
-maze_width = 19
-maze_height = 12
-maze_offset = po({2, 2})
-
-for j = 1, 5 do
-  mazes[j] = new_kruskal_maze(maze_width, maze_height)
-end
-
-for j = 1, 5 do
-  maze_maps[j] = luatools.deep_copy(maze_map)
-  glue_maze_into_map(j, mazes[j], maze_height, maze_width, maze_offset)
-  local glasses1 = po({5 + random(9), 5 + random(3)})
-  local glasses2, extralife
-  repeat
-    glasses2 = po({5 + random(9), 5 + random(3)})
-  until glasses2 ~= glasses1
-  repeat
-    extralife = po({5 + random(9), 5 + random(3)})
-  until (extralife ~= glasses1) and (extralife ~= glasses2)
-  replace_key_in_map(j, " ", "G", 2*glasses1 + maze_offset)
-  replace_key_in_map(j, " ", "H", 2*glasses2 + maze_offset)
-  replace_key_in_map(j, " ", "E", 2*extralife + maze_offset)
-  if random(2) == 1 then
-    maze_maps[j] = luatools.mirror_map_vertically(maze_maps[j])
-  end
-  if random(2) == 1 then
-    maze_maps[j] = luatools.mirror_map_horizontally(maze_maps[j], 1)
-  end
-  local number_field = {}
-  for y = 1, #maze_map do
-    number_field[y] = string.rep(""..j, string.len(maze_map[y]))
-  end  
-  maze_maps[j] = luatools.fuse_map_layers(maze_maps[j], number_field)
-end
-
---------------------------------------------
--- FINAL MAZE
---------------------------------------------
-
-fmaze_width = 19 * 2 - 1
-fmaze_height = 12 * 2 - 1
-fmaze_offset = po({3, 3})
-
--- frame
-maze_maps[6] = {string.rep("$", fmaze_width * 2 + 3)}
-table.insert(maze_maps[6], maze_maps[6][1])
-for j = 1, fmaze_height * 2 - 1 do
-  table.insert(maze_maps[6], "$$" .. string.rep(" ", fmaze_width * 2 - 1) .. "$$")
-end
-table.insert(maze_maps[6], maze_maps[6][1])
-table.insert(maze_maps[6], maze_maps[6][1])
-
--- oneway entry and exit
-replace_key_in_map(6, "$", "-", {1, 7})
-replace_key_in_map(6, "$", "A", {2, 7})
-replace_key_in_map(6, "$", "-", {fmaze_width * 2 + 2, fmaze_height * 2 - 3})
-replace_key_in_map(6, "$", "-", {fmaze_width * 2 + 3, fmaze_height * 2 - 3})
-
--- water/panel holes
-local radius = {}
-local position = {}
-for h = 1, 5 do
-  local tries = 0
-  repeat
-    radius[h] = 5 + random(5)
-    position[h] = po({radius[h] + 2 + random(2*fmaze_width - 1 - 2*(radius[h] + 2)),
-                      radius[h] + 2 + random(2*fmaze_height - 1 - 2*(radius[h] + 2))})
-    local correct = true
-    for j = 1, h - 1 do
-      local delta = position[h] - position[j]
-      local joined_radius = radius[h] + radius[j] + 2
-      correct = correct and
-        (delta.x*delta.x + delta.y*delta.y > joined_radius * joined_radius)
-    end
-    tries = tries + 1
-  until correct or (tries > 100)
-end
-for h = 1, #radius do
-  for y = -radius[h], radius[h] do
-    for x = -radius[h], radius[h] do
-      local distsqr = x*x + y*y
-      if distsqr <= (radius[h] - 3) * (radius[h] - 3) then
-        replace_key_in_map(6, "$", "%", position[h] + {x, y})
-        replace_key_in_map(6, "_", "%", position[h] + {x, y})
-        replace_key_in_map(6, " ", "%", position[h] + {x, y})
-      elseif distsqr <= (radius[h] - 1.5) * (radius[h] - 1.5) then
-        replace_key_in_map(6, "_", "$", position[h] + {x, y})
-        replace_key_in_map(6, " ", "$", position[h] + {x, y})
-      elseif distsqr <= radius[h] * radius[h] then
-        replace_key_in_map(6, " ", "-", position[h] + {x, y})
-      end
-    end
-  end
-end
-
--- maze
-fmaze = new_kruskal_maze(fmaze_width, fmaze_height)
-glue_maze_into_map(6, fmaze, fmaze_height, fmaze_width, fmaze_offset)
-
--- numbers
-local number_field = {}
-for y = 1, #maze_maps[6] do
-  number_field[y] = ""
-  for x = 1, string.len(maze_maps[6][y]) do
-    number_field[y] = number_field[y]
-      .. luatools.cond(math.floor(x/5)%2 == math.floor(y/5)%2, final_spot_1, final_spot_2)
-  end
-end
-maze_maps[6] = luatools.fuse_map_layers(maze_maps[6], number_field)
-
---------------------------------------------
--- OXYD ROOM
---------------------------------------------
-
-oxyd_room = {
--- |        ++        |
-   "$%%%%%%%~~%%%~~~~~~",
-   "$%%%%%%%%%%3%%%%~~~",
-   "$$%%%%%%2%%B%%4%%%%",
-   "$$%%%1%%B%   %B%%5%",
-   "$$$%%B%         %B%",
-   "$$$%%    $$$$$    %",
-   "  s     $$$$$$$   %",
-   "$$$%%    $$$$$    %",
-   "$$$%%B%         %B%",
-   "$$%%%5%%B%   %B%%1%",
-   "$$%%%%%%4%%B%%2%%%%",
-   "$%%%%%%%%%%3%%%%~~~",
-   "$%%%%%%%~~%%%~~~~~~"}
-
---------------------------------------------
--- FUSING, GLUING AND CREATING THE WORLD
---------------------------------------------
-
--- prepare central room
-local central_number_field = {}
-for y = 1, #central_room do
-  central_number_field[y] = string.rep("0", string.len(central_room[y]))
-end
-central_room = luatools.fuse_map_layers(central_room, central_number_field)
-
--- prepare oxyd room
-for j = 1, 3*12 do
-  table.insert(oxyd_room, 1, "")
-end
-local oxyd_number_field = {}
-for y = 1, #oxyd_room do
-  oxyd_number_field[y] = string.rep("0", string.len(oxyd_room[y]))
-end
-oxyd_room = luatools.fuse_map_layers(oxyd_room, oxyd_number_field)
-
--- glue together
-local xspacing = {string.rep(" ", 2*18)}
-local yspacing = {"", "", "", "", "", "", "", "", "", "", ""} -- 11 times
-
-map1 = luatools.concat_maps_vertically(maze_maps[1], yspacing, maze_maps[2])
-map2 = luatools.concat_maps_vertically(maze_maps[3], yspacing, maze_maps[4])
-map3 = luatools.concat_maps_vertically(central_room, yspacing, maze_maps[5])
-whole_map = luatools.concat_maps_horizontally(
-    map1, xspacing, map2, xspacing, map3, maze_maps[6], oxyd_room)
-
-w, h = wo(main_resolver, "  ", whole_map)
-
-print ("Width: "..w..", Height: "..h..", Total: "..w*h)
-
---------------------------------------------
--- MONOFLOP-VORTEX CABLING
---------------------------------------------
-
-for j = 1, 5 do
-  no["monoflop#*"][j]["_mynumber"] = monoflop_permutation[j]
-  no["vortex#*"][j]["destination"] = vortex_goals[j]
-end
-
-function monoflop_call(onoff, sender)
-  local myvortex = no["vortex#*"][sender["_mynumber"]]
-  myvortex:message(luatools.cond(onoff == true, "open", "close"))
-end
-
-    ]]></el:luamain>
-    <el:i18n>
-      <el:string el:key="title">
-        <el:english el:translate="false"/>
-      </el:string>
-    </el:i18n>
-  </el:protected>
-</el:level>

Copied: trunk/data/levels/enigma_viii/andreas48_2.xml (from rev 1281, trunk/data/levels/enigma_viii/andreas48_1.xml)
===================================================================
--- trunk/data/levels/enigma_viii/andreas48_1.xml	2008-08-22 01:09:49 UTC (rev 1281)
+++ trunk/data/levels/enigma_viii/andreas48_2.xml	2008-08-23 16:58:35 UTC (rev 1284)
@@ -0,0 +1,450 @@
+<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
+<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
+  <el:protected>
+    <el:info el:type="level">
+      <el:identity el:title="Fashions Pass" el:subtitle="But dynamite is forever" el:id="andreas48"/>
+      <el:version el:score="2" el:release="2" el:revision="3" el:status="released"/>
+      <el:author el:name="Andreas Lochmann" el:email="" el:homepage=""/>
+      <el:copyright>Copyright ? 2008 Andreas Lochmann</el:copyright>
+      <el:license el:type="GPL v2.0 or above" el:open="true"/>
+      <el:compatibility el:enigma="1.10">
+        <el:dependency el:path="lib/natmaze" el:id="lib/natmaze" el:release="1" el:preload="true"/>
+        <el:dependency el:path="lib/liblua" el:id="lib/liblua" el:release="1" el:preload="true"/>
+        <el:dependency el:path="lib/libmath" el:id="lib/libmath" el:release="1" el:preload="true"/>
+        <el:dependency el:path="lib/libmap" el:id="lib/libmap" el:release="1" el:preload="true"/>
+      </el:compatibility>
+      <el:modes el:easy="false" el:single="true" el:network="false"/>
+      <el:comments>
+        <el:dedication>Thanks to Nat for his maze-library!</el:dedication>
+      </el:comments>
+      <el:score el:easy="-" el:difficult="21:06"/>
+    </el:info>
+    <el:luamain><![CDATA[
+
+--------------------------------------------
+-- CONSTANTS
+--------------------------------------------
+
+spot_constants = {SPOT_DEATH,
+                  SPOT_TRAP,
+                  SPOT_SENSOR,
+                  SPOT_ACTORIMPULSE,
+                  SPOT_HOLLOW}
+
+designs =
+  {{"fl-samba",     "fl-water", "st-bluegray",   "st-bluegray_hole",   OXYD_CYAN},
+   {"fl-rock",      "fl-abyss", "st-camouflage", "st-camouflage_hole", OXYD_GREEN},
+   {"fl-sahara",    "fl-abyss", "st-greenbrown", "st-greenbrown_hole", OXYD_YELLOW},
+   {"fl-black",     "fl-water", "st-marble",     "st-marble_hole",     OXYD_PURPLE},
+   {"fl-bluegreen", "fl-abyss", "st-metal",      "st-metal_hole",      OXYD_BLUE},
+   {"fl-brick",     "fl-water", "st-rock1",      "st-rock1_hole",      OXYD_RED},
+   {"fl-gravel",    "fl-abyss", "st-rock2",      "st-rock2_hole",      OXYD_BLACK},
+   {"fl-metal",     "fl-water", "st-rock3",      "st-rock3_hole",      OXYD_WHITE}}
+
+vortex_goals = {}
+maze_maps = {}
+mazes = {}
+
+--------------------------------------------
+-- MOST IMPORTANT RANDOM DECISIONS
+--------------------------------------------
+
+design_permutation = lib.math.permutation(#designs)
+spot_permutation = lib.math.permutation(#spot_constants)
+monoflop_permutation = lib.math.permutation(5)
+final_spot_1 = random(2) + 1
+final_spot_2 = random(2) + 3
+wo["ExtralifeGlasses"] = spot_constants[spot_permutation[1]]
+
+--------------------------------------------
+-- TILE DEFINITIONS (CENTRAL AND OXYD ROOM)
+--------------------------------------------
+
+ti["  "] = {"fl-water"}
+ti[" 0"] = {"fl-stone", friction = 3.0, adhesion = 3.0}
+ti["@0"] = {"#ac-blackball"} .. ti({"fl-stone", "start_position"})
+ti["L0"] = {"st_laser", orientation = EAST, state = ON} .. ti[" 0"]
+ti["P0"] = {"st_polarswitch"} .. ti[" 0"]
+ti["v0"] = {"it_vortex", "vortex#", autoclose = true, state = CLOSED} .. ti[" 0"]
+ti["M0"] = {"st_monoflop", "monoflop#", action = "signal"} .. ti[" 0"]
+ti["e0"] = {"it_extralife"} .. ti[" 0"]
+ti["f0"] = {"it-flagblack"} .. ti[" 0"]
+ti["W0"] = {"st_turnstilearm_w"} .. ti[" 0"]
+ti["S0"] = {"st_turnstilearm_s"} .. ti[" 0"]
+ti["T0"] = {"st_turnstile"} .. ti[" 0"]
+ti["B0"] = {"st-stone_break"} .. ti[" 0"]
+ti["s0"] = {"it-spade"} .. ti[" 0"]
+
+for j = 1, 5 do
+  ti[j.."0"] = {"st_oxyd", oxydcolor = designs[design_permutation[j]][5]} .. ti[" 0"]
+end
+
+ti["panel1"] = ti({"st_panel", cluster = 1}) .. ti[" 0"]
+ti["panel2"] = ti({"st_panel", cluster = 2}) .. ti[" 0"]
+ti["water"] = ti({"fl-water"})
+
+--------------------------------------------
+-- TILE DEFINITIONS (MAZES)
+--------------------------------------------
+
+for j = 1, 5 do
+  local design = designs[design_permutation[j]]
+  local spot = spot_constants[spot_permutation[j]]
+
+  ti["_"..j] = ti({design[1]})
+
+  if spot == SPOT_SENSOR then
+    ti[" "..j] = ti["_"..j] .. ti({"it_blocker", "sensor_door#"})
+  else
+    ti[" "..j] = ti["_"..j]
+  end
+  
+  if spot == SPOT_ACTORIMPULSE then
+    ti["#"..j] = ti["_"..j] .. ti({design[2]})
+  else
+    ti["#"..j] = ti["_"..j] .. ti({design[3]})
+  end
+  
+  if spot == SPOT_HOLLOW then
+    ti["."..j] = ti["_"..j] .. ti({design[4]})
+  else
+    ti["."..j] = ti["_"..j]
+  end
+
+  if spot == SPOT_DEATH then
+    ti["*"..j] = ti["_"..j] .. ti({"st_death", invisible = true})
+  elseif spot == SPOT_TRAP then
+    ti["*"..j] = ti["_"..j] .. ti({"it_trap"})
+  elseif spot == SPOT_SENSOR then
+    ti["*"..j] = ti["_"..j]
+      .. ti({"it_sensor", invisible = true, action = "close", target = "sensor_door#*"})
+  elseif spot == SPOT_ACTORIMPULSE then
+    ti["*"..j] = ti["_"..j] .. ti({"st_actorimpulse", invisible = true, strength = 1000})
+  elseif spot == SPOT_HOLLOW then
+    ti["*"..j] = ti["_"..j] .. ti({design[4]}) .. ti({"it-booze-broken"})
+  end
+
+  if spot == SPOT_SENSOR then
+    ti["g"..j] = ti["_"..j] .. ti({"it_sensor", target = "sensor_door#*",
+                   action = "open"})
+  else
+    ti["g"..j] = ti["_"..j]
+  end
+  
+  ti["M"..j] = {"st_monoflop", target = "vortex_"..spot, action = "signal"} .. ti["_"..j]
+  ti["v"..j] = {"it_vortex", "vortex_"..spot, autoclose = true, state = CLOSED,
+                 destination = "start_position"} .. ti["_"..j]
+  ti["O"..j] = {"st_oxyd", oxydcolor = design[5]} .. ti["_"..j]
+  ti["d"..j] = {"it-dynamite"} .. ti["_"..j]
+  ti["G"..j] = {"it_glasses", state = spot_constants[spot_permutation[(j%5) + 1]]}
+               .. ti["_"..j]
+  ti["H"..j] = {"it_glasses", state = spot_constants[spot_permutation[((j+1)%5) + 1]]}
+               .. ti["_"..j]
+  ti["E"..j] = {"it_extralife"} .. ti["_"..j]
+  ti["A"..j] = {"st_oneway", orientation = EAST} .. ti["_"..j]
+  ti["-"..j] = ti[" 0"]
+
+  if (j == 4) then
+    ti["+"..j] = ti["#"..j]
+    ti["k"..j] = ti["_"..j]
+    ti["D"..j] = ti["_"..j] .. {"st_blocker", "keydoor"..j}
+    ti["L"..j] = ti["#"..j]
+    ti["N"..j] = ti["#"..j]
+  elseif j == 5 then
+    ti["+"..j] = ti["#"..j]
+    ti["k"..j] = ti["_"..j]
+    ti["D"..j] = ti["_"..j] .. {"st_blocker", "keydoor"..j}
+    ti["K"..j] = ti["#"..j]
+  else
+    ti["+"..j] = ti["_"..j]
+    ti["K"..j] = ti["_"..j]
+    ti["D"..j] = ti["_"..j]
+    ti["L"..j] = ti["_"..j]
+    ti["N"..j] = ti["_"..j]
+  end
+end    
+
+ti["k1"] = ti["_1"] .. {"it_floppy"}
+ti["k2"] = ti["_2"] .. {"it_key", code = "good_key"}
+ti["k3"] = ti["_3"] .. {"it_key", code = "bad_key"}
+ti["K4"] = ti["_4"] .. {"st_floppy", target = "keydoor4"}
+ti["N5"] = ti["_5"] .. {"st_key", code = "good_key", target = "key_call"}
+ti["L5"] = ti["_5"] .. {"st_key", code = "bad_key", target = "key_call"}
+
+--------------------------------------------
+-- RESOLVER (RANDOM ELEMENTS)
+--------------------------------------------
+
+panel_randomicity = {["~"] = 20, ["%"] = 70, ["$"] = 100} -- in percent
+
+function main_resolver(key, x, y)
+  local mainkey = string.sub(key, 1, 1)
+  local number = tonumber(string.sub(key, 2, 2))
+  if panel_randomicity[mainkey] then
+    if random(100) <= panel_randomicity[mainkey] then
+      return ti["panel"..random(2)]
+    else
+      return ti["water"]
+    end
+  elseif mainkey == "*" and random(3) == 1 then
+    return ti["#"..number]
+  elseif mainkey == "." and random(3) == 1 then
+    return ti["_"..number]
+  elseif mainkey == "g" then
+    table.insert(vortex_goals, po({x + 0.5, y + 0.5}))
+    return ti["g"..number]
+  end
+  return ti[key]
+end
+
+--------------------------------------------
+-- MAP AND MAZE TOOLS
+--------------------------------------------
+
+function replace_key_in_map(j, oldkey, newkey, pos)
+  if maze_maps[j][po(pos) - {1,1}] == oldkey then
+    maze_maps[j][po(pos) - {1,1}] = newkey
+  end
+end
+
+function glue_maze_into_map(j, maze, height, width, offset)
+  for y = 0, height - 1 do
+    for x = 0, width - 1 do
+      local pos = 2*po({x, y}) + offset
+      local east = lib.lua.cond(maze:can_go_east(x,y), ".", "*")
+      local south = lib.lua.cond(maze:can_go_south(x,y), ".", "*")
+      replace_key_in_map(j, " ", east,  pos + {1,0})
+      replace_key_in_map(j, " ", south, pos + {0,1})
+      replace_key_in_map(j, " ", "#",   pos + {1,1})
+    end
+  end
+end
+
+--------------------------------------------
+-- CENTRAL ROOM
+--------------------------------------------
+
+central_room = wo:newMap(" ", {
+-- |        ++        |        ++        |        ++        |
+  "~~~~~~~%%%%%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%%%%$",
+  "~~~~~%%%%%%%%%%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%%%%%$$",
+  "~~~%%%%     %%%%%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%%%%%%%%$$",
+  "~~%%%   M v    %%%%%~~~~%%%%%%%%%%~~~~~~~~~~%%%%%%%%%$$$$",
+  "~~%%  v     M    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%$$$$$$$",
+  "~~%%               %%%%%%%      %%%%%%%%%%%%%%%%%$WT $$$$",
+  "~~%% M   @    v             LP                     S     ",
+  "~~%%               %%%%%%%      %%%%%%%%%%%%%%%%%$$$$$$$$",
+  "~~%%  v     M    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%$$$$$$$",
+  "~~%%%   M v    %%%%%~~~~%%%%%%%%%%~~~~~~~~~~%%%%%%%%%$$$$",
+  "~~~%%%%     %%%%%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%%%%%%%%$$",
+  "~~~~~%%%%%%%%%%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%%%%%$$",
+  "~~~~~~~%%%%%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%%%%$"})
+
+--------------------------------------------
+-- FIRST FIVE MAZES
+--------------------------------------------
+
+maze_map = wo:newMap(" ", {
+"###O################################O##",
+"#_____                             ___#",
+"#_M___                             _d_O",
+"O__v__                             ___#",
+"#___g_                                #",
+"#_____                                #",
+"#                                     #",
+"#                                     #",
+"#                                     #",
+"#                                     #",
+"#                                     #",
+"#                                     #",
+"#                                     #",
+"#                                     #",
+"#                                     #",
+"#                                     #",
+"#                                     #",
+"#                                     #",
+"#                                     #",
+"#                                _____#",
+"#                                _++D+#",
+"#___                             _Lk__O",
+"O_d_                             _K___#",
+"#___                             _N___#",
+"##O################################O###"})
+
+maze_width = 19
+maze_height = 12
+maze_offset = po({2, 2})
+
+for j = 1, 5 do
+  mazes[j] = new_kruskal_maze(maze_width, maze_height)
+end
+
+for j = 1, 5 do
+  maze_maps[j] = lib.lua.deep_copy(maze_map)
+  glue_maze_into_map(j, mazes[j], maze_height, maze_width, maze_offset)
+  local glasses1 = po({5 + random(9), 5 + random(3)})
+  local glasses2, extralife
+  repeat
+    glasses2 = po({5 + random(9), 5 + random(3)})
+  until glasses2 ~= glasses1
+  repeat
+    extralife = po({5 + random(9), 5 + random(3)})
+  until (extralife ~= glasses1) and (extralife ~= glasses2)
+  replace_key_in_map(j, " ", "G", 2*glasses1 + maze_offset)
+  replace_key_in_map(j, " ", "H", 2*glasses2 + maze_offset)
+  replace_key_in_map(j, " ", "E", 2*extralife + maze_offset)
+  if random(2) == 1 then
+    maze_maps[j] = maze_maps[j] ^ MAP_MIRROR_VERTICAL
+  end
+  if random(2) == 1 then
+    maze_maps[j] = maze_maps[j] ^ MAP_MIRROR_HORIZONTAL
+  end
+  maze_maps[j] = maze_maps[j] * (""..j)
+end
+
+--------------------------------------------
+-- FINAL MAZE
+--------------------------------------------
+
+fmaze_width = 19 * 2 - 1
+fmaze_height = 12 * 2 - 1
+fmaze_offset = po({3, 3})
+
+-- frame
+maze_maps[6] = {string.rep("$", fmaze_width * 2 + 3)}
+table.insert(maze_maps[6], maze_maps[6][1])
+for j = 1, fmaze_height * 2 - 1 do
+  table.insert(maze_maps[6], "$$" .. string.rep(" ", fmaze_width * 2 - 1) .. "$$")
+end
+table.insert(maze_maps[6], maze_maps[6][1])
+table.insert(maze_maps[6], maze_maps[6][1])
+maze_maps[6] = wo:newMap(" ", maze_maps[6])
+
+-- oneway entry and exit
+replace_key_in_map(6, "$", "-", {1, 7})
+replace_key_in_map(6, "$", "A", {2, 7})
+replace_key_in_map(6, "$", "-", {fmaze_width * 2 + 2, fmaze_height * 2 - 3})
+replace_key_in_map(6, "$", "-", {fmaze_width * 2 + 3, fmaze_height * 2 - 3})
+
+-- water/panel holes
+local radius = {}
+local position = {}
+for h = 1, 5 do
+  local tries = 0
+  repeat
+    radius[h] = 11 - h   -- former: 5 + random(5)
+    position[h] = po({radius[h] + 2 + random(2*fmaze_width - 1 - 2*(radius[h] + 2)),
+                      radius[h] + 2 + random(2*fmaze_height - 1 - 2*(radius[h] + 2))})
+    local correct = true
+    for j = 1, h - 1 do
+      local delta = position[h] - position[j]
+      local joined_radius = radius[h] + radius[j] + 2
+      correct = correct and
+        (delta.x*delta.x + delta.y*delta.y > joined_radius * joined_radius)
+    end
+    tries = tries + 1
+  until correct or (tries > 100)
+end
+for h = 1, #radius do
+  for y = -radius[h], radius[h] do
+    for x = -radius[h], radius[h] do
+      local distsqr = x*x + y*y
+      if distsqr <= (radius[h] - 3) * (radius[h] - 3) then
+        replace_key_in_map(6, "$", "%", position[h] + {x, y})
+        replace_key_in_map(6, "-", "%", position[h] + {x, y})
+        replace_key_in_map(6, " ", "%", position[h] + {x, y})
+      elseif distsqr <= (radius[h] - 1.5) * (radius[h] - 1.5) then
+        replace_key_in_map(6, "-", "$", position[h] + {x, y})
+        replace_key_in_map(6, " ", "$", position[h] + {x, y})
+      elseif distsqr <= radius[h] * radius[h] then
+        replace_key_in_map(6, " ", "-", position[h] + {x, y})
+      end
+    end
+  end
+end
+
+-- maze
+fmaze = new_kruskal_maze(fmaze_width, fmaze_height)
+glue_maze_into_map(6, fmaze, fmaze_height, fmaze_width, fmaze_offset)
+
+-- numbers
+local number_field = {}
+for y = 1, #maze_maps[6] do
+  number_field[y] = ""
+  for x = 1, string.len(maze_maps[6][y]) do
+    number_field[y] = number_field[y]
+      .. lib.lua.cond(math.floor(x/5)%2 == math.floor(y/5)%2, final_spot_1, final_spot_2)
+  end
+end
+maze_maps[6] = maze_maps[6] * wo:newMap(" ", number_field)
+
+--------------------------------------------
+-- OXYD ROOM
+--------------------------------------------
+
+oxyd_room = wo:newMap(" ", {
+-- |        ++        |
+   "%%%%%%%~~%%%~~~~~~~",
+   "%%%%%%%%%%3%%%%~~~~",
+   "$%%%%%%2%%B%%4%%%%~",
+   "$%%%1%%B%   %B%%5%%",
+   "$$%%B%         %B%%",
+   "$$$%    $$$$$    %%",
+   "efs    $$~~~$$   %%",
+   "$$$%    $$$$$    %%",
+   "$$%%B%         %B%%",
+   "$%%%5%%B%   %B%%1%%",
+   "$%%%%%%4%%B%%2%%%%~",
+   "%%%%%%%%%%3%%%%~~~~",
+   "%%%%%%%~~%%%~~~~~~~"})
+
+--------------------------------------------
+-- FUSING, GLUING AND CREATING THE WORLD
+--------------------------------------------
+
+-- prepare central and oxyd room
+central_room = central_room * "0"
+oxyd_room = (wo:newMap(" ", 1, 3*12) + oxyd_room) * "0"
+
+-- glue together
+xspacing = wo:newMap("  ", 18, 1)
+yspacing = wo:newMap("  ", 1, 11)
+
+map1 = maze_maps[1] + yspacing + maze_maps[2]
+map2 = maze_maps[3] + yspacing + maze_maps[4]
+map3 = central_room + yspacing + (maze_maps[5] .. xspacing)
+whole_map =     map1 .. xspacing .. map2 .. xspacing
+             .. map3 .. maze_maps[6] .. oxyd_room
+
+w, h = wo(main_resolver, "  ", whole_map)
+
+--------------------------------------------
+-- MONOFLOP-VORTEX CABLING
+--------------------------------------------
+
+monoflops = no["monoflop#*"]
+vortices = no["vortex#*"]
+
+for j = 1, 5 do
+  monoflops[j]["target"] = vortices[monoflop_permutation[j]]
+  vortices[j]["destination"] = vortex_goals[j]
+end
+
+--------------------------------------------
+-- KEY-STONE CALLBACK FUNCTION
+--------------------------------------------
+
+key_sum = 0
+function key_call(is_on, sender)
+  key_sum = key_sum + lib.lua.cond(is_on == ON, 1, -1)
+  no["keydoor5"]:message(lib.lua.cond(key_sum == 2, "open", "close"))
+end
+
+    ]]></el:luamain>
+    <el:i18n>
+      <el:string el:key="title">
+        <el:english el:translate="false"/>
+      </el:string>
+    </el:i18n>
+  </el:protected>
+</el:level>

Modified: trunk/data/levels/enigma_viii/andreas49_1.xml
===================================================================
--- trunk/data/levels/enigma_viii/andreas49_1.xml	2008-08-23 12:20:31 UTC (rev 1283)
+++ trunk/data/levels/enigma_viii/andreas49_1.xml	2008-08-23 16:58:35 UTC (rev 1284)
@@ -3,12 +3,12 @@
   <el:protected>
     <el:info el:type="level">
       <el:identity el:title="Wired" el:subtitle="" el:id="andreas49"/>
-      <el:version el:score="1" el:release="1" el:revision="3" el:status="released"/>
+      <el:version el:score="1" el:release="1" el:revision="4" el:status="released"/>
       <el:author el:name="Andreas Lochmann" el:email="" el:homepage=""/>
       <el:copyright>Copyright ? 2008 Andreas Lochmann</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
       <el:compatibility el:enigma="1.10">
-        <el:dependency el:path="lib/libluatools" el:id="lib/libluatools" el:release="1" el:preload="true"/>
+        <el:dependency el:path="lib/libmath" el:id="lib/libmath" el:release="1" el:preload="true"/>
       </el:compatibility>
       <el:modes el:easy="true" el:single="true" el:network="false"/>
       <el:score el:easy="0:37" el:difficult="8:49"/>
@@ -30,11 +30,11 @@
 ti["S"] = {"st_switch", target = "easy_mode_call"}
 
 floors  = {ti[" "], ti["a"], ti["b"], ti["c"]}
-polynom = luatools.random_vector(10, 4)
+polynom = lib.math.random_vector(10, 4)
 
 function myresolver(key, x, y)
   if key == " " then  
-    return floors[luatools.cubic_polynomial(polynom, x, y) % (#floors) + 1]
+    return floors[lib.math.cubic_polynomial(polynom, x, y) % (#floors) + 1]
   elseif    (key == "#")
          or ((key == "_") and (random(4) == 1))
          or ((key == "S") and wo["IsDifficult"]) then
@@ -61,8 +61,8 @@
    "####################___________________"
 })
 
-door_p = luatools.permutation(12)
-wire_p = luatools.permutation(12)
+door_p = lib.math.permutation(12)
+wire_p = lib.math.permutation(12)
 woods = no["wood#*"]
 triggers = no["trigger#*"]
 doors = no["door#*"]

Modified: trunk/data/levels/enigma_viii/index.xml
===================================================================
--- trunk/data/levels/enigma_viii/index.xml	2008-08-23 12:20:31 UTC (rev 1283)
+++ trunk/data/levels/enigma_viii/index.xml	2008-08-23 16:58:35 UTC (rev 1284)
@@ -1,7 +1,7 @@
 <?xml version="1.0" encoding="UTF-8" standalone="no" ?>
 <index xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="index.xsd">
 
-  <info enigma="1.00" group="Enigma" location="10900" network="false" owner="Enigma Team" release="1" revision="5" title="Enigma VIII"/>
+  <info enigma="1.00" group="Enigma" location="10900" network="false" owner="Enigma Team" release="1" revision="6" title="Enigma VIII"/>
 
   <attributes/>
 
@@ -10,7 +10,7 @@
     <level _seq="2" _title="Jack-Of-All-Trades" _xpath="./mecke12_1" author="mecke" ctrl="force" easy="true" id="mecke12" rel="1" rev="31" score="1" target="time" unit="duration"/>
     <level _seq="3" _title="Enigmaparcour" _xpath="./mecke15_1" author="mecke" ctrl="force" easy="true" id="mecke15" rel="1" rev="21" score="1" target="time" unit="duration"/>
     <level _seq="4" _title="Rhythm of Space" _xpath="./mecke20_1" author="mecke" ctrl="force" easy="true" id="mecke20" rel="1" rev="21" score="1" target="time" unit="duration"/>
-    <level _seq="5" _title="The Show Jumper" _xpath="./andreas47_1" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas47" rel="1" rev="3" score="1" target="time" unit="duration"/>
+    <level _seq="5" _title="The Show Jumper" _xpath="./andreas47_1" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas47" rel="1" rev="4" score="1" target="time" unit="duration"/>
     <level _seq="6" _title="The Red Room" _xpath="./joe29_1" author="Joseph Dunne" ctrl="force" easy="true" id="joe29" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="7" _title="Enigmines" _xpath="./huffman01_1" author="Brian Huffman" ctrl="force" easy="true" id="huffman01" rel="1" rev="2" score="1" target="time" unit="duration"/>
     <level _seq="8" _title="Red Cave" _xpath="./mecke21_1" author="mecke" ctrl="force" easy="true" id="mecke21" rel="1" rev="30" score="1" target="time" unit="duration"/>
@@ -27,7 +27,7 @@
     <level _seq="19" _title="Color Maze" _xpath="./pulley16_3" author="Mark Pulley" ctrl="force" easy="false" id="pulley16" rel="3" rev="4" score="3" target="time" unit="duration"/>
     <level _seq="20" _title="Earthlink" _xpath="./pulley15_1" author="Mark Pulley" ctrl="force" easy="true" id="pulley15" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="21" _title="Vanity's Constrictions" _xpath="./andreas53_2" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas53" rel="2" rev="5" score="2" target="time" unit="duration"/>
-    <level _seq="22" _title="Wired" _xpath="./andreas49_1" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas49" rel="1" rev="3" score="1" target="time" unit="duration"/>
+    <level _seq="22" _title="Wired" _xpath="./andreas49_1" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas49" rel="1" rev="4" score="1" target="time" unit="duration"/>
     <level _seq="23" _title="Push Wires" _xpath="./ral24_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20080708ral196" rel="1" rev="100" score="1" target="time" unit="duration"/>
     <level _seq="24" _title="Wired Five" _xpath="./ral25_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20080721ral073" rel="1" rev="109" score="1" target="time" unit="duration"/>
     <level _seq="25" _title="Wireban Premiere" _xpath="./ral26_1" author="Ronald Lamprecht" ctrl="force" easy="false" id="20080715ral161" rel="1" rev="106" score="1" target="time" unit="duration"/>
@@ -36,7 +36,7 @@
     <level _seq="28" _title="Freestyle Microwire" _xpath="./ral29_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20080719ral530" rel="1" rev="107" score="1" target="time" unit="duration"/>
     <level _seq="29" _title="Balance Beam" _xpath="./mecke03_1" author="mecke" ctrl="force" easy="true" id="mecke03" rel="1" rev="29" score="1" target="time" unit="duration"/>
     <level _seq="30" _title="Colored Oxyds" _xpath="./andreas50_1" author="Andreas Lochmann" ctrl="force" easy="false" id="andreas50" rel="1" rev="2" score="1" target="time" unit="duration"/>
-    <level _seq="31" _title="Fashions Pass" _xpath="./andreas48_1" author="Andreas Lochmann" ctrl="force" easy="false" id="andreas48" rel="1" rev="2" score="1" target="time" unit="duration"/>
+    <level _seq="31" _title="Fashions Pass" _xpath="./andreas48_2" author="Andreas Lochmann" ctrl="force" easy="false" id="andreas48" rel="2" rev="3" score="2" target="time" unit="duration"/>
     <level _seq="32" _title="Colored Turnstiles" _xpath="./andreas51_1" author="Andreas Lochmann" ctrl="force" easy="false" id="andreas51" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="33" _title="Sanssouci" _xpath="./mecke05_1" author="mecke" ctrl="force" easy="true" id="mecke05" rel="1" rev="22" score="1" target="time" unit="duration"/>
   </levels>

Copied: trunk/data/levels/lib/liblua.xml (from rev 1281, trunk/data/levels/lib/libluatools.xml)
===================================================================
--- trunk/data/levels/lib/libluatools.xml	2008-08-22 01:09:49 UTC (rev 1281)
+++ trunk/data/levels/lib/liblua.xml	2008-08-23 16:58:35 UTC (rev 1284)
@@ -0,0 +1,189 @@
+<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
+<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
+  <el:protected>
+    <el:info el:type="library">
+      <el:identity el:title="" el:id="lib/liblua"/>
+      <el:version el:score="1" el:release="1" el:revision="4" el:status="released"/>
+      <el:author  el:name="Enigma Team" el:email="" el:homepage=""/>
+      <el:copyright>Copyright ? 2007, 2008 Enigma Team</el:copyright>
+      <el:license el:type="GPL v2.0 or above" el:open="true"/>
+      <el:compatibility el:enigma="1.10">
+      </el:compatibility>
+      <el:modes el:easy="false" el:single="false" el:network="false"/>
+      <el:comments>
+      </el:comments>
+      <el:score el:easy="-" el:difficult="-"/>
+    </el:info>
+    <el:luamain><![CDATA[
+
+---------------------------------------------------------------------
+-- liblib.lua holds some general utilities for working with Lua.
+-- It includes functions for deep-copying tables, combining tables,
+-- and shuffling tables and a conditional function.
+---------------------------------------------------------------------
+--
+-- liblua provides the following functions:
+--   lib.lua.deep_copy(source)
+--   lib.lua.combine_tables(arg1, ...)
+--   lib.lua.shuffle_table(t)
+--   lib.lua.print_table(t, prefix, depth)
+--   lib.lua.mod(value, modul)
+--   lib.lua.cond(condition, iftrue, iffalse)
+--
+
+lib.lua = {}
+setmetatable(lib.lua, getmetatable(lib))
+
+---------------------------------------------------------------------
+--  TABLE  HANDLING
+---------------------------------------------------------------------
+
+-- deep_copy returns a copy of SOURCE, where table entries are
+-- not copied as memory references, but complete ("deep copy").
+-- Metatables are transfered, but not deep-copied.
+-- TODO: use rawset/rawget instead.
+function lib.lua.deep_copy(source)
+ if type(source) ~= "table" then
+   return source
+ end
+ local dest = {}
+ for k, v in pairs(source) do
+   if type(source[k]) == "table" then
+     dest[k] = lib.lua.deep_copy(source[k])
+   else
+     dest[k] = source[k]
+   end
+ end
+ setmetatable(dest, getmetatable(source))
+ return dest
+end 
+
+-- combine_tables returns a table consisting of all entries of the
+-- entries of OVER_TABLE: OVER_TABLE is a table of tables, say
+-- {T1, T2, T3, ...}. The result of combine_tables will be a new
+-- table with all entries of T1, T2, T3 etc., with the first table
+-- having highest priority etc.
+function lib.lua.combine_tables(arg1, ...)
+  local args = {arg1, ...}
+  if table.getn(args) == 1 then
+    args = arg1
+  end
+  if type(args) ~= "table" then
+    error("combine_tables: None or only one argument, and it's not a table!", 2)
+  end
+  local result = {}
+  for j,t in pairs(args) do
+    if type(t) ~= "table" then
+      error("combine_tables: Main table does not consist of tables alone!", 2)
+    end
+    for k,v in pairs(t) do
+      result[k] = result[k] or lib.lua.deep_copy(v)
+    end
+  end
+  return result
+end
+
+-- shuffle_table resorts the table T randomly. Note that only those entries
+-- of T can be sorted, that are indexed with integers from 1 to table.getn(T).
+-- No return value, the table itself is shuffled.
+function lib.lua.shuffle_table(t)
+  if table.getn(t) < 2 then
+    return
+  end
+  for n = table.getn(t), 2, -1 do
+    local m = math.random(n)
+    t[n], t[m] = t[m], t[n]
+  end
+end
+
+-- print_table uses the print command to print all
+-- entries of a table, one table per line.
+-- It should be used for debug reasons only.
+-- PREFIX can be a string to be put in front of each
+-- line of the output, in case you need to distinguish
+-- several outputs from each other.
+-- print_table is recursive, i.e. a table with table
+-- as entries will call print_table again. To avoid
+-- infinite loops, DEPTH is used as additional argument.
+-- Don't use it in levels. If you want to suppress
+-- the recursive function, use DEPTH = -1.
+function lib.lua.print_table(t, prefix, depth)
+  if type(t) ~= "table" then
+    print("print_table: Argument is of type "..type(t)..", not table.")
+    return
+  end
+  for key, value in pairs(t) do
+    local key_s
+    if type(key) == "string" then
+      key_s = "\"" .. key .. "\""
+    elseif type(key) == "number" then
+      key_s = key
+    else
+      key_s = "<" .. type(key) .. ">"
+    end
+    if type(value) == "number" then
+      print((prefix or "") .. "|" .. key_s .. " = " .. value)
+    elseif type(value) == "string" then
+      print((prefix or "").. "|" .. key_s .. " = \"" .. value .. "\"")
+    elseif type(value) == "table" then
+      if (depth or 0) < 5 then
+        print((prefix or "") .. "|" .. key_s .. " = |")
+        lib.lua.print_table(value,
+            (prefix or "") .. "|" .. string.rep(" ", string.len(key_s) + 3),
+            (depth or 0) + 1)
+        print((prefix or "") .. "|")
+      else
+        print((prefix or "") .. "|" .. key_s .. " = | ...")
+      end
+    else
+      print((prefix or "").. "|" .. key_s .. " of type " .. type(value))
+    end
+  end
+end
+
+---------------------------------------------------------------------
+--  MATHEMATICAL  FUNCTIONS
+---------------------------------------------------------------------
+
+-- As Lua uses different names for the modulo-function in its
+-- versions, it's sometimes better to wrap them.
+-- Even worse, lua's modulo function doesn't handle negative
+-- values as it should. The following function returns (given
+-- an integer) another integer between 0 and MODUL-1.
+function lib.lua.mod(value, modul)
+  if (type(value) ~= "number") or (type(modul) ~= "number") then
+    error("lib.lua.mod: Arguments are not two numbers.", 2)
+  end
+  if modul <= 0 then
+    error("lib.lua.mod: Second argument (modul) must be positive.", 2)
+  end
+  if value < 0 then
+    -- No, the following call to lib.lua.mod is not a real
+    -- recursion, it's only for the case where VALUE is a
+    -- negative multiple of MODUL (otherwise we would get
+    -- MODUL as result, not zero).
+    return lib.lua.mod(modul + (math.fmod or math.mod)(value, modul), modul)
+  else
+    return (math.fmod or math.mod)(value, modul)
+  end
+end
+
+-- A wrapper of "if" to resemble the ternary ?:-function.
+-- Note that this function evaluates both IFTRUE as well as IFFALSE, e.g.
+--   lib.lua.cond(t == 0, 1/t, error("Division by zero"))
+-- will evaluate the error-function and thus halt for any T.
+-- Hence: Make sure there are no sideeffects in IFTRUE and IFFALSE!
+function lib.lua.cond(condition, iftrue, iffalse)
+  if condition then
+    return iftrue
+  else
+    return iffalse
+  end
+end
+
+    ]]></el:luamain>
+    <el:i18n>
+    </el:i18n>
+  </el:protected>
+</el:level>
+

Deleted: trunk/data/levels/lib/libluatools.xml
===================================================================
--- trunk/data/levels/lib/libluatools.xml	2008-08-23 12:20:31 UTC (rev 1283)
+++ trunk/data/levels/lib/libluatools.xml	2008-08-23 16:58:35 UTC (rev 1284)
@@ -1,375 +0,0 @@
-<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
-<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
-  <el:protected>
-    <el:info el:type="library">
-      <el:identity el:title="" el:id="lib/libluatools"/>
-      <el:version el:score="1" el:release="1" el:revision="3" el:status="released"/>
-      <el:author  el:name="Enigma Team" el:email="" el:homepage=""/>
-      <el:copyright>Copyright ? 2007, 2008 Enigma Team</el:copyright>
-      <el:license el:type="GPL v2.0 or above" el:open="true"/>
-      <el:compatibility el:enigma="1.00">
-      </el:compatibility>
-      <el:modes el:easy="false" el:single="false" el:network="false"/>
-      <el:comments>
-      </el:comments>
-      <el:score el:easy="-" el:difficult="-"/>
-    </el:info>
-    <el:luamain><![CDATA[
-
----------------------------------------------------------------------
--- libluatools holds some general utilities for working with Lua.
--- It includes functions for deep-copying tables, combining tables,
--- and shuffling tables, a function to calculate Manhattan
--- distances and a wrapper for Lua's modulo-function, which has
--- been renamed from math.mod to math.fmod.
----------------------------------------------------------------------
-
-luatools = {}
-
----------------------------------------------------------------------
---  TABLE  HANDLING
----------------------------------------------------------------------
-
--- deep_copy returns a copy of SOURCE, where table entries are
--- not copied as memory references, but complete ("deep copy").
--- Metatables are transfered, but not deep-copied.
--- TODO: use rawset/rawget instead.
-function luatools.deep_copy(source)
- if type(source) ~= "table" then
-   return source
- end
- local dest = {}
- for k, v in pairs(source) do
-   if type(source[k]) == "table" then
-     dest[k] = luatools.deep_copy(source[k])
-   else
-     dest[k] = source[k]
-   end
- end
- setmetatable(dest, getmetatable(source))
- return dest
-end 
-
--- combine_tables returns a table consisting of all entries of the
--- entries of OVER_TABLE: OVER_TABLE is a table of tables, say
--- {T1, T2, T3, ...}. The result of combine_tables will be a new
--- table with all entries of T1, T2, T3 etc., with the first table
--- having highest priority etc.
-function luatools.combine_tables(arg1, ...)
-  local args = {arg1, ...}
-  if table.getn(args) == 1 then
-    args = arg1
-  end
-  if type(args) ~= "table" then
-    error("combine_tables: None or only one argument, and it's not a table!")
-  end
-  local result = {}
-  for j,t in pairs(args) do
-    if type(t) ~= "table" then
-      error("combine_tables: Main table does not consist of tables alone!")
-    end
-    for k,v in pairs(t) do
-      result[k] = result[k] or luatools.deep_copy(v)
-    end
-  end
-  return result
-end
-
--- shuffle_table resorts the table T randomly. Note that only those entries
--- of T can be sorted, that are indexed with integers from 1 to table.getn(T).
--- No return value, the table itself is shuffled.
-function luatools.shuffle_table(t)
-  if table.getn(t) < 2 then
-    return
-  end
-  for n = table.getn(t), 2, -1 do
-    local m = math.random(n)
-    t[n], t[m] = t[m], t[n]
-  end
-end
-
--- print_table uses the print command to print all
--- entries of a table, one table per line.
--- It should be used for debug reasons only.
--- PREFIX can be a string to be put in front of each
--- line of the output, in case you need to distinguish
--- several outputs from each other.
--- print_table is recursive, i.e. a table with table
--- as entries will call print_table again. To avoid
--- infinite loops, DEPTH is used as additional argument.
--- Don't use it in levels. If you want to suppress
--- the recursive function, use DEPTH = -1.
-function luatools.print_table(t, prefix, depth)
-  if type(t) ~= "table" then
-    print("print_table: Argument is of type "..type(t)..", not table.")
-    return
-  end
-  for key, value in pairs(t) do
-    local key_s
-    if type(key) == "string" then
-      key_s = "\"" .. key .. "\""
-    elseif type(key) == "number" then
-      key_s = key
-    else
-      key_s = "<" .. type(key) .. ">"
-    end
-    if type(value) == "number" then
-      print((prefix or "") .. "|" .. key_s .. " = " .. value)
-    elseif type(value) == "string" then
-      print((prefix or "").. "|" .. key_s .. " = \"" .. value .. "\"")
-    elseif type(value) == "table" then
-      if (depth or 0) < 5 then
-        print((prefix or "") .. "|" .. key_s .. " = |")
-        luatools.print_table(value,
-            (prefix or "") .. "|" .. string.rep(" ", string.len(key_s) + 3),
-            (depth or 0) + 1)
-        print((prefix or "") .. "|")
-      else
-        print((prefix or "") .. "|" .. key_s .. " = | ...")
-      end
-    else
-      print((prefix or "").. "|" .. key_s .. " of type " .. type(value))
-    end
-  end
-end
-
----------------------------------------------------------------------
---  ADVANCED  POSITION  HANDLING  AND  CALCULATIONS
----------------------------------------------------------------------
-
--- manhattan_distance calculates the Manhattan-distance between
--- (X1,Y1) and (X2, Y2), which is |X1 - X2| + |Y1 - Y2|.
--- If X2 and Y2 are nil, X1 and Y1 are assumed to be positions
--- instead of coordinates.
-function luatools.manhattan_distance(x1, y1, x2, y2)
-  if x1 and y1 and x2 and y2 then
-    -- x1, y1, x2, y2 are coordinates
-    return math.abs(x1 - x2) + math.abs(y1 - y2)
-  end
-  if x1 and y1 then
-    -- x1 and y1 are positions, possibly tables.
-    local p1 = x1
-    local p2 = y1
-    if type(p1) == "table" then
-      p1 = po(p1)
-    end
-    if type(p2) == "table" then
-      p2 = po(p2)
-    end
-    return math.abs(p1.x - p2.x) + math.abs(p1.y - p2.y)
-  end
-  error("manhattan_distance: Too less arguments.")  
-end
-
----------------------------------------------------------------------
---  MATHEMATICAL  FUNCTIONS
----------------------------------------------------------------------
-
--- As Lua uses different names for the modulo-function in its
--- versions, it's sometimes better to wrap them.
--- Even worse, lua's modulo function doesn't handle negative
--- values as it should. The following function returns (given
--- an integer) another integer between 0 and MODUL-1.
-function luatools.mod(value, modul)
-  if (type(value) ~= "number") or (type(modul) ~= "number") then
-    error("luatools.mod: Arguments are not two numbers.")
-  end
-  if modul <= 0 then
-    error("luatools.mod: Second argument (modul) must be positive.")
-  end
-  if value < 0 then
-    -- No, the following call to luatools.mod is not a real
-    -- recursion, it's only for the case where VALUE is a
-    -- negative multiple of MODUL (otherwise we would get
-    -- MODUL as result, not zero).
-    return luatools.mod(modul + (math.fmod or math.mod)(value, modul), modul)
-  else
-    return (math.fmod or math.mod)(value, modul)
-  end
-end
-
--- A wrapper of "if" to resemble the ternary ?:-function.
--- Note that this function evaluates both IFTRUE as well as IFFALSE, e.g.
---   luatools.cond(t == 0, 1/t, error("Division by zero"))
--- will evaluate the error-function and thus halt for any T.
--- Hence: Make sure there are no sideeffects in IFTRUE and IFFALSE!
-function luatools.cond(condition, iftrue, iffalse)
-  if condition then
-    return iftrue
-  else
-    return iffalse
-  end
-end
-
--- digits returns a table whose elements are the digits of NUMBER
--- in base BASE. BASE can be a number (e.g. 3 to get ternary)
--- as well as a table (then the table entries with numerical
--- keys will be used as digits).
--- Examples:
---   luatools.digits(13, 2) = {1, 0, 1, 1}
---   luatools.digits(15, 16) = {15}
---   luatools.digits(17, 3) = {2, 2, 1}
---   luatools.digits(17, {2, "b", 5}) = {5, 5, "b"}
--- Hexadecimal would be:
---   luatools.digits(x, {0,1,2,3,4,5,6,7,8,9,"A","B","C","D","E","F"})
--- NUMBER is supposed to be a non-negative integer.
-function luatools.digits(number, base)
-  -- Check arguments and calculate fullbase and exponent
-  if type(number) ~= "number" then
-    error("digits: First argument not a number ("..type(number).." instead).")
-  end
-  if (type(base) ~= "number") and (type(base) ~= "table") then
-    error("digits: Second argument not valid type ("..type(base)..").")
-  end
-  if (number < 0) or (number ~= math.ceil(number)) then
-    error("digits: First argument out of range ("..number..").")
-  end
-  local fullbase = {}
-  local exponent = 0
-  if type(base) == "number" then
-    if (base < 2) or (base ~= math.ceil(base)) then
-      error("digits: Second argument out of range ("..base..").")
-    end
-    for j = 1, base do
-      table.insert(fullbase, j - 1)
-    end
-  else -- type(base) == "table"
-    if table.getn(base) < 2 then
-      error("digits: Second argument has not enough elements.")
-    end
-    fullbase = base
-  end
-  exponent = table.getn(fullbase)
-  -- Decompose NUMBER
-  local remains = number
-  local result = {}
-  while remains > 0 do
-    local d = luatools.mod(remains, exponent)
-    table.insert(result, fullbase[d + 1])
-    remains = (remains - d) / exponent
-    if remains ~= math.ceil(remains) then
-      error("digits: Internal error during calculation (remains = "..remains..").")
-    end
-  end
-  return result
-end
-
--- Return a table of all combinations of DEPTH entries,
--- each of which is chosen from DIGITS.
--- Example: luatools.combinations(3, {7, 8, "a"}) will return
---   { {7,7,7}, {7,7,8}, {7,7,"a"}, {7,8,7}, {7,8,8}, {7,8,"a"},
---     {7,"a",7}, {7,"a",8}, {7,"a","a"}, {8,7,7}, ... }
--- Mathematically, it builds the leafs of an #DIGITS-ary tree
--- of depth DEPTH.
-function luatools.combinations(depth, digits)
-  local all_combinations = {{}}
-  local digs = digits
-  if (type(depth) ~= "number") or (depth < 1) or (depth ~= math.floor(depth)) then
-    error("combinations: First argument (depth) not a number or out of range.")
-  end
-  if type(digits) == "number" then
-    if (digits < 1) or (digits ~= math.floor(digits)) then
-      error("combinations: Second argument (digits) out of range.")
-    end
-    digs = {}
-    for j = 1, digits do
-      digs[j] = j
-    end
-  end
-  if type(digs) ~= "table" then
-    error("combinations: Second argument (digits) should be number or table.")
-  end
-  for _ = 1, depth do
-    local next_step = {}
-    for _, old_combination in pairs(all_combinations) do
-      for _, new_digit in pairs(digs) do
-        local new_combination = luatools.deep_copy(old_combination)
-        table.insert(new_combination, new_digit)
-        table.insert(next, new_combination)
-      end
-    end
-    all_combinations = next_step
-  end
-  return all_combinations
-end
-
--- cubic_polynomial returns the result of the
--- following polynomial with coefficients in A:
--- a[10]*y*y*y + a[9]*x*y*y + a[8]*x*x*y + a[7]*x*x*x
---   + a[6]*y*y + a[5]*x*y + a[4]*x*x + a[3]*y + a[2]*x + a[1]
--- You can use luatools.random_vector(10, ...) and
--- a modulo operation to easily form a random
--- pattern of a floor, or choose the coefficients
--- to your own liking. Entries in A which are not
--- numbers are considered zero.
-function luatools.cubic_polynomial(a, x, y)
-  if type(a) ~= "table" then
-    error("cubic_polynomial: First argument not a table (" .. type(a)
-          .. " instead).")
-  end
-  if (type(x) ~= "number") or (type(y) ~= "number") then
-    error("cubic_polynomial: Second or third argument not a number.")
-  end
-  return   (a[10] or 0)*y*y*y + (a[9] or 0)*x*y*y + (a[8] or 0)*x*x*y
-         + (a[7] or 0)*x*x*x + (a[6] or 0)*y*y + (a[5] or 0)*x*y
-         + (a[4] or 0)*x*x + (a[3] or 0)*y + (a[2] or 0)*x + (a[1] or 0)
-end
-
----------------------------------------------------------------------
---  PERMUTATIONS  AND  RANDOM  NUMBERS
----------------------------------------------------------------------
-
--- Return a random permutation of n elements.
--- This function outputs a table with integer entries between
--- 1 and n at positions 1 to n.
-function luatools.permutation(n)
-  if type(n) ~= "number" then
-    error("permutation: Expected number, got "..type(n).."!")
-  end
-  if (n < 1) or (n ~= math.floor(n)) then
-    error("permutation: Argument must be positive integer.")
-  end
-  local sequence = {}
-  for j = 1, n do
-    table.insert(sequence, j)
-  end
-  luatools.shuffle_table(sequence)
-  return sequence
-end
-
--- Return a random cyclic permutation (i.e. with only one cycle) of n elements.
-function luatools.cyclic_permutation(n)  
-  if type(n) ~= "number" then
-    error("cyclic_permutation: Expected number, got "..type(n).."!")
-  end
-  local sequence1 = luatools.permutation(n)
-  local sequence2 = {}
-  for j = 1, n - 1 do
-    sequence2[sequence1[j]] = sequence1[j+1]
-  end
-  sequence2[sequence1[n]] = sequence1[1]
-  return sequence2
-end
-
--- Return a table with NUMBER random entries.
--- Additional arguments like with math.random.
-function luatools.random_vector(number, ...)
-  if type(number) ~= "number" then
-    error("random_vector: First argument not a number ("..type(number).." instead).")
-  end
-  if (number < 0) or (number ~= math.ceil(number)) then
-    error("random_vector: First argument out of range ("..number..").")
-  end
-  local result = {}
-  for j = 1, number do
-    result[j] = math.random(...)
-  end
-  return result
-end
-
-    ]]></el:luamain>
-    <el:i18n>
-    </el:i18n>
-  </el:protected>
-</el:level>
-

Modified: trunk/data/levels/lib/libmap.xml
===================================================================
--- trunk/data/levels/lib/libmap.xml	2008-08-23 12:20:31 UTC (rev 1283)
+++ trunk/data/levels/lib/libmap.xml	2008-08-23 16:58:35 UTC (rev 1284)
@@ -131,7 +131,7 @@
   for y = 1, new_h do
     result[y] = ""
     for x = 1, new_w do
-      result[y] = result[y] .. map[rot({x - 1, y - 1})]
+      result[y] = result[y] .. map[rot(x - 1, y - 1)]
     end
   end
   return wo:newMap(map.defaultkey, result)  
@@ -431,7 +431,8 @@
           end
           local line_width = string.len(entry) / kl
           if line_width ~= math.floor(line_width) then
-            error("newMap: Line " .. key .. " doesn't fit to key length.", 2)
+            error("newMap: Line " .. key .. " doesn't fit to key length ("
+                  .. kl .. ").", 2)
           end
           width = math.max(width, line_width)
           newmap[key] = entry

Added: trunk/data/levels/lib/libmath.xml
===================================================================
--- trunk/data/levels/lib/libmath.xml	2008-08-23 12:20:31 UTC (rev 1283)
+++ trunk/data/levels/lib/libmath.xml	2008-08-23 16:58:35 UTC (rev 1284)
@@ -0,0 +1,253 @@
+<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
+<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
+  <el:protected>
+    <el:info el:type="library">
+      <el:identity el:title="" el:id="lib/libmath"/>
+      <el:version el:score="1" el:release="1" el:revision="4" el:status="released"/>
+      <el:author  el:name="Enigma Team" el:email="" el:homepage=""/>
+      <el:copyright>Copyright ? 2007, 2008 Enigma Team</el:copyright>
+      <el:license el:type="GPL v2.0 or above" el:open="true"/>
+      <el:compatibility el:enigma="1.10">
+      </el:compatibility>
+      <el:modes el:easy="false" el:single="false" el:network="false"/>
+      <el:comments>
+      </el:comments>
+      <el:score el:easy="-" el:difficult="-"/>
+    </el:info>
+    <el:luamain><![CDATA[
+
+---------------------------------------------------------------------
+-- libmath includes mathematical and functions and algorithms
+-- of various origins.
+---------------------------------------------------------------------
+--
+-- libmath provides the following functions:
+--   lib.math.manhattan_distance(x1, y1, x2, y2)
+--   lib.math.digits(number, base)
+--   lib.math.combinations(depth, digits)
+--   lib.math.cubic_polynomial(a, x, y)
+--   lib.math.permutation(n)
+--   lib.math.cyclic_permutation(n)  
+--   lib.math.random_vector(number, ...)
+-- Additional mathematically relevant functions are part of liblua:
+--   lib.lua.mod(value, modul)
+--   lib.lua.cond(condition, iftrue, iffalse)
+--
+
+lib.math = {}
+setmetatable(lib.math, getmetatable(lib))
+
+---------------------------------------------------------------------
+--  ADVANCED  POSITION  HANDLING  AND  CALCULATIONS
+---------------------------------------------------------------------
+
+-- manhattan_distance calculates the Manhattan-distance between
+-- (X1,Y1) and (X2, Y2), which is |X1 - X2| + |Y1 - Y2|.
+-- If X2 and Y2 are nil, X1 and Y1 are assumed to be positions
+-- instead of coordinates.
+function lib.math.manhattan_distance(x1, y1, x2, y2)
+  if x1 and y1 and x2 and y2 then
+    -- x1, y1, x2, y2 are coordinates
+    return math.abs(x1 - x2) + math.abs(y1 - y2)
+  end
+  if x1 and y1 then
+    -- x1 and y1 are positions, possibly tables.
+    local p1 = x1
+    local p2 = y1
+    if type(p1) == "table" then
+      p1 = po(p1)
+    end
+    if type(p2) == "table" then
+      p2 = po(p2)
+    end
+    return math.abs(p1.x - p2.x) + math.abs(p1.y - p2.y)
+  end
+  error("manhattan_distance: Too less arguments.", 2)
+end
+
+---------------------------------------------------------------------
+--  MATHEMATICAL  FUNCTIONS
+---------------------------------------------------------------------
+
+-- digits returns a table whose elements are the digits of NUMBER
+-- in base BASE. BASE can be a number (e.g. 3 to get ternary)
+-- as well as a table (then the table entries with numerical
+-- keys will be used as digits).
+-- Examples:
+--   lib.math.digits(13, 2) = {1, 0, 1, 1}
+--   lib.math.digits(15, 16) = {15}
+--   lib.math.digits(17, 3) = {2, 2, 1}
+--   lib.math.digits(17, {2, "b", 5}) = {5, 5, "b"}
+-- Hexadecimal would be:
+--   lib.math.digits(x, {0,1,2,3,4,5,6,7,8,9,"A","B","C","D","E","F"})
+-- NUMBER is supposed to be a non-negative integer.
+function lib.math.digits(number, base)
+  -- Check arguments and calculate fullbase and exponent
+  if type(number) ~= "number" then
+    error("digits: First argument not a number ("..type(number).." instead).", 2)
+  end
+  if (type(base) ~= "number") and (type(base) ~= "table") then
+    error("digits: Second argument not valid type ("..type(base)..").", 2)
+  end
+  if (number < 0) or (number ~= math.ceil(number)) then
+    error("digits: First argument out of range ("..number..").", 2)
+  end
+  local fullbase = {}
+  local exponent = 0
+  if type(base) == "number" then
+    if (base < 2) or (base ~= math.ceil(base)) then
+      error("digits: Second argument out of range ("..base..").", 2)
+    end
+    for j = 1, base do
+      table.insert(fullbase, j - 1)
+    end
+  else -- type(base) == "table"
+    if table.getn(base) < 2 then
+      error("digits: Second argument has not enough elements.", 2)
+    end
+    fullbase = base
+  end
+  exponent = table.getn(fullbase)
+  -- Decompose NUMBER
+  local remains = number
+  local result = {}
+  while remains > 0 do
+    local d = remains % exponent
+    table.insert(result, fullbase[d + 1])
+    remains = (remains - d) / exponent
+    if remains ~= math.ceil(remains) then
+      error("digits: Internal error during calculation (remains = "..remains..").", 2)
+    end
+  end
+  return result
+end
+
+-- Return a table of all combinations of DEPTH entries,
+-- each of which is chosen from DIGITS.
+-- Example: lib.math.combinations(3, {7, 8, "a"}) will return
+--   { {7,7,7}, {7,7,8}, {7,7,"a"}, {7,8,7}, {7,8,8}, {7,8,"a"},
+--     {7,"a",7}, {7,"a",8}, {7,"a","a"}, {8,7,7}, ... }
+-- Mathematically, it builds the leafs of an #DIGITS-ary tree
+-- of depth DEPTH. Note that liblua has to be loaded to use
+-- lib.math.combinations.
+function lib.math.combinations(depth, digits)
+  if not lib.lua then
+    error("combinations: Please include the library liblua to use lib.math.combinations.", 2)
+  end
+  local all_combinations = {{}}
+  local digs = digits
+  if (type(depth) ~= "number") or (depth < 1) or (depth ~= math.floor(depth)) then
+    error("combinations: First argument (depth) not a number or out of range.", 2)
+  end
+  if type(digits) == "number" then
+    if (digits < 1) or (digits ~= math.floor(digits)) then
+      error("combinations: Second argument (digits) out of range.", 2)
+    end
+    digs = {}
+    for j = 1, digits do
+      digs[j] = j
+    end
+  end
+  if type(digs) ~= "table" then
+    error("combinations: Second argument (digits) should be number or table.", 2)
+  end
+  for _ = 1, depth do
+    local next_step = {}
+    for _, old_combination in pairs(all_combinations) do
+      for _, new_digit in pairs(digs) do
+        local new_combination = lib.lua.deep_copy(old_combination)
+        table.insert(new_combination, new_digit)
+        table.insert(next, new_combination)
+      end
+    end
+    all_combinations = next_step
+  end
+  return all_combinations
+end
+
+-- cubic_polynomial returns the result of the
+-- following polynomial with coefficients in A:
+-- a[10]*y*y*y + a[9]*x*y*y + a[8]*x*x*y + a[7]*x*x*x
+--   + a[6]*y*y + a[5]*x*y + a[4]*x*x + a[3]*y + a[2]*x + a[1]
+-- You can use lib.math.random_vector(10, ...) and
+-- a modulo operation to easily form a random
+-- pattern of a floor, or choose the coefficients
+-- to your own liking. Entries in A which are not
+-- numbers are considered zero.
+function lib.math.cubic_polynomial(a, x, y)
+  if type(a) ~= "table" then
+    error("cubic_polynomial: First argument not a table (" .. type(a)
+          .. " instead).", 2)
+  end
+  if (type(x) ~= "number") or (type(y) ~= "number") then
+    error("cubic_polynomial: Second or third argument not a number.", 2)
+  end
+  return   (a[10] or 0)*y*y*y + (a[9] or 0)*x*y*y + (a[8] or 0)*x*x*y
+         + (a[7] or 0)*x*x*x + (a[6] or 0)*y*y + (a[5] or 0)*x*y
+         + (a[4] or 0)*x*x + (a[3] or 0)*y + (a[2] or 0)*x + (a[1] or 0)
+end
+
+---------------------------------------------------------------------
+--  PERMUTATIONS  AND  RANDOM  NUMBERS
+---------------------------------------------------------------------
+
+-- Return a random permutation of n elements.
+-- This function outputs a table with integer entries between
+-- 1 and n at positions 1 to n.
+function lib.math.permutation(n)
+  if type(n) ~= "number" then
+    error("permutation: Expected number, got "..type(n).."!", 2)
+  end
+  if (n < 1) or (n ~= math.floor(n)) then
+    error("permutation: Argument must be positive integer.", 2)
+  end
+  if n == 1 then
+    return {1}
+  end
+  local sequence = {}
+  for j = 1, n do
+    table.insert(sequence, j)
+  end
+  for n = table.getn(sequence), 2, -1 do
+    local m = math.random(n)
+    sequence[n], sequence[m] = sequence[m], sequence[n]
+  end
+  return sequence
+end
+
+-- Return a random cyclic permutation (i.e. with only one cycle) of n elements.
+function lib.math.cyclic_permutation(n)  
+  if type(n) ~= "number" then
+    error("cyclic_permutation: Expected number, got "..type(n).."!", 2)
+  end
+  local sequence1 = lib.math.permutation(n)
+  local sequence2 = {}
+  for j = 1, n - 1 do
+    sequence2[sequence1[j]] = sequence1[j+1]
+  end
+  sequence2[sequence1[n]] = sequence1[1]
+  return sequence2
+end
+
+-- Return a table with NUMBER random entries.
+-- Additional arguments like with math.random.
+function lib.math.random_vector(number, ...)
+  if type(number) ~= "number" then
+    error("random_vector: First argument not a number ("..type(number).." instead).", 2)
+  end
+  if (number < 0) or (number ~= math.ceil(number)) then
+    error("random_vector: First argument out of range ("..number..").", 2)
+  end
+  local result = {}
+  for j = 1, number do
+    result[j] = math.random(...)
+  end
+  return result
+end
+
+    ]]></el:luamain>
+    <el:i18n>
+    </el:i18n>
+  </el:protected>
+</el:level>
+

Modified: trunk/data/levels/lib/libsoko-endphase.xml
===================================================================
--- trunk/data/levels/lib/libsoko-endphase.xml	2008-08-23 12:20:31 UTC (rev 1283)
+++ trunk/data/levels/lib/libsoko-endphase.xml	2008-08-23 16:58:35 UTC (rev 1284)
@@ -74,7 +74,7 @@
   -- ensure a correctly set endphase-attribute
   local endp = sokoarea[nr].design.endp
   if not endp then
-    sokoarea[nr].design.endp = luatools.deep_copy(default_design.endp)
+    sokoarea[nr].design.endp = lib.lua.deep_copy(default_design.endp)
     endp = sokoarea[nr].design.endp
   end
   if type(endp) ~= "table" then
@@ -83,7 +83,7 @@
   end
   local alg = endp.alg
   if alg == nil then
-    sokoarea[nr].design.endp.alg = luatools.deep_copy(default_design.endp.alg)
+    sokoarea[nr].design.endp.alg = lib.lua.deep_copy(default_design.endp.alg)
     alg = endp.alg
   end
   if type(alg) ~= "string" then
@@ -131,7 +131,7 @@
 function endphase(sokoarea_number)
   -- Correct structure of endp-attribute has been checked
   -- by prepare_endphase, we trust it blindly.
-  local endp = luatools.deep_copy(sokoarea[sokoarea_number].design.endp)
+  local endp = lib.lua.deep_copy(sokoarea[sokoarea_number].design.endp)
   local alg = endp.alg
   local param = ""
   local px, py = enigma.GetPos(enigma.GetNamedObject("marble_"..sokoarea_number.."_1"))
@@ -150,7 +150,7 @@
 
   -- redraw level and give items
   endphase_redraw_level_array(sokoarea_number)
-  local give = luatools.deep_copy(endp.give)
+  local give = lib.lua.deep_copy(endp.give)
   if type(give) == "string" then
     give = {give}
   end
@@ -210,7 +210,7 @@
 
 function endphase_redraw_level_array(sokoarea_number)
   local nr = sokoarea_number or 1
-  local endp = luatools.deep_copy(sokoarea[nr].design.endp)
+  local endp = lib.lua.deep_copy(sokoarea[nr].design.endp)
   local dx = sokoarea[nr].offset.x
   local dy = sokoarea[nr].offset.y
 
@@ -307,7 +307,7 @@
 
   -- Select all places outside or in the walls, unreachable
   -- for the marble.
-  for p, v in pairs(luatools.combine_tables(sokoarea[nr].list_outside,
+  for p, v in pairs(lib.lua.combine_tables(sokoarea[nr].list_outside,
                 sokoarea[nr].list_wall_two)) do
     if (mod(v.lx, 2) == 0) and (mod(v.ly, 2) == 0) then
       table.insert(places, v)
@@ -337,11 +337,11 @@
     end    
   end
 
-  luatools.shuffle_table(places)
+  lib.lua.shuffle_table(places)
 
   for j = 1, number_pairs do
-    set_oxyd(sokoarea_number, luatools.deep_copy(places[2*j-1]), flavor, j - 1)
-    set_oxyd(sokoarea_number, luatools.deep_copy(places[2*j]), flavor, j - 1)
+    set_oxyd(sokoarea_number, lib.lua.deep_copy(places[2*j-1]), flavor, j - 1)
+    set_oxyd(sokoarea_number, lib.lua.deep_copy(places[2*j]), flavor, j - 1)
   end
   oxyd_shuffle()
 end
@@ -362,10 +362,10 @@
       -- and no other oxyd or blocker is near the new oxyd or its
       -- blocker.
       for j, w in pairs(oxyds) do
-        if    (luatools.manhattan_distance(w.blocker.lx, w.blocker.ly, x, y) <= 1)
-           or (luatools.manhattan_distance(w.lx, w.ly, x, y) <= 1)
-           or (luatools.manhattan_distance(w.blocker.lx, w.blocker.ly, x-dx, y-dy) <= 1)
-           or (luatools.manhattan_distance(w.lx, w.ly, x-dx, y-dy) <= 1) then
+        if    (lib.math.manhattan_distance(w.blocker.lx, w.blocker.ly, x, y) <= 1)
+           or (lib.math.manhattan_distance(w.lx, w.ly, x, y) <= 1)
+           or (lib.math.manhattan_distance(w.blocker.lx, w.blocker.ly, x-dx, y-dy) <= 1)
+           or (lib.math.manhattan_distance(w.lx, w.ly, x-dx, y-dy) <= 1) then
           return false
         end
       end
@@ -404,11 +404,11 @@
     end    
   end
 
-  luatools.shuffle_table(oxyds)
+  lib.lua.shuffle_table(oxyds)
 
   -- set oxyds and blockers
   local function set_block(w)
-    local myblocker = luatools.deep_copy(blocker)
+    local myblocker = lib.lua.deep_copy(blocker)
     -- if there's an entry "st-door", choose between st-door-h and st-door-v.
     if type(myblocker) == "string" then
       myblocker = {myblocker}
@@ -425,11 +425,11 @@
     -- now set in-floor and blocker, and add to list_blocker.
     set_element(w.lx, w.ly, nr, "inf")
     set_element(w.lx, w.ly, nr, "", myblocker)
-    sokoarea[nr].list_blocker[(w.lx).."/"..(w.ly)] = luatools.deep_copy(w)
+    sokoarea[nr].list_blocker[(w.lx).."/"..(w.ly)] = lib.lua.deep_copy(w)
   end
   for j = 1, number_pairs do   -- Testlevel: 14
-    set_oxyd(nr, luatools.deep_copy(oxyds[2*j-1]), flavor, j - 1)
-    set_oxyd(nr, luatools.deep_copy(oxyds[2*j]), flavor, j - 1)
+    set_oxyd(nr, lib.lua.deep_copy(oxyds[2*j-1]), flavor, j - 1)
+    set_oxyd(nr, lib.lua.deep_copy(oxyds[2*j]), flavor, j - 1)
     set_block(oxyds[2*j-1].blocker)
     set_block(oxyds[2*j].blocker)
   end
@@ -442,7 +442,7 @@
   for p, v in pairs(sokoarea[nr].list_goal) do
     table.insert(goal_table, v)
   end
-  luatools.shuffle_table(goal_table)
+  lib.lua.shuffle_table(goal_table)
   for j = 2, math.min(table.getn(goal_table), table.getn(oxyds)) do
     sokoarea[nr].goal_to_blocker[goal_table[j].goal_number] = oxyds[j].blocker
   end
@@ -459,7 +459,7 @@
     table.insert(places, v)
   end
 
-  luatools.shuffle_table(places)
+  lib.lua.shuffle_table(places)
   
   -- choose number of oxyds
   local max = table.getn(places)
@@ -508,7 +508,7 @@
     end
   end
 
-  luatools.shuffle_table(places)
+  lib.lua.shuffle_table(places)
 
   -- choose number of magnets
   local number_magnets = math.floor(table.getn(places)/6)
@@ -529,7 +529,7 @@
     table.insert(places, v)
   end
 
-  luatools.shuffle_table(places)
+  lib.lua.shuffle_table(places)
 
   -- choose number of fourswitchs/oxyds
   local max = table.getn(places)
@@ -552,7 +552,7 @@
     places[j].correct = false
   end
   places.number_pairs = number_pairs
-  sokoarea[sokoarea_number].places = luatools.deep_copy(places)
+  sokoarea[sokoarea_number].places = lib.lua.deep_copy(places)
 end
 
 function endphase_call_fourswitch(onoff, sender)
@@ -661,13 +661,13 @@
     local it = enigma.GetItem(x, y)
     local fl = enigma.GetFloor(x, y)
     if st and enigma.GetAttrib(st, "_sokoarea") then
-      SendMessage(st, luatools.cond(open, "open", "close"))
+      SendMessage(st, lib.lua.cond(open, "open", "close"))
     end
     if it and enigma.GetAttrib(it, "_sokoarea") then
-      SendMessage(it, luatools.cond(open, "open", "close"))
+      SendMessage(it, lib.lua.cond(open, "open", "close"))
     end
     if fl then
-      SendMessage(fl, luatools.cond(open, "close", "open"))
+      SendMessage(fl, lib.lua.cond(open, "close", "open"))
     end
   end  
 end
@@ -675,7 +675,7 @@
 function endphase_vortex(sokoarea_number)
   local nr = sokoarea_number or 1
   local list_way = 
-    luatools.combine_tables(sokoarea[nr].list_way, sokoarea[nr].list_blocker)
+    lib.lua.combine_tables(sokoarea[nr].list_way, sokoarea[nr].list_blocker)
   local components = 0
   local component = {}
 
@@ -737,7 +737,7 @@
       table.insert(u, component[j])
     end
   end
-  luatools.shuffle_table(u)
+  lib.lua.shuffle_table(u)
   while (table.getn(t) < 5) and (table.getn(u) > 0) do
     table.insert(t, u[table.getn(u)])
     table.remove(u)
@@ -754,7 +754,7 @@
   
   -- Find a cyclic permutation (i.e. with only one cycle) to connect the
   -- vortices (each vortex shall be reached by starting from any other).
-  local connect = luatools.cyclic_permutation(components)
+  local connect = lib.math.cyclic_permutation(components)
 
   -- Now set and connect the vortices
   for j, v in pairs(vortex) do
@@ -782,7 +782,7 @@
     table.insert(places, v)
   end
 
-  luatools.shuffle_table(places)
+  lib.lua.shuffle_table(places)
   
   -- set items (for Enigma 1.0), set attributes of door (>= 1.1)
   for j, v in pairs(places) do
@@ -792,16 +792,16 @@
     if st then
       enigma.SetAttrib(st, "action", "callback")
       enigma.SetAttrib(st, "target", "endphase_call_knocking")
-      local closepos = places[luatools.mod(j, table.getn(places)) + 1]
-      local openpos = places[luatools.mod(j+1, table.getn(places)) + 1]
+      local closepos = places[lib.lua.mod(j, table.getn(places)) + 1]
+      local openpos = places[lib.lua.mod(j+1, table.getn(places)) + 1]
       enigma.SetAttrib(st, "_close_x", closepos.lx)
       enigma.SetAttrib(st, "_close_y", closepos.ly)
       enigma.SetAttrib(st, "_open_x", openpos.lx)
       enigma.SetAttrib(st, "_open_y", openpos.ly)
       --enigma.SetAttrib(st, "_close",
-      --  luatools.deep_copy(places[luatools.mod(j+1, table.getn(places)) + 1]))
+      --  lib.lua.deep_copy(places[lib.lua.mod(j+1, table.getn(places)) + 1]))
       --enigma.SetAttrib(st, "_open",
-      --  luatools.deep_copy(places[luatools.mod(j+2, table.getn(places)) + 1]))
+      --  lib.lua.deep_copy(places[lib.lua.mod(j+2, table.getn(places)) + 1]))
     end
   end
 end

Modified: trunk/data/levels/lib/libsoko.xml
===================================================================
--- trunk/data/levels/lib/libsoko.xml	2008-08-23 12:20:31 UTC (rev 1283)
+++ trunk/data/levels/lib/libsoko.xml	2008-08-23 16:58:35 UTC (rev 1284)
@@ -8,7 +8,8 @@
       <el:copyright>Copyright ? 2007 Enigma Team</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
       <el:compatibility el:enigma="1.00">
-        <el:dependency el:path="lib/libluatools" el:id="lib/libluatools" el:release="1" el:preload="true"/>
+        <el:dependency el:path="lib/liblua" el:id="lib/liblua" el:release="1" el:preload="true"/>
+        <el:dependency el:path="lib/libmath" el:id="lib/libmath" el:release="1" el:preload="true"/>
         <el:dependency el:path="lib/libsoko-designlist" el:id="lib/libsoko-designlist" el:release="1" el:preload="true"/>
         <el:dependency el:path="lib/libsoko-endphase" el:id="lib/libsoko-endphase" el:release="1" el:preload="true"/>
       </el:compatibility>
@@ -137,7 +138,7 @@
 -- set_oxyd sets an oxyd with given flavor and color and adds
 -- the neccessary entry to list_oxyd.
 function set_oxyd(sokoarea_number, list_entry, flavor, color)
-  local entry = luatools.deep_copy(list_entry)
+  local entry = lib.lua.deep_copy(list_entry)
   entry.flavor = flavor
   entry.color = color
   oxyd(entry.lx, entry.ly, flavor, color)
@@ -824,16 +825,16 @@
   -- choose design
   local design = {}
   if type(design_description) == "number" then
-    design = luatools.deep_copy(design_list[design_description])
+    design = lib.lua.deep_copy(design_list[design_description])
   elseif type(design_description) == "table" then
-    design = luatools.deep_copy(design_description)
+    design = lib.lua.deep_copy(design_description)
   elseif (type(design_description) == "nil") and (type(level_array) == "table") then
-    design = luatools.deep_copy(design_from_level(level_array, maxdesignnumber))
+    design = lib.lua.deep_copy(design_from_level(level_array, maxdesignnumber))
   else
     myerror("Can't make sense of design type "..type(design)..".")
   end
   -- fill chosen design with default values where neccessary
-  design = luatools.combine_tables({design, default_design})
+  design = lib.lua.combine_tables({design, default_design})
   -- No stone set for outf, not even "st-none"?
   -- Use the default outf-stone instead, and remove it on endphase.
   if type(design.outf) ~= "table" then



From andreasl at mail.berlios.de  Sat Aug 23 22:04:21 2008
From: andreasl at mail.berlios.de (andreasl at mail.berlios.de)
Date: Sat, 23 Aug 2008 22:04:21 +0200
Subject: [Enigma-game-svn] r1285 - trunk/doc/reference
Message-ID: <200808232004.m7NK4Le9024759@sheep.berlios.de>

Author: andreasl
Date: 2008-08-23 22:04:18 +0200 (Sat, 23 Aug 2008)
New Revision: 1285

Modified:
   trunk/doc/reference/enigma-ref.texi
Log:
Trunk:
 - Add chapter "Libraries" to refman, current sections:
    - liblua (complete)
    - libmath (complete)
    - libmap (complete)
    - libsoko (empty)
 - Adapt example "Wired" after splitting of libluatools.
 - Adapt subsection about "drawMap".
Todo:
 - Section about libsoko.
 - Possibly a full example for the first three libraries
   (mabye "Fashions Pass"?)


Modified: trunk/doc/reference/enigma-ref.texi
===================================================================
--- trunk/doc/reference/enigma-ref.texi	2008-08-23 16:58:35 UTC (rev 1284)
+++ trunk/doc/reference/enigma-ref.texi	2008-08-23 20:04:18 UTC (rev 1285)
@@ -38,6 +38,7 @@
 * Stone Objects::
 * Actor Objects::
 * Other Objects::               Rubberbands, etc.
+* Libraries::                   Advanced tools
 * Advanced Features::           Fire, ...
 * Extension Development::       Resolver, Library Development
 * Old API - Objects::           Description of all objects in Enigma
@@ -1338,7 +1339,7 @@
 * Internationalization (i18n)::
 * Usage::
 * Update and Upgrade::
-* Libraries::
+* Using Libraries::
 @end menu
 
 @node Getting Started with Levels
@@ -2554,15 +2555,15 @@
 use this element for the same purpose, with the same syntax, without modifying the author's
 protected section.
 
- at node Libraries
- at section Libraries
+ at node Using Libraries
+ at section Using Libraries
 
 Libraries are collections of Lua functions for reuse in many levels. To use a library, you must
-declare it as an dependency, as described in @ref{<compatibility>}. Preloading the library is all
+declare it as a dependency, as described in @ref{<compatibility>}. Preloading the library is all
 you have to do to use the library. Otherwise, you can use the function @ref{enigma.LoadLib} to
 load the library at a certain point of execution.
 
-Enigma provides several very useful libraries. You will find them on the system
+Enigma provides several very useful @ref{Libraries}. You will find them on the system
 path in the subdirectory @samp{levels/lib}. Most of them are documented in-line.
 You will find a separate documentation file
 @samp{doc/ant_lua.txt} for @samp{ant}.
@@ -4595,7 +4596,7 @@
 
 @example
 01	  <el:compatibility el:enigma="1.10">
-02	    <el:dependency el:path="lib/libluatools" el:id="lib/libluatools" el:release="1" el:preload="true"/>
+02	    <el:dependency el:path="lib/libmath" el:id="lib/libmath" el:release="1" el:preload="true"/>
 03	  </el:compatibility>
 ...
 04    @i{ti}["@var{ }"] = @{"@b{fl-sahara}", @b{friction} = @var{3.5}, @b{adhesion} = @var{4.0}@}
@@ -4614,11 +4615,11 @@
 17    @i{ti}["@var{S}"] = @{"@b{st_switch}", @b{target} = "@var{easy_mode_call}"@}
 18    
 19    @var{floors}  = @{@i{ti}["@var{ }"], @i{ti}["@var{a}"], @i{ti}["@var{b}"], @i{ti}["@var{c}"]@}
-20    @var{polynom} = @i{luatools}. at i{random_vector}(@var{10}, @var{4})
+20    @var{polynom} = @i{lib}. at i{math}. at i{random_vector}(@var{10}, @var{4})
 21    
 22    function @var{myresolver}(@var{key}, @var{x}, @var{y})
 23      if @var{key} == "@var{ }" then 
-24	  return @var{floors}[@i{luatools}. at i{cubic_polynomial}(@var{polynom}, @var{x}, @var{y}) % (#@var{floors}) + @var{1}]
+24	  return @var{floors}[@i{lib}. at i{math}. at i{cubic_polynomial}(@var{polynom}, @var{x}, @var{y}) % (#@var{floors}) + @var{1}]
 25      elseif    (@var{key} == "@var{#}")
 26            or ((@var{key} == "@var{_}") and (@i{random}(@var{4}) == @var{1}))
 27            or ((@var{key} == "@var{S}") and @i{wo}["@b{IsDifficult}"]) then
@@ -4645,8 +4646,8 @@
 48       "@var{####################___________________}"
 49    @})
 50    
-51    @var{door_p} = @i{luatools}. at i{permutation}(@var{12})
-52    @var{wire_p} = @i{luatools}. at i{permutation}(@var{12})
+51    @var{door_p} = @i{lib}. at i{math}. at i{permutation}(@var{12})
+52    @var{wire_p} = @i{lib}. at i{math}. at i{permutation}(@var{12})
 53    @var{woods} = @i{no}["@var{wood}#*"]
 54    @var{triggers} = @i{no}["@var{trigger}#*"]
 55    @var{doors} = @i{no}["@var{door}#*"]
@@ -4682,11 +4683,11 @@
 
 @example
 01	  <el:compatibility el:enigma="1.10">
-02	    <el:dependency el:path="lib/libluatools" el:id="lib/libluatools" el:release="1" el:preload="true"/>
+02	    <el:dependency el:path="lib/libmath" el:id="lib/libmath" el:release="1" el:preload="true"/>
 03	  </el:compatibility>
 @end example
-We make use of some functions of the luatools library. Thus we need to preload it, 
-besides declaration of compatibility to Enigma 1.10.
+We make use of some functions of the @ref{libmath} library. Thus we need to
+preload it, besides declaration of compatibility to Enigma 1.10.
 
 @example
 04    @i{ti}["@var{ }"] = @{"@b{fl-sahara}", @b{friction} = @var{3.5}, @b{adhesion} = @var{4.0}@}
@@ -4731,7 +4732,7 @@
 
 @example
 19    @var{floors}  = @{@i{ti}["@var{ }"], @i{ti}["@var{a}"], @i{ti}["@var{b}"], @i{ti}["@var{c}"]@}
-20    @var{polynom} = @i{luatools}. at i{random_vector}(@var{10}, @var{4})
+20    @var{polynom} = @i{lib}. at i{math}. at i{random_vector}(@var{10}, @var{4})
 @end example
 Preparations for the floor design. The four floor tiles are stored in a table
 for number based index access. Ten random numbers in the range 1 to 4 are
@@ -4749,7 +4750,7 @@
 
 @example
 23      if @var{key} == "@var{ }" then 
-24	  return @var{floors}[@i{luatools}. at i{cubic_polynomial}(@var{polynom}, @var{x}, @var{y}) % (#@var{floors}) + @var{1}]
+24	  return @var{floors}[@i{lib}. at i{math}. at i{cubic_polynomial}(@var{polynom}, @var{x}, @var{y}) % (#@var{floors}) + @var{1}]
 @end example
 These two lines generate the always changing floor design. For every map key
 @samp{ } we calculate the cubic polynomial that is randomized due to the
@@ -4798,11 +4799,11 @@
 default floor is @samp{ }, too.
 
 @example
-51    @var{door_p} = @i{luatools}. at i{permutation}(@var{12})
-52    @var{wire_p} = @i{luatools}. at i{permutation}(@var{12})
+51    @var{door_p} = @i{lib}. at i{math}. at i{permutation}(@var{12})
+52    @var{wire_p} = @i{lib}. at i{math}. at i{permutation}(@var{12})
 @end example
 Now let us shuffle the trigger/door assignment and the wire distribution. We
-do this by permutating 12 index numbers to be used for door and wire access.
+do this by permuting 12 index numbers to be used for door and wire access.
 
 @example
 53    @var{woods} = @i{no}["@var{wood}#*"]
@@ -9082,6 +9083,962 @@
 @menu
 @end menu
 
+ at c ===================  Libraries  =======================
+
+ at node Libraries
+ at chapter Libraries
+
+ at menu
+* liblua::       General methods for tables.
+* libmath::      Mathematical algorithms, like random permutations.
+* libmap::       Methods for API 2-maps.
+* libsoko::      A library to interpret Sokoban level files.
+ at end menu
+
+ at node liblua
+ at section liblua
+
+ at menu
+* lib.lua.combine_tables::  Collect entries of anonymous Lua-tables into a common table.
+* lib.lua.cond::            A wrapper for if.
+* lib.lua.deep_copy::       Complete copies of Lua-tables.
+* lib.lua.mod::             A modulo operation.
+* lib.lua.print_table::     Print tables for debug reasons.
+* lib.lua.shuffle_table::   Shuffle arbitrary anonymous Lua-tables.
+ at end menu
+
+ at c ----------------- combine_tables -------------------- 
+
+ at node lib.lua.combine_tables
+ at subsection lib.lua.combine_tables
+
+ at samp{combine_tables} combines all entries of a set or table of tables into one
+common table (i.e., it joins the subtables). As some of the subtables can have
+equally named entries, the first subtable has highest priority, the second
+subtable second priority etc.
+
+ at table @asis
+ at item @b{Syntax:}
+ at b{lib.lua.combine_tables}(@i{overtable})
+
+ at b{lib.lua.combine_tables}(@i{table1}, @i{table2}, ...)
+
+ at table @asis
+ at item @i{overtable}
+A table of tables: @samp{overtable = @{table1, table2, ...@}}
+
+ at item @i{table1}, @i{table2}, ...
+Lua tables to be joined.
+ at end table
+
+ at item @b{Syntax Samples:}
+ at example
+all_contacts = lib.lua.combine_tables(telephon_numbers, email_addresses)
+ at end example
+
+ at item @b{Details:}
+Just as groups can be joined by @samp{grp1 + grp2}, it can sometimes be
+neccessary to join anonymous tables, as well. 
+In most situations, object grouping should be used instead, but when one works
+with more abstract data (like names of objects instead of objects, or tables
+holding design informations), @samp{combine_tables} can be useful.
+
+ at item @b{Full Example:}
+ at example
+ at end example
+ at end table
+
+ at c ----------------- cond -------------------- 
+
+ at node lib.lua.cond
+ at subsection lib.lua.cond
+
+ at samp{lib.lua.cond} is a conditional assignment, a ternary operator very
+similar (but not equal to) the @samp{?:}-expression in C-like languages. Note
+however, that there are caveats, see details.
+
+ at table @asis
+ at item @b{Syntax:}
+ at b{lib.lua.cond}(@i{condition}, @i{iftrue}, @i{iffalse})
+
+ at table @asis
+ at item @i{condition}
+A boolean expression.
+
+ at item @i{iftrue}
+The expression to be returned if @samp{condition} is true.
+
+ at item @i{iffalse}
+The expression to be returned if @samp{condition} is false.
+ at end table
+
+ at item @b{Syntax Samples:}
+ at example
+lib.lua.cond(wo["IsDifficult"], @{"st_death"@}, ti["#"])
+ at end example
+
+ at item @b{Details:}
+ at samp{lib.lua.cond} evaluates both expressions @samp{iftrue} and
+ at samp{iffalse}, regargless of @samp{condition}. Hence,
+ at example
+lib.lua.cond(t == 0, 1/t, error("Division by zero"))
+ at end example
+will always raise an error: All sideeffects will happen.
+Another example which will not work:
+ at example
+w,h = lib.lua.cond(wo["IsDifficult"], wo(ti, " ", map1), wo(ti, " ", map2))
+ at end example
+Use this instead:
+ at example
+w,h = wo(ti, " ", lib.lua.cond(wo["IsDifficult"], map1, map2))
+ at end example
+However, in most cases @samp{lib.lua.cond} is used with static expressions for
+ at samp{iftrue} and @samp{iffalse} (e.g. strings or variables), when no
+sideeffects are possible.
+
+ at item @b{Full Example:}
+ at example
+ at end example
+ at end table
+
+ at c ----------------- deep_copy -------------------- 
+
+ at node lib.lua.deep_copy
+ at subsection lib.lua.deep_copy
+
+ at samp{deep_copy} returns a copy of its argument, where table entries are
+not copied as memory references (like Lua typically does), but complete
+(thereby called "deep copy").
+
+ at table @asis
+ at item @b{Syntax:}
+ at b{lib.lua.deep_copy}(@i{source})
+
+ at table @asis
+ at item @i{source}
+The object to be copied.
+ at end table
+
+ at item @b{Syntax Samples:}
+ at example
+a = @{5@}
+b = a
+c = lib.lua.deep_copy(a)
+b[1] = 4
+ at end example
+
+After these four commands, @samp{a[1]} and @samp{b[1]} will both be @samp{4},
+but @samp{c[1]} will still be @samp{5}.
+
+ at item @b{Details:}
+Metatables are transfered, but not deep-copied.
+Userdata (like tiles and positions) is not guaranteed to be deep-copied.
+
+ at item @b{Full Example:}
+ at example
+ at end example
+ at end table
+
+ at c ----------------- mod -------------------- 
+
+ at node lib.lua.mod
+ at subsection lib.lua.mod
+
+A wrapper for the modulo operation.
+
+ at table @asis
+ at item @b{Syntax:}
+ at b{lib.lua.mod}(@i{value}, @i{modul})
+
+ at table @asis
+ at item @i{value}, @i{modul}
+Numbers. @samp{modul} must be positive (non-zero).
+ at end table
+
+ at item @b{Syntax Samples:}
+ at example
+lib.lua.mod(7*7, 17)
+lib.lua.mod(5.3, 1/3)
+lib.lua.mod(no["marble"].x, 1)
+ at end example
+
+ at item @b{Details:}
+Lua 5.0 uses @samp{math.mod} as modulo operation, Lua 5.1 provides @samp{%} and
+ at samp{math.fmod}. Whereas all three operations agree on positive numbers and
+zero as @samp{value}, there are differences on negative numbers:
+ at example
+math.mod(-1, 4) == -1
+math.fmod(-1, 4) == -1
+(-1)%4 == 3
+lib.lua.mod(-1, 4) == 3
+ at end example
+While the Lua-own modulo functions yield results even for negative
+ at samp{modul} (with varying signs of the outcome), @samp{lib.lua.mod} will raise
+an error if @samp{modul <= 0}, and the result @samp{r} is otherwise guaranteed
+to be @samp{0 <= r < modul}.
+
+ at item @b{Full Example:}
+ at example
+ at end example
+ at end table
+
+ at c ----------------- print_table -------------------- 
+
+ at node lib.lua.print_table
+ at subsection lib.lua.print_table
+
+ at samp{print_table} is a debug command, which uses the API's @samp{print}
+command to recursively print its argument to the standard output.
+
+ at table @asis
+ at item @b{Syntax:}
+ at b{lib.lua.print_table}(@i{table}, @i{prefix}, @i{depth})
+
+ at table @asis
+ at item @i{table}
+The table to be printed.
+
+ at item @i{prefix}
+A string which will be printed before the table as a
+separator. Can be @samp{nil}.
+
+ at item @i{depth}
+ at samp{nil} in normal use, @samp{-1} if you want to suppress the recursion.
+ at end table
+
+ at item @b{Syntax Samples:}
+ at example
+a = @{1, 5=2, "Hello", other_table = @{x = 4, y = 5, z = "World"@}@}
+lib.lua.print_table(a, nil, -1)
+lib.lua.print_table(a, "--> ")
+ at end example
+
+ at item @b{Details:}
+ at samp{print_table} is recursive, i.e. a table with table
+as entries will call @samp{print_table} again. To avoid
+infinite loops, @samp{depth} is used internally to count
+the depth level of the recursion. The recursion currently
+stops on depth 5. Set @samp{depth} to @samp{-1} to stop
+recursion entirely.
+
+Use @samp{print_table} only for debugging and testing, it
+is not meant as an element of gameplay.
+ at item @b{Full Example:}
+ at example
+ at end example
+ at end table
+
+ at c ----------------- shuffle_table -------------------- 
+
+ at node lib.lua.shuffle_table
+ at subsection lib.lua.shuffle_table
+
+ at samp{shuffle_table} randomly resorts its argument.
+
+ at table @asis
+ at item @b{Syntax:}
+ at b{lib.lua.shuffle_table}(@i{source})
+
+ at table @asis
+ at item @i{source}
+The table to be shuffled.
+ at end table
+
+ at item @b{Syntax Samples:}
+ at example
+a = @{1, 2, 3, "r", @{"x", "y", "z"@}, 4@}
+lib.lua.shuffle_table(a)
+ at end example
+
+A typical result for @samp{a} would be
+ at example
+a = @{"r", 4, 2, @{"x", "y", "z"@}, 1, 3@}
+ at end example
+
+ at item @b{Details:}
+The result is a permutation of the original table. The permutation restricts to
+those entries with numerical keys, and of those only the ones between @samp{1}
+and @samp{table.getn(@i{source})}. @samp{shuffle_table} has no return value.
+
+ at item @b{Full Example:}
+ at example
+ at end example
+ at end table
+
+
+ at node libmath
+ at section libmath
+
+ at menu
+* lib.math.combinations::       Calculates all possible combinations of a set.
+* lib.math.cubic_polynomial::   Calculates the result of a cubic polynomial.
+* lib.math.cyclic_permutation:: Random cyclic permutation.
+* lib.math.digits::             Decomposes a number into digits for an arbitrary base.
+* lib.math.manhattan_distance:: Calculates the Manhattan distance of positions.
+* lib.math.permutation::        Random permutation.
+* lib.math.random_vector::      A table with random entries.
+ at end menu
+
+ at c ----------------- combinations -------------------- 
+
+ at node lib.math.combinations
+ at subsection lib.math.combinations
+
+ at samp{lib.math.combinations} returns a table of all combinations of
+ at samp{depth} entries, each of which is chosen from @samp{digits}.
+
+ at table @asis
+ at item @b{Syntax:}
+ at b{lib.math.combinations}(@i{depth}, @i{digits})
+
+ at table @asis
+ at item @i{depth}
+A positive integer.
+
+ at item @i{digits}
+A positive integer or a table with numerical entries.
+ at end table
+
+ at item @b{Syntax Samples:}
+ at example
+lib.math.combinations(2, 2)
+ == @{ @{1, 1@}, @{1, 2@}, @{2, 1@}, @{2, 2@} @}
+lib.math.combinations(3, @{7, 8, "a"@})
+ == @{ @{7,7,7@}, @{7,7,8@}, @{7,7,"a"@},
+       @{7,8,7@}, @{7,8,8@}, @{7,8,"a"@},
+       @{7,"a",7@}, @{7,"a",8@}, @{7,"a","a"@},
+       @{8,7,7@}, ... @}
+ at end example
+
+ at item @b{Details:}
+Mathematically, it builds the leafs of an @samp{#digits}-ary tree
+of depth @samp{depth}.
+
+ at item @b{Full Example:}
+ at example
+ at end example
+ at end table
+
+ at c ----------------- cubic_polynomial -------------------- 
+
+ at node lib.math.cubic_polynomial
+ at subsection lib.math.cubic_polynomial
+
+ at samp{cubic_polynomial} returns the result of the following polynomial with
+coefficients in @samp{a}:
+ at example
+a[10]*y*y*y + a[9]*x*y*y + a[8]*x*x*y + a[7]*x*x*x
+  + a[6]*y*y + a[5]*x*y + a[4]*x*x + a[3]*y + a[2]*x + a[1]
+ at end example
+
+ at table @asis
+ at item @b{Syntax:}
+ at b{lib.math.cubic_polynomial}(@i{a}, @i{x}, @i{y})
+
+ at table @asis
+ at item @i{a}
+A table with numerical entries @samp{a[1]} to @samp{a[10]}. The entries may be
+ at samp{nil} (i.e. missing), then they are interpreted as zero.
+
+ at item @i{x}, @i{y}
+Numbers.
+
+ at end table
+
+ at item @b{Syntax Samples:}
+ at example
+lib.math.cubic_polynomial(@{1, a, b@}, x, y) == a*x + b*y
+ at end example
+
+ at item @b{Details:}
+You can use @samp{lib.math.random_vector(10, ...)} and a modulo operation to
+easily form a random pattern of a floor, or choose the coefficients to your own
+liking. Entries in A which are not numbers are considered zero.
+
+ at item @b{Full Example:}
+This is an excerpt from "Wired" and demonstrates the use of
+ at samp{cubic_polynomial} inside a custom resolver to create random, but
+patternlike floors:
+ at example
+[...]
+floors = @{ti[" "], ti["a"], ti["b"], ti["c"]@}
+polynom = lib.math.random_vector(10, 4)
+
+function myresolver(key, x, y)
+  if key == " " then  
+    return floors[lib.math.cubic_polynomial(a, x, y) % (#floors) + 1]
+  elseif
+    [...]
+  else
+    return ti[key]
+  end
+end
+
+w, h = wo(myresolver, " ", @{
+[...]
+ at end example
+"Wired" is explained in detail in section @ref{Wired}.
+ at end table
+
+ at c ----------------- cyclic_permutation -------------------- 
+
+ at node lib.math.cyclic_permutation
+ at subsection lib.math.cyclic_permutation
+
+ at samp{cyclic_permutation} returns a random permutation (i.e. a random shuffling)
+of the numbers 1 to @samp{n}, which is cyclic: There exists a closed path from
+any number to any other number (see details below).
+
+ at table @asis
+ at item @b{Syntax:}
+ at b{lib.math.cyclic_permutation}(@i{n})
+
+ at table @asis
+ at item @i{n}
+A positive integer.
+ at end table
+
+ at item @b{Syntax Samples:}
+ at example
+lib.math.cyclic_permutation(#no["marbles#*"])
+ at end example
+
+ at item @b{Details:}
+A cyclic permutation is a special kind of permutation, which has only one
+cycle. The easiest way is to give an example for a cyclic permutation:
+ at example
+8, 1, 2, 9, 3, 7, 4, 6, 10, 5
+ at end example
+We may write this as:
+ at example
+1 -> 8
+2 -> 1
+3 -> 2
+...
+ at end example
+We can now put all of these together into a sequence:
+ at example
+1 -> 8 -> 6 -> 7 -> 4 -> 9 -> 10 -> 5 -> 3 -> 2 -> 1
+ at end example
+This is, the sequence creates a single cycle through all 10 numbers.
+This is not always possible with a general permutation.
+
+If you need a fixpoint-free permutation, you might choose to use a cyclic
+permutation instead, although not every fixpoint-free permutation is cyclic.
+
+ at item @b{Full Example:}
+If you want to connect an arbitrary number of meditation marbles with
+rubberbands in a cyclic manner, but otherwise randomly, you can use
+ at samp{lib.math.cyclic_permutation}:
+ at example
+marbles = no["marbles#*"]
+p = lib.math.cyclic_permutation(#marbles)
+
+for j = 1, #marbles do
+  wo:add(@{"ot_rubberband", anchor1 = marbles[j], anchor2 = marbles[p[j]]@})
+end
+ at end example
+If you want to connect them in a linear way, you can either remove a step in
+the loop:
+ at example
+[...]
+for j = 1, #marbles - 1 do
+[...]
+ at end example
+or use @samp{lib.math.permutation} in the following way:
+ at example
+marbles = no["marbles#*"]
+p = lib.math.permutation(#marbles)
+
+for j = 1, #marbles - 1 do
+  wo:add(@{"ot_rubberband", anchor1 = marbles[p[j]], anchor2 = marbles[p[j+1]]@})
+end
+ at end example
+ at end table
+
+ at c ----------------- digits -------------------- 
+
+ at node lib.math.digits
+ at subsection lib.math.digits
+
+ at samp{lib.math.digits} returns a table whose elements are the digits of
+ at samp{number} in base @samp{base}. @samp{base} can be a positive integer (e.g.
+3 to get ternary) as well as a table (then the table entries with numerical
+keys will be used as digits).
+
+ at table @asis
+ at item @b{Syntax:}
+ at b{lib.math.digits}(@i{number}, @i{base})
+
+ at table @asis
+ at item @i{number}
+A non-negative integer.
+
+ at item @i{base}
+A positive integer other than 1, or a table with numerical keys.
+
+ at end table
+
+ at item @b{Syntax Samples:}
+ at example
+lib.math.digits(13, 2) == @{1, 0, 1, 1@}
+lib.math.digits(15, 16) == @{15@}
+lib.math.digits(17, 3) == @{2, 2, 1@}
+lib.math.digits(17, @{2, "b", 5@}) == @{5, 5, "b"@}
+ at end example
+
+The following function can be used to get a table with hexadecimal entries:
+ at example
+lib.math.digits(x, @{0,1,2,3,4,5,6,7,8,9,"A","B","C","D","E","F"@})
+ at end example
+
+ at item @b{Details:}
+
+ at item @b{Full Example:}
+ at example
+ at end example
+ at end table
+
+ at c ----------------- manhattan_distance -------------------- 
+
+ at node lib.math.manhattan_distance
+ at subsection lib.math.manhattan_distance
+
+ at samp{manhattan_distance} calculates the Manhattan distance between two
+positions @samp{pos1} and @samp{pos2}, which is 
+ at example
+|pos1.x - pos2.x| + |pos1.y - pos2.y|.
+ at end example
+
+ at table @asis
+ at item @b{Syntax:}
+ at b{lib.math.manhattan_distance}(@i{pos1}, @i{pos2})
+
+ at b{lib.math.manhattan_distance}(@i{x1}, @i{y1}, @i{x2}, @i{y2})
+
+ at table @asis
+ at item @i{pos1}, @i{pos2}
+Positions (e.g. object references or tables @samp{@{posx, posy@}}.
+
+ at item @i{x1}, @i{y1}, @i{x2}, @i{y2}
+Coordinates of the positions @samp{pos1} and @samp{pos2}, respectively.
+ at end table
+
+ at item @b{Syntax Samples:}
+ at example
+lib.math.manhattan_distance(4, 5, 3, 3)
+lib.math.manhattan_distance(@{4, 5@}, @{3, 3@})
+lib.math.manhattan_distance(no["marble"], no["othermarble"])
+ at end example
+
+ at item @b{Details:}
+The Manhattan distance counts the minimal number of pushes neccessary to push a
+wood stone from one position to another. Its unit balls are squares with the
+diagonals parallel to the x- and y-axis (rhombi).
+
+ at item @b{Full Example:}
+ at example
+ at end example
+ at end table
+
+ at c ----------------- permutation -------------------- 
+
+ at node lib.math.permutation
+ at subsection lib.math.permutation
+
+ at samp{permutation} returns a random permutation (i.e. a random shuffling) of the
+numbers 1 to @samp{n}.
+
+ at table @asis
+ at item @b{Syntax:}
+ at b{lib.math.permutation}(@i{n})
+
+ at table @asis
+ at item @i{n}
+A positive integer.
+ at end table
+
+ at item @b{Syntax Samples:}
+ at example
+lib.math.permutation(#no["doors#*"])
+ at end example
+
+ at item @b{Details:}
+Permutations give a simple way to randomize a level, e.g. by changing the
+assignment of action/target-pairs ("Which trigger to which door?").
+
+ at item @b{Full Example:}
+ at example
+ at end example
+ at end table
+
+ at c ----------------- random_vector -------------------- 
+
+ at node lib.math.random_vector
+ at subsection lib.math.random_vector
+
+ at samp{random_vector} returns a table of @samp{n} random entries.
+
+ at table @asis
+ at item @b{Syntax:}
+ at b{lib.math.random_vector}(@i{n}, @i{...})
+
+ at table @asis
+ at item @i{n}
+A non-negative integer.
+
+ at item @i{...}
+Further arguments, which are the same as for @samp{math.random}: Either no
+further arguments, then the random numbers will be float values in
+ at samp{[0,1)}, or with one additional number @samp{p}, then the random numbers
+will be integers between 1 and @samp{p} (both included), or two additional
+numbers @samp{p, q}, then the random numbers will be integers between @samp{p}
+and @samp{q} (both included).
+ at end table
+
+ at item @b{Syntax Samples:}
+ at example
+lib.math.random_vector(4, 3)
+ at end example
+will return a table of 4 random numbers out of @{1,2,3@}, and
+ at example
+lib.math.random_vector(22)
+ at end example
+returns a table of 22 float values between 0.0 and 1.0 (excluding 1.0).
+
+ at item @b{Details:}
+ at samp{random_vector} can be used in conjunction with @samp{cubic_polynomial} to
+create random patterns, see @ref{lib.math.cubic_polynomial} and @ref{Wired}.
+
+ at item @b{Full Example:}
+ at example
+ at end example
+ at end table
+  
+
+ at node libmap
+ at section libmap
+
+ at samp{libmap} gives the author more possibilities to work with API 2-maps. Up
+to now, a map just is a table of strings, as described in @ref{World Creation
+and Resolver Chaining}. With @samp{libmap}, you can utilize maps in a more
+advanced way.
+
+ at menu
+* Creating Maps::
+* Drawing Maps::
+* Rotating and Mirroring Maps::
+* Requesting and Changing Single Map Entries::
+* Connecting Two Maps::
+* Other Map Tasks::
+ at end menu
+
+ at c ----------------- Creating Maps -------------------- 
+
+ at node Creating Maps
+ at subsection Creating Maps
+
+We start by defining a table of strings representing the level we want to
+write in a two-dimensional array of tile keys:
+
+ at example
+mypremap = @{"# # # # # # # ",
+            "o t1  #   t2o ",
+            "#     #     # ",
+            "#     d2d1# # ",
+            "# @@1#     @@2# ",
+            "# # #     t1# ",
+            "o   d3    t3o ",
+            "# # # # # # # "@}
+ at end example
+
+To not get confused with names, in this section we'll call such a table of
+strings a 'premap'. We create a map (in the sense of libmap) by applying
+ at samp{wo:newMap} to it, with a default key and the premap as arguments:
+ at example
+mymap = wo:newMap("  ", mypremap)
+ at end example
+The default key is saved in @samp{mymap} as well, it's part of a map.
+
+You can use
+ at example
+mymap = wo:newMap(key, height, width)
+ at end example
+to define map of size @samp{height*width}, where every tile key is @samp{key},
+and the default key is set to @samp{key} as well. You might even omit
+ at samp{height} and @samp{width}, then you create a map consisting of only one
+character.
+
+ at c ----------------- Drawing Maps -------------------- 
+
+ at node Drawing Maps
+ at subsection Drawing Maps
+
+Just as we could've used the premap with @samp{wo} or @samp{wo:drawMap} to draw
+it (see @ref{drawMap}), we can use the newly created map as well:
+ at example
+wo(resolver, mymap)
+wo:drawMap(resolver, anchor, mymap)
+wo:drawMap(resolver, anchor, ignore, mymap)
+ at end example
+When the @samp{ignore}-attribute for @samp{drawMap} is omitted, the default key
+of @samp{mymap} is used instead.
+
+Of course you can draw the map multiple times, even from within a resolver, see
+ at ref{drawMap} for a full example.
+
+ at c ----------------- Rotating and Mirroring Maps -------------------- 
+
+ at node Rotating and Mirroring Maps
+ at subsection Rotating and Mirroring Maps
+
+We can transform a single map simply by using one of the following commands:
+ at example
+newmap = lib.map.transform(mymap, operation)
+newmap = mymap ^ operation
+ at end example
+ at samp{operation} can be any of the following constants:
+ at table @asis
+ at item @samp{MAP_IDENT}
+No transformation.
+ at item @samp{MAP_ROT_CW}
+Rotate 90 degrees clockwise.
+ at item @samp{MAP_ROT_180}
+Rotate 180 degrees (i.e. a point reflection around the midpoint)
+ at item @samp{MAP_ROT_CCW}
+Rotate 90 degrees counter-clockwise.
+ at item @samp{MAP_MIRROR_HORIZONTAL}
+Mirror along a vertical axis, i.e. left and right are swapped.
+ at item @samp{MAP_MIRROR_VERTICAL}
+Mirror along a horizontal axis, i.e. up and down are swapped.
+ at item @samp{MAP_MIRROR_SLASH}
+Mirror along the diagonal from upper-left to lower-right corner.
+ at item @samp{MAP_MIRROR_BACKSLASH}
+Mirror along the diagonal from upper-right to lower-left corner.
+ at end table
+The mirror-constants might seem inverse to their meaning, however it's meant in
+the following sense: @samp{MAP_MIRROR_HORIZONTAL} flips left and right, i.e. the
+reflection is done in horizontal direction, with a vertical axis.
+
+When you want to perform two transformations after each other, remember that
+neither
+ at example
+newmap = mymap ^ operation1 ^ operation2
+ at end example
+nor
+ at example
+newmap = mymap ^ (operation1 * operation2)
+ at end example
+will work. The correct syntax is:
+ at example
+newmap = (mymap ^ operation1) ^ operation2
+ at end example
+
+ at c ----------------- Requesting and Changing Single Map Entries -------------------- 
+
+ at node Requesting and Changing Single Map Entries
+ at subsection Requesting and Changing Single Map Entries
+
+Let's take a look at our example again:
+ at example
+mymap = wo:newMap("  ", @{"# # # # # # # ",
+                         "o t1  #   t2o ",
+                         "#     #     # ",
+                         "#     d2d1# # ",
+                         "# @@1#     @@2# ",
+                         "# # #     t1# ",
+                         "o   d3    t3o ",
+                         "# # # # # # # "@})
+ at end example
+It's easy to check, what kind of tile key is at position @code{@{1,1@}} (note
+that the upper left corner is at position @code{@{0,0@}}):
+ at example
+mymap[@{1, 1@}] == "t1"
+ at end example
+It's similarly easy to change it. Let's say, we want to create a passage
+one tile right beside the second marble @samp{@@2}, which is named
+ at samp{marble2}:
+ at example
+mymap[no["marble2"] + @{1,0@}]
+ at end example
+Note that the reference to @samp{marble2} only works after the marble has been
+set.
+
+ at c ----------------- Connecting Two Maps -------------------- 
+
+ at node Connecting Two Maps
+ at subsection Connecting Two Maps
+
+Given two maps @samp{map1} and @samp{map2}, we can glue them together
+horizontally by @samp{map1 .. map2} as well as vertically with @samp{map1 +
+map2}. Missing entries will be filled with the default key of the respective
+map, the default key of the result will be the one of @samp{map1}. A simple
+example:
+ at example
+map1 = wo:newMap(" ", @{"####",
+                        "o  #",
+                        "# w#",
+                        "####"@})
+map2 = wo:newMap(".", @{"#######",
+                        "#w.#..#",
+                        "#..D..#",
+                        "#..#.w#",
+                        "#######"@})
+map1 .. map2 == wo:newMap(" ", @{"###########",
+                                "o  ##w.#..#",
+                                "# w##..D..#",
+                                "#####..#.w#",
+                                "    #######"@})
+map2 .. map1 == wo:newMap(".", @{"###########",
+                                "#w.#..#o  #",
+                                "#..D..## w#",
+                                "#..#.w#####",
+                                "#######    "@})
+map1 + map2 == wo:newMap(" ", @{"####   ",
+                               "o  #   ",
+                               "# w#   ",
+                               "####   ",
+                               "#######",
+                               "#w.#..#",
+                               "#..D..#",
+                               "#..#.w#",
+                               "#######"@})
+ at end example
+
+It's also possible to paste a map into another map:
+ at example
+map1:paste(map2, pos)
+ at end example
+will paste @samp{map2} into @samp{map1} at position @samp{pos} (relative to
+ at samp{map1}: @code{@{0,0@}} is the upper left edge). If neccessary, @samp{map1}
+will be extended such that the whole of @samp{map2} fits into it. You can use
+ at samp{map1.sub} to reduce its size again (see below) as well as to define
+ at samp{map2} as a section of another map. During the pasting, any occurence of
+the default key of @samp{map2} will be ignored, i.e. not drawn onto
+ at samp{map1}. You can change the default key with @samp{map2.defaultkey = ...}
+prior to the paste command to circumvent this, or use
+ at samp{map2.replace(tile)} to replace more tile keys by the default key, such
+that they are not drawn as well. You can use an object group for @samp{pos}, in
+this case several copies of @samp{map2} will be pasted into @samp{map1}. There
+is no guarantee about the sequence in which the maps will be pasted into
+ at samp{map1}.
+
+However, there's a fourth possibility: Two maps may represent two different
+parts of tile keys. Let's give an example to fuse two tile key layers:
+ at example
+first_char = wo:newMap(".", @{"#######",
+                             "#w.#..#",
+                             "#..D..#",
+                             "#..#.w#",
+                             "#######"@})
+last_char  = wo:newMap(".", @{"C     C",
+                             " 11 22 ",
+                             " 11322 ",
+                             " 11 22 ",
+                             "C     C"@})
+first_char * last_char = wo:newMap(" .", @{"#C# # # # # #C",
+                                          "# w1.1# .2.2# ",
+                                          "# .1.1D3.2.2# ",
+                                          "# .1.1# .2w2# ",
+                                          "#C# # # # # #C"@})
+ at end example
+The default key of the fused map is the concatenation of the two original
+default keys. You can use a string instead of any of the two maps, in this case
+the whole tile key layer will consist of this string everywhere:
+ at example
+first_char = wo:newMap(".", @{"#######",
+                             "#w.#..#",
+                             "#..D..#",
+                             "#..#.w#",
+                             "#######"@})
+first_char * "u" = wo:newMap(" u", @{"#u#u#u#u#u#u#u",
+                                    "#uwu.u#u.u.u#u",
+                                    "#u.u.uDu.u.u#u",
+                                    "#u.u.u#u.uwu#u",
+                                    "#u#u#u#u#u#u#u"@})
+
+ at end example
+Fusing maps can be a mighty technique in combination with the
+ at ref{res.composer}- and @ref{res.autotile}-resolvers.
+
+ at c ----------------- Other Map Tasks -------------------- 
+
+ at node Other Map Tasks
+ at subsection Other Map Tasks
+
+You can access the default key of a map by @samp{mymap.defaultkey}, and change
+it just as easily:
+ at example
+mymap.defaultkey = ".3"
+mymap:set_default_key(".3")
+ at end example
+The new default key should have the same length as the old one. However, it is
+possible to choose a new key length as long as it fits to the map.
+
+You can replace any occurence of a tile key @samp{tile1} by @samp{tile2} simply
+by
+ at example
+mymap:replace(tile1, tile2)
+ at end example
+You can omit @samp{tile2}, then any occurence of @samp{tile1} will be replaced
+by the default key.
+
+Width and height of a map can be accessed via @samp{mymap.width} and
+ at samp{mymap.height}. However, these values can be changed only through the
+following commands @samp{mymap:extend} and @samp{mymap:sub}.
+
+It's possible to extend a map to a given position, as long as both
+coordinates are non-negative:
+ at example
+mymap:extend(@{19, 12@})
+ at end example
+will extend @samp{mymap} up to position @samp{@{19,12@}}. Missing entries will
+be filled with the default key. If the map already covers this position, no
+change will be done.
+
+ at samp{lib.map.sub} allows you to copy a rectangular area of a map and create a
+"submap" this way. @samp{lib.map.sub} uses the same syntax as
+ at samp{wo:drawRect}, i.e. either
+ at example
+submap = mymap:sub(pos1, pos2)
+ at end example
+with @samp{pos1} being the top left-hand corner and @samp{pos2} the bottom
+right-hand corner, or alternatively
+ at example
+submap = mymap:sub(pos1, width, height)
+ at end example
+to define the rectangle by its top left-hand corner and the side lengths of its
+area. If the bottom right-hand corner overlaps the area of @samp{mymap}, the
+resulting @samp{submap} will still be just the rectangular section of
+ at samp{mymap}, i.e. width and height can be less than the arguments specified.
+Use @samp{submap:extend(width, height)} to ensure the full width and height.
+The default key of the submap of course is the default key of the original map.
+
+If you want to check whether a position @samp{pos} lies inside a map, you can
+use @samp{mymap:covers(pos)}, which returns a boolean value. Note that a map
+always starts in @samp{@{0,0@}}.
+
+Finally, you can use @samp{mymap:print()} to print @samp{mymap} to standard
+output. Similar to @ref{lib.lua.print_table}, this is useful for debugging a
+level by taking a look at its maps, but should not appear in the final level.
+ at samp{mymap:print()} allows several optional arguments:
+ at example
+mymap:print(withXYCounts, left_separator, right_separator)
+ at end example
+If @samp{withXYCounts} is @samp{true}, the map is printed with coordinates on
+the top and on the left. @samp{left_separator} and @samp{right_separator} can
+be strings to be put between the left coordinate axis and the map, and behind
+the map (to analyse space characters).
+
+ at node libsoko
+ at section libsoko
+
+ at menu
+* lib.soko.create::
+* lib.soko.recreate::
+* lib.soko.draw::
+ at end menu
+
 @c ===================  Advanced Features  =======================
 
 @node Advanced Features
@@ -9184,8 +10141,10 @@
 @table @asis
 @item @b{Syntax:}
 
- at b{wo:drawMap}(@i{resolver}, @i{anchor}, @i{ignore}, @i{map})
+ at b{wo:drawMap}(@i{resolver}, @i{anchor}, @i{ignore}, @i{map}, [@i{readdir}])
 
+ at b{wo:drawMap}(@i{resolver}, @i{anchor}, @i{libmap-map}, [@i{readdir}])
+
 @table @asis
 @item @i{subresolver}
 Resolver to which unresolved requests should be forwarded. May be @samp{ti}
@@ -9197,12 +10156,20 @@
 if it not used within the map.
 @item @i{map}
 A table of strings. Each string describes a row of tiles by its tile keys.
+ at item @i{libmap-map}
+If the map used is created via @ref{libmap}, the @samp{ignore}-string can
+be omitted. The map's default key will then be ignored instead.
+ at item @i{readdir}
+An optional argument to modify the direction of the map relative to the world.
+This argument can be any of the constants described in @ref{Rotating and
+Mirroring Maps}.
 @end table
 
 @item @b{Syntax Samples:}
 @example
 wo:drawMap(ti, po(5, 7), "-", @{"abcabc"@})
 wo:drawMap(ti, anchor_object, "--", @{"--##--##","##--##"@})
+wo:drawMap(ti, {12, 5}, " ", @{"122  221"@}, MAP_ROT_CW)
 @end example
 
 @item @b{Details:}



From ral at mail.berlios.de  Sun Aug 24 00:54:47 2008
From: ral at mail.berlios.de (ral at BerliOS)
Date: Sun, 24 Aug 2008 00:54:47 +0200
Subject: [Enigma-game-svn] r1286 - in trunk: data data/levels/lib src
	src/stones
Message-ID: <200808232254.m7NMslwP009281@sheep.berlios.de>

Author: ral
Date: 2008-08-24 00:54:45 +0200 (Sun, 24 Aug 2008)
New Revision: 1286

Modified:
   trunk/data/api2init.lua
   trunk/data/levels/lib/ralf_sokoban.xml
   trunk/src/Object.cc
   trunk/src/lua.cc
   trunk/src/stones/PullStone.cc
   trunk/src/stones/SwapStone.cc
   trunk/src/stones/SwapStone.hh
Log:
Trunk 1.1: 
- group fix index access with foreign object instance
- swap/pull stone fix laser transparency during object exchange time -
  inherit transparency from exchanged object
- ralf_sokoban: fix door illegal attribute "type" usage on flavor a,b,c
- callback value fix for 1.01 compatibility: translation of "false" to 0
- api2 constants: correct directions to ENE, ESE, WSW, WNW

Modified: trunk/data/api2init.lua
===================================================================
--- trunk/data/api2init.lua	2008-08-23 20:04:18 UTC (rev 1285)
+++ trunk/data/api2init.lua	2008-08-23 22:54:45 UTC (rev 1286)
@@ -109,12 +109,12 @@
 
 -- multidirections as used by st_chess
 NNE = po(1, -2)
-NEE = po(2, -1)
-SEE = po(2, 1)
+ENE = po(2, -1)
+ESE = po(2, 1)
 SSE = po(1, 2)
 SSW = po(-1, 2)
-SWW = po(-2, 1)
-NWW = po(-2, -1)
+WSW = po(-2, 1)
+WNW = po(-2, -1)
 NNW = po(-2, -1)
 
 -- essential

Modified: trunk/data/levels/lib/ralf_sokoban.xml
===================================================================
--- trunk/data/levels/lib/ralf_sokoban.xml	2008-08-23 20:04:18 UTC (rev 1285)
+++ trunk/data/levels/lib/ralf_sokoban.xml	2008-08-23 22:54:45 UTC (rev 1286)
@@ -901,7 +901,8 @@
          if doorface == "st-blocker" then
            set_stone(doorface,xd,yd, {name="door"..doors})
          else
-           set_stone(doorface,xd,yd, {name="door"..doors, type=d})
+--           set_stone(doorface,xd,yd, {name="door"..doors, type=d})
+           set_stone(doorface,xd,yd, {name="door"..doors})
          end
       end
       oxyd(xo,yo)

Modified: trunk/src/Object.cc
===================================================================
--- trunk/src/Object.cc	2008-08-23 20:04:18 UTC (rev 1285)
+++ trunk/src/Object.cc	2008-08-23 22:54:45 UTC (rev 1286)
@@ -284,6 +284,10 @@
         Value messageValue = val;
         if (objFlags & OBJBIT_INVERSE)
             messageValue = invertActionValue(val);
+        
+        if (server::EnigmaCompatibility < 1.10) {
+            messageValue = messageValue.to_bool() ? 1 : 0; 
+        }
 
         TokenList targets = getAttr("target");
         TokenList actions = getAttr("action");

Modified: trunk/src/lua.cc
===================================================================
--- trunk/src/lua.cc	2008-08-23 20:04:18 UTC (rev 1285)
+++ trunk/src/lua.cc	2008-08-23 22:54:45 UTC (rev 1286)
@@ -2618,8 +2618,23 @@
         }
     } else {
         lua_getmetatable(L, 1);
-        lua_pushvalue(L, 2);   // copy last object as key
-        lua_rawget(L, -2);     // get last index        
+        lua_pushvalue(L, 2);   // copy object as key
+        lua_rawget(L, -2);     // get index
+        if (lua_isnil(L, -1)) {
+            // another copy of the object is used that results in another metatable hash,
+            // we need to compare with all objects (call it a workaround for a lua caveat or bad design)
+            Object *obj1 = to_object(L, 2);
+            int numObjects = lua_objlen(L, -2);
+            for (int i = 1; i <= numObjects; ++i) {
+                lua_rawgeti(L, -2, i);  // the object
+                Object *obj2 = to_object(L, -1);
+                lua_pop(L, 1);          // the object        
+                if (obj1 == obj2) {
+                    lua_pushinteger(L, i);
+                    break;
+                }
+            }            
+        }
     }
     return 1;
 }

Modified: trunk/src/stones/PullStone.cc
===================================================================
--- trunk/src/stones/PullStone.cc	2008-08-23 20:04:18 UTC (rev 1285)
+++ trunk/src/stones/PullStone.cc	2008-08-23 22:54:45 UTC (rev 1286)
@@ -65,7 +65,11 @@
     }
     
     bool PullStone::is_transparent(Direction d) const {
-        return true;
+        // a moving pull stone should be transparent just on of the two affected grids at each
+        // point of time. The vanishing part is the proxy of the other exchanged stone.
+        // Thus it inherits the transparency behaviour from it. 
+        return (state != VANISHING || 
+                (yieldedStone != NULL && yieldedStone->is_transparent(d))); 
     }
     
     void PullStone::on_impulse(const Impulse& impulse) {

Modified: trunk/src/stones/SwapStone.cc
===================================================================
--- trunk/src/stones/SwapStone.cc	2008-08-23 20:04:18 UTC (rev 1285)
+++ trunk/src/stones/SwapStone.cc	2008-08-23 22:54:45 UTC (rev 1286)
@@ -64,6 +64,13 @@
         return state == IDLE;
     }
     
+    bool SwapStone::is_transparent(Direction d) const {
+        // a moving swap stone should be intransparent just on of the two affected grids at each
+        // point of time. The vanishing part is the proxy of the other exchanged stone.
+        // Thus it inherits the transparency behaviour from it. 
+        return (state == VANISHING && 
+                (yieldedStone != NULL && yieldedStone->is_transparent(d))); 
+    }
     void SwapStone::on_impulse(const Impulse& impulse) {
         if (state != IDLE)
             return;

Modified: trunk/src/stones/SwapStone.hh
===================================================================
--- trunk/src/stones/SwapStone.hh	2008-08-23 20:04:18 UTC (rev 1285)
+++ trunk/src/stones/SwapStone.hh	2008-08-23 22:54:45 UTC (rev 1286)
@@ -57,6 +57,7 @@
         virtual bool is_floating() const;
         virtual bool is_sticky(const Actor *a) const;
         virtual bool is_removable() const;
+        virtual bool is_transparent(Direction d) const;
         virtual void on_impulse(const Impulse& impulse);
         
         // TimeHandler interface



From ral at mail.berlios.de  Sun Aug 24 13:59:44 2008
From: ral at mail.berlios.de (ral at BerliOS)
Date: Sun, 24 Aug 2008 13:59:44 +0200
Subject: [Enigma-game-svn] r1287 - in trunk: data data/schemas src src/items
	src/stones
Message-ID: <200808241159.m7OBxijO015835@sheep.berlios.de>

Author: ral
Date: 2008-08-24 13:59:42 +0200 (Sun, 24 Aug 2008)
New Revision: 1287

Added:
   trunk/src/items/SeedItem.cc
   trunk/src/items/SeedItem.hh
   trunk/src/stones/VolcanoStone.cc
   trunk/src/stones/VolcanoStone.hh
Modified:
   trunk/data/api1init.lua
   trunk/data/schemas/objects.xml
   trunk/src/Makefile.am
   trunk/src/items.cc
   trunk/src/items.hh
   trunk/src/items/ShogunDot.hh
   trunk/src/ox_magnum.cc
   trunk/src/ox_oxyd1.cc
   trunk/src/ox_peroxyd.cc
   trunk/src/stones.hh
   trunk/src/stones/BoulderStone.hh
   trunk/src/stones/ShogunStone.cc
   trunk/src/stones_complex.cc
   trunk/src/stones_simple.cc
   trunk/src/world.cc
   trunk/src/world.hh
Log:
Trunk 1.1: new API reengineering
- volcano:
  - rename to st_volcano, st_volcano_active
  - volcano now presses it_trigger
  - new attribute "secure" for guaranteed spreading
  - activity state attribute can be evaluated and set to active
- seed:
  - rename to it_seed, it_seed_volcano, it_seed_fake, it_seed_wood
  - attribute secure for st_volcano
  - complete identity transfer to resulting stone
  - activity state attribute can be evaluated and set to active


Modified: trunk/data/api1init.lua
===================================================================
--- trunk/data/api1init.lua	2008-08-23 22:54:45 UTC (rev 1286)
+++ trunk/data/api1init.lua	2008-08-24 11:59:42 UTC (rev 1287)
@@ -64,6 +64,9 @@
     it_magnet_on = "it-magnet-on",
     it_magnet_off = "it-magnet-off",
     it_rubberband = "it-rubberband",
+    it_seed = "it-seed",
+    it_seed_fake = "it-seed_nowood",
+    it_seed_volcano = "it-seed_volcano",
     it_shogun_s = "it-shogun-s",
     it_shogun_m = "it-shogun-m",
     it_shogun_l = "it-shogun-l",
@@ -219,6 +222,10 @@
     st_turnstilearm_e = "st-turnstile-e",
     st_turnstilearm_s = "st-turnstile-s",
     st_turnstilearm_w = "st-turnstile-w",
+    st_volcano = "st-volcano",
+    st_volcano_new = "st-volcano-growing",
+    st_volcano_active = "st-volcano_active",
+    st_volcano_inactive = "st-volcano_inactive",
     st_window = "st-window"
 }
 
@@ -675,7 +682,7 @@
     ["st-plain_hole__trigger"] = "signal",
     st_polarswitch__onoff = "toggle",
     st_switch__onoff = "toggle",
-    ["st-volcano__trigger"] = "toggle",
+    st_volcano__trigger = "toggle",
     ["st-white1__trigger"] = "signal",
     ["st-white2__trigger"] = "signal",
     ["st-white3__trigger"] = "signal",

Modified: trunk/data/schemas/objects.xml
===================================================================
--- trunk/data/schemas/objects.xml	2008-08-23 22:54:45 UTC (rev 1286)
+++ trunk/data/schemas/objects.xml	2008-08-24 11:59:42 UTC (rev 1287)
@@ -61,6 +61,7 @@
     <msg name="closeall" type="nil"/>
     <msg name="disconnect" type="nil"/>
     <msg name="flip" type="nil"/>
+    <msg name="grow" type="nil"/>
     <msg name="hit" type="object"/>
     <msg name="ignite" type="nil"/>
     <msg name="inner_pull" type="dir"/>
@@ -168,6 +169,21 @@
     <object name="it_magnet_on">
       <attr name="state" value="1"/>
     </object>
+    <object name="it_seed">
+      <attr name="flavor"/>
+      <attr name="secure"/>
+      <msg name="grow"/>
+      <msg name="signal"/>
+    </object>
+    <object name="it_seed_wood">
+      <attr name="flavor" value="wood"/>
+    </object>
+    <object name="it_seed_fake">
+      <attr name="flavor" value="fake"/>
+    </object>
+    <object name="it_seed_volcano">
+      <attr name="flavor" value="volcano"/>
+    </object>
     <object name="it_sensor">
       <attr name="invisible"/>
       <msg name="_glasses"/>
@@ -807,6 +823,10 @@
     <object name="st_turnstilearm_w">
       <attr name="state" value="0"/>
     </object>
+    <object name="st_volcano">
+      <attr name="secure"/>
+      <msg name="_trigger"/>
+    </object>
     <object name="st_window">
       <attr name="faces" default="s"/>
       <attr name="scratches"/>

Modified: trunk/src/Makefile.am
===================================================================
--- trunk/src/Makefile.am	2008-08-23 22:54:45 UTC (rev 1286)
+++ trunk/src/Makefile.am	2008-08-24 11:59:42 UTC (rev 1287)
@@ -203,6 +203,8 @@
 	items/GlassesItem.hh	\
 	items/Magnet.cc		\
 	items/Magnet.hh		\
+	items/SeedItem.cc	\
+	items/SeedItem.hh	\
 	items/Sensor.cc		\
 	items/Sensor.hh		\
 	items/ShogunDot.cc	\
@@ -281,6 +283,8 @@
 	stones/TimerStone.hh	\
 	stones/Turnstile.cc	\
 	stones/Turnstile.hh	\
+	stones/VolcanoStone.cc	\
+	stones/VolcanoStone.hh	\
 	stones/WindowStone.cc	\
 	stones/WindowStone.hh	\
 	stones/YieldingStone.cc	\

Added: trunk/src/items/SeedItem.cc
===================================================================
--- trunk/src/items/SeedItem.cc	2008-08-23 22:54:45 UTC (rev 1286)
+++ trunk/src/items/SeedItem.cc	2008-08-24 11:59:42 UTC (rev 1287)
@@ -0,0 +1,163 @@
+/*
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *  
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include "items/SeedItem.hh"
+#include "errors.hh"
+//#include "main.hh"
+#include "server.hh"
+#include "stones.hh"
+#include "world.hh"
+
+namespace enigma {
+
+    SeedItem::SeedItem(int flavor) {
+        objFlags |= flavor << 24;
+    }
+
+    std::string SeedItem::getClass() const {
+        return "it_seed";
+    }
+    
+    void SeedItem::setAttr(const string& key, const Value &val) {
+        if (key == "flavor") {
+            std::string flavor = val.to_string();
+            int code;
+            if (flavor == "wood") code = 0;
+            else if (flavor == "fake") code = 1;
+            else if (flavor == "volcano") code = 2;
+            else
+                ASSERT(false, XLevelRuntime, ecl::strf("Seed: illegal flavor value #s", flavor.c_str()).c_str());
+                
+            if (isDisplayable()) {
+                init_model();
+            }
+            return;
+        }
+        Item::setAttr(key, val);
+    }
+    
+    Value SeedItem::getAttr(const string &key) const {
+        if (key == "flavor") {
+            int flavor = (objFlags & OBJBIT_FLAVOR) >> 24;
+            switch (flavor) {
+                case 0 : return "wood"; break;
+                case 1 : return "fake"; break;
+                case 2 : return "volcano"; break;
+            }
+        } else
+            return Item::getAttr(key);
+    }
+    
+    Value SeedItem::message(const Message &m) {
+        if (m.message == "grow" || m.message == "signal") {
+            if (isDisplayable())
+                startGrowing();
+            return Value();
+        }
+        return Item::message(m);
+    }
+    
+    void SeedItem::setState(int extState) {
+        state = extState;
+        if (state == ACTIVE && isDisplayable())
+            startGrowing();
+        
+    }
+    
+    void SeedItem::init_model() {
+        if (state == IDLE)
+            set_model("it-seed");
+        else
+            set_anim("it-seed-growing");
+    }
+    
+    void SeedItem::processLight(Direction d) {
+        startGrowing();
+    }
+    
+    void SeedItem::animcb() {
+        GridPos p= get_pos();
+        int flavor = (objFlags & OBJBIT_FLAVOR) >> 24;
+        if ((server::GameCompatibility == GAMET_OXYDMAGNUM || server::GameCompatibility == GAMET_OXYD1) &&
+            (flavor == 0 && GetStone(p))) {
+            std::string model = GetStone(p)->get_kind();
+            if (model == "st-grate1") {
+                SetFloor(p, MakeFloor("fl-stwood"));
+                kill();
+                return;
+           }
+       }
+       Stone *st = MakeStone(flavor == 0 ? "st-wood-growing" : (flavor == 1 ? "st-greenbrown-growing" : "st_volcano_growing"));
+       transferIdentity(st);
+       if (Value v = getAttr("secure"))
+           st->setAttr("secure", v);
+       SetStone(p, st);
+       kill();
+    }
+    
+    std::string SeedItem::get_inventory_model() {
+        return "it-seed";
+    }
+    
+    bool SeedItem::isStatic() const {
+        return state == ACTIVE;  // active seed is static
+    }
+    
+    void SeedItem::on_drop(Actor *a) {
+        startGrowing();
+    }
+    
+    void SeedItem::on_stonehit(Stone *st) {
+        startGrowing();
+    }
+    
+    bool SeedItem::actor_hit(Actor *a) {
+        if (state == ACTIVE)
+            return false;   // do not pickup growing seed
+        return Item::actor_hit(a);
+    }
+
+    
+    void SeedItem::startGrowing() {
+        if (state == IDLE) {
+            state = ACTIVE;
+            sound_event("seedgrow");
+            set_anim("it-seed-growing");
+        }
+    }
+        
+    int SeedItem::traitsIdx() const {
+        return (objFlags & OBJBIT_FLAVOR) >> 24;  // access should be fast for traits radius access
+    }
+    
+
+    ItemTraits SeedItem::traits[3] = {
+        {"it_seed_wood", it_seed_wood, itf_static, 0.2},
+        {"it_seed_fake", it_seed_fake, itf_static, 0.2},
+        {"it_seed_volcano", it_seed_volcano, itf_static, 0.2}
+    };
+
+    BOOT_REGISTER_START
+        BootRegister(new SeedItem(0), "it_seed");
+        BootRegister(new SeedItem(0), "it_seed_wood");
+        BootRegister(new SeedItem(1), "it_seed_fake");
+        BootRegister(new SeedItem(2), "it_seed_volcano");
+    BOOT_REGISTER_END
+
+} // namespace enigma


Property changes on: trunk/src/items/SeedItem.cc
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/items/SeedItem.hh
===================================================================
--- trunk/src/items/SeedItem.hh	2008-08-23 22:54:45 UTC (rev 1286)
+++ trunk/src/items/SeedItem.hh	2008-08-24 11:59:42 UTC (rev 1287)
@@ -0,0 +1,75 @@
+/*
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef SEEDITEM_HH
+#define SEEDITEM_HH
+
+#include "items.hh"
+
+#include "enigma.hh"
+
+namespace enigma {
+    /**
+     */
+    class SeedItem : public Item {
+        CLONEOBJ(SeedItem);
+        DECL_ITEMTRAITS_ARRAY(3, traitsIdx());
+
+    private:
+        enum iState {
+            IDLE,     ///< inactive
+            ACTIVE    ///< activated
+        };
+        
+        enum ObjectPrivatFlagsBits {
+            OBJBIT_FLAVOR =   3<<24,   ///< wood, greenbrown, volcano seed
+        };
+    public:
+        SeedItem(int flavor);
+
+        // Object interface
+        virtual std::string getClass() const;
+        virtual void setAttr(const string& key, const Value &val);
+        virtual Value getAttr(const std::string &key) const;
+        virtual Value message(const Message &m);
+        
+        // StateObject interface
+        virtual void setState(int extState);
+
+        // GridObject interface
+        virtual void init_model();
+        virtual void processLight(Direction d);
+        
+        // ModelCallback interface
+        virtual void animcb();
+        
+        // ItemObject interface
+        virtual std::string get_inventory_model();
+        virtual bool isStatic() const;
+        virtual void on_drop(Actor *a);
+        virtual void on_stonehit(Stone *st);
+        virtual bool actor_hit(Actor *a);
+
+    private:
+        void startGrowing();
+        int traitsIdx() const;
+    };
+    
+} // namespace enigma
+
+#endif


Property changes on: trunk/src/items/SeedItem.hh
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/src/items/ShogunDot.hh
===================================================================
--- trunk/src/items/ShogunDot.hh	2008-08-23 22:54:45 UTC (rev 1286)
+++ trunk/src/items/ShogunDot.hh	2008-08-24 11:59:42 UTC (rev 1287)
@@ -48,12 +48,12 @@
         virtual Value getAttr(const std::string &key) const;
         virtual Value message(const Message &m);
 
+        // StateObject interface
+        virtual void setState(int extState);
+
         // GridObject interface
         virtual void on_creation(GridPos p);
 
-        // StateObject interface
-        virtual void setState(int extState);
-
     private:
         int getHoles() const;
         int requiredShogunHoles() const;

Modified: trunk/src/items.cc
===================================================================
--- trunk/src/items.cc	2008-08-23 22:54:45 UTC (rev 1286)
+++ trunk/src/items.cc	2008-08-24 11:59:42 UTC (rev 1287)
@@ -145,7 +145,7 @@
 bool Item::actor_hit(Actor *actor)
 {
     const ItemTraits &tr = get_traits();
-    if (tr.flags & itf_static)
+    if (isStatic())
         return false;
     else {
         double radius = 0.3;
@@ -1271,12 +1271,6 @@
             change_state(BURNING);
         }
         void on_drop(Actor *) { change_state(BURNING); }
-        bool actor_hit(Actor *a) {
-            if (state == BURNING)
-                return false;   // don't pick up burning dynamite
-
-            return Item::actor_hit(a);
-        }
     };
     DEF_ITEMTRAITSF(Dynamite, "it-dynamite", it_dynamite,
                 itf_indestructible | itf_fireproof);
@@ -1425,107 +1419,6 @@
 }
 
 
-/* -------------------- Seed -------------------- */
-namespace
-{
-    class Seed : public Item {
-        bool activep;
-
-        bool actor_hit(Actor *a) {
-            if (activep)
-                return false;   // do not pickup growing seed
-            return Item::actor_hit(a);
-        }
-        void on_drop (Actor *) {start_growing();}
-        void on_stonehit (Stone *) {start_growing();}
-        void processLight(Direction d) {start_growing();}
-
-        virtual Value message(const Message &m) {
-            if (m.message == "grow" || m.message == "signal") {
-                start_growing();
-                return Value();
-            }
-            return Item::message(m);
-        }
-
-        void start_growing() {
-            if (!activep) {
-                activep = true;
-                sound_event ("seedgrow");
-                set_anim("it-seed-growing");
-            }
-        }
-
-        void animcb() {
-            GridPos p= get_pos();
-            if ((server::GameCompatibility == GAMET_OXYDMAGNUM || server::GameCompatibility == GAMET_OXYD1) &&
-                (get_stone_name() == "st-wood-growing" && GetStone(p))) {
-                string model = GetStone(p)->get_kind();
-                if (model == "st-grate1") {
-                    SetFloor(p, MakeFloor("fl-stwood"));
-                    kill();
-                    return;
-               }
-           }
-           Stone *st = MakeStone (get_stone_name());
-           transferName(st);
-           SetStone (p, st);
-           kill();
-        }
-        
-        virtual bool isStatic() const {
-            return activep;  // active seed is static
-        }
-
-        virtual const char* get_stone_name() = 0;
-    public:
-        Seed ()
-        : activep(false)
-        {}
-    };
-
-    class SeedWood : public Seed {
-        CLONEOBJ(SeedWood);
-        DECL_ITEMTRAITS;
-
-        const char* get_stone_name() {
-            return "st-wood-growing";
-        }
-
-    public:
-        SeedWood()
-        {}
-    };
-    DEF_ITEMTRAITSR(SeedWood, "it-seed", it_seed, 0.2f);
-
-    class SeedNowood : public Seed {
-        CLONEOBJ(SeedNowood);
-        DECL_ITEMTRAITS;
-
-        const char* get_stone_name() {
-            return "st-greenbrown-growing";
-        }
-    public:
-        SeedNowood()
-        {}
-    };
-    DEF_ITEMTRAITSR(SeedNowood, "it-seed_nowood", it_seed_nowood, 0.2f);
-
-    class SeedVolcano : public Seed {
-        CLONEOBJ(SeedVolcano);
-        DECL_ITEMTRAITS;
-
-        const char* get_stone_name() {
-            return "st-volcano-growing";
-        }
-    public:
-        SeedVolcano()
-        {}
-    };
-    DEF_ITEMTRAITSR(SeedVolcano, "it-seed_volcano", it_seed_volcano, 0.2f);
-}
-
-
 /* -------------------- YinYang item -------------------- */
 namespace
 {
@@ -1625,12 +1518,6 @@
         bool active;
         Direction m_direction;
 
-        bool actor_hit(Actor *a) {
-            if (active)
-                return false;
-            return Item::actor_hit(a);
-        }
-
         void on_drop(Actor *) { activate(); }
 
         void activate() {
@@ -2841,9 +2728,6 @@
     Puller::setup();
     RegisterItem (new Ring);
     RegisterItem (new RubberbandItem);
-    RegisterItem (new SeedWood);
-    RegisterItem (new SeedNowood);
-    RegisterItem (new SeedVolcano);
     RegisterItem (new Spade);
     RegisterItem (new Spoon);
     RegisterItem (new Spring1);

Modified: trunk/src/items.hh
===================================================================
--- trunk/src/items.hh	2008-08-23 22:54:45 UTC (rev 1286)
+++ trunk/src/items.hh	2008-08-24 11:59:42 UTC (rev 1287)
@@ -100,8 +100,8 @@
         it_puller_w,
         it_ring,
         it_rubberband,
-        it_seed,
-        it_seed_nowood,
+        it_seed_wood,
+        it_seed_fake,
         it_seed_volcano,
         it_sensor,
         it_shogun_s,
@@ -236,7 +236,7 @@
 
         /*! The model used for displaying this item in an
           inventory. */
-        virtual string get_inventory_model();
+        virtual std::string get_inventory_model();
 
         /* Called when item is activated by the owner of `a'. */
         virtual ItemAction activate(Actor* a, GridPos p);

Modified: trunk/src/ox_magnum.cc
===================================================================
--- trunk/src/ox_magnum.cc	2008-08-23 22:54:45 UTC (rev 1286)
+++ trunk/src/ox_magnum.cc	2008-08-24 11:59:42 UTC (rev 1287)
@@ -327,7 +327,7 @@
     "it-spade",         // OxydMagnum item 0x22
     UNUSED,        // OxydMagnum item 0x23
     "it-pin",           // OxydMagnum item 0x24
-    "it-seed",          // OxydMagnum item 0x25
+    "it_seed",          // OxydMagnum item 0x25
     "it-spring2",       // OxydMagnum item 0x26
     "it-spring1",       // OxydMagnum item 0x27
     "it-bag",           // OxydMagnum item 0x28

Modified: trunk/src/ox_oxyd1.cc
===================================================================
--- trunk/src/ox_oxyd1.cc	2008-08-23 22:54:45 UTC (rev 1286)
+++ trunk/src/ox_oxyd1.cc	2008-08-24 11:59:42 UTC (rev 1287)
@@ -343,7 +343,7 @@
     "it-spade",                   // 0x22
     "it-surprise",                // 0x23
     "it-pin",                     // 0x24
-    "it-seed",                    // 0x25
+    "it_seed",                    // 0x25
     "it-spring2",                 // 0x26
     "it-spring1",                 // 0x27
     "it-bag",                     // 0x28

Modified: trunk/src/ox_peroxyd.cc
===================================================================
--- trunk/src/ox_peroxyd.cc	2008-08-23 22:54:45 UTC (rev 1286)
+++ trunk/src/ox_peroxyd.cc	2008-08-24 11:59:42 UTC (rev 1287)
@@ -415,7 +415,7 @@
     "it-spade",                   // 0x21
     "it-surprise",                // 0x22
     "it-pin",                     // 0x23
-    "it-seed",                    // 0x24
+    "it_seed",                    // 0x24
     "it-spring2",                 // 0x25
     "it-spring1",                 // 0x26
     "it-bag",                     // 0x27

Modified: trunk/src/stones/BoulderStone.hh
===================================================================
--- trunk/src/stones/BoulderStone.hh	2008-08-23 22:54:45 UTC (rev 1286)
+++ trunk/src/stones/BoulderStone.hh	2008-08-24 11:59:42 UTC (rev 1287)
@@ -21,7 +21,6 @@
 #define BOULDERSTONE_HH
 
 #include "stones.hh"
-//#include "laser.hh"
 
 #include "stones_internal.hh"
 

Modified: trunk/src/stones/ShogunStone.cc
===================================================================
--- trunk/src/stones/ShogunStone.cc	2008-08-23 22:54:45 UTC (rev 1286)
+++ trunk/src/stones/ShogunStone.cc	2008-08-24 11:59:42 UTC (rev 1287)
@@ -81,6 +81,7 @@
         } else
             return Stone::getAttr(key);
     }
+    
     Value ShogunStone::message(const Message &m) {
         if (m.message == "kill") {
             if (yieldShogun()) {

Added: trunk/src/stones/VolcanoStone.cc
===================================================================
--- trunk/src/stones/VolcanoStone.cc	2008-08-23 22:54:45 UTC (rev 1286)
+++ trunk/src/stones/VolcanoStone.cc	2008-08-24 11:59:42 UTC (rev 1287)
@@ -0,0 +1,197 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *  
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include "stones/VolcanoStone.hh"
+#include "player.hh"
+#include "world.hh"
+//#include "main.hh"
+
+namespace enigma {
+    VolcanoStone::VolcanoStone(int initState) {
+        state = initState;
+    }
+    
+    std::string VolcanoStone::getClass() const {
+        return "st_volcano";
+    }
+
+    void VolcanoStone::setAttr(const string& key, const Value &val) {
+        if (key == "secure") {
+            if (val.to_bool())
+                objFlags |= OBJBIT_SECURE;
+            else
+                objFlags &= ~OBJBIT_SECURE;
+            return;
+        }
+        Stone::setAttr(key, val);
+    }
+    
+    Value VolcanoStone::getAttr(const string &key) const {
+        if (key == "secure") {
+            return (objFlags & OBJBIT_SECURE) != 0;
+        } else
+            return Stone::getAttr(key);
+    }
+    
+    Value VolcanoStone::message(const Message &m) {
+        if (m.message == "_trigger" || m.message == "toggle") {
+            if (state == INACTIVE) {
+                state = ACTIVE;
+                init_model();
+            }
+            return Value();
+        }
+        return Stone::message(m);
+    }
+
+    int VolcanoStone::externalState() const {
+        return (state == INACTIVE || state == FINISHED || state == BREAKING) ? 0 : 1;
+    }
+    
+    void VolcanoStone::setState(int extState) {
+        if (state <= ACTIVE) {
+            state = extState;
+            if (isDisplayable())
+                init_model();
+        }
+    }
+    
+    void VolcanoStone::init_model() {
+        switch( state) {
+            case FINISHED:
+            case INACTIVE: set_model("st-plain"); break;
+            case ACTIVE:   set_anim("st-farting"); break;
+            case BREAKING: set_anim("st-fartbreak-anim"); break;
+            case NEW:      set_anim("it-seed-growing"); break;
+            case GROWING:  set_anim("st-volcano-growing"); break;
+        }
+    }
+
+    void VolcanoStone::animcb() {
+        switch (state) {
+            case NEW:
+                state = GROWING;
+                TouchStone(get_pos());   // inform triggers etc. of state change
+                init_model();
+                break;
+            case GROWING:
+                state = ACTIVE;
+                init_model();
+                break;
+            case BREAKING:
+                KillStone(get_pos());
+                break;
+            case ACTIVE:
+                // Spread
+                GridPos p = get_pos();
+                if (DoubleRand(0, 1) > 0.7) spread(move(p, NORTH));
+                if (DoubleRand(0, 1) > 0.7) spread(move(p, EAST));
+                if (DoubleRand(0, 1) > 0.7) spread(move(p, SOUTH));
+                if (DoubleRand(0, 1) > 0.7) spread(move(p, WEST));
+
+                // Be finished at random time
+                if ((((objFlags & OBJBIT_SECURE) == 0) || neighborsVulcanized()) && (DoubleRand(0, 1) > 0.95))
+                    state = FINISHED;
+                init_model();
+                break;
+        }
+    }
+
+    bool VolcanoStone::is_floating() const {
+        return state == NEW;
+    }
+    
+    bool VolcanoStone::is_transparent(Direction d) const {
+        return false;
+    }
+    bool VolcanoStone::is_sticky(const Actor *a) const {
+        return state != NEW;
+    }
+    
+    StoneResponse VolcanoStone::collision_response(const StoneContact &sc) {
+        return state != NEW ? STONE_REBOUND : STONE_PASS;
+    }
+    
+    void VolcanoStone::actor_hit(const StoneContact &sc) {
+        Actor *a = sc.actor;
+
+        if( state == ACTIVE && player::WieldedItemIs (a, "it_hammer")) {
+            state = BREAKING;
+            init_model();
+        } else if (state == GROWING) {
+            SendMessage(a, "shatter");
+        }
+    }
+    
+    void VolcanoStone::actor_touch(const StoneContact &sc) {
+        if (state == GROWING)
+            SendMessage(sc.actor, "shatter");        
+    }
+
+    void VolcanoStone::actor_inside(Actor *a) {
+        if (state != NEW)
+            SendMessage(a, "shatter");
+    }
+    
+    void VolcanoStone::actor_contact(Actor *a) {
+        if (state == GROWING)
+            SendMessage(a, "shatter");
+    }
+    
+    FreezeStatusBits VolcanoStone::get_freeze_bits() {
+        return FREEZEBIT_NO_STONE;
+    }
+    
+    void VolcanoStone::spread(GridPos p) {
+        if(GetStone(p) == NULL) {
+            Stone * st = MakeStone("st_volcano_new");
+            st->setAttr("secure", getAttr("secure"));
+            SetStone(p, st);
+        }
+    }
+    
+    bool VolcanoStone::neighborsVulcanized() {
+        for (Direction d = WEST; d != NODIR; d = next(d)) {
+            if (GetStone(move(get_pos(), d)) == NULL)
+                if (!positionVulcanizable(move(get_pos(), d)))
+                    return false;
+        }
+        return true;
+    }
+    
+    bool VolcanoStone::positionVulcanizable(GridPos p) {
+        for (Direction d = WEST; d != NODIR; d = next(d)) {
+            VolcanoStone *v = dynamic_cast<VolcanoStone *>(GetStone(move(p, d)));
+            if (v != this && v != NULL && v->externalState() == 1)
+                return true;
+        }
+    }
+    
+    DEF_TRAITSM(VolcanoStone, "st_volcano", st_volcano, MOVABLE_BREAKABLE);
+    
+    BOOT_REGISTER_START
+        BootRegister(new VolcanoStone(0), "st_volcano");
+        BootRegister(new VolcanoStone(0), "st_volcano_inactive");
+        BootRegister(new VolcanoStone(1), "st_volcano_active");
+        BootRegister(new VolcanoStone(2), "st_volcano_new");
+        BootRegister(new VolcanoStone(3), "st_volcano_growing");
+    BOOT_REGISTER_END
+
+} // namespace enigma


Property changes on: trunk/src/stones/VolcanoStone.cc
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/stones/VolcanoStone.hh
===================================================================
--- trunk/src/stones/VolcanoStone.hh	2008-08-23 22:54:45 UTC (rev 1286)
+++ trunk/src/stones/VolcanoStone.hh	2008-08-24 11:59:42 UTC (rev 1287)
@@ -0,0 +1,88 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef VOLCANOSTONE_HH
+#define VOLCANOSTONE_HH
+
+#include "stones.hh"
+
+#include "stones_internal.hh"
+
+namespace enigma {
+
+    /** 
+     * 
+     */
+    class VolcanoStone : public Stone {
+        CLONEOBJ(VolcanoStone);
+        DECL_TRAITS;
+    private:
+        enum iState {
+            INACTIVE,     ///< 
+            ACTIVE,       ///< 
+            NEW,          ///<
+            GROWING,      ///<
+            FINISHED,     ///< 
+            BREAKING      ///< 
+        };
+        
+    private:
+        enum ObjectPrivatFlagsBits {
+            OBJBIT_SECURE =   1<<24,   ///< secure spreading of volcano
+        };
+
+    public:
+        VolcanoStone(int initState);
+        
+        // Object interface
+        virtual std::string getClass() const;        
+        virtual void setAttr(const string& key, const Value &val);
+        virtual Value getAttr(const std::string &key) const;
+        virtual Value message(const Message &m);
+        
+        // StateObject interface
+        virtual int externalState() const;
+        virtual void setState(int extState);
+
+        // GridObject interface
+        virtual void init_model();
+        
+        // ModelCallback interface
+        virtual void animcb();
+        
+        // Stone interface
+        virtual bool is_floating() const;
+        virtual bool is_transparent(Direction d) const;
+        virtual bool is_sticky(const Actor *a) const;
+        virtual StoneResponse collision_response(const StoneContact &sc);
+        virtual void actor_hit(const StoneContact &sc);
+        virtual void actor_touch(const StoneContact &sc);
+        virtual void actor_inside(Actor *a);
+        virtual void actor_contact(Actor *a);
+        virtual FreezeStatusBits get_freeze_bits();
+
+    private:
+        void spread(GridPos p);
+        bool neighborsVulcanized();
+        bool positionVulcanizable(GridPos p);
+    };
+
+} // namespace enigma
+
+#endif


Property changes on: trunk/src/stones/VolcanoStone.hh
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/src/stones.hh
===================================================================
--- trunk/src/stones.hh	2008-08-23 22:54:45 UTC (rev 1286)
+++ trunk/src/stones.hh	2008-08-24 11:59:42 UTC (rev 1287)
@@ -208,9 +208,9 @@
         /* ---------- Stone interface (events) ---------- */
 
         virtual void actor_hit (const StoneContact &sc);
-        virtual void actor_touch (const StoneContact &sc);
-        virtual void actor_inside (Actor * /*a*/) {}
-        virtual void actor_contact (Actor * /*a*/) {}
+        virtual void actor_touch(const StoneContact &sc);
+        virtual void actor_inside(Actor *a) {}
+        virtual void actor_contact(Actor *a) {}
 
         virtual bool freeze_check();
         

Modified: trunk/src/stones_complex.cc
===================================================================
--- trunk/src/stones_complex.cc	2008-08-23 22:54:45 UTC (rev 1286)
+++ trunk/src/stones_complex.cc	2008-08-24 11:59:42 UTC (rev 1287)
@@ -39,78 +39,7 @@
 
 namespace enigma { 
 
-/* -------------------- Volcano -------------------- */
-namespace
-{
-    class VolcanoStone : public Stone {
-        CLONEOBJ(VolcanoStone);
-        DECL_TRAITS;
-    public:
-        enum State {INACTIVE, ACTIVE, FINISHED, BREAKING};
-        VolcanoStone( State initstate=INACTIVE) : state( initstate) {}
-    private:
-        enum State state;
 
-        void init_model() {
-            switch( state) {
-            case FINISHED:
-            case INACTIVE: set_model( "st-plain"); break;
-            case ACTIVE: set_anim( "st-farting"); break;
-            case BREAKING: set_anim("st-stone_break-anim"); break;
-            }
-        }
-
-        void animcb() {
-            if (state == ACTIVE) {
-                // Spread
-                GridPos p = get_pos();
-                if (DoubleRand(0, 1) > 0.7) spread (move(p, NORTH));
-                if (DoubleRand(0, 1) > 0.7) spread (move(p, EAST));
-                if (DoubleRand(0, 1) > 0.7) spread (move(p, SOUTH));
-                if (DoubleRand(0, 1) > 0.7) spread (move(p, WEST));
-
-                // Be finished at random time
-                if (DoubleRand(0, 1) > 0.95)
-                    state = FINISHED;
-                init_model();
-            } else if( state == BREAKING) {
-                KillStone( get_pos());
-            }
-        }
-
-        virtual Value message(const Message &m) {
-            if (m.message == "_trigger" || m.message == "toggle") {
-                if (state == INACTIVE) {
-                    state = ACTIVE;
-                    init_model();
-                }
-                return Value();
-            }
-            return Stone::message(m);
-        }
-
-        void spread( GridPos p) {
-            Stone *st = GetStone(p);
-            if( !st) {
-                Item *it = MakeItem("it-seed_volcano");
-                SetItem( p, it);
-                SendMessage( it, "grow");
-            }
-        }
-
-        void actor_hit(const StoneContact &sc) {
-            Actor *a = sc.actor;
-
-            if( state == ACTIVE && player::WieldedItemIs (a, "it_hammer")) {
-                state = BREAKING;
-                init_model();
-            }
-        }
-    };
-    DEF_TRAITSM(VolcanoStone, "st-volcano", st_volcano, MOVABLE_BREAKABLE);    
-}
-
-
 ///* -------------------- Puzzle stones -------------------- */ 
 
 /** \page st-puzzle Puzzle Stone
@@ -1135,10 +1064,6 @@
 
     Register(new MovableImpulseStone);
 
-    Register( new VolcanoStone);
-    Register("st-volcano_inactive", new VolcanoStone(VolcanoStone::INACTIVE));
-    Register("st-volcano_active", new VolcanoStone(VolcanoStone::ACTIVE));
-
     // PerOxyd/Enigma compatible puzzle stones:
     Register(new PuzzleStone(0, false));
     Register("st-puzzle-hollow", new PuzzleStone(1, false));

Modified: trunk/src/stones_simple.cc
===================================================================
--- trunk/src/stones_simple.cc	2008-08-23 22:54:45 UTC (rev 1286)
+++ trunk/src/stones_simple.cc	2008-08-24 11:59:42 UTC (rev 1287)
@@ -969,25 +969,6 @@
     };
     DEF_TRAITS(GreenbrownStone_Growing, "st-greenbrown-growing", st_greenbrown_growing);
 
-    class VolcanoStone_Growing : public Stone {
-        CLONEOBJ(VolcanoStone_Growing);
-        DECL_TRAITS;
-    public:
-        VolcanoStone_Growing()
-        {}
-    private:
-        void init_model() { set_anim("st-volcano-growing"); }
-        void animcb() {
-            Stone *st = MakeStone("st-volcano_active");
-            ReplaceStone(get_pos(), st);
-        }
-        void actor_contact(Actor *a) {SendMessage(a, "shatter");}
-        void actor_inside(Actor *a) {SendMessage(a, "shatter");}
-        void actor_hit(const StoneContact &sc) {SendMessage(sc.actor, "shatter");}
-
-        FreezeStatusBits get_freeze_bits() { return FREEZEBIT_NO_STONE; }
-    };
-    DEF_TRAITS(VolcanoStone_Growing, "st-volcano-growing", st_volcano_growing);
 }
 
 
@@ -1773,7 +1754,6 @@
     Register(new WoodenStone("st-flhay", "fl-hay"));
     Register(new WoodenStone_Growing);
     Register(new GreenbrownStone_Growing);
-    Register(new VolcanoStone_Growing);
 
     Register(new YinYangStone1);
     Register(new YinYangStone2);

Modified: trunk/src/world.cc
===================================================================
--- trunk/src/world.cc	2008-08-23 22:54:45 UTC (rev 1286)
+++ trunk/src/world.cc	2008-08-24 11:59:42 UTC (rev 1287)
@@ -2037,6 +2037,10 @@
     SetStone(newPos, YieldStone(oldPos));
 }
 
+void TouchStone(GridPos pos) {
+    level->changed_stones.push_back(pos);
+}
+
 void SetScrambleIntensity (int intensity) {
     level->scrambleIntensity = intensity;
 }

Modified: trunk/src/world.hh
===================================================================
--- trunk/src/world.hh	2008-08-23 22:54:45 UTC (rev 1286)
+++ trunk/src/world.hh	2008-08-24 11:59:42 UTC (rev 1287)
@@ -275,6 +275,7 @@
     Stone *YieldStone(GridPos p);
     void   KillStone(GridPos p);
     void   MoveStone(GridPos oldPos, GridPos newPos);
+    void TouchStone(GridPos pos);
 
 /* -------------------- Items -------------------- */
 



From ral at mail.berlios.de  Sun Aug 24 16:01:04 2008
From: ral at mail.berlios.de (ral at mail.berlios.de)
Date: Sun, 24 Aug 2008 16:01:04 +0200
Subject: [Enigma-game-svn] r1288 - team_levelpacks/team_test_new_api
Message-ID: <200808241401.m7OE14pi031225@sheep.berlios.de>

Author: ral
Date: 2008-08-24 16:00:53 +0200 (Sun, 24 Aug 2008)
New Revision: 1288

Added:
   team_levelpacks/team_test_new_api/ralT062_1.xml
Log:
Test Level new API:
- volcano test level added


Added: team_levelpacks/team_test_new_api/ralT062_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/ralT062_1.xml	2008-08-24 11:59:42 UTC (rev 1287)
+++ team_levelpacks/team_test_new_api/ralT062_1.xml	2008-08-24 14:00:53 UTC (rev 1288)
@@ -0,0 +1,64 @@
+<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
+<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
+  <el:protected>
+    <el:info el:type="level">
+      <el:identity el:title="Test Volcano new API" el:subtitle="" el:id="20080823ral431"/>
+      <el:version el:score="1" el:release="1" el:revision="$Revision$" el:status="experimental"/>
+      <el:author  el:name="Ronald Lamprecht" el:email="ral at users.berlios.de"/>
+      <el:copyright>Copyright ? 2008 Ronald Lamprecht</el:copyright>
+      <el:license el:type="GPL v2.0 or above" el:open="true"/>
+      <el:compatibility el:enigma="1.10">
+      </el:compatibility>
+      <el:modes el:easy="false" el:single="true" el:network="false"/>
+      <el:comments>
+      </el:comments>
+      <el:score el:easy="-" el:difficult="-"/>
+    </el:info>
+    <el:luamain><![CDATA[
+wo["ConserveLevel"] = true
+
+ti[" "] = {"fl-sahara"}
+ti["#"] = {"st-rock1"}
+
+ti["-"] = {"st-grate1"}
+ti["+"] = {"it_trigger", target="laser"}
+
+ti["."] = {"it_seed_volcano"}
+ti[";"] = {"it_seed_volcano", secure=true}
+ti["L"] = {"st_laser_n", "laser"}
+
+ti["V"] = {"st_volcano"}
+ti["v"] = {"st_volcano_active"}
+ti["u"] = {"st_volcano_inactive", "volcano", secure=true}
+ti["S"] = {"st_switch", target="volcano"}
+
+ti["B"] = {"st_boulder_s"}
+ti["w"] = {"it_magicwand"}
+
+ti["@"] = {"#ac-blackball"} .. ti({"it_hammer"}) 
+
+w, h = wo(ti, " ", {
+"  v  #  V    #  u   ",
+"     #       #    # ",
+" #   #       #    # ",
+" #   #  B    #    S ",
+" #-######-######-## ",
+" #   #L      #    # ",
+" #   #  ...  #    # ",
+" #   -  @w;  -    # ",
+" #   #       #    # ",
+" #-######-######-## ",
+" #   #       #    # ",
+" #   #       -    # ",
+" #  +#       #      "
+})
+
+
+  ]]></el:luamain>
+    <el:i18n>
+	 <el:string el:key="title">
+	   <el:english el:translate="false"/>
+	 </el:string>
+   </el:i18n>
+  </el:protected>
+</el:level>


Property changes on: team_levelpacks/team_test_new_api/ralT062_1.xml
___________________________________________________________________
Name: svn:keywords
   + Revision
Name: svn:eol-style
   + native



From raoul at mail.berlios.de  Mon Aug 25 23:27:21 2008
From: raoul at mail.berlios.de (raoul at BerliOS)
Date: Mon, 25 Aug 2008 23:27:21 +0200
Subject: [Enigma-game-svn] r1289 - in trunk/data/levels: enigma_cross
	enigma_i enigma_vii enigma_viii
Message-ID: <200808252127.m7PLRLq2023604@sheep.berlios.de>

Author: raoul
Date: 2008-08-25 23:27:20 +0200 (Mon, 25 Aug 2008)
New Revision: 1289

Added:
   trunk/data/levels/enigma_vii/mecke12_1.xml
Removed:
   trunk/data/levels/enigma_vii/duffy175_1.xml
   trunk/data/levels/enigma_viii/mecke12_1.xml
Modified:
   trunk/data/levels/enigma_cross/newlevels.xml
   trunk/data/levels/enigma_cross/newlevels_1.1.0.xml
   trunk/data/levels/enigma_i/alain04_1.xml
   trunk/data/levels/enigma_i/index.xml
   trunk/data/levels/enigma_vii/index.xml
   trunk/data/levels/enigma_viii/index.xml
   trunk/data/levels/enigma_viii/mecke01_1.xml
   trunk/data/levels/enigma_viii/mecke05_1.xml
   trunk/data/levels/enigma_viii/mecke07_1.xml
Log:
-> Swap/Pull fixes
-> Alain04: Fix for balls appearing under stones
-> Some index updates



Modified: trunk/data/levels/enigma_cross/newlevels.xml
===================================================================
--- trunk/data/levels/enigma_cross/newlevels.xml	2008-08-24 14:00:53 UTC (rev 1288)
+++ trunk/data/levels/enigma_cross/newlevels.xml	2008-08-25 21:27:20 UTC (rev 1289)
@@ -1,7 +1,7 @@
 <?xml version="1.0" encoding="UTF-8" standalone="no" ?>
 <index xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="index.xsd">
 
-  <info enigma="1.00" group="Facets" location="15400" network="false" owner="Enigma Team" release="1" revision="9" title="Enigma 1.00 new"/>
+  <info enigma="1.00" group="Facets" location="15400" network="false" owner="Enigma Team" release="1" revision="10" title="Enigma 1.00 new"/>
 
   <attributes/>
 
@@ -17,7 +17,7 @@
     <level _seq="9" _title="Enigmawale" _xpath="enigma_i/alain20_1" author="Alain Busser" ctrl="force" easy="true" id="alain20" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="10" _title="Encased" _xpath="enigma_i/xerxes01_1" author="Xerxes M. Dynatos" ctrl="force" easy="false" id="xerxes01" rel="1" rev="2" score="1" target="time" unit="duration"/>
     <level _seq="11" _title="Without Tremor" _xpath="enigma_i/richi04_1" author="Richi B?tzer" ctrl="force" easy="false" id="richi04" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="12" _title="- Meditation -" _xpath="enigma_i/alain04_1" author="Alain Busser" ctrl="force" easy="false" id="alain04" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="12" _title="- Meditation -" _xpath="enigma_i/alain04_1" author="Alain Busser" ctrl="force" easy="false" id="alain04" rel="1" rev="2" score="1" target="time" unit="duration"/>
     <level _seq="13" _title="Light Barrier" _xpath="enigma_i/richi03_1" author="Richi B?tzer" ctrl="force" easy="false" id="richi03" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="14" _title="Dead Ball Walking" _xpath="enigma_i/illmind08_1" author="illmind" ctrl="force" easy="false" id="illmind08" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="15" _title="The Enigmhanoi Towers" _xpath="enigma_i/alain05_1" author="Alain Busser" ctrl="force" easy="true" id="alain05" rel="1" rev="0" score="1" target="time" unit="duration"/>
@@ -67,7 +67,7 @@
     <level _seq="59" _title="Manamana" _xpath="enigma_iii/just07_1" author="JuSt" ctrl="force" easy="false" id="just07" rel="1" rev="3" score="1" target="time" unit="duration"/>
     <level _seq="60" _title="Bad Flowers" _xpath="enigma_iii/nat30_1" author="Nat Pryce" ctrl="force" easy="true" id="nat30" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="61" _title="Don't Touch" _xpath="enigma_iii/raoul07_2" author="Raoul Bourquin" ctrl="force" easy="true" id="raoul07" rel="2" rev="1" score="2" target="time" unit="duration"/>
-    <level _seq="62" _title="Laser Castle" _xpath="enigma_iii/andreas04_1" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas04" rel="1" rev="3" score="1" target="time" unit="duration"/>
+    <level _seq="62" _title="Laser Castle" _xpath="enigma_iii/andreas04_1" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas04" rel="1" rev="4" score="1" target="time" unit="duration"/>
     <level _seq="63" _title="Bump Ahead" _xpath="enigma_iii/illmind01_1" author="illmind" ctrl="force" easy="false" id="illmind01" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="64" _title="Killer Hills" _xpath="enigma_iii/luc11_1" author="Lukas Sch?ller" ctrl="force" easy="false" id="luc11" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="65" _title="Fox in the Henhouse" _xpath="enigma_iii/nat26_1" author="Nat Pryce" ctrl="force" easy="false" id="nat26" rel="1" rev="0" score="1" target="time" unit="duration"/>
@@ -169,7 +169,7 @@
     <level _seq="161" _title="- Meditation -" _xpath="enigma_vi/alain25_2" author="Alain Busser + Raoul Bourquin" ctrl="force" easy="true" id="alain25" rel="2" rev="2" score="2" target="time" unit="duration"/>
     <level _seq="162" _title="Checkmate I" _xpath="enigma_vi/andreas29_1" author="Andreas Lochmann" ctrl="force" easy="false" id="andreas29" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="163" _title="The Stable" _xpath="enigma_vi/andreas30_2" author="Andreas Lochmann" ctrl="force" easy="false" id="andreas30" rel="2" rev="1" score="2" target="time" unit="duration"/>
-    <level _seq="164" _title="Chess, Bugs &amp; Rock'n'Roll" _xpath="enigma_vi/andreas31_1" author="Andreas Lochmann" ctrl="force" easy="false" id="andreas31" rel="1" rev="2" score="1" target="time" unit="duration"/>
+    <level _seq="164" _title="Chess, Bugs &amp; Rock'n'Roll" _xpath="enigma_vi/andreas31_1" author="Andreas Lochmann" ctrl="force" easy="false" id="andreas31" rel="1" rev="3" score="1" target="time" unit="duration"/>
     <level _seq="165" _title="Chessing Positions" _xpath="enigma_vi/raoul22_1" author="Raoul Bourquin" ctrl="force" easy="false" id="raoul22" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="166" _title="Twisting by the pool" _xpath="enigma_vi/alain23_1" author="Alain Busser" ctrl="force" easy="true" id="alain23" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="167" _title="Hot Meditation" _xpath="enigma_vi/ral08_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20060527ral010" rel="1" rev="42" score="1" target="time" unit="duration"/>

Modified: trunk/data/levels/enigma_cross/newlevels_1.1.0.xml
===================================================================
--- trunk/data/levels/enigma_cross/newlevels_1.1.0.xml	2008-08-24 14:00:53 UTC (rev 1288)
+++ trunk/data/levels/enigma_cross/newlevels_1.1.0.xml	2008-08-25 21:27:20 UTC (rev 1289)
@@ -1,7 +1,7 @@
 <?xml version="1.0" encoding="UTF-8" standalone="no" ?>
 <index xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="index.xsd">
 
-  <info enigma="1.00" group="Facets" location="15600" network="false" owner="Enigma Team" release="1" revision="11" title="Enigma 1.1 new"/>
+  <info enigma="1.00" group="Facets" location="15600" network="false" owner="Enigma Team" release="1" revision="12" title="Enigma 1.1 new"/>
 
   <attributes/>
 
@@ -30,90 +30,89 @@
     <level _seq="22" _title="Double Oneways" _xpath="enigma_vii/duffy172_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy172" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="23" _title="Wood - Water - Wood" _xpath="enigma_vii/duffy173_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy173" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="24" _title="Transpositions" _xpath="enigma_vii/duffy174_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy174" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="25" _title="The Pearl Necklet" _xpath="enigma_vii/duffy175_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy175" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="26" _title="Puppet" _xpath="enigma_vii/pulley06_2" author="Mark Pulley" ctrl="force" easy="true" id="pulley06" rel="2" rev="2" score="1" target="time" unit="duration"/>
-    <level _seq="27" _title="Restless Meditation" _xpath="enigma_vii/ral09_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20070623ral914" rel="1" rev="77" score="1" target="time" unit="duration"/>
-    <level _seq="28" _title="Ghost Driver" _xpath="enigma_vii/duffy176_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy176" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="29" _title="Re-entry Circuit" _xpath="enigma_vii/pulley05_1" author="Mark Pulley" ctrl="force" easy="false" id="pulley05" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="30" _title="Not Fast Enough" _xpath="enigma_vii/jet04_3" author="James Taylor, Ronald Lamprecht" ctrl="force" easy="true" id="20070413jet001" rel="3" rev="3" score="3" target="time" unit="duration"/>
-    <level _seq="31" _title="Give Way" _xpath="enigma_vii/just20_1" author="JuSt" ctrl="force" easy="false" id="just20" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="32" _title="Give more Way" _xpath="enigma_vii/just21_2" author="JuSt" ctrl="force" easy="true" id="just21" rel="2" rev="3" score="2" target="time" unit="duration"/>
-    <level _seq="33" _title="Give Way 4 two" _xpath="enigma_vii/just22_2" author="JuSt" ctrl="force" easy="true" id="just22" rel="2" rev="2" score="2" target="time" unit="duration"/>
-    <level _seq="34" _title="Lost in Time and Space" _xpath="enigma_vii/just23_1" author="JuSt" ctrl="force" easy="false" id="just23" rel="1" rev="2" score="1" target="time" unit="duration"/>
-    <level _seq="35" _title="Alternatives?" _xpath="enigma_vii/just24_1" author="JuSt" ctrl="force" easy="true" id="just24" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="36" _title="No More Alternatives" _xpath="enigma_vii/just25_1" author="JuSt" ctrl="force" easy="true" id="just25" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="37" _title="The Walls" _xpath="enigma_vii/just26_1" author="JuSt" ctrl="force" easy="true" id="just26" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="38" _title="Pull the Puller" _xpath="enigma_vii/just28_1" author="JuSt" ctrl="force" easy="false" id="just28" rel="1" rev="2" score="1" target="time" unit="duration"/>
-    <level _seq="39" _title="Double Sense" _xpath="enigma_vii/joe14_1" author="Joseph Dunne" ctrl="force" easy="true" id="joe14" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="40" _title="Double Sense II" _xpath="enigma_vii/joe15_1" author="Joseph Dunne" ctrl="force" easy="true" id="joe15" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="41" _title="Lightyears" _xpath="enigma_vii/duffy177_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy177" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="42" _title="Zero Magnetism Lab" _xpath="enigma_vii/duffy178_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy178" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="43" _title="Armageddon" _xpath="enigma_vii/duffy179_1" author="Jacob Scott" ctrl="force" easy="true" id="duffy179" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="44" _title="Mountain Climbing II" _xpath="enigma_vii/joe25_1" author="Joseph Dunne" ctrl="force" easy="true" id="joe25" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="45" _title="Minor Tangler" _xpath="enigma_vii/joe24_1" author="Joseph Dunne" ctrl="force" easy="false" id="joe24" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="46" _title="Circulation" _xpath="enigma_vii/pulley03_2" author="Mark Pulley" ctrl="force" easy="false" id="pulley03" rel="2" rev="2" score="2" target="time" unit="duration"/>
-    <level _seq="47" _title="Maze for Two" _xpath="enigma_vii/ral22_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20071017ral096" rel="1" rev="84" score="1" target="time" unit="duration"/>
-    <level _seq="48" _title="Making Shapes" _xpath="enigma_vii/joe18_1" author="Joseph Dunne" ctrl="force" easy="false" id="joe18" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="49" _title="Clever Pushing" _xpath="enigma_vii/joe19_2" author="Joseph Dunne" ctrl="force" easy="false" id="joe19" rel="2" rev="1" score="2" target="time" unit="duration"/>
-    <level _seq="50" _title="Using Rotators" _xpath="enigma_vii/joe20_1" author="Joseph Dunne" ctrl="force" easy="false" id="joe20" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="51" _title="Swapping Puzzle" _xpath="enigma_vii/joe21_1" author="Joseph Dunne" ctrl="force" easy="false" id="joe21" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="52" _title="Swapping Puzzle II" _xpath="enigma_vii/joe22_1" author="Joseph Dunne" ctrl="force" easy="false" id="joe22" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="53" _title="Multiban" _xpath="enigma_vii/dpl01_1" author="Dominik Leipold" ctrl="force" easy="false" id="dpl01" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="54" _title="Riverside" _xpath="enigma_vii/johann02_2" author="Johann Freymuth" ctrl="force" easy="false" id="johann02" rel="2" rev="0" score="2" target="time" unit="duration"/>
-    <level _seq="55" _title="The Lone Ranger" _xpath="enigma_vii/pulley04_1" author="Mark Pulley" ctrl="force" easy="false" id="pulley04" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="56" _title="Little Shop Of Horrors" _xpath="enigma_vii/pulley07_1" author="Mark Pulley" ctrl="force" easy="false" id="pulley07" rel="1" rev="5" score="1" target="time" unit="duration"/>
-    <level _seq="57" _title="Spaceship Control" _xpath="enigma_vii/safalra01_1" author="Safalra" ctrl="force" easy="false" id="safalra01" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="58" _title="Ball Alley" _xpath="enigma_vii/johann01_1" author="Johann Freymuth" ctrl="force" easy="false" id="johann01" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="59" _title="Action Potential" _xpath="enigma_vii/pulley02_1" author="Mark Pulley" ctrl="force" easy="true" id="pulley02" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="60" _title="Remote Meditation" _xpath="enigma_vii/dpl02_1" author="Dominik Leipold" ctrl="force" easy="true" id="dpl02" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="61" _title="Triggered Triggers" _xpath="enigma_vii/just19_1" author="JuSt" ctrl="force" easy="true" id="just19" rel="1" rev="2" score="1" target="time" unit="duration"/>
-    <level _seq="62" _title="Lady in Red" _xpath="enigma_vii/just30_1" author="Just" ctrl="force" easy="true" id="just30" rel="1" rev="3" score="1" target="time" unit="duration"/>
-    <level _seq="63" _title="Crawling the Abyss" _xpath="enigma_vii/sph02_1" author="ShadowPhrogg32642342" ctrl="force" easy="true" id="sph02" rel="1" rev="5" score="1" target="time" unit="duration"/>
-    <level _seq="64" _title="Bold Boulder" _xpath="enigma_vii/ral14_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20061124ral279" rel="1" rev="96" score="1" target="time" unit="duration"/>
-    <level _seq="65" _title="Tinker, Tailor" _xpath="enigma_vii/andreas46_3" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas46" rel="4" rev="4" score="2" target="time" unit="duration"/>
-    <level _seq="66" _title="Elbow Society" _xpath="enigma_vii/andreas45_2" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas45" rel="2" rev="5" score="2" target="time" unit="duration"/>
-    <level _seq="67" _title="Watchmaker" _xpath="enigma_vii/huesing01_1" author="Johannes H?sing" ctrl="force" easy="false" id="huesing01" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="68" _title="Map it out II" _xpath="enigma_vii/manuel01_1" author="Manuel Eisentraut" ctrl="force" easy="true" id="manuel01" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="69" _title="Underground Temple" _xpath="enigma_vii/joe12_2" author="Joseph Dunne" ctrl="force" easy="true" id="joe_12" rel="2" rev="0" score="2" target="time" unit="duration"/>
-    <level _seq="70" _title="Mountain Climbing III" _xpath="enigma_vii/joe26_1" author="Joseph Dunne" ctrl="force" easy="true" id="joe26" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="71" _title="Recover the Stone" _xpath="enigma_vii/joe28_1" author="Joseph Dunne" ctrl="force" easy="false" id="joe28" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="72" _title="Pick-Up" _xpath="enigma_vii/joe27_1" author="Joseph Dunne" ctrl="force" easy="false" id="joe27" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="73" _title="A Kind of Magic" _xpath="enigma_vii/just37_1" author="JuSt" ctrl="force" easy="true" id="JuStA Kind of Magic" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="74" _title="Blue Screen Of Death" _xpath="enigma_vii/pulley10_2" author="Mark Pulley" ctrl="force" easy="true" id="pulley10" rel="2" rev="1" score="2" target="time" unit="duration"/>
-    <level _seq="75" _title="Audience in Venice" _xpath="enigma_vii/mecke09_1" author="mecke" ctrl="force" easy="true" id="mecke9" rel="1" rev="20" score="1" target="time" unit="duration"/>
-    <level _seq="76" _title="Black Liberation" _xpath="enigma_vii/mecke11_1" author="mecke" ctrl="force" easy="true" id="mecke11" rel="1" rev="25" score="1" target="time" unit="duration"/>
-    <level _seq="77" _title="Jack-Of-All-Trades" _xpath="enigma_viii/mecke12_1" author="mecke" ctrl="force" easy="true" id="mecke12" rel="1" rev="31" score="1" target="time" unit="duration"/>
-    <level _seq="78" _title="Enigmaparcour" _xpath="enigma_viii/mecke15_1" author="mecke" ctrl="force" easy="true" id="mecke15" rel="1" rev="21" score="1" target="time" unit="duration"/>
-    <level _seq="79" _title="Rhythm of Space" _xpath="enigma_viii/mecke20_1" author="mecke" ctrl="force" easy="true" id="mecke20" rel="1" rev="21" score="1" target="time" unit="duration"/>
-    <level _seq="80" _title="The Show Jumper" _xpath="enigma_viii/andreas47_1" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas47" rel="1" rev="3" score="1" target="time" unit="duration"/>
-    <level _seq="81" _title="The Red Room" _xpath="enigma_viii/joe29_1" author="Joseph Dunne" ctrl="force" easy="true" id="joe29" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="82" _title="Enigmines" _xpath="enigma_viii/huffman01_1" author="Brian Huffman" ctrl="force" easy="true" id="huffman01" rel="1" rev="2" score="1" target="time" unit="duration"/>
-    <level _seq="83" _title="Red Cave" _xpath="enigma_viii/mecke21_1" author="mecke" ctrl="force" easy="true" id="mecke21" rel="1" rev="30" score="1" target="time" unit="duration"/>
-    <level _seq="84" _title="Status code 302" _xpath="enigma_viii/dev02_1" author="/dev/null" ctrl="force" easy="true" id="dev02" rel="1" rev="4" score="1" target="time" unit="duration"/>
-    <level _seq="85" _title="A Screenful of Secrets" _xpath="enigma_viii/mecke01_1" author="mecke" ctrl="force" easy="true" id="mecke01" rel="1" rev="21" score="1" target="time" unit="duration"/>
-    <level _seq="86" _title="Southside Life" _xpath="enigma_viii/mecke10_1" author="mecke" ctrl="force" easy="true" id="mecke10" rel="1" rev="18" score="1" target="time" unit="duration"/>
-    <level _seq="87" _title="Joona's Chess" _xpath="enigma_viii/joona02_1" author="Joona Laire" ctrl="force" easy="true" id="joona02" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="88" _title="Helios I" _xpath="enigma_viii/mecke07_1" author="mecke" ctrl="force" easy="false" id="mecke48" rel="1" rev="11" score="1" target="time" unit="duration"/>
-    <level _seq="89" _title="The Green Hell" _xpath="enigma_viii/mecke22_1" author="mecke" ctrl="force" easy="true" id="mecke22" rel="1" rev="55" score="1" target="time" unit="duration"/>
-    <level _seq="90" _title="Tilt Board" _xpath="enigma_viii/ulf06_2" author="Ulf Stegemann" ctrl="force" easy="true" id="20080529ulf118" rel="2" rev="116" score="2" target="time" unit="duration"/>
-    <level _seq="91" _title="4 - 8 - 4" _xpath="enigma_viii/dpl03_3" author="Dominik Leipold" ctrl="force" easy="true" id="20070821dpl003" rel="3" rev="4" score="3" target="time" unit="duration"/>
-    <level _seq="92" _title="Impulsive Order" _xpath="enigma_viii/raywick05_1" author="Ray Wick" ctrl="force" easy="true" id="raywick5" rel="1" rev="5" score="1" target="time" unit="duration"/>
-    <level _seq="93" _title="Cross Mail" _xpath="enigma_viii/johann03_1" author="Johann Freymuth" ctrl="force" easy="false" id="johann03" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="94" _title="Color Maze" _xpath="enigma_viii/pulley16_3" author="Mark Pulley" ctrl="force" easy="false" id="pulley16" rel="3" rev="4" score="3" target="time" unit="duration"/>
-    <level _seq="95" _title="Earthlink" _xpath="enigma_viii/pulley15_1" author="Mark Pulley" ctrl="force" easy="true" id="pulley15" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="96" _title="Vanity's Constrictions" _xpath="enigma_viii/andreas53_2" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas53" rel="2" rev="5" score="2" target="time" unit="duration"/>
-    <level _seq="97" _title="Wired" _xpath="enigma_viii/andreas49_1" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas49" rel="1" rev="3" score="1" target="time" unit="duration"/>
-    <level _seq="98" _title="Push Wires" _xpath="enigma_viii/ral24_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20080708ral196" rel="1" rev="100" score="1" target="time" unit="duration"/>
-    <level _seq="99" _title="Wired Five" _xpath="enigma_viii/ral25_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20080721ral073" rel="1" rev="109" score="1" target="time" unit="duration"/>
-    <level _seq="100" _title="Wireban Premiere" _xpath="enigma_viii/ral26_1" author="Ronald Lamprecht" ctrl="force" easy="false" id="20080715ral161" rel="1" rev="106" score="1" target="time" unit="duration"/>
-    <level _seq="101" _title="Microwire" _xpath="enigma_viii/ral27_1" author="Ronald Lamprecht" ctrl="force" easy="false" id="20080717ral427" rel="1" rev="107" score="1" target="time" unit="duration"/>
-    <level _seq="102" _title="More Microwire" _xpath="enigma_viii/ral28_1" author="Ronald Lamprecht" ctrl="force" easy="false" id="20080717ral282" rel="1" rev="105" score="1" target="time" unit="duration"/>
-    <level _seq="103" _title="Freestyle Microwire" _xpath="enigma_viii/ral29_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20080719ral530" rel="1" rev="107" score="1" target="time" unit="duration"/>
-    <level _seq="104" _title="Balance Beam" _xpath="enigma_viii/mecke03_1" author="mecke" ctrl="force" easy="true" id="mecke03" rel="1" rev="29" score="1" target="time" unit="duration"/>
-    <level _seq="105" _title="Colored Oxyds" _xpath="enigma_viii/andreas50_1" author="Andreas Lochmann" ctrl="force" easy="false" id="andreas50" rel="1" rev="2" score="1" target="time" unit="duration"/>
-    <level _seq="106" _title="Fashions Pass" _xpath="enigma_viii/andreas48_1" author="Andreas Lochmann" ctrl="force" easy="false" id="andreas48" rel="1" rev="2" score="1" target="time" unit="duration"/>
-    <level _seq="107" _title="Colored Turnstiles" _xpath="enigma_viii/andreas51_1" author="Andreas Lochmann" ctrl="force" easy="false" id="andreas51" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="108" _title="Sanssouci" _xpath="enigma_viii/mecke05_1" author="mecke" ctrl="force" easy="true" id="mecke05" rel="1" rev="22" score="1" target="time" unit="duration"/>
+    <level _seq="25" _title="Puppet" _xpath="enigma_vii/pulley06_2" author="Mark Pulley" ctrl="force" easy="true" id="pulley06" rel="2" rev="2" score="1" target="time" unit="duration"/>
+    <level _seq="26" _title="Restless Meditation" _xpath="enigma_vii/ral09_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20070623ral914" rel="1" rev="77" score="1" target="time" unit="duration"/>
+    <level _seq="27" _title="Ghost Driver" _xpath="enigma_vii/duffy176_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy176" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="28" _title="Re-entry Circuit" _xpath="enigma_vii/pulley05_1" author="Mark Pulley" ctrl="force" easy="false" id="pulley05" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="29" _title="Not Fast Enough" _xpath="enigma_vii/jet04_3" author="James Taylor, Ronald Lamprecht" ctrl="force" easy="true" id="20070413jet001" rel="3" rev="3" score="3" target="time" unit="duration"/>
+    <level _seq="30" _title="Give Way" _xpath="enigma_vii/just20_1" author="JuSt" ctrl="force" easy="false" id="just20" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="31" _title="Give more Way" _xpath="enigma_vii/just21_2" author="JuSt" ctrl="force" easy="true" id="just21" rel="2" rev="3" score="2" target="time" unit="duration"/>
+    <level _seq="32" _title="Give Way 4 two" _xpath="enigma_vii/just22_2" author="JuSt" ctrl="force" easy="true" id="just22" rel="2" rev="2" score="2" target="time" unit="duration"/>
+    <level _seq="33" _title="Lost in Time and Space" _xpath="enigma_vii/just23_1" author="JuSt" ctrl="force" easy="false" id="just23" rel="1" rev="2" score="1" target="time" unit="duration"/>
+    <level _seq="34" _title="Alternatives?" _xpath="enigma_vii/just24_1" author="JuSt" ctrl="force" easy="true" id="just24" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="35" _title="No More Alternatives" _xpath="enigma_vii/just25_1" author="JuSt" ctrl="force" easy="true" id="just25" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="36" _title="The Walls" _xpath="enigma_vii/just26_1" author="JuSt" ctrl="force" easy="true" id="just26" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="37" _title="Pull the Puller" _xpath="enigma_vii/just28_1" author="JuSt" ctrl="force" easy="false" id="just28" rel="1" rev="2" score="1" target="time" unit="duration"/>
+    <level _seq="38" _title="Double Sense" _xpath="enigma_vii/joe14_1" author="Joseph Dunne" ctrl="force" easy="true" id="joe14" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="39" _title="Double Sense II" _xpath="enigma_vii/joe15_1" author="Joseph Dunne" ctrl="force" easy="true" id="joe15" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="40" _title="Lightyears" _xpath="enigma_vii/duffy177_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy177" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="41" _title="Zero Magnetism Lab" _xpath="enigma_vii/duffy178_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy178" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="42" _title="Armageddon" _xpath="enigma_vii/duffy179_1" author="Jacob Scott" ctrl="force" easy="true" id="duffy179" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="43" _title="Mountain Climbing II" _xpath="enigma_vii/joe25_1" author="Joseph Dunne" ctrl="force" easy="true" id="joe25" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="44" _title="Minor Tangler" _xpath="enigma_vii/joe24_1" author="Joseph Dunne" ctrl="force" easy="false" id="joe24" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="45" _title="Circulation" _xpath="enigma_vii/pulley03_2" author="Mark Pulley" ctrl="force" easy="false" id="pulley03" rel="2" rev="2" score="2" target="time" unit="duration"/>
+    <level _seq="46" _title="Maze for Two" _xpath="enigma_vii/ral22_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20071017ral096" rel="1" rev="84" score="1" target="time" unit="duration"/>
+    <level _seq="47" _title="Making Shapes" _xpath="enigma_vii/joe18_1" author="Joseph Dunne" ctrl="force" easy="false" id="joe18" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="48" _title="Clever Pushing" _xpath="enigma_vii/joe19_2" author="Joseph Dunne" ctrl="force" easy="false" id="joe19" rel="2" rev="1" score="2" target="time" unit="duration"/>
+    <level _seq="49" _title="Using Rotators" _xpath="enigma_vii/joe20_1" author="Joseph Dunne" ctrl="force" easy="false" id="joe20" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="50" _title="Swapping Puzzle" _xpath="enigma_vii/joe21_1" author="Joseph Dunne" ctrl="force" easy="false" id="joe21" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="51" _title="Swapping Puzzle II" _xpath="enigma_vii/joe22_1" author="Joseph Dunne" ctrl="force" easy="false" id="joe22" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="52" _title="Multiban" _xpath="enigma_vii/dpl01_1" author="Dominik Leipold" ctrl="force" easy="false" id="dpl01" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="53" _title="Riverside" _xpath="enigma_vii/johann02_2" author="Johann Freymuth" ctrl="force" easy="false" id="johann02" rel="2" rev="0" score="2" target="time" unit="duration"/>
+    <level _seq="54" _title="The Lone Ranger" _xpath="enigma_vii/pulley04_1" author="Mark Pulley" ctrl="force" easy="false" id="pulley04" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="55" _title="Little Shop Of Horrors" _xpath="enigma_vii/pulley07_1" author="Mark Pulley" ctrl="force" easy="false" id="pulley07" rel="1" rev="5" score="1" target="time" unit="duration"/>
+    <level _seq="56" _title="Spaceship Control" _xpath="enigma_vii/safalra01_1" author="Safalra" ctrl="force" easy="false" id="safalra01" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="57" _title="Ball Alley" _xpath="enigma_vii/johann01_1" author="Johann Freymuth" ctrl="force" easy="false" id="johann01" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="58" _title="Action Potential" _xpath="enigma_vii/pulley02_1" author="Mark Pulley" ctrl="force" easy="true" id="pulley02" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="59" _title="Remote Meditation" _xpath="enigma_vii/dpl02_1" author="Dominik Leipold" ctrl="force" easy="true" id="dpl02" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="60" _title="Triggered Triggers" _xpath="enigma_vii/just19_1" author="JuSt" ctrl="force" easy="true" id="just19" rel="1" rev="2" score="1" target="time" unit="duration"/>
+    <level _seq="61" _title="Lady in Red" _xpath="enigma_vii/just30_1" author="Just" ctrl="force" easy="true" id="just30" rel="1" rev="3" score="1" target="time" unit="duration"/>
+    <level _seq="62" _title="Crawling the Abyss" _xpath="enigma_vii/sph02_1" author="ShadowPhrogg32642342" ctrl="force" easy="true" id="sph02" rel="1" rev="5" score="1" target="time" unit="duration"/>
+    <level _seq="63" _title="Bold Boulder" _xpath="enigma_vii/ral14_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20061124ral279" rel="1" rev="96" score="1" target="time" unit="duration"/>
+    <level _seq="64" _title="Tinker, Tailor" _xpath="enigma_vii/andreas46_3" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas46" rel="4" rev="5" score="2" target="time" unit="duration"/>
+    <level _seq="65" _title="Elbow Society" _xpath="enigma_vii/andreas45_2" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas45" rel="2" rev="5" score="2" target="time" unit="duration"/>
+    <level _seq="66" _title="Watchmaker" _xpath="enigma_vii/huesing01_1" author="Johannes H?sing" ctrl="force" easy="false" id="huesing01" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="67" _title="Map it out II" _xpath="enigma_vii/manuel01_1" author="Manuel Eisentraut" ctrl="force" easy="true" id="manuel01" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="68" _title="Underground Temple" _xpath="enigma_vii/joe12_2" author="Joseph Dunne" ctrl="force" easy="true" id="joe_12" rel="2" rev="0" score="2" target="time" unit="duration"/>
+    <level _seq="69" _title="Mountain Climbing III" _xpath="enigma_vii/joe26_1" author="Joseph Dunne" ctrl="force" easy="true" id="joe26" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="70" _title="Recover the Stone" _xpath="enigma_vii/joe28_1" author="Joseph Dunne" ctrl="force" easy="false" id="joe28" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="71" _title="Pick-Up" _xpath="enigma_vii/joe27_1" author="Joseph Dunne" ctrl="force" easy="false" id="joe27" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="72" _title="A Kind of Magic" _xpath="enigma_vii/just37_1" author="JuSt" ctrl="force" easy="true" id="JuStA Kind of Magic" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="73" _title="Blue Screen Of Death" _xpath="enigma_vii/pulley10_2" author="Mark Pulley" ctrl="force" easy="true" id="pulley10" rel="2" rev="1" score="2" target="time" unit="duration"/>
+    <level _seq="74" _title="Audience in Venice" _xpath="enigma_vii/mecke09_1" author="mecke" ctrl="force" easy="true" id="mecke9" rel="1" rev="20" score="1" target="time" unit="duration"/>
+    <level _seq="75" _title="Black Liberation" _xpath="enigma_vii/mecke11_1" author="mecke" ctrl="force" easy="true" id="mecke11" rel="1" rev="25" score="1" target="time" unit="duration"/>
+    <level _seq="76" _title="Jack-Of-All-Trades" _xpath="enigma_vii/mecke12_1" author="mecke" ctrl="force" easy="true" id="mecke12" rel="1" rev="31" score="1" target="time" unit="duration"/>
+    <level _seq="77" _title="Enigmaparcour" _xpath="enigma_viii/mecke15_1" author="mecke" ctrl="force" easy="true" id="mecke15" rel="1" rev="21" score="1" target="time" unit="duration"/>
+    <level _seq="78" _title="Rhythm of Space" _xpath="enigma_viii/mecke20_1" author="mecke" ctrl="force" easy="true" id="mecke20" rel="1" rev="21" score="1" target="time" unit="duration"/>
+    <level _seq="79" _title="The Show Jumper" _xpath="enigma_viii/andreas47_1" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas47" rel="1" rev="4" score="1" target="time" unit="duration"/>
+    <level _seq="80" _title="The Red Room" _xpath="enigma_viii/joe29_1" author="Joseph Dunne" ctrl="force" easy="true" id="joe29" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="81" _title="Enigmines" _xpath="enigma_viii/huffman01_1" author="Brian Huffman" ctrl="force" easy="true" id="huffman01" rel="1" rev="2" score="1" target="time" unit="duration"/>
+    <level _seq="82" _title="Red Cave" _xpath="enigma_viii/mecke21_1" author="mecke" ctrl="force" easy="true" id="mecke21" rel="1" rev="30" score="1" target="time" unit="duration"/>
+    <level _seq="83" _title="Status code 302" _xpath="enigma_viii/dev02_1" author="/dev/null" ctrl="force" easy="true" id="dev02" rel="1" rev="4" score="1" target="time" unit="duration"/>
+    <level _seq="84" _title="A Screenful of Secrets" _xpath="enigma_viii/mecke01_1" author="mecke" ctrl="force" easy="true" id="mecke01" rel="1" rev="22" score="1" target="time" unit="duration"/>
+    <level _seq="85" _title="Southside Life" _xpath="enigma_viii/mecke10_1" author="mecke" ctrl="force" easy="true" id="mecke10" rel="1" rev="18" score="1" target="time" unit="duration"/>
+    <level _seq="86" _title="Joona's Chess" _xpath="enigma_viii/joona02_1" author="Joona Laire" ctrl="force" easy="true" id="joona02" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="87" _title="Helios I" _xpath="enigma_viii/mecke07_1" author="mecke" ctrl="force" easy="false" id="mecke48" rel="1" rev="12" score="1" target="time" unit="duration"/>
+    <level _seq="88" _title="The Green Hell" _xpath="enigma_viii/mecke22_1" author="mecke" ctrl="force" easy="true" id="mecke22" rel="1" rev="55" score="1" target="time" unit="duration"/>
+    <level _seq="89" _title="Tilt Board" _xpath="enigma_viii/ulf06_2" author="Ulf Stegemann" ctrl="force" easy="true" id="20080529ulf118" rel="2" rev="116" score="2" target="time" unit="duration"/>
+    <level _seq="90" _title="4 - 8 - 4" _xpath="enigma_viii/dpl03_3" author="Dominik Leipold" ctrl="force" easy="true" id="20070821dpl003" rel="3" rev="4" score="3" target="time" unit="duration"/>
+    <level _seq="91" _title="Impulsive Order" _xpath="enigma_viii/raywick05_1" author="Ray Wick" ctrl="force" easy="true" id="raywick5" rel="1" rev="5" score="1" target="time" unit="duration"/>
+    <level _seq="92" _title="Cross Mail" _xpath="enigma_viii/johann03_1" author="Johann Freymuth" ctrl="force" easy="false" id="johann03" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="93" _title="Color Maze" _xpath="enigma_viii/pulley16_3" author="Mark Pulley" ctrl="force" easy="false" id="pulley16" rel="3" rev="4" score="3" target="time" unit="duration"/>
+    <level _seq="94" _title="Earthlink" _xpath="enigma_viii/pulley15_1" author="Mark Pulley" ctrl="force" easy="true" id="pulley15" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="95" _title="Vanity's Constrictions" _xpath="enigma_viii/andreas53_2" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas53" rel="2" rev="5" score="2" target="time" unit="duration"/>
+    <level _seq="96" _title="Wired" _xpath="enigma_viii/andreas49_1" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas49" rel="1" rev="4" score="1" target="time" unit="duration"/>
+    <level _seq="97" _title="Push Wires" _xpath="enigma_viii/ral24_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20080708ral196" rel="1" rev="100" score="1" target="time" unit="duration"/>
+    <level _seq="98" _title="Wired Five" _xpath="enigma_viii/ral25_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20080721ral073" rel="1" rev="109" score="1" target="time" unit="duration"/>
+    <level _seq="99" _title="Wireban Premiere" _xpath="enigma_viii/ral26_1" author="Ronald Lamprecht" ctrl="force" easy="false" id="20080715ral161" rel="1" rev="106" score="1" target="time" unit="duration"/>
+    <level _seq="100" _title="Microwire" _xpath="enigma_viii/ral27_1" author="Ronald Lamprecht" ctrl="force" easy="false" id="20080717ral427" rel="1" rev="107" score="1" target="time" unit="duration"/>
+    <level _seq="101" _title="More Microwire" _xpath="enigma_viii/ral28_1" author="Ronald Lamprecht" ctrl="force" easy="false" id="20080717ral282" rel="1" rev="105" score="1" target="time" unit="duration"/>
+    <level _seq="102" _title="Freestyle Microwire" _xpath="enigma_viii/ral29_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20080719ral530" rel="1" rev="107" score="1" target="time" unit="duration"/>
+    <level _seq="103" _title="Balance Beam" _xpath="enigma_viii/mecke03_1" author="mecke" ctrl="force" easy="true" id="mecke03" rel="1" rev="29" score="1" target="time" unit="duration"/>
+    <level _seq="104" _title="Colored Oxyds" _xpath="enigma_viii/andreas50_1" author="Andreas Lochmann" ctrl="force" easy="false" id="andreas50" rel="1" rev="2" score="1" target="time" unit="duration"/>
+    <level _seq="105" _title="Fashions Pass" _xpath="enigma_viii/andreas48_2" author="Andreas Lochmann" ctrl="force" easy="false" id="andreas48" rel="2" rev="3" score="2" target="time" unit="duration"/>
+    <level _seq="106" _title="Colored Turnstiles" _xpath="enigma_viii/andreas51_1" author="Andreas Lochmann" ctrl="force" easy="false" id="andreas51" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="107" _title="Sanssouci" _xpath="enigma_viii/mecke05_1" author="mecke" ctrl="force" easy="true" id="mecke05" rel="1" rev="23" score="1" target="time" unit="duration"/>
   </levels>
 
 </index>

Modified: trunk/data/levels/enigma_i/alain04_1.xml
===================================================================
--- trunk/data/levels/enigma_i/alain04_1.xml	2008-08-24 14:00:53 UTC (rev 1288)
+++ trunk/data/levels/enigma_i/alain04_1.xml	2008-08-25 21:27:20 UTC (rev 1289)
@@ -3,7 +3,7 @@
   <el:protected>
     <el:info el:type="level">
       <el:identity el:title="- Meditation -" el:subtitle="" el:id="alain04"/>
-      <el:version el:score="1" el:release="1" el:revision="1" el:status="released"/>
+      <el:version el:score="1" el:release="1" el:revision="2" el:status="released"/>
       <el:author  el:name="Alain Busser" el:email="" el:homepage=""/>
       <el:copyright>Copyright ? 2006 Alain Busser</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
@@ -32,45 +32,45 @@
         elseif c == "o" then
             oxyd( i-1, line)
             elseif c == "a" then
-            set_item("it-wormhole",i-1,line, {targetx=13.5, targety=10+random(10)/10, strength=0, range=0})          
+            set_item("it-wormhole",i-1,line, {targetx=13+random(6)/8, targety=10+random(6)/8, strength=0, range=0})
         elseif c == "b" then
-            set_item("it-wormhole",i-1,line, {targetx=4.5, targety=3+random(10)/10, strength=0, range=0})          
+            set_item("it-wormhole",i-1,line, {targetx=4+random(6)/8, targety=3+random(6)/8, strength=0, range=0})
             elseif c == "c" then
-            set_item("it-wormhole",i-1,line, {targetx=16.5, targety=4+random(10)/10, strength=0, range=0})          
+            set_item("it-wormhole",i-1,line, {targetx=16+random(6)/8, targety=4+random(6)/8, strength=0, range=0})
         elseif c == "d" then
-            set_item("it-wormhole",i-1,line, {targetx=6.5, targety=10+random(10)/10, strength=0, range=0})          
+            set_item("it-wormhole",i-1,line, {targetx=6+random(6)/8, targety=10+random(6)/8, strength=0, range=0})
             elseif c == "e" then
-            set_item("it-wormhole",i-1,line, {targetx=13.5, targety=3+random(10)/10, strength=0, range=0})          
+            set_item("it-wormhole",i-1,line, {targetx=13+random(6)/8, targety=3+random(6)/8, strength=0, range=0})
         elseif c == "f" then
-            set_item("it-wormhole",i-1,line, {targetx=4.5, targety=10+random(10)/10, strength=0, range=0})          
+            set_item("it-wormhole",i-1,line, {targetx=4+random(6)/8, targety=10+random(6)/8, strength=0, range=0})
             elseif c == "g" then
-            set_item("it-wormhole",i-1,line, {targetx=16.5, targety=9+random(10)/10, strength=0, range=0})          
+            set_item("it-wormhole",i-1,line, {targetx=16+random(6)/8, targety=9+random(6)/8, strength=0, range=0})
         elseif c == "h" then
-            set_item("it-wormhole",i-1,line, {targetx=6.5, targety=3+random(10)/10, strength=0, range=0})          
+            set_item("it-wormhole",i-1,line, {targetx=6+random(6)/8, targety=3+random(6)/8, strength=0, range=0})
         elseif c == "i" then
-            set_item("it-wormhole",i-1,line, {targetx=13.5, targety=10+random(10)/10, strength=0, range=0})          
+            set_item("it-wormhole",i-1,line, {targetx=13+random(6)/8, targety=10+random(6)/8, strength=0, range=0})
         elseif c == "j" then
-            set_item("it-wormhole",i-1,line, {targetx=4.5, targety=3+random(10)/10, strength=0, range=0})          
+            set_item("it-wormhole",i-1,line, {targetx=4+random(6)/8, targety=3+random(6)/8, strength=0, range=0})
             elseif c == "k" then
-            set_item("it-wormhole",i-1,line, {targetx=16.5, targety=4+random(10)/10, strength=0, range=0})          
+            set_item("it-wormhole",i-1,line, {targetx=16+random(6)/8, targety=4+random(6)/8, strength=0, range=0})
         elseif c == "l" then
-            set_item("it-wormhole",i-1,line, {targetx=6.5, targety=10+random(10)/10, strength=0, range=0})          
+            set_item("it-wormhole",i-1,line, {targetx=6+random(6)/8, targety=10+random(6)/8, strength=0, range=0})
             elseif c == "m" then
-            set_item("it-wormhole",i-1,line, {targetx=13.5, targety=3+random(10)/10, strength=0, range=0})          
+            set_item("it-wormhole",i-1,line, {targetx=13+random(6)/8, targety=3+random(6)/8, strength=0, range=0})
         elseif c == "n" then
-            set_item("it-wormhole",i-1,line, {targetx=4.5, targety=10+random(10)/10, strength=0, range=0})          
+            set_item("it-wormhole",i-1,line, {targetx=4+random(6)/8, targety=10+random(6)/8, strength=0, range=0})
             elseif c == "p" then
-            set_item("it-wormhole",i-1,line, {targetx=16.5, targety=9+random(10)/10, strength=0, range=0})          
+            set_item("it-wormhole",i-1,line, {targetx=16+random(6)/8, targety=9+random(6)/8, strength=0, range=0})
         elseif c == "q" then
-            set_item("it-wormhole",i-1,line, {targetx=6.5, targety=3+random(10)/10, strength=0, range=0})          
+            set_item("it-wormhole",i-1,line, {targetx=6+random(6)/8, targety=3+random(6)/8, strength=0, range=0})
           elseif c=="z" then
-            set_actor("ac-whiteball-small", i-.5,line+.5, {player=0})
+            set_actor("ac-whiteball-small", i-0.5,line+0+0.5, {player=0})
         elseif c=="+" then
             set_item("it-hollow", i-1, line)
         elseif c=="*" then
             set_stone("st-actorimpulse_invisible", i-1,line)
         end
-    end    
+    end
 end
 
 --               01234567890123456789

Modified: trunk/data/levels/enigma_i/index.xml
===================================================================
--- trunk/data/levels/enigma_i/index.xml	2008-08-24 14:00:53 UTC (rev 1288)
+++ trunk/data/levels/enigma_i/index.xml	2008-08-25 21:27:20 UTC (rev 1289)
@@ -1,7 +1,7 @@
 <?xml version="1.0" encoding="UTF-8" standalone="no" ?>
 <index xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="index.xsd">
 
-  <info enigma="1.00" group="Enigma" location="10200" network="false" owner="Enigma Team" release="1" revision="8" title="Enigma I"/>
+  <info enigma="1.00" group="Enigma" location="10200" network="false" owner="Enigma Team" release="1" revision="9" title="Enigma I"/>
 
   <attributes/>
 
@@ -45,7 +45,7 @@
     <level _seq="37" _title=".J.U.M.P." _xpath="./martin60_1" author="Martin Hawlisch" ctrl="force" easy="false" id="martin60" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="38" _title="Encased" _xpath="./xerxes01_1" author="Xerxes M. Dynatos" ctrl="force" easy="false" id="xerxes01" rel="1" rev="2" score="1" target="time" unit="duration"/>
     <level _seq="39" _title="Without Tremor" _xpath="./richi04_1" author="Richi B?tzer" ctrl="force" easy="false" id="richi04" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="40" _title="- Meditation -" _xpath="./alain04_1" author="Alain Busser" ctrl="force" easy="false" id="alain04" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="40" _title="- Meditation -" _xpath="./alain04_1" author="Alain Busser" ctrl="force" easy="false" id="alain04" rel="1" rev="2" score="1" target="time" unit="duration"/>
     <level _seq="41" _title="Light Barrier" _xpath="./richi03_1" author="Richi B?tzer" ctrl="force" easy="false" id="richi03" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="42" _title="Basement" _xpath="./siegfried26_1" author="Siegfried Fennig" ctrl="force" easy="false" id="level9c" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="43" _title="Sokoban Revival" _xpath="./martin04_1" author="Martin Hawlisch" ctrl="force" easy="false" id="martin04" rel="1" rev="0" score="1" target="time" unit="duration"/>

Deleted: trunk/data/levels/enigma_vii/duffy175_1.xml
===================================================================
--- trunk/data/levels/enigma_vii/duffy175_1.xml	2008-08-24 14:00:53 UTC (rev 1288)
+++ trunk/data/levels/enigma_vii/duffy175_1.xml	2008-08-25 21:27:20 UTC (rev 1289)
@@ -1,672 +0,0 @@
-<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
-<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
-  <el:protected>
-    <el:info el:type="level">
-      <el:identity el:title="The Pearl Necklet" el:subtitle="" el:id="duffy175"/>
-      <el:version el:score="1" el:release="1" el:revision="0" el:status="released"/>
-      <el:author  el:name="Jacob Scott" el:email="" el:homepage=""/>
-      <el:copyright>Copyright ? 2007 Jacob Scott</el:copyright>
-      <el:license el:type="GPL v2.0 or above" el:open="true"/>
-      <el:compatibility el:enigma="0.92">
-      </el:compatibility>
-      <el:modes el:easy="false" el:single="true" el:network="false"/>
-      <el:score el:easy="-" el:difficult="-"/>
-    </el:info>
-    <el:luamain><![CDATA[
-rooms_wide=2
-rooms_high=1
-
-levelw=1+(19*rooms_wide)
-levelh=1+(12*rooms_high)
-
-create_world( levelw, levelh)
-enigma.ConserveLevel = 0
-
-fill_floor("fl-black", 0,0,levelw,levelh)
-
-function renderLine( line, pattern)
-    for i=1, strlen(pattern) do
-        local c = strsub( pattern, i, i)
-        if c =="#" then
-            set_stone( "st-rock6", i-1, line)
-        elseif c =="0" then
-            set_stone( "st-greenbrown_move", i-1, line,{name="b0"})
-        elseif c =="1" then
-            set_stone( "st-rock1_move", i-1, line,{name="b1"})
-        elseif c =="2" then
-            set_stone( "st-marble_move", i-1, line,{name="b2"})
-        elseif c =="3" then
-            set_stone( "st-brownie", i-1, line,{name="b3"})
-        elseif c =="4" then
-            set_stone("st-puzzle-nesw",i-1,line,{name="b4"})
-        elseif c =="5" then
-            set_stone( "st-glass_move", i-1, line,{name="b5"})
-        elseif c =="6" then
-            set_stone( "st-wood", i-1, line,{name="b6"})
-        elseif c =="7" then
-            set_stone( "st-shogun-s", i-1, line,{name="b7"})
-        elseif c =="8" then
-            set_stone( "st-rock3_move", i-1, line,{name="b8"})
-        elseif c =="9" then
-            set_stone( "st-block", i-1, line,{name="b9"})
-        elseif c =="k" then
-            set_stone( "st-greenbrown_move", i-1, line)
-        elseif c =="l" then
-            set_stone( "st-rock1_move", i-1, line)
-        elseif c =="m" then
-            set_stone( "st-marble_move", i-1, line)
-        elseif c =="n" then
-            set_stone( "st-brownie", i-1, line)
-        elseif c =="$" then
-            set_stone("st-puzzle-nesw",i-1,line)
-        elseif c =="p" then
-            set_stone( "st-glass_move", i-1, line)
-        elseif c =="q" then
-            set_stone( "st-wood", i-1, line)
-        elseif c =="r" then
-            set_stone( "st-shogun-s", i-1, line)
-        elseif c =="s" then
-            set_stone( "st-rock3_move", i-1, line)
-        elseif c =="t" then
-            set_stone( "st-block", i-1, line)
-        elseif c == "o" then
-            oxyd( i-1, line)
-        elseif c == "*" then
-            set_stone( "st-brownie", i-1, line)
-        elseif c == "!" then
-            abyss(i-1,line)
-        elseif c == "~" then
-            set_floor("fl-water",i-1,line)
-        elseif c=="z" then
-            set_actor("ac-blackball", i-.5,line+.5, {player=0})
-        elseif c=="y" then
-            set_actor("ac-whiteball", i-1,line+.5, {player=1})
-        elseif c == "g" then
-            draw_stones("st-grate1",{i-1,line}, {1,1}, 1)
-        elseif c=="+" then
-            set_stone( "st-wood", i-1, line)
-        elseif c=="=" then
-            set_floor("fl-space",i-1,line)
-        elseif c=="a" then
-            set_item("it-trigger",i-1,line,{action="callback",target="funcca"})
-        elseif c=="b" then
-            set_item("it-trigger",i-1,line,{action="callback",target="funcca"})
-        elseif c=="c" then
-            set_item("it-trigger",i-1,line,{action="callback",target="funcca"})
-        elseif c=="d" then
-            set_item("it-trigger",i-1,line,{action="callback",target="funcca"})
-        elseif c=="e" then
-            set_item("it-trigger",i-1,line,{action="callback",target="funcca"})
-        elseif c=="f" then
-            set_item("it-trigger",i-1,line,{action="callback",target="funcca"})
-        elseif c=="`" then
-            set_item("it-trigger",i-1,line,{action="callback",target="funcca"})
-        elseif c=="h" then
-            set_item("it-trigger",i-1,line,{action="callback",target="funcca"})
-        elseif c=="i" then
-            set_item("it-trigger",i-1,line,{action="callback",target="funcca"})
-        elseif c=="j" then
-            set_item("it-trigger",i-1,line,{action="callback",target="funcca"})
-        elseif c=="A" then
-            set_attrib(laser(i-1,line, FALSE, NORTH), "name", "l1a")
-        elseif c=="B" then
-            set_attrib(laser(i-1,line, FALSE, SOUTH), "name", "l1b")
-        elseif c=="C" then
-            set_attrib(laser(i-1,line, FALSE, NORTH), "name", "l2a")
-        elseif c=="D" then
-            set_attrib(laser(i-1,line, FALSE, SOUTH), "name", "l2b")
-        elseif c=="E" then
-            set_attrib(laser(i-1,line, FALSE, NORTH), "name", "l3a")
-        elseif c=="F" then
-            set_attrib(laser(i-1,line, FALSE, SOUTH), "name", "l3b")
-        elseif c=="G" then
-            set_attrib(laser(i-1,line, FALSE, NORTH), "name", "l4a")
-        elseif c=="H" then
-            set_attrib(laser(i-1,line, FALSE, SOUTH), "name", "l4b")
-        elseif c=="I" then
-            set_attrib(laser(i-1,line, FALSE, NORTH), "name", "l5a")
-        elseif c=="J" then
-            set_attrib(laser(i-1,line, FALSE, SOUTH), "name", "l5b")
-        elseif c=="K" then
-            set_attrib(laser(i-1,line, FALSE, NORTH), "name", "l6a")
-        elseif c=="L" then
-            set_attrib(laser(i-1,line, FALSE, SOUTH), "name", "l6b")
-        elseif c=="M" then
-            set_attrib(laser(i-1,line, FALSE, NORTH), "name", "l7a")
-        elseif c=="N" then
-            set_attrib(laser(i-1,line, FALSE, SOUTH), "name", "l7b")
-        elseif c=="O" then
-            set_attrib(laser(i-1,line, FALSE, NORTH), "name", "l8a")
-        elseif c=="P" then
-            set_attrib(laser(i-1,line, FALSE, SOUTH), "name", "l8b")
-        elseif c=="Q" then
-            set_attrib(laser(i-1,line, FALSE, NORTH), "name", "l9a")
-        elseif c=="R" then
-            set_attrib(laser(i-1,line, FALSE, SOUTH), "name", "l9b")
-        elseif c=="U" then
-           doorv(i-1,line,{name="d1"})
-        end
-    end    
-end
-
-renderLine(00,"#######################################")
-renderLine(01,"#        klmn$pqrst                 #o#")
-renderLine(02,"#                                   # #")
-renderLine(03,"#                                   # #")
-renderLine(04,"#                                   # #")
-renderLine(05,"#    A C E G I K M O Q              # #")
-renderLine(06,"# z a#b#c#d#e#f#`#h#i#j 0123456789  U #")
-renderLine(07,"#    B D F H J L N P R              # #")
-renderLine(08,"#                                   # #")
-renderLine(09,"#                                   # #")
-renderLine(10,"#                                   # #")
-renderLine(11,"#        klmn$pqrst                 #o#")
-renderLine(12,"#######################################")
-
-oxyd_shuffle()
-
-b0=enigma.GetNamedObject("b0")
-b1=enigma.GetNamedObject("b1")
-b2=enigma.GetNamedObject("b2")
-b3=enigma.GetNamedObject("b3")
-b4=enigma.GetNamedObject("b4")
-b5=enigma.GetNamedObject("b5")
-b6=enigma.GetNamedObject("b6")
-b7=enigma.GetNamedObject("b7")
-b8=enigma.GetNamedObject("b8")
-b9=enigma.GetNamedObject("b9")
-
-l1a=enigma.GetNamedObject("l1a")
-l1b=enigma.GetNamedObject("l1b")
-l2a=enigma.GetNamedObject("l2a")
-l2b=enigma.GetNamedObject("l2b")
-l3a=enigma.GetNamedObject("l3a")
-l3b=enigma.GetNamedObject("l3b")
-l4a=enigma.GetNamedObject("l4a")
-l4b=enigma.GetNamedObject("l4b")
-l5a=enigma.GetNamedObject("l5a")
-l5b=enigma.GetNamedObject("l5b")
-l6a=enigma.GetNamedObject("l6a")
-l6b=enigma.GetNamedObject("l6b")
-l7a=enigma.GetNamedObject("l7a")
-l7b=enigma.GetNamedObject("l7b")
-l8a=enigma.GetNamedObject("l8a")
-l8b=enigma.GetNamedObject("l8b")
-l9a=enigma.GetNamedObject("l9a")
-l9b=enigma.GetNamedObject("l9b")
-
-d1=enigma.GetNamedObject("d1")
-
-p0=-1
-p1=-1
-p2=-1
-p3=-1
-p4=-1
-p5=-1
-p6=-1
-p7=-1
-p8=-1
-p9=-1
-
-function funcccheck()
-    p01=(p0)..(p1)
-    if p01=="10" or p01=="11" or p01=="13" or p01=="14" or p01=="17" or p01=="19" or p01=="22" or p01=="23" or p01=="26" or p01=="29" or p01=="31" or p01=="33" or p01=="34" or p01=="37" or p01=="38" or p01=="39" or p01=="41" or p01=="43" or p01=="46" or p01=="47" or p01=="53" or p01=="58" or p01=="59" or p01=="61" or p01=="62" or p01=="67" or p01=="71" or p01=="73" or p01=="74" or p01=="79" or p01=="82" or p01=="83" or p01=="86" or p01=="89" or p01=="94" or p01=="97" then
-        enigma.SendMessage(l1a,"on",nil)
-        enigma.SendMessage(l1b,"on",nil)
-        c01=1
-    else
-        enigma.SendMessage(l1a,"off",nil)
-        enigma.SendMessage(l1b,"off",nil)
-        c01=0
-    end
-
-    p12=(p1)..(p2)
-    if p12=="02" or p12=="03" or p12=="04"  or p12=="05" or p12=="06" or p12=="07" or p12=="10" or p12=="11" or p12=="13" or p12=="14" or p12=="17" or p12=="19" or p12=="22" or p12=="23" or p12=="26" or p12=="29" or p12=="31" or p12=="33" or p12=="34" or p12=="37" or p12=="38" or p12=="39" or p12=="41" or p12=="43" or p12=="46" or p12=="47" or p12=="53" or p12=="58" or p12=="59" or p12=="61" or p12=="62" or p12=="67" or p12=="71" or p12=="73" or p12=="74" or p12=="79" or p12=="82" or p12=="83" or p12=="86" or p12=="89" or p12=="94" or p12=="97" then
-        enigma.SendMessage(l2a,"on",nil)
-        enigma.SendMessage(l2b,"on",nil)
-        c12=1
-    else
-        enigma.SendMessage(l2a,"off",nil)
-        enigma.SendMessage(l2b,"off",nil)
-        c12=0
-    end
-
-    p23=(p2)..(p3)
-    if p23=="02" or p23=="03" or p23=="04"  or p23=="05" or p23=="06" or p23=="07" or p23=="10" or p23=="11" or p23=="13" or p23=="14" or p23=="17" or p23=="19" or p23=="22" or p23=="23" or p23=="26" or p23=="29" or p23=="31" or p23=="33" or p23=="34" or p23=="37" or p23=="38" or p23=="39" or p23=="41" or p23=="43" or p23=="46" or p23=="47" or p23=="53" or p23=="58" or p23=="59" or p23=="61" or p23=="62" or p23=="67" or p23=="71" or p23=="73" or p23=="74" or p23=="79" or p23=="82" or p23=="83" or p23=="86" or p23=="89" or p23=="94" or p23=="97" then
-        enigma.SendMessage(l3a,"on",nil)
-        enigma.SendMessage(l3b,"on",nil)
-        c23=1
-    else
-        enigma.SendMessage(l3a,"off",nil)
-        enigma.SendMessage(l3b,"off",nil)
-        c23=0
-    end
-
-    p34=(p3)..(p4)
-    if p34=="02" or p34=="03" or p34=="04"  or p34=="05" or p34=="06" or p34=="07" or p34=="10" or p34=="11" or p34=="13" or p34=="14" or p34=="17" or p34=="19" or p34=="22" or p34=="23" or p34=="26" or p34=="29" or p34=="31" or p34=="33" or p34=="34" or p34=="37" or p34=="38" or p34=="39" or p34=="41" or p34=="43" or p34=="46" or p34=="47" or p34=="53" or p34=="58" or p34=="59" or p34=="61" or p34=="62" or p34=="67" or p34=="71" or p34=="73" or p34=="74" or p34=="79" or p34=="82" or p34=="83" or p34=="86" or p34=="89" or p34=="94" or p34=="97" then
-        enigma.SendMessage(l4a,"on",nil)
-        enigma.SendMessage(l4b,"on",nil)
-        c34=1
-    else
-        enigma.SendMessage(l4a,"off",nil)
-        enigma.SendMessage(l4b,"off",nil)
-        c34=0
-    end
-
-    p45=(p4)..(p5)
-    if p45=="02" or p45=="03" or p45=="04"  or p45=="05" or p45=="06" or p45=="07" or p45=="10" or p45=="11" or p45=="13" or p45=="14" or p45=="17" or p45=="19" or p45=="22" or p45=="23" or p45=="26" or p45=="29" or p45=="31" or p45=="33" or p45=="34" or p45=="37" or p45=="38" or p45=="39" or p45=="41" or p45=="43" or p45=="46" or p45=="47" or p45=="53" or p45=="58" or p45=="59" or p45=="61" or p45=="62" or p45=="67" or p45=="71" or p45=="73" or p45=="74" or p45=="79" or p45=="82" or p45=="83" or p45=="86" or p45=="89" or p45=="94" or p45=="97" then
-        enigma.SendMessage(l5a,"on",nil)
-        enigma.SendMessage(l5b,"on",nil)
-        c45=1
-    else
-        enigma.SendMessage(l5a,"off",nil)
-        enigma.SendMessage(l5b,"off",nil)
-        c45=0
-    end
-
-    p56=(p5)..(p6)
-    if p56=="02" or p56=="03" or p56=="04"  or p56=="05" or p56=="06" or p56=="07" or p56=="10" or p56=="11" or p56=="13" or p56=="14" or p56=="17" or p56=="19" or p56=="22" or p56=="23" or p56=="26" or p56=="29" or p56=="31" or p56=="33" or p56=="34" or p56=="37" or p56=="38" or p56=="39" or p56=="41" or p56=="43" or p56=="46" or p56=="47" or p56=="53" or p56=="58" or p56=="59" or p56=="61" or p56=="62" or p56=="67" or p56=="71" or p56=="73" or p56=="74" or p56=="79" or p56=="82" or p56=="83" or p56=="86" or p56=="89" or p56=="94" or p56=="97" then
-        enigma.SendMessage(l6a,"on",nil)
-        enigma.SendMessage(l6b,"on",nil)
-        c56=1
-    else
-        enigma.SendMessage(l6a,"off",nil)
-        enigma.SendMessage(l6b,"off",nil)
-        c56=0
-    end
-
-    p67=(p6)..(p7)
-    if p67=="02" or p67=="03" or p67=="04"  or p67=="05" or p67=="06" or p67=="07" or p67=="10" or p67=="11" or p67=="13" or p67=="14" or p67=="17" or p67=="19" or p67=="22" or p67=="23" or p67=="26" or p67=="29" or p67=="31" or p67=="33" or p67=="34" or p67=="37" or p67=="38" or p67=="39" or p67=="41" or p67=="43" or p67=="46" or p67=="47" or p67=="53" or p67=="58" or p67=="59" or p67=="61" or p67=="62" or p67=="67" or p67=="71" or p67=="73" or p67=="74" or p67=="79" or p67=="82" or p67=="83" or p67=="86" or p67=="89" or p67=="94" or p67=="97" then
-        enigma.SendMessage(l7a,"on",nil)
-        enigma.SendMessage(l7b,"on",nil)
-        c67=1
-    else
-        enigma.SendMessage(l7a,"off",nil)
-        enigma.SendMessage(l7b,"off",nil)
-        c67=0
-    end
-
-    p78=(p7)..(p8)
-    if p78=="02" or p78=="03" or p78=="04"  or p78=="05" or p78=="06" or p78=="07" or p78=="10" or p78=="11" or p78=="13" or p78=="14" or p78=="17" or p78=="19" or p78=="22" or p78=="23" or p78=="26" or p78=="29" or p78=="31" or p78=="33" or p78=="34" or p78=="37" or p78=="38" or p78=="39" or p78=="41" or p78=="43" or p78=="46" or p78=="47" or p78=="53" or p78=="58" or p78=="59" or p78=="61" or p78=="62" or p78=="67" or p78=="71" or p78=="73" or p78=="74" or p78=="79" or p78=="82" or p78=="83" or p78=="86" or p78=="89" or p78=="94" or p78=="97" then
-        enigma.SendMessage(l8a,"on",nil)
-        enigma.SendMessage(l8b,"on",nil)
-        c78=1
-    else
-        enigma.SendMessage(l8a,"off",nil)
-        enigma.SendMessage(l8b,"off",nil)
-        c78=0
-    end
-
-    p89=(p8)..(p9)
-    if p89=="02" or p89=="03" or p89=="04"  or p89=="05" or p89=="06" or p89=="07" or p89=="10" or p89=="11" or p89=="13" or p89=="14" or p89=="17" or p89=="19" or p89=="22" or p89=="23" or p89=="26" or p89=="29" or p89=="31" or p89=="33" or p89=="34" or p89=="37" or p89=="38" or p89=="39" or p89=="41" or p89=="43" or p89=="46" or p89=="47" or p89=="53" or p89=="58" or p89=="59" or p89=="61" or p89=="62" or p89=="67" or p89=="71" or p89=="73" or p89=="74" or p89=="79" or p89=="82" or p89=="83" or p89=="86" or p89=="89" or p89=="94" or p89=="97" then
-        enigma.SendMessage(l9a,"on",nil)
-        enigma.SendMessage(l9b,"on",nil)
-        c89=1
-    else
-        enigma.SendMessage(l9a,"off",nil)
-        enigma.SendMessage(l9b,"off",nil)
-        c89=0
-    end
-
-    if ((c01+c12+c23+c34+c45+c56+c67+c78+c89)==9) then
-        enigma.SendMessage(d1,"open",nil)
-    else
-        enigma.SendMessage(d1,"close",nil)
-    end
-end
-
-function funcca()
-    xx0,yy0=enigma.GetPos(b0)
-    xx1,yy1=enigma.GetPos(b1)
-    xx2,yy2=enigma.GetPos(b2)
-    xx3,yy3=enigma.GetPos(b3)
-    xx4,yy4=enigma.GetPos(b4)
-    xx5,yy5=enigma.GetPos(b5)
-    xx6,yy6=enigma.GetPos(b6)
-    xx7,yy7=enigma.GetPos(b7)
-    xx8,yy8=enigma.GetPos(b8)
-    xx9,yy9=enigma.GetPos(b9)
-
-    if not((xx0==4 and yy0==6) or (xx1==4 and yy1==6) or (xx2==4 and yy2==6) or (xx3==4 and yy3==6) or (xx4==4 and yy4==6) or (xx5==4 and yy5==6) or (xx6==4 and yy6==6) or (xx7==4 and yy7==6) or (xx8==4 and yy8==6) or (xx9==4 and yy9==6)) then
-        p0=-1
-    end
-    if not((xx0==6 and yy0==6) or (xx1==6 and yy1==6) or (xx2==6 and yy2==6) or (xx3==6 and yy3==6) or (xx4==6 and yy4==6) or (xx5==6 and yy5==6) or (xx6==6 and yy6==6) or (xx7==6 and yy7==6) or (xx8==6 and yy8==6) or (xx9==6 and yy9==6)) then
-        p1=-1
-    end
-    if not((xx0==8 and yy0==6) or (xx1==8 and yy1==6) or (xx2==8 and yy2==6) or (xx3==8 and yy3==6) or (xx4==8 and yy4==6) or (xx5==8 and yy5==6) or (xx6==8 and yy6==6) or (xx7==8 and yy7==6) or (xx8==8 and yy8==6) or (xx9==8 and yy9==6)) then
-        p2=-1
-    end
-    if not((xx0==10 and yy0==6) or (xx1==10 and yy1==6) or (xx2==10 and yy2==6) or (xx3==10 and yy3==6) or (xx4==10 and yy4==6) or (xx5==10 and yy5==6) or (xx6==10 and yy6==6) or (xx7==10 and yy7==6) or (xx8==10 and yy8==6) or (xx9==10 and yy9==6)) then
-        p3=-1
-    end
-    if not((xx0==12 and yy0==6) or (xx1==12 and yy1==6) or (xx2==12 and yy2==6) or (xx3==12 and yy3==6) or (xx4==12 and yy4==6) or (xx5==12 and yy5==6) or (xx6==12 and yy6==6) or (xx7==12 and yy7==6) or (xx8==12 and yy8==6) or (xx9==12 and yy9==6)) then
-        p4=-1
-    end
-    if not((xx0==14 and yy0==6) or (xx1==14 and yy1==6) or (xx2==14 and yy2==6) or (xx3==14 and yy3==6) or (xx4==14 and yy4==6) or (xx5==14 and yy5==6) or (xx6==14 and yy6==6) or (xx7==14 and yy7==6) or (xx8==14 and yy8==6) or (xx9==14 and yy9==6)) then
-        p5=-1
-    end
-    if not((xx0==16 and yy0==6) or (xx1==16 and yy1==6) or (xx2==16 and yy2==6) or (xx3==16 and yy3==6) or (xx4==16 and yy4==6) or (xx5==16 and yy5==6) or (xx6==16 and yy6==6) or (xx7==16 and yy7==6) or (xx8==16 and yy8==6) or (xx9==16 and yy9==6)) then
-        p6=-1
-    end
-    if not((xx0==18 and yy0==6) or (xx1==18 and yy1==6) or (xx2==18 and yy2==6) or (xx3==18 and yy3==6) or (xx4==18 and yy4==6) or (xx5==18 and yy5==6) or (xx6==18 and yy6==6) or (xx7==18 and yy7==6) or (xx8==18 and yy8==6) or (xx9==18 and yy9==6)) then
-        p7=-1
-    end
-    if not((xx0==20 and yy0==6) or (xx1==20 and yy1==6) or (xx2==20 and yy2==6) or (xx3==20 and yy3==6) or (xx4==20 and yy4==6) or (xx5==20 and yy5==6) or (xx6==20 and yy6==6) or (xx7==20 and yy7==6) or (xx8==20 and yy8==6) or (xx9==20 and yy9==6)) then
-        p8=-1
-    end
-    if not((xx0==22 and yy0==6) or (xx1==22 and yy1==6) or (xx2==22 and yy2==6) or (xx3==22 and yy3==6) or (xx4==22 and yy4==6) or (xx5==22 and yy5==6) or (xx6==22 and yy6==6) or (xx7==22 and yy7==6) or (xx8==22 and yy8==6) or (xx9==22 and yy9==6)) then
-        p9=-1
-    end
-    if xx0==4 and yy0==6 then
-        p0=0
-    end
-    if xx0==6 and yy0==6 then
-        p1=0
-    end
-    if xx0==8 and yy0==6 then
-        p2=0
-    end
-    if xx0==10 and yy0==6 then
-        p3=0
-    end
-    if xx0==12 and yy0==6 then
-        p4=0
-    end
-    if xx0==14 and yy0==6 then
-        p5=0
-    end
-    if xx0==16 and yy0==6 then
-        p6=0
-    end
-    if xx0==18 and yy0==6 then
-        p7=0
-    end
-    if xx0==20 and yy0==6 then
-        p8=0
-    end
-    if xx0==22 and yy0==6 then
-        p9=0
-    end
-    if xx1==4 and yy1==6 then
-        p0=1
-    end
-    if xx1==6 and yy1==6 then
-        p1=1
-    end
-    if xx1==8 and yy1==6 then
-        p2=1
-    end
-    if xx1==10 and yy1==6 then
-        p3=1
-    end
-    if xx1==12 and yy1==6 then
-        p4=1
-    end
-    if xx1==14 and yy1==6 then
-        p5=1
-    end
-    if xx1==16 and yy1==6 then
-        p6=1
-    end
-    if xx1==18 and yy1==6 then
-        p7=1
-    end
-    if xx1==20 and yy1==6 then
-        p8=1
-    end
-    if xx1==22 and yy1==6 then
-        p9=1
-    end
-    if xx2==4 and yy2==6 then
-        p0=2
-    end
-    if xx2==6 and yy2==6 then
-        p1=2
-    end
-    if xx2==8 and yy2==6 then
-        p2=2
-    end
-    if xx2==10 and yy2==6 then
-        p3=2
-    end
-    if xx2==12 and yy2==6 then
-        p4=2
-    end
-    if xx2==14 and yy2==6 then
-        p5=2
-    end
-    if xx2==16 and yy2==6 then
-        p6=2
-    end
-    if xx2==18 and yy2==6 then
-        p7=2
-    end
-    if xx2==20 and yy2==6 then
-        p8=2
-    end
-    if xx2==22 and yy2==6 then
-        p9=2
-    end
-    if xx3==4 and yy3==6 then
-        p0=3
-    end
-    if xx3==6 and yy3==6 then
-        p1=3
-    end
-    if xx3==8 and yy3==6 then
-        p2=3
-    end
-    if xx3==10 and yy3==6 then
-        p3=3
-    end
-    if xx3==12 and yy3==6 then
-        p4=3
-    end
-    if xx3==14 and yy3==6 then
-        p5=3
-    end
-    if xx3==16 and yy3==6 then
-        p6=3
-    end
-    if xx3==18 and yy3==6 then
-        p7=3
-    end
-    if xx3==20 and yy3==6 then
-        p8=3
-    end
-    if xx3==22 and yy3==6 then
-        p9=3
-    end
-    if xx4==4 and yy4==6 then
-        p0=4
-    end
-    if xx4==6 and yy4==6 then
-        p1=4
-    end
-    if xx4==8 and yy4==6 then
-        p2=4
-    end
-    if xx4==10 and yy4==6 then
-        p3=4
-    end
-    if xx4==12 and yy4==6 then
-        p4=4
-    end
-    if xx4==14 and yy4==6 then
-        p5=4
-    end
-    if xx4==16 and yy4==6 then
-        p6=4
-    end
-    if xx4==18 and yy4==6 then
-        p7=4
-    end
-    if xx4==20 and yy4==6 then
-        p8=4
-    end
-    if xx4==22 and yy4==6 then
-        p9=4
-    end
-    if xx5==4 and yy5==6 then
-        p0=5
-    end
-    if xx5==6 and yy5==6 then
-        p1=5
-    end
-    if xx5==8 and yy5==6 then
-        p2=5
-    end
-    if xx5==10 and yy5==6 then
-        p3=5
-    end
-    if xx5==12 and yy5==6 then
-        p4=5
-    end
-    if xx5==14 and yy5==6 then
-        p5=5
-    end
-    if xx5==16 and yy5==6 then
-        p6=5
-    end
-    if xx5==18 and yy5==6 then
-        p7=5
-    end
-    if xx5==20 and yy5==6 then
-        p8=5
-    end
-    if xx5==22 and yy5==6 then
-        p9=5
-    end
-    if xx6==4 and yy6==6 then
-        p0=6
-    end
-    if xx6==6 and yy6==6 then
-        p1=6
-    end
-    if xx6==8 and yy6==6 then
-        p2=6
-    end
-    if xx6==10 and yy6==6 then
-        p3=6
-    end
-    if xx6==12 and yy6==6 then
-        p4=6
-    end
-    if xx6==14 and yy6==6 then
-        p5=6
-    end
-    if xx6==16 and yy6==6 then
-        p6=6
-    end
-    if xx6==18 and yy6==6 then
-        p7=6
-    end
-    if xx6==20 and yy6==6 then
-        p8=6
-    end
-    if xx6==22 and yy6==6 then
-        p9=6
-    end
-    if xx7==4 and yy7==6 then
-        p0=7
-    end
-    if xx7==6 and yy7==6 then
-        p1=7
-    end
-    if xx7==8 and yy7==6 then
-        p2=7
-    end
-    if xx7==10 and yy7==6 then
-        p3=7
-    end
-    if xx7==12 and yy7==6 then
-        p4=7
-    end
-    if xx7==14 and yy7==6 then
-        p5=7
-    end
-    if xx7==16 and yy7==6 then
-        p6=7
-    end
-    if xx7==18 and yy7==6 then
-        p7=7
-    end
-    if xx7==20 and yy7==6 then
-        p8=7
-    end
-    if xx7==22 and yy7==6 then
-        p9=7
-    end
-    if xx8==4 and yy8==6 then
-        p0=8
-    end
-    if xx8==6 and yy8==6 then
-        p1=8
-    end
-    if xx8==8 and yy8==6 then
-        p2=8
-    end
-    if xx8==10 and yy8==6 then
-        p3=8
-    end
-    if xx8==12 and yy8==6 then
-        p4=8
-    end
-    if xx8==14 and yy8==6 then
-        p5=8
-    end
-    if xx8==16 and yy8==6 then
-        p6=8
-    end
-    if xx8==18 and yy8==6 then
-        p7=8
-    end
-    if xx8==20 and yy8==6 then
-        p8=8
-    end
-    if xx8==22 and yy8==6 then
-        p9=8
-    end
-    if xx9==4 and yy9==6 then
-        p0=9
-    end
-    if xx9==6 and yy9==6 then
-        p1=9
-    end
-    if xx9==8 and yy9==6 then
-        p2=9
-    end
-    if xx9==10 and yy9==6 then
-        p3=9
-    end
-    if xx9==12 and yy9==6 then
-        p4=9
-    end
-    if xx9==14 and yy9==6 then
-        p5=9
-    end
-    if xx9==16 and yy9==6 then
-        p6=9
-    end
-    if xx9==18 and yy9==6 then
-        p7=9
-    end
-    if xx9==20 and yy9==6 then
-        p8=9
-    end
-    if xx9==22 and yy9==6 then
-        p9=9
-    end
-    funcccheck()
-end
-
-display.SetFollowMode(display.FOLLOW_SCROLLING)
-    ]]></el:luamain>
-    <el:i18n>
-      <el:string el:key="title">
-        <el:english el:translate="false"/>
-      </el:string>
-    </el:i18n>
-  </el:protected>
-</el:level>
-

Modified: trunk/data/levels/enigma_vii/index.xml
===================================================================
--- trunk/data/levels/enigma_vii/index.xml	2008-08-24 14:00:53 UTC (rev 1288)
+++ trunk/data/levels/enigma_vii/index.xml	2008-08-25 21:27:20 UTC (rev 1289)
@@ -1,7 +1,7 @@
 <?xml version="1.0" encoding="UTF-8" standalone="no" ?>
 <index xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="index.xsd">
 
-  <info enigma="1.00" group="Enigma" location="10800" network="false" owner="Enigma Team" release="1" revision="16" title="Enigma VII"/>
+  <info enigma="1.00" group="Enigma" location="10800" network="false" owner="Enigma Team" release="1" revision="17" title="Enigma VII"/>
 
   <attributes/>
 
@@ -54,58 +54,58 @@
     <level _seq="46" _title="Double Oneways" _xpath="./duffy172_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy172" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="47" _title="Wood - Water - Wood" _xpath="./duffy173_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy173" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="48" _title="Transpositions" _xpath="./duffy174_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy174" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="49" _title="The Pearl Necklet" _xpath="./duffy175_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy175" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="50" _title="Puppet" _xpath="./pulley06_2" author="Mark Pulley" ctrl="force" easy="true" id="pulley06" rel="2" rev="2" score="1" target="time" unit="duration"/>
-    <level _seq="51" _title="Restless Meditation" _xpath="./ral09_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20070623ral914" rel="1" rev="77" score="1" target="time" unit="duration"/>
-    <level _seq="52" _title="Ghost Driver" _xpath="./duffy176_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy176" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="53" _title="Re-entry Circuit" _xpath="./pulley05_1" author="Mark Pulley" ctrl="force" easy="false" id="pulley05" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="54" _title="Not Fast Enough" _xpath="./jet04_3" author="James Taylor, Ronald Lamprecht" ctrl="force" easy="true" id="20070413jet001" rel="3" rev="3" score="3" target="time" unit="duration"/>
-    <level _seq="55" _title="Give Way" _xpath="./just20_1" author="JuSt" ctrl="force" easy="false" id="just20" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="56" _title="Give more Way" _xpath="./just21_2" author="JuSt" ctrl="force" easy="true" id="just21" rel="2" rev="2" score="2" target="time" unit="duration"/>
-    <level _seq="57" _title="Give Way 4 two" _xpath="./just22_2" author="JuSt" ctrl="force" easy="true" id="just22" rel="2" rev="2" score="2" target="time" unit="duration"/>
-    <level _seq="58" _title="Lost in Time and Space" _xpath="./just23_1" author="JuSt" ctrl="force" easy="false" id="just23" rel="1" rev="2" score="1" target="time" unit="duration"/>
-    <level _seq="59" _title="Alternatives?" _xpath="./just24_1" author="JuSt" ctrl="force" easy="true" id="just24" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="60" _title="No More Alternatives" _xpath="./just25_1" author="JuSt" ctrl="force" easy="true" id="just25" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="61" _title="The Walls" _xpath="./just26_1" author="JuSt" ctrl="force" easy="true" id="just26" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="62" _title="Pull the Puller" _xpath="./just28_1" author="JuSt" ctrl="force" easy="false" id="just28" rel="1" rev="2" score="1" target="time" unit="duration"/>
-    <level _seq="63" _title="Double Sense" _xpath="./joe14_1" author="Joseph Dunne" ctrl="force" easy="true" id="joe14" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="64" _title="Double Sense II" _xpath="./joe15_1" author="Joseph Dunne" ctrl="force" easy="true" id="joe15" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="65" _title="Lightyears" _xpath="./duffy177_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy177" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="66" _title="Zero Magnetism Lab" _xpath="./duffy178_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy178" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="67" _title="Armageddon" _xpath="./duffy179_1" author="Jacob Scott" ctrl="force" easy="true" id="duffy179" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="68" _title="Mountain Climbing II" _xpath="./joe25_1" author="Joseph Dunne" ctrl="force" easy="true" id="joe25" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="69" _title="Minor Tangler" _xpath="./joe24_1" author="Joseph Dunne" ctrl="force" easy="false" id="joe24" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="70" _title="Circulation" _xpath="./pulley03_2" author="Mark Pulley" ctrl="force" easy="false" id="pulley03" rel="2" rev="2" score="2" target="time" unit="duration"/>
-    <level _seq="71" _title="Maze for Two" _xpath="./ral22_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20071017ral096" rel="1" rev="84" score="1" target="time" unit="duration"/>
-    <level _seq="72" _title="Making Shapes" _xpath="./joe18_1" author="Joseph Dunne" ctrl="force" easy="false" id="joe18" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="73" _title="Clever Pushing" _xpath="./joe19_2" author="Joseph Dunne" ctrl="force" easy="false" id="joe19" rel="2" rev="1" score="2" target="time" unit="duration"/>
-    <level _seq="74" _title="Using Rotators" _xpath="./joe20_1" author="Joseph Dunne" ctrl="force" easy="false" id="joe20" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="75" _title="Swapping Puzzle" _xpath="./joe21_1" author="Joseph Dunne" ctrl="force" easy="false" id="joe21" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="76" _title="Swapping Puzzle II" _xpath="./joe22_1" author="Joseph Dunne" ctrl="force" easy="false" id="joe22" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="77" _title="Multiban" _xpath="./dpl01_1" author="Dominik Leipold" ctrl="force" easy="false" id="dpl01" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="78" _title="Riverside" _xpath="./johann02_2" author="Johann Freymuth" ctrl="force" easy="false" id="johann02" rel="2" rev="0" score="2" target="time" unit="duration"/>
-    <level _seq="79" _title="The Lone Ranger" _xpath="./pulley04_1" author="Mark Pulley" ctrl="force" easy="false" id="pulley04" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="80" _title="Little Shop Of Horrors" _xpath="./pulley07_1" author="Mark Pulley" ctrl="force" easy="false" id="pulley07" rel="1" rev="5" score="1" target="time" unit="duration"/>
-    <level _seq="81" _title="Spaceship Control" _xpath="./safalra01_1" author="Safalra" ctrl="force" easy="false" id="safalra01" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="82" _title="Ball Alley" _xpath="./johann01_1" author="Johann Freymuth" ctrl="force" easy="false" id="johann01" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="83" _title="Action Potential" _xpath="./pulley02_1" author="Mark Pulley" ctrl="force" easy="true" id="pulley02" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="84" _title="Remote Meditation" _xpath="./dpl02_1" author="Dominik Leipold" ctrl="force" easy="true" id="dpl02" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="85" _title="Triggered Triggers" _xpath="./just19_1" author="JuSt" ctrl="force" easy="true" id="just19" rel="1" rev="2" score="1" target="time" unit="duration"/>
-    <level _seq="86" _title="Lady in Red" _xpath="./just30_1" author="Just" ctrl="force" easy="true" id="just30" rel="1" rev="3" score="1" target="time" unit="duration"/>
-    <level _seq="87" _title="Crawling the Abyss" _xpath="./sph02_1" author="ShadowPhrogg32642342" ctrl="force" easy="true" id="sph02" rel="1" rev="5" score="1" target="time" unit="duration"/>
-    <level _seq="88" _title="Bold Boulder" _xpath="./ral14_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20061124ral279" rel="1" rev="96" score="1" target="time" unit="duration"/>
-    <level _seq="89" _title="Tinker, Tailor" _xpath="./andreas46_3" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas46" rel="4" rev="5" score="2" target="time" unit="duration"/>
-    <level _seq="90" _title="Elbow Society" _xpath="./andreas45_2" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas45" rel="2" rev="5" score="2" target="time" unit="duration"/>
-    <level _seq="91" _title="Watchmaker" _xpath="./huesing01_1" author="Johannes H?sing" ctrl="force" easy="false" id="huesing01" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="92" _title="Map it out II" _xpath="./manuel01_1" author="Manuel Eisentraut" ctrl="force" easy="true" id="manuel01" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="93" _title="Underground Temple" _xpath="./joe12_2" author="Joseph Dunne" ctrl="force" easy="true" id="joe_12" rel="2" rev="0" score="2" target="time" unit="duration"/>
-    <level _seq="94" _title="Mountain Climbing III" _xpath="./joe26_1" author="Joseph Dunne" ctrl="force" easy="true" id="joe26" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="95" _title="Recover the Stone" _xpath="./joe28_1" author="Joseph Dunne" ctrl="force" easy="false" id="joe28" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="96" _title="Pick-Up" _xpath="./joe27_1" author="Joseph Dunne" ctrl="force" easy="false" id="joe27" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="97" _title="A Kind of Magic" _xpath="./just37_1" author="JuSt" ctrl="force" easy="true" id="JuStA Kind of Magic" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="98" _title="Blue Screen Of Death" _xpath="./pulley10_2" author="Mark Pulley" ctrl="force" easy="true" id="pulley10" rel="2" rev="1" score="2" target="time" unit="duration"/>
-    <level _seq="99" _title="Audience in Venice" _xpath="./mecke09_1" author="mecke" ctrl="force" easy="true" id="mecke9" rel="1" rev="20" score="1" target="time" unit="duration"/>
-    <level _seq="100" _title="Black Liberation" _xpath="./mecke11_1" author="mecke" ctrl="force" easy="true" id="mecke11" rel="1" rev="25" score="1" target="time" unit="duration"/>
+    <level _seq="49" _title="Puppet" _xpath="./pulley06_2" author="Mark Pulley" ctrl="force" easy="true" id="pulley06" rel="2" rev="2" score="1" target="time" unit="duration"/>
+    <level _seq="50" _title="Restless Meditation" _xpath="./ral09_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20070623ral914" rel="1" rev="77" score="1" target="time" unit="duration"/>
+    <level _seq="51" _title="Ghost Driver" _xpath="./duffy176_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy176" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="52" _title="Re-entry Circuit" _xpath="./pulley05_1" author="Mark Pulley" ctrl="force" easy="false" id="pulley05" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="53" _title="Not Fast Enough" _xpath="./jet04_3" author="James Taylor, Ronald Lamprecht" ctrl="force" easy="true" id="20070413jet001" rel="3" rev="3" score="3" target="time" unit="duration"/>
+    <level _seq="54" _title="Give Way" _xpath="./just20_1" author="JuSt" ctrl="force" easy="false" id="just20" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="55" _title="Give more Way" _xpath="./just21_2" author="JuSt" ctrl="force" easy="true" id="just21" rel="2" rev="3" score="2" target="time" unit="duration"/>
+    <level _seq="56" _title="Give Way 4 two" _xpath="./just22_2" author="JuSt" ctrl="force" easy="true" id="just22" rel="2" rev="2" score="2" target="time" unit="duration"/>
+    <level _seq="57" _title="Lost in Time and Space" _xpath="./just23_1" author="JuSt" ctrl="force" easy="false" id="just23" rel="1" rev="2" score="1" target="time" unit="duration"/>
+    <level _seq="58" _title="Alternatives?" _xpath="./just24_1" author="JuSt" ctrl="force" easy="true" id="just24" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="59" _title="No More Alternatives" _xpath="./just25_1" author="JuSt" ctrl="force" easy="true" id="just25" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="60" _title="The Walls" _xpath="./just26_1" author="JuSt" ctrl="force" easy="true" id="just26" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="61" _title="Pull the Puller" _xpath="./just28_1" author="JuSt" ctrl="force" easy="false" id="just28" rel="1" rev="2" score="1" target="time" unit="duration"/>
+    <level _seq="62" _title="Double Sense" _xpath="./joe14_1" author="Joseph Dunne" ctrl="force" easy="true" id="joe14" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="63" _title="Double Sense II" _xpath="./joe15_1" author="Joseph Dunne" ctrl="force" easy="true" id="joe15" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="64" _title="Lightyears" _xpath="./duffy177_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy177" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="65" _title="Zero Magnetism Lab" _xpath="./duffy178_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy178" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="66" _title="Armageddon" _xpath="./duffy179_1" author="Jacob Scott" ctrl="force" easy="true" id="duffy179" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="67" _title="Mountain Climbing II" _xpath="./joe25_1" author="Joseph Dunne" ctrl="force" easy="true" id="joe25" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="68" _title="Minor Tangler" _xpath="./joe24_1" author="Joseph Dunne" ctrl="force" easy="false" id="joe24" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="69" _title="Circulation" _xpath="./pulley03_2" author="Mark Pulley" ctrl="force" easy="false" id="pulley03" rel="2" rev="2" score="2" target="time" unit="duration"/>
+    <level _seq="70" _title="Maze for Two" _xpath="./ral22_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20071017ral096" rel="1" rev="84" score="1" target="time" unit="duration"/>
+    <level _seq="71" _title="Making Shapes" _xpath="./joe18_1" author="Joseph Dunne" ctrl="force" easy="false" id="joe18" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="72" _title="Clever Pushing" _xpath="./joe19_2" author="Joseph Dunne" ctrl="force" easy="false" id="joe19" rel="2" rev="1" score="2" target="time" unit="duration"/>
+    <level _seq="73" _title="Using Rotators" _xpath="./joe20_1" author="Joseph Dunne" ctrl="force" easy="false" id="joe20" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="74" _title="Swapping Puzzle" _xpath="./joe21_1" author="Joseph Dunne" ctrl="force" easy="false" id="joe21" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="75" _title="Swapping Puzzle II" _xpath="./joe22_1" author="Joseph Dunne" ctrl="force" easy="false" id="joe22" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="76" _title="Multiban" _xpath="./dpl01_1" author="Dominik Leipold" ctrl="force" easy="false" id="dpl01" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="77" _title="Riverside" _xpath="./johann02_2" author="Johann Freymuth" ctrl="force" easy="false" id="johann02" rel="2" rev="0" score="2" target="time" unit="duration"/>
+    <level _seq="78" _title="The Lone Ranger" _xpath="./pulley04_1" author="Mark Pulley" ctrl="force" easy="false" id="pulley04" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="79" _title="Little Shop Of Horrors" _xpath="./pulley07_1" author="Mark Pulley" ctrl="force" easy="false" id="pulley07" rel="1" rev="5" score="1" target="time" unit="duration"/>
+    <level _seq="80" _title="Spaceship Control" _xpath="./safalra01_1" author="Safalra" ctrl="force" easy="false" id="safalra01" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="81" _title="Ball Alley" _xpath="./johann01_1" author="Johann Freymuth" ctrl="force" easy="false" id="johann01" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="82" _title="Action Potential" _xpath="./pulley02_1" author="Mark Pulley" ctrl="force" easy="true" id="pulley02" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="83" _title="Remote Meditation" _xpath="./dpl02_1" author="Dominik Leipold" ctrl="force" easy="true" id="dpl02" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="84" _title="Triggered Triggers" _xpath="./just19_1" author="JuSt" ctrl="force" easy="true" id="just19" rel="1" rev="2" score="1" target="time" unit="duration"/>
+    <level _seq="85" _title="Lady in Red" _xpath="./just30_1" author="Just" ctrl="force" easy="true" id="just30" rel="1" rev="3" score="1" target="time" unit="duration"/>
+    <level _seq="86" _title="Crawling the Abyss" _xpath="./sph02_1" author="ShadowPhrogg32642342" ctrl="force" easy="true" id="sph02" rel="1" rev="5" score="1" target="time" unit="duration"/>
+    <level _seq="87" _title="Bold Boulder" _xpath="./ral14_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20061124ral279" rel="1" rev="96" score="1" target="time" unit="duration"/>
+    <level _seq="88" _title="Tinker, Tailor" _xpath="./andreas46_3" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas46" rel="4" rev="5" score="2" target="time" unit="duration"/>
+    <level _seq="89" _title="Elbow Society" _xpath="./andreas45_2" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas45" rel="2" rev="5" score="2" target="time" unit="duration"/>
+    <level _seq="90" _title="Watchmaker" _xpath="./huesing01_1" author="Johannes H?sing" ctrl="force" easy="false" id="huesing01" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="91" _title="Map it out II" _xpath="./manuel01_1" author="Manuel Eisentraut" ctrl="force" easy="true" id="manuel01" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="92" _title="Underground Temple" _xpath="./joe12_2" author="Joseph Dunne" ctrl="force" easy="true" id="joe_12" rel="2" rev="0" score="2" target="time" unit="duration"/>
+    <level _seq="93" _title="Mountain Climbing III" _xpath="./joe26_1" author="Joseph Dunne" ctrl="force" easy="true" id="joe26" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="94" _title="Recover the Stone" _xpath="./joe28_1" author="Joseph Dunne" ctrl="force" easy="false" id="joe28" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="95" _title="Pick-Up" _xpath="./joe27_1" author="Joseph Dunne" ctrl="force" easy="false" id="joe27" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="96" _title="A Kind of Magic" _xpath="./just37_1" author="JuSt" ctrl="force" easy="true" id="JuStA Kind of Magic" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="97" _title="Blue Screen Of Death" _xpath="./pulley10_2" author="Mark Pulley" ctrl="force" easy="true" id="pulley10" rel="2" rev="1" score="2" target="time" unit="duration"/>
+    <level _seq="98" _title="Audience in Venice" _xpath="./mecke09_1" author="mecke" ctrl="force" easy="true" id="mecke9" rel="1" rev="20" score="1" target="time" unit="duration"/>
+    <level _seq="99" _title="Black Liberation" _xpath="./mecke11_1" author="mecke" ctrl="force" easy="true" id="mecke11" rel="1" rev="25" score="1" target="time" unit="duration"/>
+    <level _seq="100" _title="Jack-Of-All-Trades" _xpath="./mecke12_1" author="mecke" ctrl="force" easy="true" id="mecke12" rel="1" rev="31" score="1" target="time" unit="duration"/>
   </levels>
 
 </index>

Copied: trunk/data/levels/enigma_vii/mecke12_1.xml (from rev 1288, trunk/data/levels/enigma_viii/mecke12_1.xml)


Property changes on: trunk/data/levels/enigma_vii/mecke12_1.xml
___________________________________________________________________
Name: svn:mergeinfo
   + 
Name: svn:eol-style
   + native

Modified: trunk/data/levels/enigma_viii/index.xml
===================================================================
--- trunk/data/levels/enigma_viii/index.xml	2008-08-24 14:00:53 UTC (rev 1288)
+++ trunk/data/levels/enigma_viii/index.xml	2008-08-25 21:27:20 UTC (rev 1289)
@@ -1,44 +1,43 @@
 <?xml version="1.0" encoding="UTF-8" standalone="no" ?>
 <index xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="index.xsd">
 
-  <info enigma="1.00" group="Enigma" location="10900" network="false" owner="Enigma Team" release="1" revision="6" title="Enigma VIII"/>
+  <info enigma="1.00" group="Enigma" location="10900" network="false" owner="Enigma Team" release="1" revision="7" title="Enigma VIII"/>
 
   <attributes/>
 
   <levels>
     <level _seq="1" _title="Welcome" _xpath="./welcometopack8_1" author="Raoul Bourquin" ctrl="force" easy="true" id="welcometopack8" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="2" _title="Jack-Of-All-Trades" _xpath="./mecke12_1" author="mecke" ctrl="force" easy="true" id="mecke12" rel="1" rev="31" score="1" target="time" unit="duration"/>
-    <level _seq="3" _title="Enigmaparcour" _xpath="./mecke15_1" author="mecke" ctrl="force" easy="true" id="mecke15" rel="1" rev="21" score="1" target="time" unit="duration"/>
-    <level _seq="4" _title="Rhythm of Space" _xpath="./mecke20_1" author="mecke" ctrl="force" easy="true" id="mecke20" rel="1" rev="21" score="1" target="time" unit="duration"/>
-    <level _seq="5" _title="The Show Jumper" _xpath="./andreas47_1" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas47" rel="1" rev="4" score="1" target="time" unit="duration"/>
-    <level _seq="6" _title="The Red Room" _xpath="./joe29_1" author="Joseph Dunne" ctrl="force" easy="true" id="joe29" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="7" _title="Enigmines" _xpath="./huffman01_1" author="Brian Huffman" ctrl="force" easy="true" id="huffman01" rel="1" rev="2" score="1" target="time" unit="duration"/>
-    <level _seq="8" _title="Red Cave" _xpath="./mecke21_1" author="mecke" ctrl="force" easy="true" id="mecke21" rel="1" rev="30" score="1" target="time" unit="duration"/>
-    <level _seq="9" _title="Status code 302" _xpath="./dev02_1" author="/dev/null" ctrl="force" easy="true" id="dev02" rel="1" rev="4" score="1" target="time" unit="duration"/>
-    <level _seq="10" _title="A Screenful of Secrets" _xpath="./mecke01_1" author="mecke" ctrl="force" easy="true" id="mecke01" rel="1" rev="21" score="1" target="time" unit="duration"/>
-    <level _seq="11" _title="Southside Life" _xpath="./mecke10_1" author="mecke" ctrl="force" easy="true" id="mecke10" rel="1" rev="18" score="1" target="time" unit="duration"/>
-    <level _seq="12" _title="Joona's Chess" _xpath="./joona02_1" author="Joona Laire" ctrl="force" easy="true" id="joona02" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="13" _title="Helios I" _xpath="./mecke07_1" author="mecke" ctrl="force" easy="false" id="mecke48" rel="1" rev="11" score="1" target="time" unit="duration"/>
-    <level _seq="14" _title="The Green Hell" _xpath="./mecke22_1" author="mecke" ctrl="force" easy="true" id="mecke22" rel="1" rev="55" score="1" target="time" unit="duration"/>
-    <level _seq="15" _title="Tilt Board" _xpath="./ulf06_2" author="Ulf Stegemann" ctrl="force" easy="true" id="20080529ulf118" rel="2" rev="116" score="2" target="time" unit="duration"/>
-    <level _seq="16" _title="4 - 8 - 4" _xpath="./dpl03_3" author="Dominik Leipold" ctrl="force" easy="true" id="20070821dpl003" rel="3" rev="4" score="3" target="time" unit="duration"/>
-    <level _seq="17" _title="Impulsive Order" _xpath="./raywick05_1" author="Ray Wick" ctrl="force" easy="true" id="raywick5" rel="1" rev="5" score="1" target="time" unit="duration"/>
-    <level _seq="18" _title="Cross Mail" _xpath="./johann03_1" author="Johann Freymuth" ctrl="force" easy="false" id="johann03" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="19" _title="Color Maze" _xpath="./pulley16_3" author="Mark Pulley" ctrl="force" easy="false" id="pulley16" rel="3" rev="4" score="3" target="time" unit="duration"/>
-    <level _seq="20" _title="Earthlink" _xpath="./pulley15_1" author="Mark Pulley" ctrl="force" easy="true" id="pulley15" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="21" _title="Vanity's Constrictions" _xpath="./andreas53_2" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas53" rel="2" rev="5" score="2" target="time" unit="duration"/>
-    <level _seq="22" _title="Wired" _xpath="./andreas49_1" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas49" rel="1" rev="4" score="1" target="time" unit="duration"/>
-    <level _seq="23" _title="Push Wires" _xpath="./ral24_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20080708ral196" rel="1" rev="100" score="1" target="time" unit="duration"/>
-    <level _seq="24" _title="Wired Five" _xpath="./ral25_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20080721ral073" rel="1" rev="109" score="1" target="time" unit="duration"/>
-    <level _seq="25" _title="Wireban Premiere" _xpath="./ral26_1" author="Ronald Lamprecht" ctrl="force" easy="false" id="20080715ral161" rel="1" rev="106" score="1" target="time" unit="duration"/>
-    <level _seq="26" _title="Microwire" _xpath="./ral27_1" author="Ronald Lamprecht" ctrl="force" easy="false" id="20080717ral427" rel="1" rev="107" score="1" target="time" unit="duration"/>
-    <level _seq="27" _title="More Microwire" _xpath="./ral28_1" author="Ronald Lamprecht" ctrl="force" easy="false" id="20080717ral282" rel="1" rev="105" score="1" target="time" unit="duration"/>
-    <level _seq="28" _title="Freestyle Microwire" _xpath="./ral29_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20080719ral530" rel="1" rev="107" score="1" target="time" unit="duration"/>
-    <level _seq="29" _title="Balance Beam" _xpath="./mecke03_1" author="mecke" ctrl="force" easy="true" id="mecke03" rel="1" rev="29" score="1" target="time" unit="duration"/>
-    <level _seq="30" _title="Colored Oxyds" _xpath="./andreas50_1" author="Andreas Lochmann" ctrl="force" easy="false" id="andreas50" rel="1" rev="2" score="1" target="time" unit="duration"/>
-    <level _seq="31" _title="Fashions Pass" _xpath="./andreas48_2" author="Andreas Lochmann" ctrl="force" easy="false" id="andreas48" rel="2" rev="3" score="2" target="time" unit="duration"/>
-    <level _seq="32" _title="Colored Turnstiles" _xpath="./andreas51_1" author="Andreas Lochmann" ctrl="force" easy="false" id="andreas51" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="33" _title="Sanssouci" _xpath="./mecke05_1" author="mecke" ctrl="force" easy="true" id="mecke05" rel="1" rev="22" score="1" target="time" unit="duration"/>
+    <level _seq="2" _title="Enigmaparcour" _xpath="./mecke15_1" author="mecke" ctrl="force" easy="true" id="mecke15" rel="1" rev="21" score="1" target="time" unit="duration"/>
+    <level _seq="3" _title="Rhythm of Space" _xpath="./mecke20_1" author="mecke" ctrl="force" easy="true" id="mecke20" rel="1" rev="21" score="1" target="time" unit="duration"/>
+    <level _seq="4" _title="The Show Jumper" _xpath="./andreas47_1" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas47" rel="1" rev="4" score="1" target="time" unit="duration"/>
+    <level _seq="5" _title="The Red Room" _xpath="./joe29_1" author="Joseph Dunne" ctrl="force" easy="true" id="joe29" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="6" _title="Enigmines" _xpath="./huffman01_1" author="Brian Huffman" ctrl="force" easy="true" id="huffman01" rel="1" rev="2" score="1" target="time" unit="duration"/>
+    <level _seq="7" _title="Red Cave" _xpath="./mecke21_1" author="mecke" ctrl="force" easy="true" id="mecke21" rel="1" rev="30" score="1" target="time" unit="duration"/>
+    <level _seq="8" _title="Status code 302" _xpath="./dev02_1" author="/dev/null" ctrl="force" easy="true" id="dev02" rel="1" rev="4" score="1" target="time" unit="duration"/>
+    <level _seq="9" _title="A Screenful of Secrets" _xpath="./mecke01_1" author="mecke" ctrl="force" easy="true" id="mecke01" rel="1" rev="22" score="1" target="time" unit="duration"/>
+    <level _seq="10" _title="Southside Life" _xpath="./mecke10_1" author="mecke" ctrl="force" easy="true" id="mecke10" rel="1" rev="18" score="1" target="time" unit="duration"/>
+    <level _seq="11" _title="Joona's Chess" _xpath="./joona02_1" author="Joona Laire" ctrl="force" easy="true" id="joona02" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="12" _title="Helios I" _xpath="./mecke07_1" author="mecke" ctrl="force" easy="false" id="mecke48" rel="1" rev="12" score="1" target="time" unit="duration"/>
+    <level _seq="13" _title="The Green Hell" _xpath="./mecke22_1" author="mecke" ctrl="force" easy="true" id="mecke22" rel="1" rev="55" score="1" target="time" unit="duration"/>
+    <level _seq="14" _title="Tilt Board" _xpath="./ulf06_2" author="Ulf Stegemann" ctrl="force" easy="true" id="20080529ulf118" rel="2" rev="116" score="2" target="time" unit="duration"/>
+    <level _seq="15" _title="4 - 8 - 4" _xpath="./dpl03_3" author="Dominik Leipold" ctrl="force" easy="true" id="20070821dpl003" rel="3" rev="4" score="3" target="time" unit="duration"/>
+    <level _seq="16" _title="Impulsive Order" _xpath="./raywick05_1" author="Ray Wick" ctrl="force" easy="true" id="raywick5" rel="1" rev="5" score="1" target="time" unit="duration"/>
+    <level _seq="17" _title="Cross Mail" _xpath="./johann03_1" author="Johann Freymuth" ctrl="force" easy="false" id="johann03" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="18" _title="Color Maze" _xpath="./pulley16_3" author="Mark Pulley" ctrl="force" easy="false" id="pulley16" rel="3" rev="4" score="3" target="time" unit="duration"/>
+    <level _seq="19" _title="Earthlink" _xpath="./pulley15_1" author="Mark Pulley" ctrl="force" easy="true" id="pulley15" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="20" _title="Vanity's Constrictions" _xpath="./andreas53_2" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas53" rel="2" rev="5" score="2" target="time" unit="duration"/>
+    <level _seq="21" _title="Wired" _xpath="./andreas49_1" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas49" rel="1" rev="4" score="1" target="time" unit="duration"/>
+    <level _seq="22" _title="Push Wires" _xpath="./ral24_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20080708ral196" rel="1" rev="100" score="1" target="time" unit="duration"/>
+    <level _seq="23" _title="Wired Five" _xpath="./ral25_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20080721ral073" rel="1" rev="109" score="1" target="time" unit="duration"/>
+    <level _seq="24" _title="Wireban Premiere" _xpath="./ral26_1" author="Ronald Lamprecht" ctrl="force" easy="false" id="20080715ral161" rel="1" rev="106" score="1" target="time" unit="duration"/>
+    <level _seq="25" _title="Microwire" _xpath="./ral27_1" author="Ronald Lamprecht" ctrl="force" easy="false" id="20080717ral427" rel="1" rev="107" score="1" target="time" unit="duration"/>
+    <level _seq="26" _title="More Microwire" _xpath="./ral28_1" author="Ronald Lamprecht" ctrl="force" easy="false" id="20080717ral282" rel="1" rev="105" score="1" target="time" unit="duration"/>
+    <level _seq="27" _title="Freestyle Microwire" _xpath="./ral29_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20080719ral530" rel="1" rev="107" score="1" target="time" unit="duration"/>
+    <level _seq="28" _title="Balance Beam" _xpath="./mecke03_1" author="mecke" ctrl="force" easy="true" id="mecke03" rel="1" rev="29" score="1" target="time" unit="duration"/>
+    <level _seq="29" _title="Colored Oxyds" _xpath="./andreas50_1" author="Andreas Lochmann" ctrl="force" easy="false" id="andreas50" rel="1" rev="2" score="1" target="time" unit="duration"/>
+    <level _seq="30" _title="Fashions Pass" _xpath="./andreas48_2" author="Andreas Lochmann" ctrl="force" easy="false" id="andreas48" rel="2" rev="3" score="2" target="time" unit="duration"/>
+    <level _seq="31" _title="Colored Turnstiles" _xpath="./andreas51_1" author="Andreas Lochmann" ctrl="force" easy="false" id="andreas51" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="32" _title="Sanssouci" _xpath="./mecke05_1" author="mecke" ctrl="force" easy="true" id="mecke05" rel="1" rev="23" score="1" target="time" unit="duration"/>
   </levels>
 
 </index>

Modified: trunk/data/levels/enigma_viii/mecke01_1.xml
===================================================================
--- trunk/data/levels/enigma_viii/mecke01_1.xml	2008-08-24 14:00:53 UTC (rev 1288)
+++ trunk/data/levels/enigma_viii/mecke01_1.xml	2008-08-25 21:27:20 UTC (rev 1289)
@@ -3,7 +3,7 @@
   <el:protected >
     <el:info el:type="level">
       <el:identity el:title="A Screenful of Secrets" el:subtitle="My First Level" el:id="mecke01"/>
-      <el:version el:score="1" el:release="1" el:revision="$Revision: 21 $" el:status="released"/>
+      <el:version el:score="1" el:release="1" el:revision="$Revision: 22 $" el:status="released"/>
       <el:author  el:name="mecke" el:email="" el:homepage=""/>
       <el:copyright>Copyright ? 2008 Thomas Bernhardt</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
@@ -36,7 +36,7 @@
 ti["G "] = {"st-glass"}
 ti["m "] = {"st-glass_move"}
 ti["X "] = {"st-grate1"}
-ti["P "] = {"st-pull"}
+ti["P "] = {"st_pull"}
 ti["W "] = ti["P "] .. {"it_wormhole",range=0,strength=0, state=OFF}
 ti["^ "] = {"st_oneway_black_n"}
 ti["v "] = {"st_oneway_black_s"}

Modified: trunk/data/levels/enigma_viii/mecke05_1.xml
===================================================================
--- trunk/data/levels/enigma_viii/mecke05_1.xml	2008-08-24 14:00:53 UTC (rev 1288)
+++ trunk/data/levels/enigma_viii/mecke05_1.xml	2008-08-25 21:27:20 UTC (rev 1289)
@@ -3,7 +3,7 @@
   <el:protected>
     <el:info el:type="level">
       <el:identity el:title="Sanssouci" el:subtitle="A Baroque Game" el:id="mecke05"/>
-      <el:version el:score="1" el:release="1" el:revision="$Revision:22$" el:status="released"/>
+      <el:version el:score="1" el:release="1" el:revision="$Revision:23$" el:status="released"/>
       <el:author  el:name="mecke" el:email=""/>
       <el:copyright>Copyright ? 2008 Thomas Bernhardt</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
@@ -117,8 +117,8 @@
 ti["P "] = {"st_panel"}
 ti["Q "] = {"st_panel_s"}
 ti["Q3"] = {"st_panel_s","repanel1"}
-ti["G "] = {"st-swap"}
-ti["W "] = ti["^ "] .. {"st-swap"}
+ti["G "] = {"st_swap"}
+ti["W "] = ti["^ "] .. {"st_swap"}
 ti["a "] = {"st_switch", target="fire"}
 ti["b "] = {"st_switch", target="knight"}
 ti["c "] = {"st_switch", target="jux"}

Modified: trunk/data/levels/enigma_viii/mecke07_1.xml
===================================================================
--- trunk/data/levels/enigma_viii/mecke07_1.xml	2008-08-24 14:00:53 UTC (rev 1288)
+++ trunk/data/levels/enigma_viii/mecke07_1.xml	2008-08-25 21:27:20 UTC (rev 1289)
@@ -3,7 +3,7 @@
   <el:protected >
     <el:info el:type="level">
       <el:identity el:title="Helios I" el:subtitle="Use the Lightpassenger" el:id="mecke48"/>
-      <el:version el:score="1" el:release="1" el:revision="$Revision: 11 $" el:status="released"/>
+      <el:version el:score="1" el:release="1" el:revision="$Revision: 12 $" el:status="released"/>
       <el:author  el:name="mecke" el:email="" el:homepage=""/>
       <el:copyright>Copyright ? 2008 Thomas Bernhardt</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
@@ -48,7 +48,7 @@
 ti[" j"] = {"it_magicwand"}
 ti["S "] = ti[" n"] ..{"st-black4"}
 ti["G "] = {"st-yellow"}
-ti["P "] = ti[" n"] ..{"st-pull"}
+ti["P "] = ti[" n"] ..{"st_pull"}
 ti["g "] = {"it_glasses"}
 ti["T "] = ti["g "] .. {"st-grate1"}
 ti["J "] = {"#ac-top", range=1, force=1}

Deleted: trunk/data/levels/enigma_viii/mecke12_1.xml
===================================================================
--- trunk/data/levels/enigma_viii/mecke12_1.xml	2008-08-24 14:00:53 UTC (rev 1288)
+++ trunk/data/levels/enigma_viii/mecke12_1.xml	2008-08-25 21:27:20 UTC (rev 1289)
@@ -1,478 +0,0 @@
-?<?xml version="1.0" encoding="utf-8" standalone="no" ?>
-<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
-  xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd"
-  xmlns:el="http://enigma-game.org/schema/level/1">
-  <el:protected >
-    <el:info el:type="level">
-      <el:identity el:title="Jack-Of-All-Trades" el:subtitle="Find The Paradise" el:id="mecke12"/>
-      <el:version el:score="1" el:release="1" el:revision="$Revision: 31 $" el:status="released"/>
-      <el:author  el:name="mecke" el:email="" el:homepage=""/>
-      <el:copyright>Copyright ? 2008 Thomas Bernhardt</el:copyright>
-      <el:license el:type="GPL v2.0 or above" el:open="true"/>
-      <el:compatibility el:enigma="0.92">
-        <el:dependency el:path="lib/ant" el:id="lib/ant" el:release="1" el:preload="true"/>
-      </el:compatibility>
-      <el:modes el:easy="true" el:single="true" el:network="false" el:control="force"
-        el:scoreunit="duration" el:scoretarget="time"/>
-      <el:comments>
-        <el:credits el:showinfo="true" el:showstart="false">Thanks to Ronald Lamprecht for some patterns and code examples</el:credits>
-      </el:comments>
-      <el:score el:easy="20:18" el:difficult="25:52"/>
-    </el:info>
-    <el:luamain><![CDATA[
-function file_oxyd(x,y,f)
-    oxyd_default_flavor=f
-    oxyd(x,y)
-end
-levelh=39
-levelw=60
-enigma.FlatForce=30
-enigma.SlopeForce=30
-enigma.ElectricForce=30
-cells={}
-items={}
-actors={}
-stones={}
-actors[" "]=cell{}
-stones[" "]=cell{}
-cells[" "]=cell{}
-items[" "]=cell{}
-cells["!"]=cell{floor="fl-normal"}
-stones["!"]=cell{stone="st-yellow"}
-stones["#"]=cell{stone="st-death"}
-cells["#"]=cell{floor="fl-rough-blue"}
-cells["$"]=cell{floor="fl-light"}
-stones["$"]=cell{stone="st-knight"}
-stones["%"]=cell{stone="st-grate1"}
-cells["%"]=cell{floor="fl-abyss"}
-cells["&"]=cell{floor="fl-water"}
-cells["'"]=cell{floor="fl-sahara"}
-cells["("]=cell{floor="fl-bluegray"}
-stones["&"]=cell{parent={{file_oxyd,"d"}}}
-cells[")"]=cell{floor="fl-leavesc1"}
-cells["*"]=cell{floor="fl-gradient9"}
-cells["+"]=cell{floor="fl-himalaya"}
-cells[","]=cell{floor="fl-gradient10"}
-stones["'"]=cell{stone="st-actorimpulse_invisible"}
-stones["U"]=cell{stone="st-switch_black"}
-cells["i"]=cell{floor="fl-ice"}
-
-function ac_blackball(x,y)
-n=""
-p=0
-f=0
- if (x==8) and (y==18) then
-  n="ac8x18"
-  p=0
-  mf=1
- end
-set_actor("ac-blackball",x+0.5,y+0.5,{player=p,name=n,mouseforce=mf})
-end
-actors["!"]=cell{parent={{ac_blackball}}}
-items["!"]=cell{item="it-extralife"}
-items["#"]=cell{item="it-spring2"}
-items["$"]=cell{item="it-vstrip"}
-stones["("]=cell{stone="st-key_a"}
-stones[")"]=cell{stone="st-key_b"}
-cells["-"]=cell{floor="fl-gradient11"}
-cells["."]=cell{floor="fl-gradient12"}
-items["%"]=cell{item="it-brush"}
-stones["*"]=cell{stone="st-break_bolder"}
-cells["/"]=cell{floor="fl-bluegreenx"}
-stones["+"]=cell{stone="st-glass_move"}
-stones[","]=cell{stone="st-door-v"}
-cells["0"]=cell{floor="fl-space"}
-stones["-"]=cell{stone="st-blue-sand"}
-stones["."]=cell{stone="st-oneway_black-w"}
-stones["/"]=cell{stone="st-oneway_black-e"}
-stones["P"]=cell{stone="st-oneway_black-s"}
-items["&"]=cell{item="it-crack3"}
-stones["0"]=cell{stone="st-brick_magic"}
-stones["1"]=cell{stone="st-rock1_hole"}
-stones["B"]=cell{stone="st-black4"}
-stones["2"]=cell{stone="st-bolder-w"}
-items["'"]=cell{item="it-trigger"}
-items["("]=cell{item="it-springboard"}
-stones["3"]=cell{stone="st-door-h"}
-function ac_top(x,y)
-n=""
-r=0
-f=0
- init=false
- if (x==25) and (y==4) then
-  n="ac25x4"
-  r=10
-  f=10
-  init=FALSE
- end
- if (x==26) and (y==9) then
-  n="ac26x9"
-  r=10
-  f=10
-  init=FALSE
- end
- if (x==27) and (y==4) then
-  n="ac27x4"
-  r=10
-  f=10
-  init=FALSE
- end
- if (x==28) and (y==11) then
-  n="ac28x11"
-  r=10
-  f=10
-  init=FALSE
- end
- if (x==29) and (y==4) then
-  n="ac29x4"
-  r=10
-  f=10
-  init=FALSE
- end
- if (x==30) and (y==9) then
-  n="ac30x9"
-  r=10
-  f=10
-  init=FALSE
- end
- if (x==31) and (y==4) then
-  n="ac31x4"
-  r=10
-  f=10
-  init=FALSE
- end
- if (x==26) and (y==26) then
-  n="ac31x4"
-  r=10
-  f=10
-  init=FALSE
- end
- if (x==26) and (y==28) then
-  n="ac31x4"
-  r=10
-  f=10
-  init=FALSE
- end
- if (x==26) and (y==30) then
-  n="ac31x4"
-  r=10
-  f=10
-  init=FALSE
- end
- if (x==26) and (y==32) then
-  n="ac31x4"
-  r=10
-  f=10
-  init=FALSE
- end
- if (x==26) and (y==34) then
-  n="ac31x4"
-  r=10
-  f=10
-  init=FALSE
- end
- if (x==26) and (y==36) then
-  n="ac31x4"
-  r=10
-  f=10
-  init=FALSE
- end
-set_actor("ac-top",x+0.5,y+0.5,{range=r,force=f,name=n,gohome=init})
-end
-actors["#"]=cell{parent={{ac_top}}}
-stones["4"]=cell{stone="st-laser-e"}
-items[")"]=cell{item="it-coffee"}
-items["*"]=cell{item="it-key_b"}
-items["+"]=cell{item="it-blackbomb"}
-stones["5"]=cell{stone="st-black3"}
-stones["6"]=cell{stone="st-rock1"}
-cells["1"]=cell{floor="fl-rough-red"}
-stones["7"]=cell{stone="st-bolder-e"}
-stones["Z"]=cell{stone="st-bolder-n"}
-stones["Y"]=cell{stone="st-bolder-s"}
-cells["2"]=cell{floor="fl-samba"}
-stones["8"]=cell{stone="st-rock4"}
-items[","]=cell{item="it-wormhole"}
-items["-"]=cell{item="it-puller-n"}
-items["."]=cell{item="it-hstrip"}
-cells["3"]=cell{floor="fl-swamp"}
-stones["9"]=cell{stone="st-actorimpulse"}
-cells["4"]=cell{floor="fl-bluegreen"}
-stones[":"]=cell{stone="st-puzzle-hollow"}
-items["/"]=cell{item="it-hammer"}
-cells["5"]=cell{floor="fl-gradient4"}
-items["0"]=cell{item="it-key_a"}
-items["1"]=cell{item="it-magicwand"}
-items["3"]=cell{item="it-floppy"}
-stones[";"]=cell{stone="st-black4"}
-stones["<"]=cell{stone="st-laser-s"}
-stones["="]=cell{stone="st-laser-n"}
-stones[">"]=cell{stone="st-wood"}
-cells["6"]=cell{floor="fl-acwhite"}
-cells["7"]=cell{floor="fl-gradient14"}
-stones["?"]=cell{stone="st-likeoxydd"}
-stones["@"]=cell{stone="st-glass"}
-stones["A"]=cell{stone="st-door-h-open"}
-items["2"]=cell{item="it-cherry"}
-stones["V"]=cell{stone="st-floppy"}
-stones["W"]=cell{stone="st-stone_break"}
-function ac_rotor(x,y)
-n=""
-r=0
-f=0
- init=false
- if (x==58) and (y==18) then
-  n="ac58x18"
-  r=7
-  f=7
-  init=FALSE
- end
-set_actor("ac-rotor",x+0.5,y+0.5,{range=r,force=f,name=n,gohome=init})
-end
-actors["$"]=cell{parent={{ac_rotor}}}
-level={"!!!!!!!!!!!!!!!!!!!!!!!!!!0!0!0!!!!!!!!!!!!!!!!!!!!!!!!!!!!!",
-       "!%#%################!!!!!!!!!!!!!!!!!%%%%$44$44$2%!!!!!!!!!!",
-       "!#%!!!!!&!&!&!!!!!!#!!!!!0!0!0!0!!!!!22%%%3333322%%!%6%%%%(!",
-       "!%!&&&&&&&&&&&&&&&!#!!!!!!!!!!!!!!!!!%2%%%%32322%%!!!!!&!&!!",
-       "!#!&&&&&)i&i)&&&&&!#!!!!0!0!0!0!0!!!!%2%%%%3032$%%%!(%(&%%(!",
-       "!#!&&&)iiiiiii)&&&!#!!!!!!!!!!!!!!!!!%2222200024%4!!!&!&!!!!",
-       "!#!&!'&iii!iii&'!&!#!!!0!0!0!0!0!0!!!%2%33330334%4%!%&%%(%6!",
-       "!#!&&&)iiiiiii)&&&!#!!!!!!!!!!!!!!!!!22%3$332534%4!!!&!!!&!!",
-       "!#!&&&&&)i&i)&&&&&!#!!0!0!0!0!0!0!0!!%%%33333!5$%%%!%%%%(&%!",
-       "!#!&&&&&&&&&&&&&&&!%!!!!!!!!!!!!!!!!!%%%333333*5%%!!!!!!!&!!",
-       "!#!!!!!!&!!!&!!!!!%#!0!0!0!0!0!0!0!0!%%%%%%%%%$55%%!(%&%%(%!",
-       "!################%#%!!!!!!!!!!!!!!!!!%%%%%%%%%%%*5!!!!!!!!!!",
-       "!!!!!!!!!!!!!!!!!!!!0!0!0!0!0!0!0!0!0!!!!!!!!!!!!*5!%%&%&!%!",
-       "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*!!!!!!!!!",
-       "!!!!!!!!!!!!!!!!!!!//////////////////!!!!!!!!!!!!!!!!!!!$$$!",
-       "!!!!!!!!!!!!!!!!!!!/((((((((((((((((/!!!!!!!!!!!!!!!!!!!$$$!",
-       "!!!!!!*+%%+-!!!!!!!/(!&&&&&&&&&&&&!(/!!!!!!!!!!!!!!!!!!!$$$!",
-       "!!!!!!+%%%%+!!!!!!!/(!!!!!&!!&!!!!!(/!!!!!!!!!!!!!!!!!!!$$$!",
-       "!!!!!!%%''%%!!!!!!!/(!!!&!&!!&!!!!1(/!1!1!1!1!1!1!!!!-!!$$$!",
-       "!!!!!!%%''%%!!!!!!!/(!!!&!&!!&!!!!1(/!1!1!1!1!1!1!!!!7!!$$$!",
-       "!!!!!!+%%%%+!!!!!!!/(!!!!!&!!&!!!!!(/!!!!!!!!!!!!!!!!!!!$$$!",
-       "!!!!!!,+%%+.!!!!!!!/(!&&&&&&&&&&&&!(/!!!!!!!!!!!!!!!!!!!$$$!",
-       "!!!!!!!!!!!!!!!!!!!/((((((((((((((((/!!!!!!!!!!!!!!!!!!!$$$!",
-       "!!!!!!!!!!!!!!!!!!!//////////////////!!!!!!!!!!!!!!!!!!!$$$!",
-       "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!",
-       "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!222%%%%%%%22!!!!!!!!!!",
-       "!iiiiiiiiiiiiiiiiii!!!!!!!!!i!!!!!!!!!2%22%%%%%22%%!!!!!!!!!",
-       "!iiiiiiiiiiiiiiiiii!!!!!!!!!i!!!!!!!!!%%%22%%%22%%!!!!!!!!!!",
-       "!iiiiiiiiiiiiiiiiii!!!!!!!!!i!!!!!!!!!%%%%22%22%%%%!!!!!!!!!",
-       "!ii&&&&&&&&&&&&&&ii!!!!!!!!!!!!!!!!!!!%%%%%222%%%%!!!!!!!!!!",
-       "!ii&&&&&&&&&&&&&&ii!!!!!&!!!i!!!&&!!&!%%%%/%%%/%%%%!!!!!!!!!",
-       "!ii&&&&&&&&&&&&&&ii!!!!&!&!!i!!&!!&!!!%%%%%%%%%%%%!!!!!!!!!!",
-       "!$i&&&&&&&&&&&&&&i$!!!&!0!&!i!&!00!&&!%%/%/%%%/%/%%!!!!!!!!!",
-       "!$$&&&&&&&&&&&&&&$$!!!!&!&!!!!!&!!&!!!%%%%%%%%%%%%!!!!!!!!!!",
-       "!$$&&&&&&&&&&&&&&$$!!!!!&!!!i!!!&&!!&!/%/%%($(%%/%/!!!!!!!!!",
-       "!$$&&&&&&&&&&&&&&$$!!!!!!!!!i!!!!!!!!!%%%%(%$%(%%%!!!!!!!!!!",
-       "!$$i$$i$i$$i$i$$i$$!!!!!!!!!i!!!!!!!&!%%%(33333(%%%!!!!!!!!!",
-       "!$$$$$$$$ii$$$$$$$$!!!!!!!!!!!!!!!!!!!2%%%%242%%%%!!!!!!!!!!",
-       "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!"}
-   acmap={"                                                            ",
-          "                                                            ",
-          "                                                            ",
-          "                                                            ",
-          "                         # # # #                            ",
-          "                                                            ",
-          "                                                            ",
-          "                                                            ",
-          "                                                            ",
-          "                          #   #                             ",
-          "                                                            ",
-          "                            #                               ",
-          "                                                            ",
-          "                                                            ",
-          "                                                            ",
-          "                                                            ",
-          "                                                            ",
-          "                                                            ",
-          "        !                                                 $ ",
-          "                                                            ",
-          "                                                            ",
-          "                                                            ",
-          "                                                            ",
-          "                                                            ",
-          "                                                            ",
-          "                                                            ",
-          "                          #                                 ",
-          "                                                            ",
-          "                          #                                 ",
-          "                                                            ",
-          "                          #                                 ",
-          "                                                            ",
-          "                          #                                 ",
-          "                                                            ",
-          "                          #                                 ",
-          "                                                            ",
-          "                          #                                 ",
-          "                                                            ",
-          "                                                            "}
-  itmap={"                                                            ",
-         "                                            /    .          ",
-         "                       '  '   '  '                          ",
-         "                                                            ",
-         "                                                            ",
-         "                                                .           ",
-         "         ! !                                                ",
-         "                          ) * )  +       !     0.           ",
-         "                                                            ",
-         "                                                            ",
-         "                                                            ",
-         "                                                            ",
-         "                                                            ",
-         "                                                            ",
-         "                                                            ",
-         "                           !!                            2  ",
-         "                                                            ",
-         "                     &     && &                          2  ",
-         "                                '                   '       ",
-         "         #                      '                   '    2  ",
-         "                     &     && &                             ",
-         "                                                         2  ",
-         "                                                            ",
-         "                                                            ",
-         "                     222222 2 2222222                       ",
-         "                                                            ",
-         "                                                            ",
-         "                            2                               ",
-         "                                                            ",
-         "                            2             $   $             ",
-         "                                                            ",
-         "                            2             $   $             ",
-         "                                         .     .            ",
-         "                            2           $       $           ",
-         "                                      3.         .1         ",
-         "                            2                               ",
-         "                                            /               ",
-         "                                                            ",
-         "                                                            "}
- stmap={"!!!!!!!!!!!!!!!!!!!!$---------------$6666666U66666688#888888",
-        "!          WWW*W*WWW$-- - - - - - --$    6     6   ;       8",
-        "! %%%%%%%%%%%%%%%%%W$.             .$.   +6   6  6 #   #   8",
-        "! %               %W$-- -3-3-3-3- --$    + 6 6  6 68       8",
-        "! %     >   >     % $- -         - -$    + #:# 6   #   #   8",
-        "! %      0(0      % #-- - - - - - --#    + :::    68       8",
-        "! % >     >W    > > $-             -$    + #:# 6 + #   #   8",
-        "! %      0)0      % $/;;;         5/$/   + 6  6   68       8",
-        "! %     >   >     % $-             -$    +  6  6   #   #   8",
-        "! %               % $-  -   -   -  -#    +   6  6 68       8",
-        "! %%%%%%%%P%%%%%%%% $-     = =     -$    +    6  6 #   #   8",
-        "!                   #--   -   -   --$    +     6  68       8",
-        "!!!!!!!PPPP!!!!!!!!!$-             -$666666666666  8       8",
-        "#######PPPP########*-*-*-*-*-*-*-*-*-!!!!!!!!!!!!! !!!!!6A66",
-        "#                 %                  %  9              9   6",
-        "#                 %                  %       9           + 6",
-        "#                 %                  %             9       6",
-        "#                 %   #### %%  %%%6  %88888888888888<8!8 @ 6",
-        "#                 %   ## 4     %                  2   ?8   6",
-        "#                 %   ## 4     %                  2   ?8 @ 6",
-        "#                 %   #### %%  %%%6  %88888888888888=8!8   6",
-        "#                 %                  %             9     @ 6",
-        "#                 %                  %       9             6",
-        "#                 %                  %   9             9   6",
-        "###################000000000000000000!!!!!!!!!!!!! !!!!!6366",
-        "!!!!!!!!!!!!!!!!!!!!6      #B#       6            -.%%%6@@@8",
-        "!$$$$$$$$$$$$$$$$$$!6      $B$       6      #      #%%%#6@@8",
-        "!                  !61     #B#      16      #     68>%>6@@@8",
-        "!3!%%%%%%%%%%%%%%!3!62     $B$      76      #      # > #6@@8",
-        "!  %ZZ Z ZZ Z ZZ%  !62     #B#      76            68   6@@@8",
-        "!  %            %  !62     $B$      76      #      # > #6>>8",
-        "!  %            %  !62     #B#      76   #3###3#  68> >6   8",
-        "V  %&& & && & &&% B,$2     $B$      76      #      #   #6  8",
-        "!  %            %  !62     #B#      76      #     68>>>6>>>8",
-        "!W %            %  !62     $B$      76     6 6     #   #6  8",
-        "!*W%YY Y YY Y YY%  !62     #B#      76    6   6   68>>>6@  8",
-        "!A!%%%%%%%%%%%%%%!A!62     $B$      76   6     6   #   #6@ 8",
-        "!WWWWW*WW WWW*     !62     #B#      .     6   6   68 # .  @8",
-        "!!!!!!!!!!!!!!!!!!!!-----------------6666666U666666888888888"}
-
-create_world_by_map(level)
-draw_map(0,0,stmap,stones)
-draw_map(0,0,itmap,items)
-draw_map(0,0,acmap,actors)
-set_item("it-vortex-open",50,24,{targetx= 44.5,targety = 35.5 })
-set_item("it-vortex-open",44,35)
-Signal ("it(44 35)", "it(53 35)")
-Signal ("it(44 35)", "it(50 24)")
-set_item("it-vortex-open",51,25,{targetx= 48.5,targety = 25.5 })
-set_item("it-vortex-open",48,25,{targetx= 51.5,targety = 25.5 })
-set_item("it-vortex-open",38,25,{targetx= 38.5,targety = 37.5 })
-set_item("it-vortex-open",38,37,{targetx= 38.5,targety = 25.5 })
-set_item("it-vortex-open",53,35,{targetx= 50.5,targety = 24.5 }) 
---set_item("it-vortex-open",44,34,{targetx= 50.5,targety = 24.5 }) 
-SetAttrib(enigma.GetItem(23,2),"invisible",FALSE)
-SetAttrib(enigma.GetStone(25,18),"on",FALSE)
-SetAttrib(enigma.GetStone(25,19),"on",FALSE)
-SetAttrib(enigma.GetItem(26,2),"invisible",FALSE)
-SetAttrib(enigma.GetItem(30,2),"invisible",FALSE)
-SetAttrib(enigma.GetItem(32,18),"invisible",FALSE)
-SetAttrib(enigma.GetItem(32,19),"invisible",FALSE)
-SetAttrib(enigma.GetItem(33,2),"invisible",FALSE)
---SetAttrib(enigma.GetItem(38,25),"strength",2)
---SetAttrib(enigma.GetItem(38,25),"range",2)
---SetAttrib(enigma.GetItem(51,25),"strength",2)
---SetAttrib(enigma.GetItem(51,25),"range",2)
-SetAttrib(enigma.GetStone(52,17),"on",FALSE)
-SetAttrib(enigma.GetItem(52,18),"invisible",FALSE)
-SetAttrib(enigma.GetItem(52,19),"invisible",FALSE)
-SetAttrib(enigma.GetStone(52,20),"on",FALSE)
-SetAttrib(enigma.GetStone(27,10),"on",FALSE)
-SetAttrib(enigma.GetStone(29,10),"on",FALSE)
-SetAttrib(enigma.GetStone(0,32),"on",FALSE)
-
-if (not difficult) then
-set_item("it-flagblack",12,18)
-set_item("it-extralife",12,19)
-set_item("it-pin",58,37)
-set_floor("fl-ice",32,30)
-set_floor("fl-ice",33,30)
-set_floor("fl-ice",32,34)
-set_floor("fl-ice",33,34)
-else
-set_item("it-death",12,14)
-set_item("it-death",12,16)
-set_item("it-death",12,18)
-set_item("it-death",12,20)
-set_item("it-death",12,22)
-set_item("it-death",12,24)
-set_item("it-death",4,14)
-set_item("it-death",16,16)
-set_item("it-death",6,18)
-set_item("it-death",17,20)
-end
-Signal ("it(52 18)","st(52 17)")
-Signal ("it(52 19)","st(52 20)")
-Signal ("it(32 18)","st(25 18)")
-Signal ("it(32 19)","st(25 19)")
-Signal ("it(52 18)","st(27 10)")
-Signal ("it(52 19)","st(29 10)")
-Signal ("it(32 18)","st(27 10)")
-Signal ("it(32 19)","st(29 10)")
-Signal ("it(33 2)","st(31 3)")
-Signal ("it(30 2)","st(29 3)")
-Signal ("it(26 2)","st(27 3)")
-Signal ("it(23 2)","st(25 3)")
-Signal ("st(10 5)","st(19 32)")
-Signal ("st(10 7)","st(57 24)")
---Signal ("it(51 25)","fl(49 25)")
---Signal ("it(38 25)","fl(38 37)")
-Signal ("st(44 38)","st(42 31)")
-Signal ("st(44 0)","st(46 31)")
-Signal ("st(28 25)","st(22 32)")
-Signal ("st(0 32)","st(1 28)")
-Signal ("st(0 32)","st(18 28)")
-oxyd_shuffle()
-    ]]></el:luamain>
-      <el:i18n>
-        <el:string el:key="title">
-          <el:english el:translate="true"/>
-          <el:translation el:lang="de">Sei ein Hans Dampf ... in allen Gassen</el:translation>
-        </el:string>
-        <el:string el:key="subtitle">
-          <el:english el:translate="true"/>
-          <el:translation el:lang="de">Finde das Paradies</el:translation>
-        </el:string>
-      </el:i18n>
-  </el:protected>
-</el:level>



From raoul at mail.berlios.de  Tue Aug 26 00:21:58 2008
From: raoul at mail.berlios.de (raoul at BerliOS)
Date: Tue, 26 Aug 2008 00:21:58 +0200
Subject: [Enigma-game-svn] r1290 - in trunk/data: . levels/enigma_cross
	levels/enigma_vi
Message-ID: <200808252221.m7PMLwFe029358@sheep.berlios.de>

Author: raoul
Date: 2008-08-26 00:21:57 +0200 (Tue, 26 Aug 2008)
New Revision: 1290

Modified:
   trunk/data/api1init.lua
   trunk/data/levels/enigma_cross/newlevels_1.0.1.xml
   trunk/data/levels/enigma_vi/index.xml
   trunk/data/levels/enigma_vi/raoul30_2.xml
Log:
-> Forgot api1init last time
-> Shortcut (very longcut) fix for "Industrial Puzzles"
   (yes, it's a nasty one :) )


Modified: trunk/data/api1init.lua
===================================================================
--- trunk/data/api1init.lua	2008-08-25 21:27:20 UTC (rev 1289)
+++ trunk/data/api1init.lua	2008-08-25 22:21:57 UTC (rev 1290)
@@ -1032,9 +1032,9 @@
 function keyb(x,y) set_item("it-key", x,y, {keycode=2.0}) end
 function keyc(x,y) set_item("it-key", x,y, {keycode=3.0}) end
 
-function shogundot1(x,y,attrs) set_item("it_shogun_s", x, y, attrs) end
-function shogundot2(x,y,attrs) set_item("it_shogun_m", x, y, attrs) end
-function shogundot3(x,y,attrs) set_item("it_shogun_l", x, y, attrs) end
+function shogundot1(x,y,attrs) set_item("it-shogun-s", x, y, attrs) end
+function shogundot2(x,y,attrs) set_item("it-shogun-m", x, y, attrs) end
+function shogundot3(x,y,attrs) set_item("it-shogun-l", x, y, attrs) end
 
 function Wormhole(x,y,targetx, targety, attribs)
     local attrs = attribs or {}

Modified: trunk/data/levels/enigma_cross/newlevels_1.0.1.xml
===================================================================
--- trunk/data/levels/enigma_cross/newlevels_1.0.1.xml	2008-08-25 21:27:20 UTC (rev 1289)
+++ trunk/data/levels/enigma_cross/newlevels_1.0.1.xml	2008-08-25 22:21:57 UTC (rev 1290)
@@ -27,7 +27,7 @@
     <level _seq="19" _title="jumping ball flash" _xpath="enigma_vi/illmind13_1" author="illmind" ctrl="force" easy="false" id="2007ill001" rel="1" rev="3" score="1" target="time" unit="duration"/>
     <level _seq="20" _title="Cold Meditation" _xpath="enigma_vii/ral18_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20070314ral728" rel="1" rev="67" score="1" target="time" unit="duration"/>
     <level _seq="21" _title="Same task ..." _xpath="enigma_vi/raoul29_1" author="Raoul Bourquin" ctrl="force" easy="true" id="raoul29" rel="1" rev="4" score="1" target="time" unit="duration"/>
-    <level _seq="22" _title="Industrial Puzzles" _xpath="enigma_vi/raoul30_2" author="Raoul Bourquin" ctrl="force" easy="false" id="raoul30" rel="2" rev="6" score="2" target="time" unit="duration"/>
+    <level _seq="22" _title="Industrial Puzzles" _xpath="enigma_vi/raoul30_2" author="Raoul Bourquin" ctrl="force" easy="false" id="raoul30" rel="2" rev="7" score="2" target="time" unit="duration"/>
     <level _seq="23" _title="Odyssey" _xpath="enigma_vi/ant39_1" author="Petr Machata" ctrl="force" easy="false" id="ant39" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="24" _title="Tandem Chess" _xpath="enigma_vi/luc34_1" author="Lukas Sch?ller" ctrl="force" easy="false" id="luc342007" rel="1" rev="2" score="1" target="time" unit="duration"/>
     <level _seq="25" _title="Magic Trinity" _xpath="enigma_vi/duffy146_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy146" rel="1" rev="1" score="1" target="time" unit="duration"/>

Modified: trunk/data/levels/enigma_vi/index.xml
===================================================================
--- trunk/data/levels/enigma_vi/index.xml	2008-08-25 21:27:20 UTC (rev 1289)
+++ trunk/data/levels/enigma_vi/index.xml	2008-08-25 22:21:57 UTC (rev 1290)
@@ -103,7 +103,7 @@
     <level _seq="95" _title="Pleasure Garden" _xpath="./duffy134_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy134" rel="1" rev="5" score="1" target="time" unit="duration"/>
     <level _seq="96" _title="Construction Workers" _xpath="./duffy142_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy142" rel="1" rev="3" score="1" target="time" unit="duration"/>
     <level _seq="97" _title="City Life" _xpath="./joona03_1" author="Joona Laire" ctrl="force" easy="true" id="20061119joona503" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="98" _title="Industrial Puzzles" _xpath="./raoul30_2" author="Raoul Bourquin" ctrl="force" easy="false" id="raoul30" rel="2" rev="6" score="2" target="time" unit="duration"/>
+    <level _seq="98" _title="Industrial Puzzles" _xpath="./raoul30_2" author="Raoul Bourquin" ctrl="force" easy="false" id="raoul30" rel="2" rev="7" score="2" target="time" unit="duration"/>
     <level _seq="99" _title="Polar Bears' Paradise" _xpath="./ral19_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20070314ral394" rel="1" rev="68" score="1" target="time" unit="duration"/>
     <level _seq="100" _title="The Aztec Temple" _xpath="./zogga01_1" author="Dominik Lehmann" ctrl="force" easy="true" id="zogga01" rel="1" rev="1" score="1" target="time" unit="duration"/>
   </levels>

Modified: trunk/data/levels/enigma_vi/raoul30_2.xml
===================================================================
--- trunk/data/levels/enigma_vi/raoul30_2.xml	2008-08-25 21:27:20 UTC (rev 1289)
+++ trunk/data/levels/enigma_vi/raoul30_2.xml	2008-08-25 22:21:57 UTC (rev 1290)
@@ -3,7 +3,7 @@
   <el:protected>
     <el:info el:type="level">
       <el:identity el:title="Industrial Puzzles" el:subtitle="" el:id="raoul30"/>
-      <el:version el:score="2" el:release="2" el:revision="6" el:status="released"/>
+      <el:version el:score="2" el:release="2" el:revision="7" el:status="released"/>
       <el:author  el:name="Raoul Bourquin" el:email="" el:homepage=""/>
       <el:copyright>Copyright ? 2007 Raoul Bourquin</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
@@ -56,7 +56,7 @@
             set_floor("fl-abyss",i-1, line)
         elseif c=="s" then
             set_stone("st-grate1",i-1, line)
-            set_item("it-seed",i-1, line)
+            set_item("it-seed_volcano",i-1, line)
         elseif c=="m" then
             set_stone("st-mail-w",i-1, line)
         elseif c=="(" then



From ral at mail.berlios.de  Wed Aug 27 23:45:03 2008
From: ral at mail.berlios.de (ral at BerliOS)
Date: Wed, 27 Aug 2008 23:45:03 +0200
Subject: [Enigma-game-svn] r1291 - in trunk: data data/schemas src src/items
	src/stones
Message-ID: <200808272145.m7RLj3u2012344@sheep.berlios.de>

Author: ral
Date: 2008-08-27 23:44:59 +0200 (Wed, 27 Aug 2008)
New Revision: 1291

Added:
   trunk/src/items/BrakeItem.cc
   trunk/src/items/BrakeItem.hh
   trunk/src/items/PipeItem.cc
   trunk/src/items/PipeItem.hh
   trunk/src/items/RubberbandItem.cc
   trunk/src/items/RubberbandItem.hh
   trunk/src/stones/BrakeStone.cc
   trunk/src/stones/BrakeStone.hh
   trunk/src/stones/FartStone.cc
   trunk/src/stones/FartStone.hh
   trunk/src/stones/MailStone.cc
   trunk/src/stones/MailStone.hh
Modified:
   trunk/data/api1init.lua
   trunk/data/api2init.lua
   trunk/data/models-2d.lua
   trunk/data/schemas/objects.xml
   trunk/src/Makefile.am
   trunk/src/items.cc
   trunk/src/items.hh
   trunk/src/ox_magnum.cc
   trunk/src/ox_oxyd1.cc
   trunk/src/ox_peroxyd.cc
   trunk/src/stones/CoinSlot.cc
   trunk/src/stones/ShogunStone.cc
   trunk/src/stones/VolcanoStone.cc
   trunk/src/stones_complex.cc
   trunk/src/stones_simple.cc
Log:
Trunk 1.1: new API reengineering
- volcano:
  - rename incactive variant to st_volcano_idle
- fart stone:
  - rename to st_fart
  - StateObject with 3 states: IDLE, ACTIVE, BREAKING
  - prepared for full swap capability
- brake:
  - rename to it_brake, st_brake
  - transfer identity between both representations on application
- shogun stone:
  - disallow wire impulses to push larger shoguns on top of smaller ones
- rubberband item:
  - extracted from items.cc
- coinslot stone:
  support of 2 new interval_s/m/l values:
  - COIN_IGNORE: accept coin but do not act
  - COIN_REJECT: do not accecpt coin
- pipe item
  - rename to it_pipe_w,... it_pipe_ns, it_pipe_nw, it_pipe_ew
    (instead of ... it-pipe-v, it-pipe-wn, it-pipe-h) 
- mail stone
  - rename to st_mail_n,...
  - attribute orientation added


Modified: trunk/data/api1init.lua
===================================================================
--- trunk/data/api1init.lua	2008-08-25 22:21:57 UTC (rev 1290)
+++ trunk/data/api1init.lua	2008-08-27 21:44:59 UTC (rev 1291)
@@ -47,6 +47,7 @@
 RenamingObjectsNew2Old = {
     it_blocker = "it-blocker",
     it_blocker_new = "it-blocker-new",
+    it_brake = "it-brake",
     it_brush = "it-brush",
     it_coin_s = "it-coin1",
     it_coin_m = "it-coin2",
@@ -62,6 +63,16 @@
     it_magicwand = "it-magicwand",
     it_magnet = "it-magnet",
     it_magnet_on = "it-magnet-on",
+    it_pipe_w = "it-pipe-w",
+    it_pipe_s = "it-pipe-s",
+    it_pipe_sw = "it-pipe-sw",
+    it_pipe_e = "it-pipe-e",
+    it_pipe_ew = "it-pipe-h",
+    it_pipe_es = "it-pipe-es",
+    it_pipe_n = "it-pipe-n",
+    it_pipe_nw = "it-pipe-nw",
+    it_pipe_ns = "it-pipe-v",
+    it_pipe_ne = "it-pipe-ne",
     it_magnet_off = "it-magnet-off",
     it_rubberband = "it-rubberband",
     it_seed = "it-seed",
@@ -107,6 +118,7 @@
     st_boulder_e = "st-bolder-e",
     st_boulder_s = "st-bolder-s",
     st_boulder_w = "st-bolder-w",
+    st_brake = "st-brake",
     st_brick = "st-brick",
     st_brick_w = "st-bigbrick-w",
     st_brick_s = "st-bigbrick-s",
@@ -132,6 +144,7 @@
     st_door_a = "st-door_a",
     st_door_b = "st-door_b",
     st_door_c = "st-door_c",
+    st_fart = "st-fart",
     st_floppy = "st-floppy",
     st_fourswitch = "st-fourswitch",
     st_knight = "st-knight",
@@ -143,6 +156,10 @@
     st_laserflop = "st-lasertimeswitch",
     st_lightpassenger = "st-lightpassenger",
     st_lightpassenger_off = "st-lightpassenger_off",
+    st_mail_w = "st-mail-w",
+    st_mail_s = "st-mail-s",
+    st_mail_e = "st-mail-e",
+    st_mail_n = "st-mail-n",
     
     st_mirror_slab_n = "st-mirror-p|",
     st_mirror_slab_e = "st-mirror-p/",
@@ -225,7 +242,7 @@
     st_volcano = "st-volcano",
     st_volcano_new = "st-volcano-growing",
     st_volcano_active = "st-volcano_active",
-    st_volcano_inactive = "st-volcano_inactive",
+    st_volcano_idle = "st-volcano_inactive",
     st_window = "st-window"
 }
 
@@ -666,7 +683,7 @@
     st_blocker_new__trigger = "toggle",
     st_boulder__direction = "orientate",
     st_door__openclose = "toggle",
-    ["st-fart__trigger"] = "toggle",
+    st_fart__trigger = "toggle",
     st_fourswitch__trigger = "toggle",
     st_floppy__onoff = "toggle",
     st_key__onoff = "toggle",

Modified: trunk/data/api2init.lua
===================================================================
--- trunk/data/api2init.lua	2008-08-25 22:21:57 UTC (rev 1290)
+++ trunk/data/api2init.lua	2008-08-27 21:44:59 UTC (rev 1291)
@@ -66,6 +66,8 @@
 ON       = 1
 CLOSED   = 0
 OPEN     = 1
+IDLE     = 0
+ACTIVE   = 1
 OXYDPAIR = 2
 
 -- color
@@ -131,6 +133,10 @@
 SPOT_LIGHTPASSENGER =  16
 SPOT_TRAP           =  32
 
+-- coinslot
+COIN_IGNORE = -1
+COIN_REJECT = -2
+
 -- follower
 FOLLOW_NO     = 0
 FOLLOW_SCROLL = 1

Modified: trunk/data/models-2d.lua
===================================================================
--- trunk/data/models-2d.lua	2008-08-25 22:21:57 UTC (rev 1290)
+++ trunk/data/models-2d.lua	2008-08-27 21:44:59 UTC (rev 1291)
@@ -479,8 +479,8 @@
 
 -- it-pipe --
 do
-    DefTiles("it-pipe", {"it-pipe-e", "it-pipe-s", "it-pipe-es", "it-pipe-sw", "it-pipe-h",
-                            "it-pipe-w", "it-pipe-n", "it-pipe-ne", "it-pipe-wn", "it-pipe-v"})
+    DefTiles("it-pipe", {"it_pipe_e", "it_pipe_s", "it_pipe_es", "it_pipe_sw", "it_pipe_ew",
+                            "it_pipe_w", "it_pipe_n", "it_pipe_ne", "it_pipe_nw", "it_pipe_ns"})
 end
 
 -- it-trigger --

Modified: trunk/data/schemas/objects.xml
===================================================================
--- trunk/data/schemas/objects.xml	2008-08-25 22:21:57 UTC (rev 1290)
+++ trunk/data/schemas/objects.xml	2008-08-27 21:44:59 UTC (rev 1291)
@@ -120,6 +120,7 @@
     </object>
     <object name="it_blocker_new" init="true">
     </object>
+    <object name="it_brake"/>
     <object name="it_brush"/>
     <object name="it_coin">
       <attr name="coin_value" default="3"/>
@@ -169,6 +170,49 @@
     <object name="it_magnet_on">
       <attr name="state" value="1"/>
     </object>
+    <object name="it_pipe">
+      <attr name="connections"/>
+      <msg name="_explosion"/>
+    </object>
+    <object name="it_pipe_w">
+      <attr name="connections" value="w"/>
+    </object>
+    <object name="it_pipe_s">
+      <attr name="connections" value="s"/>
+    </object>
+    <object name="it_pipe_sw">
+      <attr name="connections" value="sw"/>
+    </object>
+    <object name="it_pipe_e">
+      <attr name="connections" value="e"/>
+    </object>
+    <object name="it_pipe_ew">
+      <attr name="connections" value="ew"/>
+    </object>
+    <object name="it_pipe_es">
+      <attr name="connections" value="es"/>
+    </object>
+    <object name="it_pipe_n">
+      <attr name="connections" value="n"/>
+    </object>
+    <object name="it_pipe_nw">
+      <attr name="connections" value="nw"/>
+    </object>
+    <object name="it_pipe_ns">
+      <attr name="connections" value="ns"/>
+    </object>
+    <object name="it_pipe_ne">
+      <attr name="connections" value="ne"/>
+    </object>
+    <object name="it_rubberband">
+      <attr name="anchor2"/>
+      <attr name="strength" default="10"/>
+      <attr name="length"/>
+      <attr name="threshold"/>
+      <attr name="max"/>
+      <attr name="min"/>
+      <attr name="scissor"/>
+    </object>
     <object name="it_seed">
       <attr name="flavor"/>
       <attr name="secure"/>
@@ -203,15 +247,6 @@
     <object name="it_shogun_l">
       <attr name="flavor" value="l"/>
     </object>
-    <object name="it_rubberband">
-      <attr name="anchor2"/>
-      <attr name="strength" default="10"/>
-      <attr name="length"/>
-      <attr name="threshold"/>
-      <attr name="max"/>
-      <attr name="min"/>
-      <attr name="scissor"/>
-    </object>
     <object name="it_strip">
       <attr name="connections"/>
       <attr name="friction"/>
@@ -427,6 +462,9 @@
     <object name="st_boulder_n">
       <attr name="orientation" value="3"/>
     </object>
+    <object name="st_brake">
+      <msg name="_explosion"/>
+    </object>
     <object name="st_brick" super="st_clusterstone"/>
     <object name="st_brick_w">
       <attr name="connections" value="w"/>
@@ -523,6 +561,12 @@
     <object name="st_door_d">
       <attr name="flavor" value="d"/>
     </object>
+    <object name="st_fart" states="3">
+      <msg name="ignite"/>
+      <msg name="signal"/>
+      <msg name="_explosion"/>
+      <msg name="_trigger"/>
+    </object>
     <object name="st_floppy">
       <msg name="on"/>
       <msg name="off"/>
@@ -543,6 +587,21 @@
     <object name="st_knight">
       <attr name="state" max="4" rw="r"/>
     </object>
+    <object name="st_mail">
+      <attr name="orientation"/>
+    </object>
+    <object name="st_mail_w">
+      <attr name="orientation" value="0"/>
+    </object>
+    <object name="st_mail_s">
+      <attr name="orientation" value="1"/>
+    </object>
+    <object name="st_mail_e">
+      <attr name="orientation" value="2"/>
+    </object>
+    <object name="st_mail_n">
+      <attr name="orientation" value="3"/>
+    </object>
     <object name="st_laser">
       <attr name="counterclock"/>
       <attr name="orientation"/>

Modified: trunk/src/Makefile.am
===================================================================
--- trunk/src/Makefile.am	2008-08-25 22:21:57 UTC (rev 1290)
+++ trunk/src/Makefile.am	2008-08-27 21:44:59 UTC (rev 1291)
@@ -197,12 +197,18 @@
 	lev/ScoreManager.hh	\
 	lev/VolatileIndex.cc	\
 	lev/VolatileIndex.hh	\
+	items/BrakeItem.cc	\
+	items/BrakeItem.hh	\
 	items/BlockerItem.cc	\
 	items/BlockerItem.hh	\
 	items/GlassesItem.cc	\
 	items/GlassesItem.hh	\
 	items/Magnet.cc		\
 	items/Magnet.hh		\
+	items/PipeItem.cc	\
+	items/PipeItem.hh	\
+	items/RubberbandItem.cc	\
+	items/RubberbandItem.hh	\
 	items/SeedItem.cc	\
 	items/SeedItem.hh	\
 	items/Sensor.cc		\
@@ -229,6 +235,8 @@
 	stones/BlockerStone.hh	\
 	stones/BoulderStone.cc	\
 	stones/BoulderStone.hh	\
+	stones/BrakeStone.cc	\
+	stones/BrakeStone.hh	\
 	stones/ChessStone.cc	\
 	stones/ChessStone.hh	\
 	stones/ClusterStone.cc	\
@@ -241,6 +249,8 @@
 	stones/DeathStone.hh	\
 	stones/Door.cc		\
 	stones/Door.hh		\
+	stones/FartStone.cc	\
+	stones/FartStone.hh	\
 	stones/FloppySwitch.cc   \
 	stones/FloppySwitch.hh   \
 	stones/FourSwitch.cc	\
@@ -255,6 +265,8 @@
 	stones/LaserSwitch.hh	\
 	stones/LightPassengerStone.cc	\
 	stones/LightPassengerStone.hh	\
+	stones/MailStone.cc	\
+	stones/MailStone.hh	\
 	stones/MirrorStone.cc	\
 	stones/MirrorStone.hh	\
 	stones/MonoFlopStone.cc	\

Added: trunk/src/items/BrakeItem.cc
===================================================================
--- trunk/src/items/BrakeItem.cc	2008-08-25 22:21:57 UTC (rev 1290)
+++ trunk/src/items/BrakeItem.cc	2008-08-27 21:44:59 UTC (rev 1291)
@@ -0,0 +1,60 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *  
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include "items/BrakeItem.hh"
+
+//#include "main.hh"
+#include "world.hh"
+
+namespace enigma {
+    BrakeItem::BrakeItem() {
+    }
+    
+    void BrakeItem::on_creation(GridPos p) {
+        SetStone(p, MakeStone("st_brake"));
+        kill();
+    }
+    
+    std::string BrakeItem::get_inventory_model() {
+        return "st-brake";
+    }
+    
+    ItemAction BrakeItem::activate(Actor* a, GridPos p) {
+        return ITEM_DROP;
+    }
+    
+    bool BrakeItem::can_drop_at(GridPos p) {
+        return GetStone(p) == NULL;
+    }
+    
+    void BrakeItem::drop (Actor *a, GridPos p) {
+        Stone *st = MakeStone("st_brake");
+        SetStone(p, st);
+        transferIdentity(st);
+        kill();
+    }
+    
+    DEF_ITEMTRAITS(BrakeItem, "it_brake", it_brake);
+    
+    BOOT_REGISTER_START
+        BootRegister(new BrakeItem(), "it_brake");
+    BOOT_REGISTER_END
+
+} // namespace enigma


Property changes on: trunk/src/items/BrakeItem.cc
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/items/BrakeItem.hh
===================================================================
--- trunk/src/items/BrakeItem.hh	2008-08-25 22:21:57 UTC (rev 1290)
+++ trunk/src/items/BrakeItem.hh	2008-08-27 21:44:59 UTC (rev 1291)
@@ -0,0 +1,48 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef BRAKEITEM_HH
+#define BRAKEITEM_HH
+
+#include "items.hh"
+
+#include "actors.hh"
+#include "stones.hh"
+
+namespace enigma {
+    class BrakeItem : public Item {
+        CLONEOBJ(BrakeItem);
+        DECL_ITEMTRAITS;
+
+    public:                
+        BrakeItem();
+        
+        // GridObject interface
+        virtual void on_creation(GridPos p);
+        
+        // Items interface
+        virtual std::string get_inventory_model();
+        virtual ItemAction activate(Actor* a, GridPos p);
+        virtual bool can_drop_at(GridPos p);
+        virtual void drop(Actor *a, GridPos p);
+    };
+    
+} // namespace enigma
+
+#endif


Property changes on: trunk/src/items/BrakeItem.hh
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/items/PipeItem.cc
===================================================================
--- trunk/src/items/PipeItem.cc	2008-08-25 22:21:57 UTC (rev 1290)
+++ trunk/src/items/PipeItem.cc	2008-08-27 21:44:59 UTC (rev 1291)
@@ -0,0 +1,121 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *  
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include "items/PipeItem.hh"
+
+//#include "main.hh"
+#include "world.hh"
+
+namespace enigma {
+
+    /** 
+     * About recursion detection while finding the end of a mailpipe
+     *  
+     * Since there are no possibilities for forking a mailpipe, there is only one 
+     * cause that may lead to a closed, circular mailpipe. This is if a pipeitem is
+     * placed exactly under the mailstone. But not every pipepiece is dangerous,
+     * there are some that can be placed under the mailstone without problems.
+     * 
+     * The mailpipe is only closed to a circular one if the pipepiece under the
+     * mailstone has the same 'output'-direction as the stone.
+     */
+    GridPos PipeItem::findPipeEndpoint(GridPos start, Direction dir) {
+        GridPos p = start;
+        Direction move_dir = dir;
+    
+        while (move_dir != NODIR) {
+            p.move(move_dir);
+            if (Item *it = GetItem(p)) {
+                if (it->getClass() == "it_pipe") {
+                    DirectionBits dbits = it->getConnections();
+                    if (has_dir(dbits, reverse(move_dir))) {
+                        dbits = (DirectionBits) (dbits & ~to_bits(reverse(move_dir)));
+                        switch (dbits) {
+                            case WESTBIT : move_dir = WEST; break;
+                            case SOUTHBIT : move_dir = SOUTH; break;
+                            case EASTBIT : move_dir = EAST; break;
+                            case NORTHBIT : move_dir = NORTH; break;
+                            default : move_dir = NODIR; break;
+                        }
+                    } else
+                        move_dir = NODIR;
+                }
+            } else
+                move_dir = NODIR;
+    
+            if (p == start && move_dir == dir)  // recursion detection
+                return GridPos(-1, -1);         // illegal position outside of world
+        }
+        return p;
+    }
+
+    PipeItem::PipeItem(std::string connections) {
+        setAttr("connections", connections);
+    }
+    
+    std::string PipeItem::getClass() const {
+        return "it_pipe";
+    }
+    
+    Value PipeItem::message(const Message &m) {
+        if (m.message == "_explosion") {
+            transform("it-explosion1");
+            return Value();
+        }
+        return Item::message(m);
+    }
+    
+    std::string PipeItem::getModelName() const {
+        return "it_pipe_";
+    }
+    
+    int PipeItem::traitsIdx() const {
+        static int idx[] = { 0, 0, 1, 2, 3, 4, 5, 0, 6, 7, 8, 0, 9, 0, 0, 0};
+        return idx[getConnections()];
+    }
+    
+    ItemTraits PipeItem::traits[10] = {
+        {"it_pipe_w",  it_pipe_w,  itf_none, 0.0},
+        {"it_pipe_s",  it_pipe_s,  itf_none, 0.0},
+        {"it_pipe_sw", it_pipe_sw, itf_none, 0.0},
+        {"it_pipe_e",  it_pipe_e,  itf_none, 0.0},
+        {"it_pipe_ew", it_pipe_ew, itf_none, 0.0},
+        {"it_pipe_es", it_pipe_es, itf_none, 0.0},
+        {"it_pipe_n",  it_pipe_n,  itf_none, 0.0},
+        {"it_pipe_nw", it_pipe_nw, itf_none, 0.0},
+        {"it_pipe_ns", it_pipe_ns, itf_none, 0.0},
+        {"it_pipe_ne", it_pipe_ne, itf_none, 0.0}
+    };
+    
+    BOOT_REGISTER_START
+        BootRegister(new PipeItem("ew"), "it_pipe");
+        BootRegister(new PipeItem("w"),  "it_pipe_w");
+        BootRegister(new PipeItem("s"),  "it_pipe_s");
+        BootRegister(new PipeItem("sw"), "it_pipe_sw");
+        BootRegister(new PipeItem("e"),  "it_pipe_e");
+        BootRegister(new PipeItem("ew"), "it_pipe_ew");
+        BootRegister(new PipeItem("es"), "it_pipe_es");
+        BootRegister(new PipeItem("n"),  "it_pipe_n");
+        BootRegister(new PipeItem("nw"), "it_pipe_nw");
+        BootRegister(new PipeItem("ns"), "it_pipe_ns");
+        BootRegister(new PipeItem("ne"), "it_pipe_ne");
+    BOOT_REGISTER_END
+
+} // namespace enigma


Property changes on: trunk/src/items/PipeItem.cc
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/items/PipeItem.hh
===================================================================
--- trunk/src/items/PipeItem.hh	2008-08-25 22:21:57 UTC (rev 1290)
+++ trunk/src/items/PipeItem.hh	2008-08-27 21:44:59 UTC (rev 1291)
@@ -0,0 +1,51 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef PIPEITEM_HH
+#define PIPEITEM_HH
+
+#include "items.hh"
+
+
+namespace enigma {
+    class PipeItem : public Item {
+        CLONEOBJ(PipeItem);
+        DECL_ITEMTRAITS_ARRAY(10, traitsIdx());
+
+    public:
+        static GridPos findPipeEndpoint(GridPos start, Direction dir);
+    
+        PipeItem(std::string connections);
+
+        // Object interface
+        virtual std::string getClass() const;
+        virtual Value message(const Message &m);
+
+        // Gridobject interface
+        virtual std::string getModelName() const;
+        
+        // Item interface
+        
+    private:
+        int traitsIdx() const;
+    };
+    
+} // namespace enigma
+
+#endif


Property changes on: trunk/src/items/PipeItem.hh
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/items/RubberbandItem.cc
===================================================================
--- trunk/src/items/RubberbandItem.cc	2008-08-25 22:21:57 UTC (rev 1290)
+++ trunk/src/items/RubberbandItem.cc	2008-08-27 21:44:59 UTC (rev 1291)
@@ -0,0 +1,80 @@
+/*
+ * Copyright (C) 2006,2007 Raoul Bourquin
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *  
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include "items/RubberbandItem.hh"
+
+//#include "main.hh"
+#include "world.hh"
+
+namespace enigma {
+    RubberbandItem::RubberbandItem() {
+    }
+    
+    std::string RubberbandItem::getClass() const {
+        return "it_rubberband";
+    }
+    
+    ItemAction RubberbandItem::activate(Actor *a, GridPos p) {
+        // TODO: Multiple Targets!
+        // TODO: Target for black and target for white marble?
+        // TODO: MultiplayerGame: Defaulttarget is second actor!
+
+        // Get actor or stone with the name, given in "connect_to":
+        ObjectList ol = getAttr("anchor2").getObjectList(a);
+        
+        // Target does NOT exist, Drop Item
+        if (ol.size() == 0)
+            return ITEM_DROP;
+
+        Object *anchor2 = ol.front();
+            
+        // The mode attribute "scissor" defines, if when using an it-rubberband,
+        // other rubberbands to the actor will be cut of or not, true means they will. false is default.
+        bool isScissor = to_bool(getAttr("scissor"));
+
+        if (isScissor)
+            SendMessage(a, "disconnect");
+
+        sound_event ("rubberband");
+        
+        if (anchor2 != a) { // It's not allowed to connect a rubberband to self.
+            Object *obj = MakeObject("ot_rubberband");
+            obj->setAttr("anchor1", a);
+            obj->setAttr("anchor2", anchor2);
+            obj->setAttr("strength", getAttr("strength"));
+            obj->setAttr("length", getAttr("length"));
+            obj->setAttr("threshold", getAttr("threshold"));
+            obj->setAttr("max", getAttr("max"));
+            obj->setAttr("min", getAttr("min"));
+            AddOther(dynamic_cast<Other *>(obj));
+            transferIdentity(obj);
+            SendMessage(obj, "_performaction");
+        }
+
+        return ITEM_KILL;
+    }
+    
+    DEF_ITEMTRAITS(RubberbandItem, "it_rubberband", it_rubberband);
+    
+    BOOT_REGISTER_START
+        BootRegister(new RubberbandItem(), "it_rubberband");
+    BOOT_REGISTER_END
+
+} // namespace enigma


Property changes on: trunk/src/items/RubberbandItem.cc
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/items/RubberbandItem.hh
===================================================================
--- trunk/src/items/RubberbandItem.hh	2008-08-25 22:21:57 UTC (rev 1290)
+++ trunk/src/items/RubberbandItem.hh	2008-08-27 21:44:59 UTC (rev 1291)
@@ -0,0 +1,44 @@
+/*
+ * Copyright (C) 2006,2007 Raoul Bourquin
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef RUBBERBANDITEM_HH
+#define RUBBERBANDITEM_HH
+
+#include "items.hh"
+
+#include "actors.hh"
+
+namespace enigma {
+    class RubberbandItem : public Item {
+        CLONEOBJ(RubberbandItem);
+        DECL_ITEMTRAITS;
+
+    public:
+        RubberbandItem();
+
+        // Object interface
+        virtual std::string getClass() const;
+
+        // Item interface
+        virtual ItemAction activate(Actor* a, GridPos p);
+    };
+    
+} // namespace enigma
+
+#endif


Property changes on: trunk/src/items/RubberbandItem.hh
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/src/items.cc
===================================================================
--- trunk/src/items.cc	2008-08-25 22:21:57 UTC (rev 1290)
+++ trunk/src/items.cc	2008-08-27 21:44:59 UTC (rev 1291)
@@ -1048,46 +1048,6 @@
     DEF_ITEMTRAITSF(Springboard, "it-springboard", it_springboard, itf_static);
 }
 
-
-/* -------------------- Brake -------------------- */
-
-// Brake is only used to hold st-brake while it is in an inventory
-
-// TODO transfer identity !!
-namespace
-{
-    class Brake : public Item {
-        CLONEOBJ(Brake);
-        DECL_ITEMTRAITS;
-    public:
-        Brake() {}
-
-        void on_creation (GridPos p) {
-            SetStone(p, MakeStone("st-brake"));
-            kill();
-        }
-
-        bool can_drop_at (GridPos p) {
-            return GetStone(p) == 0;
-        }
-
-        void drop (Actor *, GridPos p) {
-            SetStone(p, MakeStone("st-brake"));
-            kill();
-        }
-
-        string get_inventory_model() {
-            return "st-brake";
-        }
-
-        ItemAction activate(Actor *, GridPos) {
-            return ITEM_DROP;
-        }
-    };
-    DEF_ITEMTRAITS(Brake, "it-brake", it_brake);
-}
-
-
 /* -------------------- Explosion -------------------- */
 namespace
 {
@@ -1469,45 +1429,6 @@
     DEF_ITEMTRAITS(Spade, "it-spade", it_spade);
 }
 
-
-/* -------------------- Pipes -------------------- */
-namespace
-{
-    class Pipe : public Item {
-        CLONEOBJ(Pipe);
-        int subtype;
-        DECL_ITEMTRAITS_ARRAY(10, subtype);
-
-        Pipe(int stype) : subtype(stype) {}
-        virtual Value message(const Message &m) {
-            if (m.message == "_explosion") {
-                replace("it-explosion1");
-                return Value();
-            }
-            return Item::message(m);
-        }
-    public:
-        static void setup() {
-            for (int i=0; i<10; ++i)
-                RegisterItem (new Pipe (i));
-        }
-    };
-
-    ItemTraits Pipe::traits[] = {
-        {"it-pipe-e",  it_pipe_e,  itf_none, 0.0 },
-        {"it-pipe-w",  it_pipe_w,  itf_none, 0.0 },
-        {"it-pipe-s",  it_pipe_s,  itf_none, 0.0 },
-        {"it-pipe-n",  it_pipe_n,  itf_none, 0.0 },
-        {"it-pipe-es", it_pipe_es, itf_none, 0.0 },
-        {"it-pipe-ne", it_pipe_ne, itf_none, 0.0 },
-        {"it-pipe-sw", it_pipe_sw, itf_none, 0.0 },
-        {"it-pipe-wn", it_pipe_wn, itf_none, 0.0 },
-        {"it-pipe-h",  it_pipe_h,  itf_none, 0.0 },
-        {"it-pipe-v",  it_pipe_v,  itf_none, 0.0 },
-    };
-}
-
-
 /* -------------------- Pullers -------------------- */
 namespace
 {
@@ -2609,71 +2530,6 @@
     DEF_ITEMTRAITS(Drop, "it-drop", it_drop);
 }
 
-/* -------------------- Rubberband Item-------------------- */
-    class RubberbandItem : public Item {
-        CLONEOBJ(RubberbandItem);
-        DECL_ITEMTRAITS;
-
-    public:
-        RubberbandItem();
-
-        // Object interface
-        virtual std::string getClass() const;
-
-        // Item interface
-        virtual ItemAction activate(Actor* a, GridPos p);
-};
-    
-    RubberbandItem::RubberbandItem() {
-    }
-    
-    std::string RubberbandItem::getClass() const {
-        return "it_rubberband";
-    }
-    
-    ItemAction RubberbandItem::activate(Actor *a, GridPos p) {
-        // TODO: Multiple Targets!
-        // TODO: Target for black and target for white marble?
-        // TODO: MultiplayerGame: Defaulttarget is second actor!
-
-        // Get actor or stone with the name, given in "connect_to":
-        ObjectList ol = getAttr("anchor2").getObjectList(a);
-        
-        // Target does NOT exist, Drop Item
-        if (ol.size() == 0)
-            return ITEM_DROP;
-
-        Object *anchor2 = ol.front();
-            
-        // The mode attribute "scissor" defines, if when using an it-rubberband,
-        // other rubberbands to the actor will be cut of or not, true means they will. false is default.
-        bool isScissor = to_bool(getAttr("scissor"));
-
-        if (isScissor)
-            SendMessage(a, "disconnect");
-
-        sound_event ("rubberband");
-        
-        if (anchor2 != a) { // It's not allowed to connect a rubberband to self.
-            Object *obj = MakeObject("ot_rubberband");
-            obj->setAttr("anchor1", a);
-            obj->setAttr("anchor2", anchor2);
-            obj->setAttr("strength", getAttr("strength"));
-            obj->setAttr("length", getAttr("length"));
-            obj->setAttr("threshold", getAttr("threshold"));
-            obj->setAttr("max", getAttr("max"));
-            obj->setAttr("min", getAttr("min"));
-            AddOther(dynamic_cast<Other *>(obj));
-            transferIdentity(obj);
-            SendMessage(obj, "_performaction");
-        }
-
-        return ITEM_KILL;
-    }
-    
-    DEF_ITEMTRAITS(RubberbandItem, "it_rubberband", it_rubberband);
-
-
 /* -------------------- Functions -------------------- */
 
 void InitItems()
@@ -2683,7 +2539,6 @@
     RegisterItem (new BlackBomb);
     RegisterItem (new BlackBombBurning);
     RegisterItem (new Booze);
-    RegisterItem (new Brake);
     RegisterItem (new BrokenBooze);
     RegisterItem (new Brush);
     Burnable::setup();
@@ -2724,10 +2579,8 @@
     RegisterItem (new OxydBridgeActive);
     RegisterItem (new Pencil);
     RegisterItem (new Pin);
-    Pipe::setup();
     Puller::setup();
     RegisterItem (new Ring);
-    RegisterItem (new RubberbandItem);
     RegisterItem (new Spade);
     RegisterItem (new Spoon);
     RegisterItem (new Spring1);

Modified: trunk/src/items.hh
===================================================================
--- trunk/src/items.hh	2008-08-25 22:21:57 UTC (rev 1290)
+++ trunk/src/items.hh	2008-08-27 21:44:59 UTC (rev 1291)
@@ -92,8 +92,8 @@
         it_pencil,
         it_pin,
         it_pipe_e, it_pipe_w, it_pipe_s, it_pipe_n,
-        it_pipe_es, it_pipe_ne, it_pipe_sw, it_pipe_wn,
-        it_pipe_h, it_pipe_v,
+        it_pipe_es, it_pipe_ne, it_pipe_sw, it_pipe_nw,
+        it_pipe_ew, it_pipe_ns,
         it_puller_n,
         it_puller_e,
         it_puller_s,
@@ -214,9 +214,9 @@
           register a ForceField in the world. */
         virtual void add_force(Actor *a, ecl::V2 &f);
 
-        virtual bool can_drop_at (GridPos p);
+        virtual bool can_drop_at(GridPos p);
 
-        virtual void drop (Actor *a, GridPos p);
+        virtual void drop(Actor *a, GridPos p);
 
         /*! Called when item is dropped by actor `a' */
         virtual void on_drop(Actor *a);

Modified: trunk/src/ox_magnum.cc
===================================================================
--- trunk/src/ox_magnum.cc	2008-08-25 22:21:57 UTC (rev 1290)
+++ trunk/src/ox_magnum.cc	2008-08-27 21:44:59 UTC (rev 1291)
@@ -227,10 +227,10 @@
     "st_shogun_s",              // OxydMagnum stone 0x6c
     "st-stoneimpulse",          // OxydMagnum stone 0x6d
     "st_laserflop",             // OxydMagnum stone 0x6e
-    "st-mail-n",                // OxydMagnum stone 0x6f
-    "st-mail-w",                // OxydMagnum stone 0x70
-    "st-mail-e",                // OxydMagnum stone 0x71
-    "st-mail-s",                // OxydMagnum stone 0x72
+    "st_mail_n",                // OxydMagnum stone 0x6f
+    "st_mail_w",                // OxydMagnum stone 0x70
+    "st_mail_e",                // OxydMagnum stone 0x71
+    "st_mail_s",                // OxydMagnum stone 0x72
     "st_door_d",                // OxydMagnum stone 0x73
     "st_door_d_ew",             // OxydMagnum stone 0x74
     "st-metal",                 // OxydMagnum stone 0x75
@@ -318,12 +318,12 @@
     "it-flagwhite",     // OxydMagnum item 0x19
     "it-flagblack",     // OxydMagnum item 0x1a
     "it-ring",          // OxydMagnum item 0x1b
-    "it-pipe-wn",       // OxydMagnum item 0x1c
-    "it-pipe-sw",       // OxydMagnum item 0x1d
-    "it-pipe-ne",       // OxydMagnum item 0x1e
-    "it-pipe-es",       // OxydMagnum item 0x1f
-    "it-pipe-v",        // OxydMagnum item 0x20
-    "it-pipe-h",        // OxydMagnum item 0x21
+    "it_pipe_nw",       // OxydMagnum item 0x1c
+    "it_pipe_sw",       // OxydMagnum item 0x1d
+    "it_pipe_ne",       // OxydMagnum item 0x1e
+    "it_pipe_es",       // OxydMagnum item 0x1f
+    "it_pipe_ns",        // OxydMagnum item 0x20
+    "it_pipe_ew",        // OxydMagnum item 0x21
     "it-spade",         // OxydMagnum item 0x22
     UNUSED,        // OxydMagnum item 0x23
     "it-pin",           // OxydMagnum item 0x24

Modified: trunk/src/ox_oxyd1.cc
===================================================================
--- trunk/src/ox_oxyd1.cc	2008-08-25 22:21:57 UTC (rev 1290)
+++ trunk/src/ox_oxyd1.cc	2008-08-27 21:44:59 UTC (rev 1291)
@@ -259,10 +259,10 @@
     "st_shogun_s",              // Oxyd1 stone 0x6c
     "st-stoneimpulse",          // Oxyd1 stone 0x6d
     "st_laserflop",             // Oxyd1 stone 0x6e
-    "st-mail-n",                // Oxyd1 stone 0x6f
-    "st-mail-w",                // Oxyd1 stone 0x70
-    "st-mail-e",                // Oxyd1 stone 0x71
-    "st-mail-s",                // Oxyd1 stone 0x72
+    "st_mail_n",                // Oxyd1 stone 0x6f
+    "st_mail_w",                // Oxyd1 stone 0x70
+    "st_mail_e",                // Oxyd1 stone 0x71
+    "st_mail_s",                // Oxyd1 stone 0x72
     "st_door_d",                // Oxyd1 stone 0x73
     "st_door_d_ew",             // Oxyd1 stone 0x74
     "st-metal",                 // Oxyd1 stone 0x75
@@ -334,12 +334,12 @@
     "it-flagwhite",               // 0x19
     "it-flagblack",               // 0x1a
     "it-ring",                    // 0x1b
-    "it-pipe-wn",                 // 0x1c
-    "it-pipe-sw",                 // 0x1d
-    "it-pipe-ne",                 // 0x1e
-    "it-pipe-es",                 // 0x1f
-    "it-pipe-v",                  // 0x20
-    "it-pipe-h",                  // 0x21
+    "it_pipe_nw",                 // 0x1c
+    "it_pipe_sw",                 // 0x1d
+    "it_pipe_ne",                 // 0x1e
+    "it_pipe_es",                 // 0x1f
+    "it_pipe_ns",                 // 0x20
+    "it_pipe_ew",                 // 0x21
     "it-spade",                   // 0x22
     "it-surprise",                // 0x23
     "it-pin",                     // 0x24

Modified: trunk/src/ox_peroxyd.cc
===================================================================
--- trunk/src/ox_peroxyd.cc	2008-08-25 22:21:57 UTC (rev 1290)
+++ trunk/src/ox_peroxyd.cc	2008-08-27 21:44:59 UTC (rev 1291)
@@ -299,10 +299,10 @@
     "st_shogun_sm",             // PerOxyd stone 0x6c
     "st-stoneimpulse",          // PerOxyd stone 0x6d
     "st_laserflop",             // PerOxyd stone 0x6e
-    "st-mail-n",                // PerOxyd stone 0x6f
-    "st-mail-w",                // PerOxyd stone 0x70
-    "st-mail-e",                // PerOxyd stone 0x71
-    "st-mail-s",                // PerOxyd stone 0x72
+    "st_mail_n",                // PerOxyd stone 0x6f
+    "st_mail_w",                // PerOxyd stone 0x70
+    "st_mail_e",                // PerOxyd stone 0x71
+    "st_mail_s",                // PerOxyd stone 0x72
     "st_door_d",                // PerOxyd stone 0x73
     "st_door_d_ew",             // PerOxyd stone 0x74
     "st-metal",                 // PerOxyd stone 0x75
@@ -345,7 +345,7 @@
     "st-grate1",                // PerOxyd stone 0x9a
     "st-metal_hole",            // PerOxyd stone 0x9b
     "st-stone1",                // PerOxyd stone 0x9c
-    "st-fart",                  // PerOxyd stone 0x9d
+    "st_fart",                  // PerOxyd stone 0x9d
     "st_turnstile_red",         // PerOxyd stone 0x9e
     "st_turnstilearm_n",        // PerOxyd stone 0x9f
     "st_turnstilearm_s",        // PerOxyd stone 0xa0
@@ -406,12 +406,12 @@
     "it-flagwhite",               // 0x18
     "it-flagblack",               // 0x19
     "it-ring",                    // 0x1a
-    "it-pipe-wn",                 // 0x1b
-    "it-pipe-sw",                 // 0x1c
-    "it-pipe-ne",                 // 0x1d
-    "it-pipe-es",                 // 0x1e
-    "it-pipe-v",                  // 0x1f
-    "it-pipe-h",                  // 0x20
+    "it_pipe_nw",                 // 0x1b
+    "it_pipe_sw",                 // 0x1c
+    "it_pipe_ne",                 // 0x1d
+    "it_pipe_es",                 // 0x1e
+    "it_pipe_ns",                  // 0x1f
+    "it_pipe_ew",                  // 0x20
     "it-spade",                   // 0x21
     "it-surprise",                // 0x22
     "it-pin",                     // 0x23
@@ -447,7 +447,7 @@
     "it_brush",                   // 0x41
     "it-banana",                  // 0x42
     "it-pencil",                  // 0x43
-    "it-brake",                   // 0x44
+    "it_brake",                   // 0x44
     "it-squashed",                // 0x45
     "it_blocker",                 // 0x46
     "it_magicwand",               // 0x47

Added: trunk/src/stones/BrakeStone.cc
===================================================================
--- trunk/src/stones/BrakeStone.cc	2008-08-25 22:21:57 UTC (rev 1290)
+++ trunk/src/stones/BrakeStone.cc	2008-08-27 21:44:59 UTC (rev 1291)
@@ -0,0 +1,93 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *  
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include "stones/BrakeStone.hh"
+#include "player.hh"
+#include "world.hh"
+//#include "main.hh"
+
+namespace enigma {
+    BrakeStone::BrakeStone() {
+    }
+    
+    std::string BrakeStone::getClass() const {
+        return "st_brake";
+    }
+    
+    Value BrakeStone::message(const Message &m) {
+        if (m.message == "_explosion") {
+            explode();
+            return Value();
+        }
+        return Stone::message(m);
+    }
+
+    void BrakeStone::init_model() {
+        set_model("st-brake");
+    }
+    
+    void BrakeStone::on_creation (GridPos p) {
+        Stone::on_creation(p);
+
+        Item    *it = GetItem(p);
+        if (it && it->is_kind("it_blocker")) {
+            KillItem(p);
+        }
+    }
+    
+    void BrakeStone::processLight(Direction d) {
+        explode();
+    }
+
+    bool BrakeStone::is_sticky(const Actor *a) const {
+        return false;
+    }
+    
+    StoneResponse BrakeStone::collision_response(const StoneContact &sc) {
+        return STONE_PASS;
+    }
+    
+    void BrakeStone::actor_inside(Actor *a) {
+        static const double BRAKE_RADIUS = 0.3;
+        GridPos p = get_pos();
+        double dist = ecl::length(a->get_pos() - p.center());
+
+        if (dist < BRAKE_RADIUS) {
+            player::PickupStoneAsItem(a, p);
+        }
+    }
+    
+    void BrakeStone::on_move() {
+        // we are not floating, but we do not shatter actors when swapped or pulled
+    }
+    
+    void BrakeStone::explode() {
+        GridPos p = get_pos();
+        KillStone(p);
+        SetItem(p, MakeItem("it-explosion1"));
+    }
+            
+    DEF_TRAITSM(BrakeStone, "st_brake", st_brake, MOVABLE_BREAKABLE);
+    
+    BOOT_REGISTER_START
+        BootRegister(new BrakeStone(), "st_brake");
+    BOOT_REGISTER_END
+
+} // namespace enigma


Property changes on: trunk/src/stones/BrakeStone.cc
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/stones/BrakeStone.hh
===================================================================
--- trunk/src/stones/BrakeStone.hh	2008-08-25 22:21:57 UTC (rev 1290)
+++ trunk/src/stones/BrakeStone.hh	2008-08-27 21:44:59 UTC (rev 1291)
@@ -0,0 +1,59 @@
+/*
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef BRAKESTONE_HH
+#define BRAKESTONE_HH
+
+#include "stones.hh"
+
+#include "stones_internal.hh"
+
+namespace enigma {
+
+    /** 
+     * 
+     */
+    class BrakeStone : public Stone {
+        CLONEOBJ(BrakeStone);
+        DECL_TRAITS;
+        
+    public:
+        BrakeStone();
+
+        // Object interface
+        virtual std::string getClass() const;
+        virtual Value message(const Message &m);
+        
+        // GridObject interface
+        virtual void init_model();
+        virtual void on_creation(GridPos p);
+        virtual void processLight(Direction d);
+        
+        // Stone interface
+        virtual bool is_sticky(const Actor *a) const;
+        virtual StoneResponse collision_response(const StoneContact &sc);
+        virtual void actor_inside(Actor *a);
+        virtual void on_move();
+         
+    private:
+        void explode();
+    };
+
+} // namespace enigma
+
+#endif


Property changes on: trunk/src/stones/BrakeStone.hh
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/src/stones/CoinSlot.cc
===================================================================
--- trunk/src/stones/CoinSlot.cc	2008-08-25 22:21:57 UTC (rev 1290)
+++ trunk/src/stones/CoinSlot.cc	2008-08-27 21:44:59 UTC (rev 1291)
@@ -113,7 +113,7 @@
                     double interval;
                     if (server::EnigmaCompatibility < 1.10) 
                         interval = it->getAttr("coin_value");
-                    else 
+                    else {
                         switch (id) {
                             case it_coin1:
                                 interval = getAttr("interval_s"); break;
@@ -122,20 +122,25 @@
                             case it_coin4:
                                 interval = getAttr("interval_l"); break;
                         }
-                    
-                    if (objFlags & OBJBIT_INSTANT) {
-                        // start or update timer
-                        double rest = GameTimer.remove_alarm(this);
-                        GameTimer.set_alarm(this, interval + rest, false);
-                    } else {
-                        // remember time value for animcb evaluation
-                        setAttr("$addTime", (double)getAttr("$addTime") + interval);
+                        if (interval == -2)  // reject coin
+                            return;
                     }
+                    if (interval > 0) {
+                        if (objFlags & OBJBIT_INSTANT) {
+                            // start or update timer
+                            double rest = GameTimer.remove_alarm(this);
+                            GameTimer.set_alarm(this, interval + rest, false);
+                        } else {
+                            // remember time value for animcb evaluation
+                            setAttr("$addTime", (double)getAttr("$addTime") + interval);
+                        }
+                    }
                     inv->yield_first();
                     player::RedrawInventory(inv);
                     delete it;
                     
-                    setIState((objFlags & OBJBIT_INSTANT) ? INSERT_ON : (iState)(state + 2));
+                    if (interval > 0)
+                        setIState((objFlags & OBJBIT_INSTANT) ? INSERT_ON : (iState)(state + 2));
                 }
             }
         }

Added: trunk/src/stones/FartStone.cc
===================================================================
--- trunk/src/stones/FartStone.cc	2008-08-25 22:21:57 UTC (rev 1290)
+++ trunk/src/stones/FartStone.cc	2008-08-27 21:44:59 UTC (rev 1291)
@@ -0,0 +1,119 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *  
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include "stones/FartStone.hh"
+#include "player.hh"
+#include "world.hh"
+//#include "main.hh"
+
+namespace enigma {
+    FartStone::FartStone() {
+    }
+    
+    std::string FartStone::getClass() const {
+        return "st_fart";
+    }
+    
+    Value FartStone::message(const Message &m) {
+        if (m.message == "toggle" || (m.message == "signal" && m.value != 0) ||
+                (m.message == "_trigger" && m.value.to_bool())) {
+            setState(ACTIVE);
+            return Value();
+        } else if (m.message == "ignite" || m.message == "_explosion") { 
+            setState(BREAKING);
+            return Value();
+        }
+        return Stone::message(m);
+    }
+
+    int FartStone::maxState() const {
+        return BREAKING;
+    }
+    
+    int FartStone::externalState() const {
+        return (state == ACTIVEBREAKING) ? BREAKING : state;
+    }
+    
+    void FartStone::setState(int extState) {
+        if (state == extState)
+            return;
+            
+        if ((state == IDLE && extState == BREAKING) || (state == ACTIVEBREAKING && extState == IDLE)) {
+            state = BREAKING;
+            if (isDisplayable()) {
+                fart();
+                sound_event("stonedestroy");
+            }
+        } else if (state == IDLE && extState == ACTIVE) {
+            state = ACTIVE;
+            if (isDisplayable())            
+                fart();
+        } else if (state == ACTIVE && extState == IDLE) {
+            state = IDLE;
+        } else if (state == ACTIVE && extState == BREAKING) {
+            state = ACTIVEBREAKING;
+        } else
+            return;
+        
+        if (isDisplayable())
+            init_model();
+    }
+    
+    void FartStone::init_model() {
+        switch (state) {
+            case IDLE:     set_model("st-fart"); break;
+            case ACTIVEBREAKING:
+            case ACTIVE:   set_anim("st-farting"); break;
+            case BREAKING: set_anim("st-fartbreak-anim"); break;
+        }
+    }
+    
+    void FartStone::processLight(Direction d) {
+        setState(BREAKING);
+    }
+
+    void FartStone::animcb() {
+        if (state == ACTIVE || state == ACTIVEBREAKING)
+            setState(IDLE);
+        else if (state == BREAKING)
+            KillStone(get_pos());
+    }
+
+    void FartStone::actor_hit(const StoneContact &sc) {
+        if (player::WieldedItemIs(sc.actor, "it_hammer"))
+            setState(BREAKING);
+        else
+            setState(ACTIVE);
+    }
+    
+    void FartStone::fart() {
+        Object *ox = GetObjectTemplate("st_oxyd");
+        SendMessage(ox, "closeall");
+        sound_event("fart");
+    }
+    
+        
+    DEF_TRAITSM(FartStone, "st_fart", st_fart, MOVABLE_BREAKABLE);
+    
+    BOOT_REGISTER_START
+        BootRegister(new FartStone(), "st_fart");
+    BOOT_REGISTER_END
+
+} // namespace enigma


Property changes on: trunk/src/stones/FartStone.cc
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/stones/FartStone.hh
===================================================================
--- trunk/src/stones/FartStone.hh	2008-08-25 22:21:57 UTC (rev 1290)
+++ trunk/src/stones/FartStone.hh	2008-08-27 21:44:59 UTC (rev 1291)
@@ -0,0 +1,71 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef FARTSTONE_HH
+#define FARTSTONE_HH
+
+#include "stones.hh"
+
+#include "stones_internal.hh"
+
+namespace enigma {
+
+    /** 
+     * 
+     */
+    class FartStone : public Stone {
+        CLONEOBJ(FartStone);
+        DECL_TRAITS;
+    private:
+        enum iState {
+            IDLE,           ///< 
+            ACTIVE,         ///< 
+            BREAKING,       ///< 
+            ACTIVEBREAKING  ///< active state with a pending breaking 
+        };
+        
+    public:
+        FartStone();
+        
+        // Object interface
+        virtual std::string getClass() const;        
+        virtual Value message(const Message &m);
+        
+        // StateObject interface
+        virtual int maxState() const;
+        virtual int externalState() const;
+        virtual void setState(int extState);
+
+        // GridObject interface
+        virtual void init_model();
+        virtual void processLight(Direction d);
+        
+        // ModelCallback interface
+        virtual void animcb();
+        
+        // Stone interface
+        virtual void actor_hit(const StoneContact &sc);
+
+    private:
+        void fart();
+    };
+
+} // namespace enigma
+
+#endif


Property changes on: trunk/src/stones/FartStone.hh
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/stones/MailStone.cc
===================================================================
--- trunk/src/stones/MailStone.cc	2008-08-25 22:21:57 UTC (rev 1290)
+++ trunk/src/stones/MailStone.cc	2008-08-27 21:44:59 UTC (rev 1291)
@@ -0,0 +1,77 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *  
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include "stones/MailStone.hh"
+#include "Inventory.hh"
+#include "player.hh"
+#include "world.hh"
+#include "items/PipeItem.hh"
+//#include "main.hh"
+
+namespace enigma {
+    MailStone::MailStone(Direction dir) : Stone("st_mail") {
+        setAttr("orientation", Value(dir));
+    }
+    
+    std::string MailStone::getClass() const {
+        return "st_mail";
+    }
+    
+    void MailStone::setAttr(const string& key, const Value &val) {
+        if (isDisplayable())
+            if (key == "orientation") {
+                Stone::setAttr(key, val);
+                init_model();
+                return;
+            }
+        Stone::setAttr(key, val);
+    }
+
+    void MailStone::init_model() {
+        string mname = "st-mail" ;
+        set_model(mname + to_suffix(getOrientation()));
+    }
+    
+    void MailStone::actor_hit(const StoneContact &sc) {
+        if (enigma::Inventory *inv = player::GetInventory(sc.actor)) {
+            if (Item *it = inv->get_item(0)) {
+                GridPos p = PipeItem::findPipeEndpoint(get_pos(), getOrientation());
+                if (IsInsideLevel(p) && it->can_drop_at (p)) {
+                    it = inv->yield_first();
+                    player::RedrawInventory (inv);
+                    it->drop(sc.actor, p);
+                }
+            }
+        }
+    }
+    
+    Direction MailStone::getOrientation() const {
+        return to_direction(getAttr("orientation"));
+    }
+        
+    BOOT_REGISTER_START
+        BootRegister(new MailStone(NORTH), "st_mail");
+        BootRegister(new MailStone(NORTH), "st_mail_n");
+        BootRegister(new MailStone(EAST),  "st_mail_e");
+        BootRegister(new MailStone(SOUTH), "st_mail_s");
+        BootRegister(new MailStone(WEST),  "st_mail_w");
+    BOOT_REGISTER_END
+
+} // namespace enigma


Property changes on: trunk/src/stones/MailStone.cc
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/stones/MailStone.hh
===================================================================
--- trunk/src/stones/MailStone.hh	2008-08-25 22:21:57 UTC (rev 1290)
+++ trunk/src/stones/MailStone.hh	2008-08-27 21:44:59 UTC (rev 1291)
@@ -0,0 +1,54 @@
+/*
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef MAILSTONE_HH
+#define MAILSTONE_HH
+
+#include "stones.hh"
+
+#include "stones_internal.hh"
+
+namespace enigma {
+
+    /** 
+     * 
+     */
+    class MailStone : public Stone {
+        CLONEOBJ(MailStone);
+//        DECL_TRAITS;
+        
+    public:
+        MailStone(Direction dir);
+
+        // Object interface
+        virtual std::string getClass() const;
+        virtual void setAttr(const string& key, const Value &val);
+        
+        // GridObject interface
+        virtual void init_model();
+        
+        // Stone interface
+        virtual void actor_hit(const StoneContact &sc);
+         
+    private:
+        Direction getOrientation() const;
+    };
+
+} // namespace enigma
+
+#endif


Property changes on: trunk/src/stones/MailStone.hh
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/src/stones/ShogunStone.cc
===================================================================
--- trunk/src/stones/ShogunStone.cc	2008-08-25 22:21:57 UTC (rev 1290)
+++ trunk/src/stones/ShogunStone.cc	2008-08-27 21:44:59 UTC (rev 1291)
@@ -168,7 +168,7 @@
                 fitsNeighborShogun = (nss->getHoles() & (2*ownHole() -1)) == 0;
         }
         
-        if ((st == NULL) || fitsNeighborShogun) {  // can we move?
+        if ((subShogun == NULL) && ((st == NULL) || fitsNeighborShogun)) {  // can we move?
             // first remove from current position
             if (!yieldShogun())
                 return;            // being swapped or pulled

Modified: trunk/src/stones/VolcanoStone.cc
===================================================================
--- trunk/src/stones/VolcanoStone.cc	2008-08-25 22:21:57 UTC (rev 1290)
+++ trunk/src/stones/VolcanoStone.cc	2008-08-27 21:44:59 UTC (rev 1291)
@@ -188,7 +188,7 @@
     
     BOOT_REGISTER_START
         BootRegister(new VolcanoStone(0), "st_volcano");
-        BootRegister(new VolcanoStone(0), "st_volcano_inactive");
+        BootRegister(new VolcanoStone(0), "st_volcano_idle");
         BootRegister(new VolcanoStone(1), "st_volcano_active");
         BootRegister(new VolcanoStone(2), "st_volcano_new");
         BootRegister(new VolcanoStone(3), "st_volcano_growing");

Modified: trunk/src/stones_complex.cc
===================================================================
--- trunk/src/stones_complex.cc	2008-08-25 22:21:57 UTC (rev 1290)
+++ trunk/src/stones_complex.cc	2008-08-27 21:44:59 UTC (rev 1291)
@@ -947,121 +947,12 @@
                 st_stoneimpulse_movable, MOVABLE_STANDARD);
 }
 
-
-/* -------------------- Mail stone -------------------- */
-
-namespace
-{
-    class MailStone : public Stone {
-        CLONEOBJ(MailStone);
-        Direction m_dir;
-
-
-        MailStone (const char *kind, Direction dir);
-        void actor_hit (const StoneContact &sc);
-
-        GridPos find_pipe_endpoint();
-    public:
-        static void setup();
-    };
-}
-
-void MailStone::setup()
-{
-    Register (new MailStone ("st-mail-n", NORTH));
-    Register (new MailStone ("st-mail-e", EAST));
-    Register (new MailStone ("st-mail-s", SOUTH));
-    Register (new MailStone ("st-mail-w", WEST));
-}
-
-MailStone::MailStone (const char *kind, Direction dir)
-: Stone(kind), m_dir(dir)
-{}
-
-
-void MailStone::actor_hit (const StoneContact &sc) 
-{
-    if (enigma::Inventory *inv = player::GetInventory(sc.actor)) {
-        if (Item *it = inv->get_item(0)) {
-            GridPos p = find_pipe_endpoint();
-            if (IsInsideLevel(p) && it->can_drop_at (p)) {
-                it = inv->yield_first();
-                player::RedrawInventory (inv);
-                it->drop(sc.actor, p);
-            }
-        }
-    }
-}
-
-/** About recursion detection while finding the end of a mailpipe
- *  
- *  Since there are no possibilities for forking a mailpipe, there is only one 
- *  cause that may lead to a closed, circular mailpipe. This is if a pipeitem is
- *  placed exactly under the mailstone. But not every pipepiece is dangerous,
- *  there are some that can be placed under the mailstone without problems.
- * 
- *  The mailpipe is only closed to a circular one if the pipepiece under the
- *  mailstone has the same 'output'-direction as the stone.
- */
-GridPos MailStone::find_pipe_endpoint() 
-{
-    GridPos p = get_pos();
-    Direction move_dir = m_dir;
-    GridPos q = p; // Store the stonepos for recursion detection.
-
-    while (move_dir != NODIR) {
-        p.move (move_dir);
-        if (Item *it = GetItem(p)) {
-            switch (get_id(it)) {
-            case it_pipe_h:
-                if (!(move_dir == EAST || move_dir == WEST))
-                    move_dir = NODIR;
-                break;
-            case it_pipe_v:
-                if (!(move_dir == SOUTH || move_dir == NORTH))
-                    move_dir = NODIR;
-                break;
-            case it_pipe_ne:
-                if (move_dir == SOUTH)     move_dir = EAST;
-                else if (move_dir == WEST) move_dir = NORTH;
-                else                       move_dir = NODIR;
-                break;
-            case it_pipe_es:
-                if (move_dir == NORTH)     move_dir = EAST;
-                else if (move_dir == WEST) move_dir = SOUTH;
-                else                       move_dir = NODIR;
-                break;
-            case it_pipe_sw:
-                if (move_dir == NORTH)     move_dir = WEST;
-                else if (move_dir == EAST) move_dir = SOUTH;
-                else                       move_dir = NODIR;
-                break;
-            case it_pipe_wn:
-                if (move_dir == SOUTH)     move_dir = WEST;
-                else if (move_dir == EAST) move_dir = NORTH;
-                else                       move_dir = NODIR;
-                break;
-            default:
-                move_dir = NODIR;; // end of pipe reached
-            }
-        } else
-            move_dir = NODIR;
-
-        if (p == q)
-            ASSERT(move_dir != m_dir, XLevelRuntime, "Mailpipe is circular! Recursion detected!");   
-    }
-    return p;
-}
-
-
 // --------------------------------------------------------------------------------
 
 void Init_complex()
 {
     Register(new HollowStoneImpulseStone);
 
-    MailStone::setup();
-
     Register(new MovableImpulseStone);
 
     // PerOxyd/Enigma compatible puzzle stones:
@@ -1106,4 +997,3 @@
 }
 
 } // namespace enigma
-

Modified: trunk/src/stones_simple.cc
===================================================================
--- trunk/src/stones_simple.cc	2008-08-25 22:21:57 UTC (rev 1290)
+++ trunk/src/stones_simple.cc	2008-08-27 21:44:59 UTC (rev 1291)
@@ -971,107 +971,6 @@
 
 }
 
-
-
-/* -------------------- FartStone -------------------- */
-
-/** \page st-fart Fart Stone
-
-The fart stone has the unpleasant habit of "blowing off" when
-triggered (by actor contact or signal) and will close all oxyd stones.
-
-\subsection fartm Messages
-
-- \b trigger: as usual
-
-*/
-
-namespace
-{
-    class FartStone : public Stone {
-        CLONEOBJ(FartStone);
-        DECL_TRAITS;
-
-        enum State { IDLE, FARTING, BREAKING };
-        State state;
-        bool rememberBreaking;  // set true if an explosion or break-message
-                                // or such occured while farting
-
-        void change_state(State newstate);
-        void animcb();
-        void actor_hit(const StoneContact &sc);
-        virtual Value message(const Message &m);
-
-        void processLight(Direction d) {
-            change_state(BREAKING);
-        }
-    public:
-        FartStone() : state(IDLE), rememberBreaking(false) 
-        {}
-    };
-    DEF_TRAITSM(FartStone, "st-fart", st_fart, MOVABLE_BREAKABLE);
-}
-
-void FartStone::change_state(State newstate) 
-{
-    if (state == newstate)
-        return;
-
-    switch (newstate) {
-    case IDLE:
-        state = IDLE;
-        init_model();
-        if (rememberBreaking)
-            change_state(BREAKING);
-        break;
-    case FARTING:
-    case BREAKING:
-        if (state == IDLE) {
-            Object *ox = GetObjectTemplate("st_oxyd");
-            SendMessage(ox, "closeall");
-            sound_event("fart");
-            if (newstate == BREAKING) {
-                sound_event ("stonedestroy");
-                set_anim ("st-fartbreak-anim");
-            }
-            else
-                set_anim("st-farting");
-            state = newstate;
-        } else if (state == FARTING && newstate == BREAKING)
-            rememberBreaking = true;
-        break;
-    }
-}
-
-void FartStone::animcb() 
-{
-    if (state == FARTING)
-        change_state(IDLE);
-    else if (state == BREAKING)
-        KillStone(get_pos());
-}
-
-void FartStone::actor_hit(const StoneContact &sc) 
-{
-    if (player::WieldedItemIs (sc.actor, "it_hammer"))
-        change_state(BREAKING);
-    else
-        change_state(FARTING);
-}
-Value FartStone::message(const Message &m) 
-{
-    if (m.message == "toggle" || (m.message == "signal" && m.value != 0) ||
-            (m.message == "_trigger" && m.value.to_bool())) {
-        change_state(FARTING);
-        return Value();
-    } else if (m.message == "ignite" || m.message == "_explosion") { 
-        change_state(BREAKING);
-        return Value();
-    }
-    return Stone::message(m);
-}
-
-
 /* -------------------- Thief -------------------- */
 namespace
 {
@@ -1435,78 +1334,6 @@
     DEF_TRAITSM(MagicStone, "st-magic", st_magic, MOVABLE_BREAKABLE);
 }
 
-
-/* -------------------- Brake stone -------------------- */
-
-/** \page st-brake Brake
-
-Blocks bolder stones and other movable stones.  Can be picked up.
-
-\image html st-brake.png
-*/
-
-namespace
-{
-    class BrakeStone : public Stone {
-        CLONEOBJ(BrakeStone);
-        DECL_TRAITS;
-    public:
-        BrakeStone()
-        {}
-
-        void on_creation (GridPos p) {
-            Stone::on_creation(p);
-
-            Item    *it = GetItem(p);
-            if (it && it->is_kind("it_blocker")) {
-                KillItem(p);
-//                sound_event ("explosion1");
-            }
-        }
-
-        StoneResponse collision_response(const StoneContact &/*sc*/) {
-            return STONE_PASS;
-        }
-
-        void actor_inside(Actor *a) {
-            const double BRAKE_RADIUS = 0.3;
-            GridPos      p            = get_pos();
-            double       dist         = length(a->get_pos() - p.center());
-
-            if (dist < BRAKE_RADIUS) {
-                player::PickupStoneAsItem(a, p);
-            }
-        }
-
-        void explode() {
-            GridPos p = get_pos();
-            KillStone(p);
-            SetItem(p, MakeItem("it-explosion1"));
-        }
-
-        void processLight(Direction d) {
-            explode();
-        }
-
-        virtual Value message(const Message &m) {
-            if (m.message == "_explosion") {
-                explode();
-                return Value();
-            }
-            return Stone::message(m);
-        }
-
-        bool is_sticky(const Actor *) const 
-        { return false; }
-        
-        void on_move() {
-            // we are not floating, but we do not shatter actors when swapped or pulled
-        }
-    };
-    DEF_TRAITSM(BrakeStone, "st-brake", st_brake, MOVABLE_BREAKABLE);
-}
-
-
 /* -------------------- Disco stones -------------------- */
 namespace
 {
@@ -1716,7 +1543,6 @@
     Register(new BombStone("st-bombs", "it-blackbomb"));
     //Register(new BombStone("st-dynamite", "it-dynamite"));
     //Register(new BombStone("st-whitebombs", "it-whitebomb"));
-    Register(new BrakeStone);
 
     Register(new Break_acblack);
     Register(new Break_acwhite);
@@ -1733,7 +1559,6 @@
     Register(new DummyStone);
     Register(new EasyModeStone);
     Register(new FakeOxydStone);
-    Register(new FartStone);
     Register(new Grate1);
     Register(new Grate2);
     Register(new Grate3);



From ral at mail.berlios.de  Sat Aug 30 00:06:25 2008
From: ral at mail.berlios.de (ral at BerliOS)
Date: Sat, 30 Aug 2008 00:06:25 +0200
Subject: [Enigma-game-svn] r1292 - in trunk/src: items stones
Message-ID: <200808292206.m7TM6Ph8027857@sheep.berlios.de>

Author: ral
Date: 2008-08-30 00:06:24 +0200 (Sat, 30 Aug 2008)
New Revision: 1292

Modified:
   trunk/src/items/PipeItem.cc
   trunk/src/items/PipeItem.hh
   trunk/src/stones/SwapStone.cc
Log:
Trunk 1.1: new API reengineering
- pipe item:
  - fix endpoint algorithm
  - remove special explosion handling - it is the default of items
- swap stone:
  - double item hit for peroxyd compatibility


Modified: trunk/src/items/PipeItem.cc
===================================================================
--- trunk/src/items/PipeItem.cc	2008-08-27 21:44:59 UTC (rev 1291)
+++ trunk/src/items/PipeItem.cc	2008-08-29 22:06:24 UTC (rev 1292)
@@ -56,7 +56,8 @@
                         }
                     } else
                         move_dir = NODIR;
-                }
+                } else
+                    move_dir = NODIR;
             } else
                 move_dir = NODIR;
     
@@ -74,14 +75,6 @@
         return "it_pipe";
     }
     
-    Value PipeItem::message(const Message &m) {
-        if (m.message == "_explosion") {
-            transform("it-explosion1");
-            return Value();
-        }
-        return Item::message(m);
-    }
-    
     std::string PipeItem::getModelName() const {
         return "it_pipe_";
     }

Modified: trunk/src/items/PipeItem.hh
===================================================================
--- trunk/src/items/PipeItem.hh	2008-08-27 21:44:59 UTC (rev 1291)
+++ trunk/src/items/PipeItem.hh	2008-08-29 22:06:24 UTC (rev 1292)
@@ -35,7 +35,6 @@
 
         // Object interface
         virtual std::string getClass() const;
-        virtual Value message(const Message &m);
 
         // Gridobject interface
         virtual std::string getModelName() const;

Modified: trunk/src/stones/SwapStone.cc
===================================================================
--- trunk/src/stones/SwapStone.cc	2008-08-27 21:44:59 UTC (rev 1291)
+++ trunk/src/stones/SwapStone.cc	2008-08-29 22:06:24 UTC (rev 1292)
@@ -98,8 +98,10 @@
         state = APPEARING;
         set_model(std::string("st-swap") + to_suffix(impulse.dir));
         GameTimer.set_alarm(this, 0.1, false);
+        if (server::GameCompatibility == GAMET_PEROXYD)
+            if (Item *it = GetItem(newPos))
+                it->on_stonehit(this);
 
-
         sound_event("moveslow");
         server::IncMoveCounter(1);
         propagateImpulse(impulse);
@@ -111,6 +113,9 @@
             if (isDisplayable())
                 init_model();
         } else if (state == VANISHING) {
+            if (server::GameCompatibility == GAMET_PEROXYD)
+                if (Item *it = GetItem(get_pos()))
+                    it->on_stonehit(this);
             setStone();
         } else
             ASSERT(false, XLevelRuntime, "SwapStone: alarm called with inconsistent state");



From ral at mail.berlios.de  Sat Aug 30 00:19:19 2008
From: ral at mail.berlios.de (ral at mail.berlios.de)
Date: Sat, 30 Aug 2008 00:19:19 +0200
Subject: [Enigma-game-svn] r1293 - team_levelpacks/team_test_new_api
Message-ID: <200808292219.m7TMJJkd028577@sheep.berlios.de>

Author: ral
Date: 2008-08-30 00:19:05 +0200 (Sat, 30 Aug 2008)
New Revision: 1293

Added:
   team_levelpacks/team_test_new_api/ralT063_1.xml
   team_levelpacks/team_test_new_api/ralT064_1.xml
Modified:
   team_levelpacks/team_test_new_api/ralT016_1.xml
   team_levelpacks/team_test_new_api/ralT028_1.xml
   team_levelpacks/team_test_new_api/ralT029_1.xml
   team_levelpacks/team_test_new_api/ralT030_1.xml
   team_levelpacks/team_test_new_api/ralT031_1.xml
   team_levelpacks/team_test_new_api/ralT037_1.xml
   team_levelpacks/team_test_new_api/ralT039_1.xml
   team_levelpacks/team_test_new_api/ralT041_1.xml
   team_levelpacks/team_test_new_api/ralT042_1.xml
   team_levelpacks/team_test_new_api/ralT043_1.xml
   team_levelpacks/team_test_new_api/ralT046_1.xml
   team_levelpacks/team_test_new_api/ralT047_1.xml
   team_levelpacks/team_test_new_api/ralT053_1.xml
   team_levelpacks/team_test_new_api/ralT054_1.xml
   team_levelpacks/team_test_new_api/ralT060_1.xml
   team_levelpacks/team_test_new_api/ralT061_1.xml
   team_levelpacks/team_test_new_api/ralT062_1.xml
   team_levelpacks/team_test_new_api/raoulT03_1.xml
   team_levelpacks/team_test_new_api/raoulT04_1.xml
Log:
Test Level new API:
- mail, pipe test level added
- puzzle test level for old API oddities
- update of test levels due to recent renamings

Modified: team_levelpacks/team_test_new_api/ralT016_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/ralT016_1.xml	2008-08-29 22:06:24 UTC (rev 1292)
+++ team_levelpacks/team_test_new_api/ralT016_1.xml	2008-08-29 22:19:05 UTC (rev 1293)
@@ -33,7 +33,7 @@
 ti["e"] = {"st_laser_n", state = ON}
 ti["m"] = {"st_mirror", movable=true, transparent=true, orientation=1}
 ti["w"] = {"it_magicwand"}
-ti["V"] = {"st-volcano_inactive"}
+ti["V"] = {"st_volcano"}
 ti["I"] = {"st-stoneimpulse"}
 ti["i"] = {"st-stoneimpulse_movable"}
 ti["L"] = {"st_rotator_ccw"}

Modified: team_levelpacks/team_test_new_api/ralT028_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/ralT028_1.xml	2008-08-29 22:06:24 UTC (rev 1292)
+++ team_levelpacks/team_test_new_api/ralT028_1.xml	2008-08-29 22:19:05 UTC (rev 1293)
@@ -22,44 +22,49 @@
 ti[" "] = {"fl-sahara"}
 ti["#"] = {"st-rock1"}
 
-ti["o"] = {"st_oxyd"}
-ti["O"] = {"st_oxyd", "o#", target="enlighten"}
-ti["D"] = {"st_oxyd_d", "o#", target="enlighten"}
+ti["z"] = {"st_oxyd"}
+ti["Z"] = {"st_oxyd", "o%%", target="enlighten"}
+--ti["D"] = {"st_oxyd_d", "o#", target="enlighten"}
 ti["F"] = {"st_oxyd", oxydcolor=-3, noshuffle=true}
 ti["B"] = {"st_oxyd", "bold", oxydcolor=-4, noshuffle=true}
-ti["S"] = {"st_switch", target="o#1"}
-ti["T"] = {"st_switch", target="o#2", action="open"}
-ti["U"] = {"st_switch", target="o#2", action="close"}
-ti["V"] = {"st_switch", target="o#3", action="signal"}
+ti["J"] = {"st_switch", target="o%1"}
+ti["T"] = {"st_switch", target="o%2", action="open"}
+ti["U"] = {"st_switch", target="o%2", action="close"}
+ti["V"] = {"st_switch", target="o%3", action="signal"}
 ti["W"] = {"st_switch", target="statetest"}
 ti["C"] = {"st_switch", target="bold", action="signal"}
-ti["L"] = {"st_laser_n", "Laser#"}
-ti["l"] = {"st_laser_n", "laser#"}
+ti["K"] = {"st_laser_n", "Laser%%"}
+ti["k"] = {"st_laser_n", "laser%%"}
 ti["b"] = {"st_boulder_s"}
-ti["s"] = {"st-swap"}
-ti["X"] = {"st_switch", target="o#1", action="shuffle"}
-ti["Y"] = {"st_switch", target="o#1", action="closeall"}
-ti["1"] = (ti[" "] .. {"it_magicwand"}) .. {"#ac-blackball"}
+ti["s"] = {"st_swap"}
+ti["X"] = {"st_switch", target="o%1", action="shuffle"}
+ti["Y"] = {"st_switch", target="o%1", action="closeall"}
+ti["@"] = (ti[" "] .. {"it_magicwand"}) .. {"#ac-blackball"}
 
-ti["w"] = {"st_switch", target="Laser#7", action="toggle"}
-ti["f"] = {"st-fart"}
+ti["w"] = {"st_switch", target="Laser%7", action="toggle"}
+ti["f"] = {"st_fart"}
+ti["h"] = {"it_hammer"}
+ti["d"] = {"it-dynamite"}
+ti["E"] = {"st-bombs"}
 
-ti["p"] = {"st_oxyd", "p#"}
+ti["t"] = {"st_oxyd", "t#"}
 
-w, h = wo(ti, " ", {
+myresolver = res.autotile(ti, {"L", "R", "K"}, {"l", "q", "k"},
+    {"1","6", "Z"})
+w, h = wo(myresolver, " ", {
 "                    ",
-"  Ll Ll Ll Ll Ll Ll ",
+"  Ll Mm Nn Oo Pp Qq ",
 "                    ",
-"  O  O  O  O  sD O  ",
+"  1  2  3  4  s5 6  ",
 "                    ",
-"  S  TU V  W        ",
+"  J  TU V  W        ",
 "                    ",
-"  o   1             ",
+"  z   @ hd     f    ",
 "f                   ",
-"  os   ps           ",
-"    f    p          ",
+"  zs   ts      f    ",
+"E   f    t          ",
 "  F      C Bs       ",
-"    Y  X      wL b  ",
+"    Y  X      wR  b  ",
 "                    ",
 "                    ",
 "                    ",
@@ -74,7 +79,7 @@
 "                    "
 })
 
-wo:shuffleOxyd({no["p#*"],min=1})
+wo:shuffleOxyd({no["t#*"],min=1})
 
 for col = 0, 11 do
   for j, fla in pairs({"a", "b", "c", "d"}) do
@@ -85,7 +90,7 @@
 function statetest(value)
     local newstate = 0
     if value then newstate = 1 end
-    no["o#4"]["state"] = newstate
+    no["o%4"]["state"] = newstate
 end
 
 function enlighten(value, sender)
@@ -94,10 +99,10 @@
     
     -- all pair opened oxyds with the second laser
     for i=1,6 do
-        if no["o#"..i]["state"] == 2 then
-            no["laser#"..i]:on()
+        if no["o%"..i]["state"] == 2 then
+            no["laser%"..i]:on()
         else
-            no["laser#"..i]:off()
+            no["laser%"..i]:off()
         end
     end
 end

Modified: team_levelpacks/team_test_new_api/ralT029_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/ralT029_1.xml	2008-08-29 22:06:24 UTC (rev 1292)
+++ team_levelpacks/team_test_new_api/ralT029_1.xml	2008-08-29 22:19:05 UTC (rev 1293)
@@ -39,7 +39,7 @@
 ti["S"] = ti[" "] .. {"st_panel", faces=""}
 ti["T"] = ti[" "] .. {"st_panel", cluster=2}
 ti["|"] = ti[" "] .. {"st_panel", connections="sn"}
-ti["s"] = ti[" "] .. {"st-swap"}
+ti["s"] = ti[" "] .. {"st_swap"}
 
 ti["x"] = ti[" "] .. {"st_panel", "dynamic", connections=""}
 ti["a"] = ti[" "] .. {"st_switch", "north", target="change"}
@@ -47,7 +47,7 @@
 ti["c"] = ti[" "] .. {"st_switch", "south", target="change"}
 ti["d"] = ti[" "] .. {"st_switch", "west", target="change"}
 
-ti["A"] = (ti[" "] .. {"it-brake"}) .. {"#ac-blackball"}
+ti["A"] = (ti[" "] .. {"st_brake"}) .. {"#ac-blackball"}
 
 ti["D"] = ti[" "] .. {"st_switch", target="deletion"}
 ti["E"] = ti[" "] .. {"st_switch", target="recluster"}

Modified: team_levelpacks/team_test_new_api/ralT030_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/ralT030_1.xml	2008-08-29 22:06:24 UTC (rev 1292)
+++ team_levelpacks/team_test_new_api/ralT030_1.xml	2008-08-29 22:19:05 UTC (rev 1293)
@@ -23,7 +23,7 @@
 ti["#"] = ti[" "] .. {"st-rock1"}
 ti["~"] = ti({"fl-rough-blue"}) .. {"st-chameleon"}
 
-ti["s"] = ti[" "] .. {"st-swap"}
+ti["s"] = ti[" "] .. {"st_swap"}
 
 ti["2"] = ti[" "] .. {"st_panel", cluster=2}
 
@@ -32,7 +32,7 @@
 ti["R"] = ti[" "] .. {"st_panel", faces="ne"}
 
 
-ti["A"] = (ti[" "] .. {"it-brake"}) .. {"#ac-blackball"}
+ti["A"] = (ti[" "] .. {"st_brake"}) .. {"#ac-blackball"}
 
 
 ti["w"] = ti[" "] .. {"st_switch", target="Laser", action="toggle"}
@@ -40,7 +40,7 @@
 ti["L"] = ti[" "] .. {"st_laser_n", "Laser"}
 
 ti["+"] = ti[" "] .. {"st-grate1"}
-ti["."] = ti[" "] .. {"it-seed"}
+ti["."] = ti[" "] .. {"it_seed"}
 
 
 w, h = wo(ti, " ", {

Modified: team_levelpacks/team_test_new_api/ralT031_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/ralT031_1.xml	2008-08-29 22:06:24 UTC (rev 1292)
+++ team_levelpacks/team_test_new_api/ralT031_1.xml	2008-08-29 22:19:05 UTC (rev 1293)
@@ -51,7 +51,7 @@
 ti["U"] = ti[" "] .. {"st-block"}
 ti["V"] = ti[" "] .. {"st-brownie"}
 ti["u"] = ti[" "] .. {"it-spring1"}
-ti["v"] = ti[" "] .. {"it-brake"}
+ti["v"] = ti[" "] .. {"st_brake"}
 ti["Y"] = ti[" "] .. {"st_death"}
 ti["z"] = ti[" "] .. {"it-dynamite"}
 

Modified: team_levelpacks/team_test_new_api/ralT037_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/ralT037_1.xml	2008-08-29 22:06:24 UTC (rev 1292)
+++ team_levelpacks/team_test_new_api/ralT037_1.xml	2008-08-29 22:19:05 UTC (rev 1293)
@@ -27,7 +27,7 @@
 ti["T"] = {"st_turnstile"}
 ti["t"] = {"st_turnstilearm_n","it"}
 ti["R"] = {"it_rubberband", anchor2="it", length=4}
-ti["p"] = {"st-swap", "you"}
+ti["p"] = {"st_swap", "you"}
 ti["m"] = {"it_magnet_on", strength=-40}
 ti["1"] = {"#ac-blackball", "me"}
 ti["2"] = {"#ac-whiteball"}

Modified: team_levelpacks/team_test_new_api/ralT039_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/ralT039_1.xml	2008-08-29 22:06:24 UTC (rev 1292)
+++ team_levelpacks/team_test_new_api/ralT039_1.xml	2008-08-29 22:19:05 UTC (rev 1293)
@@ -21,7 +21,7 @@
 
 ti[" "] = {"fl-sahara"}
 
-ti["s"] = {"st-swap"}
+ti["s"] = {"st_swap"}
 ti["W"] = {"st-wood"}
 
 ti["A"] = {"#ac-blackball"}

Modified: team_levelpacks/team_test_new_api/ralT041_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/ralT041_1.xml	2008-08-29 22:06:24 UTC (rev 1292)
+++ team_levelpacks/team_test_new_api/ralT041_1.xml	2008-08-29 22:19:05 UTC (rev 1293)
@@ -42,7 +42,7 @@
 ti["r"] = {"st_rotator_cw", movable=true}
 ti["R"] = {"st_rotator_ccw", movable=false}
 ti["W"] = {"st-wood"}
-ti["s"] = {"st-swap"}
+ti["s"] = {"st_swap"}
 ti["g"] = {"st-glass1"}
 ti["S"] = {"st_switch", target="addrot"}
 

Modified: team_levelpacks/team_test_new_api/ralT042_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/ralT042_1.xml	2008-08-29 22:06:24 UTC (rev 1292)
+++ team_levelpacks/team_test_new_api/ralT042_1.xml	2008-08-29 22:19:05 UTC (rev 1293)
@@ -40,7 +40,7 @@
 ti["T"] = {"st-turnstile"}
 ti["e"] = {"st-turnstile-e"}
 
-ti["s"] = {"st-swap"}
+ti["s"] = {"st_swap"}
 ti["i"] = {"st-stoneimpulse_movable"}
 ti["w"] = {"st-wood"}
 ti["h"] = {"it_hammer"}

Modified: team_levelpacks/team_test_new_api/ralT043_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/ralT043_1.xml	2008-08-29 22:06:24 UTC (rev 1292)
+++ team_levelpacks/team_test_new_api/ralT043_1.xml	2008-08-29 22:19:05 UTC (rev 1293)
@@ -35,7 +35,7 @@
 
 ti["1"] = ti["f"] .. {"#ac-blackball"} 
 
-ti["r"] = {"st-brake"}
+ti["r"] = {"st_brake"}
 
 w, h = wo(ti, " ", {
 " B #        c       ",

Modified: team_levelpacks/team_test_new_api/ralT046_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/ralT046_1.xml	2008-08-29 22:06:24 UTC (rev 1292)
+++ team_levelpacks/team_test_new_api/ralT046_1.xml	2008-08-29 22:19:05 UTC (rev 1293)
@@ -29,7 +29,7 @@
 ti["G "] = {"st-grate1"}
 
 ti["2 "] = {"it_coin_s"}
-ti["s "] = {"it-seed"}
+ti["s "] = {"it_seed"}
 ti["c "] = {"it-cherry"}
 ti["h "] = {"it_hammer"}
 

Modified: team_levelpacks/team_test_new_api/ralT047_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/ralT047_1.xml	2008-08-29 22:06:24 UTC (rev 1292)
+++ team_levelpacks/team_test_new_api/ralT047_1.xml	2008-08-29 22:19:05 UTC (rev 1293)
@@ -29,7 +29,7 @@
 ti["G  "] = {"st-grate1"}
 
 ti[" 2 "] = {"it_coin_s"}
-ti[" s "] = {"it-seed"}
+ti[" s "] = {"it_seed"}
 ti[" c "] = {"it-cherry"}
 ti[" h "] = {"it_hammer"}
 

Modified: team_levelpacks/team_test_new_api/ralT053_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/ralT053_1.xml	2008-08-29 22:06:24 UTC (rev 1292)
+++ team_levelpacks/team_test_new_api/ralT053_1.xml	2008-08-29 22:19:05 UTC (rev 1293)
@@ -24,7 +24,7 @@
 ti["."] = {"st-wood"}
 ti["w"] = {"st-wood", "w"}
 ti["s"] = {"st_scissors"}
-ti["S"] = {"st-swap"}
+ti["S"] = {"st_swap"}
 ti["r"] = {"st_rubberband"}
 ti["R"] = {"it_rubberband", anchor2="a3", length=3, strength=50, threshold=1.5}
 ti["p"] = {"it_rubberband", anchor2="a2", length=3, strength=10, threshold=2.5, max=4, min=4}

Modified: team_levelpacks/team_test_new_api/ralT054_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/ralT054_1.xml	2008-08-29 22:06:24 UTC (rev 1292)
+++ team_levelpacks/team_test_new_api/ralT054_1.xml	2008-08-29 22:19:05 UTC (rev 1293)
@@ -30,8 +30,8 @@
 ti["template_w"] = {"st-wood", "w%%"}
 ti["template_b"] = {"st-brownie", "b%%"}
 ti["s"] = {"st_scissors"}
-ti["S"] = {"st-swap"}
-ti["U"] = {"st-pull", "pull"}
+ti["S"] = {"st_swap"}
+ti["U"] = {"st_pull", "pull"}
 ti["R"] = {"st_rotator_cw", movable=true}
 ti["Q"] = {"st_rotator_cw", "rotcw", movable=true}
 ti["q"] = {"st_rotator_ccw", "rotccw", movable=true}

Modified: team_levelpacks/team_test_new_api/ralT060_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/ralT060_1.xml	2008-08-29 22:06:24 UTC (rev 1292)
+++ team_levelpacks/team_test_new_api/ralT060_1.xml	2008-08-29 22:19:05 UTC (rev 1293)
@@ -45,7 +45,7 @@
 ti["v"] = {"st-wood", "wood2"}
 ti["u"] = {"st-wood", "wood3"}
 ti["r"] = {"st-rock1"}
-ti["s"] = {"st-swap"}
+ti["s"] = {"st_swap"}
 ti["c"] = {"it-cherry"}
 
 ti["S"] = {"st_switch", target="kill_l"}

Modified: team_levelpacks/team_test_new_api/ralT061_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/ralT061_1.xml	2008-08-29 22:06:24 UTC (rev 1292)
+++ team_levelpacks/team_test_new_api/ralT061_1.xml	2008-08-29 22:19:05 UTC (rev 1293)
@@ -27,7 +27,7 @@
 ti["S"] = {"st_swap"}
 ti["s"] = {"st_swap", "swap"}
 
-ti["B"] = {"st-brake"}
+ti["B"] = {"st_brake"}
 ti["R"] = {"st_rotator", movable=true}
 ti["w"] = {"st-wood", "wood1"}
 ti["W"] = {"st-wood", "wood2"}
@@ -44,6 +44,9 @@
 ti["t"] = {"it_trigger", target="pol1"}
 ti["T"] = {"it_trigger", target="pol2"}
 
+ti["d"] = {"it-dynamite"}
+ti["E"] = {"st-bombs"}
+
 ti["@"] = {"#ac-blackball"} 
 ti["."] = {"#ac-whiteball", "white"} 
 
@@ -55,11 +58,11 @@
 "                    ",
 "  #     PB    S  g  ",
 "  #                 ",
-"  #                 ",
-"          R         ",
-"   s   @       p    ",
-"        cc          ",
-"   W           w    ",
+"  #                E",
+"          R        d",
+"   s   @       p   d",
+"        cc         d",
+"   W           w   d",
 "                    ",
 " .                  "
 })

Modified: team_levelpacks/team_test_new_api/ralT062_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/ralT062_1.xml	2008-08-29 22:06:24 UTC (rev 1292)
+++ team_levelpacks/team_test_new_api/ralT062_1.xml	2008-08-29 22:19:05 UTC (rev 1293)
@@ -29,7 +29,7 @@
 
 ti["V"] = {"st_volcano"}
 ti["v"] = {"st_volcano_active"}
-ti["u"] = {"st_volcano_inactive", "volcano", secure=true}
+ti["u"] = {"st_volcano_idle", "volcano", secure=true}
 ti["S"] = {"st_switch", target="volcano"}
 
 ti["B"] = {"st_boulder_s"}

Added: team_levelpacks/team_test_new_api/ralT063_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/ralT063_1.xml	2008-08-29 22:06:24 UTC (rev 1292)
+++ team_levelpacks/team_test_new_api/ralT063_1.xml	2008-08-29 22:19:05 UTC (rev 1293)
@@ -0,0 +1,96 @@
+<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
+<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
+  <el:protected>
+    <el:info el:type="level">
+      <el:identity el:title="Test Puzzle new API" el:subtitle="" el:id="20080824ral493"/>
+      <el:version el:score="1" el:release="1" el:revision="$Revision$" el:status="experimental"/>
+      <el:author  el:name="Ronald Lamprecht" el:email="ral at users.berlios.de"/>
+      <el:copyright>Copyright ? 2008 Ronald Lamprecht</el:copyright>
+      <el:license el:type="GPL v2.0 or above" el:open="true"/>
+      <el:compatibility el:enigma="1.10">
+      </el:compatibility>
+      <el:modes el:easy="false" el:single="true" el:network="false"/>
+      <el:comments>
+      </el:comments>
+      <el:score el:easy="-" el:difficult="-"/>
+    </el:info>
+    <el:luamain><![CDATA[
+wo["ConserveLevel"] = true
+wo["ConserveLevel"] = true
+
+ti[" "] = {"fl-sahara"}
+ti["#"] = {"st_bluesand", cluster=1}
+
+ti["A"] = {"st-puzzle-w"}
+ti["B"] = {"st-puzzle-s"}
+ti["C"] = {"st-puzzle-sw"}
+ti["D"] = {"st-puzzle-e"}
+ti["E"] = {"st-puzzle-ew"}
+ti["F"] = {"st-puzzle-es"}
+ti["G"] = {"st-puzzle-esw"}
+ti["H"] = {"st-puzzle-n"}
+ti["I"] = {"st-puzzle-nw"}
+ti["J"] = {"st-puzzle-ns"}
+ti["K"] = {"st-puzzle-nsw"}
+ti["L"] = {"st-puzzle-ne"}
+ti["M"] = {"st-puzzle-new"}
+ti["N"] = {"st-puzzle-nes"}
+ti["O"] = {"st-puzzle-nesw"}
+ti["P"] = {"st-puzzle-hollow"}
+
+ti["a"] = {"st-puzzle2-w"}
+ti["b"] = {"st-puzzle2-s"}
+ti["c"] = {"st-puzzle2-sw"}
+ti["d"] = {"st-puzzle2-e"}
+ti["e"] = {"st-puzzle2-ew"}
+ti["f"] = {"st-puzzle2-es"}
+ti["g"] = {"st-puzzle2-esw"}
+ti["h"] = {"st-puzzle2-n"}
+ti["i"] = {"st-puzzle2-nw"}
+ti["j"] = {"st-puzzle2-ns"}
+ti["k"] = {"st-puzzle2-nsw"}
+ti["l"] = {"st-puzzle2-ne"}
+ti["m"] = {"st-puzzle2-new"}
+ti["n"] = {"st-puzzle2-nes"}
+ti["o"] = {"st-puzzle2-nesw"}
+ti["p"] = {"st-puzzle2-hollow"}
+
+ti["'"] = {"st-puzzle-n", "puz1"}
+ti["!"] = {"st-puzzle2-w", "puz2"}
+ti["W"] = {"st-wood", "wood1"}
+ti["w"] = {"st-wood", "wood2"}
+
+ti["-"] = {"st_laser_w", state = ON}
+ti["="] = {"st_polarswitch"}
+ti["."] = {"st-stoneimpulse_movable"}
+ti["*"] = {"it-cherry"}
+
+ti["@"] = {"#ac-blackball"} ..ti({"it_magicwand"})
+
+w, h = wo(ti, " ", {
+"                   ",
+" BB    =-    BPB =-",
+" H     =-          ",
+"  H                ",
+"   bb  =-          ",
+"   h   =-    bpb =-",
+"    h        @     ",
+"                   ",
+"   DPA.       dpa. ",
+"    *          *   ",
+"                   ",
+"  O'  W     dp! w  ",
+"                   "
+})
+
+wo:add({"ot_wire", anchor1="puz1", anchor2="wood1"})
+wo:add({"ot_wire", anchor1="puz2", anchor2="wood2"})
+
+  ]]></el:luamain>
+    <el:i18n>
+	 <el:string el:key="title">
+	   <el:english el:translate="false"/>
+	 </el:string>
+   </el:i18n>
+  </el:protected>
+</el:level>


Property changes on: team_levelpacks/team_test_new_api/ralT063_1.xml
___________________________________________________________________
Name: svn:keywords
   + Revision
Name: svn:eol-style
   + native

Added: team_levelpacks/team_test_new_api/ralT064_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/ralT064_1.xml	2008-08-29 22:06:24 UTC (rev 1292)
+++ team_levelpacks/team_test_new_api/ralT064_1.xml	2008-08-29 22:19:05 UTC (rev 1293)
@@ -0,0 +1,67 @@
+<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
+<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
+  <el:protected>
+    <el:info el:type="level">
+      <el:identity el:title="Test Mail new API" el:subtitle="" el:id="20080827ral227"/>
+      <el:version el:score="1" el:release="1" el:revision="$Revision$" el:status="experimental"/>
+      <el:author  el:name="Ronald Lamprecht" el:email="ral at users.berlios.de"/>
+      <el:copyright>Copyright ? 2008 Ronald Lamprecht</el:copyright>
+      <el:license el:type="GPL v2.0 or above" el:open="true"/>
+      <el:compatibility el:enigma="1.10">
+      </el:compatibility>
+      <el:modes el:easy="false" el:single="true" el:network="false"/>
+      <el:comments>
+      </el:comments>
+      <el:score el:easy="-" el:difficult="-"/>
+    </el:info>
+    <el:luamain><![CDATA[
+wo["ConserveLevel"] = true
+
+ti[" "] = {"fl-sahara"}
+
+ti["-"] = {"it_pipe_ew"}
+ti["|"] = {"it_pipe_ns"}
+ti["1"] = {"it_pipe_sw"}
+ti["2"] = {"it_pipe_es"}
+ti["3"] = {"it_pipe_ne"}
+ti["4"] = {"it_pipe_nw"}
+ti["p"] = {"it_pipe"}
+ti["w"] = {"it_pipe", connections="w"}
+
+ti["N"] = {"st_mail_n"}
+ti["W"] = {"st_mail_w"}
+
+ti["h"] = {"it_hammer"}
+ti["m"] = {"it_magicwand"}
+ti["b"] = {"st_brake"}
+ti["d"] = {"it-dynamite"}
+ti["E"] = {"st-bombs"}
+
+ti["@"] = {"#ac-blackball"} 
+ti["."] = {"#ac-whiteball", "white"} 
+
+w, h = wo(ti, " ", {
+"E ddd               ",
+"                    ",
+"                    ",
+"     W     N        ",
+"                    ",
+"                    ",
+"   |- 1234 pw       ",
+"                    ",
+"          @         ",
+"                    ",
+"      hmb           ",
+"                    ",
+" .                  "
+})
+
+
+  ]]></el:luamain>
+    <el:i18n>
+	 <el:string el:key="title">
+	   <el:english el:translate="false"/>
+	 </el:string>
+   </el:i18n>
+  </el:protected>
+</el:level>


Property changes on: team_levelpacks/team_test_new_api/ralT064_1.xml
___________________________________________________________________
Name: svn:keywords
   + Revision
Name: svn:eol-style
   + native

Modified: team_levelpacks/team_test_new_api/raoulT03_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/raoulT03_1.xml	2008-08-29 22:06:24 UTC (rev 1292)
+++ team_levelpacks/team_test_new_api/raoulT03_1.xml	2008-08-29 22:19:05 UTC (rev 1293)
@@ -51,7 +51,7 @@
 ti["w"] = {"it_wrench"}
 ti["i"] = {"it_hammer"}
 ti["r"] = {"it-ring"}
-ti["s"] = {"it-seed"}
+ti["s"] = {"it_seed"}
 ti["k"] = {"it-coffee"}
 ti["K"] = {"it-cherry"}
 ti[":"] = {"it-dynamite"}

Modified: team_levelpacks/team_test_new_api/raoulT04_1.xml
===================================================================
--- team_levelpacks/team_test_new_api/raoulT04_1.xml	2008-08-29 22:06:24 UTC (rev 1292)
+++ team_levelpacks/team_test_new_api/raoulT04_1.xml	2008-08-29 22:19:05 UTC (rev 1293)
@@ -52,6 +52,22 @@
 ti["F"] = ti[" "] .. {"st_coinslot", name="csy", interval_m=1, target="la6", action="toggle"}
 ti["G"] = ti[" "] .. {"st_coinslot", name="csz", interval_l=1, target="la7", action="toggle"}
 
+ti["H"] = ti[" "] .. {"st_coinslot", interval_s=COIN_IGNORE , target="la8", action="toggle"}
+ti["I"] = ti[" "] .. {"st_coinslot", interval_m=COIN_IGNORE , target="la9", action="toggle"}
+ti["J"] = ti[" "] .. {"st_coinslot", interval_l=COIN_IGNORE , target="la10", action="toggle"}
+
+ti["h"] = ti[" "] .. {"st_laser_e", name="la8"}
+ti["i"] = ti[" "] .. {"st_laser_e", name="la9"}
+ti["j"] = ti[" "] .. {"st_laser_e", name="la10"}
+
+ti["1"] = ti[" "] .. {"st_coinslot", interval_s=COIN_REJECT , target="la11", action="toggle"}
+ti["2"] = ti[" "] .. {"st_coinslot", interval_m=COIN_REJECT , target="la12", action="toggle"}
+ti["3"] = ti[" "] .. {"st_coinslot", interval_l=COIN_REJECT , target="la13", action="toggle"}
+
+ti["4"] = ti[" "] .. {"st_laser_w", name="la11"}
+ti["5"] = ti[" "] .. {"st_laser_w", name="la12"}
+ti["6"] = ti[" "] .. {"st_laser_w", name="la13"}
+
 ti["W"] = {"st-wood"}
 
 w, h = wo(ti, " ", {
@@ -64,9 +80,9 @@
 "     YYYYYYYYYY     ",
 "          ZZZZZZZZZZ",
 "                    ",
-" xyz     El         ",
-" yzx     Fm         ",
-" zxy     Gn         ",
+" xyz     El  41  Hh ",
+" yzx     Fm  52  Ii ",
+" zxy     Gn  63  Jj ",
 "                    "
 })
 



From andreasl at mail.berlios.de  Sat Aug 30 00:36:42 2008
From: andreasl at mail.berlios.de (andreasl at mail.berlios.de)
Date: Sat, 30 Aug 2008 00:36:42 +0200
Subject: [Enigma-game-svn] r1294 - in homepage/input: . articles
Message-ID: <200808292236.m7TMag1r006039@sheep.berlios.de>

Author: andreasl
Date: 2008-08-30 00:36:21 +0200 (Sat, 30 Aug 2008)
New Revision: 1294

Added:
   homepage/input/articles/infobox_marbleous.html
   homepage/input/articles/infobox_marbleous_de.html
   homepage/input/articles/infobox_marbleous_ru.html
   homepage/input/articles/marbleous_1.html
   homepage/input/articles/marbleous_1_de.html
   homepage/input/articles/marbleous_1_ru.html
Removed:
   homepage/input/articles/apprentice_1.html
   homepage/input/articles/apprentice_1_de.html
   homepage/input/articles/apprentice_1_ru.html
   homepage/input/articles/infobox_apprentice.html
   homepage/input/articles/infobox_apprentice_de.html
   homepage/input/articles/infobox_apprentice_ru.html
Modified:
   homepage/input/hp_archive.html
   homepage/input/hp_archive_de.html
   homepage/input/hp_archive_ru.html
   homepage/input/infobox.html
   homepage/input/infobox_de.html
   homepage/input/infobox_ru.html
   homepage/input/output-files.lua
   homepage/input/top_news.html
   homepage/input/top_news_de.html
   homepage/input/top_news_ru.html
Log:
Homepage:
 - Change of title of novice-article column to
   "Marbleous!"/"Gemurmel!".
    - Adaption of infobox text, file names etc.
Todo:
 - Russian counterparts (links are already adapted),
   relevant files: infobox_ru, top_news_ru, hp_archive_ru,
   articles/infobox_marbleous_ru, articles/marbleous_1_ru.


Deleted: homepage/input/articles/apprentice_1.html
===================================================================
--- homepage/input/articles/apprentice_1.html	2008-08-29 22:19:05 UTC (rev 1293)
+++ homepage/input/articles/apprentice_1.html	2008-08-29 22:36:21 UTC (rev 1294)
@@ -1,29 +0,0 @@
-
-<h2>The Apprentice &mdash; &quot;We welcome you&quot;</h2>
-
-<p>
-Interested friends ask me, what is Enigma like? Is a game with all those many
-levels worthwhile? &hellip; I say to them: Be glad, you still have all of them to
-play! The apprentice looks perplexed at the first twelve &quot;previews&quot;
-of the opened level pack and begins playing &quot;Welcome&quot;&mdash;and opens
-&quot;his&quot; first oxyds, still unsure of the handling of the marble that
-is now under his thumb. Was that it!? Yes&mdash;Level finished. That easy?
-Yes&mdash;in some respect every level is a &quot;Welcome&quot;-level &hellip;
-with more or fewer obstacles! Light up the oxyds&mdash;and, as a diversion,
-meditate in &quot;meditation levels&quot;: make the marble
-&quot;stay put&quot;. The preview shows the apprentice, still basking in the
-glow of the
-solved &quot;Welcome&quot;, that every enclosed level differs in color,
-composition, shape &hellip;, and during his first contact with
-the &quot;death's-head&quot; he experiences &quot;landscapes&quot; that present
-varying degrees of challenge, perils, that seem limitless in their evolution:
-Over 1000 levels!
-And then he realises: Yes&mdash;I know that completing this level means x% of
-them solved, but there is still much to do&mdash;fortunately! And thanks to all
-those that made this possible. And maybe, some day, he starts to &quot;make it
-possible&quot; as well: We welcome you!
-</p>
-
-<p><i>
-Mecke
-</i></p>

Deleted: homepage/input/articles/apprentice_1_de.html
===================================================================
--- homepage/input/articles/apprentice_1_de.html	2008-08-29 22:19:05 UTC (rev 1293)
+++ homepage/input/articles/apprentice_1_de.html	2008-08-29 22:36:21 UTC (rev 1294)
@@ -1,28 +0,0 @@
-
-<h2>Der Neuling &mdash; &quot;You are welcome&quot;</h2>
-
-<p>
-Interessierten, die mich fragen, wie das mit Enigma &quot;so sei&quot;, ob das
-Spiel &quot;lohne&quot;, diese vielen Level &hellip; sage ich: Sei froh, du hast noch
-alle vor dir! Verdutzt schaut der Neuling auf die im aufgerufenen Levelpaket
-angezeigten ersten 12 &quot;Vorschauen&quot; und startet  &quot;Welcome&quot; -
-und &ouml;ffnet &quot;seine&quot; ersten Oxyds, noch unsicher im Umgang mit der in
-seiner &quot;Gewalt&quot; befindlichen Kugel.  War's das? Ja - Level geschafft.
-So einfach? Ja - jeder Level ist im Prinzip ein &quot;Welcome&quot;-Spiel &hellip;
-mit mehr oder weniger Hindernissen! Bring die Oxyds zum leuchten - und, als
-Abwechslung, meditiere in &quot;Meditationsleveln&quot;: bring &quot;die&quot;
-Kugel zum &quot;verweilen&quot;. Die Levelvorschau zeigt dem Neuling, noch
-gl&uuml;cklich &uuml;ber das gel&ouml;ste  &quot;Welcome&quot;, dass jeder
-angebotene Level sich in Farbe, Aufbau, Form &hellip; unterscheidet, und
-sp&auml;testens beim Erstkontakt mit einem &quot;Totenkopf&quot; realisiert es
-&quot;Landschaften&quot; mit unterschiedlichen Herausforderungen, Bedrohungen,
-die in ihrer Evolution dann grenzenlos erscheint: &uuml;ber 1000 Level! Und dann
-sieht er: Ja - ich &quot;kenne&quot; den Level = x% geloest, aber da liegt noch
-viel vor mir - zum Gl&uuml;ck! Und dank all jener, die das erm&ouml;glicht
-haben. Und vielleicht, irgendwann, ist er selbst dabei, mit zu
-&quot;erm&ouml;glichen&quot;: You are welcome!
-</p>
-
-<p><i>
-Mecke
-</i></p>

Deleted: homepage/input/articles/apprentice_1_ru.html
===================================================================
--- homepage/input/articles/apprentice_1_ru.html	2008-08-29 22:19:05 UTC (rev 1293)
+++ homepage/input/articles/apprentice_1_ru.html	2008-08-29 22:36:21 UTC (rev 1294)
@@ -1,27 +0,0 @@
-
-<h2>????? ?????????? &mdash; &quot;????? ??????????&quot;</h2>
-
-<p>
-?????? ?????????? ???? ?? Enigma, ?? ??? ??? &quot;??????&quot;,
-??? &quot;????? ?? ? ??? ??????&quot;, ?? ??? ??? ?????????????? ??????&hellip;
-? ?????? ??: ?????????, ??? ???? ??? ?????? ????????? ??????? ? ?????? ?? ???!
-??????? ?????????? ??????? ?? ?????? ?????? &quot;???????&quot; ?????????
-?????? ???????, ????????? ??????? &quot;Welcome&quot; (&quot;????? ??????????&quot;)
-&mdash; ? ????????? &quot;????&quot; ?????? ??????, ??? ??? ??????? ????????? ?
-?????????????? ??? ???????. ??? ???? ?? &mdash; ??????? ???????. ??? ??????? ?? &mdash;
-? ????????? ???? ?????? ??????? &mdash; ??? ??????? &quot;Welcome&quot;&hellip; ??????
-?????????? ??????????? ??????????! ???????? ?????? ??? ??? ???????????? ????????????? ??
-&quot;??????? ??? ?????????&quot;: ????????? &quot;?????&quot; &quot;????????????&quot;.
-????? ?????????? ???????, ??????? ??? ??? ????????, ??? ?????? ??????? &quot;Welcome&quot;,
-??? ? ??????? ?? ??????? ????????? ???????? ??????????, ??????????, ?????&hellip;
-?, ???????, ?????? ??????? ? &quot;???????&quot; ??????????, ??? &quot;??????&quot;
-????? ????????? ??????????? ? ?????, ???????, ???????, ??? ??????? ? ????????: ?????
-1000 ???????! ? ????? ?? ?????: ?? &mdash; ? &quot;????&quot;, ??? ????? x% ???????, ??
-??? ?????? ????????? ??????? &mdash; ? ???????! ? ?????????? ???? ???, ??? ????????
-??? ? ?????. ?, ????? ????, ??????? ?? ????????????? ? ???, ??? &quot;????????? ??? ? ?????&quot;
-&mdash; ??????? ??????!
-</p>
-
-<p><i>
-Mecke
-</i></p>

Deleted: homepage/input/articles/infobox_apprentice.html
===================================================================
--- homepage/input/articles/infobox_apprentice.html	2008-08-29 22:19:05 UTC (rev 1293)
+++ homepage/input/articles/infobox_apprentice.html	2008-08-29 22:36:21 UTC (rev 1294)
@@ -1,6 +0,0 @@
-    <div class="infobody">
-       <div class="info">
-         <h3>The Apprentice</h3>
-         <a href="$$apprentice_1$$">Part 1: <br>&quot;You are welcome&quot;</a>
-       </div>
-    </div>

Deleted: homepage/input/articles/infobox_apprentice_de.html
===================================================================
--- homepage/input/articles/infobox_apprentice_de.html	2008-08-29 22:19:05 UTC (rev 1293)
+++ homepage/input/articles/infobox_apprentice_de.html	2008-08-29 22:36:21 UTC (rev 1294)
@@ -1,6 +0,0 @@
-    <div class="infobody">
-       <div class="info">
-         <h3>Der Neuling</h3>
-         <a href="$$apprentice_1$$">Teil 1: <br>&quot;You are welcome&quot;</a>
-       </div>
-    </div>

Deleted: homepage/input/articles/infobox_apprentice_ru.html
===================================================================
--- homepage/input/articles/infobox_apprentice_ru.html	2008-08-29 22:19:05 UTC (rev 1293)
+++ homepage/input/articles/infobox_apprentice_ru.html	2008-08-29 22:36:21 UTC (rev 1294)
@@ -1,6 +0,0 @@
-    <div class="infobody">
-       <div class="info">
-         <h3>????? ??????????</h3>
-         <a href="$$apprentice_1$$">????? 1: <br>&quot;????? ??????????&quot;</a>
-       </div>
-    </div>

Copied: homepage/input/articles/infobox_marbleous.html (from rev 1291, homepage/input/articles/infobox_apprentice.html)
===================================================================
--- homepage/input/articles/infobox_apprentice.html	2008-08-27 21:44:59 UTC (rev 1291)
+++ homepage/input/articles/infobox_marbleous.html	2008-08-29 22:36:21 UTC (rev 1294)
@@ -0,0 +1,7 @@
+    <div class="infobody">
+       <div class="info">
+         <h2>Marbleous!</h2>
+         <h3>The Novice</h3>
+         <a href="$$marbleous_1$$">Part 1: <br>&quot;We welcome you&quot;</a>
+       </div>
+    </div>

Copied: homepage/input/articles/infobox_marbleous_de.html (from rev 1291, homepage/input/articles/infobox_apprentice_de.html)
===================================================================
--- homepage/input/articles/infobox_apprentice_de.html	2008-08-27 21:44:59 UTC (rev 1291)
+++ homepage/input/articles/infobox_marbleous_de.html	2008-08-29 22:36:21 UTC (rev 1294)
@@ -0,0 +1,7 @@
+    <div class="infobody">
+       <div class="info">
+         <h2>Gemurmel!</h2>
+         <h3>Der Neuling</h3>
+         <a href="$$marbleous_1$$">Teil 1: <br>&quot;You are welcome&quot;</a>
+       </div>
+    </div>

Copied: homepage/input/articles/infobox_marbleous_ru.html (from rev 1291, homepage/input/articles/infobox_apprentice_ru.html)
===================================================================
--- homepage/input/articles/infobox_apprentice_ru.html	2008-08-27 21:44:59 UTC (rev 1291)
+++ homepage/input/articles/infobox_marbleous_ru.html	2008-08-29 22:36:21 UTC (rev 1294)
@@ -0,0 +1,7 @@
+    <div class="infobody">
+       <div class="info">
+         <h2>Marbleous!</h2>
+         <h3>????? ??????????</h3>
+         <a href="$$marbleous_1$$">????? 1: <br>&quot;????? ??????????&quot;</a>
+       </div>
+    </div>

Copied: homepage/input/articles/marbleous_1.html (from rev 1291, homepage/input/articles/apprentice_1.html)
===================================================================
--- homepage/input/articles/apprentice_1.html	2008-08-27 21:44:59 UTC (rev 1291)
+++ homepage/input/articles/marbleous_1.html	2008-08-29 22:36:21 UTC (rev 1294)
@@ -0,0 +1,31 @@
+
+<h2>Marbleous!</h2>
+
+<h3>The Novice &mdash; &quot;We welcome you&quot;</h3>
+
+<p>
+Interested friends ask me, what is Enigma like? Is a game with all those many
+levels worthwhile? &hellip; I say to them: Be glad, you still have all of them to
+play! The novice looks perplexed at the first twelve &quot;previews&quot;
+of the opened level pack and begins playing &quot;Welcome&quot;&mdash;and opens
+&quot;his&quot; first oxyds, still unsure of the handling of the marble that
+is now under his thumb. Was that it!? Yes&mdash;Level finished. That easy?
+Yes&mdash;in some respect every level is a &quot;Welcome&quot;-level &hellip;
+with more or fewer obstacles! Light up the oxyds&mdash;and, as a diversion,
+meditate in &quot;meditation levels&quot;: make the marble
+&quot;stay put&quot;. The preview shows the novice, still basking in the
+glow of the
+solved &quot;Welcome&quot;, that every enclosed level differs in color,
+composition, shape &hellip;, and during his first contact with
+the &quot;death's-head&quot; he experiences &quot;landscapes&quot; that present
+varying degrees of challenge, perils, that seem limitless in their evolution:
+Over 1000 levels!
+And then he realises: Yes&mdash;I know that completing this level means x% of
+them solved, but there is still much to do&mdash;fortunately! And thanks to all
+those that made this possible. And maybe, some day, he starts to &quot;make it
+possible&quot; as well: We welcome you!
+</p>
+
+<p><i>
+Mecke
+</i></p>

Copied: homepage/input/articles/marbleous_1_de.html (from rev 1291, homepage/input/articles/apprentice_1_de.html)
===================================================================
--- homepage/input/articles/apprentice_1_de.html	2008-08-27 21:44:59 UTC (rev 1291)
+++ homepage/input/articles/marbleous_1_de.html	2008-08-29 22:36:21 UTC (rev 1294)
@@ -0,0 +1,30 @@
+
+<h2>Gemurmel!</h2>
+
+<h3>Der Neuling &mdash; &quot;You are welcome&quot;</h3>
+
+<p>
+Interessierten, die mich fragen, wie das mit Enigma &quot;so sei&quot;, ob das
+Spiel &quot;lohne&quot;, diese vielen Level &hellip; sage ich: Sei froh, du hast noch
+alle vor dir! Verdutzt schaut der Neuling auf die im aufgerufenen Levelpaket
+angezeigten ersten 12 &quot;Vorschauen&quot; und startet  &quot;Welcome&quot; -
+und &ouml;ffnet &quot;seine&quot; ersten Oxyds, noch unsicher im Umgang mit der in
+seiner &quot;Gewalt&quot; befindlichen Kugel.  War's das? Ja - Level geschafft.
+So einfach? Ja - jeder Level ist im Prinzip ein &quot;Welcome&quot;-Spiel &hellip;
+mit mehr oder weniger Hindernissen! Bring die Oxyds zum leuchten - und, als
+Abwechslung, meditiere in &quot;Meditationsleveln&quot;: bring &quot;die&quot;
+Kugel zum &quot;verweilen&quot;. Die Levelvorschau zeigt dem Neuling, noch
+gl&uuml;cklich &uuml;ber das gel&ouml;ste  &quot;Welcome&quot;, dass jeder
+angebotene Level sich in Farbe, Aufbau, Form &hellip; unterscheidet, und
+sp&auml;testens beim Erstkontakt mit einem &quot;Totenkopf&quot; realisiert es
+&quot;Landschaften&quot; mit unterschiedlichen Herausforderungen, Bedrohungen,
+die in ihrer Evolution dann grenzenlos erscheint: &uuml;ber 1000 Level! Und dann
+sieht er: Ja - ich &quot;kenne&quot; den Level = x% geloest, aber da liegt noch
+viel vor mir - zum Gl&uuml;ck! Und dank all jener, die das erm&ouml;glicht
+haben. Und vielleicht, irgendwann, ist er selbst dabei, mit zu
+&quot;erm&ouml;glichen&quot;: You are welcome!
+</p>
+
+<p><i>
+Mecke
+</i></p>

Copied: homepage/input/articles/marbleous_1_ru.html (from rev 1291, homepage/input/articles/apprentice_1_ru.html)
===================================================================
--- homepage/input/articles/apprentice_1_ru.html	2008-08-27 21:44:59 UTC (rev 1291)
+++ homepage/input/articles/marbleous_1_ru.html	2008-08-29 22:36:21 UTC (rev 1294)
@@ -0,0 +1,29 @@
+
+<h2>Marbleous!</h2>
+
+<h3>????? ?????????? &mdash; &quot;????? ??????????&quot;</h3>
+
+<p>
+?????? ?????????? ???? ?? Enigma, ?? ??? ??? &quot;??????&quot;,
+??? &quot;????? ?? ? ??? ??????&quot;, ?? ??? ??? ?????????????? ??????&hellip;
+? ?????? ??: ?????????, ??? ???? ??? ?????? ????????? ??????? ? ?????? ?? ???!
+??????? ?????????? ??????? ?? ?????? ?????? &quot;???????&quot; ?????????
+?????? ???????, ????????? ??????? &quot;Welcome&quot; (&quot;????? ??????????&quot;)
+&mdash; ? ????????? &quot;????&quot; ?????? ??????, ??? ??? ??????? ????????? ?
+?????????????? ??? ???????. ??? ???? ?? &mdash; ??????? ???????. ??? ??????? ?? &mdash;
+? ????????? ???? ?????? ??????? &mdash; ??? ??????? &quot;Welcome&quot;&hellip; ??????
+?????????? ??????????? ??????????! ???????? ?????? ??? ??? ???????????? ????????????? ??
+&quot;??????? ??? ?????????&quot;: ????????? &quot;?????&quot; &quot;????????????&quot;.
+????? ?????????? ???????, ??????? ??? ??? ????????, ??? ?????? ??????? &quot;Welcome&quot;,
+??? ? ??????? ?? ??????? ????????? ???????? ??????????, ??????????, ?????&hellip;
+?, ???????, ?????? ??????? ? &quot;???????&quot; ??????????, ??? &quot;??????&quot;
+????? ????????? ??????????? ? ?????, ???????, ???????, ??? ??????? ? ????????: ?????
+1000 ???????! ? ????? ?? ?????: ?? &mdash; ? &quot;????&quot;, ??? ????? x% ???????, ??
+??? ?????? ????????? ??????? &mdash; ? ???????! ? ?????????? ???? ???, ??? ????????
+??? ? ?????. ?, ????? ????, ??????? ?? ????????????? ? ???, ??? &quot;????????? ??? ? ?????&quot;
+&mdash; ??????? ??????!
+</p>
+
+<p><i>
+Mecke
+</i></p>

Modified: homepage/input/hp_archive.html
===================================================================
--- homepage/input/hp_archive.html	2008-08-29 22:19:05 UTC (rev 1293)
+++ homepage/input/hp_archive.html	2008-08-29 22:36:21 UTC (rev 1294)
@@ -24,7 +24,7 @@
   </li>
   <li><a href="$$april_2008$$">April Fool's Day Joke 2008 - &quot;The Three Clouds&quot;</a>
   </li>
-  <li><a href="$$apprentice_1$$">The Apprentice, Part 1</a>
+  <li><a href="$$marbleous_1$$">Marbleous! &mdash; The Novice, Part 1</a>
   </li>
 </ul>
 

Modified: homepage/input/hp_archive_de.html
===================================================================
--- homepage/input/hp_archive_de.html	2008-08-29 22:19:05 UTC (rev 1293)
+++ homepage/input/hp_archive_de.html	2008-08-29 22:36:21 UTC (rev 1294)
@@ -24,7 +24,7 @@
   </li>
   <li><a href="$$april_2008$$">Aprilscherz 2008 - &quot;The Three Clouds&quot;</a>
   </li>
-  <li><a href="$$apprentice_1$$">Der Neuling, Teil 1</a>
+  <li><a href="$$marbleous_1$$">Gemurmel! &mdash; Der Neuling, Teil 1</a>
   </li>
 </ul>
 

Modified: homepage/input/hp_archive_ru.html
===================================================================
--- homepage/input/hp_archive_ru.html	2008-08-29 22:19:05 UTC (rev 1293)
+++ homepage/input/hp_archive_ru.html	2008-08-29 22:36:21 UTC (rev 1294)
@@ -23,6 +23,6 @@
   </li>
   <li><a href="$$april_2008$$">??????????????? ????? 2008 - &quot;The Three Clouds&quot;</a>
   </li>
-  <li><a href="$$apprentice_1$$">????? ??????????, ????? 1</a>
+  <li><a href="$$marbleous_1$$">????? ??????????, ????? 1</a>
   </li>
 </ul>

Modified: homepage/input/infobox.html
===================================================================
--- homepage/input/infobox.html	2008-08-29 22:19:05 UTC (rev 1293)
+++ homepage/input/infobox.html	2008-08-29 22:36:21 UTC (rev 1294)
@@ -1,9 +1,10 @@
     <div class="infobody">
        <div class="info">
-         <h3>The Apprentice</h3>
-         Mecke started a new monthly column for our homepage, &quot;The
-         Apprentice&quot;! Read about his first adventure, his
-         experiences and thoughts <a href="$$apprentice_1$$">here</a>.
+         <h3>Marbleous!</h3>
+         With this we present a new column on our homepage, starting with
+         Mecke's series &quot;The Novice&quot;! Read <a
+         href="$$marbleous_1$$">here</a> about his first adventures,
+         his experiences and thoughts as &quot;novice&quot;.
 
          <h3>Level of the Month</h3>
          <a href="$$lotm_current$$"><img src="$$lotm_current_image$$"

Modified: homepage/input/infobox_de.html
===================================================================
--- homepage/input/infobox_de.html	2008-08-29 22:19:05 UTC (rev 1293)
+++ homepage/input/infobox_de.html	2008-08-29 22:36:21 UTC (rev 1294)
@@ -1,10 +1,10 @@
     <div class="infobody">
        <div class="info">
-         <h3>Der Neuling</h3>
-         Mecke hat f&uuml;r uns eine neue monatliche Kolumne begonnen, den
-         &quot;Neuling&quot;! Lesen Sie <a
-         href="$$apprentice_1$$">hier</a> &uuml;ber sein erstes Abenteuer,
-         seine Erfahrungen und Gedanken.
+         <h3>Gemurmel!</h3>
+         Eine neue Kolumne er&ouml;ffnen wir hiermit auf unserer Homepage,
+         beginnend mit Mecke's Reihe &quot;Der Neuling&quot;! Lesen Sie <a
+         href="$$marbleous_1$$">hier</a> &uuml;ber sein erstes Abenteuer,
+         seine Erfahrungen und Gedanken als &quot;Neuling&quot;.
          
          <h3>Level des Monats</h3>
          <a href="$$lotm_current$$"><img src="$$lotm_current_image$$"

Modified: homepage/input/infobox_ru.html
===================================================================
--- homepage/input/infobox_ru.html	2008-08-29 22:19:05 UTC (rev 1293)
+++ homepage/input/infobox_ru.html	2008-08-29 22:36:21 UTC (rev 1294)
@@ -3,7 +3,7 @@
          <h3>????? ??????????</h3>
          Mecke ??????? ?????? ??? ????? ??????????? ??????? ??? ????? ???????? ???????? &mdash;
 	 &quot;????? ??????????&quot;! ? ?????? ??? ???????????, ??? ????? ? ???????????? ???????
-	 <a href="$$apprentice_1$$">?????</a>.
+	 <a href="$$marbleous_1$$">?????</a>.
 
          <h3>??????? ??????</h3>
          <a href="$$lotm_current$$"><img src="$$lotm_current_image$$"

Modified: homepage/input/output-files.lua
===================================================================
--- homepage/input/output-files.lua	2008-08-29 22:19:05 UTC (rev 1293)
+++ homepage/input/output-files.lua	2008-08-29 22:36:21 UTC (rev 1294)
@@ -521,17 +521,17 @@
 }    
 
 ----------------------------------------------------------------------
--- The Apprentice
+-- Marbleous!
 ----------------------------------------------------------------------
 
-html.apprentice_1 = {
-    outfile = "apprentice_1.html",
-    title = "The Apprentice, Part 1",
-    title_de = "Der Neuling, Teil 1",
+html.marbleous_1 = {
+    outfile = "marbleous_1.html",
+    title = "Marbleous! &mdash; The Novice, Part 1",
+    title_de = "Gemurmel! &mdash; Der Neuling, Teil 1",
     title_ru = "????? ??????????, ????? 1",
-    rightcolumn = {"articles/infobox_apprentice"},
-    body = {"articles/apprentice_1"},
-}    
+    rightcolumn = {"articles/infobox_marbleous"},
+    body = {"articles/marbleous_1"},
+}
 
 ----------------------------------------------------------------------
 -- Independent Level Articles
@@ -544,5 +544,5 @@
     title_ru = "Patterns of Impulse",
     rightcolumn = {},
     body = {"articles/level_andreas11"},
-}    
+}
 

Modified: homepage/input/top_news.html
===================================================================
--- homepage/input/top_news.html	2008-08-29 22:19:05 UTC (rev 1293)
+++ homepage/input/top_news.html	2008-08-29 22:36:21 UTC (rev 1294)
@@ -48,9 +48,10 @@
          Labyrinth&quot;</a>, from Shoki. You can download it
          <a href="$$imagedir$$/lotm/lotm_200703_shoki.jpg">here</a>.
          
-         <h4><span class="date">2008-08-17:</span> The Apprentice</h4>
-         Mecke started a new monthly column for our homepage, &quot;The
-         Apprentice&quot;! Read about his first adventure, his
-         experiences and thoughts <a href="$$apprentice_1$$">here</a>.
+         <h4><span class="date">2008-08-29:</span> Marbleous!</h4>
+         With this we present a new column on our homepage, starting with
+         Mecke's series &quot;The Novice&quot;! Read <a
+         href="$$marbleous_1$$">here</a> about his first adventures,
+         his experiences and thoughts as &quot;novice&quot;.
          
 

Modified: homepage/input/top_news_de.html
===================================================================
--- homepage/input/top_news_de.html	2008-08-29 22:19:05 UTC (rev 1293)
+++ homepage/input/top_news_de.html	2008-08-29 22:36:21 UTC (rev 1294)
@@ -52,9 +52,9 @@
          bekommen. Sie k&ouml;nnen sie <a
          href="$$imagedir$$/lotm/lotm_200703_shoki.jpg">hier</a> herunterladen.
          
-         <h4><span class="date">17.8.2008:</span> Der Neuling</h4>
-         Mecke hat f&uuml;r uns eine neue monatliche Kolumne begonnen, den
-         &quot;Neuling&quot;! Lesen Sie <a
-         href="$$apprentice_1$$">hier</a> &uuml;ber sein erstes Abenteuer,
-         seine Erfahrungen und Gedanken.
+         <h4><span class="date">2008-08-30:</span> Gemurmel!</h4>
+         Eine neue Kolumne er&ouml;ffnen wir hiermit auf unserer Homepage,
+         beginnend mit Mecke's Reihe &quot;Der Neuling&quot;! Lesen Sie <a
+         href="$$marbleous_1$$">hier</a> &uuml;ber sein erstes Abenteuer,
+         seine Erfahrungen und Gedanken als &quot;Neuling&quot;.
          
\ No newline at end of file

Modified: homepage/input/top_news_ru.html
===================================================================
--- homepage/input/top_news_ru.html	2008-08-29 22:19:05 UTC (rev 1293)
+++ homepage/input/top_news_ru.html	2008-08-29 22:36:21 UTC (rev 1294)
@@ -43,5 +43,5 @@
          <h4><span class="date">2008-08-17:</span> The Apprentice</h4>
          Mecke started a new monthly column for our homepage, &quot;The
          Apprentice&quot;! Read about his first adventure, his
-         experiences and thoughts <a href="$$apprentice_1$$">here</a>.
+         experiences and thoughts <a href="$$marbleous_1$$">here</a>.
 



From ral at mail.berlios.de  Sat Aug 30 12:33:09 2008
From: ral at mail.berlios.de (ral at mail.berlios.de)
Date: Sat, 30 Aug 2008 12:33:09 +0200
Subject: [Enigma-game-svn] r1295 - trunk/doc/reference
Message-ID: <200808301033.m7UAX9CZ016149@sheep.berlios.de>

Author: ral
Date: 2008-08-30 12:32:39 +0200 (Sat, 30 Aug 2008)
New Revision: 1295

Modified:
   trunk/doc/reference/enigma-ref.texi
Log:
Trunk 1.1: new API
- refman docu updates for r1292: added fart, pipe, mail, seed, volcano


Modified: trunk/doc/reference/enigma-ref.texi
===================================================================
--- trunk/doc/reference/enigma-ref.texi	2008-08-29 22:36:21 UTC (rev 1294)
+++ trunk/doc/reference/enigma-ref.texi	2008-08-30 10:32:39 UTC (rev 1295)
@@ -5929,6 +5929,7 @@
 
 @menu
 * it_blocker::         Shrinked Blocker Stone
+* it_brake::           Movable Stone Brake
 * it_brush::           
 * it_coin::            Enigma's currency
 * it_cross::           Floor switch for patient Actors
@@ -5941,7 +5942,9 @@
 * it_landmine::        
 * it_magicwand::       Wizards Tools
 * it_magnet::          
+* it_pipe::            
 * it_rubberband::      
+* it_seed::            Seeds for Wood, Volcano Stones
 * it_sensor::          Floor Switch for passing Actors
 * it_shogun::          Dot for Shogun Stones
 * it_strip::           Narrow Bridge
@@ -6035,6 +6038,41 @@
 
 @end table
 
+ at c ----------------- Brake Item -------------------- 
+ at node it_brake
+ at subsection it_brake
+ at obindex it_brake
+
+The brake is a stone that can be picked up as an item by actors. The 
+ at ref{st_brake} can be used to stop a running @ref{st_boulder} or a
+ at ref{st_lightpassenger}, what likely has given this object its name.
+
+When an actor passes below the brake stone it will pick up the object like
+other items. The brake will be added as a brake item to its inventory. 
+Unlike other items the brake can be dropped even on grids that are already
+occupied by an item. But you can not drop the brake beneath another stone like
+a @ref{it_seed}.
+
+On dropping the brake item it transforms immediatly to an @ref{st_brake} without
+killing an item positioned on the grid. The brake stone will press an
+ at ref{it_trigger} beneath, what makes the brake item a portable trigger key.
+
+The item itself will never exist on the world grid. It exists just as part of
+the player inventory or item containers like @ref{it_bag}.
+
+Due to the @ref{Snapshot Principle} you should never instantiate this item. Do
+set an @ref{st_brake} to the world grid positions instead. This item is listed
+for your understanding what happens to a picked up brake and for identifying
+an @ref{Object Kind} @samp{it_brake} in an inventory or a container.
+
+ at table @asis
+
+ at item @b{Attributes:} none
+
+ at item @b{Messages:} none
+
+ at end table
+
 @c ----------------- Brush Item -------------------- 
 @node it_brush
 @subsection it_brush
@@ -6422,6 +6460,104 @@
 
 @end table
 
+ at c ----------------- Seed Item -------------------- 
+ at node it_seed
+ at subsection it_seed
+ at obindex it_seed
+
+Stone seeds are items that start growing and finally transforming to stones
+on activation. There are different @samp{flavor}s of seeds that all look the
+same, but do grow to different stones. While a @samp{wood} seed grows to an
+ at ref{st_wood}, a @samp{fake} seed grows to an unmovable green brown stone and
+a @samp{volcano} seed grows to an active @ref{st_volcano}.
+
+Seeds can be dropped on any item free grid position, even beneath another stone
+that will get killed by the seed successor stone.
+
+Seeds get automatically activated when being dropped, when hit by a laser beam
+or a stone being pushed on them. You can activate them by @samp{grow} and
+ at samp{signal} messages, too.
+
+The identity of the seed gets transfered to the emerging stone including the
+attribute @samp{secure}.
+
+The only method of handling seeds without activation are containment within a
+ at ref{it_bag} or sending them via @ref{st_mail} to a destination grid.
+
+ at table @asis
+ at item @b{Attributes:}
+ at table @asis
+ at item @b{flavor}, @ @ @i{values}: @code{"wood"}, @code{"fake"}, @code{"volcano"}; @ @ @i{default}: @code{"wood"}
+The type of the resulting stone.
+ at item @b{secure} @ @ @i{values}: @code{true}, @code{false}; @ @ @i{default}: @code{false}
+This attribute is transfered to the resulting stone. The @ref{st_volcano} makes
+use of it.
+ at end table
+
+ at item @b{Messages:} none
+ at table @asis
+ at item @b{grow}
+Start growing the seed.
+ at item @b{signal} @ @ @xref{signal}
+Start growing the seed.
+ at end table
+
+ at item @b{Variants:}
+ at table @asis
+ at item @b{it_seed} flavor = @code{"wood"}
+ at item @b{it_seed_wood} flavor = @code{"wood"}
+ at item @b{it_seed_fake} flavor = @code{"fake"}
+ at item @b{it_seed_volcano} flavor = @code{"volcano"}
+ at end table
+
+ at end table
+
+ at c ----------------- Pipe Item -------------------- 
+ at node it_pipe
+ at subsection it_pipe
+ at obindex it_pipe
+
+Pipe items are used to build item transporting pipes connected to an
+ at ref{st_mail}. 
+
+Pipe items are described by their @samp{connections} to neighbor grids. A pipe
+is build up of items with fitting connections.
+
+Even though there exist pipe ending items with just one connection there is
+currently no known usage of them besides decoration.
+
+ at table @asis
+ at item @b{Attributes:}
+ at table @asis
+ at item @b{connections}, @ @ @i{values}: string; @ @ @i{default}: @code{"ew"}
+Describes the pipe connections to the neighbor grids. The string is a substring of 
+ at code{"nesw"} listing the existing connections. The sequence of the sides, north,
+east, south, west, is guaranteed on read access but arbitrary on write access.
+Currently only pipes with one or two connections do exist.
+ at end table
+
+ at item @b{Messages:} none
+ at item @b{Action:} none
+
+ at item @b{Variants:}
+ at table @asis
+ at item @b{it_pipe} connections = @code{"ew"}
+The horizontal pipe.
+ at item @b{it_pipe_w} connections = @code{"w"}
+ at item @b{it_pipe_s} connections = @code{"s"}
+ at item @b{it_pipe_sw} connections = @code{"sw"}
+ at item @b{it_pipe_e} connections = @code{"e"}
+ at item @b{it_pipe_ew} connections = @code{"ew"}
+The horizontal pipe.
+ at item @b{it_pipe_es} connections = @code{"es"}
+ at item @b{it_pipe_n} connections = @code{"n"}
+ at item @b{it_pipe_nw} connections = @code{"nw"}
+ at item @b{it_pipe_ns} connections = @code{"ns"}
+The vertical pipe.
+ at item @b{it_pipe_ne} connections = @code{"ne"}
+ at end table
+ at end table
+
 @c ----------------- Rubberband Item -------------------- 
 @node it_rubberband
 @subsection it_rubberband
@@ -6472,6 +6608,59 @@
 @ref{ot_rubberband}.
 @end table
 
+
+ at c ----------------- Seed Item -------------------- 
+ at node it_seed
+ at subsection it_seed
+ at obindex it_seed
+
+Stone seeds are items that start growing and finally transforming to stones
+on activation. There are different @samp{flavor}s of seeds that all look the
+same, but do grow to different stones. While a @samp{wood} seed grows to an
+ at ref{st_wood}, a @samp{fake} seed grows to an unmovable green brown stone and
+a @samp{volcano} seed grows to an active @ref{st_volcano}.
+
+Seeds can be dropped on any item free grid position, even beneath another stone
+that will get killed by the seed successor stone.
+
+Seeds get automatically activated when being dropped, when hit by a laser beam
+or a stone being pushed on them. You can activate them by @samp{grow} and
+ at samp{signal} messages, too.
+
+The identity of the seed gets transfered to the emerging stone including the
+attribute @samp{secure}.
+
+The only method of handling seeds without activation are containment within a
+ at ref{it_bag} or sending them via @ref{st_mail} to a destination grid.
+
+ at table @asis
+ at item @b{Attributes:}
+ at table @asis
+ at item @b{flavor}, @ @ @i{values}: @code{"wood"}, @code{"fake"}, @code{"volcano"}; @ @ @i{default}: @code{"wood"}
+The type of the resulting stone.
+ at item @b{secure} @ @ @i{values}: @code{true}, @code{false}; @ @ @i{default}: @code{false}
+This attribute is transfered to the resulting stone. The @ref{st_volcano} makes
+use of it.
+ at end table
+
+ at item @b{Messages:} none
+ at table @asis
+ at item @b{grow}
+Start growing the seed.
+ at item @b{signal} @ @ @xref{signal}
+Start growing the seed.
+ at end table
+
+ at item @b{Variants:}
+ at table @asis
+ at item @b{it_seed} flavor = @code{"wood"}
+ at item @b{it_seed_wood} flavor = @code{"wood"}
+ at item @b{it_seed_fake} flavor = @code{"fake"}
+ at item @b{it_seed_volcano} flavor = @code{"volcano"}
+ at end table
+
+ at end table
+
 @c ----------------- Sensor Item -------------------- 
 @node it_sensor
 @subsection it_sensor
@@ -7144,10 +7333,12 @@
 * st_actorimpulse::    Bumper Stone
 * st_blocker::         Shrinkable Blocker
 * st_boulder::         Moving Arrow Boulder
+* st_brake::           Brake for moving Boulders
 * st_chess::           Movable Chess Knight Stone
 * st_coinslot::        Coin Driven Switch
 * st_death::           Skull Stone
 * st_door::            Door of various Flavors
+* st_fart::            Oxyd closing Stone
 * st_floppy::          Floppy Driven Switch
 * st_fourswitch::      Four Direction Switch
 * st_key::             Key Driven Switch
@@ -7156,19 +7347,23 @@
 * st_laserflop::       Lightsensitive Monoflop
 * st_laserswitch::     Lightsensitive Switch
 * st_lightpassenger::  Stone pushed by Light
+* st_mail::            Mail office for Item transportation
 * st_mirror::          Mirrors of all flavors
 * st_monoflop::        Monoflop Switch
 * st_oneway::          Oneway Passage
 * st_oxyd::            Game Target Stone
 * st_polarswitch::     Transparency Switch for Light Beams
+* st_pull::            Pullable Stone
 * st_rotator::         Rotating Stone Impulser
 * st_rubberband::      Rubberband generator
 * st_scissors::        Scissors cutting rubberbands
 * st_shogun::          Stackable Hole Stones
+* st_swap::            Neighbor Swapping Stone
 * st_switch::          Classical on/off Switch
 * st_timer::           Animated Timer
 * st_turnstile::       Turnstile Pivot
 * st_turnstilearm::    Turnstile Arm
+* st_volcano::         Spreading Volcano
 * st_window::          Faced Window
 @end menu
 
@@ -7381,6 +7576,40 @@
 
 @end table
 
+ at c ----------------- Brake Stone -------------------- 
+ at node st_brake
+ at subsection st_brake
+ at obindex st_brake
+
+The brake stone can be used to block a running @ref{st_boulder} or a
+ at ref{st_lightpassenger}, what likely has given this object its name. But unlike
+all other blocking stones the brake can be picked up as an item by actors and
+dropped anywhere else.
+
+When an actor passes below the brake stone it will pick up the object like
+other items. The brake will be added as an @ref{it_brake} to its inventory. 
+Unlike other items the brake can be dropped even on grids that are already
+occupied by an item. But you can not drop the brake beneath another stone like
+a @ref{it_seed}.
+
+On dropping the brake item it transforms immediatly back to an @ref{st_brake}
+without killing the item positioned on the grid. Just one exception is a brake
+being dropped on top of an @ref{it_blocker} what results in an elimination of
+the blocker. On the other hand a brake stone will press an @ref{it_trigger}
+beneath, what makes the brake item a portable trigger key.
+
+The brake stone explodes when it is exposed to laser light or a @ref{it_bomb}
+explosion on a direct neighbor grid.
+
+ at table @asis
+ at item @b{Attributes:} none
+
+ at item @b{Messages:} none
+
+ at item @b{Action:} none
+
+ at end table
+
 @c ----------------- Chess Stone -------------------- 
 @node st_chess
 @subsection st_chess
@@ -7638,6 +7867,49 @@
 
 @end table
 
+ at c ----------------- Fart Stone -------------------- 
+ at node st_fart
+ at subsection st_fart
+ at obindex st_fart
+
+This stone looks like an @ref{st_oxyd} of flavor @code{"b"}, but it has the
+unpleasant habit of "blowing off" when being activated. Unfortunatley the 
+bad air closes all open @ref{st_oxyd}s.
+
+The stone gets activated on an actor hit, on @ref{st_boulder}s hit and on its
+destruction.
+
+The player can destroy this troublemaker with an actor that reveals an 
+ at ref{it_hammer}, by directing a laser light onto the fart stone or by a nearby
+explosion or ignition. 
+
+Of course you can activate and destroy it by messages and state set operations,
+too.
+
+ at table @asis
+ at item @b{Attributes:}
+
+ at table @asis
+ at item @b{state}, @ @ @i{values}: @code{IDLE}, @code{ACTIVE}, @code{BREAKING}; @ @ @i{default}: @code{IDLE}: @ @ @xref{state}
+Current state of the fart stone. You can just change the state into legal
+follow up states. A breaking state is final.
+ at end table
+
+ at item @b{Messages:}
+
+ at table @asis
+ at item @b{toggle} @ @ @xref{toggle}
+Toggles stone from @samp{IDLE} to @samp{ACTIVE}
+ at item @b{signal} @ @ @xref{signal}
+Toggles stone from @samp{IDLE} to @samp{ACTIVE}
+ at item @b{ignite}
+Toggles stone to @samp{BREAKING}
+ at end table
+
+ at item @b{Action:} none
+
+ at end table
+
 @c ----------------- Floppy Stone -------------------- 
 @node st_floppy
 @subsection st_floppy
@@ -8025,6 +8297,41 @@
 
 @end table
 
+ at c ----------------- Mail Stone -------------------- 
+ at node st_mail
+ at subsection st_mail
+ at obindex st_mail
+
+When hit by an actor, a mail stone takes the first item out of the player's
+inventory and drops it at its exit, or the exit of the appending @ref{it_pipe}. 
+If this position is blocked (e.g., by another item), no item is taken from
+inventory.
+
+ at table @asis
+ at item @b{Attributes:}
+
+ at table @asis
+ at item @b{orientation}, @ @ @i{values}: @code{NORTH}, @code{EAST}, @code{SOUTH}, @code{WEST}; @ @ @i{default}: @code{NORTH}
+The orientation of the mail stone. It determines the neighbor grid position
+onto which the item will dropped, or where the pipe starts.
+ at end table
+
+ at item @b{Messages:} none
+
+ at item @b{Action:} none
+
+ at item @b{Variants:}
+
+ at table @asis
+ at item @b{st_mail}: orientation = @code{NORTH}
+ at item @b{st_mail_w}: orientation = @code{WEST}
+ at item @b{st_mail_s}: orientation = @code{SOUTH}
+ at item @b{st_mail_e}: orientation = @code{EAST}
+ at item @b{st_mail_n}: orientation = @code{NORTH}
+ at end table
+
+ at end table
+
 @c ----------------- Mirror Stone -------------------- 
 @node st_mirror
 @subsection st_mirror
@@ -8373,6 +8680,53 @@
 
 @end table
 
+ at c ----------------- Pull Stone -------------------- 
+ at node st_pull
+ at subsection st_pull
+ at obindex st_pull
+
+A pull stone changes its position on an initiating impulse into the reverse
+direction of the impulse. Thus it can not be pushed like other movable stones.
+But when an actor hits a pull stone it acts like being pulled. If another stone
+is located on the destination grid, both stones will exchange their positions.
+The exchange will also be perfomed when the pull stones receives a stone impulse
+via an @ref{ot_wire} or a neighboring @ref{st_stoneimpulse}. A similar stone is
+the @ref{st_swap}, that exchanges with stones in the forward direction of the
+initiating impulse.
+
+Actors on the destination grid, including an initiating hitting actor, are 
+pulled through it, not caged under them. The actors reappear on the old grid
+position of the pull stone with their old velocities.
+
+The pull stone is laser light transparent like other glass like stones.
+
+An existing stone exchange partner is not mandatory. But if an stone is located
+on the destination position of a pull stone some conditions must be met for a
+stone exchange. Connected @ref{Cluster Stones} building a block, @ref{st_oxyd} 
+configured as being @samp{static}, and another @ref{st_swap} or pull stone that
+is currently engaged in an own stone exchange operation will refuse swapping.
+
+Stone exchanges will not cause item hit transformations as caused by push moved
+stones. But the exchanged stones will react on the new floor, e.g. causing 
+ at ref{st_wood} and similar stones to sink into water.
+
+Furtheron the exchange is atomic concerning @ref{it_trigger} detection and
+laser light transparency. If the exchanged stone is not transparent, the light
+will pass on every time slice just on one of the two grids. If the exchanged
+stone is floating and does not press @ref{it_trigger}s, the pull stone will 
+press just one trigger, releasing the trigger of the old position before 
+pressing the new position's trigger like any other stone being pushed from one 
+grid to the next.
+
+ at table @asis
+ at item @b{Attributes:} none
+
+ at item @b{Messages:} none
+
+ at item @b{Action:} none
+
+ at end table
+
 @c ----------------- Rotator Stone -------------------- 
 @node st_rotator
 @subsection st_rotator
@@ -8417,7 +8771,6 @@
 @item @b{st_rotator_ccw}: state = @code{CCW}
 @end table
 
-
 @end table
 
 @c ----------------- Rubberband Stone -------------------- 
@@ -8563,6 +8916,46 @@
 
 @end table
 
+ at c ----------------- Swap Stone -------------------- 
+ at node st_swap
+ at subsection st_swap
+ at obindex st_swap
+
+A swap stone can exchange its position with a neighboring stone on the side
+in direction of the initiating impulse. It is not freely movable by pushes.
+But when an actor hits a swap stone and another stone is located on the opposite
+side of the swap stone, both stones will exchange their positions. The swap will
+also be perfomed when the swap stones receives a stone impulse via an
+ at ref{ot_wire} or a neighboring @ref{st_stoneimpulse}. A similar stone it the
+ at ref{st_pull}, that exchanges with stones in the reverse direction of the
+initiating impulse.
+
+An existing stone exchange partner is mandatory. Nearly all stones can be 
+swapped. Just connected @ref{Cluster Stones} building a block, @ref{st_oxyd} 
+configured as being @samp{static}, and another swap stone or @ref{st_pull} that
+is currently engaged in an own stone exchange operation will refuse swapping.
+
+Stone exchanges will not cause item hit transformations as caused by push moved
+stones. But the exchanged stones will react on the new floor, e.g. causing 
+ at ref{st_wood} and similar stones to sink into water.
+
+Furtheron the exchange is atomic concerning @ref{it_trigger} detection and
+laser light transparency. If the exchanged stone is transparent, the light
+will pass on every time slice just on one of the two grids. If the exchanged
+stone is floating and does not press @ref{it_trigger}s, the swap stone will 
+press just one trigger, releasing the trigger of the old position before 
+pressing the new position's trigger like any other stone being pushed from one 
+grid to the next.
+
+ at table @asis
+ at item @b{Attributes:} none
+
+ at item @b{Messages:} none
+
+ at item @b{Action:} none
+
+ at end table
+
 @c ----------------- Switch Stone -------------------- 
 @node st_switch
 @subsection st_switch
@@ -8830,6 +9223,69 @@
 @end table
 @end table
 
+ at c ----------------- Volcano Stone -------------------- 
+ at node st_volcano
+ at subsection st_volcano
+ at obindex st_volcano
+
+A volcano stone spreads slowly to neighboring grid positions and filling up
+complete areas and will just stop on boundaries set by others stones.
+
+A volcano can either start by the setting of an @samp{ACTIVE} variant, by
+an inactive @samp{IDLE} variant being triggered by a message or a hitting
+ at ref{st_boulder}, or by an @ref{it_seed} of flavor @code{volcano} being dropped
+or triggered.
+
+Once being activated a volcano stone spreads randomly to its direct neighbor
+positions. Even though the new set volcano seeds can be passed by actors
+without harm for a short period of time the volcano gets lethal while growing.
+After reaching its full size a volcano remains for a random time in an active,
+glowing state spreading to neighbour positions. During this phase an actor
+with a revealed @ref{it_hammer} can destroy the active volcano stone.
+
+The spreading of the volcano can be made @samp{secure} by setting this attribute
+to @samp{true}. Per default the spreading in not secure and a volcano may
+stop spreading with a certain chance anywhere, but especially in narrow gateways.
+In contrast a secure volcano remains active until it is guaranteed that all its
+neighbor grid positions will be filled with volcano stones.
+
+After its active phase a volcano reaches its final inactive state and can not
+be reactivated anymore.
+
+A volcano stone will press any @ref{it_trigger} as soon as it starts growing.
+
+!!Work in progress!! special behaviour on items and floors may yet be added
+
+ at table @asis
+ at item @b{Attributes:}
+ at table @asis
+ at item @b{state}, @ @ @i{values}: @code{IDLE}, @code{ACTIVE}; @ @ @i{default}: @code{IDLE} @ @ @xref{state}
+Inactive, finished and breaking volcano will report an @samp{IDLE} state,
+new, growing and active volcano will report an @samp{ACTIVE} state. An inactive
+volcano can be activated by setting the state to @samp{ACTIVE}. All other
+attempts to set the state will be silently ignored.
+ at item @b{secure} @ @ @i{values}: @code{true}, @code{false}; @ @ @i{default}: @code{false}
+A secure volcano will spread a complete area with guarantee.
+ at end table
+
+ at item @b{Messages:}
+ at table @asis
+ at item @b{toggle} @ @ @xref{toggle}
+Activates an inactive volcano stone.
+ at end table
+
+ at item @b{Variants:}
+ at table @asis
+ at item @b{st_volcano}: state = @code{IDLE}
+ at item @b{st_volcano_idle}: state = @code{IDLE}
+ at item @b{st_volcano_active}: state = @code{ACTIVE}
+ at item @b{st_volcano_new}:
+An active volcano starting in the seed like phase.
+ at item @b{st_volcano_growing}:
+An active volcano starting in the growing phase.
+ at end table
+ at end table
+
 @c ----------------- Window Stone -------------------- 
 @node st_window
 @subsection st_window



From ged at mail.berlios.de  Sun Aug 31 15:09:29 2008
From: ged at mail.berlios.de (ged at mail.berlios.de)
Date: Sun, 31 Aug 2008 15:09:29 +0200
Subject: [Enigma-game-svn] r1296 - in homepage/input: . articles
Message-ID: <200808311309.m7VD9Tic031028@sheep.berlios.de>

Author: ged
Date: 2008-08-31 15:09:23 +0200 (Sun, 31 Aug 2008)
New Revision: 1296

Modified:
   homepage/input/articles/infobox_marbleous_ru.html
   homepage/input/articles/marbleous_1_ru.html
   homepage/input/hp_archive_ru.html
   homepage/input/infobox_ru.html
   homepage/input/output-files.lua
   homepage/input/top_news_ru.html
Log:
Homepage:
- Russian translation for pages related to new column has been modified

Modified: homepage/input/articles/infobox_marbleous_ru.html
===================================================================
--- homepage/input/articles/infobox_marbleous_ru.html	2008-08-30 10:32:39 UTC (rev 1295)
+++ homepage/input/articles/infobox_marbleous_ru.html	2008-08-31 13:09:23 UTC (rev 1296)
@@ -1,7 +1,7 @@
     <div class="infobody">
        <div class="info">
-         <h2>Marbleous!</h2>
-         <h3>????? ??????????</h3>
+         <h2>???????????!</h2>
+         <h3>???????? ?? ???????</h3>
          <a href="$$marbleous_1$$">????? 1: <br>&quot;????? ??????????&quot;</a>
        </div>
     </div>

Modified: homepage/input/articles/marbleous_1_ru.html
===================================================================
--- homepage/input/articles/marbleous_1_ru.html	2008-08-30 10:32:39 UTC (rev 1295)
+++ homepage/input/articles/marbleous_1_ru.html	2008-08-31 13:09:23 UTC (rev 1296)
@@ -1,7 +1,7 @@
 
-<h2>Marbleous!</h2>
+<h2>???????????!</h2>
 
-<h3>????? ?????????? &mdash; &quot;????? ??????????&quot;</h3>
+<h3>???????? ?? ??????? &mdash; &quot;????? ??????????&quot;</h3>
 
 <p>
 ?????? ?????????? ???? ?? Enigma, ?? ??? ??? &quot;??????&quot;,

Modified: homepage/input/hp_archive_ru.html
===================================================================
--- homepage/input/hp_archive_ru.html	2008-08-30 10:32:39 UTC (rev 1295)
+++ homepage/input/hp_archive_ru.html	2008-08-31 13:09:23 UTC (rev 1296)
@@ -23,6 +23,6 @@
   </li>
   <li><a href="$$april_2008$$">??????????????? ????? 2008 - &quot;The Three Clouds&quot;</a>
   </li>
-  <li><a href="$$marbleous_1$$">????? ??????????, ????? 1</a>
+  <li><a href="$$marbleous_1$$">???????????! &mdash; ???????? ?? ???????, ????? 1</a>
   </li>
 </ul>

Modified: homepage/input/infobox_ru.html
===================================================================
--- homepage/input/infobox_ru.html	2008-08-30 10:32:39 UTC (rev 1295)
+++ homepage/input/infobox_ru.html	2008-08-31 13:09:23 UTC (rev 1296)
@@ -1,9 +1,10 @@
     <div class="infobody">
        <div class="info">
-         <h3>????? ??????????</h3>
-         Mecke ??????? ?????? ??? ????? ??????????? ??????? ??? ????? ???????? ???????? &mdash;
-	 &quot;????? ??????????&quot;! ? ?????? ??? ???????????, ??? ????? ? ???????????? ???????
-	 <a href="$$marbleous_1$$">?????</a>.
+         <h3>???????????!</h3>
+         ? ????? ??????? ?? ????? ???????? ???????? ????? ???????, ??????? ????????? ????? ??????
+         Mecke &mdash; &quot;???????? ?? ???????&quot;! <a
+         href="$$marbleous_1$$">?????</a> ?? ?????? ???????? ? ??? ?????? ???????????, ?????
+	  ? ????????????, ????? ?? ??? &quot;????????&quot;.
 
          <h3>??????? ??????</h3>
          <a href="$$lotm_current$$"><img src="$$lotm_current_image$$"

Modified: homepage/input/output-files.lua
===================================================================
--- homepage/input/output-files.lua	2008-08-30 10:32:39 UTC (rev 1295)
+++ homepage/input/output-files.lua	2008-08-31 13:09:23 UTC (rev 1296)
@@ -111,7 +111,7 @@
     
     lotm_history = "History of LotM",
     lotm_history_de = "Geschichte des LdM",
-    --ru-- lotm_history_ru = "History of LotM",
+    lotm_history_ru = "?????????? ??",
     lotm_history_es = "Historia de LotM",
 
     lotm_current = function(v,s,l0)
@@ -528,7 +528,7 @@
     outfile = "marbleous_1.html",
     title = "Marbleous! &mdash; The Novice, Part 1",
     title_de = "Gemurmel! &mdash; Der Neuling, Teil 1",
-    title_ru = "????? ??????????, ????? 1",
+    title_ru = "???????????! &mdash; ???????? ?? ???????, ????? 1",
     rightcolumn = {"articles/infobox_marbleous"},
     body = {"articles/marbleous_1"},
 }

Modified: homepage/input/top_news_ru.html
===================================================================
--- homepage/input/top_news_ru.html	2008-08-30 10:32:39 UTC (rev 1295)
+++ homepage/input/top_news_ru.html	2008-08-31 13:09:23 UTC (rev 1296)
@@ -40,8 +40,6 @@
          ?????? ???? 2007, <a href="$$lotm_200703$$">&quot;Island
          Labyrinth&quot;</a>. ?? ?????? ??????? ?? <a href="$$imagedir$$/lotm/lotm_200703_shoki.jpg">?????</a>.
 
-         <h4><span class="date">2008-08-17:</span> The Apprentice</h4>
-         Mecke started a new monthly column for our homepage, &quot;The
-         Apprentice&quot;! Read about his first adventure, his
-         experiences and thoughts <a href="$$marbleous_1$$">here</a>.
+         <h4><span class="date">2008-08-17:</span> ???????????!</h4>
+         Mecke ??????? ?????? ??? ????? ??????????? ??????? ??? ????? ???????? ???????? &mdash; &quot;???????? ?? ???????&quot;! ? ?????? ??? ???????????, ????? ? ???????????? ??????? <a href="$$marbleous_1$$">?????</a>.
 



From andreasl at mail.berlios.de  Sun Aug 31 21:38:33 2008
From: andreasl at mail.berlios.de (andreasl at mail.berlios.de)
Date: Sun, 31 Aug 2008 21:38:33 +0200
Subject: [Enigma-game-svn] r1297 - trunk/doc/reference
Message-ID: <200808311938.m7VJcXg5026977@sheep.berlios.de>

Author: andreasl
Date: 2008-08-31 21:38:31 +0200 (Sun, 31 Aug 2008)
New Revision: 1297

Modified:
   trunk/doc/reference/enigma-ref.texi
Log:
Trunk:
 - Refman: Just typos.


Modified: trunk/doc/reference/enigma-ref.texi
===================================================================
--- trunk/doc/reference/enigma-ref.texi	2008-08-31 13:09:23 UTC (rev 1296)
+++ trunk/doc/reference/enigma-ref.texi	2008-08-31 19:38:31 UTC (rev 1297)
@@ -4717,7 +4717,7 @@
 15    @i{ti}["@var{1}"] = @{"@b{st_panel}", @b{cluster} = @var{1}@}
 16    @i{ti}["@var{2}"] = @{"@b{st_panel}", @b{cluster} = @var{2}@}
 @end example
-The base of the prominent all time different looking @ref{st_panel} boarder 
+The base of the prominent all time different looking @ref{st_panel} border 
 design. Two tiles with panel stones assigned to two different clusters. The
 engine will automatically join all neighboring stones of the same cluster to
 big unified blocks. Now we just need to assign these tiles to the different 
@@ -4726,7 +4726,7 @@
 @example
 17    @i{ti}["@var{S}"] = @{"@b{st_switch}", @b{target} = "@var{easy_mode_call}"@}
 @end example
-The left boarder switch that will just be used in easy mode. It is blocked in
+The left border switch that will just be used in easy mode. It is blocked in
 line 27 to not appear in the regular mode. The target is the callback function
 of lines 71 to 81.
 
@@ -4764,7 +4764,7 @@
 27            or ((@var{key} == "@var{S}") and @i{wo}["@b{IsDifficult}"]) then
 28        return @i{ti}["".. at i{random}(@var{2})]
 @end example
-And now we cluster the boarder panels. First we need to decide where to put
+And now we cluster the border panels. First we need to decide where to put
 panels at all. The positions marked @samp{#} in the map are for sure. 
 Additionally we choose randomly every 4th @samp{_} postition to be a panel 
 instead of being a water floor. Finally we replace just in difficult mode
@@ -9903,13 +9903,13 @@
 
 @item @b{Syntax Samples:}
 @example
-lib.math.cubic_polynomial(@{1, a, b@}, x, y) == a*x + b*y
+lib.math.cubic_polynomial(@{1, a, b@}, x, y) == a*x + b*y + 1
 @end example
 
 @item @b{Details:}
 You can use @samp{lib.math.random_vector(10, ...)} and a modulo operation to
 easily form a random pattern of a floor, or choose the coefficients to your own
-liking. Entries in A which are not numbers are considered zero.
+liking. Entries in @samp{a} which are not numbers are considered zero.
 
 @item @b{Full Example:}
 This is an excerpt from "Wired" and demonstrates the use of
@@ -10332,14 +10332,14 @@
 example:
 @example
 map1 = wo:newMap(" ", @{"####",
-                        "o  #",
-                        "# w#",
-                        "####"@})
+                       "o  #",
+                       "# w#",
+                       "####"@})
 map2 = wo:newMap(".", @{"#######",
-                        "#w.#..#",
-                        "#..D..#",
-                        "#..#.w#",
-                        "#######"@})
+                       "#w.#..#",
+                       "#..D..#",
+                       "#..#.w#",
+                       "#######"@})
 map1 .. map2 == wo:newMap(" ", @{"###########",
                                 "o  ##w.#..#",
                                 "# w##..D..#",



From ral at mail.berlios.de  Sun Aug 31 23:18:12 2008
From: ral at mail.berlios.de (ral at BerliOS)
Date: Sun, 31 Aug 2008 23:18:12 +0200
Subject: [Enigma-game-svn] r1298 - in trunk: data data/schemas src src/items
Message-ID: <200808312118.m7VLICGx005877@sheep.berlios.de>

Author: ral
Date: 2008-08-31 23:18:10 +0200 (Sun, 31 Aug 2008)
New Revision: 1298

Added:
   trunk/src/items/Meditation.cc
   trunk/src/items/Meditation.hh
Modified:
   trunk/data/api1init.lua
   trunk/data/api2init.lua
   trunk/data/models-2d.lua
   trunk/data/schemas/objects.xml
   trunk/src/GridObject.hh
   trunk/src/Makefile.am
   trunk/src/WorldProxy.cc
   trunk/src/items.cc
   trunk/src/items.hh
   trunk/src/ox_extra.cc
   trunk/src/ox_magnum.cc
   trunk/src/ox_oxyd1.cc
   trunk/src/ox_peroxyd.cc
Log:
Trunk 1.1: new API reengineering
- pipe item: fix wrong api 1 mapping of it-pipe-wn
- meditation item:
  - rename it-hollow, it-tinyhollow, it-hill, it-tinyhill to
      it_meditation(_hollow), it_meditation_dent, it_meditation_hill,
      it_meditation_bump
  - fix all known "holes" in registration of meditatin marbles keeping
    the new fast O(1) algorithm
  - keep identity on item "transformation" (just the state changes)
  - add "state" attribute and constants (MEDITATION_HOLLOW,...)
  - prepare new types VOLCANO and CALDERA (just images are missing)
  - refine attribute "essential" - keep it on transformations
- rename global attribute "HoleForce" to "MeditationForce"


Modified: trunk/data/api1init.lua
===================================================================
--- trunk/data/api1init.lua	2008-08-31 19:38:31 UTC (rev 1297)
+++ trunk/data/api1init.lua	2008-08-31 21:18:10 UTC (rev 1298)
@@ -63,6 +63,10 @@
     it_magicwand = "it-magicwand",
     it_magnet = "it-magnet",
     it_magnet_on = "it-magnet-on",
+    it_meditation_hollow = "it-hollow",
+    it_meditation_dent = "it-tinyhollow",
+    it_meditation_bump = "it-tinyhill",
+    it_meditation_hill = "it-hill",
     it_pipe_w = "it-pipe-w",
     it_pipe_s = "it-pipe-s",
     it_pipe_sw = "it-pipe-sw",
@@ -70,7 +74,7 @@
     it_pipe_ew = "it-pipe-h",
     it_pipe_es = "it-pipe-es",
     it_pipe_n = "it-pipe-n",
-    it_pipe_nw = "it-pipe-nw",
+    it_pipe_nw = "it-pipe-wn",
     it_pipe_ns = "it-pipe-v",
     it_pipe_ne = "it-pipe-ne",
     it_magnet_off = "it-magnet-off",

Modified: trunk/data/api2init.lua
===================================================================
--- trunk/data/api2init.lua	2008-08-31 19:38:31 UTC (rev 1297)
+++ trunk/data/api2init.lua	2008-08-31 21:18:10 UTC (rev 1298)
@@ -124,6 +124,14 @@
 INDISPENSIBLE = 1
 PERKIND       = 2
 
+-- meditation
+MEDITATION_CALDERA = -3
+MEDITATION_HOLLOW  = -2
+MEDITATION_DENT    = -1
+MEDITATION_BUMP    =  1
+MEDITATION_HILL    =  2
+MEDITATION_VOLCANO =  3
+
 -- glasses
 SPOT_NOTHING        =   0
 SPOT_DEATH          =   1

Modified: trunk/data/models-2d.lua
===================================================================
--- trunk/data/models-2d.lua	2008-08-31 19:38:31 UTC (rev 1297)
+++ trunk/data/models-2d.lua	2008-08-31 21:18:10 UTC (rev 1298)
@@ -394,14 +394,11 @@
         "it-booze",
         "it-booze-broken",
         "it-cherry",
-        "it-cross",
         "it-document",
         "it-drop",
         "it-dynamite",
         "it-flagblack",
         "it-flagwhite",
-        "it-hill",
-        "it-hollow",
         "it-odometer",
         "it-pencil",
         "it-pin",
@@ -412,8 +409,6 @@
         "it-spring1",
         "it-spring2",
         "it-surprise",
-        "it-tinyhill",
-        "it-tinyhollow",
         "it-weight",
         "it-whitebomb"
     }
@@ -434,6 +429,10 @@
     DefImage("it_key", {filename="it-key"})
     DefImage("it_landmine", {filename="it-landmine"})
     DefImage("it_magicwand", {filename="it-magicwand"})
+    DefImage("it_meditation_hollow", {filename="it-hollow"})
+    DefImage("it_meditation_hill", {filename="it-hill"})
+    DefImage("it_meditation_dent", {filename="it-tinyhollow"})
+    DefImage("it_meditation_bump", {filename="it-tinyhill"})
     DefImage("it_rubberband", {filename="it-rubberband"})
     DefImage("it_sword", {filename="it-sword"})
     DefImage("it_umbrella", {filename="it-umbrella"})

Modified: trunk/data/schemas/objects.xml
===================================================================
--- trunk/data/schemas/objects.xml	2008-08-31 19:38:31 UTC (rev 1297)
+++ trunk/data/schemas/objects.xml	2008-08-31 21:18:10 UTC (rev 1298)
@@ -14,6 +14,7 @@
     <attr name="counterclock" type="bool" default="false" rw="rw"/>
     <attr name="checkerboard" type="int" default="nil" rw="rw"/>
     <attr name="destination" type="tokens" default="nil" rw="rw"/>
+    <attr name="essential" type="int" default="0" min="0" max="2" rw="rw"/>
     <attr name="faces" type="string" default="nil" rw="rw"/>
     <attr name="fellows" type="group" default="nil" rw="r"/>
     <attr name="flavor" type="string" default="b" rw="rw"/>
@@ -72,6 +73,7 @@
     <msg name="open" type="nil"/>
     <msg name="orientate" type="nil"/>
     <msg name="shuffle" type="nil"/>
+    <msg name="shovel" type="nil"/>
     <msg name="signal" type="int" min="0" max="1"/>
     <msg name="toggle" type="nil"/>
     <msg name="turn" type="nil"/>
@@ -170,6 +172,32 @@
     <object name="it_magnet_on">
       <attr name="state" value="1"/>
     </object>
+    <object name="it_meditation">
+      <attr name="state" min="-3" max="3" default="-2"/>
+      <attr name="essential" max="1"/>
+      <msg name="flip"/>
+      <msg name="shovel"/>
+      <msg name="signal"/>
+      <msg name="_init"/>
+    </object>
+    <object name="it_meditation_caldera">
+      <attr name="state" value="-3"/>
+    </object>
+    <object name="it_meditation_hollow">
+      <attr name="state" value="-2"/>
+    </object>
+    <object name="it_meditation_dent">
+      <attr name="state" value="-1"/>
+    </object>
+    <object name="it_meditation_bump">
+      <attr name="state" value="1"/>
+    </object>
+    <object name="it_meditation_hill">
+      <attr name="state" value="2"/>
+    </object>
+    <object name="it_meditation_vulcano">
+      <attr name="state" value="3"/>
+    </object>
     <object name="it_pipe">
       <attr name="connections"/>
       <msg name="_explosion"/>

Modified: trunk/src/GridObject.hh
===================================================================
--- trunk/src/GridObject.hh	2008-08-31 19:38:31 UTC (rev 1297)
+++ trunk/src/GridObject.hh	2008-08-31 21:18:10 UTC (rev 1298)
@@ -95,8 +95,8 @@
 
         // GridObject interface
         
-        virtual void actor_enter (Actor *a) {}
-        virtual void actor_leave (Actor *a) {}
+        virtual void actor_enter(Actor *a) {}
+        virtual void actor_leave(Actor *a) {}
 
 
         void warning(const char *format, ...) const;

Modified: trunk/src/Makefile.am
===================================================================
--- trunk/src/Makefile.am	2008-08-31 19:38:31 UTC (rev 1297)
+++ trunk/src/Makefile.am	2008-08-31 21:18:10 UTC (rev 1298)
@@ -205,6 +205,8 @@
 	items/GlassesItem.hh	\
 	items/Magnet.cc		\
 	items/Magnet.hh		\
+	items/Meditation.cc	\
+	items/Meditation.hh	\
 	items/PipeItem.cc	\
 	items/PipeItem.hh	\
 	items/RubberbandItem.cc	\

Modified: trunk/src/WorldProxy.cc
===================================================================
--- trunk/src/WorldProxy.cc	2008-08-31 19:38:31 UTC (rev 1297)
+++ trunk/src/WorldProxy.cc	2008-08-31 21:18:10 UTC (rev 1298)
@@ -86,7 +86,7 @@
             return server::FlatForce;
         } else if (key == "FrictionFactor") {
             return server::FrictionFactor;
-        } else if (key == "HoleForce") {
+        } else if (key == "MeditationForce") {
             return server::HoleForce;
         } else if (key == "IceFriction") {
             return server::IceFriction;
@@ -172,7 +172,7 @@
             server::FlatForce = val;
         } else if (key == "FrictionFactor") {
             server::FrictionFactor = val;
-        } else if (key == "HoleForce") {
+        } else if (key == "MeditationForce") {
             server::HoleForce = val;
         } else if (key == "IceFriction") {
             server::IceFriction = val;

Added: trunk/src/items/Meditation.cc
===================================================================
--- trunk/src/items/Meditation.cc	2008-08-31 19:38:31 UTC (rev 1297)
+++ trunk/src/items/Meditation.cc	2008-08-31 21:18:10 UTC (rev 1298)
@@ -0,0 +1,256 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *  
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include "items/Meditation.hh"
+
+//#include "main.hh"
+#include "world.hh"
+
+namespace enigma {
+
+    Meditation::Meditation(int initState) {
+        state = initState;
+    }
+    
+    std::string Meditation::getClass() const {
+        return "it_meditation";
+    }
+    
+    void Meditation::setAttr(const string& key, const Value &val) {
+        if (key == "essential") {
+            bool essential = (val == 1);
+            if (essential != (bool)(objFlags & OBJBIT_INDISPENSIBLE)) {
+                if (isDisplayable() /* && state != HILL && state != BUMP */) {
+                    if (whiteball != NULL && enter_time == -1) {   // meditatist is registered
+                        bool indispensable = objFlags & OBJBIT_INDISPENSIBLE;
+                        ChangeMeditation(0, 0, indispensable ? -1 : +1, indispensable ? +1 : -1);
+                    }
+                    ChangeMeditation(0, essential ? +1 : -1 , 0, 0);
+                }
+                objFlags ^= OBJBIT_INDISPENSIBLE;
+            }
+            return;
+        }
+        Item::setAttr(key, val);
+    }
+    
+    Value Meditation::getAttr(const std::string &key) const {
+        if (key == "essential") {
+            return (objFlags & OBJBIT_INDISPENSIBLE) ? 1 : 0;
+        }
+        return Item::getAttr(key);
+    }
+    
+    Value Meditation::message(const Message &m) {
+        if (m.message == "flip") {
+            setState(-state);
+            return Value();
+        } else if (m.message == "signal") {
+            setState(m.value != 0 ? std::abs(state) : -std::abs(state)); 
+            return Value();
+        } else if (m.message == "shovel") {
+            shovel();
+            return Value();
+        } else if (m.message == "_init") {
+            checkActors();
+            return Value();
+        } else
+            return Item::message(m);
+    }
+    
+    int Meditation::minState() const {
+        return CALDERA;
+    }
+    int Meditation::maxState() const {
+        return VOLCANO;
+    }
+    
+    void Meditation::toggleState() {
+        setState(-state);
+    }
+    
+    void Meditation::setState(int extState) {
+        if (extState != state && extState != 0) {
+            if (isDisplayable()) {
+                if (state != HILL && state != BUMP && (extState == HILL || extState == BUMP)) {
+                    // a meditation hole is changed to a hill or bump
+                    if (whiteball != NULL)
+                        deregisterWhiteball();
+//                    if (objFlags & OBJBIT_INDISPENSIBLE)
+//                        ChangeMeditation(0, -1, 0, 0);
+                } else if ((state == HILL || state == BUMP) && extState != HILL && extState != BUMP) {
+                    // hill or bump is made a meditation hole
+                    if (server::WorldInitialized)
+                        checkActors();
+//                    if (objFlags & OBJBIT_INDISPENSIBLE)
+//                        ChangeMeditation(0, +1, 0, 0);
+                }
+                
+                state = extState;
+                init_model();
+            } else
+                state = extState;
+        }
+    }
+        
+    void Meditation::on_creation(GridPos p) {
+        if (/* state != HILL && state != BUMP && */ (objFlags & OBJBIT_INDISPENSIBLE))
+            ChangeMeditation(0, +1, 0, 0);
+        if (server::WorldInitialized)
+            checkActors();
+        Item::on_creation(p);
+    }
+    
+    void Meditation::on_removal(GridPos p) {
+        if (/* state != HILL && state != BUMP && */ (objFlags & OBJBIT_INDISPENSIBLE))
+            ChangeMeditation(0, -1, 0, 0);
+        if (whiteball != NULL)
+            deregisterWhiteball();
+        Item::on_removal(p);
+    }
+    
+    void Meditation::actor_leave(Actor *a) {
+        if (whiteball == a)
+            // meditatist left hollow (warp, ...)
+            deregisterWhiteball();
+    }
+    
+    void Meditation::on_stonehit(Stone *) {
+        shovel();
+    }
+    
+    bool Meditation::actor_hit(Actor *a) {
+        static const double MINTIME = 1.0;
+        ItemID id = get_id(this);
+    
+        if (state != HILL && state != BUMP) {
+            if (whiteball == NULL && !a->is_flying() && get_id(a) == ac_meditation && isMeditating(a)) {
+                // meditatist entered a free hollow
+                whiteball  = a;
+                enter_time = server::LevelTime;
+            } else if (whiteball == a) {
+                if (a->is_flying() || !isMeditating(a)) {
+                    // meditatist left hollow
+                    whiteball = NULL;
+                    if (enter_time == -1) {   // meditatist is registered
+                        bool indispensable = objFlags & OBJBIT_INDISPENSIBLE;
+                        ChangeMeditation(0, 0, indispensable ? -1 : 0, indispensable ? 0 : -1);
+                    }
+                } else  if (enter_time != -1 && (server::LevelTime - enter_time) >= MINTIME) {
+                        // just meditated enough to mark hollow as engaged
+                        bool indispensable = objFlags & OBJBIT_INDISPENSIBLE;
+                        ChangeMeditation(0, 0, indispensable ? +1 : 0, indispensable ? 0 : +1);
+                        enter_time = -1;  // mark as registered
+                }
+            }
+        }
+        return false;  // do not pick up
+    }
+    
+    void Meditation::add_force(Actor *a, V2 &f) {
+        ecl::V2 v = a->get_pos() - get_pos().center();
+        double dist = ecl::length(v);
+    
+        if (dist > (std::abs(state) > 1 ? 0.5 : 0.3))
+            return;
+    
+        if (dist <= 0) { // exactly on hill-top
+            ActorInfo *ai = a->get_actorinfo();
+            if (length(ai->vel) <= 0) { // no velocity
+                // we are never "exactly" on the top!
+                double x = DoubleRand(-0.03, 0.05);
+                double y = DoubleRand(-0.03, 0.05);
+                x = (x < 0.01) ? x - 0.02 : x;
+                y = (y < 0.01) ? y - 0.02 : y;
+                v = ecl::V2(x, y);
+            }
+        }
+    
+        f += (state < 0 ? -1 : 1) * ((std::abs(state) == VOLCANO && dist < 0.3) ? -1 : 1) 
+                * 90 * server::HoleForce * v; // get the force
+    }
+    
+    bool Meditation::isMeditating(Actor *a) {
+        double dist = ecl::length(a->get_pos() - get_pos().center());
+        return (state <= HOLLOW) && dist < 0.4 || (state == DENT || state == VOLCANO) && dist < 0.24;
+    }
+     
+    void Meditation::shovel() {
+        int newState = (state > 0) ? state - 1 : state + 1;
+        if (newState == 0) {
+            // double register indispensible holes as the kill will subtract one essentialness 
+            if (/* state != HILL && state != BUMP && */ (objFlags & OBJBIT_INDISPENSIBLE))
+                ChangeMeditation(0, +1, 0, 0);
+            kill();
+        } else {
+            setState(newState);
+        }
+    }
+    
+    void Meditation::checkActors() {
+        ItemID id = get_id(this);
+        if (state != HILL && state != BUMP) {
+            std::vector<Actor*> actors;
+            GetActorsInsideField(get_pos(), actors);
+            for (std::vector<Actor*>::iterator itr = actors.begin(); itr != actors.end(); ++itr) {
+//                Log << "Hollow - initial meditatist  typ " << get_id(*itr) << "\n";
+                if (!(*itr)->is_flying() &&  whiteball==NULL && get_id(*itr)==ac_meditation && isMeditating(*itr)) {
+                     // meditatist entered a free hollow
+                    whiteball  = *itr;
+                    enter_time = server::LevelTime;
+//                    Log << "Hollow - initial meditatist time " << enter_time << "\n";
+                    break;
+                }
+            }
+        }
+    }
+    
+    void Meditation::deregisterWhiteball() {
+        if (whiteball != NULL && enter_time == -1) {   // meditatist is registered
+            bool indispensable = objFlags & OBJBIT_INDISPENSIBLE;
+            ChangeMeditation(0, 0, indispensable ? -1 : 0, indispensable ? 0 : -1);
+        }
+        whiteball = NULL;
+    }
+    
+    int Meditation::traitsIdx() const {
+        return state < 0 ? state + 3 : state + 2;
+    }
+
+    ItemTraits Meditation::traits[6] = {
+        {"it_meditation_caldera",  it_meditation_caldera,  itf_static | itf_fireproof},
+        {"it_meditation_hollow",  it_meditation_hollow,  itf_static | itf_fireproof},
+        {"it_meditation_dent",  it_meditation_dent,  itf_static | itf_fireproof},
+        {"it_meditation_bump",  it_meditation_bump,  itf_static | itf_fireproof},
+        {"it_meditation_hill",  it_meditation_hill,  itf_static | itf_fireproof},
+        {"it_meditation_vulcano",  it_meditation_vulcano,  itf_static | itf_fireproof},
+    };
+
+    BOOT_REGISTER_START
+        BootRegister(new Meditation(-2), "it_meditation");
+        BootRegister(new Meditation(-3), "it_meditation_caldera");
+        BootRegister(new Meditation(-2), "it_meditation_hollow");
+        BootRegister(new Meditation(-1), "it_meditation_dent");
+        BootRegister(new Meditation(1), "it_meditation_bump");
+        BootRegister(new Meditation(2), "it_meditation_hill");
+        BootRegister(new Meditation(3), "it_meditation_vulcano");
+    BOOT_REGISTER_END
+
+} // namespace enigma


Property changes on: trunk/src/items/Meditation.cc
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/items/Meditation.hh
===================================================================
--- trunk/src/items/Meditation.hh	2008-08-31 19:38:31 UTC (rev 1297)
+++ trunk/src/items/Meditation.hh	2008-08-31 21:18:10 UTC (rev 1298)
@@ -0,0 +1,84 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef MEDITATIONITEM_HH
+#define MEDITATIONITEM_HH
+
+#include "items.hh"
+
+#include "actors.hh"
+#include "stones.hh"
+
+namespace enigma {
+    class Meditation : public Item {
+        CLONEOBJ(Meditation);
+        DECL_ITEMTRAITS_ARRAY(6, traitsIdx());
+
+        enum iState {
+            CALDERA = -3,     ///< a large deepening with a small hill in the middle
+            HOLLOW  = -2,     ///< a large deepening
+            DENT    = -1,     ///< a small deepening
+            BUMP    =  1,     ///< a small elevation
+            HILL    =  2,     ///< a large elevation
+            VOLCANO =  3      ///< a large elevation with a small dent in the middle
+        };
+
+        enum ObjectPrivatFlagsBits {
+            OBJBIT_INDISPENSIBLE =   1<<24,   ///< 
+        };
+    public:                
+        Meditation(int initState);
+        
+        // Object interface
+        virtual std::string getClass() const;
+        virtual void setAttr(const string& key, const Value &val);
+        virtual Value getAttr(const std::string &key) const;
+        virtual Value message(const Message &m);
+
+        // StateObject interface
+        virtual int minState() const;
+        virtual int maxState() const;
+        virtual void toggleState();
+        virtual void setState(int extState);
+        
+        // GridObject interface
+        virtual void on_creation(GridPos p);
+        virtual void on_removal(GridPos p);
+        virtual void actor_leave(Actor *a);
+        
+        // Items interface
+        virtual void on_stonehit(Stone *st);
+        virtual bool actor_hit(Actor *a);
+        virtual void add_force(Actor *a, ecl::V2 &f);
+        
+    private:
+        // Variables.
+        Actor *whiteball;   // The small white ball that is currently being tracked
+        double enter_time;  // ... when did it enter the hollow?
+
+        bool isMeditating(Actor *a);
+        void shovel();
+        void checkActors();
+        void deregisterWhiteball();
+        int traitsIdx() const;
+    };
+    
+} // namespace enigma
+
+#endif


Property changes on: trunk/src/items/Meditation.hh
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/src/items.cc
===================================================================
--- trunk/src/items.cc	2008-08-31 19:38:31 UTC (rev 1297)
+++ trunk/src/items.cc	2008-08-31 21:18:10 UTC (rev 1298)
@@ -699,278 +699,6 @@
         {"it_coin_l",  it_coin4,  itf_none, 0.0},
     };
     
-
-
-/* -------------------- Hills and Hollows -------------------- */
-
-/** \page it-hills Hills and Hollows
-
-Hills and hollows are placed on the floor and can
-make the movement difficult.
-
-\subsection hillsm Messages
-- \b trigger	will convert a hill to a hollow and vice versa
-- \b shovel     decreases the size of the hill/hollow
-
-\image html it-hill.png
-*/
-namespace
-{
-    class HillHollow : public Item {
-    public:
-        // Object interface.
-        virtual Value message(const Message &m);
-    protected:
-        enum Type { HILL, HOLLOW, TINYHILL, TINYHOLLOW };
-
-        HillHollow(Type t);
-
-        void transmute(Type newtype);
-        V2 vec_to_center (V2 v);
-        double get_radius() const { return m_radius[m_type]; }
-
-        Type get_type() const { return m_type; }
-
-    private:
-        double get_forcefac() const {
-            return m_forcefac[m_type] * server::HoleForce;
-        }
-        void shovel();
-
-        // Item interface
-        void add_force(Actor *a, V2 &f);
-        void on_stonehit(Stone *st);
-
-
-        // Variables.
-        static double m_radius[4], m_forcefac[4];
-        Type m_type;
-    };
-
-    class Hill : public HillHollow {
-        CLONEOBJ(Hill);
-        DECL_ITEMTRAITS;
-    public:
-        Hill() : HillHollow(HILL) {}
-    };
-    DEF_ITEMTRAITSF(Hill, "it-hill", it_hill, itf_static | itf_fireproof);
-
-    class TinyHill : public HillHollow {
-        CLONEOBJ(TinyHill);
-        DECL_ITEMTRAITS;
-    public:
-        TinyHill() : HillHollow(TINYHILL) {}
-    };
-    DEF_ITEMTRAITSF(TinyHill, "it-tinyhill", it_tinyhill, itf_static | itf_fireproof);
-
-    /*
-     * Hollows are special in that they can end the current level
-     * if they have each a small white marble inside them.
-     */
-    class Hollow : public HillHollow {
-        CLONEOBJ(Hollow);
-        DECL_ITEMTRAITS;
-    public:
-        Hollow(Type t = HOLLOW);
-        // Object interface.
-        virtual Value message(const Message &m);
-        virtual void on_creation(GridPos p);
-        virtual void on_removal(GridPos p);
-    protected:
-        virtual void setup_successor(Item *newitem);
-    private:
-        // Item interface.
-        bool actor_hit(Actor *a);
-        void actor_leave(Actor *a);
-
-        // Functions.
-        bool near_center_p (Actor *a);
-
-        // Variables.
-        Actor *whiteball;   // The small white ball that is currently being tracked
-        double enter_time;  // ... when did it enter the hollow?
-    };
-    DEF_ITEMTRAITSF(Hollow, "it-hollow", it_hollow, itf_static | itf_fireproof);
-
-
-    class TinyHollow : public Hollow {
-        CLONEOBJ(TinyHollow);
-        DECL_ITEMTRAITS;
-    public:
-        TinyHollow() : Hollow(TINYHOLLOW) {}
-    };
-    DEF_ITEMTRAITSF(TinyHollow, "it-tinyhollow", it_tinyhollow, itf_static | itf_fireproof);
-
-}
-
-
-/* ---------- HillHollow ---------- */
-
-double HillHollow::m_radius[4] = {0.5, 0.5, 0.3, 0.3};
-double HillHollow::m_forcefac[4] = {90,-90, 90, -90};
-
-
-HillHollow::HillHollow (Type t)
-: m_type(t)
-{}
-
-void HillHollow::on_stonehit(Stone *)
-{
-    shovel();
-}
-
-void HillHollow::shovel() {
-    switch (get_id (this)) {
-    case it_hollow: transmute (TINYHOLLOW); break;
-    case it_hill:   transmute (TINYHILL); break;
-    default:        kill(); break;
-    }
-}
-
-Value HillHollow::message(const Message &m)
-{
-    if (m.message == "flip") {
-        Type flippedkind[] = {HOLLOW,HILL, TINYHOLLOW,TINYHILL};
-        transmute(flippedkind[m_type]);
-        return Value();
-    } else if (m.message == "signal") {
-        if (m.value != 0) {
-            Type flippedkind[] = {HILL,HILL, TINYHILL,TINYHILL};
-            transmute(flippedkind[m_type]);
-        } else {
-            Type flippedkind[] = {HOLLOW,HOLLOW, TINYHOLLOW,TINYHOLLOW};
-            transmute(flippedkind[m_type]);
-        }
-        return Value();
-    } else if (m.message == "shovel") {
-        shovel();
-        return Value();
-    } 
-    return Item::message(m);
-}
-
-V2 HillHollow::vec_to_center (V2 v)
-{
-    return v-get_pos().center();
-}
-
-void HillHollow::add_force(Actor *a, V2 &f)
-{
-    V2     v    = vec_to_center(a->get_pos());
-    double dist = length(v);
-
-    if (dist > get_radius())
-        return;
-
-    if (dist <= 0) { // exactly on hill-top
-        ActorInfo *ai = a->get_actorinfo();
-        if (length(ai->vel) <= 0) { // no velocity
-            // we are never "exactly" on the top!
-            v = ecl::V2(DoubleRand(0.01, 0.05), DoubleRand(0.01, 0.05));
-        }
-    }
-
-    f += get_forcefac()*v; // get the force
-}
-
-void HillHollow::transmute(Type newtype)
-{
-    static char *newmodel[] = { "it-hill", "it-hollow", "it-tinyhill", "it-tinyhollow" };
-    replace(newmodel[newtype]);
-}
-
-
-/* ---------- Hollow ---------- */
-
-// TODO handle set of essential attribute
-
-Hollow::Hollow(Type t) : HillHollow(t), whiteball(0), enter_time (-1) {
-}
-
-Value Hollow::message(const Message &m) {
-    Log << "Hollow - init time " << server::LevelTime << "\n";
-    if (m.message == "_init") {
-        vector<Actor*> actors;
-        GetActorsInsideField(get_pos(), actors);
-        for (vector<Actor*>::iterator it = actors.begin(); it != actors.end(); ++it) {
-            Log << "Hollow - initial meditatist  typ " << get_id(*it) << "\n";
-            if (!(*it)->is_flying() &&  whiteball==NULL && get_id(*it)==ac_meditation && near_center_p(*it)) {
-                 // meditatist entered a free hollow
-                whiteball  = *it;
-                enter_time = server::LevelTime;
-                Log << "Hollow - initial meditatist time " << enter_time << "\n";
-                break;
-            }
-        }
-        return Value();
-    }
-    return HillHollow::message(m);
-}
-
-void Hollow::on_creation(GridPos p) {
-    if (getDefaultedAttr("essential", 0) == 1)
-        ChangeMeditation(0, +1, 0, 0);
-    HillHollow::on_creation(p);
-}
-
-void Hollow::on_removal(GridPos p) {   //TODO a change from Hollow to TinyHollow is critical -> single class with state reengineering
-    if (getDefaultedAttr("essential", 0) == 1)
-        ChangeMeditation(0, -1, 0, 0);
-    HillHollow::on_removal(p);
-}
-
-bool Hollow::near_center_p (Actor *a)
-{
-    return (length(vec_to_center(a->get_pos())) < get_radius()*0.8);
-}
-
-bool Hollow::actor_hit(Actor *a)
-{
-    const double MINTIME = 1.0;
-    ItemID id = get_id (this);
-
-    if (id == it_hollow || id == it_tinyhollow) {
-        if (whiteball==NULL && get_id(a)==ac_meditation && near_center_p(a)) {
-            // meditatist entered a free hollow
-            whiteball  = a;
-            enter_time = server::LevelTime;
-        } else if (whiteball == a) {
-            if (!near_center_p(a)) {
-                // meditatist left hollow
-                whiteball = NULL;
-                if (enter_time == -1) {   // meditatist is registered
-                    bool indispensable = (getDefaultedAttr("essential", 0) == 1);
-                    ChangeMeditation(0, 0, indispensable ? -1 : 0, indispensable ? 0 : -1);
-                }
-            } else  if (enter_time != -1 && (server::LevelTime - enter_time) >= MINTIME) {
-                    // just meditated enough to mark hollow as engaged
-                    bool indispensable = (getDefaultedAttr("essential", 0) == 1);
-                    ChangeMeditation(0, 0, indispensable ? +1 : 0, indispensable ? 0 : +1);
-                    enter_time = -1;  // mark as registered
-            }
-        }
-    }
-
-    return false;
-}
-
-void Hollow::actor_leave(Actor *a) {
-    if (whiteball == a) {
-        // meditatist left hollow (warp, ...)
-        whiteball = NULL;
-        if (enter_time == -1) {   // meditatist is registered
-            bool indispensable = (getDefaultedAttr("essential", 0) == 1);
-            ChangeMeditation(0, 0, indispensable ? -1 : 0, indispensable ? 0 : -1);
-        }
-    }
-}
-
-
-void Hollow::setup_successor(Item *newitem) {
-    newitem->setAttr("essential", getAttr("essential"));
-}
-
-
 /* -------------------- Springs -------------------- */
 
 /** \page it-spring Spring
@@ -1087,7 +815,7 @@
         void animcb() {
             if (Floor *fl = GetFloor(get_pos()))
                 if (fl->is_destructible())
-                    replace("it-hollow");
+                    replace("it_meditation_hollow");
                 else
                     kill();
         }
@@ -2567,8 +2295,6 @@
     RegisterItem (new Floppy);
     RegisterItem (new Hammer(false));
     Register ("it_hammer_new", new Hammer(true));
-    RegisterItem (new Hill);
-    RegisterItem (new Hollow);
     RegisterItem (new Trap);
     RegisterItem (new Key);
     RegisterItem (new Landmine);
@@ -2590,8 +2316,6 @@
     RegisterItem (new SurpriseItem);
     RegisterItem (new Sword(false));
     Register ("it_sword_new", new Sword(true));
-    RegisterItem (new TinyHill);
-    RegisterItem (new TinyHollow);
     RegisterItem (new TwoPKillStone);
     RegisterItem (new Umbrella(false));
     Register ("it_umbrella_new", new Umbrella(true));

Modified: trunk/src/items.hh
===================================================================
--- trunk/src/items.hh	2008-08-31 19:38:31 UTC (rev 1297)
+++ trunk/src/items.hh	2008-08-31 21:18:10 UTC (rev 1298)
@@ -88,6 +88,12 @@
         it_magicwand,
         it_magnet_off,
         it_magnet_on,
+        it_meditation_caldera,
+        it_meditation_hollow,
+        it_meditation_dent,
+        it_meditation_bump,
+        it_meditation_hill,
+        it_meditation_vulcano,
         it_odometer,
         it_pencil,
         it_pin,

Modified: trunk/src/ox_extra.cc
===================================================================
--- trunk/src/ox_extra.cc	2008-08-31 19:38:31 UTC (rev 1297)
+++ trunk/src/ox_extra.cc	2008-08-31 21:18:10 UTC (rev 1298)
@@ -355,11 +355,11 @@
     UNUSED,                  // OxydExtra item 0x2c
     "it_vortex_open",             // OxydExtra item 0x2d
     UNUSED,                  // OxydExtra item 0x2e
-    "it_wormhole_on",             // OxydExtra item 0x2f
-    "it-hill",                    // OxydExtra item 0x30
-    "it-tinyhill",                // OxydExtra item 0x31
-    "it-hollow",                  // OxydExtra item 0x32
-    "it-tinyhollow",              // OxydExtra item 0x33
+    "it_wormhole_on",        // OxydExtra item 0x2f
+    "it_meditation_hill",    // OxydExtra item 0x30
+    "it_meditation_bump",    // OxydExtra item 0x31
+    "it_meditation_hollow",  // OxydExtra item 0x32
+    "it_meditation_dent",    // OxydExtra item 0x33
     UNUSED,                  // OxydExtra item 0x34
     UNUSED,                  // OxydExtra item 0x35
     UNUSED,                  // OxydExtra item 0x36

Modified: trunk/src/ox_magnum.cc
===================================================================
--- trunk/src/ox_magnum.cc	2008-08-31 19:38:31 UTC (rev 1297)
+++ trunk/src/ox_magnum.cc	2008-08-31 21:18:10 UTC (rev 1298)
@@ -338,10 +338,10 @@
     "it_vortex_open",   // OxydMagnum item 0x2d
     "it_vortex_closed", // OxydMagnum item 0x2e
     "it_wormhole_on",   // OxydMagnum item 0x2f
-    "it-hill",          // OxydMagnum item 0x30
-    "it-tinyhill",      // OxydMagnum item 0x31
-    "it-hollow",        // OxydMagnum item 0x32
-    "it-tinyhollow",    // OxydMagnum item 0x33
+    "it_meditation_hill",   // OxydMagnum item 0x30
+    "it_meditation_bump",   // OxydMagnum item 0x31
+    "it_meditation_hollow", // OxydMagnum item 0x32
+    "it_meditation_dent",   // OxydMagnum item 0x33
     "it_strip_ns",      // OxydMagnum item 0x34
     "it_strip_ew",      // OxydMagnum item 0x35
     "it-springboard",   // OxydMagnum item 0x36

Modified: trunk/src/ox_oxyd1.cc
===================================================================
--- trunk/src/ox_oxyd1.cc	2008-08-31 19:38:31 UTC (rev 1297)
+++ trunk/src/ox_oxyd1.cc	2008-08-31 21:18:10 UTC (rev 1298)
@@ -354,10 +354,10 @@
     "it_vortex_open",             // 0x2d
     "it_vortex_closed",           // 0x2e
     "it_wormhole_on",             // 0x2f
-    "it-hill",                    // 0x30
-    "it-tinyhill",                // 0x31
-    "it-hollow",                  // 0x32
-    "it-tinyhollow",              // 0x33
+    "it_meditation_hill",         // 0x30
+    "it_meditation_bump",         // 0x31
+    "it_meditation_hollow",       // 0x32
+    "it_meditation_dent",         // 0x33
     "it_strip_ns",                // 0x34
     "it_strip_ew",                // 0x35
     "it-springboard",             // 0x36

Modified: trunk/src/ox_peroxyd.cc
===================================================================
--- trunk/src/ox_peroxyd.cc	2008-08-31 19:38:31 UTC (rev 1297)
+++ trunk/src/ox_peroxyd.cc	2008-08-31 21:18:10 UTC (rev 1298)
@@ -427,10 +427,10 @@
     "it_vortex_open",             // 0x2d
     "it_vortex_closed",           // 0x2e
     "it_wormhole_on",             // 0x2f XXX
-    "it-hill",                    // 0x30
-    "it-tinyhill",                // 0x31
-    "it-hollow",                  // 0x32
-    "it-tinyhollow",              // 0x33
+    "it_meditation_hill",         // 0x30
+    "it_meditation_bump",         // 0x31
+    "it_meditation_hollow",       // 0x32
+    "it_meditation_dent",         // 0x33
     "it_strip_ns",                // 0x34
     "it_strip_ew",                // 0x35
     "it-springboard",             // 0x36



