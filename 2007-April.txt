From ral at mail.berlios.de  Wed Apr  4 01:00:30 2007
From: ral at mail.berlios.de (ral at BerliOS)
Date: Wed, 4 Apr 2007 01:00:30 +0200
Subject: [Enigma-game-svn] r676 - in branches/1.0: data lib-src/enigma-core
	src/gui src/lev
Message-ID: <200704032300.l33N0Upl029620@sheep.berlios.de>

Author: ral
Date: 2007-04-04 01:00:17 +0200 (Wed, 04 Apr 2007)
New Revision: 676

Modified:
   branches/1.0/data/models-32.lua
   branches/1.0/data/models-40.lua
   branches/1.0/data/models-48.lua
   branches/1.0/lib-src/enigma-core/ecl_font.cc
   branches/1.0/lib-src/enigma-core/ecl_font.hh
   branches/1.0/lib-src/enigma-core/ecl_utf.cc
   branches/1.0/lib-src/enigma-core/ecl_utf.hh
   branches/1.0/src/gui/LevelWidget.cc
   branches/1.0/src/lev/Proxy.cc
Log:
Branch 1.0: fix various problems with Umlauts in level titles
- handle utf-8 for bitmap fonts
- use alternate ttf font for characters not available in bitmap fonts
- optimize title placing in LevelWidget
- ensure that titles never overwrite each other
- ensure that long titles are truncated only at the end


Modified: branches/1.0/data/models-32.lua
===================================================================
--- branches/1.0/data/models-32.lua	2007-03-30 23:17:51 UTC (rev 675)
+++ branches/1.0/data/models-32.lua	2007-04-03 23:00:17 UTC (rev 676)
@@ -2,6 +2,7 @@
 SpriteSize = 40
 ShadowSize = 41
 DefineFont ("timefont", "vera_sans.ttf", 36, "timefont", 180, 180, 180)
+DefineFont ("smallalternative", "DejaVuSansCondensed.ttf", 14, "menufont")
 DefineFont ("menufont", "DejaVuSansCondensed.ttf", 16, "menufont")
 DefineFont ("menufontsel", "DejaVuSansCondensed.ttf", 16, "menufont", 180, 180, 180)
 DefineFont ("statusbarfont", "DejaVuSansCondensed.ttf", 18, "dreamorp24")

Modified: branches/1.0/data/models-40.lua
===================================================================
--- branches/1.0/data/models-40.lua	2007-03-30 23:17:51 UTC (rev 675)
+++ branches/1.0/data/models-40.lua	2007-04-03 23:00:17 UTC (rev 676)
@@ -3,6 +3,7 @@
 ShadowSize = 51
 
 DefineFont ("timefont", "vera_sans.ttf", 36, "timefont", 180, 180, 180)
+DefineFont ("smallalternative", "DejaVuSansCondensed.ttf", 14, "menufont")
 DefineFont ("menufont", "DejaVuSansCondensed.ttf", 16, "menufont")
 DefineFont ("menufontsel", "DejaVuSansCondensed.ttf", 16, "menufont", 180, 180, 180)
 DefineFont ("statusbarfont", "DejaVuSansCondensed.ttf", 20, "dreamorp24")

Modified: branches/1.0/data/models-48.lua
===================================================================
--- branches/1.0/data/models-48.lua	2007-03-30 23:17:51 UTC (rev 675)
+++ branches/1.0/data/models-48.lua	2007-04-03 23:00:17 UTC (rev 676)
@@ -3,6 +3,7 @@
 ShadowSize = 61
 
 DefineFont ("timefont", "vera_sans.ttf", 40, "timefont", 180, 180, 180)
+DefineFont ("smallalternative", "DejaVuSansCondensed.ttf", 14, "menufont")
 DefineFont ("menufont", "DejaVuSansCondensed.ttf", 16, "menufont")
 DefineFont ("menufontsel", "DejaVuSansCondensed.ttf", 16, "menufont", 180, 180, 180)
 DefineFont ("statusbarfont", "DejaVuSansCondensed.ttf", 24, "dreamorp24")

Modified: branches/1.0/lib-src/enigma-core/ecl_font.cc
===================================================================
--- branches/1.0/lib-src/enigma-core/ecl_font.cc	2007-03-30 23:17:51 UTC (rev 675)
+++ branches/1.0/lib-src/enigma-core/ecl_font.cc	2007-04-03 23:00:17 UTC (rev 676)
@@ -1,5 +1,6 @@
 /*
  * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2006,2007      Ronald Lamprecht
  *
  * This program is free software; you can redistribute it and/or
  * modify it under the terms of the GNU General Public License
@@ -18,26 +19,26 @@
  */
 #include "ecl_font.hh"
 #include "ecl_geom.hh"
+#include "ecl_utf.hh"
 #include "ecl_video.hh"
 #include <vector>
 #include <string>
 #include <memory>               // for auto_ptr
 #include <stdio.h>
+#include <cstdlib>
+#include <ostream>
+#include <iostream>
 
 #include <config.h>
 
 using namespace ecl;
 using namespace std;
 
-int Font::get_width(const char *str) 
-{
-    int w=0;
-    for (const char *p = str; *p; ++p)
-	w += get_width(*p);
-    return w;
+void Font::render(const GC &gc, int x, int y, std::string text,
+        Font * altFont, int maxwidth) {
+    render(gc, x, y, text.c_str());
 }
 
-
 std::string::size_type 
 ecl::breakString (Font *font,
                   const std::string &str,
@@ -76,19 +77,22 @@
     class InvalidFont {};
 
     class BitmapFont : public Font {
-	vector<Rect>	char_rects;
-	vector<int>	advance;
-	Surface		*surface;
+        vector<Rect>    char_rects;
+        vector<int>     advance;
+        Surface         *surface;
     public:
-	BitmapFont(Surface *s, const char *descr);
-	~BitmapFont() { delete surface; }
+        BitmapFont(Surface *s, const char *descr);
+        ~BitmapFont() { delete surface; }
 
-	int get_lineskip() { return surface->height() + 3; }
-	int get_width(char c);
-	int get_height();
+        int get_lineskip() { return surface->height() + 3; }
+        int get_width(char c);
+        virtual int get_width(const char *str, Font * altFont = NULL);
+        int get_height();
 
-	Surface *render(const char *str);
-        void render(const GC &gc, int x, int y, const char *str);
+        virtual Surface *render(const char *str);
+        virtual void render(const GC &gc, int x, int y, const char *str);
+        virtual void render(const GC &gc, int x, int y, std::string text,
+                Font * altFont = NULL, int maxwidth = -1);
     };
 }
 
@@ -110,6 +114,8 @@
         char_rects[c].y = 0;
         char_rects[c].h = s->height();
         advance[c] = adv;
+        if (adv = 0)
+            std::cout << "BitFont 0\n";
     }
 }
 
@@ -117,29 +123,77 @@
     return advance[int(c)];
 }
 
+int BitmapFont::get_width(const char *str, Font * altFont) {
+    int width = 0;
+    for (const char *p=str; *p; ++p) {
+        // utf-8 char handling
+        int len = utf8NextCharSize(p); // num of bytes that represents one real character 
+        if (len == 0) {
+            // a spurious follow up byte
+            continue;
+        }
+                     
+        if (len > 1 || advance[int(*p)] == 0) {
+            if (altFont != NULL) {
+                std::string utf8char(p, len);
+                width += altFont->get_width(utf8char.c_str());
+            }
+            p += len - 1;
+        } else {
+            width += get_width(*p);
+        }
+    }
+    return width;
+}
+
 int BitmapFont::get_height() {
     return surface->height();
 }
 
-Surface *
-BitmapFont::render(const char *str)
-{
-    Surface *s = MakeSurface(Font::get_width(str), get_height(), 16);
+Surface * BitmapFont::render(const char *str) {
+    Surface *s = MakeSurface(get_width(str), get_height(), 16);
     s->set_color_key(0,0,0);
     render (GC(s), 0, 0, str);
     return s;
 }
 
-void
-BitmapFont::render(const GC &gc, int x, int y, const char *str)
-{
-    for (const char *p=str; *p; ++p) {
-        blit(gc, x, y, surface, char_rects[int(*p)]);
-        x += get_width(*p);
+void BitmapFont::render(const GC &gc, int x, int y, const char *str) {
+    render(gc, x, y, std::string(str));
+}
+
+void BitmapFont::render(const GC &gc, int x, int y, std::string text,
+        Font * altFont, int maxwidth) {
+    int width = 0;
+    for (const char *p=text.c_str(); *p; ++p) {
+        // utf-8 char handling
+        int len = utf8NextCharSize(p); // num of bytes that represents one real character 
+        if (len == 0) {
+            // a spurious follow up byte
+            continue;
+        }
+                     
+        if (len > 1 || advance[int(*p)] == 0) {
+            if (altFont != NULL) {
+                std::string utf8char(p, len);
+                int charWidth = altFont->get_width(utf8char.c_str());
+                width += charWidth;
+                if (maxwidth <= 0 || width < maxwidth) {
+                   altFont->render(gc, x, y, utf8char.c_str());
+                    x += altFont->get_width(utf8char.c_str());
+                }
+            }
+            p += len - 1;
+        } else {
+            int charWidth = get_width(*p);
+            width += charWidth;
+            if (maxwidth <= 0 || width < maxwidth) {
+                blit(gc, x, y, surface, char_rects[int(*p)]);
+                x += charWidth;
+            }
+        }
     }
 }
 
-
 Font *
 ecl::LoadBitmapFont(const char * imgname, const char * descrname)
 {
@@ -167,8 +221,8 @@
 namespace
 {
     class TrueTypeFont : public Font {
-    	// Variables
-	TTF_Font *font;
+        // Variables
+        TTF_Font *font;
         SDL_Color fgcolor;
 
 
@@ -176,18 +230,18 @@
         TrueTypeFont (const TrueTypeFont &);
         TrueTypeFont &operator= (const TrueTypeFont &);
     public:
-    	TrueTypeFont (TTF_Font *font_, int r, int g, int b);
-	
-	~TrueTypeFont();
-	
-    	// Font interface
-	int get_lineskip();
-	int get_height();
-	int get_width (char c);
-        int get_width (const char *str);
+        TrueTypeFont (TTF_Font *font_, int r, int g, int b);
+        
+        ~TrueTypeFont();
+        
+        // Font interface
+        int get_lineskip();
+        int get_height();
+        int get_width (char c);
+        virtual int get_width(const char *str, Font * altFont = NULL);
 
-	Surface *render (const char *str);
-	void     render (const GC &gc, int x, int y, const char *str);
+        Surface *render (const char *str);
+        void     render (const GC &gc, int x, int y, const char *str);
     };
 }
 
@@ -198,7 +252,7 @@
     fgcolor.g = g;
     fgcolor.b = b;
 }
-	
+        
 TrueTypeFont::~TrueTypeFont()
 {
     TTF_CloseFont (font);
@@ -211,7 +265,7 @@
 int TrueTypeFont::get_height() { 
     return TTF_FontHeight(font); 
 }
-	
+        
 int TrueTypeFont::get_width(char c) {
     int minx, maxx, miny, maxy, advance;
     TTF_GlyphMetrics(font, c, &minx, &maxx, &miny, &maxy, &advance);
@@ -239,7 +293,7 @@
         blit (gc, x, y, s.get());
 }
 
-int TrueTypeFont::get_width(const char *str) 
+int TrueTypeFont::get_width(const char *str, Font * altFont) 
 {
     int w,h;
     TTF_SizeUTF8 (font, str, &w, &h);
@@ -249,7 +303,7 @@
 Font *ecl::LoadTTF (const char *filename, int ptsize, int r, int g, int b)
 {
     if (TTF_Init()) {
-    	// Error initializing TTF engine
+        // Error initializing TTF engine
     }
     TTF_Font *font = TTF_OpenFont (filename, ptsize);
     return (font) ? new TrueTypeFont (font, r, g, b) : 0;

Modified: branches/1.0/lib-src/enigma-core/ecl_font.hh
===================================================================
--- branches/1.0/lib-src/enigma-core/ecl_font.hh	2007-03-30 23:17:51 UTC (rev 675)
+++ branches/1.0/lib-src/enigma-core/ecl_font.hh	2007-04-03 23:00:17 UTC (rev 676)
@@ -1,5 +1,6 @@
 /*
  * Copyright (C) 2002,2004 Daniel Heck
+ * Copyright (C) 2006,2007 Ronald Lamprecht
  *
  * This program is free software; you can redistribute it and/or
  * modify it under the terms of the GNU General Public License
@@ -27,18 +28,18 @@
 
     class Font {
     public:
-	virtual ~Font() {}
+        virtual ~Font() {}
 
         virtual int get_lineskip() =0;
-	virtual int get_height() = 0;
+        virtual int get_height() = 0;
 
-	virtual int get_width(char c) = 0;
-	virtual int get_width(const char *str);
+        virtual int get_width(char c) = 0;   // depreceated ! not utf-8 compatible!
+        virtual int get_width(const char *str, Font * altFont = NULL) = 0;
 
-	virtual Surface *render(const char *str) = 0;
-        virtual void render(const GC &gc, int x, int y, 
-                            const char *str) = 0;
-        
+        virtual Surface *render(const char *str) = 0;
+        virtual void render(const GC &gc, int x, int y, const char *str) = 0;
+        virtual void render(const GC &gc, int x, int y, std::string text,
+                Font * altFont = NULL, int maxwidth = -1);
     };
 
     std::string::size_type breakString(Font *font,
@@ -51,7 +52,7 @@
       DESCRNAME. */
     Font *LoadBitmapFont(const char * filename,
                          const char * descrname);
-			
+
     /** Load a TrueType font from FILENAME with size PTSIZE. */ 
     Font *LoadTTF (const char *filename, int ptsize, int r=0xff, int g=0xff, int b=0xff);
 

Modified: branches/1.0/lib-src/enigma-core/ecl_utf.cc
===================================================================
--- branches/1.0/lib-src/enigma-core/ecl_utf.cc	2007-03-30 23:17:51 UTC (rev 675)
+++ branches/1.0/lib-src/enigma-core/ecl_utf.cc	2007-04-03 23:00:17 UTC (rev 676)
@@ -27,7 +27,7 @@
  *
  * The modifications and additions have the following copyright
  *
- * Copyright (C) 2005 Ronald Lamprecht
+ * Copyright (C) 2005, 2007 Ronald Lamprecht
  *
  * This program is free software; you can redistribute it and/or
  * modify it under the terms of the GNU General Public License
@@ -180,4 +180,20 @@
             i += charSize;
         }
     }
+    
+    int utf8NextCharSize(const std::string &utf8String) {
+        unsigned char c = utf8String[0];
+        int len = 1; // num of bytes that represents one real character 
+        if ((c & 0xC0) == 0x80) {
+            // a spurious follow up byte
+            len = 0;
+        } else if ((c & 0xE0) == 0xC0) {
+            len = 2;
+        } else if ((c & 0xF0) == 0xE0) {
+            len = 3;
+        } else if ((c & 0xF8) == 0xF0) {
+            len = 4;
+        }
+        return len;
+    }
 } //namespace ecl

Modified: branches/1.0/lib-src/enigma-core/ecl_utf.hh
===================================================================
--- branches/1.0/lib-src/enigma-core/ecl_utf.hh	2007-03-30 23:17:51 UTC (rev 675)
+++ branches/1.0/lib-src/enigma-core/ecl_utf.hh	2007-04-03 23:00:17 UTC (rev 676)
@@ -26,7 +26,7 @@
  * ---------------------------------------------------------------------
  * The modifications and additions have the following copyright
  *
- * Copyright (C) 2005 Ronald Lamprecht
+ * Copyright (C) 2005, 2007 Ronald Lamprecht
  *
  * This program is free software; you can redistribute it and/or
  * modify it under the terms of the GNU General Public License
@@ -82,4 +82,5 @@
 		
 
     void utf8CharSizes(const std::string &utf8String, std::vector<unsigned char> &sizes);
+    int  utf8NextCharSize(const std::string &utf8String);
 } //namespace ecl

Modified: branches/1.0/src/gui/LevelWidget.cc
===================================================================
--- branches/1.0/src/gui/LevelWidget.cc	2007-03-30 23:17:51 UTC (rev 675)
+++ branches/1.0/src/gui/LevelWidget.cc	2007-04-03 23:00:17 UTC (rev 676)
@@ -1,5 +1,6 @@
 /*
  * Copyright (C) 2002,2003,2004,2005,2006 Daniel Heck
+ * Copyright (C) 2006,2007                Ronald Lamprecht
  *
  * This program is free software; you can redistribute it and/or
  * modify it under the terms of the GNU General Public License
@@ -292,7 +293,7 @@
         const int imgw = vminfo.thumbw;       // Size of the preview images
         const int imgh = vminfo.thumbh;
     
-        const int hgap = Max(0, (get_w() - width*buttonw) / (width-1));
+        const int hgap = Max(0, (get_w() - width*buttonw) / (width));
         const int vgap = Max(0, (get_h() - height*buttonh)/ (height-1));
     
         unsigned i=ifirst;          // level index
@@ -305,7 +306,7 @@
                 if (i >= curIndex->size())
                     goto done_painting;
     
-                int xpos = get_x() + x*(buttonw + hgap);
+                int xpos = get_x() + hgap/2 + x*(buttonw + hgap);
                 int ypos = get_y() + y*(buttonh + vgap);
     
                 Rect buttonarea(xpos, ypos, buttonw, buttonh);
@@ -344,11 +345,12 @@
                 }
                 // Draw level name
                 Font    *smallfnt = enigma::GetFont("levelmenu");
-                const char *caption = levelProxy->getTitle().c_str();
+                Font    *altsmallfnt = enigma::GetFont("smallalternative");;
+                std::string caption = levelProxy->getTitle();
                 smallfnt->render (gc,
-                                  xpos + (buttonw-smallfnt->get_width(caption))/2,
-                                  imgy + imgh,
-                                  caption);
+                          xpos + buttonw/2 - ecl::Min(smallfnt->get_width(caption.c_str(), altsmallfnt)/2, (buttonw+hgap)/2),
+                          imgy + imgh + 2,
+                          caption, altsmallfnt, buttonw + hgap);
             }
         }
         done_painting:

Modified: branches/1.0/src/lev/Proxy.cc
===================================================================
--- branches/1.0/src/lev/Proxy.cc	2007-03-30 23:17:51 UTC (rev 675)
+++ branches/1.0/src/lev/Proxy.cc	2007-04-03 23:00:17 UTC (rev 676)
@@ -172,7 +172,7 @@
             theProxy = NULL;
         } else {
             // eliminate duplicates and register
-//            Log << "autoRegisterLevel register '" << indexPath << "/"<< filename << "\n";
+//            Log << "autoRegisterLevel register '" << indexPath << "/"<< filename << " Title: " << theProxy->getTitle() <<"\n";
             std::string cacheKey = theProxy->getNormLevelPath() + theProxy->getId() + 
                     ecl::strf("%d", theProxy->getReleaseVersion());
             std::map<std::string, Proxy *>::iterator i = cache.find(cacheKey);



From andreasl at mail.berlios.de  Wed Apr  4 21:50:43 2007
From: andreasl at mail.berlios.de (andreasl at BerliOS)
Date: Wed, 4 Apr 2007 21:50:43 +0200
Subject: [Enigma-game-svn] r678 - homepage/input/lotm
Message-ID: <200704041950.l34JohjS023235@sheep.berlios.de>

Author: andreasl
Date: 2007-04-04 21:50:43 +0200 (Wed, 04 Apr 2007)
New Revision: 678

Modified:
   homepage/input/lotm/lotm_200704.html
   homepage/input/lotm/lotm_200704_de.html
Log:
Homepage:
 - LotM April '07 concerning easy mode of "Pneumatic Delivery": corrected
LotM is now ready for validation and upload.


Modified: homepage/input/lotm/lotm_200704.html
===================================================================
--- homepage/input/lotm/lotm_200704.html	2007-04-03 23:19:21 UTC (rev 677)
+++ homepage/input/lotm/lotm_200704.html	2007-04-04 19:50:43 UTC (rev 678)
@@ -153,7 +153,12 @@
 
   <p>There is an easy mode?! Well, I didn't know too, until Manuel drew my
   attention to it. Indeed, the version in Enigma 1.00 has an easy mode coded
-  but we forgot to activate it ... will be corrected with 1.01!</p>
+  but we forgot to activate it ... unfortunately, we can't reconstruct if the
+  world records achieved and listed above are done in normal or easy mode.
+  So I'm very sorry to announce an update of &quot;Pneumatic Delivery&quot;
+  in Enigma 1.01, with corrected easy mode, which will make all prior
+  records of PD obsolete. If you see any more levels with internal easy modes
+  that are not marked as such, please inform us.</p>
 
   <p class="quote">
   Personally I think I created this landscape quite well, and what is even

Modified: homepage/input/lotm/lotm_200704_de.html
===================================================================
--- homepage/input/lotm/lotm_200704_de.html	2007-04-03 23:19:21 UTC (rev 677)
+++ homepage/input/lotm/lotm_200704_de.html	2007-04-04 19:50:43 UTC (rev 678)
@@ -174,7 +174,14 @@
   <p>Es gibt hier einen Easy-Mode?! Ja, das wusste ich auch nicht, bis Manuel
   meine Aufmerksamkeit darauf gezogen hat. Tats&auml;chlich besitzt die
   Version in Enigma 1.00 einen Easy-Mode im Quelltext, den wir nur vergessen
-  haben zu aktivieren ... wird mit 1.01 korrigiert!</p>
+  haben zu aktivieren ... leider k&ouml;nnen wir nicht rekonstruieren, ob die
+  erzielten und oben gelisteten Weltrekorde im Normal- oder Easy-Mode erspielt
+  wurden. Entsprechend tut es mir sehr leid, ein Update f&uuml;r
+  &quot;Pneumatic Delivery&quot; in Enigma 1.01 anzuk&uuml;ndigen, mit
+  korrigiertem Easy-Mode, der alle vorigen Rekorde von P.D. ung&uuml;ltig
+  macht. Falls Sie weitere Levels sehen, die einen internen Easy-Mode
+  besitzen, aber nicht als solche gekennzeichnet sind, informieren Sie uns
+  bitte.</p>
 
   <p class="quote">
   Ich pers&ouml;nlich finde, dass mir diese Landschaft gut gelungen ist, aber



From ral at mail.berlios.de  Wed Apr  4 23:25:19 2007
From: ral at mail.berlios.de (ral at BerliOS)
Date: Wed, 4 Apr 2007 23:25:19 +0200
Subject: [Enigma-game-svn] r679 - in homepage/input: . news
Message-ID: <200704042125.l34LPJtC030278@sheep.berlios.de>

Author: ral
Date: 2007-04-04 23:25:10 +0200 (Wed, 04 Apr 2007)
New Revision: 679

Added:
   homepage/input/news/news_issue20_de.html
   homepage/input/news/news_issue20_en.html
Modified:
   homepage/input/output-files.lua
   homepage/input/support.html
   homepage/input/support_de.html
   homepage/input/table-hcp.html
   homepage/input/table-solved.html
   homepage/input/table-wr.html
   homepage/input/userlist.html
Log:
Homepage:
- score statistics for March 2007
- russian manual

Added: homepage/input/news/news_issue20_de.html
===================================================================
--- homepage/input/news/news_issue20_de.html	2007-04-04 19:50:43 UTC (rev 678)
+++ homepage/input/news/news_issue20_de.html	2007-04-04 21:25:10 UTC (rev 679)
@@ -0,0 +1,6 @@
+<h3 class="news">
+    <span class="date">Apr 4 2007: </span> Russisches Benutzerhandbuch
+</h3>
+
+<p>Das russische Benutzerhandbuch f&uuml;r Enigma 1.00 ist nun auf der
+<a href="$$support$$#documentation">Dokumentationsseite</a> erh&auml;ltlich.</p>


Property changes on: homepage/input/news/news_issue20_de.html
___________________________________________________________________
Name: svn:eol-style
   + native

Added: homepage/input/news/news_issue20_en.html
===================================================================
--- homepage/input/news/news_issue20_en.html	2007-04-04 19:50:43 UTC (rev 678)
+++ homepage/input/news/news_issue20_en.html	2007-04-04 21:25:10 UTC (rev 679)
@@ -0,0 +1,6 @@
+<h3 class="news">
+    <span class="date">Apr 4 2007: </span> Russian Manual
+</h3>
+
+<p>The Russian manual for Enigma 1.00 is now available in the <a
+href="$$support$$#documentation">documentation section</a>.</p>


Property changes on: homepage/input/news/news_issue20_en.html
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: homepage/input/output-files.lua
===================================================================
--- homepage/input/output-files.lua	2007-04-04 19:50:43 UTC (rev 678)
+++ homepage/input/output-files.lua	2007-04-04 21:25:10 UTC (rev 679)
@@ -7,7 +7,7 @@
 suffix = ".html"
 
 language_list = {"", "_de"} -- "_fr"
-newsfield = {16, 17, 18, 19}
+newsfield = {16, 17, 18, 19, 20}
 
 general = {
     infile = directory.."schema"..suffix,

Modified: homepage/input/support.html
===================================================================
--- homepage/input/support.html	2007-04-04 19:50:43 UTC (rev 678)
+++ homepage/input/support.html	2007-04-04 21:25:10 UTC (rev 679)
@@ -38,6 +38,12 @@
     <li><img src="$$imagedir$$/flags25x15/fr.png" border="0" width="25" height="15" alt="French" title="French">&nbsp;&nbsp;
       <a href="manual/enigma_fr.html">Manuel Fran&ccedil;ais (html)</a>&nbsp;&nbsp;
       finished after 1.00 release!</li>
+    <li><img src="$$imagedir$$/flags25x15/ru.png" border="0" width="25" height="15" alt="Russian" title="Russian">&nbsp;&nbsp;
+      <a href="manual/enigma_ru.html">Russian User manual (html)</a>&nbsp;&nbsp;
+      finished after 1.00 release!</li>
+    <li><img src="$$imagedir$$/flags25x15/ru.png" border="0" width="25" height="15" alt="Russian" title="Russian">&nbsp;&nbsp;
+      <a href="manual/enigma_ru.pdf">Russian User manual (pdf)</a>&nbsp;&nbsp;
+      finished after 1.00 release!</li>
   </ul>
 
   <p>Further on we provide a reference manual which is included in the Enigma

Modified: homepage/input/support_de.html
===================================================================
--- homepage/input/support_de.html	2007-04-04 19:50:43 UTC (rev 678)
+++ homepage/input/support_de.html	2007-04-04 21:25:10 UTC (rev 679)
@@ -46,6 +46,12 @@
     <li><img src="$$imagedir$$/flags25x15/fr.png" border="0" width="25" height="15" alt="Franz&ouml;sisch" title="Franz&ouml;sisch">&nbsp;&nbsp;
       <a href="manual/enigma_fr.html">Manuel Fran&ccedil;ais (html)</a>&nbsp;&nbsp;
       komplettiert nach der 1.00-Version!</li>
+    <li><img src="$$imagedir$$/flags25x15/ru.png" border="0" width="25" height="15" alt="Russisch" title="Russisch">&nbsp;&nbsp;
+      <a href="manual/enigma_ru.html">Russisches Benutzerhandbuch (html)</a>&nbsp;&nbsp;
+      komplettiert nach der 1.00-Version!</li>
+    <li><img src="$$imagedir$$/flags25x15/ru.png" border="0" width="25" height="15" alt="Russisch" title="Russisch">&nbsp;&nbsp;
+      <a href="manual/enigma_ru.pdf">Russisches Benutzerhandbuch (pdf)</a>&nbsp;&nbsp;
+      komplettiert nach der 1.00-Version!</li>
   </ul>
 
   <p>Desweiteren stellen wir ein Referenzhandbuch zur Verf&uuml;gung, das

Modified: homepage/input/table-hcp.html
===================================================================
--- homepage/input/table-hcp.html	2007-04-04 19:50:43 UTC (rev 678)
+++ homepage/input/table-hcp.html	2007-04-04 21:25:10 UTC (rev 679)
@@ -1,53 +1,63 @@
   <table>
-    <caption>Handicap Statistics of February 2007</caption>
+    <caption>Handicap Statistics of March 2007</caption>
     <colgroup><col width="130"><col width="220"></colgroup>
     <tr><th>solved hcp</th><th class="left">user</th></tr>
-     <tr><td class="num">-176.4</td><td class="left">'Moneymaker'</td></tr>
-     <tr><td class="num">-138.8</td><td class="left">'Stupid'</td></tr>
-     <tr><td class="num">-118.1</td><td class="left">'Johannes'</td></tr>
-     <tr><td class="num">-111.6</td><td class="left">'Great Scott'</td></tr>
-     <tr><td class="num"> -98.4</td><td class="left">'Duffy'</td></tr>
-     <tr><td class="num"> -82.8</td><td class="left">'Django'</td></tr>
-     <tr><td class="num"> -70.4</td><td class="left">'bojster'</td></tr>
-     <tr><td class="num"> -43.9</td><td class="left">'JuSt'</td></tr>
-     <tr><td class="num"> -41.9</td><td class="left">'Raoul'</td></tr>
-     <tr><td class="num"> -41.7</td><td class="left">'HuB34'</td></tr>
-     <tr><td class="num"> -40.3</td><td class="left">'Ronald'</td></tr>
-     <tr><td class="num"> -39.6</td><td class="left">'Taztunes'</td></tr>
-     <tr><td class="num"> -34.3</td><td class="left">'Iceshark7'</td></tr>
-     <tr><td class="num"> -24.4</td><td class="left">'daydreamer'</td></tr>
-     <tr><td class="num"> -16.0</td><td class="left">'Andreas'</td></tr>
-     <tr><td class="num"> -15.0</td><td class="left">'Wuzzy'</td></tr>
-     <tr><td class="num"> -10.9</td><td class="left">'ryujun'</td></tr>
+     <tr><td class="num">-182.5</td><td class="left">'Moneymaker'</td></tr>
+     <tr><td class="num">-140.7</td><td class="left">'Stupid'</td></tr>
+     <tr><td class="num">-134.3</td><td class="left">'Johannes'</td></tr>
+     <tr><td class="num">-113.9</td><td class="left">'Great Scott'</td></tr>
+     <tr><td class="num">-101.1</td><td class="left">'Duffy'</td></tr>
+     <tr><td class="num"> -87.8</td><td class="left">'Django'</td></tr>
+     <tr><td class="num"> -72.2</td><td class="left">'bojster'</td></tr>
+     <tr><td class="num"> -66.3</td><td class="left">'Taztunes'</td></tr>
+     <tr><td class="num"> -51.4</td><td class="left">'Raoul'</td></tr>
+     <tr><td class="num"> -48.7</td><td class="left">'HuB34'</td></tr>
+     <tr><td class="num"> -46.5</td><td class="left">'daydreamer'</td></tr>
+     <tr><td class="num"> -44.9</td><td class="left">'JuSt'</td></tr>
+     <tr><td class="num"> -42.3</td><td class="left">'Ronald'</td></tr>
+     <tr><td class="num"> -41.1</td><td class="left">'Lukas'</td></tr>
+     <tr><td class="num"> -35.4</td><td class="left">'Iceshark7'</td></tr>
+     <tr><td class="num"> -34.9</td><td class="left">'para_doks'</td></tr>
+     <tr><td class="num"> -33.3</td><td class="left">'Ghatotkacha'</td></tr>
+     <tr><td class="num"> -32.2</td><td class="left">'Wuzzy'</td></tr>
+     <tr><td class="num"> -21.1</td><td class="left">'ryujun'</td></tr>
+     <tr><td class="num"> -18.0</td><td class="left">'Andreas'</td></tr>
+     <tr><td class="num"> -16.9</td><td class="left">'Sim_Ed'</td></tr>
      <tr><td class="num"> -10.8</td><td class="left">'joseba'</td></tr>
-     <tr><td class="num">  -2.5</td><td class="left">'Klaus'</td></tr>
-     <tr><td class="num">  -1.7</td><td class="left">'Ale'</td></tr>
-     <tr><td class="num">   0.3</td><td class="left">'Ghatotkacha'</td></tr>
-     <tr><td class="num">   2.9</td><td class="left">'Thomas'</td></tr>
-     <tr><td class="num">   4.8</td><td class="left">'para_doks'</td></tr>
-     <tr><td class="num">   5.5</td><td class="left">'Chris'</td></tr>
-     <tr><td class="num">   7.6</td><td class="left">'Marc-Hendrik'</td></tr>
-     <tr><td class="num">   8.4</td><td class="left">'erich'</td></tr>
-     <tr><td class="num">   8.7</td><td class="left">'Melanie'</td></tr>
-     <tr><td class="num">  10.3</td><td class="left">'J3FF'</td></tr>
-     <tr><td class="num">  19.4</td><td class="left">'Edgar_Flesk'</td></tr>
-     <tr><td class="num">  23.6</td><td class="left">'niebie'</td></tr>
-     <tr><td class="num">  24.2</td><td class="left">'Vlad'</td></tr>
-     <tr><td class="num">  28.7</td><td class="left">'Tiger'</td></tr>
-     <tr><td class="num">  33.2</td><td class="left">'U-Punkt'</td></tr>
-     <tr><td class="num">  35.8</td><td class="left">'Valkyrie2'</td></tr>
-     <tr><td class="num">  36.6</td><td class="left">'Zak'</td></tr>
-     <tr><td class="num">  38.1</td><td class="left">'Sandra'</td></tr>
-     <tr><td class="num">  39.4</td><td class="left">'rgsantos at yahoo.com'</td></tr>
-     <tr><td class="num">  42.9</td><td class="left">'Turbogurk'</td></tr>
-     <tr><td class="num">  43.3</td><td class="left">'Jeffrey S'</td></tr>
-     <tr><td class="num">  48.1</td><td class="left">'ged'</td></tr>
-     <tr><td class="num">  53.4</td><td class="left">'ShadowPhrogg32642342'</td></tr>
-     <tr><td class="num">  58.0</td><td class="left">'Alf'</td></tr>
-     <tr><td class="num">  63.8</td><td class="left">'Samuel'</td></tr>
-     <tr><td class="num">  68.4</td><td class="left">'jojo'</td></tr>
-     <tr><td class="num">  68.5</td><td class="left">'Magnus and Susi'</td></tr>
-     <tr><td class="num">  68.8</td><td class="left">'Dvorhagen'</td></tr>
-     <tr><td class="num">  81.2</td><td class="left">'Miel56'</td></tr>
+     <tr><td class="num">  -3.7</td><td class="left">'Klaus'</td></tr>
+     <tr><td class="num">  -2.3</td><td class="left">'Ale'</td></tr>
+     <tr><td class="num">  -1.5</td><td class="left">'Marc-Hendrik'</td></tr>
+     <tr><td class="num">   1.4</td><td class="left">'Thomas'</td></tr>
+     <tr><td class="num">   3.9</td><td class="left">'Chris'</td></tr>
+     <tr><td class="num">   6.9</td><td class="left">'ged'</td></tr>
+     <tr><td class="num">   7.1</td><td class="left">'erich'</td></tr>
+     <tr><td class="num">   7.8</td><td class="left">'Melanie'</td></tr>
+     <tr><td class="num">   9.2</td><td class="left">'J3FF'</td></tr>
+     <tr><td class="num">   9.4</td><td class="left">'Mark P.'</td></tr>
+     <tr><td class="num">  13.6</td><td class="left">'IChrisI'</td></tr>
+     <tr><td class="num">  16.2</td><td class="left">'niebie'</td></tr>
+     <tr><td class="num">  17.5</td><td class="left">'hdwow'</td></tr>
+     <tr><td class="num">  18.5</td><td class="left">'Edgar_Flesk'</td></tr>
+     <tr><td class="num">  20.1</td><td class="left">'redsantz'</td></tr>
+     <tr><td class="num">  22.1</td><td class="left">'Tarim'</td></tr>
+     <tr><td class="num">  23.0</td><td class="left">'Vlad'</td></tr>
+     <tr><td class="num">  27.6</td><td class="left">'Tiger'</td></tr>
+     <tr><td class="num">  29.4</td><td class="left">'U-Punkt'</td></tr>
+     <tr><td class="num">  35.1</td><td class="left">'Valkyrie2'</td></tr>
+     <tr><td class="num">  35.8</td><td class="left">'Zak'</td></tr>
+     <tr><td class="num">  37.1</td><td class="left">'Sandra'</td></tr>
+     <tr><td class="num">  41.3</td><td class="left">'Jeffrey S'</td></tr>
+     <tr><td class="num">  42.3</td><td class="left">'Turbogurk'</td></tr>
+     <tr><td class="num">  48.1</td><td class="left">'Breezy'</td></tr>
+     <tr><td class="num">  53.1</td><td class="left">'ShadowPhrogg32642342'</td></tr>
+     <tr><td class="num">  56.9</td><td class="left">'Mecki'</td></tr>
+     <tr><td class="num">  58.3</td><td class="left">'Alf'</td></tr>
+     <tr><td class="num">  59.7</td><td class="left">'Magnus and Susi'</td></tr>
+     <tr><td class="num">  62.5</td><td class="left">'xmouse'</td></tr>
+     <tr><td class="num">  63.5</td><td class="left">'Samuel'</td></tr>
+     <tr><td class="num">  68.3</td><td class="left">'Dvorhagen'</td></tr>
+     <tr><td class="num">  68.7</td><td class="left">'jojo'</td></tr>
+     <tr><td class="num">  81.0</td><td class="left">'Miel56'</td></tr>
+     <tr><td class="num">  87.4</td><td class="left">'The red O'</td></tr>
      <tr><td class="num">  90.1</td><td class="left">'Michael'</td></tr>
   </table>

Modified: homepage/input/table-solved.html
===================================================================
--- homepage/input/table-solved.html	2007-04-04 19:50:43 UTC (rev 678)
+++ homepage/input/table-solved.html	2007-04-04 21:25:10 UTC (rev 679)
@@ -1,53 +1,63 @@
   <table>
-    <caption>Solved Level Statistics of February 2007</caption>
+    <caption>Solved Level Statistics of March 2007</caption>
     <colgroup><col width="130"><col width="130"><col width="130"><col width="240"></colgroup>
     <tr><th>difficult</th><th>easy</th><th>total</th><th class="left">user</th></tr>
-    <tr><td class="num">966/974</td><td class="num">150/152</td><td class="num"> 99.11%</td><td class="left">'Taztunes'</td></tr>
-    <tr><td class="num">928/974</td><td class="num">137/152</td><td class="num"> 94.58%</td><td class="left">'Moneymaker'</td></tr>
-    <tr><td class="num">910/974</td><td class="num">138/152</td><td class="num"> 93.07%</td><td class="left">'Ronald'</td></tr>
+    <tr><td class="num">966/974</td><td class="num">151/152</td><td class="num"> 99.20%</td><td class="left">'Taztunes'</td></tr>
+    <tr><td class="num">942/974</td><td class="num">142/152</td><td class="num"> 96.27%</td><td class="left">'Moneymaker'</td></tr>
+    <tr><td class="num">933/974</td><td class="num">139/152</td><td class="num"> 95.20%</td><td class="left">'ryujun'</td></tr>
+    <tr><td class="num">919/974</td><td class="num">140/152</td><td class="num"> 94.05%</td><td class="left">'Ronald'</td></tr>
     <tr><td class="num">861/974</td><td class="num">136/152</td><td class="num"> 88.54%</td><td class="left">'Stupid'</td></tr>
-    <tr><td class="num">869/974</td><td class="num">120/152</td><td class="num"> 87.83%</td><td class="left">'ryujun'</td></tr>
     <tr><td class="num">873/974</td><td class="num">100/152</td><td class="num"> 86.41%</td><td class="left">'JuSt'</td></tr>
-    <tr><td class="num">870/974</td><td class="num"> 65/152</td><td class="num"> 83.04%</td><td class="left">'Django'</td></tr>
+    <tr><td class="num">837/974</td><td class="num">122/152</td><td class="num"> 85.17%</td><td class="left">'Johannes'</td></tr>
+    <tr><td class="num">950/974</td><td class="num">  0/152</td><td class="num"> 84.37%</td><td class="left">'Tarim'</td></tr>
+    <tr><td class="num">877/974</td><td class="num"> 69/152</td><td class="num"> 84.01%</td><td class="left">'Django'</td></tr>
+    <tr><td class="num">797/974</td><td class="num">133/152</td><td class="num"> 82.59%</td><td class="left">'para_doks'</td></tr>
     <tr><td class="num">907/974</td><td class="num">  1/152</td><td class="num"> 80.64%</td><td class="left">'Ale'</td></tr>
-    <tr><td class="num">847/974</td><td class="num"> 17/152</td><td class="num"> 76.73%</td><td class="left">'Melanie'</td></tr>
+    <tr><td class="num">785/974</td><td class="num">104/152</td><td class="num"> 78.95%</td><td class="left">'daydreamer'</td></tr>
+    <tr><td class="num">852/974</td><td class="num"> 17/152</td><td class="num"> 77.18%</td><td class="left">'Melanie'</td></tr>
     <tr><td class="num">745/974</td><td class="num"> 82/152</td><td class="num"> 73.45%</td><td class="left">'bojster'</td></tr>
-    <tr><td class="num">736/974</td><td class="num"> 71/152</td><td class="num"> 71.67%</td><td class="left">'daydreamer'</td></tr>
-    <tr><td class="num">667/974</td><td class="num"> 93/152</td><td class="num"> 67.50%</td><td class="left">'Johannes'</td></tr>
-    <tr><td class="num">683/974</td><td class="num"> 70/152</td><td class="num"> 66.87%</td><td class="left">'HuB34'</td></tr>
-    <tr><td class="num">618/974</td><td class="num">119/152</td><td class="num"> 65.45%</td><td class="left">'para_doks'</td></tr>
+    <tr><td class="num">794/974</td><td class="num"> 33/152</td><td class="num"> 73.45%</td><td class="left">'Sim_Ed'</td></tr>
+    <tr><td class="num">695/974</td><td class="num"> 78/152</td><td class="num"> 68.65%</td><td class="left">'HuB34'</td></tr>
+    <tr><td class="num">673/974</td><td class="num"> 95/152</td><td class="num"> 68.21%</td><td class="left">'Marc-Hendrik'</td></tr>
     <tr><td class="num">654/974</td><td class="num"> 83/152</td><td class="num"> 65.45%</td><td class="left">'Great Scott'</td></tr>
+    <tr><td class="num">686/974</td><td class="num"> 29/152</td><td class="num"> 63.50%</td><td class="left">'Lukas'</td></tr>
     <tr><td class="num">641/974</td><td class="num"> 43/152</td><td class="num"> 60.75%</td><td class="left">'Klaus'</td></tr>
-    <tr><td class="num">599/974</td><td class="num"> 84/152</td><td class="num"> 60.66%</td><td class="left">'Marc-Hendrik'</td></tr>
+    <tr><td class="num">548/974</td><td class="num"> 94/152</td><td class="num"> 57.02%</td><td class="left">'Raoul'</td></tr>
+    <tr><td class="num">539/974</td><td class="num"> 82/152</td><td class="num"> 55.15%</td><td class="left">'Wuzzy'</td></tr>
+    <tr><td class="num">541/974</td><td class="num"> 23/152</td><td class="num"> 50.09%</td><td class="left">'redsantz'</td></tr>
     <tr><td class="num">526/974</td><td class="num"> 37/152</td><td class="num"> 50.00%</td><td class="left">'Valkyrie2'</td></tr>
-    <tr><td class="num">521/974</td><td class="num"> 32/152</td><td class="num"> 49.11%</td><td class="left">'Raoul'</td></tr>
+    <tr><td class="num">523/974</td><td class="num"> 24/152</td><td class="num"> 48.58%</td><td class="left">'niebie'</td></tr>
+    <tr><td class="num">433/974</td><td class="num"> 78/152</td><td class="num"> 45.38%</td><td class="left">'Mark P.'</td></tr>
+    <tr><td class="num">463/974</td><td class="num"> 44/152</td><td class="num"> 45.03%</td><td class="left">'Ghatotkacha'</td></tr>
     <tr><td class="num">499/974</td><td class="num">  0/152</td><td class="num"> 44.32%</td><td class="left">'Edgar_Flesk'</td></tr>
-    <tr><td class="num">408/974</td><td class="num"> 61/152</td><td class="num"> 41.65%</td><td class="left">'Wuzzy'</td></tr>
-    <tr><td class="num">449/974</td><td class="num"> 12/152</td><td class="num"> 40.94%</td><td class="left">'niebie'</td></tr>
-    <tr><td class="num">440/974</td><td class="num">  8/152</td><td class="num"> 39.79%</td><td class="left">'Duffy'</td></tr>
+    <tr><td class="num">459/974</td><td class="num">  8/152</td><td class="num"> 41.47%</td><td class="left">'Duffy'</td></tr>
+    <tr><td class="num">426/974</td><td class="num">  6/152</td><td class="num"> 38.37%</td><td class="left">'hdwow'</td></tr>
     <tr><td class="num">394/974</td><td class="num"> 36/152</td><td class="num"> 38.19%</td><td class="left">'Iceshark7'</td></tr>
+    <tr><td class="num">377/974</td><td class="num"> 31/152</td><td class="num"> 36.23%</td><td class="left">'Breezy'</td></tr>
     <tr><td class="num">386/974</td><td class="num"> 10/152</td><td class="num"> 35.17%</td><td class="left">'J3FF'</td></tr>
-    <tr><td class="num">354/974</td><td class="num"> 22/152</td><td class="num"> 33.39%</td><td class="left">'Ghatotkacha'</td></tr>
-    <tr><td class="num">334/974</td><td class="num"> 23/152</td><td class="num"> 31.71%</td><td class="left">'Jeffrey S'</td></tr>
+    <tr><td class="num">361/974</td><td class="num"> 23/152</td><td class="num"> 34.10%</td><td class="left">'U-Punkt'</td></tr>
+    <tr><td class="num">374/974</td><td class="num">  7/152</td><td class="num"> 33.84%</td><td class="left">'IChrisI'</td></tr>
+    <tr><td class="num">344/974</td><td class="num"> 27/152</td><td class="num"> 32.95%</td><td class="left">'Jeffrey S'</td></tr>
     <tr><td class="num">288/974</td><td class="num"> 63/152</td><td class="num"> 31.17%</td><td class="left">'erich'</td></tr>
-    <tr><td class="num">345/974</td><td class="num">  4/152</td><td class="num"> 30.99%</td><td class="left">'rgsantos at yahoo.com'</td></tr>
-    <tr><td class="num">304/974</td><td class="num"> 23/152</td><td class="num"> 29.04%</td><td class="left">'U-Punkt'</td></tr>
     <tr><td class="num">296/974</td><td class="num"> 29/152</td><td class="num"> 28.86%</td><td class="left">'Tiger'</td></tr>
     <tr><td class="num">264/974</td><td class="num"> 53/152</td><td class="num"> 28.15%</td><td class="left">'Andreas'</td></tr>
     <tr><td class="num">280/974</td><td class="num"> 15/152</td><td class="num"> 26.20%</td><td class="left">'Thomas'</td></tr>
     <tr><td class="num">210/974</td><td class="num"> 38/152</td><td class="num"> 22.02%</td><td class="left">'Sandra'</td></tr>
+    <tr><td class="num">164/974</td><td class="num"> 21/152</td><td class="num"> 16.43%</td><td class="left">'ged'</td></tr>
     <tr><td class="num">129/974</td><td class="num"> 55/152</td><td class="num"> 16.34%</td><td class="left">'Vlad'</td></tr>
     <tr><td class="num">150/974</td><td class="num"> 30/152</td><td class="num"> 15.99%</td><td class="left">'Chris'</td></tr>
     <tr><td class="num">159/974</td><td class="num"> 20/152</td><td class="num"> 15.90%</td><td class="left">'Turbogurk'</td></tr>
     <tr><td class="num">159/974</td><td class="num"> 17/152</td><td class="num"> 15.63%</td><td class="left">'Zak'</td></tr>
+    <tr><td class="num">127/974</td><td class="num"> 15/152</td><td class="num"> 12.61%</td><td class="left">'Magnus and Susi'</td></tr>
+    <tr><td class="num">113/974</td><td class="num"> 22/152</td><td class="num"> 11.99%</td><td class="left">'Mecki'</td></tr>
     <tr><td class="num"> 90/974</td><td class="num"> 21/152</td><td class="num">  9.86%</td><td class="left">'joseba'</td></tr>
     <tr><td class="num">106/974</td><td class="num">  0/152</td><td class="num">  9.41%</td><td class="left">'Alf'</td></tr>
     <tr><td class="num"> 92/974</td><td class="num"> 13/152</td><td class="num">  9.33%</td><td class="left">'ShadowPhrogg32642342'</td></tr>
-    <tr><td class="num"> 96/974</td><td class="num">  6/152</td><td class="num">  9.06%</td><td class="left">'Magnus and Susi'</td></tr>
     <tr><td class="num"> 67/974</td><td class="num"> 19/152</td><td class="num">  7.64%</td><td class="left">'Dvorhagen'</td></tr>
-    <tr><td class="num"> 63/974</td><td class="num"> 16/152</td><td class="num">  7.02%</td><td class="left">'ged'</td></tr>
+    <tr><td class="num"> 58/974</td><td class="num"> 19/152</td><td class="num">  6.84%</td><td class="left">'xmouse'</td></tr>
     <tr><td class="num"> 39/974</td><td class="num"> 14/152</td><td class="num">  4.71%</td><td class="left">'jojo'</td></tr>
     <tr><td class="num"> 42/974</td><td class="num">  9/152</td><td class="num">  4.53%</td><td class="left">'Samuel'</td></tr>
     <tr><td class="num"> 27/974</td><td class="num">  5/152</td><td class="num">  2.84%</td><td class="left">'Miel56'</td></tr>
+    <tr><td class="num"> 23/974</td><td class="num">  5/152</td><td class="num">  2.49%</td><td class="left">'The red O'</td></tr>
     <tr><td class="num">  7/974</td><td class="num"> 12/152</td><td class="num">  1.69%</td><td class="left">'Michael'</td></tr>
   </table>

Modified: homepage/input/table-wr.html
===================================================================
--- homepage/input/table-wr.html	2007-04-04 19:50:43 UTC (rev 678)
+++ homepage/input/table-wr.html	2007-04-04 21:25:10 UTC (rev 679)
@@ -1,33 +1,37 @@
   <table>
-    <caption>Worldrecord Statistics of February 2007</caption>
+    <caption>Worldrecord Statistics of March 2007</caption>
     <colgroup><col width="80"><col width="80"><col width="470"></colgroup>
     <tr><th>total</th><th>shared</th><th class="left">users</th></tr>
-    <tr><td class="num">705</td><td class="num">188</td><td class="left">'Moneymaker'</td></tr>
-    <tr><td class="num">247</td><td class="num"> 97</td><td class="left">'Stupid'</td></tr>
-    <tr><td class="num">157</td><td class="num">110</td><td class="left">'Johannes'</td></tr>
-    <tr><td class="num">118</td><td class="num"> 82</td><td class="left">'Great Scott'</td></tr>
-    <tr><td class="num">116</td><td class="num"> 57</td><td class="left">'Duffy'</td></tr>
-    <tr><td class="num"> 56</td><td class="num"> 38</td><td class="left">'Iceshark7'</td></tr>
-    <tr><td class="num"> 34</td><td class="num"> 23</td><td class="left">'bojster'</td></tr>
-    <tr><td class="num"> 33</td><td class="num"> 17</td><td class="left">'Django'</td></tr>
-    <tr><td class="num"> 26</td><td class="num"> 23</td><td class="left">'joseba'</td></tr>
-    <tr><td class="num"> 21</td><td class="num">  4</td><td class="left">'Ronald'</td></tr>
+    <tr><td class="num">741</td><td class="num">220</td><td class="left">'Moneymaker'</td></tr>
+    <tr><td class="num">231</td><td class="num"> 98</td><td class="left">'Stupid'</td></tr>
+    <tr><td class="num">189</td><td class="num">139</td><td class="left">'Johannes'</td></tr>
+    <tr><td class="num">117</td><td class="num"> 61</td><td class="left">'Duffy'</td></tr>
+    <tr><td class="num">107</td><td class="num"> 79</td><td class="left">'Great Scott'</td></tr>
+    <tr><td class="num"> 48</td><td class="num"> 39</td><td class="left">'Iceshark7'</td></tr>
+    <tr><td class="num"> 33</td><td class="num"> 26</td><td class="left">'Django'</td></tr>
+    <tr><td class="num"> 29</td><td class="num"> 17</td><td class="left">'HuB34'</td></tr>
+    <tr><td class="num"> 29</td><td class="num"> 24</td><td class="left">'bojster'</td></tr>
+    <tr><td class="num"> 25</td><td class="num"> 22</td><td class="left">'Ghatotkacha'</td></tr>
+    <tr><td class="num"> 24</td><td class="num"> 22</td><td class="left">'joseba'</td></tr>
     <tr><td class="num"> 20</td><td class="num">  6</td><td class="left">'Raoul'</td></tr>
-    <tr><td class="num"> 19</td><td class="num"> 14</td><td class="left">'HuB34'</td></tr>
-    <tr><td class="num"> 12</td><td class="num"> 10</td><td class="left">'Ghatotkacha'</td></tr>
-    <tr><td class="num">  8</td><td class="num">  1</td><td class="left">'JuSt'</td></tr>
-    <tr><td class="num">  7</td><td class="num">  5</td><td class="left">'Thomas' + 'daydreamer'</td></tr>
-    <tr><td class="num">  6</td><td class="num">  6</td><td class="left">'Chris' + 'Ralf'</td></tr>
-    <tr><td class="num">  5</td><td class="num">  3</td><td class="left">'Wuzzy'</td></tr>
+    <tr><td class="num"> 19</td><td class="num"> 17</td><td class="left">'daydreamer'</td></tr>
+    <tr><td class="num"> 18</td><td class="num">  6</td><td class="left">'Ronald'</td></tr>
+    <tr><td class="num"> 12</td><td class="num">  6</td><td class="left">'Lukas'</td></tr>
+    <tr><td class="num"> 11</td><td class="num">  8</td><td class="left">'Wuzzy'</td></tr>
+    <tr><td class="num"> 10</td><td class="num">  9</td><td class="left">'ged'</td></tr>
+    <tr><td class="num">  7</td><td class="num">  1</td><td class="left">'Taztunes'</td></tr>
+    <tr><td class="num">  7</td><td class="num">  3</td><td class="left">'para_doks'</td></tr>
+    <tr><td class="num">  6</td><td class="num">  6</td><td class="left">'Chris' + 'Thomas' + 'Ralf'</td></tr>
+    <tr><td class="num">  5</td><td class="num">  1</td><td class="left">'JuSt'</td></tr>
     <tr><td class="num">  5</td><td class="num">  5</td><td class="left">'J3FF'</td></tr>
-    <tr><td class="num">  4</td><td class="num">  0</td><td class="left">'Ale' + 'Taztunes'</td></tr>
-    <tr><td class="num">  4</td><td class="num">  1</td><td class="left">'Andreas'</td></tr>
     <tr><td class="num">  4</td><td class="num">  2</td><td class="left">'Stephanie'</td></tr>
-    <tr><td class="num">  3</td><td class="num">  1</td><td class="left">'Edgar_Flesk'</td></tr>
-    <tr><td class="num">  2</td><td class="num">  0</td><td class="left">'para_doks' + 'Markus'</td></tr>
+    <tr><td class="num">  3</td><td class="num">  0</td><td class="left">'IChrisI' + 'Ale'</td></tr>
+    <tr><td class="num">  3</td><td class="num">  1</td><td class="left">'Andreas' + 'Edgar_Flesk'</td></tr>
+    <tr><td class="num">  3</td><td class="num">  3</td><td class="left">'Sim_Ed'</td></tr>
+    <tr><td class="num">  2</td><td class="num">  0</td><td class="left">'Markus'</td></tr>
     <tr><td class="num">  2</td><td class="num">  1</td><td class="left">'Vlad'</td></tr>
-    <tr><td class="num">  2</td><td class="num">  2</td><td class="left">'ged' + 'Ingo'</td></tr>
-    <tr><td class="num">  1</td><td class="num">  0</td><td class="left">'Daniel' + 'Nat' + 'Melanie' + 'Klaus' + 'Turbogurk' + 'Ant'</td></tr>
+    <tr><td class="num">  2</td><td class="num">  2</td><td class="left">'Ingo'</td></tr>
+    <tr><td class="num">  1</td><td class="num">  0</td><td class="left">'Daniel' + 'Nat' + 'Melanie' + 'Klaus' + 'Turbogurk' + 'hdwow' + 'Mark P.' + 'Ant'</td></tr>
     <tr><td class="num">  1</td><td class="num">  1</td><td class="left">'niebie' + 'Zak' + 'Samuel'</td></tr>
-    <tr><td class="num">  0</td><td class="num">  0</td><td class="left">'Alf' + 'Dvorhagen' + 'Valkyrie2' + 'ryujun' + 'Marc-Hendrik' + 'Miel56' + 'Magnus and Susi' + 'Michael' + 'rgsantos at yahoo.com' + 'erich' + 'Ingo_K' + 'jojo' + 'U-Punkt' + 'Jeffrey S' + 'Holger' + 'Tiger' + 'ShadowPhrogg32642342' + 'Sandra'</td></tr>
+    <tr><td class="num">  0</td><td class="num">  0</td><td class="left">'Alf' + 'Dvorhagen' + 'Valkyrie2' + 'ryujun' + 'Marc-Hendrik' + 'Miel56' + 'Mecki' + 'Magnus and Susi' + 'Michael' + 'redsantz' + 'Tarim' + 'erich' + 'The red O' + 'Breezy' + 'Ingo_K' + 'jojo' + 'U-Punkt' + 'Jeffrey S' + 'Holger' + 'Tiger' + 'xmouse' + 'ShadowPhrogg32642342' + 'Sandra'</td></tr>
   </table>

Modified: homepage/input/userlist.html
===================================================================
--- homepage/input/userlist.html	2007-04-04 19:50:43 UTC (rev 678)
+++ homepage/input/userlist.html	2007-04-04 21:25:10 UTC (rev 679)
@@ -6,6 +6,7 @@
     <li>Andreas</li>
     <li>Ant</li>
     <li>bojster</li>
+    <li>Breezy</li>
     <li>Chris</li>
     <li>Daniel</li>
     <li>daydreamer</li>
@@ -17,9 +18,11 @@
     <li>ged</li>
     <li>Ghatotkacha</li>
     <li>Great Scott</li>
+    <li>hdwow</li>
     <li>Holger</li>
     <li>HuB34</li>
     <li>Iceshark7</li>
+    <li>IChrisI</li>
     <li>Ingo</li>
     <li>Ingo_K</li>
     <li>J3FF</li>
@@ -29,9 +32,12 @@
     <li>joseba</li>
     <li>JuSt</li>
     <li>Klaus</li>
+    <li>Lukas</li>
     <li>Magnus and Susi</li>
     <li>Marc-Hendrik</li>
+    <li>Mark P.</li>
     <li>Markus</li>
+    <li>Mecki</li>
     <li>Melanie</li>
     <li>Michael</li>
     <li>Miel56</li>
@@ -41,15 +47,18 @@
     <li>para_doks</li>
     <li>Ralf</li>
     <li>Raoul</li>
-    <li>rgsantos at yahoo.com</li>
+    <li>redsantz</li>
     <li>Ronald</li>
     <li>ryujun</li>
     <li>Samuel</li>
     <li>Sandra</li>
     <li>ShadowPhrogg32642342</li>
+    <li>Sim_Ed</li>
     <li>Stephanie</li>
     <li>Stupid</li>
+    <li>Tarim</li>
     <li>Taztunes</li>
+    <li>The red O</li>
     <li>Thomas</li>
     <li>Tiger</li>
     <li>Turbogurk</li>
@@ -57,6 +66,7 @@
     <li>Valkyrie2</li>
     <li>Vlad</li>
     <li>Wuzzy</li>
+    <li>xmouse</li>
     <li>Zak</li>
   </ul>
 </div>



From R.Lamprecht at T-Online.de  Wed Apr  4 23:41:26 2007
From: R.Lamprecht at T-Online.de (Ronald Lamprecht)
Date: Wed, 04 Apr 2007 23:41:26 +0200
Subject: [Enigma-game-svn] branches/1.0
Message-ID: <46141B86.1010309@T-Online.de>

As the patch is too large the commit message as a short manual notification:

Branch 1.0:
- I18N po update fr,hu by translators
- russian manual addition
- ratings with March 2007 score evaluation

Ronald


From ral at mail.berlios.de  Wed Apr  4 23:53:29 2007
From: ral at mail.berlios.de (ral at BerliOS)
Date: Wed, 4 Apr 2007 23:53:29 +0200
Subject: [Enigma-game-svn] r680 - in branches/1.0: po src
Message-ID: <200704042153.l34LrTAn031876@sheep.berlios.de>

Author: ral
Date: 2007-04-04 23:53:28 +0200 (Wed, 04 Apr 2007)
New Revision: 680

Modified:
   branches/1.0/po/hu.po
   branches/1.0/src/server.cc
Log:
Branch 1.0: 
- fix false easy mode activation: respect declared level easy mode
- fix hu.po of r677 - eliminate spurious formfeed


Modified: branches/1.0/po/hu.po
===================================================================
--- branches/1.0/po/hu.po	2007-04-04 21:25:10 UTC (rev 679)
+++ branches/1.0/po/hu.po	2007-04-04 21:53:28 UTC (rev 680)
@@ -2211,7 +2211,7 @@
 #  author: "Ulf Stegemann" email "ulf-enigma at zeitform.de"
 #: po/level_i18n.cc:1348
 msgid "For heaven's sake ... don't drown!"
-msgstr "Az ?g szerelm?re... meg ne fulladjon!"
+msgstr "Az ?g szerelm?re... meg ne fulladjon!"
 
 #  level: "Scrooge"
 #  author: "Siegfried Fennig" email ""

Modified: branches/1.0/src/server.cc
===================================================================
--- branches/1.0/src/server.cc	2007-04-04 21:25:10 UTC (rev 679)
+++ branches/1.0/src/server.cc	2007-04-04 21:53:28 UTC (rev 680)
@@ -23,6 +23,8 @@
 #include "actors.hh"
 #include "client.hh"
 #include "lua.hh"
+#include "lev/Index.hh"
+#include "lev/Proxy.hh"
 #include "main.hh"
 #include "nls.hh"
 #include "options.hh"
@@ -563,8 +565,10 @@
 
 enigma::Difficulty server::GetDifficulty()
 {
+    lev::Index *ind = lev::Index::getCurrentIndex();
+    lev::Proxy *curProxy = ind->getCurrent();
     int i= app.state->getInt ("Difficulty");
-    if (i == DIFFICULTY_EASY && !server::CreatingPreview)
+    if (i == DIFFICULTY_EASY && !server::CreatingPreview && curProxy->hasEasymode())
         return DIFFICULTY_EASY;
     else
         return DIFFICULTY_HARD;



From raoul at mail.berlios.de  Thu Apr  5 16:25:47 2007
From: raoul at mail.berlios.de (raoul at BerliOS)
Date: Thu, 5 Apr 2007 16:25:47 +0200
Subject: [Enigma-game-svn] r681 - in branches/1.0: data/levels/enigma_cross
	data/levels/enigma_iv data/levels/enigma_v data/levels/enigma_vi src
Message-ID: <200704051425.l35EPlfF009104@sheep.berlios.de>

Author: raoul
Date: 2007-04-05 16:25:46 +0200 (Thu, 05 Apr 2007)
New Revision: 681

Added:
   branches/1.0/data/levels/enigma_iv/ant29_2.xml
   branches/1.0/data/levels/enigma_v/malla01_2.xml
   branches/1.0/data/levels/enigma_vi/ant39_1.xml
   branches/1.0/data/levels/enigma_vi/luc34_1.xml
   branches/1.0/data/levels/enigma_vi/ral18_1.xml
   branches/1.0/data/levels/enigma_vi/raoul29_1.xml
   branches/1.0/data/levels/enigma_vi/raoul30_1.xml
Removed:
   branches/1.0/data/levels/enigma_iv/ant29_1.xml
   branches/1.0/data/levels/enigma_v/malla01_1.xml
Modified:
   branches/1.0/data/levels/enigma_cross/enigma0_92_1.xml
   branches/1.0/data/levels/enigma_cross/enigma0_92_3.xml
   branches/1.0/data/levels/enigma_cross/newlevels.xml
   branches/1.0/data/levels/enigma_cross/newlevels_1.0.1.xml
   branches/1.0/data/levels/enigma_iv/index.xml
   branches/1.0/data/levels/enigma_v/duffy126_1.xml
   branches/1.0/data/levels/enigma_v/index.xml
   branches/1.0/data/levels/enigma_v/raoul12_1.xml
   branches/1.0/data/levels/enigma_vi/index.xml
   branches/1.0/data/levels/enigma_vi/just10_1.xml
   branches/1.0/data/levels/enigma_vi/just11_1.xml
   branches/1.0/data/levels/enigma_vi/raoul28.xml
   branches/1.0/src/stones_simple.cc
Log:
-> 6 new levels, total 25 new levels for Enigma 1.01
-> Some levelbugfixes

-> it-glasses-bugfix



Modified: branches/1.0/data/levels/enigma_cross/enigma0_92_1.xml
===================================================================
--- branches/1.0/data/levels/enigma_cross/enigma0_92_1.xml	2007-04-04 21:53:28 UTC (rev 680)
+++ branches/1.0/data/levels/enigma_cross/enigma0_92_1.xml	2007-04-05 14:25:46 UTC (rev 681)
@@ -118,7 +118,7 @@
     <level _seq="110" _title="Draggers" _xpath="enigma_v/ant21_1" author="Petr Machata" ctrl="force" easy="false" id="ant21" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="111" _title="The Disappearing Block" _xpath="enigma_ii/duffy02_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy2" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="112" _title="Space Fishing" _xpath="enigma_iii/martin73_1" author="Martin Hawlisch" ctrl="force" easy="false" id="martin73" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="113" _title="Robbery" _xpath="enigma_iv/ant29_1" author="Petr Machata" ctrl="force" easy="false" id="ant29" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="113" _title="Robbery" _xpath="enigma_iv/ant29_2" author="Petr Machata" ctrl="force" easy="false" id="ant29" rel="2" rev="1" score="2" target="time" unit="duration"/>
     <level _seq="114" _title="Go!" _xpath="enigma_iv/ant02_1" author="Petr Machata" ctrl="force" easy="false" id="ant02" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="115" _title="Laser Magic" _xpath="enigma_ii/ant30_1" author="Petr Machata" ctrl="force" easy="false" id="ant30" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="116" _title="Cannonball" _xpath="enigma_iv/ant11_1" author="Petr Machata" ctrl="force" easy="false" id="ant11" rel="1" rev="0" score="1" target="time" unit="duration"/>

Modified: branches/1.0/data/levels/enigma_cross/enigma0_92_3.xml
===================================================================
--- branches/1.0/data/levels/enigma_cross/enigma0_92_3.xml	2007-04-04 21:53:28 UTC (rev 680)
+++ branches/1.0/data/levels/enigma_cross/enigma0_92_3.xml	2007-04-05 14:25:46 UTC (rev 681)
@@ -34,7 +34,7 @@
     <level _seq="26" _title="Blocks and Water" _xpath="enigma_iii/duffy99_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy99" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="27" _title="Island Paradise" _xpath="enigma_i/duffy100_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy100" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="28" _title="Variety Pack" _xpath="enigma_i/duffy101_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy101" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="29" _title="Pneumatic Delivery" _xpath="enigma_v/malla01_1" author="Manuel K?nig" ctrl="force" easy="false" id="malla01" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="29" _title="Pneumatic Delivery" _xpath="enigma_v/malla01_2" author="Manuel K?nig" ctrl="force" easy="true" id="malla01" rel="2" rev="2" score="2" target="time" unit="duration"/>
     <level _seq="30" _title="Pentomino I" _xpath="enigma_ii/ralf16_1" author="Ralf Westram" ctrl="force" easy="false" id="ralf_pento1" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="31" _title="Pentomino II" _xpath="enigma_ii/ralf17_1" author="Ralf Westram" ctrl="force" easy="false" id="ralf_pento2" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="32" _title="Pentomino III" _xpath="enigma_ii/ralf18_1" author="Ralf Westram" ctrl="force" easy="false" id="ralf_pento3" rel="1" rev="0" score="1" target="time" unit="duration"/>
@@ -64,7 +64,7 @@
     <level _seq="56" _title="Electric Meditation" _xpath="enigma_iv/duffy123_1" author="Jacob Scott" ctrl="force" easy="true" id="duffy123" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="57" _title="Worse Nightmare" _xpath="enigma_iv/duffy124_1" author="Jacob Scott" ctrl="force" easy="true" id="duffy124" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="58" _title="Triple-Maze" _xpath="enigma_iv/duffy125_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy125" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="59" _title="Elaborate" _xpath="enigma_v/duffy126_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy126" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="59" _title="Elaborate" _xpath="enigma_v/duffy126_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy126" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="60" _title="Now What?" _xpath="enigma_v/duffy127_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy127" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="61" _title="Patterns" _xpath="enigma_ii/duffy128_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy128" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="62" _title="Island Labyrinth" _xpath="enigma_v/duffy129_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy129" rel="1" rev="0" score="1" target="time" unit="duration"/>

Modified: branches/1.0/data/levels/enigma_cross/newlevels.xml
===================================================================
--- branches/1.0/data/levels/enigma_cross/newlevels.xml	2007-04-04 21:53:28 UTC (rev 680)
+++ branches/1.0/data/levels/enigma_cross/newlevels.xml	2007-04-05 14:25:46 UTC (rev 681)
@@ -107,7 +107,7 @@
     <level _seq="99" _title="Thievish Alleys" _xpath="enigma_v/andreas33_1" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas33" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="100" _title="Double play" _xpath="enigma_v/just06_1" author="JuSt" ctrl="force" easy="false" id="just06" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="101" _title="Oxyd-Puzzle" _xpath="enigma_v/raoul05_1" author="Raoul Bourquin" ctrl="force" easy="false" id="raoul05" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="102" _title="Keystone" _xpath="enigma_v/raoul12_1" author="Raoul Bourquin" ctrl="force" easy="true" id="raoul12" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="102" _title="Keystone" _xpath="enigma_v/raoul12_1" author="Raoul Bourquin" ctrl="force" easy="true" id="raoul12" rel="1" rev="2" score="1" target="time" unit="duration"/>
     <level _seq="103" _title="Print 23" _xpath="enigma_v/richi07_1" author="Richi B?tzer" ctrl="force" easy="false" id="richi07" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="104" _title="Laser Crossing" _xpath="enigma_v/luc24_1" author="Lukas Sch?ller" ctrl="force" easy="true" id="luc24" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="105" _title="The Carousel" _xpath="enigma_v/luc30_1" author="Lukas Sch?ller" ctrl="force" easy="false" id="luc30" rel="1" rev="0" score="1" target="time" unit="duration"/>

Modified: branches/1.0/data/levels/enigma_cross/newlevels_1.0.1.xml
===================================================================
--- branches/1.0/data/levels/enigma_cross/newlevels_1.0.1.xml	2007-04-04 21:53:28 UTC (rev 680)
+++ branches/1.0/data/levels/enigma_cross/newlevels_1.0.1.xml	2007-04-05 14:25:46 UTC (rev 681)
@@ -17,7 +17,7 @@
     <level _seq="9" _title="Counterclockwise" _xpath="enigma_vi/ulf05_1" author="Ulf Stegemann" ctrl="force" easy="true" id="20070126ulf020" rel="1" rev="93" score="1" target="time" unit="duration"/>
     <level _seq="10" _title="Check the light" _xpath="enigma_vi/just10_1" author="JuSt" ctrl="force" easy="false" id="just10" rel="1" rev="4" score="1" target="time" unit="duration"/>
     <level _seq="11" _title="Twokoban I" _xpath="enigma_vi/raoul28" author="Raoul Bourquin" ctrl="force" easy="true" id="raoul28" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="12" _title="The passage" _xpath="enigma_vi/just11_1" author="JuSt" ctrl="force" easy="false" id="just11" rel="1" rev="4" score="1" target="time" unit="duration"/>
+    <level _seq="12" _title="The passage" _xpath="enigma_vi/just11_1" author="JuSt" ctrl="force" easy="false" id="just11" rel="1" rev="5" score="1" target="time" unit="duration"/>
     <level _seq="13" _title="Magic triangle" _xpath="enigma_vi/just13_1" author="JuSt" ctrl="force" easy="false" id="just13" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="14" _title="Revolver" _xpath="enigma_vi/ral16_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20070214ral703" rel="1" rev="59" score="1" target="time" unit="duration"/>
     <level _seq="15" _title="Devil's bolder" _xpath="enigma_vi/just14_1" author="JuSt" ctrl="force" easy="true" id="just14" rel="1" rev="2" score="1" target="time" unit="duration"/>
@@ -26,6 +26,11 @@
     <level _seq="18" _title="Polar Bears Paradise" _xpath="enigma_vi/ral19_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20070314ral394" rel="1" rev="63" score="1" target="time" unit="duration"/>
     <level _seq="19" _title="Your friend, the light" _xpath="enigma_vi/just15_1" author="JuSt" ctrl="force" easy="true" id="just15" rel="1" rev="2" score="1" target="time" unit="duration"/>
     <level _seq="20" _title="jumping ball flash" _xpath="enigma_vi/illmind13_1" author="illmind" ctrl="force" easy="false" id="2007ill001" rel="1" rev="3" score="1" target="time" unit="duration"/>
+    <level _seq="21" _title="Cold Meditation" _xpath="enigma_vi/ral18_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20070314ral728" rel="1" rev="67" score="1" target="time" unit="duration"/>
+    <level _seq="22" _title="Same task ..." _xpath="enigma_vi/raoul29_1" author="Raoul Bourquin" ctrl="force" easy="true" id="raoul29" rel="1" rev="2" score="1" target="time" unit="duration"/>
+    <level _seq="23" _title="Industrial puzzles" _xpath="enigma_vi/raoul30_1" author="Raoul Bourquin" ctrl="force" easy="false" id="raoul30" rel="1" rev="3" score="1" target="time" unit="duration"/>
+    <level _seq="24" _title="Odyssey" _xpath="enigma_vi/ant39_1" author="Petr Machata" ctrl="force" easy="false" id="ant39" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="25" _title="Tandem Chess" _xpath="enigma_vi/luc34_1" author="Lukas Sch?ller" ctrl="force" easy="false" id="luc342007" rel="1" rev="1" score="1" target="time" unit="duration"/>
   </levels>
 
 </index>

Deleted: branches/1.0/data/levels/enigma_iv/ant29_1.xml
===================================================================
--- branches/1.0/data/levels/enigma_iv/ant29_1.xml	2007-04-04 21:53:28 UTC (rev 680)
+++ branches/1.0/data/levels/enigma_iv/ant29_1.xml	2007-04-05 14:25:46 UTC (rev 681)
@@ -1,69 +0,0 @@
-<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
-<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
-  <el:protected>
-    <el:info el:type="level">
-      <el:identity el:title="Robbery" el:subtitle="" el:id="ant29"/>
-      <el:version el:score="1" el:release="1" el:revision="0" el:status="released"/>
-      <el:author  el:name="Petr Machata" el:email="" el:homepage=""/>
-      <el:copyright>Copyright ? 2003 Petr Machata</el:copyright>
-      <el:license el:type="GPL v2.0 or above" el:open="true"/>
-      <el:compatibility el:enigma="0.92">
-       <el:dependency el:path="lib/ant" el:id="lib/ant" el:release="1" el:preload="true"/>
-      </el:compatibility>
-      <el:modes el:easy="false" el:single="true" el:network="false"/>
-      <el:comments>
-        <el:code>Lua 5.1 and XML converted by Leveladministrators</el:code>
-      </el:comments>
-      <el:score el:easy="-" el:difficult="-"/>
-    </el:info>
-    <el:luamain><![CDATA[
-function f_doorA() send_group_message(doorsA, "openclose") end
-
-floor = cell{floor="fl-himalaya"}
-stone = cell{stone="st-rock4"}
-actor = cell{actor={"ac-blackball", {player=0}}}
-doorsA = {}
-doorA = cell{{{add_multistone, "st-door_a", doorsA, {type="v"}}}}
-cslt1 = cell{stone={"st-coinslot", {action="callback", target="f_doorA"}}}
-coin1 = cell{item= {"it-coin1"}}
-coin2 = cell{item= {"it-coin2"}}
-coin3 = cell{item= {"it-coin4"}}
-coinr = cell{{{randomfloor, {coin1, coin2, coin3}}}}
-crack3 = cell{item= {"it-crack3", {fixed=1}}}
-crack2 = cell{item= {"it-crack1", {fixed=1}}}
-spring = cell{item= "it-spring2"}
-
-create_world(20, 13)
-oxyd_default_flavor = "a"
-fill_world_func(floor)
-draw_border_func(stone)
-draw_func(abyss, {13,0}, {0,1}, 13)
-for i=0,4 do draw_func(coinr, {14+i,6-i}, {0,1}, 2*i+1) end
-draw_func(stone, {12,1}, {0,1}, 3)
-draw_func(stone, {12,11}, {0,-1}, 3)
-draw_func(stone, {14,1}, {0,1}, 3)
-draw_func(stone, {14,11}, {0,-1}, 3)
-
-set_funcs(oxyd, {{1,1},{1,11},{11,1},{11,11}})
-set_funcs(stone, {{1,2},{2,2},{1,10},{2,10},{11,2},{10,2},{11,10},{10,10}})
-set_funcs(doorA, {{2,1},{2,11},{10,1},{10,11}})
-cslt1(6,6)
-coin1(8,7)
-
-crack3(11,9)
-crack2(10,9)
-crack2(11,8)
-spring(10,11)
-
-actor(5,5)
-
-oxyd_shuffle()
-enigma.ConserveLevel = FALSE
-    ]]></el:luamain>
-    <el:i18n>
-      <el:string el:key="title">
-        <el:english el:translate="false"/>
-      </el:string>
-    </el:i18n>
-  </el:protected>
-</el:level>

Added: branches/1.0/data/levels/enigma_iv/ant29_2.xml
===================================================================
--- branches/1.0/data/levels/enigma_iv/ant29_2.xml	2007-04-04 21:53:28 UTC (rev 680)
+++ branches/1.0/data/levels/enigma_iv/ant29_2.xml	2007-04-05 14:25:46 UTC (rev 681)
@@ -0,0 +1,87 @@
+<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
+<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
+  <el:protected>
+    <el:info el:type="level">
+      <el:identity el:title="Robbery" el:subtitle="" el:id="ant29"/>
+      <el:version el:score="2" el:release="2" el:revision="1" el:status="released"/>
+      <el:author  el:name="Petr Machata" el:email="" el:homepage=""/>
+      <el:copyright>Copyright ? 2003 Petr Machata</el:copyright>
+      <el:license el:type="GPL v2.0 or above" el:open="true"/>
+      <el:compatibility el:enigma="0.92">
+       <el:dependency el:path="lib/ant" el:id="lib/ant" el:release="1" el:preload="true"/>
+      </el:compatibility>
+      <el:modes el:easy="false" el:single="true" el:network="false"/>
+      <el:comments>
+        <el:code>Lua 5.1 and XML converted by Leveladministrators</el:code>
+      </el:comments>
+      <el:score el:easy="-" el:difficult="-"/>
+    </el:info>
+    <el:luamain><![CDATA[
+function f_doorA() send_group_message(doorsA, "openclose") end
+function f_doorB() send_group_message(doorsB, "openclose") end
+
+floor = cell{floor="fl-himalaya"}
+stone = cell{stone="st-rock4"}
+actor = cell{actor={"ac-blackball", {player=0}}}
+
+doorsA = {}
+doorsB = {}
+doorA = cell{{{add_multistone, "st-door_a", doorsA, {type="v"}}}}
+doorB = cell{{{add_multistone, "st-door_a", doorsB, {type="v"}}}}
+
+cslt1 = cell{stone={"st-coinslot", {action="callback", target="f_doorA"}}}
+cslt2 = cell{stone={"st-coinslot", {action="callback", target="f_doorB"}}}
+
+coin1 = cell{item= {"it-coin1"}}
+coin2 = cell{item= {"it-coin2"}}
+coin3 = cell{item= {"it-coin4"}}
+coinr = cell{{{randomfloor, {coin1, coin2, coin3}}}}
+
+crack3 = cell{item= {"it-crack3", {fixed=1}}}
+crack2 = cell{item= {"it-crack1", {fixed=1}}}
+
+create_world(20, 13)
+oxyd_default_flavor = "a"
+
+fill_world_func(floor)
+
+draw_border_func(stone)
+draw_func(abyss, {13,0}, {0,1}, 13)
+
+for i=0,4 do draw_func(coinr, {14+i,6-i}, {0,1}, 2*i+1) end
+
+draw_func(stone, {12,1}, {0,1}, 3)
+draw_func(stone, {12,11}, {0,-1}, 3)
+draw_func(stone, {14,1}, {0,1}, 3)
+draw_func(stone, {14,11}, {0,-1}, 3)
+
+set_funcs(oxyd, {{1,1},{1,11},{11,1},{11,11}})
+set_funcs(stone, {{1,2},{2,2},{1,10},{2,10},{11,2},{10,2},{11,10},{10,10}})
+
+set_funcs(doorA, {{2,1},{10,11}})
+set_funcs(doorB, {{2,11},{10,1}})
+
+cslt1(6,4)
+cslt2(6,8)
+
+coin1(8,7)
+
+crack3(11,9)
+crack2(10,9)
+crack2(11,8)
+
+set_item("it-spring2",10,11)
+set_item("it-spring2",10,1)
+
+actor(5,5)
+
+oxyd_shuffle()
+enigma.ConserveLevel = FALSE
+    ]]></el:luamain>
+    <el:i18n>
+      <el:string el:key="title">
+        <el:english el:translate="false"/>
+      </el:string>
+    </el:i18n>
+  </el:protected>
+</el:level>


Property changes on: branches/1.0/data/levels/enigma_iv/ant29_2.xml
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: branches/1.0/data/levels/enigma_iv/index.xml
===================================================================
--- branches/1.0/data/levels/enigma_iv/index.xml	2007-04-04 21:53:28 UTC (rev 680)
+++ branches/1.0/data/levels/enigma_iv/index.xml	2007-04-05 14:25:46 UTC (rev 681)
@@ -32,7 +32,7 @@
     <level _seq="24" _title="Tunnels" _xpath="./martin82_1" author="Martin Hawlisch" ctrl="force" easy="false" id="martin82" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="25" _title="Light Switches" _xpath="./siegfried24_1" author="Siegfried Fennig" ctrl="force" easy="false" id="level8e" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="26" _title="The Tomb" _xpath="./ant04_1" author="Petr Machata" ctrl="force" easy="false" id="ant04" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="27" _title="Robbery" _xpath="./ant29_1" author="Petr Machata" ctrl="force" easy="false" id="ant29" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="27" _title="Robbery" _xpath="./ant29_2" author="Petr Machata" ctrl="force" easy="false" id="ant29" rel="2" rev="1" score="2" target="time" unit="duration"/>
     <level _seq="28" _title="The Life Game" _xpath="./alain13_1" author="Alain Busser" ctrl="force" easy="false" id="alain13" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="29" _title="Where is it?" _xpath="./barry02_1" author="Barry &amp; Lori Mead" ctrl="force" easy="false" id="barry02" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="30" _title="- Meditation -" _xpath="./ant23_1" author="Petr Machata" ctrl="force" easy="false" id="ant23" rel="1" rev="0" score="1" target="time" unit="duration"/>

Modified: branches/1.0/data/levels/enigma_v/duffy126_1.xml
===================================================================
--- branches/1.0/data/levels/enigma_v/duffy126_1.xml	2007-04-04 21:53:28 UTC (rev 680)
+++ branches/1.0/data/levels/enigma_v/duffy126_1.xml	2007-04-05 14:25:46 UTC (rev 681)
@@ -3,7 +3,7 @@
   <el:protected>
     <el:info el:type="level">
       <el:identity el:title="Elaborate" el:subtitle="" el:id="duffy126"/>
-      <el:version el:score="1" el:release="1" el:revision="0" el:status="released"/>
+      <el:version el:score="1" el:release="1" el:revision="1" el:status="released"/>
       <el:author  el:name="Jacob Scott" el:email="" el:homepage=""/>
       <el:copyright>Copyright ? 2004 Jacob Scott</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
@@ -39,19 +39,19 @@
             set_item("it-pin",i-1,line)
         elseif c =="s" then
             set_stone( "st-greenbrown", i-1, line)
-           set_floor("fl-inverse",i-1,line)
+            set_floor("fl-inverse",i-1,line)
         elseif c =="G" then
-       set_stone( "st-fakeoxyda", i-1, line)
+            set_stone( "st-fakeoxyda", i-1, line)
         elseif c =="|" then
-       set_stone( "st-fakeoxyda", i-1, line)
-       set_item("it-cherry",i-1,line)
+            set_stone( "st-fakeoxyda", i-1, line)
+            set_item("it-cherry",i-1,line)
         elseif c =="e" then
-           set_stone("st-glass2_hole",i-1,line)
-             set_item("it-vortex-open", i-1, line, {targetx="22.5",targety="52.5"})
+            set_stone("st-glass2_hole",i-1,line)
+            set_item("it-vortex-open", i-1, line, {targetx="22.5",targety="52.5"})
         elseif c =="I" then
-             set_item("it-vortex-open", i-1, line, {targetx="1.5",targety="54.5"})
+            set_item("it-vortex-open", i-1, line, {targetx="1.5",targety="54.5"})
         elseif c =="," then
-             set_item("it-vortex-open", i-1, line)
+            set_item("it-vortex-open", i-1, line)
         elseif c =="?" then
             set_stone( "st-greenbrown", i-1, line)
             set_floor("fl-ice",i-1,line)
@@ -67,23 +67,31 @@
         elseif c =="V" then
             set_stone( "st-brick_magic", i-1, line)
         elseif c =="`" then
-           set_stone( "st-bigbrick-nw", i-1, line)
+            set_stone( "st-bigbrick-nw", i-1, line)
         elseif c =="@" then
-           set_stone( "st-bigbrick-ne", i-1, line)
+            set_stone( "st-bigbrick-ne", i-1, line)
         elseif c =="^" then
-           set_stone( "st-bigbrick-es", i-1, line)
+            set_stone( "st-bigbrick-es", i-1, line)
         elseif c =="-" then
-           set_stone( "st-bigbrick-sw", i-1, line)
+            set_stone( "st-bigbrick-sw", i-1, line)
         elseif c =="8" then
-           set_stone( "st-bigbrick-n", i-1, line)
+            set_stone( "st-bigbrick-n", i-1, line)
         elseif c =="6" then
-           set_stone( "st-bigbrick-e", i-1, line)
+            set_stone( "st-bigbrick-e", i-1, line)
         elseif c =="." then
-           set_stone( "st-bigbrick-s", i-1, line)
+            set_stone( "st-bigbrick-s", i-1, line)
         elseif c ==";" then
-           set_stone( "st-bigbrick-w", i-1, line)
+            set_stone( "st-bigbrick-w", i-1, line)
         elseif c ==":" then
-           set_stone( "st-bigbrick-nesw", i-1, line)
+            set_stone( "st-bigbrick-nesw", i-1, line)
+        elseif c =="[" then
+            set_stone( "st-bigbrick-nes", i-1, line)
+        elseif c =="]" then
+            set_stone( "st-bigbrick-nsw", i-1, line)
+        elseif c =="(" then
+            set_stone( "st-bigbrick-esw", i-1, line)
+        elseif c ==")" then
+            set_stone( "st-bigbrick-new", i-1, line)
         elseif c =="t" then
             set_stone( "st-brick_magic", i-1, line)
             set_item("it-surprise",i-1,line)
@@ -124,26 +132,26 @@
             set_floor("fl-normal",i-1,line)
         elseif c == "*" then
             set_stone( "st-brownie", i-1, line)
-                elseif c == "!" then
+        elseif c == "!" then
             abyss(i-1,line)
         elseif c == "~" then
-           set_floor("fl-water",i-1,line)
+            set_floor("fl-water",i-1,line)
         elseif c=="z" then
-           set_actor("ac-blackball", i-1,line+.5, {player=0,essential=1})
+            set_actor("ac-blackball", i-1,line+.5, {player=0,essential=1})
         elseif c=="y" then
-           set_actor("ac-whiteball", i-.5,line+.5, {player=1,essential=1})
+            set_actor("ac-whiteball", i-.5,line+.5, {player=1,essential=1})
         elseif c=="w" then
-           set_actor("ac-killerball", i-.5,line+.5, {player=1,mouseforce=0})
+            set_actor("ac-killerball", i-.5,line+.5, {player=1,mouseforce=0})
             set_floor("fl-ice",i-1,line)
         elseif c=="R" then
-           set_actor("ac-rotor", i-.5,line+.5, {force=30,range=8})
+            set_actor("ac-rotor", i-.5,line+.5, {force=30,range=8})
         elseif c=="N" then
-           set_actor("ac-top", i-1,line+.5, {force=40,range=9})
-           set_item("it-cherry",i-1,line)
+            set_actor("ac-top", i-1,line+.5, {force=40,range=9})
+            set_item("it-cherry",i-1,line)
         elseif c==">" then
-           set_item("it-cherry",i-1,line)
+            set_item("it-cherry",i-1,line)
         elseif c=="b" then
-           set_actor("ac-bug", i-.5,line+.5)
+            set_actor("ac-bug", i-.5,line+.5)
             set_floor("fl-sand",i-1,line)
         elseif c == "g" then
             draw_stones("st-grate1",{i-1,line}, {1,1}, 1)
@@ -160,14 +168,14 @@
         elseif c=="j" then
             set_floor("fl-hay",i-1,line)
         elseif c=="q" then
-           set_floor("fl-sand",i-1,line)
+            set_floor("fl-sand",i-1,line)
         elseif c=="m" then
-           set_floor("fl-swamp",i-1,line)
+            set_floor("fl-swamp",i-1,line)
         elseif c=="Q" then
-           set_floor("fl-inverse",i-1,line)
+            set_floor("fl-inverse",i-1,line)
         elseif c=="p" then
-           set_floor("fl-swamp",i-1,line)
-           set_item("it-extralife",i-1,line)
+            set_floor("fl-swamp",i-1,line)
+            set_item("it-extralife",i-1,line)
         elseif c=="_" then
             fill_floor("fl-brick",i-1,line,18,11)
         elseif c=="Z" then
@@ -209,7 +217,7 @@
             set_floor("fl-gradient",  i-1,  line, {type=10})
         elseif c=="U" then
             set_stone("st-bolder", i-1,line, {direction=NORTH})
-           set_floor("fl-water",i-1,line)
+            set_floor("fl-water",i-1,line)
         elseif c=="4" then
             yy1( "white",  i-1, line)
             set_floor("fl-gradient",  i-1,  line, {type=4})
@@ -232,14 +240,14 @@
         elseif c=="k" then
             set_attrib(laser(i-1,line, TRUE, NORTH), "name", "laser1")
         elseif c=="E" then
-           document(i-1,line,"text1")
-         end
-    end    
-     end
+            document(i-1,line,"text1")
+        end
+    end
+end
 
 function yy1( color, x, y)
-        stone = format( "st-%s4", color)
-        set_stone( stone, x, y)
+    stone = format( "st-%s4", color)
+    set_stone( stone, x, y)
 end
 
 renderLine(00,"#######################################??????????????????#hhhhhhhhhhhhhhhhhhh")
@@ -268,15 +276,15 @@
 renderLine(23,"h                  #       #  #       #qqqqqqqqqqqqqqqq9u%               !! #")
 renderLine(24,"hHhHhHhHhHhHhHhHhHh#########  #########$$$$$$$$$$$$$$$$$$$############ ######")
 renderLine(25,"#HhHhHhHhHhHhHhHhHh#                  #_                 &jjjjjjjjjjjjjjjjjj&")
-renderLine(26,"#HHHHHHHHHHHHHHHHHH#                  #  `88@ `88@ `88@  &jjjjjjjjjjjjjjjjjj&")
-renderLine(27,"#HHHHHHHHHHHHHHHHHH#                  #  ;::6 ;::6 ;::6  &jjjjjjjjjjjjjjjjjj&")
-renderLine(28,"#HHHHHHHHHHHHHHHHHH#                  #  ;::6 ;::6 ;::6  &jjjjjjjjjjjjjjjjjj&")
-renderLine(29,"#HHHHHHHHHHHHHHHHHH#vvvvvvvvvvvvvvvvvv#  -..^ -..^ -..^  &jjjjjjjjjjjjjjjjjj&")
+renderLine(26,"#HHHHHHHHHHHHHHHHHH#                  #  ^((- ^((- ^((-  &jjjjjjjjjjjjjjjjjj&")
+renderLine(27,"#HHHHHHHHHHHHHHHHHH#                  #  [^-] [^-] [^-]  &jjjjjjjjjjjjjjjjjj&")
+renderLine(28,"#HHHHHHHHHHHHHHHHHH#                  #  [@`] [@`] [@`]  &jjjjjjjjjjjjjjjjjj&")
+renderLine(29,"#HHHHHHHHHHHHHHHHHH#vvvvvvvvvvvvvvvvvv#  @))` @))` @))`  &jjjjjjjjjjjjjjjjjj&")
 renderLine(30,"#HHHHHHHHHHHHHHHHHH#vvvvvvvvvvvvvvvvvv#o       >N        &jjjjjjjjjjjjjjjjjj&")
-renderLine(31,"#HHHHHHHHHHHHHHHHHH#vvvvvvvvvvvvvvvvvv#  `88@ `88@ `88@  Cjjjjjjjjjjjjjjjjjj&")
-renderLine(32,"#HTHHHHHHHHHHHHHHHH#vvvVVVvvvvvvvvvVVV#  ;::6 ;::6 ;::6  Ajjjjjjjjjjjjjjjjjj&")
-renderLine(33,"#HHHHHHHHHHHHHHHHHH#vvvV/VvvvvvvvvvVVV#  ;::6 ;::6 ;::6  &jjjjjjjjjjjjjjjjjj&")
-renderLine(34,"#HHHHHHHHHHHHHHHHoH#vvvVVVvvvvvvvvvvvv#  -..^ -..^ -..^  &jjjjjjjjjjjjjjjjJj&")
+renderLine(31,"#HHHHHHHHHHHHHHHHHH#vvvvvvvvvvvvvvvvvv#  ^((- ^((- ^((-  Cjjjjjjjjjjjjjjjjjj&")
+renderLine(32,"#HTHHHHHHHHHHHHHHHH#vvvVVVvvvvvvvvvVVV#  [^-] [^-] [^-]  Ajjjjjjjjjjjjjjjjjj&")
+renderLine(33,"#HHHHHHHHHHHHHHHHHH#vvvV/VvvvvvvvvvVVV#  [@`] [@`] [@`]  &jjjjjjjjjjjjjjjjjj&")
+renderLine(34,"#HHHHHHHHHHHHHHHHoH#vvvVVVvvvvvvvvvvvv#  @))` @))` @))`  &jjjjjjjjjjjjjjjjJj&")
 renderLine(35,"#HHHHHHHHHHHHHHHHHH#vvvvvvvvvvvvvvvvvv#                  &jjjjjjjjjjjjjjjjjj&")
 renderLine(36,"###############%%###vvvvvvvvvvvVVvvvVV###################&&&&&&&&&&&&&&&&&%%%")
 renderLine(37,"#              rr  #vvvvvvvvvvvVVvvvVV#vvvvvVVvvvvVVvvvvv#      U         4<%")
@@ -322,7 +330,7 @@
       </el:string>
       <el:string el:key="text1">
         <el:english el:translate="true">It is not quite that easy.</el:english>
-      </el:string> 
+      </el:string>
     </el:i18n>
   </el:protected>
 </el:level>

Modified: branches/1.0/data/levels/enigma_v/index.xml
===================================================================
--- branches/1.0/data/levels/enigma_v/index.xml	2007-04-04 21:53:28 UTC (rev 680)
+++ branches/1.0/data/levels/enigma_v/index.xml	2007-04-05 14:25:46 UTC (rev 681)
@@ -27,7 +27,7 @@
     <level _seq="19" _title="Oxyd-Puzzle" _xpath="./raoul05_1" author="Raoul Bourquin" ctrl="force" easy="false" id="raoul05" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="20" _title="- Meditation -" _xpath="./ralf12_1" author="Ralf Westram" ctrl="force" easy="true" id="ralf12" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="21" _title="Plan Ahead" _xpath="./duffy114_1" author="Jacob Scott" ctrl="force" easy="true" id="duffy114" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="22" _title="Keystone" _xpath="./raoul12_1" author="Raoul Bourquin" ctrl="force" easy="true" id="raoul12" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="22" _title="Keystone" _xpath="./raoul12_1" author="Raoul Bourquin" ctrl="force" easy="true" id="raoul12" rel="1" rev="2" score="1" target="time" unit="duration"/>
     <level _seq="23" _title="Print 23" _xpath="./richi07_1" author="Richi B?tzer" ctrl="force" easy="false" id="richi07" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="24" _title="Space Pirates" _xpath="./siegfried19_2" author="Siegfried Fennig" ctrl="force" easy="false" id="level6a" rel="2" rev="0" score="2" target="time" unit="duration"/>
     <level _seq="25" _title="Laser Crossing" _xpath="./luc24_1" author="Lukas Sch?ller" ctrl="force" easy="true" id="luc24" rel="1" rev="0" score="1" target="time" unit="duration"/>
@@ -64,13 +64,13 @@
     <level _seq="56" _title="Banana Republic" _xpath="./alain26_1" author="Alain Busser" ctrl="force" easy="true" id="alain26" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="57" _title="Too Heavy?" _xpath="./martin101_1" author="Martin Hawlisch" ctrl="force" easy="true" id="martin101" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="58" _title="Now What?" _xpath="./duffy127_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy127" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="59" _title="Pneumatic Delivery" _xpath="./malla01_1" author="Manuel K?nig" ctrl="force" easy="false" id="malla01" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="59" _title="Pneumatic Delivery" _xpath="./malla01_2" author="Manuel K?nig" ctrl="force" easy="true" id="malla01" rel="2" rev="2" score="2" target="time" unit="duration"/>
     <level _seq="60" _title="Jumpin' Jack Flash" _xpath="./ss10_1" author="Sven Siggelkow" ctrl="force" easy="true" id="ss10" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="61" _title="Venice I" _xpath="./raoul16_1" author="Raoul Bourquin" ctrl="force" easy="false" id="raoul16" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="62" _title="No way out?" _xpath="./just08_1" author="JuSt" ctrl="force" easy="false" id="just08" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="63" _title="Venice II" _xpath="./raoul17_1" author="Raoul Bourquin" ctrl="force" easy="false" id="raoul17" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="64" _title="Walking around" _xpath="./just05_2" author="JuSt" ctrl="force" easy="false" id="just05" rel="2" rev="1" score="2" target="time" unit="duration"/>
-    <level _seq="65" _title="Elaborate" _xpath="./duffy126_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy126" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="65" _title="Elaborate" _xpath="./duffy126_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy126" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="66" _title="Trigger Happy" _xpath="./xerxes03_1" author="Xerxes M. Dynatos" ctrl="force" easy="false" id="xerxes03" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="67" _title="Gods of Enigma" _xpath="./mp01_1" author="moonpearl" ctrl="force" easy="false" id="mp01" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="68" _title="Stealing from Thieves" _xpath="./duffy78_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy78" rel="1" rev="0" score="1" target="time" unit="duration"/>

Deleted: branches/1.0/data/levels/enigma_v/malla01_1.xml
===================================================================
--- branches/1.0/data/levels/enigma_v/malla01_1.xml	2007-04-04 21:53:28 UTC (rev 680)
+++ branches/1.0/data/levels/enigma_v/malla01_1.xml	2007-04-05 14:25:46 UTC (rev 681)
@@ -1,235 +0,0 @@
-<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
-<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
-  <el:protected>
-    <el:info el:type="level">
-      <el:identity el:title="Pneumatic Delivery" el:subtitle="" el:id="malla01"/>
-      <el:version el:score="1" el:release="1" el:revision="1" el:status="released"/>
-      <el:author  el:name="Manuel K?nig" el:email="" el:homepage=""/>
-      <el:copyright>Copyright ? 2004 Manuel K?nig</el:copyright>
-      <el:license el:type="GPL v2.0 or above" el:open="true"/>
-      <el:compatibility el:enigma="0.92">
-       <el:dependency el:path="lib/ant" el:id="lib/ant" el:release="1" el:preload="true"/>
-      </el:compatibility>
-      <el:modes el:easy="false" el:single="true" el:network="false"/>
-      <el:comments>
-        <el:code>Lua 5.1 and XML converted by Leveladministrators</el:code>
-      </el:comments>
-      <el:score el:easy="-" el:difficult="-"/>
-    </el:info>
-    <el:luamain><![CDATA[
-multiplayer_mode()
-
-world.DefineSimpleStone("st-c-invisible_grate","st-stone",1,0)
-display.DefineAlias("st-c-invisible_grate","st-invisible")
-
-cells={}
-cells[" "]=cell{floor="fl-wood"}
-cells["+"]=cell{item="it-seed_nowood"}
-cells["#"]=cell{stone="st-rock5"}
-cells["A"]=cell{stone="st-black4"}
-cells["a"]=cell{stone="st-white4"}
-cells["B"]=cell{stone="st-mail-n"}
-cells["b"]=cell{stone="st-mail-e"}
-cells["C"]=cell{stone="st-mail-s"}
-cells["c"]=cell{stone="st-turnstile", floor="fl-abyss"}
-cells["D"]=cell{stone="st-turnstile-n", floor="fl-abyss"}
-cells["d"]=cell{stone="st-turnstile-e", floor="fl-abyss"}
-cells["E"]=cell{stone="st-turnstile-s", floor="fl-abyss"}
-cells["e"]=cell{stone="st-turnstile-w", floor="fl-abyss"}
-cells["F"]=cell{item="it-puller-n"}
-cells["f"]=cell{item="it-puller-e"}
-cells["G"]=cell{item="it-puller-s"}
-cells["g"]=cell{item="it-puller-w"}
-cells["H"]=cell{stone="st-stoneimpulse"}
-cells["h"]=cell{stone={"st-fourswitch", {action="callback", target="mirrorswitch"}}}
-cells["I"]=cell{stone="st-shogun-l"}
-cells["i"]=cell{stone="st-shogun-m"}
-cells["J"]=cell{stone="st-shogun-s", item={"it-shogun-l", {target="door2", action="openclose"}}}
-cells["j"]=cell{stone="st-rotator_move-left"}
-cells["k"]=cell{item={"it-document", {text="text1"}}}
-cells["L"]=cell{stone={"st-laser-e", {name="laser", on=FALSE}}}
-cells["l"]=cell{stone={"st-switch_white", {target="laser", on=FALSE, action="onoff"}}}
-cells["N"]=cell{item="it-pipe-ne"}
-cells["Q"]=cell{stone={"st-laserswitch", {action="callback", target="lasertrigger1"}}}
-cells["q"]=cell{stone={"st-laserswitch", {action="callback", target="lasertrigger2"}}}
-cells["R"]=cell{stone={"st-laserswitch", {action="callback", target="lasertrigger3"}}}
-cells["r"]=cell{stone={"st-laserswitch", {action="callback", target="lasertrigger4"}}}
-cells["S"]=cell{stone={"st-door", {type="v", name="door2"}}}
-cells["s"]=cell{stone={"st-door", {type="h", name="door3"}}}
-cells["T"]=cell{stone={"st-door", {type="v", name="door1"}}}
-cells["t"]=cell{stone={"st-pmirror", {movable=0, transparent=0, orientation=2}}}
-cells["U"]=cell{stone={"st-pmirror", {movable=0, transparent=1, orientation=4}}}
-cells["u"]=cell{stone={"st-3mirror", {movable=0, transparent=0, orientation=1}}}
-cells["V"]=cell{stone={"st-3mirror", {movable=0, transparent=0, orientation=2}}}
-cells["v"]=cell{stone={"st-pmirror", {movable=1, transparent=0, orientation=1}}}
-cells["w"]=cell{item={"it-trigger", {action="callback", target="trigger1"}}}
-cells["X"]=cell{stone="st-grate2"}
-cells["x"]=cell{stone="st-grate3"}
-cells["Y"]=cell{stone={"st-pmirror", {movable=0, transparent=0, orientation=4, name="mirror1"}}}
-cells["y"]=cell{stone={"st-switch_black", {action="callback", target="stonedoor"}}}
-cells["Z"]=cell{item={"it-trigger", {action="callback", target="trigger2"}}}
-cells["z"]=cell{item={"it-trigger", {action="callback", target="trigger3"}}}
-cells["*"]=cell{stone={"st-door_c", {name="door4"}}}
-cells[","]=cell{floor="fl-water"}
-cells["3"]=cell{stone="st-c-invisible_grate"}
-puzzles2 = {}
-cells["?"]=cell{parent={{add_multicell, puzzles2}}}
-
-if (difficult) then
-cells["n"]=cell{item="it-pipe-sw"}
-cells["P"]=cell{item="it-hammer"}
-cells["p"]=cell{stone="st-stone_break"}
-cells["K"]=cell{stone="st-knight"}
-cells["$"]=cells["?"]
-cells["m"]=cell{item="it-pipe-v"}
-cells["M"]=cell{item="it-pipe-h"}
-else
-cells["n"]=cells[" "]
-cells["P"]=cells[" "]
-cells["p"]=cells[" "]
-cells["K"]=cells[" "]
-cells["m"]=cells[" "]
-cells["M"]=cells[" "]
-end
-
-      level = {
-      --        1          2        3
-      --  012345678901234567890123456789012345678
-         "#######################################",
-         "# q      u  Q#    rxYx         #   #yM#",
-         "#            #     xxx     ## W wW ##n#",
-         "#L       U   X     x 1 v   # Wz Z#  Tm#",
-         "#            #  3$3A   ##### ### #  #k#",
-         "# t      V  R#???? #  Fb..##     #  #K#",
-         "#p############ ?N? #B###ecd#####C####0#",
-         "#s## X #  ,,I# ?m? #  #  . .........###",
-         "#mf# J H  j  X ????# 2# D. ec.. . ecd##",
-         "#G###H #i# # X3$3  #  ..cN. . .ec. .  #",
-         "#F#MPH   X # X     a    E+#ecdc ...#  #",
-         "#0hM S   X   #     #l0#####.. EG ..##K#",
-         "#####################################0#"
-      --  012345678901234567890123456789012345678
-      --        1          2        3
-      }
-
---        -- [STONE DOOR] --
-stonedoorswitchgreen=0
-function stonedoor()
-    if (stonedoorswitchgreen==0) then
-      stonedoorswitchgreen=1
-      set_stone("st-grate2", 31,1)
-    elseif (stonedoorswitchgreen==1) then
-      stonedoorswitchgreen=0
-      set_stone("st-rock5", 31,1)
-    end
-end
---        -- [/STONE DOOR] --
-
---        -- [THREE TRIGGERS] --
-local switchesdoor1={0, 0, 0}
-function trigger1 () triggerdoor1(1) end 
-function trigger2 () triggerdoor1(2) end 
-function trigger3 () triggerdoor1(3) end
-doorsopen1=0
-
-function triggerdoor1(num)
-   switchesdoor1[num] = 1-switchesdoor1[num]
-   alldoor1=1
-   for x=1,3 do
-      if (switchesdoor1[x]==0) then
-         alldoor1 = 0
-    end
-   end
-   if (doorsopen1==0 and alldoor1==1) then
-      enigma.SendMessage(d1, "open", nil)
-      doorsopen1 = 1
-   elseif (doorsopen1==1 and alldoor1==0) then
-      enigma.SendMessage(d1, "close", nil)
-      doorsopen1 = 0
-   end
-end
---       -- [/THREE TRIGGERS] --
-
---        -- [FOURSWITCH] --
-function mirrorswitch()
-    mir=enigma.GetNamedObject("mirror1")
-    enigma.SendMessage(mir, "turn", nil)
-end
---       -- [/FOURSWITCH] --
-
---        -- [LASERSWITCHES] --
-local switchesdoor3={0, 0, 0, 0}
-function lasertrigger1 () triggerdoor3(1) end 
-function lasertrigger2 () triggerdoor3(2) end 
-function lasertrigger3 () triggerdoor3(3) end
-function lasertrigger4 () triggerdoor3(4) end
-doorsopen3=0
-
-function triggerdoor3(num)
-   switchesdoor3[num] = 1-switchesdoor3[num]
-   allswitches3=1
-   for x=1,4 do
-      if (switchesdoor3[x]==0) then
-         allswitches3 = 0
-    end
-   end
-   if (doorsopen3==0 and allswitches3==1) then
-      enigma.SendMessage(d3, "open", nil)
-      doorsopen3 = 1
-   elseif (doorsopen3==1 and allswitches3==0) then
-      enigma.SendMessage(d3, "close", nil)
-      doorsopen3 = 0
-   end
-end
---       -- [/LASERSWITCHES] --
-
-      oxyd_default_flavor = "d"
-      set_default_parent(cells[" "])
-      create_world_by_map(level)
-
-      --       --  [PUZZLE] --
-function scramble(x,y,d) enigma.AddScramble(x,y,d) end
-enigma.SetScrambleIntensity(50)
-scramble(14,5,"e")
-scramble(15,5,"s")
-scramble(18,8,"w")
-scramble(17,8,"n")
---       -- [/PUZZLE] --
-
-d1=enigma.GetNamedObject("door1")
-d3=enigma.GetNamedObject("door3")
-render_puzzles(puzzles2, puzzle2)
-
-fill_floor("fl-water", 14,5, 4, 1)
-fill_floor("fl-water", 17,5, 1, 4)
-set_floor("fl-water",18,8)
-
-set_floor("fl-abyss",25,9)
-set_floor("fl-abyss",25,10)
-set_floor("fl-wood",27,8)
-set_floor("fl-wood",34,8)
-set_floor("fl-wood",36,8)
-
-if (not difficult) then
-set_item("it-pipe-sw",25,5)
-set_item("it-pipe-v",25,6)
-set_item("it-pipe-v",25,7)
-set_item("it-pipe-h",26,9)
-set_item("it-pipe-h",26,9)
-set_item("it-pipe-h",3,10)
-set_item("it-pipe-h",33,7)
-set_item("it-pipe-v",37,1)
-end
-
-oxyd_shuffle()
-    ]]></el:luamain>
-    <el:i18n>
-      <el:string el:key="title">
-        <el:english el:translate="false"/>
-      </el:string>
-      <el:string el:key="text1">
-        <el:english el:translate="true">This is my first landscape, dedicated to my father. I hope you'll enjoy it!</el:english>
-      </el:string> 
-    </el:i18n>
-  </el:protected>
-</el:level>

Copied: branches/1.0/data/levels/enigma_v/malla01_2.xml (from rev 673, branches/1.0/data/levels/enigma_v/malla01_1.xml)
===================================================================
--- branches/1.0/data/levels/enigma_v/malla01_1.xml	2007-03-29 17:10:15 UTC (rev 673)
+++ branches/1.0/data/levels/enigma_v/malla01_2.xml	2007-04-05 14:25:46 UTC (rev 681)
@@ -0,0 +1,238 @@
+<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
+<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
+  <el:protected>
+    <el:info el:type="level">
+      <el:identity el:title="Pneumatic Delivery" el:subtitle="" el:id="malla01"/>
+      <el:version el:score="2" el:release="2" el:revision="2" el:status="released"/>
+      <el:author  el:name="Manuel K?nig" el:email="" el:homepage=""/>
+      <el:copyright>Copyright ? 2004 Manuel K?nig</el:copyright>
+      <el:license el:type="GPL v2.0 or above" el:open="true"/>
+      <el:compatibility el:enigma="0.92">
+       <el:dependency el:path="lib/ant" el:id="lib/ant" el:release="1" el:preload="true"/>
+      </el:compatibility>
+      <el:modes el:easy="true" el:single="true" el:network="true"/>
+      <el:comments>
+        <el:code>Lua 5.1 and XML converted by Leveladministrators</el:code>
+      </el:comments>
+      <el:score el:easy="-" el:difficult="-"/>
+    </el:info>
+    <el:luamain><![CDATA[
+multiplayer_mode()
+
+world.DefineSimpleStone("st-c-invisible_grate","st-stone",1,0)
+display.DefineAlias("st-c-invisible_grate","st-invisible")
+
+cells={}
+cells[" "]=cell{floor="fl-wood"}
+cells["#"]=cell{stone="st-rock5"}
+cells["A"]=cell{stone="st-black4"}
+cells["a"]=cell{stone="st-white4"}
+cells["B"]=cell{stone="st-mail-n"}
+cells["b"]=cell{stone="st-mail-e"}
+cells["C"]=cell{stone="st-mail-s"}
+cells["c"]=cell{stone="st-turnstile", floor="fl-abyss"}
+cells["D"]=cell{stone="st-turnstile-n", floor="fl-abyss"}
+cells["d"]=cell{stone="st-turnstile-e", floor="fl-abyss"}
+cells["E"]=cell{stone="st-turnstile-s", floor="fl-abyss"}
+cells["e"]=cell{stone="st-turnstile-w", floor="fl-abyss"}
+cells["F"]=cell{item="it-puller-n"}
+cells["f"]=cell{item="it-puller-e"}
+cells["G"]=cell{item="it-puller-s"}
+cells["g"]=cell{item="it-puller-w"}
+cells["H"]=cell{stone="st-stoneimpulse"}
+cells["h"]=cell{stone={"st-fourswitch", {action="callback", target="mirrorswitch"}}}
+cells["i"]=cell{stone="st-shogun-m"}
+cells["I"]=cell{stone="st-shogun-l"}
+cells["J"]=cell{stone="st-shogun-s", item={"it-shogun-l", {target="door2", action="openclose"}}}
+cells["j"]=cell{stone="st-rotator_move-left"}
+cells["K"]=cell{stone="st-knight"}
+cells["k"]=cell{item={"it-document", {text="text1"}}}
+cells["L"]=cell{stone={"st-laser-e", {name="laser", on=FALSE}}}
+cells["l"]=cell{stone={"st-switch_white", {target="laser", on=FALSE, action="onoff"}}}
+cells["m"]=cell{item="it-pipe-v"}
+cells["M"]=cell{item="it-pipe-h"}
+cells["N"]=cell{item="it-pipe-ne"}
+cells["n"]=cell{item="it-pipe-sw"}
+cells["Q"]=cell{stone={"st-laserswitch", {action="callback", target="lasertrigger1"}}}
+cells["P"]=cell{item="it-hammer"}
+cells["p"]=cell{stone="st-stone_break"}
+cells["q"]=cell{stone={"st-laserswitch", {action="callback", target="lasertrigger2"}}}
+cells["R"]=cell{stone={"st-laserswitch", {action="callback", target="lasertrigger3"}}}
+cells["r"]=cell{stone={"st-laserswitch", {action="callback", target="lasertrigger4"}}}
+cells["S"]=cell{stone={"st-door", {type="v", name="door2"}}}
+cells["s"]=cell{stone={"st-door", {type="h", name="door3"}}}
+cells["T"]=cell{stone={"st-door", {type="v", name="door1"}}}
+cells["t"]=cell{stone={"st-pmirror", {movable=0, transparent=0, orientation=2}}}
+cells["U"]=cell{stone={"st-pmirror", {movable=0, transparent=1, orientation=4}}}
+cells["u"]=cell{stone={"st-3mirror", {movable=0, transparent=0, orientation=1}}}
+cells["V"]=cell{stone={"st-3mirror", {movable=0, transparent=0, orientation=2}}}
+cells["v"]=cell{stone={"st-pmirror", {movable=1, transparent=0, orientation=1}}}
+cells["w"]=cell{item={"it-trigger", {action="callback", target="trigger1"}}}
+cells["X"]=cell{stone="st-grate2"}
+cells["x"]=cell{stone="st-grate3"}
+cells["Y"]=cell{stone={"st-pmirror", {movable=0, transparent=0, orientation=4, name="mirror1"}}}
+cells["y"]=cell{stone={"st-switch_black", {action="callback", target="stonedoor"}}}
+cells["Z"]=cell{item={"it-trigger", {action="callback", target="trigger2"}}}
+cells["z"]=cell{item={"it-trigger", {action="callback", target="trigger3"}}}
+cells["*"]=cell{stone={"st-door_c", {name="door4"}}}
+cells[","]=cell{floor="fl-water"}
+cells["3"]=cell{stone="st-c-invisible_grate"}
+puzzles2 = {}
+cells["?"]=cell{parent={{add_multicell, puzzles2}}}
+
+if difficult then
+    cells["$"]=cells["?"]
+end
+
+if not difficult then
+    level = {
+    --            1         2         3
+    --  012345678901234567890123456789012345678
+        "#######################################",
+        "# q      u  Q#    rxYx         #   #y #",
+        "#            #     xxx     ## W wW ## #",
+        "#L       U   X     x 1 v   # Wz Z#  TN#",
+        "#            #  3$3A       # ### #  #k#",
+        "# t      V  R#???? #       #     #  # #",
+        "# ############ ?m? #B####C######C####0#",
+        "#s## X #  ,, # ? ? #  #     ........###",
+        "# f# J H     X ????# 2# D. ec.. . ecd##",
+        "# ###H #i# # X3$3  #  #.c.. . .ec  .  #",
+        "#F#M H   X #IX     a  D E #ecdc ...#  #",
+        "#0h  S   X   #     #l0c ###.. EG ..## #",
+        "#####################################0#"
+    --  012345678901234567890123456789012345678
+    --            1         2         3
+    }
+else
+    level = {
+    --             1         2         3
+    --   012345678901234567890123456789012345678
+        "#######################################",
+        "# q      u  Q#    rxYx         #   #yM#",
+        "#            #     xxx     ## W wW ##n#",
+        "#L       U   X     x 1 v   # Wz Z#  Tm#",
+        "#            #  3$3A   ##### ### #  #k#",
+        "# t      V  R#???? #  Fb..##     #  #K#",
+        "#p############ ?N? #B###ecd#####C####0#",
+        "#s## X #  ,,I# ?m? #  #  . .........###",
+        "#mf# J H  j  X ????# 2# D. ec.. . ecd##",
+        "#G###H #i# # X3$3  #  ..c.. . .ec. .  #",
+        "#F#MPH   X # X     a  D E #ecdc ...#  #",
+        "#0hMNS   X   #     #l0c ###.. EG ..##K#",
+        "#####################################0#"
+    --   012345678901234567890123456789012345678
+    --             1         2         3
+    }
+end
+
+--        -- [STONE DOOR] --
+stonedoorswitchgreen=0
+function stonedoor()
+    if (stonedoorswitchgreen==0) then
+        stonedoorswitchgreen=1
+        set_stone("st-grate2", 31,1)
+    elseif (stonedoorswitchgreen==1) then
+        stonedoorswitchgreen=0
+        set_stone("st-rock5", 31,1)
+    end
+end
+--        -- [/STONE DOOR] --
+
+--        -- [THREE TRIGGERS] --
+local switchesdoor1={0, 0, 0}
+function trigger1 () triggerdoor1(1) end 
+function trigger2 () triggerdoor1(2) end 
+function trigger3 () triggerdoor1(3) end
+doorsopen1=0
+
+function triggerdoor1(num)
+    switchesdoor1[num] = 1-switchesdoor1[num]
+    alldoor1=1
+    for x=1,3 do
+        if (switchesdoor1[x]==0) then
+        alldoor1 = 0
+    end
+    end
+    if (doorsopen1==0 and alldoor1==1) then
+        enigma.SendMessage(d1, "open", nil)
+        doorsopen1 = 1
+    elseif (doorsopen1==1 and alldoor1==0) then
+        enigma.SendMessage(d1, "close", nil)
+        doorsopen1 = 0
+    end
+end
+--       -- [/THREE TRIGGERS] --
+
+--        -- [FOURSWITCH] --
+function mirrorswitch()
+    mir=enigma.GetNamedObject("mirror1")
+    enigma.SendMessage(mir, "turn", nil)
+end
+--       -- [/FOURSWITCH] --
+
+--        -- [LASERSWITCHES] --
+local switchesdoor3={0, 0, 0, 0}
+function lasertrigger1 () triggerdoor3(1) end 
+function lasertrigger2 () triggerdoor3(2) end 
+function lasertrigger3 () triggerdoor3(3) end
+function lasertrigger4 () triggerdoor3(4) end
+doorsopen3=0
+
+function triggerdoor3(num)
+    switchesdoor3[num] = 1-switchesdoor3[num]
+    allswitches3=1
+    for x=1,4 do
+        if (switchesdoor3[x]==0) then
+        allswitches3 = 0
+    end
+    end
+    if (doorsopen3==0 and allswitches3==1) then
+        enigma.SendMessage(d3, "open", nil)
+        doorsopen3 = 1
+    elseif (doorsopen3==1 and allswitches3==0) then
+        enigma.SendMessage(d3, "close", nil)
+        doorsopen3 = 0
+    end
+end
+--       -- [/LASERSWITCHES] --
+
+oxyd_default_flavor = "d"
+set_default_parent(cells[" "])
+create_world_by_map(level)
+
+--       --  [PUZZLE] --
+function scramble(x,y,d) enigma.AddScramble(x,y,d) end
+enigma.SetScrambleIntensity(50)
+scramble(14,5,"e")
+scramble(15,5,"s")
+scramble(18,8,"w")
+scramble(17,8,"n")
+--       -- [/PUZZLE] --
+
+d1=enigma.GetNamedObject("door1")
+d3=enigma.GetNamedObject("door3")
+render_puzzles(puzzles2, puzzle2)
+
+fill_floor("fl-water", 14,5, 4, 1)
+fill_floor("fl-water", 17,5, 1, 4)
+set_floor("fl-water",18,8)
+
+set_floor("fl-abyss",25,9)
+set_floor("fl-abyss",25,10)
+set_floor("fl-wood",27,8)
+set_floor("fl-wood",34,8)
+set_floor("fl-wood",36,8)
+
+oxyd_shuffle()
+    ]]></el:luamain>
+    <el:i18n>
+      <el:string el:key="title">
+        <el:english el:translate="false"/>
+      </el:string>
+      <el:string el:key="text1">
+        <el:english el:translate="true">This is my first landscape, dedicated to my father. I hope you'll enjoy it!</el:english>
+      </el:string> 
+    </el:i18n>
+  </el:protected>
+</el:level>

Modified: branches/1.0/data/levels/enigma_v/raoul12_1.xml
===================================================================
--- branches/1.0/data/levels/enigma_v/raoul12_1.xml	2007-04-04 21:53:28 UTC (rev 680)
+++ branches/1.0/data/levels/enigma_v/raoul12_1.xml	2007-04-05 14:25:46 UTC (rev 681)
@@ -3,7 +3,7 @@
   <el:protected>
     <el:info el:type="level">
       <el:identity el:title="Keystone" el:subtitle="" el:id="raoul12"/>
-      <el:version el:score="1" el:release="1" el:revision="1" el:status="released"/>
+      <el:version el:score="1" el:release="1" el:revision="2" el:status="released"/>
       <el:author  el:name="Raoul Bourquin" el:email="raoul at users.berlios.de" el:homepage=""/>
       <el:copyright>Copyright ? 2006 Raoul Bourquin</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
@@ -79,9 +79,9 @@
 waswo = {"","","","","","","","","","",""}
 nr = 1
 
-function translate_type(type)
-    local translate_table = {"","w","s","sw","e","ew","es","esw","n","nw","ns","nsw","ne","new","nes","nesw"}
-    return translate_table[type]
+function local_translate_type(type)
+    local local_translate_table = {"","w","s","sw","e","ew","es","esw","n","nw","ns","nsw","ne","new","nes","nesw"}
+    return local_translate_table[type]
 end
 
 local i, j = 0, 0
@@ -89,7 +89,7 @@
     for j=1, 5 do
         local this_stone = enigma.GetStone(8+j-1,5+i-1)
         if this_stone ~= nil then
-            local temp = translate_type(enigma.GetAttrib(this_stone,"connections"))
+            local temp = local_translate_type(enigma.GetAttrib(this_stone,"connections"))
             waswo[nr] = "st-puzzle2-"..tostring(temp)
             nr = nr+1
         end

Added: branches/1.0/data/levels/enigma_vi/ant39_1.xml
===================================================================
--- branches/1.0/data/levels/enigma_vi/ant39_1.xml	2007-04-04 21:53:28 UTC (rev 680)
+++ branches/1.0/data/levels/enigma_vi/ant39_1.xml	2007-04-05 14:25:46 UTC (rev 681)
@@ -0,0 +1,103 @@
+<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
+<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
+  <el:protected>
+    <el:info el:type="level">
+      <el:identity el:title="Odyssey" el:subtitle="The Enigma Level" el:id="ant39"/>
+      <el:version el:score="1" el:release="1" el:revision="0" el:status="released"/>
+      <el:author  el:name="Petr Machata" el:email="" el:homepage=""/>
+      <el:copyright>Copyright ? 2003 Petr Machata</el:copyright>
+      <el:license el:type="GPL v2.0 or above" el:open="true"/>
+      <el:compatibility el:enigma="0.92">
+       <el:dependency el:path="lib/ant" el:id="lib/ant" el:release="1" el:preload="true"/>
+      </el:compatibility>
+      <el:modes el:easy="false" el:single="true" el:network="false"/>
+      <el:score el:easy="-" el:difficult="-"/>
+    </el:info>
+    <el:luamain><![CDATA[
+-- 2003-02-10 -- keeping up to date with latest additions to ant.lua
+
+cells={}
+
+solidfloor=cell{floor={face="fl-leaves"}}
+abyssfloor=cell{floor={face="fl-abyss"}}
+wallstone=cell{stone={face="st-rock1"}}
+
+cells["#"]=cell{parent={solidfloor, wallstone}}
+cells[" "]=cell{parent={solidfloor}}
+cells["."]=cell{parent={abyssfloor}}
+cells["="]=cell{parent={solidfloor}, stone={face="st-glass"}}
+
+cells["X"]=cell{parent=cells[" "],stone={face="st-grate1"}}
+
+cells["+"]=cell{parent=cells[" "],stone={face="st-puzzle", attr={connections=PUZ_0000}}}
+cells["/"]=cell{parent=cells[" "],stone={face="st-puzzle", attr={connections=PUZ_0110}}}
+cells[")"]=cell{parent=cells[" "],stone={face="st-puzzle", attr={connections=PUZ_0001}}}
+cells["|"]=cell{parent=cells[" "],stone={face="st-puzzle", attr={connections=PUZ_1010}}}
+cells["L"]=cell{parent=cells[" "],stone={face="st-puzzle", attr={connections=PUZ_1100}}}
+
+cells["w"]=cell{parent=cells[" "],stone={face="st-wood"}}
+
+cells[">"]=cell{parent=cells[" "],stone={face="st-laser", attr={on=FALSE, dir=enigma.EAST, name="laser1"}}}
+cells["S"]=cell{parent=cells[" "],stone={face="st-switch", attr={action="onoff", target="laser1"}}}
+cells["F"]=cell{parent=cells[" "],stone={face="st-laserswitch", attr={action="openclose", target="doorF"}}}
+cells["G"]=cell{parent=cells[" "],stone={face="st-laserswitch", attr={action="openclose", target="doorG"}}}
+cells["f"]=cell{parent=cells[" "],stone={face="st-door", attr={type="h", name="doorF"}}}
+cells["g"]=cell{parent=cells[" "],stone={face="st-door", attr={type="h", name="doorG"}}}
+cells["s"]=cell{parent=cells["w"],item={face="it-seed"}}
+
+cells["M"]=cell{parent=cells[" "],stone={face="st-pmirror", attr={movable=TRUE, transparent=FALSE, orientation=NORTH}}}
+
+cells["0"]=cell{parent={cells[" "], oxyd}}
+cells["O"]=cell{parent=cells[" "],actor={face="ac-blackball", attr={player=0}, actor=1}}
+
+level = {
+   "####################",
+   "#                  #",
+   "# w w w w w  w w w #",
+   "#..................#",
+   "#..................#",
+   "#..................#",
+   "#..................#",
+   "#                  #",
+   "#     ###### ####  #",
+   "#     #G=       #  #",
+   "#     ###  +    #  #",
+   "#      O#  +    #  #",
+   "###|#####  |    ####",
+   "#X +  =    |      X#",
+   "#X M  =    |      X#",
+   "#X    =    |   /  X#",
+   ">X    =       ||  X#",
+   "#X    =       L   X#",
+   "##XXXX#====#w #===##",
+   "#X    =    w w    X#",
+   "SX w  =     w     X#",
+   "#Xw s =      ))   X#",
+   "#X s  =   M|  ww  X#",
+   "#X    =   M       X#",
+   "###g#####        ###",
+   "#       #        # #",
+   "#  w  ###        # #",
+   "# w w #F=        # #",
+   "#  w  ######f##### #",
+   "#        #         #",
+   "#........#.........#",
+   "#........#.........#",
+   "#........#.........#",
+   "#........#.........#",
+   "#        #         #",
+   "#        #         #",
+   "#0######0#0#######0#"
+}
+
+oxyd_default_flavor = "c"
+create_world_by_map(level, cells)
+oxyd_shuffle()
+    ]]></el:luamain>
+    <el:i18n>
+      <el:string el:key="title">
+        <el:english el:translate="false"/>
+      </el:string>
+    </el:i18n>
+  </el:protected>
+</el:level>


Property changes on: branches/1.0/data/levels/enigma_vi/ant39_1.xml
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: branches/1.0/data/levels/enigma_vi/index.xml
===================================================================
--- branches/1.0/data/levels/enigma_vi/index.xml	2007-04-04 21:53:28 UTC (rev 680)
+++ branches/1.0/data/levels/enigma_vi/index.xml	2007-04-05 14:25:46 UTC (rev 681)
@@ -80,7 +80,7 @@
     <level _seq="72" _title="Counterclockwise" _xpath="./ulf05_1" author="Ulf Stegemann" ctrl="force" easy="true" id="20070126ulf020" rel="1" rev="93" score="1" target="time" unit="duration"/>
     <level _seq="73" _title="Check the light" _xpath="./just10_1" author="JuSt" ctrl="force" easy="false" id="just10" rel="1" rev="4" score="1" target="time" unit="duration"/>
     <level _seq="74" _title="Twokoban I" _xpath="./raoul28" author="Raoul Bourquin" ctrl="force" easy="true" id="raoul28" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="75" _title="The passage" _xpath="./just11_1" author="JuSt" ctrl="force" easy="false" id="just11" rel="1" rev="4" score="1" target="time" unit="duration"/>
+    <level _seq="75" _title="The passage" _xpath="./just11_1" author="JuSt" ctrl="force" easy="false" id="just11" rel="1" rev="5" score="1" target="time" unit="duration"/>
     <level _seq="76" _title="Magic triangle" _xpath="./just13_1" author="JuSt" ctrl="force" easy="false" id="just13" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="77" _title="Revolver" _xpath="./ral16_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20070214ral703" rel="1" rev="59" score="1" target="time" unit="duration"/>
     <level _seq="78" _title="Devil's bolder" _xpath="./just14_1" author="JuSt" ctrl="force" easy="true" id="just14" rel="1" rev="2" score="1" target="time" unit="duration"/>
@@ -89,6 +89,11 @@
     <level _seq="81" _title="Turnstiles for Two" _xpath="./ral17_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20070314ral189" rel="1" rev="64" score="1" target="time" unit="duration"/>
     <level _seq="82" _title="Polar Bears Paradise" _xpath="./ral19_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20070314ral394" rel="1" rev="63" score="1" target="time" unit="duration"/>
     <level _seq="83" _title="The wrong place?" _xpath="./just17_1" author="JuSt" ctrl="force" easy="false" id="just17" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="84" _title="Cold Meditation" _xpath="./ral18_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20070314ral728" rel="1" rev="67" score="1" target="time" unit="duration"/>
+    <level _seq="85" _title="Same task ..." _xpath="./raoul29_1" author="Raoul Bourquin" ctrl="force" easy="true" id="raoul29" rel="1" rev="2" score="1" target="time" unit="duration"/>
+    <level _seq="86" _title="Industrial puzzles" _xpath="./raoul30_1" author="Raoul Bourquin" ctrl="force" easy="false" id="raoul30" rel="1" rev="3" score="1" target="time" unit="duration"/>
+    <level _seq="87" _title="Odyssey" _xpath="./ant39_1" author="Petr Machata" ctrl="force" easy="false" id="ant39" rel="1" rev="0" score="1" target="time" unit="duration"/>
+    <level _seq="88" _title="Tandem Chess" _xpath="./luc34_1" author="Lukas Sch?ller" ctrl="force" easy="false" id="luc342007" rel="1" rev="1" score="1" target="time" unit="duration"/>
   </levels>
 
 </index>

Modified: branches/1.0/data/levels/enigma_vi/just10_1.xml
===================================================================
--- branches/1.0/data/levels/enigma_vi/just10_1.xml	2007-04-04 21:53:28 UTC (rev 680)
+++ branches/1.0/data/levels/enigma_vi/just10_1.xml	2007-04-05 14:25:46 UTC (rev 681)
@@ -127,7 +127,8 @@
         <el:english el:translate="false"/>
       </el:string>
       <el:string el:key="text1">
-        <el:english el:translate="true">Ob Schachfiguren laserresistent sind?</el:english>
+        <el:english el:translate="true"></el:english>
+        <el:translation el:lang="de">Ob Schachfiguren laserresistent sind?</el:translation>
       </el:string>
     </el:i18n>
   </el:protected>

Modified: branches/1.0/data/levels/enigma_vi/just11_1.xml
===================================================================
--- branches/1.0/data/levels/enigma_vi/just11_1.xml	2007-04-04 21:53:28 UTC (rev 680)
+++ branches/1.0/data/levels/enigma_vi/just11_1.xml	2007-04-05 14:25:46 UTC (rev 681)
@@ -3,7 +3,7 @@
   <el:protected>
     <el:info el:type="level">
       <el:identity el:title="The passage" el:subtitle="" el:id="just11"/>
-      <el:version el:score="1" el:release="1" el:revision="4" el:status="released"/>
+      <el:version el:score="1" el:release="1" el:revision="5" el:status="released"/>
       <el:author  el:name="JuSt" el:email="" el:homepage=""/>
       <el:copyright>Copyright ? 2007 JuSt</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
@@ -147,7 +147,7 @@
 set_stones("st-pmirror", {{36, 20}, {25, 21}, {27, 21}, {27, 23}}, {movable=FALSE, transparent=TRUE, orientation="2"})
 set_stone("st-pmirror", 34, 21, {movable=FALSE, transparent=TRUE, orientation="1"})
 set_stone("st-laser", 32, 22, {dir=EAST, on="1"})
-set_stone("st-oneway", 25, 9, {orientation=WEST})
+set_stone("st-oneway", 25, 9, {orientation=EAST})
 set_stone("st-oneway", 27, 2, {orientation=EAST})
 set_stones("st-blocker", {{26, 3}, {26, 9}})
 draw_stones("st-grate1", {7, 13}, {1, 1}, 11)

Added: branches/1.0/data/levels/enigma_vi/luc34_1.xml
===================================================================
--- branches/1.0/data/levels/enigma_vi/luc34_1.xml	2007-04-04 21:53:28 UTC (rev 680)
+++ branches/1.0/data/levels/enigma_vi/luc34_1.xml	2007-04-05 14:25:46 UTC (rev 681)
@@ -0,0 +1,110 @@
+<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
+<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
+  <el:protected>
+    <el:info el:type="level">
+      <el:identity el:title="Tandem Chess" el:subtitle="Work together!" el:id="luc342007"/>
+      <el:version el:score="1" el:release="1" el:revision="1" el:status="released"/>
+      <el:author  el:name="Lukas Sch?ller" el:email="Lucky_Luc at web.de" el:homepage=""/>
+      <el:copyright>Copyright ? 2007 Lukas Sch?ller</el:copyright>
+      <el:license el:type="GPL v2.0 or above" el:open="true"/>
+      <el:compatibility el:enigma="1.00">
+      </el:compatibility>
+      <el:modes el:easy="false" el:single="true" el:network="true"/>
+      <el:score el:easy="-" el:difficult="-"/>
+    </el:info>
+    <el:luamain><![CDATA[
+CreateWorld(20,13)
+fill_floor("fl-leaves")
+oxyd_default_flavor="a"
+
+enigma.ConserveLevel=FALSE
+
+function flip_black(onoff,sender)
+  local x,y=enigma.GetPos(sender)
+  if(enigma.GetStone(x,y) ~= nil) then
+    myst=enigma.GetStone(x,y)
+    if(enigma.GetKind(myst) == "st-chess") then
+      if(enigma.GetAttrib(myst,"color") == 1) then
+        SendMessage(myst,"flip")
+      end
+    end
+  end
+end
+
+function flip_white(onoff,sender)
+  local x,y=enigma.GetPos(sender)
+  if(enigma.GetStone(x,y) ~= nil) then
+    myst=enigma.GetStone(x,y)
+    if(enigma.GetKind(myst) == "st-chess") then
+      if(enigma.GetAttrib(myst,"color") == 0) then
+        SendMessage(myst,"flip")
+      end
+    end
+  end
+end
+
+function writeLine( line, cells)
+  for i=1, strlen(cells) do
+    local c = strsub(cells,i,i)
+    if(c =="#") then
+      set_stone("st-metal",i-1,line)
+    elseif(c =="|") then
+      set_stone("st-door-v",i-1,line)
+    elseif(c =="b") then
+      set_stone("st-black4",i-1,line)
+    elseif(c =="w") then
+      set_stone("st-white4",i-1,line)
+    elseif(c =="K") then
+      set_stone("st-chess_black",i-1,line)
+    elseif(c =="B") then
+      set_item("it-trigger",i-1,line,{invisible="1",action="callback",target="flip_black"})
+      set_floor("fl-black",i-1,line)
+    elseif(c =="W") then
+      set_item("it-trigger",i-1,line,{invisible="1",action="callback",target="flip_white"})
+      set_floor("fl-white",i-1,line)
+    elseif(c =="x") then
+      set_item("it-trigger",i-1,line)
+    elseif(c =="O") then
+      oxyd(i-1,line)
+    elseif(c =="0") then
+      set_actor("ac-blackball",i-0.5,line+0.5,{player="0"})
+      set_item("it-yinyang",i-1,line)
+    elseif(c =="1") then
+      set_actor("ac-whiteball",i-0.5,line+0.5,{player="1"})
+      set_item("it-yinyang",i-1,line)
+    end
+  end
+end
+
+writeLine(00,"####################")
+writeLine(01,"#   b  #    x # x# O")
+writeLine(02,"# ###  #   #  |  | #")
+writeLine(03,"# ww   b #B#bw#  # O")
+writeLine(04,"# ### ######bw######")
+writeLine(05,"# #K  ## x#   # #  #")
+writeLine(06,"#      b b| # #    #")
+writeLine(07,"# W # ##w##       ##")
+writeLine(08,"#     ##  # B  ##  #")
+writeLine(09,"#   1 ww    #   #  #")
+writeLine(10,"# 0   ##   ##wW    #")
+writeLine(11,"#     ##         # #")
+writeLine(12,"####################")
+
+Signal("it(9 5)","st(10 6)")
+Signal("it(12 1)","st(14 2)")
+Signal("it(16 1)","st(17 2)")
+
+oxyd_shuffle()
+    ]]></el:luamain>
+    <el:i18n>
+      <el:string el:key="title">
+        <el:english el:translate="true"/>
+        <el:translation el:lang="de">Tandemschach</el:translation>
+      </el:string>
+      <el:string el:key="subtitle">
+        <el:english el:translate="true"/>
+        <el:translation el:lang="de">Arbeitet zusammen!</el:translation>
+      </el:string>
+    </el:i18n>
+  </el:protected>
+</el:level>


Property changes on: branches/1.0/data/levels/enigma_vi/luc34_1.xml
___________________________________________________________________
Name: svn:eol-style
   + native

Added: branches/1.0/data/levels/enigma_vi/ral18_1.xml
===================================================================
--- branches/1.0/data/levels/enigma_vi/ral18_1.xml	2007-04-04 21:53:28 UTC (rev 680)
+++ branches/1.0/data/levels/enigma_vi/ral18_1.xml	2007-04-05 14:25:46 UTC (rev 681)
@@ -0,0 +1,217 @@
+<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
+<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
+  <el:protected >
+    <el:info el:type="level">
+      <el:identity el:title="Cold Meditation" el:subtitle="Freeze by the Power of Light" el:id="20070314ral728"/>
+      <el:version el:score="1" el:release="1" el:revision="$Revision: 67 $" el:status="released"/>
+      <el:author  el:name="Ronald Lamprecht" el:email="ral at users.berlios.de"/>
+      <el:copyright>Copyright ? 2006 Ronald Lamprecht</el:copyright>
+      <el:license el:type="GPL v2.0 or above" el:open="true"/>
+      <el:compatibility el:enigma="1.00">
+        <el:dependency el:path="lib/andreas_itemfreeze" el:id="lib/andreas_itemfreeze" el:release="1" el:preload="true"/>
+      </el:compatibility>
+      <el:modes el:easy="true" el:single="true" el:network="false"/>
+      <el:comments>
+        <el:credits el:showinfo="true" el:showstart="false">Thanks to Nat Pryce for his libs and code examples</el:credits>
+        <el:code>Lua 5.1</el:code>
+      </el:comments>
+      <el:score el:easy="18:53" el:difficult="54:52"/>
+    </el:info>
+    <el:luamain><![CDATA[
+enigma.ConserveLevel = TRUE
+math_floor = floor
+
+set_oxyd = oxyd
+
+function oxyd( x, y, tiles )
+    return set_oxyd( x, y )
+end
+
+function nothing(x, y, tiles)
+    -- create nothing
+end
+
+function horizontal_bolder(x,y,tiles)
+    if random() >= 0.5 then
+        return set_stone( "st-bolder-w", x, y )
+    else
+        return set_stone( "st-bolder-e", x, y )
+    end
+end
+
+function vertical_bolder(x,y,tiles)
+    if random() >= 0.5 then
+        return set_stone( "st-bolder-n", x, y )
+    else
+        return set_stone( "st-bolder-s", x, y )
+    end
+end
+
+function checkerboard_floor( type1, type2, attribs1, attribs2 )
+    return function( x, y, tiles )
+        if mod(x,2) == mod(y,2) then
+            return set_floor( type1, x, y, attribs1 or {} )
+        else
+            return set_floor( type2, x, y, attribs2 or {} )
+        end
+    end
+end
+
+function floor( floor_type, attribs )
+    return function( x, y, tiles )
+        return set_floor( floor_type, x, y, attribs or {} )
+    end
+end
+
+function stone( stone_type, attribs )
+    return function( x, y, tiles )
+        return set_stone( stone_type, x, y, attribs or {} )
+    end
+end
+
+function item( item_type, attribs )
+    return function( x, y, tiles )
+        return set_item( item_type, x, y, attribs or {} )
+    end
+end
+
+function actor( actor_type, attribs )
+    return function( x, y, tiles )
+        return set_actor( actor_type, x+0.5, y, attribs or {} )
+    end
+end
+
+function gradient( gradient_type )
+    return function( x, y, tiles )
+        return set_floor( "fl-gradient", x, y, {type=gradient_type} )
+    end
+end
+
+function inherit(tile_type)
+    return function( x, y, tiles )
+        return create_tile( tiles, x, y, tile_type )
+    end
+end
+
+function group( array, constructor )
+    return function( x, y, tiles )
+        object = constructor( x, y, tiles )
+        tinsert( array, object )
+        return object
+    end
+end
+
+function difficulty( d, constructor )
+    if options.Difficulty == d then
+        return constructor
+    else
+        return nothing
+    end
+end
+
+function create_world_from_map( tiles, map )
+    create_world( strlen(map[1]), getn(map) )
+    
+    for y = 1,getn(map) do
+        local line = map[y]
+        for x = 1,strlen(line) do
+            local tile = strchar(strbyte(line,x))
+            create_tile( tiles, x-1, y-1, tile )
+        end
+    end
+end
+
+function create_tile( tiles, x, y, tile_type )
+    local constructors = tiles[tile_type]
+
+    if constructors then
+    for i = 1,getn(constructors) do
+        constructors[i](x,y,tiles)
+    end
+    else
+    error("invalid tile identifier " .. tile_type )
+    end
+end
+
+oxyd_default_flavor = "a"
+
+tiles = {}
+tiles[" "] = {floor("fl-rough-blue")}
+tiles["-"] = {floor("fl-abyss")}
+tiles["#"] = {inherit(" "), stone("st-marble")}
+tiles["h"] = {inherit("-"), item("it-hollow")}
+tiles["x"] = {inherit(" "), item("it-extralife")}
+tiles["T"] = {inherit(" "), stone("st-turnstile-green")}
+tiles["L"] = {inherit(" "), stone("st-laser-n", {name="laser-left", on=0})}
+tiles["K"] = {inherit(" "), stone("st-laser-s", {name="laser-right",on=0})}
+tiles["k"] = {inherit(" "), stone("st-switch", {target="laser-right", action="onoff"})}
+tiles["l"] = {inherit(" "), stone("st-switch", {target="laser-left", action="onoff"})}
+tiles["M"] = {inherit(" "), stone("st-mirror-p-m")}
+tiles["m"] = {inherit(" "), stone("st-mirror-p/")}
+tiles["n"] = {inherit(" "), stone("st-mirror-p\\")}
+tiles["o"] = {inherit(" "), stone("st-mirror-p|")}
+tiles["P"] = {inherit("-"), stone("st-lightpassenger")}
+tiles["G"] = {inherit(" "), stone("st-glass1_hole")}
+
+tiles["1"] = {inherit(" "), actor("ac-whiteball-small", {player=0, essential=1})}
+
+if difficult then
+    tiles["R"] = {inherit("-"), stone("st-rotator_move-right")}
+    tiles["r"] = tiles[" "]
+    tiles["+"] = tiles["-"]
+    tiles["N"] = {inherit("-"), stone("st-turnstile-n")}
+    tiles["S"] = {inherit("-"), stone("st-turnstile-s")}
+    tiles["w"] = tiles[" "]
+    tiles["W"] = tiles[" "]
+else
+    tiles["r"] = {inherit(" "), stone("st-rotator_move-right")}
+    tiles["R"] = tiles["-"]
+    tiles["+"] = tiles[" "]
+    tiles["N"] = {inherit(" "), stone("st-turnstile-n")}
+    tiles["S"] = {inherit(" "), stone("st-turnstile-s")}
+    tiles["w"] = {inherit("G"), item("it-wormhole", {targetx=2.5, targety=6.5, range=0.7, strength=1})}
+    tiles["W"] = {inherit("G"), item("it-wormhole", {targetx=17.5, targety=6.5, range=0.7, strength=1})}
+end
+
+create_world_from_map( tiles, {
+"###############K####",
+"#m      ----      n#",
+"#       ----       k",
+"#      N----w      #",
+"#  T   +--h-    M  #",
+"#       -h--R      #",
+"#o 1xr --P--- rx1 o#",
+"#  1   R--h-    1  #",
+"#  M    -h--+   T  #",
+"#      W----S      #",
+"l       ----       #",
+"#n      ----      m#",
+"####L###############"
+})
+
+set_itemfreeze(10, 2)
+set_itemfreeze(9, 10)
+if difficult then
+    set_itemfreeze(9, 3)
+    set_itemfreeze(10, 9)
+else
+    set_itemfreeze(9, 4)
+    set_itemfreeze(10, 8)
+end
+
+itemfreeze_init(0, 0, 0.01)
+
+oxyd_shuffle()
+    ]]></el:luamain>
+    <el:i18n>
+      <el:string el:key="title">
+        <el:english el:translate="false"/>
+      </el:string>
+      <el:string el:key="subtitle">
+        <el:english el:translate="true"/>
+        <el:translation el:lang="de">Erstarre durch die Macht des Lichtes</el:translation>
+      </el:string>
+    </el:i18n>
+  </el:protected>
+</el:level>
+


Property changes on: branches/1.0/data/levels/enigma_vi/ral18_1.xml
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: branches/1.0/data/levels/enigma_vi/raoul28.xml
===================================================================
--- branches/1.0/data/levels/enigma_vi/raoul28.xml	2007-04-04 21:53:28 UTC (rev 680)
+++ branches/1.0/data/levels/enigma_vi/raoul28.xml	2007-04-05 14:25:46 UTC (rev 681)
@@ -10,7 +10,7 @@
       <el:compatibility el:enigma="0.92">
       </el:compatibility>
       <el:modes el:easy="true" el:single="true" el:network="false"/>
-      <el:score el:easy="4:51" el:difficult="-"/>
+      <el:score el:easy="3:30" el:difficult="3:51"/>
     </el:info>
     <el:luamain><![CDATA[
 -- GENERAL --

Added: branches/1.0/data/levels/enigma_vi/raoul29_1.xml
===================================================================
--- branches/1.0/data/levels/enigma_vi/raoul29_1.xml	2007-04-04 21:53:28 UTC (rev 680)
+++ branches/1.0/data/levels/enigma_vi/raoul29_1.xml	2007-04-05 14:25:46 UTC (rev 681)
@@ -0,0 +1,111 @@
+<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
+<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
+  <el:protected>
+    <el:info el:type="level">
+      <el:identity el:title="Same task ..." el:subtitle="... different mirrors" el:id="raoul29"/>
+      <el:version el:score="1" el:release="1" el:revision="2" el:status="released"/>
+      <el:author  el:name="Raoul Bourquin" el:email="" el:homepage=""/>
+      <el:copyright>Copyright ? 2007 Raoul Bourquin</el:copyright>
+      <el:license el:type="GPL v2.0 or above" el:open="true"/>
+      <el:compatibility el:enigma="0.92">
+      </el:compatibility>
+      <el:modes el:easy="true" el:single="true" el:network="false"/>
+      <el:score el:easy="-" el:difficult="-"/>
+    </el:info>
+    <el:luamain><![CDATA[
+-- GENERAL --
+levelh = 13
+levelw = 20
+
+create_world(levelw, levelh)
+fill_floor("fl-metal")
+
+function renderLine( line, pattern)
+	for i=1, strlen(pattern) do
+		local c = strsub( pattern, i, i)
+  		if c=="O" then
+			oxyd(i-1,line)
+        elseif c=="G" then
+            set_stone("st-glass2",i-1,line)
+        elseif c=="F" then
+            set_stone("st-glass1",i-1,line)
+        elseif c=="<" then
+            set_stone("st-mirror-3<m",i-1,line)
+        elseif c=="|" then
+            set_stone("st-mirror-p|m",i-1,line)
+        elseif c=="(" then
+            set_stone("st-mirror-3<tm",i-1,line)
+        elseif c=="i" then
+            set_stone("st-mirror-p|tm",i-1,line)
+        elseif c=="L" then
+            set_stone("st-laser",i-1,line,{on=FALSE, dir=WEST, name="l_west"})
+        elseif c=="l" then
+            set_stone("st-laser",i-1,line,{on=FALSE, dir=EAST, name="l_east"})
+        elseif c=="P" then
+            set_stone("st-polarswitch",i-1,line,{on=FALSE})
+
+        elseif c=="h" then
+            set_stone("st-mirror-p-t",i-1,line)
+        elseif c=="v" then
+            set_stone("st-mirror-p|t",i-1,line)
+
+        elseif c=="b" then
+            set_item("it-flagblack",i-1,line)
+        elseif c=="w" then
+            set_item("it-flagwhite",i-1,line)
+
+        elseif c=="-" then
+            set_floor("fl-abyss",i-1,line)
+        elseif c=="~" then
+            if not difficult then
+                set_floor("fl-abyss",i-1,line,{friction=0.1})
+            else
+                set_floor("fl-abyss",i-1,line,{friction=0.25})
+            end
+		end
+	end
+end
+
+renderLine(00 , "-------G~~~~G-------")
+renderLine(01 , "GGOFFFFOGGGGOFFFFOGG")
+renderLine(02 , "GGh    hGGGFh    hFG")
+renderLine(03 , "OvP----PvOOvP----PvO")
+renderLine(04 , "F -    - GG -   w- F")
+renderLine(05 , "F - << - GG - |i - F")
+renderLine(06 , "F -  < - Ll - |  - F")
+renderLine(07 , "F - (< - GG - |i - F")
+renderLine(08 , "F -b   - GG -    - F")
+renderLine(09 , "OvP----PvOOvP----PvO")
+renderLine(10 , "GGh    hGGGFh    hFG")
+renderLine(11 , "GGOFFFFOGGGGOFFFFOGG")
+renderLine(12 , "-------G~~~~G-------")
+
+oxyd_shuffle()
+
+set_item("it-trigger",8,0,{action="on", target="l_west"})
+set_item("it-trigger",11,0,{action="off", target="l_west"})
+
+set_item("it-trigger",8,12,{action="off", target="l_east"})
+set_item("it-trigger",11,12,{action="on", target="l_east"})
+
+if not difficult then
+    set_actor("ac-rotor",10,0.5, {force="10", range="15", prefercurrent=1})
+    set_actor("ac-rotor",10,12.5, {force="10", range="15", prefercurrent=1})
+else
+    set_actor("ac-rotor",10,0.5, {force="20", range="15", prefercurrent=1})
+    set_actor("ac-rotor",10,12.5, {force="20", range="15", prefercurrent=1})
+end
+
+-- Special
+set_actor("ac-blackball", 4.5,6.5, {player=0})
+set_actor("ac-whiteball", 15.5,6.5, {player=1})
+set_item("it-yinyang",4,6)
+set_item("it-yinyang",15,6)
+    ]]></el:luamain>
+    <el:i18n>
+      <el:string el:key="title">
+        <el:english el:translate="false"/>
+      </el:string>
+    </el:i18n>
+  </el:protected>
+</el:level>


Property changes on: branches/1.0/data/levels/enigma_vi/raoul29_1.xml
___________________________________________________________________
Name: svn:eol-style
   + native

Added: branches/1.0/data/levels/enigma_vi/raoul30_1.xml
===================================================================
--- branches/1.0/data/levels/enigma_vi/raoul30_1.xml	2007-04-04 21:53:28 UTC (rev 680)
+++ branches/1.0/data/levels/enigma_vi/raoul30_1.xml	2007-04-05 14:25:46 UTC (rev 681)
@@ -0,0 +1,182 @@
+<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
+<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
+  <el:protected>
+    <el:info el:type="level">
+      <el:identity el:title="Industrial puzzles" el:subtitle="" el:id="raoul30"/>
+      <el:version el:score="1" el:release="1" el:revision="3" el:status="released"/>
+      <el:author  el:name="Raoul Bourquin" el:email="" el:homepage=""/>
+      <el:copyright>Copyright ? 2007 Raoul Bourquin</el:copyright>
+      <el:license el:type="GPL v2.0 or above" el:open="true"/>
+      <el:compatibility el:enigma="1.00">
+       <el:dependency el:path="lib/libpuzzle_2" el:id="lib/libpuzzle" el:release="2" el:preload="true"/>
+      </el:compatibility>
+      <el:modes el:easy="false" el:single="true" el:network="false"/>
+      <el:score el:easy="-" el:difficult="4:54"/>
+    </el:info>
+    <el:luamain><![CDATA[
+-- GENERAL --
+levelh = 13
+levelw = 20
+create_world(levelw, levelh)
+
+enigma.ConserveLevel = FALSE
+
+fill_floor("fl-brick")
+
+function renderLine( line, pattern)
+	for i=1, strlen(pattern) do
+		local c = strsub( pattern, i, i)
+        if c=="#" then
+            set_stone("st-brick",i-1, line)
+        elseif c=="M" then
+            set_stone("st-brick_magic",i-1, line)
+        elseif c=="S" then
+            set_stone("st-brick_magic",i-1, line)
+            set_floor("fl-abyss",i-1, line)
+            set_item("it-seed",i-1, line)
+        elseif c=="O" then
+            set_stone("st-stoneimpulse",i-1, line)
+        elseif c=="o" then
+            set_stone("st-stoneimpulse-hollow",i-1, line)
+            set_floor("fl-abyss",i-1, line)
+        elseif c=="G" then
+            set_stone("st-glass",i-1, line)
+        elseif c=="g" then
+            set_stone("st-glass_move",i-1, line)
+        elseif c=="X" then
+            set_stone("st-grate1",i-1, line)
+        elseif c=="x" then
+            set_stone("st-grate1",i-1, line)
+            set_floor("fl-abyss",i-1, line)
+        elseif c=="s" then
+            set_stone("st-grate1",i-1, line)
+            set_item("it-seed",i-1, line)
+        elseif c=="m" then
+            set_stone("st-mail-w",i-1, line)
+        elseif c=="(" then
+            set_stone("st-oneway_black-w",i-1, line)
+        elseif c=="d" then
+            set_stone("st-oneway-s",i-1, line)
+        elseif c=="P" then
+            set_stone("st-polarswitch",i-1, line,{on=FALSE})
+        elseif c=="p" then
+            set_stone("st-polarswitch",i-1, line,{on=TRUE})
+        elseif c=="R" then
+            set_stone("st-rubberband",i-1, line)
+        elseif c=="L" then
+            set_stone("st-laser-e",i-1, line,{on=TRUE})
+        elseif c=="l" then
+            set_stone("st-laser-w",i-1, line,{on=FALSE, name="la_2"})
+        elseif c==">" then
+            set_stone("st-mirror-3>",i-1, line)
+        elseif c=="<" then
+            set_stone("st-mirror-3<",i-1, line)
+        elseif c=="v" then
+            set_stone("st-mirror-3v",i-1, line)
+        elseif c=="^" then
+            set_stone("st-mirror-3^",i-1, line)
+        elseif c=="|" then
+            set_stone("st-mirror-p|t",i-1, line)
+        elseif c=="*" then
+            set_stone("st-oxyd",i-1, line,{flavour="c", color="1"})
+        elseif c=="K" then
+            set_stone("st-key",i-1, line,{keycode="5", action="on", target="la_2"})
+        elseif c=="k" then
+            set_stone("st-key",i-1, line,{keycode="4", action="open", target="door_1"})
+        elseif c=="D" then
+            set_stone("st-door_a",i-1, line,{name="door_1"})
+
+        elseif c==" " then
+            set_floor("fl-brick",i-1, line)
+        elseif c=="2" then
+            set_floor("fl-brick",i-1, line)
+            set_item("it-crack2",i-1, line)
+        elseif c=="-" then
+            set_floor("fl-abyss",i-1, line)
+        elseif c=="i" then
+            set_floor("fl-abyss",i-1, line)
+            set_item("it-vstrip",i-1, line)
+        elseif c=="j" then
+            set_floor("fl-abyss",i-1, line)
+            set_item("it-hstrip",i-1, line)
+		end
+	end	
+end
+
+renderLine(00 , "#####vMM|||MMvPGGOOO")
+renderLine(01 , "#XX.#X   2   MXG   O")
+renderLine(02 , "#X.i x R #O# M X.. O")
+renderLine(03 , "#.j     OO   g   ..G")
+renderLine(04 , "*#  #S# # - g g   GG")
+renderLine(05 , "PX   -#   -G>>pG  X>")
+renderLine(06 , "D##O#-#OOOGX>p<XG#dM")
+renderLine(07 , "<s    o    Gp<<G  XP")
+renderLine(08 , "GG  #SO O   gXg   #*")
+renderLine(09 , "G.. -   #O   g   ..#")
+renderLine(10 , "O ..     ### M  .. #")
+renderLine(11 , "O  .GX(      M #.  k")
+renderLine(12 , "OOOGG^lLMMMMM^m###K#")
+
+-- Items --
+set_item("it-magicwand",1,2)
+set_item("it-puller-w",18,1)
+set_item("it-document",9,0)
+set_item("it-vortex-closed",10,1)
+set_item("it-key",1,11,{keycode="5"})
+set_item("it-key",18,11,{keycode="4"})
+set_item("it-key",0,8,{keycode="3"})
+
+local t = 0
+function set_grate()
+    if t==0 then
+        set_stone("st-grate1",5, 9)
+    end
+    t = 1
+end
+
+set_item("it-trigger",4,5,{action="callback", target="set_grate"})
+
+set_floor("fl-bridge-closed",13,4,{name="br3"})
+set_item("it-trigger",10,3,{action="open", target="br3"})
+
+-- Stones --
+set_stone("st-turnstile-green",17,11)
+set_stone("st-turnstile-e",18,11)
+set_stone("st-turnstile-n",18,1)
+
+-- Puzzles --
+puzzle({"#",
+        "#"},{1,10},"bluepuzzle","none")
+
+puzzle({"#",
+        "+"},{2,11},"bluepuzzle","none")
+puzzle({"#",
+        "+"},{17,1},"bluepuzzle","none")
+puzzle({"#",
+        "+"},{18,10},"bluepuzzle","none")
+puzzle({"+",
+        "#"},{18,1},"bluepuzzle","none")
+
+puzzle({"  #",
+        " ##",
+        "## "},{1,1},"redpuzzle","none")
+puzzle({"#  ",
+        "## ",
+        " ##"},{16,1},"redpuzzle","permutation")
+puzzle({"## ",
+        " ##",
+        "  #"},{1,9},"redpuzzle","permutation")
+puzzle({" ##",
+        "## ",
+        "#  "},{16,9},"redpuzzle","permutation")
+
+-- Special
+set_actor("ac-blackball", 1.5,1.5, {player=0})                    
+    ]]></el:luamain>
+    <el:i18n>
+      <el:string el:key="title">
+        <el:english el:translate="false"/>
+      </el:string>
+    </el:i18n>
+  </el:protected>
+</el:level>


Property changes on: branches/1.0/data/levels/enigma_vi/raoul30_1.xml
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: branches/1.0/src/stones_simple.cc
===================================================================
--- branches/1.0/src/stones_simple.cc	2007-04-04 21:53:28 UTC (rev 680)
+++ branches/1.0/src/stones_simple.cc	2007-04-05 14:25:46 UTC (rev 681)
@@ -85,7 +85,8 @@
         {}
     private:
         SimpleStone(const SimpleStone& other)
-        : Stone(other.get_kind()), traits(other.traits)
+        : Stone(other.get_kind()), traits(other.traits),
+          sunglasses(false)
         {}
 
         Stone *clone() { return new SimpleStone(*this); }



From ral at mail.berlios.de  Fri Apr  6 13:32:27 2007
From: ral at mail.berlios.de (ral at BerliOS)
Date: Fri, 6 Apr 2007 13:32:27 +0200
Subject: [Enigma-game-svn] r682 - branches
Message-ID: <200704061132.l36BWRsh018108@sheep.berlios.de>

Author: ral
Date: 2007-04-06 13:32:27 +0200 (Fri, 06 Apr 2007)
New Revision: 682

Added:
   branches/eval/
Log:
Branch for source of evaluation software

Copied: branches/eval (from rev 681, tags/1.00)



From ral at mail.berlios.de  Fri Apr  6 13:47:24 2007
From: ral at mail.berlios.de (ral at BerliOS)
Date: Fri, 6 Apr 2007 13:47:24 +0200
Subject: [Enigma-game-svn] r683 - in branches/1.0: data/schemas src/gui
	src/lev
Message-ID: <200704061147.l36BlOwS020238@sheep.berlios.de>

Author: ral
Date: 2007-04-06 13:47:23 +0200 (Fri, 06 Apr 2007)
New Revision: 683

Modified:
   branches/1.0/data/schemas/score.xsd
   branches/1.0/src/gui/LevelInspector.cc
   branches/1.0/src/gui/LevelInspector.hh
   branches/1.0/src/lev/ScoreManager.cc
   branches/1.0/src/lev/ScoreManager.hh
Log:
Branch 1.0: 
- visualize inherited user ratings on score version update


Modified: branches/1.0/data/schemas/score.xsd
===================================================================
--- branches/1.0/data/schemas/score.xsd	2007-04-06 11:32:27 UTC (rev 682)
+++ branches/1.0/data/schemas/score.xsd	2007-04-06 11:47:23 UTC (rev 683)
@@ -1,5 +1,5 @@
 <?xml version="1.0" encoding="UTF-8"?>
-<xs:schema xmlns:xs='http://www.w3.org/2001/XMLSchema' version="0.1" xml:lang="en">
+<xs:schema xmlns:xs='http://www.w3.org/2001/XMLSchema' version="0.2" xml:lang="en">
   <xs:annotation>
     <xs:documentation>
       XML schema definitions for Enigma score
@@ -62,6 +62,7 @@
                   <xs:attribute name="diff2" type="uscoreType" use="optional" default="-1"/>
                   <xs:attribute name="diff2rel" type="xs:float" use="optional" default="0.92"/>
                   <xs:attribute name="rating" type="ratingType" use="optional" default="-1"/>
+                  <xs:attribute name="rating-inherited" type="ratingType" use="optional" default="-1"/>
                   <xs:attribute name="sec" type="xs:string" use="required"/>
                   <xs:anyAttribute namespace="##targetNamespace" processContents="skip"/>
                 </xs:complexType>

Modified: branches/1.0/src/gui/LevelInspector.cc
===================================================================
--- branches/1.0/src/gui/LevelInspector.cc	2007-04-06 11:32:27 UTC (rev 682)
+++ branches/1.0/src/gui/LevelInspector.cc	2007-04-06 11:47:23 UTC (rev 683)
@@ -154,6 +154,9 @@
          }
          void set_value(int value) { 
              theScoreMgr->setRating(theLevel, value);
+             if (get_parent() != NULL) {
+                get_parent()->invalidate_all();
+             }
          }
      
          string get_text(int value) const  {
@@ -211,6 +214,7 @@
         lev::RatingManager *theRatingMgr = lev::RatingManager::instance();
         lev::ScoreManager  *theScoreMgr = lev::ScoreManager::instance();
         withEasy = aLevel->hasEasymode();
+        ratingInherited = theScoreMgr->isRatingInherited(aLevel);
         ecl::Font *menufont = enigma::GetFont("menufont");
         levelPathString = 
                 (levelProxy->getNormPathType() == lev::Proxy::pt_resource) ?
@@ -492,6 +496,13 @@
         } else {
             blit (gc, vminfo->width/2-4+20, vmargin+5*25+4*vspacing+vspacing2, img_hard);
         }
+        Surface *img_changed = enigma::GetImage("changed");
+        ratingInherited = lev::ScoreManager::instance()->isRatingInherited(levelProxy);
+        if (ratingInherited) {
+            int numLines = vminfo->height < 500 ? 14 :(vminfo->height < 650 ? 18 : 19);
+            blit (gc, hmargin+110+10+40, vmargin + numLines*25 +
+                    (numLines-3)*vspacing + 3*vspacing2, img_changed);        
+        }
     }
     
     void LevelInspector::tick(double dtime) {

Modified: branches/1.0/src/gui/LevelInspector.hh
===================================================================
--- branches/1.0/src/gui/LevelInspector.hh	2007-04-06 11:32:27 UTC (rev 682)
+++ branches/1.0/src/gui/LevelInspector.hh	2007-04-06 11:47:23 UTC (rev 683)
@@ -58,6 +58,7 @@
         int vmargin;
         int hmargin;
         bool withEasy;
+        bool ratingInherited;
     };
 
 }} // namespace enigma::gui

Modified: branches/1.0/src/lev/ScoreManager.cc
===================================================================
--- branches/1.0/src/lev/ScoreManager.cc	2007-04-06 11:32:27 UTC (rev 682)
+++ branches/1.0/src/lev/ScoreManager.cc	2007-04-06 11:47:23 UTC (rev 683)
@@ -824,8 +824,9 @@
             finishUserId(std::time(NULL) & 0xFFFF);
         }
         if (rating == -1) {
-            DOMElement * level = getLevel(levelProxy);
+            DOMElement *level = getLevel(levelProxy);
             if (level == NULL)
+                // no level score entry for this level - -1 is default anyway
                return;
             else if (XMLString::parseInt(level->getAttribute(
                     Utf8ToXML("version").x_str())) == levelProxy->getScoreVersion()) {
@@ -836,15 +837,29 @@
                     level->setAttribute(Utf8ToXML("rating").x_str(),
                         Utf8ToXML(ecl::strf("%d",rating)).x_str());
                 }
+                DOMAttr *irAttr = level->getAttributeNode(Utf8ToXML("rating-inherited").x_str());
+                if ((irAttr != NULL) && irAttr->getSpecified()) {
+                    // delete any inherited rating that may shadow a default of -1
+                    level->removeAttribute(Utf8ToXML("rating-inherited").x_str());
+                    isModified = true;
+                }
                 return;
-            } else
-                // no level score entry for this score version exists - -1 is default
+            } else {
+                // no level score entry for this score version exists - the user
+                // did set the rating to undefined.
+                DOMElement *level = getCreateLevel(levelProxy);
+                isModified = true;
+                level->setAttribute(Utf8ToXML("rating").x_str(),
+                        Utf8ToXML(ecl::strf("%d",rating)).x_str());
+                level->removeAttribute(Utf8ToXML("rating-inherited").x_str());
                 return;
+            }
         } else if (rating != getRating(levelProxy)) {
-            DOMElement * level = getCreateLevel(levelProxy);
+            DOMElement *level = getCreateLevel(levelProxy);
             isModified = true;
             level->setAttribute(Utf8ToXML("rating").x_str(),
                     Utf8ToXML(ecl::strf("%d",rating)).x_str());
+            level->removeAttribute(Utf8ToXML("rating-inherited").x_str());
             return;
         }
     }
@@ -855,10 +870,42 @@
             return -1;
         else {
             const XMLCh *attr = level->getAttribute(Utf8ToXML("rating").x_str());
-            return (XMLString::stringLen(attr) > 0) ? XMLString::parseInt(attr) : -1; 
+            int rating = (XMLString::stringLen(attr) > 0) ? XMLString::parseInt(attr) : -1;
+            if (rating == -1) {
+                attr = level->getAttribute(Utf8ToXML("rating-inherited").x_str());
+                int ratingInherited = (XMLString::stringLen(attr) > 0) ? XMLString::parseInt(attr) : -1;
+                if (ratingInherited >= 0)
+                    rating = ratingInherited;
+            }
+            return rating;
         }
     }
     
+    bool ScoreManager::isRatingInherited(lev::Proxy *levelProxy) {
+        DOMElement * level = getLevel(levelProxy);
+        if (level == NULL)
+            return false;
+        if (XMLString::parseInt(level->getAttribute(
+                Utf8ToXML("version").x_str())) == levelProxy->getScoreVersion()) {
+            const XMLCh *attr = level->getAttribute(Utf8ToXML("rating").x_str());
+            int rating = (XMLString::stringLen(attr) > 0) ? XMLString::parseInt(attr) : -1;
+            if (rating == -1) {
+                attr = level->getAttribute(Utf8ToXML("rating-inherited").x_str());
+                int ratingInherited = (XMLString::stringLen(attr) > 0) ? XMLString::parseInt(attr) : -1;
+                if (ratingInherited >= 0)
+                    return true;
+            }
+            return false;
+        } else {
+            const XMLCh *attr = level->getAttribute(Utf8ToXML("rating").x_str());
+            int rating = (XMLString::stringLen(attr) > 0) ? XMLString::parseInt(attr) : -1;
+            if (rating == -1)
+                return false;
+            else
+                return true;
+        }
+    }
+    
     DOMElement * ScoreManager::getLevel(lev::Proxy *levelProxy) {
         std::map<std::string,  DOMElement *>::iterator it;
         std::string cacheKey = levelProxy->getId() + "#" + ecl::strf("%d", levelProxy->getScoreVersion());
@@ -910,7 +957,7 @@
                 attr = level->getAttribute(Utf8ToXML("rating").x_str());
                 int oldRating = (XMLString::stringLen(attr) > 0) ? XMLString::parseInt(attr) : -1;
                 if (oldRating != -1) {
-                    newLevel->setAttribute(Utf8ToXML("rating").x_str(),
+                    newLevel->setAttribute(Utf8ToXML("rating-inherited").x_str(),
                         Utf8ToXML(ecl::strf("%d",oldRating)).x_str());
                 }
                 curLevelScores[levelProxy->getId()] = newLevel;

Modified: branches/1.0/src/lev/ScoreManager.hh
===================================================================
--- branches/1.0/src/lev/ScoreManager.hh	2007-04-06 11:32:27 UTC (rev 682)
+++ branches/1.0/src/lev/ScoreManager.hh	2007-04-06 11:47:23 UTC (rev 683)
@@ -105,6 +105,7 @@
         double calcHCP(lev::Index *ind, int difficulty);
         void setRating(lev::Proxy *levelProxy, int rating);
         int getRating(lev::Proxy *levelProxy);
+        bool isRatingInherited(lev::Proxy *levelProxy);
     protected:
         ScoreManager();
     private:



From ral at mail.berlios.de  Fri Apr  6 22:58:41 2007
From: ral at mail.berlios.de (ral at BerliOS)
Date: Fri, 6 Apr 2007 22:58:41 +0200
Subject: [Enigma-game-svn] r684 - in branches/eval: . java java/src
	java/src/org java/src/org/enigma_game java/src/org/enigma_game/lev
	java/src/org/enigma_game/resources
	java/src/org/enigma_game/resources/schemas
	java/src/org/enigma_game/util
Message-ID: <200704062058.l36Kwf1Q010777@sheep.berlios.de>

Author: ral
Date: 2007-04-06 22:58:39 +0200 (Fri, 06 Apr 2007)
New Revision: 684

Added:
   branches/eval/java/
   branches/eval/java/build.xml
   branches/eval/java/src/
   branches/eval/java/src/org/
   branches/eval/java/src/org/enigma_game/
   branches/eval/java/src/org/enigma_game/EnigmaUtil.java
   branches/eval/java/src/org/enigma_game/Xore5.java
   branches/eval/java/src/org/enigma_game/lev/
   branches/eval/java/src/org/enigma_game/lev/LevelScore.java
   branches/eval/java/src/org/enigma_game/lev/LevelpackManager.java
   branches/eval/java/src/org/enigma_game/lev/RatingManager.java
   branches/eval/java/src/org/enigma_game/lev/ScoreManager.java
   branches/eval/java/src/org/enigma_game/lev/UserManager.java
   branches/eval/java/src/org/enigma_game/resources/
   branches/eval/java/src/org/enigma_game/resources/schemas/
   branches/eval/java/src/org/enigma_game/resources/schemas/users.xsd
   branches/eval/java/src/org/enigma_game/util/
   branches/eval/java/src/org/enigma_game/util/LevelEvaluation.java
   branches/eval/java/src/org/enigma_game/util/RatingDiff.java
   branches/eval/java/src/org/enigma_game/util/ScoreEvaluation.java
   branches/eval/java/src/org/enigma_game/util/ScoreRegistration.java
   branches/eval/java/src/org/enigma_game/util/UserEvaluation.java
   branches/eval/java/src/org/enigma_game/util/UserRename.java
Log:
Branch eval:
- add of evalutation java sources as used for March 2007



Added: branches/eval/java/build.xml
===================================================================
--- branches/eval/java/build.xml	2007-04-06 11:47:23 UTC (rev 683)
+++ branches/eval/java/build.xml	2007-04-06 20:58:39 UTC (rev 684)
@@ -0,0 +1,110 @@
+<?xml version="1.0"?>
+<project name="EnigmaUtil" default="all" basedir=".">
+    <description> 
+    Enigma utilities ant main build file
+    </description>
+        
+    <property name="src"   value="src"/>
+    <property name="build" value="build"/>
+    <property name="lib"   value="lib"/>
+    <property name="doc"   value="doc"/>
+    <patternset id="resources">
+	<include name="org/enigma_game/resources/**/*"/>
+    </patternset>
+    
+
+    <target name="init">  
+        <tstamp/>
+        <mkdir dir="${build}"/>
+        <mkdir dir="${lib}"/>
+        <mkdir dir="${doc}"/>
+    </target>
+
+    <!-- all -->
+    <target name="all" depends="init, app, jar, doc" 
+            description="Build the whole project">
+    </target>
+    
+    <!-- classes -->
+    <target name="classes" depends="init"
+            description="Compile modified java sources only">
+        <javac srcdir="${src}" destdir="${build}" source="5"/>
+    </target>
+    
+    <!-- app -->
+    <target name="app" depends="init"
+            description="Compile complete application">
+        <delete>
+	    <fileset dir="${build}" includes="**/*.class"/>
+	</delete>
+        <javac srcdir="${src}" destdir="${build}" source="5" debug="on"/>
+        <copy todir="${build}">
+	    <fileset dir="${src}">
+		<patternset refid="resources"/>
+	    </fileset>
+	</copy>
+        <copy todir="${build}/org/enigma_game/resources/schemas">
+            <fileset dir="../data/schemas/">
+                <include name="score.xsd"/>
+                <include name="index.xsd"/>
+                <include name="ratings.xsd"/>
+                <include name="ratings.xml"/>
+            </fileset>
+        </copy>
+        <copy todir="${build}/org/enigma_game/resources/levelpacks">
+            <fileset dir="../data/levels/enigma_cross">
+                <include name="*.xml"/>
+            </fileset>
+        </copy>
+        <copy todir="${build}/org/enigma_game/resources/levelpacks">
+            <fileset dir="../data/levels">
+                <include name="*/index.xml"/>
+            </fileset>
+            <mapper type="glob" from="*${file.separator}index.xml" to="*.xml"/>
+        </copy>
+    </target>
+    
+    <!-- run -->
+    <target name="run" 
+            description="Run application on build directory">
+        <java classname="org.enigma_game.EnigmaUtil" fork="true" dir="${build}">
+	    <assertions>
+	      <enable/>
+	    </assertions>
+	</java>
+	
+
+    </target>
+
+    <!-- jar -->
+    <target name="jar" depends="init, app"
+            description="Complile app and generate jar">
+        <jar destfile="${lib}/EnigmaUtil.jar" basedir="${build}">
+	    <manifest>
+		<attribute name="Main-Class" value="org.enigma_game.EnigmaUtil"/>
+	    </manifest>
+        </jar>
+    </target>
+    
+    <!-- doc -->
+    <target name="doc" depends="init"
+            description="Generate javadoc">
+	<delete>
+	    <fileset dir="${doc}" includes="**/*"/>
+	</delete>
+	<javadoc destdir="${doc}" source="5" author="true" Private="true">
+	    <packageset dir="${src}"/>
+	</javadoc>
+    </target>
+
+    <!-- clean -->
+    <target name="clean" description="Clean up all">
+	<delete dir="${build}"/>
+	<delete dir="${lib}"/>    
+	<delete dir="${doc}"/>
+	<delete>
+	    <fileset dir="${src}" defaultexcludes="no" includes="**/*~"/>
+	</delete>
+    </target>
+    
+</project>
\ No newline at end of file


Property changes on: branches/eval/java/build.xml
___________________________________________________________________
Name: svn:eol-style
   + native

Added: branches/eval/java/src/org/enigma_game/EnigmaUtil.java
===================================================================
--- branches/eval/java/src/org/enigma_game/EnigmaUtil.java	2007-04-06 11:47:23 UTC (rev 683)
+++ branches/eval/java/src/org/enigma_game/EnigmaUtil.java	2007-04-06 20:58:39 UTC (rev 684)
@@ -0,0 +1,163 @@
+/*
+ * Copyright (C) 2006, 2007 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+// Xerces-J problems:
+//   pretty printing  needs 2.8.0
+//   class resource urls work on parser but not on Resolver, LSInput?
+//   appendNode - LSSerializer 2.6.2 - fixed XERCES-J-969, o.k. in 2.9.0
+//   doc.createElem -> localName not specified on serialization, doc.createElemNS(null,) is o.k.
+
+// This is just an internal tool that is developed in rapid prototyping manner.
+// Do not expect many comments or a well designed architecture!
+
+package org.enigma_game;
+
+import javax.xml.parsers.*;
+import org.xml.sax.*;
+import java.io.*;
+import java.util.*;
+import org.w3c.dom.*;
+import org.w3c.dom.DOMConfiguration;
+import org.w3c.dom.DOMError;
+import org.w3c.dom.DOMErrorHandler;
+import org.w3c.dom.Document;
+import org.w3c.dom.Element;
+import org.w3c.dom.Node;
+import org.w3c.dom.bootstrap.DOMImplementationRegistry;
+import org.w3c.dom.ls.*;
+import org.apache.xerces.dom.DOMImplementationImpl;
+
+import org.enigma_game.util.LevelEvaluation;
+import org.enigma_game.util.RatingDiff;
+import org.enigma_game.util.ScoreRegistration;
+import org.enigma_game.util.ScoreEvaluation;
+import org.enigma_game.util.UserEvaluation;
+import org.enigma_game.util.UserRename;
+
+public class EnigmaUtil implements DOMErrorHandler, LSResourceResolver {
+    public static EnigmaUtil theApp;
+    public final static String RESOURCES = "/org/enigma_game/resources/";
+    public final static String W3C_XML_SCHEMA =  "http://www.w3.org/2001/XMLSchema";
+
+    public LSParser domParser;
+    public LSSerializer domWriter;
+    public DOMImplementationLS domImpl;
+    
+    private DOMConfiguration parserConfig;
+
+    Document doc;
+
+    public EnigmaUtil(String[] args) {
+        theApp = this;
+        if (args[0].equals("-?")) {
+            System.out.println("EnigmaUtil - a system tool for evaluation of scores.");
+            System.out.println("Options: java -jar EnigmaUtil -r oldRating.xml newRating.xml");
+            System.out.println("  score registration: -s enigma.score oldRating.xml users.xml");
+            System.out.println("  user renaming:      -r oldRating.xml newRating.xml users.xml");
+            System.out.println("  new rating eval.:   -e oldRating.xml newRating.xml users.xml *.zip");
+            System.out.println("  rating diff:        -d oldRating.xml newRating.xml");
+            System.out.println("  user evaluation:    -u newRating.xml users.xml *.zip");
+            System.out.println("  level evalustion:   -l rating.xml users.xml key *.zip");
+            System.exit(1);
+        }
+        try {
+            // get DOM 5.0 internal Implementation using DOM Registry
+            System.setProperty(DOMImplementationRegistry.PROPERTY,
+              //"com.sun.org.apache.xerces.internal.dom.DOMXSImplementationSourceImpl");
+              "org.apache.xerces.dom.DOMXSImplementationSourceImpl");
+            DOMImplementationRegistry registry = DOMImplementationRegistry.newInstance();
+            domImpl = (DOMImplementationLS)registry.getDOMImplementation("LS");
+    
+            if (domImpl == null)
+                System.out.println("LS domImpl is null");
+            else
+                System.out.println("LS domImpl is valid");
+            
+            // create DOMBuilder
+            domParser = domImpl.createLSParser(DOMImplementationLS.MODE_SYNCHRONOUS, null);
+            
+            parserConfig = domParser.getDomConfig();
+
+            // set error handler
+            parserConfig.setParameter("error-handler", this);
+            
+            // set resource-resolver
+            parserConfig.setParameter("resource-resolver", this);
+            
+            // set validation feature
+            parserConfig.setParameter("validate",Boolean.TRUE);
+            
+            // namespace by default, datatypenormalization ?
+            
+            // set schema language
+            parserConfig.setParameter("schema-type", "http://www.w3.org/2001/XMLSchema");
+                        
+            // create DOMWriter
+            domWriter = domImpl.createLSSerializer();
+            
+            DOMConfiguration  config = domWriter.getDomConfig();
+            config.setParameter("error-handler", this);
+            //config.setParameter("discard-default-content", Boolean.FALSE);
+            config.setParameter("format-pretty-print", Boolean.TRUE); // only support by Xerces 2.8.0++
+        } catch ( Exception ex ) {
+            ex.printStackTrace();
+        }
+
+        if (args[0].equals("-d")) {
+            new RatingDiff(args[1], args[2]);
+        } else if (args[0].equals("-s")) {
+            new ScoreRegistration(args[1], args[2], args[3]);
+        } else if (args[0].equals("-r")) {
+            new UserRename(args[1], args[2], args[3]);
+        } else if (args[0].equals("-e")) {
+            new ScoreEvaluation(args[1], args[2], args[3], args, 4);
+        } else if (args[0].equals("-u")) {
+            new UserEvaluation(args[1], args[2], args, 3);
+        } else if (args[0].equals("-l")) {
+            new LevelEvaluation(args[1], args[2],  args[3], args, 4);
+        }
+    }
+
+    public boolean handleError(DOMError error){
+        short severity = error.getSeverity();
+        if (severity == DOMError.SEVERITY_ERROR) {
+            System.out.println("[dom3-error]: "+error.getMessage());
+        }
+
+        if (severity == DOMError.SEVERITY_WARNING) {
+            System.out.println("[dom3-warning]: "+error.getMessage());
+        }
+        return true;
+
+    }
+    
+    public LSInput resolveResource(String type, String namespaceURI, String publicId,
+            String systemId, String baseURI) {
+        LSInput input = domImpl.createLSInput();
+        //System.out.println("resolve: " + systemId);
+        InputStream iStream = EnigmaUtil.class.getResourceAsStream(RESOURCES +
+                "schemas/" + systemId);
+        BufferedInputStream bStream = new BufferedInputStream(iStream);
+        input.setByteStream(bStream);
+        return input;
+    }
+    
+    public static void main(String[] args) {
+        new EnigmaUtil(args);
+    }
+}


Property changes on: branches/eval/java/src/org/enigma_game/EnigmaUtil.java
___________________________________________________________________
Name: svn:eol-style
   + native

Added: branches/eval/java/src/org/enigma_game/Xore5.java
===================================================================
--- branches/eval/java/src/org/enigma_game/Xore5.java	2007-04-06 11:47:23 UTC (rev 683)
+++ branches/eval/java/src/org/enigma_game/Xore5.java	2007-04-06 20:58:39 UTC (rev 684)
@@ -0,0 +1,32 @@
+/*
+ * Copyright (C) 2006, 2007 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+package org.enigma_game;
+
+import java.io.*;
+
+public class Xore5 {
+    public static void main(String args[]) throws IOException {
+        BufferedInputStream in = new BufferedInputStream(new FileInputStream(args[0]));
+        BufferedOutputStream out = new BufferedOutputStream(new FileOutputStream(args[1]));
+        int c;
+        while ((c = in.read()) != -1)
+           out.write(c ^ 0xE5);
+        out.flush();
+    }
+}


Property changes on: branches/eval/java/src/org/enigma_game/Xore5.java
___________________________________________________________________
Name: svn:eol-style
   + native

Added: branches/eval/java/src/org/enigma_game/lev/LevelScore.java
===================================================================
--- branches/eval/java/src/org/enigma_game/lev/LevelScore.java	2007-04-06 11:47:23 UTC (rev 683)
+++ branches/eval/java/src/org/enigma_game/lev/LevelScore.java	2007-04-06 20:58:39 UTC (rev 684)
@@ -0,0 +1,537 @@
+/*
+ * Copyright (C) 2006, 2007 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+package org.enigma_game.lev;
+
+import java.util.*; 
+import org.w3c.dom.*;
+import org.enigma_game.lev.UserManager;
+
+public class LevelScore {
+    Element elem;
+    static String currentRel = "1.00";
+    boolean isDiffSolved = false;
+    boolean isEasySolved = false;
+    int bsd = -1;
+    String bsdh;
+    Set<String> oldBsdh = new HashSet<String>();      // legacy old scores
+    Set<String> oldConfBsdh = new HashSet<String>();  // confirmed old scores
+    Set<String> newConfBsdh = new HashSet<String>();  // confirmed new scores
+    int bse = -1;
+    String bseh;
+    Set<String> oldBseh = new HashSet<String>();
+    Set<String> oldConfBseh = new HashSet<String>();
+    Set<String> newConfBseh = new HashSet<String>();
+    double pareSum;  // harm average: sum 1/score
+    double pardSum;
+    int numProfE;
+    int numProfD;
+    int solvne;   // num
+    int solvpe;   // percentage * 100
+    int solvnd;
+    int solvpd;
+    int avgurNum;
+    int avgurSum;
+    String title = "";
+    String author = "";
+    String relPath = "";
+    boolean hasEasy = true;
+    boolean partOfCurDist = false;
+    int userScoreDiff;
+    int userScoreEasy;
+    boolean userDiffSolved = false;
+    boolean userEasySolved = false;
+    static Map<String, Integer> wrHolders = new HashMap<String, Integer>();
+    static Map<String, Integer> wrSharers = new HashMap<String, Integer>();
+    boolean fullEval = false;
+    Map<Integer, String> scoresDiff = new TreeMap<Integer, String>();
+    Map<Integer, String> scoresEasy = new TreeMap<Integer, String>();
+    
+    static void printWRStatistics(UserManager userMgr) {
+        Map<String, Integer> wrHoldersTotal = new HashMap<String, Integer>(wrHolders);
+        System.out.println("Unique Worldrecords:");
+        for (Map.Entry<String, Integer> entry : wrHolders.entrySet()) {
+            System.out.println("  " + entry.getValue() + " "+ entry.getKey());
+        }
+        System.out.println("Shared Worldrecords:");
+        for (Map.Entry<String, Integer> entry : wrSharers.entrySet()) {
+            System.out.println("  " + entry.getValue() + " "+ entry.getKey());
+            Integer numUniqueWr = wrHoldersTotal.get(entry.getKey());
+            wrHoldersTotal.put(entry.getKey(), (numUniqueWr == null 
+                        ? entry.getValue()
+                        : numUniqueWr + entry.getValue()));
+        }
+        
+        Map<Integer, String> wrRanking = new TreeMap<Integer, String>();
+        for (Map.Entry<String, Integer> entry : wrHoldersTotal.entrySet()) {
+            String wrHolders = wrRanking.get(entry.getValue());
+            wrRanking.put(entry.getValue(), (wrHolders == null ? entry.getKey()
+                        : wrHolders + " + " + entry.getKey()));
+        }
+        System.out.println("Worldrecords Total Ranking:");
+        for (Map.Entry<Integer, String> entry : wrRanking.entrySet()) {
+            if (!entry.getValue().equals(""))
+                System.out.println("  " + entry.getKey() + " "+ entry.getValue());
+        }
+        
+        for (String userId : userMgr.getUserIds()) {
+            String name = userMgr.getValue(userId, "name");
+            Integer wrUnique = wrHolders.get(name);
+            Integer wrShared = wrSharers.get(name);
+            int sharedWRcount = ((wrShared != null) ? wrShared : 0);
+            int totalWRrcount = ((wrUnique != null) ? wrUnique : 0) + sharedWRcount;
+            
+            Formatter formatterWRtotal = new Formatter(Locale.US);
+            formatterWRtotal.format("%3d",  totalWRrcount);
+            userMgr.setValue(userId, "wrtotal", formatterWRtotal.toString());
+            
+            Formatter formatterWRshared = new Formatter(Locale.US);
+            formatterWRshared.format("%3d",  sharedWRcount);
+            userMgr.setValue(userId, "wrshared", formatterWRshared.toString());
+        }
+    }
+    
+    public LevelScore(Element e, String bestScoreDiff, String bestScoreDiffHolder,
+            String bestScoreEasy, String bestScoreEasyHolder) {
+        elem = e;
+        if (bestScoreDiff.length() > 0)
+            bsd = Integer.parseInt(bestScoreDiff);
+        bsdh = bestScoreDiffHolder;
+        oldBsdh.addAll(Arrays.asList(bsdh.split("\\x2B"))); // "+"
+        if (bestScoreEasy.length() > 0)
+            bse = Integer.parseInt(bestScoreEasy);
+        bseh = bestScoreEasyHolder;
+        oldBseh.addAll(Arrays.asList(bseh.split("\\x2B"))); // "+"
+    }
+    
+    public void renameUser(String oldname, String newname) {
+        if (oldBsdh.remove(oldname)) {
+            oldBsdh.add(newname);
+            String holders = "";
+            for(String name : oldBsdh) {
+                holders += name + "+";
+            }
+            if (holders.endsWith("+"))
+                holders = holders.substring(0, holders.length() -1);
+            elem.setAttributeNS(null, "bsdh", holders);
+        }
+        if (oldBseh.remove(oldname)) {
+            oldBseh.add(newname);
+            String holders = "";
+            for(String name : oldBseh) {
+                holders += name + "+";
+            }
+            if (holders.endsWith("+"))
+                holders = holders.substring(0, holders.length() -1);
+            elem.setAttributeNS(null, "bseh", holders);
+        }
+    }
+    
+    public void addIndexInfo(String levelTitle, String levelAuthor, 
+            String rPath,  String hasEasyMode) {
+        partOfCurDist = true;
+        title = levelTitle;
+        author = levelAuthor;
+        relPath = rPath;
+        if (hasEasyMode.length() > 0)
+            hasEasy = Boolean.parseBoolean(hasEasyMode);
+    }
+    
+    public void setFullEvaluation(String pattern) {
+        if (elem.getAttribute("id").contains(pattern) ||
+                author.contains(pattern) || title.contains(pattern) ||
+                relPath.contains(pattern)) {
+            fullEval = true;
+        }
+    }
+    
+    public boolean isPartOfCurDist() {
+        return partOfCurDist;
+    }
+    
+    public String getTitle() {
+        return title;
+    }
+    
+    public boolean hasEasyMode() {
+        return hasEasy;
+    }
+    
+    public boolean isDiffSolved() {
+        return isDiffSolved;
+    }
+    
+    public boolean isEasySolved() {
+        return isEasySolved;
+    }
+    
+    public double getParDiff() {
+        String parStr = elem.getAttribute("pard");
+        double par = -1;
+        if (parStr.length() > 0)
+            par = Double.parseDouble(parStr);
+        return par;
+    }
+    
+    public double getParEasy() {
+        String parStr = elem.getAttribute("pare");
+        double par = -1;
+        if (parStr.length() > 0)
+            par = Double.parseDouble(parStr);
+        return par;
+    }
+    
+    public int getRatingNum() {
+        return avgurNum;
+    }
+    
+    public double getRatingAvg() {
+        if (avgurNum >  0)
+            return (double)avgurSum/avgurNum;
+        else
+            return -1;
+    }
+    
+    public String getAuthor() {
+        return author;
+    }
+    
+    public String getId() {
+        return elem.getAttribute("id");
+    }
+    
+    public boolean hasUserDiffSolved() {
+        return userDiffSolved;
+    }
+    
+    public boolean hasUserEasySolved() {
+        return userEasySolved;
+    }
+    
+    public int getUserScoreDiff() {
+        return userScoreDiff;
+    }
+    
+    public int getUserScoreEasy() {
+        return userScoreEasy;
+    }
+    
+    public boolean isUserWRHolderDiff() {
+        return userScoreDiff >= 0 && userScoreDiff == bsd;
+    }
+    
+    public boolean isUserWRHolderEasy() {
+        return userScoreEasy >= 0 && userScoreEasy == bse;
+    }
+    
+    public boolean isUniqueWRDiff() {
+        return oldBsdh.size() + oldConfBsdh.size() + newConfBsdh.size() == 1;
+    }
+    
+    public boolean isUniqueWREasy() {
+        return oldBseh.size() + oldConfBseh.size() + newConfBseh.size() == 1;
+    }
+    
+    public void resetUserSolved() {
+        userScoreDiff = -1;
+        userScoreEasy = -1;
+        userDiffSolved = false;
+        userEasySolved = false;
+    }
+    
+    public void registerSolvage(String userName, String diffStr, String easyStr) {
+        if (diffStr.length() > 0)
+            userScoreDiff = Integer.parseInt(diffStr);
+        if (easyStr.length() > 0)
+            userScoreEasy = Integer.parseInt(easyStr);
+        
+        // user solved ?
+        if (userScoreDiff >= 0) {
+            userDiffSolved = true;
+            if (fullEval) {
+                String tieUsers = scoresDiff.get(userScoreDiff);
+                scoresDiff.put(userScoreDiff, tieUsers == null ? userName :
+                        tieUsers + "+" + userName); 
+            }
+        }
+        if (userScoreEasy >= 0) {
+            userEasySolved = true;
+            if (fullEval) {
+                String tieUsers = scoresEasy.get(userScoreEasy);
+                scoresEasy.put(userScoreEasy, tieUsers == null ? userName :
+                        tieUsers + "+" + userName); 
+            }
+        }
+    }
+    
+    public void printLevelEvaluation() {
+        if( fullEval) {
+            System.out.println("");
+            System.out.println("Level " + elem.getAttribute("id")
+                    + "  '" + title + "' by " + author);
+            for (Map.Entry<Integer, String> entry : scoresDiff.entrySet()) {
+                System.out.println(entry.getKey() + "  " +  entry.getValue());
+            }
+            if (hasEasy) {
+                System.out.println("");
+                System.out.println("Easy mode:");
+                for (Map.Entry<Integer, String> entry : scoresEasy.entrySet()) {
+                    System.out.println(entry.getKey() + "  " +  entry.getValue());
+                }
+            }
+        }
+    }
+    
+    public void registerScore(String user, boolean isProfessional, String rating, 
+            String diffStr, String diffRel, String easyStr, String easyRel,
+            String diff2Str, String diff2Rel, String easy2Str, String easy2Rel) {
+        int usd = -1;
+        int use = -1;
+        int usd2 = -1;
+        int use2 = -1;
+        int urat = -1;
+        if (diffStr.length() > 0)
+            usd = Integer.parseInt(diffStr);
+        if (easyStr.length() > 0)
+            use = Integer.parseInt(easyStr);
+        if (diff2Str.length() > 0)
+            usd2 = Integer.parseInt(diff2Str);
+        if (easy2Str.length() > 0)
+            use2 = Integer.parseInt(easy2Str);
+        if (rating.length() > 0)
+            urat = Integer.parseInt(rating);
+        
+        // solved with current release?
+        if ((usd >= 0 && diffRel.equals(currentRel)) 
+                || (usd2 >= 0 && diff2Rel.equals(currentRel))) {
+            isDiffSolved = true;
+        }
+        if ((use >= 0 && easyRel.equals(currentRel))
+                || (use2 >= 0 && easy2Rel.equals(currentRel))) {
+            isEasySolved = true;
+        }
+        
+        if (usd >= 0) {
+            if (usd < bsd || bsd == -1) {
+                // new world record
+                bsd = usd;
+                newConfBsdh.clear();
+                newConfBsdh.add(user);
+                oldBsdh.clear();
+                oldConfBsdh.clear();
+            } else if (usd == bsd) {
+                // same as world record
+                if (oldBsdh.contains(user)) {
+                    oldBsdh.remove(user);
+                    oldConfBsdh.add(user);
+                } else {
+                    newConfBsdh.add(user);
+                }
+            }
+            solvnd++;
+            if (usd == 0)
+                usd = 1;
+            if (isProfessional) {
+                pardSum += 1.0/usd;
+                numProfD++;
+            }
+        }
+        if (use >= 0) {
+            if (use < bse || bse == -1) {
+                // new world record
+                bse = use;
+                newConfBseh.clear();
+                newConfBseh.add(user);
+                oldBseh.clear();
+                oldConfBseh.clear();
+            } else if (use == bse) {
+                // same as world record
+                if (oldBseh.contains(user)) {
+                    oldBseh.remove(user);
+                    oldConfBseh.add(user);
+                } else {
+                    newConfBseh.add(user);
+                }
+            }
+            solvne++;
+            if (use == 0)
+                use = 1;
+            if (isProfessional) {
+                pareSum += 1.0/use;
+                numProfE++;
+            }
+        }
+        if (urat >= 0) {
+            avgurNum++;
+            avgurSum += urat;
+        }
+    }
+    
+    public void finish(int numUsers, int numProf) {
+        elem.setAttributeNS(null, "bsd", Integer.toString(bsd));
+        
+        String holders = "";
+        if (oldBsdh.isEmpty() && oldConfBsdh.isEmpty()) {
+            for(String name : newConfBsdh)
+                holders += name + "+";
+        } else {
+            for(String name : oldConfBsdh)
+                holders += name + "+";
+            for(String name : newConfBsdh)   // we may omit new record holders
+                holders += name + "+";       // if there are too many 
+            for(String name : oldBsdh)
+                holders += name + "+";
+        }
+        if (holders.endsWith("+"))
+            holders = holders.substring(0, holders.length() -1);
+        elem.setAttributeNS(null, "bsdh", holders);
+        
+        elem.setAttributeNS(null, "bse", Integer.toString(bse));
+        
+        holders = "";
+        if (oldBseh.isEmpty() && oldConfBseh.isEmpty()) {
+            for(String name : newConfBseh)
+                holders += name + "+";
+        } else {
+            for(String name : oldConfBseh)
+                holders += name + "+";
+            for(String name : newConfBseh)   // we may omit new record holders
+                holders += name + "+";       // if there are too many 
+            for(String name : oldBseh)
+                holders += name + "+";
+        }
+        if (holders.endsWith("+"))
+            holders = holders.substring(0, holders.length() -1);
+        elem.setAttributeNS(null, "bseh", holders);
+        
+        if (solvne == 0) {
+            pareSum = -1;
+        } else {
+            // rate profs that did not solve level as 10 * world record
+            double subScore = 10.0 * Math.max(bse, 1.0);
+            pareSum = (double)numProf / (pareSum + (numProf - numProfE)/subScore) + 0.5;
+            if (pareSum >= (99*60+59.5))
+                pareSum =  -1;
+        }
+        elem.setAttributeNS(null, "pare", Integer.toString((int)pareSum));
+
+        if (solvnd == 0) {
+            pardSum = -1;
+        } else {
+            // rate profs that did not solve level as 10 * world record
+            double subScore = 10.0 * Math.max(bsd, 1.0);
+            pardSum = (double)numProf / (pardSum + (numProf - numProfD)/subScore) + 0.5;
+            if (pardSum >= (99*60+59.5))
+                pardSum =  -1;
+        }
+        elem.setAttributeNS(null, "pard", Integer.toString((int)pardSum));
+
+        elem.setAttributeNS(null, "solvne", Integer.toString(solvne));
+        solvpe = solvne * 10000 / numUsers;
+        elem.setAttributeNS(null, "solvpe", Integer.toString(solvpe));
+        
+        elem.setAttributeNS(null, "solvnd", Integer.toString(solvnd));
+        solvpd = solvnd * 10000 / numUsers;
+        elem.setAttributeNS(null, "solvpd", Integer.toString(solvpd));
+        
+        int avgur = -1;
+        if (avgurNum >  0)
+            avgur = avgurSum * 10 / avgurNum;
+        elem.setAttributeNS(null, "avgur", Integer.toString(avgur));
+        
+        // worldrecord holder statistics
+        int numWRHolder = oldBsdh.size() + oldConfBsdh.size() + newConfBsdh.size();
+        if (numWRHolder > 1) {
+            for(String name : newConfBsdh) {
+                Integer n = wrSharers.get(name);
+                wrSharers.put(name, (n == null ? 1 : n+1));
+            }
+            for(String name : oldConfBsdh) {
+                Integer n = wrSharers.get(name);
+                wrSharers.put(name, (n == null ? 1 : n+1));
+            }
+            for(String name : oldBsdh) {
+                Integer n = wrSharers.get(name);
+                wrSharers.put(name, (n == null ? 1 : n+1));
+            }
+        } else {
+            for(String name : newConfBsdh) {
+                Integer n = wrHolders.get(name);
+                wrHolders.put(name, (n == null ? 1 : n+1));
+            }
+            for(String name : oldConfBsdh) {
+                Integer n = wrHolders.get(name);
+                wrHolders.put(name, (n == null ? 1 : n+1));
+            }
+            for(String name : oldBsdh) {
+                Integer n = wrHolders.get(name);
+                wrHolders.put(name, (n == null ? 1 : n+1));
+            }
+        }
+        if (hasEasy) {
+            numWRHolder = oldBseh.size() + oldConfBseh.size() + newConfBseh.size();
+            if (numWRHolder > 1) {
+                for(String name : newConfBseh) {
+                    Integer n = wrSharers.get(name);
+                    wrSharers.put(name, (n == null ? 1 : n+1));
+                }
+                for(String name : oldConfBseh) {
+                    Integer n = wrSharers.get(name);
+                    wrSharers.put(name, (n == null ? 1 : n+1));
+                }
+                for(String name : oldBseh) {
+                    Integer n = wrSharers.get(name);
+                    wrSharers.put(name, (n == null ? 1 : n+1));
+                }
+            } else {
+                for(String name : newConfBseh) {
+                    Integer n = wrHolders.get(name);
+                    wrHolders.put(name, (n == null ? 1 : n+1));
+                }
+                for(String name : oldConfBseh) {
+                    Integer n = wrHolders.get(name);
+                    wrHolders.put(name, (n == null ? 1 : n+1));
+                }
+                for(String name : oldBseh) {
+                    Integer n = wrHolders.get(name);
+                    wrHolders.put(name, (n == null ? 1 : n+1));
+                }
+            }
+        }
+    }
+    
+    public static class ComparatorRating implements Comparator<LevelScore> {
+        public ComparatorRating() {
+        }
+        
+        public int compare(LevelScore ls1, LevelScore ls2) {
+            if (ls1.getRatingAvg() > ls2.getRatingAvg())
+                return -1;
+            else if (ls1.getRatingAvg() < ls2.getRatingAvg())
+                return 1;
+            else {
+                if (ls1.getRatingNum() > ls2.getRatingNum())
+                    return -1;
+                else if (ls1.getRatingNum() < ls2.getRatingNum())
+                    return 1;
+                else
+                    return 0;
+            }
+        }
+    }
+}


Property changes on: branches/eval/java/src/org/enigma_game/lev/LevelScore.java
___________________________________________________________________
Name: svn:eol-style
   + native

Added: branches/eval/java/src/org/enigma_game/lev/LevelpackManager.java
===================================================================
--- branches/eval/java/src/org/enigma_game/lev/LevelpackManager.java	2007-04-06 11:47:23 UTC (rev 683)
+++ branches/eval/java/src/org/enigma_game/lev/LevelpackManager.java	2007-04-06 20:58:39 UTC (rev 684)
@@ -0,0 +1,79 @@
+/*
+ * Copyright (C) 2006, 2007 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+package org.enigma_game.lev;
+
+import java.io.*;
+import java.util.*; 
+import org.w3c.dom.*;
+import org.w3c.dom.ls.*;
+
+import org.enigma_game.EnigmaUtil;
+import org.enigma_game.lev.RatingManager;
+import org.enigma_game.lev.LevelScore;
+
+public class LevelpackManager {
+    EnigmaUtil theApp = org.enigma_game.EnigmaUtil.theApp;
+    Document doc;
+    NodeList levelElems;
+    String name;
+    List<LevelScore> levelScores = new ArrayList<LevelScore>();
+    
+    public LevelpackManager(String levelpack) {
+        name = levelpack;
+        LSInput input = theApp.domImpl.createLSInput();
+        InputStream iStream = LevelpackManager.class.getResourceAsStream(
+                EnigmaUtil.RESOURCES +
+                "levelpacks/" + levelpack + ".xml");
+        BufferedInputStream bStream = new BufferedInputStream(iStream);
+        input.setByteStream(bStream);
+        doc = theApp.domParser.parse(input);
+        
+        DOMConfiguration config = doc.getDomConfig();
+        config.setParameter("error-handler", theApp);
+        
+        levelElems = doc.getElementsByTagName("level");
+    }
+    
+    public void registerLevels(RatingManager ratingMgr) {
+        for (int i = 0; i < levelElems.getLength(); i++) {
+            Element e = (Element) levelElems.item(i);
+            LevelScore ls = ratingMgr.getLevelScore(e.getAttribute("id"),
+                    e.getAttribute("score"));
+            if (ls == null) {
+                ls = ratingMgr.newLevelScore(e.getAttribute("id"),
+                    e.getAttribute("score"));
+            }
+            ls.addIndexInfo(e.getAttribute("_title"), e.getAttribute("author"),
+                    e.getAttribute("_xpath"), e.getAttribute("easy"));
+            levelScores.add(ls);
+        }
+    }
+    
+    public String getName() {
+        return name;
+    }
+    
+    public List<LevelScore> getLevelScores() {
+        return levelScores;
+    }
+    
+    public int size() {
+        return levelScores.size();
+    }
+}


Property changes on: branches/eval/java/src/org/enigma_game/lev/LevelpackManager.java
___________________________________________________________________
Name: svn:eol-style
   + native

Added: branches/eval/java/src/org/enigma_game/lev/RatingManager.java
===================================================================
--- branches/eval/java/src/org/enigma_game/lev/RatingManager.java	2007-04-06 11:47:23 UTC (rev 683)
+++ branches/eval/java/src/org/enigma_game/lev/RatingManager.java	2007-04-06 20:58:39 UTC (rev 684)
@@ -0,0 +1,450 @@
+/*
+ * Copyright (C) 2006, 2007 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+package org.enigma_game.lev;
+
+import java.io.*;
+import java.text.*;
+import java.util.*; 
+import javax.xml.datatype.*;
+import org.w3c.dom.*;
+import org.w3c.dom.ls.*;
+
+import org.enigma_game.EnigmaUtil;
+import org.enigma_game.lev.LevelScore;
+import org.enigma_game.lev.LevelpackManager;
+import org.enigma_game.lev.UserManager;
+
+public class RatingManager {
+    EnigmaUtil theApp = org.enigma_game.EnigmaUtil.theApp;
+    Document doc;
+    Element updateElem;
+    Element levelsElem;
+    NodeList levelElems;
+    Map<String, LevelScore> levelScores = new HashMap<String, LevelScore>();
+    List<LevelpackManager> levelPacks = new ArrayList<LevelpackManager>();
+    int numDifficult;
+    int numEasy;
+    int numProf = 0;
+    static double log_2 = Math.log(2.0);
+    
+    public RatingManager(String url) {
+        doc = theApp.domParser.parseURI(url);
+        
+        DOMConfiguration config = doc.getDomConfig();
+        config.setParameter("error-handler", theApp);
+        // set validation feature
+        config.setParameter("validate", Boolean.FALSE);
+        config.setParameter("schema-type", "http://www.w3.org/2001/XMLSchema");
+        //config.setParameter("schema-location","data/personal.xsd");
+        
+        updateElem = (Element) doc.getElementsByTagName("update").item(0);
+        levelsElem = (Element) doc.getElementsByTagName("levels").item(0);
+        levelElems = doc.getElementsByTagName("level");
+    }
+    
+    public void setUpLevelScores(String levelPattern) {
+        for (int i = 0; i < levelElems.getLength(); i++) {
+            Element e = (Element) levelElems.item(i);
+            String key = e.getAttribute("id") + "_" + e.getAttribute("sv");
+            LevelScore ls = new LevelScore(e, e.getAttribute("bsd"),
+                    e.getAttribute("bsdh"), e.getAttribute("bse"), e.getAttribute("bseh"));
+            levelScores.put(key, ls);
+        }
+        LevelpackManager lpmgr;
+        lpmgr = new LevelpackManager("enigma0_92_1");
+        lpmgr.registerLevels(this);
+        levelPacks.add(lpmgr);
+        lpmgr = new LevelpackManager("enigma0_92_2");
+        lpmgr.registerLevels(this);
+        levelPacks.add(lpmgr);
+        lpmgr = new LevelpackManager("enigma0_92_3");
+        lpmgr.registerLevels(this);
+        levelPacks.add(lpmgr);
+        lpmgr = new LevelpackManager("newlevels");
+        lpmgr.registerLevels(this);
+        levelPacks.add(lpmgr);
+        lpmgr = new LevelpackManager("enigma_tutorial");
+        lpmgr.registerLevels(this);
+        levelPacks.add(lpmgr);
+        lpmgr = new LevelpackManager("enigma_i");
+        lpmgr.registerLevels(this);
+        levelPacks.add(lpmgr);
+        lpmgr = new LevelpackManager("enigma_ii");
+        lpmgr.registerLevels(this);
+        levelPacks.add(lpmgr);
+        lpmgr = new LevelpackManager("enigma_iii");
+        lpmgr.registerLevels(this);
+        levelPacks.add(lpmgr);
+        lpmgr = new LevelpackManager("enigma_iv");
+        lpmgr.registerLevels(this);
+        levelPacks.add(lpmgr);
+        lpmgr = new LevelpackManager("enigma_v");
+        lpmgr.registerLevels(this);
+        levelPacks.add(lpmgr);
+        lpmgr = new LevelpackManager("enigma_vi");
+        lpmgr.registerLevels(this);
+        levelPacks.add(lpmgr);
+        lpmgr = new LevelpackManager("enigma_esprit");
+        lpmgr.registerLevels(this);
+        levelPacks.add(lpmgr);
+        lpmgr = new LevelpackManager("enigma_oxyd");
+        lpmgr.registerLevels(this);
+        levelPacks.add(lpmgr);
+        lpmgr = new LevelpackManager("enigma_peroxyd");
+        lpmgr.registerLevels(this);
+        levelPacks.add(lpmgr);
+        lpmgr = new LevelpackManager("enigma_oxydextra");
+        lpmgr.registerLevels(this);
+        levelPacks.add(lpmgr);
+        lpmgr = new LevelpackManager("enigma_oxydmagnum");
+        lpmgr.registerLevels(this);
+        levelPacks.add(lpmgr);
+        lpmgr = new LevelpackManager("enigma_sokoban");
+        lpmgr.registerLevels(this);
+        levelPacks.add(lpmgr);
+        lpmgr = new LevelpackManager("enigma_microban");
+        lpmgr.registerLevels(this);
+        levelPacks.add(lpmgr);
+        lpmgr = new LevelpackManager("enigma_mas_microban");
+        lpmgr.registerLevels(this);
+        levelPacks.add(lpmgr);
+        
+        for(Map.Entry<String, LevelScore> entry : levelScores.entrySet()) {
+            if (entry.getValue().isPartOfCurDist()) {
+                numDifficult++;
+                if (entry.getValue().hasEasyMode()) {
+                    numEasy++;
+                }
+            }
+            if (!levelPattern.equals("")) {
+                entry.getValue().setFullEvaluation(levelPattern);
+            }
+        }
+    }
+    
+    public LevelScore getLevelScore(String id, String scoreVersion) {
+        return levelScores.get(id + "_" + scoreVersion);
+    }
+    
+    public LevelScore newLevelScore(String id, String scoreVersion) {
+        Element level = doc.createElementNS(null, "level");
+        level.setAttributeNS(null, "id", id);
+        level.setAttributeNS(null, "sv", scoreVersion);
+        levelsElem.appendChild(level);
+        
+        LevelScore ls = new LevelScore(level, "", "", "", "");
+        String key = id + "_" + scoreVersion;
+        levelScores.put(key, ls);
+        
+        System.out.println("Missing Rating: id '" + id + "' score version "
+                + scoreVersion);
+        return ls;
+    }
+    
+    public void clearUserScores() {
+        for(Map.Entry<String, LevelScore> entry : levelScores.entrySet()) {
+            if (entry.getValue().isPartOfCurDist()) {
+                entry.getValue().resetUserSolved();
+            }
+        }
+    }
+    
+    public boolean isUserProfessional(UserManager userMgr, String userId) {
+        boolean isProfessional = false;
+        int userDiffCount = 0;
+        int userEasyCount = 0;
+        for(Map.Entry<String, LevelScore> entry : levelScores.entrySet()) {
+            LevelScore ls = entry.getValue();
+            if (ls.isPartOfCurDist()) {
+                if (ls.hasUserDiffSolved())
+                    userDiffCount++;
+//              else
+//                  System.out.println("Diff " + ls.getTitle() + " by " + ls.getAuthor() + " id " +  ls.getId());
+                if (ls.hasEasyMode()) {
+                    if (ls.hasUserEasySolved())
+                        userEasyCount++;
+//                  else
+//                      System.out.println("Easy " + ls.getTitle() + " by " + ls.getAuthor() + " id " +  ls.getId());
+                }
+            }
+        }
+        double solvedPercent = 100.0 * (userDiffCount + userEasyCount)/(numDifficult + numEasy);
+        Formatter formatter = new Formatter(Locale.US);
+        formatter.format("Solved diff %3d/%3d - easy %3d/%3d = %6.2f%%", userDiffCount,
+                numDifficult, userEasyCount, numEasy, solvedPercent);
+        System.out.println(formatter.toString());
+        if (solvedPercent > 10.0) {
+            isProfessional = true;
+            numProf++;
+        }
+        Formatter formatterTotal = new Formatter(Locale.US);
+        formatterTotal.format("%6.2f",  solvedPercent);
+        userMgr.setValue(userId, "solvedtotal", formatterTotal.toString());
+        
+        Formatter formatterEasy = new Formatter(Locale.US);
+        formatterEasy.format("%3d/%3d", userEasyCount, numEasy);
+        userMgr.setValue(userId, "solvede", formatterEasy.toString());
+        
+        Formatter formatterDiff = new Formatter(Locale.US);
+        formatterDiff.format("%3d/%3d", userDiffCount, numDifficult);
+        userMgr.setValue(userId, "solvedd", formatterDiff.toString());
+        
+        return isProfessional;
+    }
+    
+    public void evaluateUser(UserManager userMgr, String userId) {
+        System.out.println("Par Evalutation");
+        StringBuilder sb = new StringBuilder();
+        Formatter formatter = new Formatter(sb, Locale.US);
+        
+        for (LevelpackManager lpm : levelPacks) {
+            double hcpe = 0;
+            double hcpd = 0;
+            for (LevelScore ls : lpm.getLevelScores()) {
+                double dhcpd = levelHcp(ls.getUserScoreDiff(), ls.getParDiff());
+                hcpd += dhcpd;
+                if (ls.hasEasyMode())
+                    hcpe += levelHcp(ls.getUserScoreEasy(), ls.getParEasy());
+                else
+                    hcpe += dhcpd;
+            }
+            hcpd = hcpd * 100.0 / lpm.size();
+            hcpe = hcpe * 100.0 / lpm.size();
+            formatter.format("%25s  Diff = %6.1f  Easy = %6.1f%n",
+                    lpm.getName(), hcpd, hcpe);
+        }
+        double hcpsum = 0;
+        int levelsum = 0;
+        double hcpsumsolved = 0;
+        int levelsumsolved = 0;
+        int totalWRrcount = 0;
+        int sharedWRcount = 0;
+        for(Map.Entry<String, LevelScore> entry : levelScores.entrySet()) {
+            LevelScore ls = entry.getValue();
+            if (ls.isPartOfCurDist()) {
+                hcpsum += levelHcp(ls.getUserScoreDiff(), ls.getParDiff());
+                levelsum++;
+                if (ls.hasUserDiffSolved()) {
+                    hcpsumsolved += levelHcp(ls.getUserScoreDiff(), ls.getParDiff());
+                    levelsumsolved++;
+                }
+                if (ls.isUserWRHolderDiff()) {
+                    totalWRrcount++;
+                    if (!ls.isUniqueWRDiff())
+                        sharedWRcount++;
+                }
+                if (ls.hasEasyMode()) {
+                    hcpsum += levelHcp(ls.getUserScoreEasy(), ls.getParEasy());
+                    levelsum++;
+                    if (ls.hasUserEasySolved()) {
+                        hcpsumsolved += levelHcp(ls.getUserScoreEasy(), ls.getParEasy());
+                        levelsumsolved++;
+                    }
+                    if (ls.isUserWRHolderEasy()) {
+                        totalWRrcount++;
+                        if (!ls.isUniqueWREasy())
+                            sharedWRcount++;
+                    }                    
+                }
+            }
+        }
+        hcpsum = hcpsum * 100.0 / levelsum;
+        int unsolved = numDifficult + numEasy - levelsumsolved;
+        hcpsumsolved += unsolved / 10.0;  // add 10% of unsolved levels as unsuccessful attempts
+        levelsumsolved += unsolved / 10;
+        hcpsumsolved = hcpsumsolved  * 100.0 / levelsumsolved;
+        formatter.format("Enigma Total Hcp = %6.1f, Solved Hcp = %6.1f at %d levels",
+                hcpsum, hcpsumsolved, levelsum);
+        System.out.println(sb.toString());
+        
+        Formatter formatterHcpTotal = new Formatter(Locale.US);
+        formatterHcpTotal.format("%6.1f",  hcpsum);
+        userMgr.setValue(userId, "hcptotal", formatterHcpTotal.toString());
+        
+        Formatter formatterHcpSolved = new Formatter(Locale.US);
+        formatterHcpSolved.format("%6.1f",  hcpsumsolved);
+        userMgr.setValue(userId, "hcpsolved", formatterHcpSolved.toString());
+        
+        // future direct output of WR based only on registerd scores
+//         Formatter formatterWRtotal = new Formatter(Locale.US);
+//         formatterWRtotal.format("%3d",  totalWRrcount);
+//         userMgr.setValue(userId, "wrtotal", formatterWRtotal.toString());
+//         
+//         Formatter formatterWRshared = new Formatter(Locale.US);
+//         formatterWRshared.format("%3d",  sharedWRcount);
+//         userMgr.setValue(userId, "wrshared", formatterWRshared.toString());
+    }
+    
+    private double levelHcp(int score, double par) {
+        double dhcp = 0;
+        if (score == -1) {
+            dhcp = 1;
+        } else if (score == -2) {
+            dhcp = 0.7;
+        } else if (score >= par && par > 0) {
+            dhcp = Math.log10(score/par);
+            if (dhcp > 0.7)
+                dhcp = 0.7;
+        } else if (score < par && par > 0) {
+            dhcp = Math.log(score/par) / log_2;
+            if (dhcp < -3)
+                dhcp = -3;
+        } else { // par <= 0 no par
+            dhcp = -3;
+        }
+        return dhcp;
+    }
+    
+    public void finishLevelScores(int numUsers, UserManager userMgr) {
+        int diffSolved = 0;
+        int diffUnsolved = 0;
+        int easySolved = 0;
+        int easyUnsolved = 0;
+        for (Map.Entry<String, LevelScore> entry : levelScores.entrySet()) {
+            LevelScore ls = entry.getValue();
+            ls.finish(numUsers, numProf);
+            if (ls.isPartOfCurDist()) {
+                if (ls.isDiffSolved()) {
+                    diffSolved++;
+                } else {
+                    diffUnsolved++;
+                    System.out.println("Diff unsolved: " + entry.getKey()
+                            + " - " + ls.getTitle());
+                }
+                if (ls.hasEasyMode()) {
+                    if (ls.isEasySolved()) {
+                        easySolved++;
+                    } else {
+                        easyUnsolved++;
+                        System.out.println("Easy unsolved: " + entry.getKey()
+                                + " - " + ls.getTitle());
+                    }
+                }
+            }
+        }
+        System.out.println("Diff Levels " + numDifficult + " Easy Levels " + numEasy);
+        System.out.println("Diff Solved " + diffSolved + " / Unsolved " + diffUnsolved);
+        System.out.println("Easy Solved " + easySolved + " / Unsolved " + easyUnsolved);
+        LevelScore.printWRStatistics(userMgr);
+        
+        
+        try {
+            PrintWriter output = new PrintWriter(new FileWriter(new File("top_rated_levels.txt")), true);
+            output.println("Top Rated Levels (with more than one rating)");
+            List<LevelScore> topRatedLevel = new ArrayList<LevelScore>(levelScores.values());
+            LevelScore.ComparatorRating compRating = new LevelScore.ComparatorRating();
+            Collections.sort(topRatedLevel, compRating);
+            int topPosition = 1;
+            for (LevelScore ls : topRatedLevel) {
+                if (ls.getRatingNum() > 1) {
+                    Formatter formatterTopRatedLevel = new Formatter(Locale.US);
+                    formatterTopRatedLevel.format("%5.2f  %d  %-23s by %-18s (%s)",  ls.getRatingAvg(),
+                            ls.getRatingNum(), ls.getTitle(), ls.getAuthor(), ls.getId());
+                    output.println(formatterTopRatedLevel.toString());
+                    topPosition++;
+                    if (topPosition > 50)
+                        break;
+                }
+            }
+        } catch (Exception e) {
+        }
+        
+    }
+    
+    public void evaluateLevels() {
+        for (Map.Entry<String, LevelScore> entry : levelScores.entrySet()) {
+            LevelScore ls = entry.getValue();
+            ls.printLevelEvaluation();
+        }
+    }
+    
+    public void renameUser(String oldname, String newname) {
+        for(Map.Entry<String, LevelScore> entry : levelScores.entrySet()) {
+            entry.getValue().renameUser(oldname, newname);
+        }
+    }
+    
+    public void save(String url) {
+        //doc.normalizeDocument();
+        System.out.println("save " + url + " - "+ levelElems.getLength());
+        theApp.domWriter.writeToURI(doc, url);
+    }
+    
+    public String getDate() {
+        return updateElem.getAttribute("date");
+    }
+    
+    public void setDate(String date) {
+        if (date.equals("")) {
+            GregorianCalendar calendar = new GregorianCalendar(TimeZone.getTimeZone("GMT"));
+            Date now = new Date();
+            calendar.setTime(now);
+            XMLGregorianCalendar xmlCal;
+            try {
+                xmlCal = DatatypeFactory.newInstance().newXMLGregorianCalendar(calendar);
+                date = xmlCal.toXMLFormat();
+            } catch( Exception ex ) {
+                System.out.println("Ratings cannot set current update time");
+                ex.printStackTrace();
+            }
+        }
+        updateElem.setAttribute("date", date);
+    }
+    
+    public String getUrlFull() {
+        return updateElem.getAttribute("urlFull");
+    }
+    
+    public void setUrlFull(String url) {
+        updateElem.setAttribute("urlFull", url);
+    }
+    
+    public String getUrlIncremental() {
+        return updateElem.getAttribute("urlIncremental");
+    }
+    
+    public void setUrlIncremental(String url) {
+        updateElem.setAttribute("urlIncremental", url);
+    }
+    
+    public Set<Map<String,String>> getRatingData() {
+        Map<String, String> level;
+        Set<Map<String,String>> allData = new HashSet<Map<String,String>>();
+        for (int i = 0; i < levelElems.getLength(); i++) {
+            level = new HashMap<String, String>();
+            NamedNodeMap attributeNodes = levelElems.item(i).getAttributes();
+            for (int j = 0; j < attributeNodes.getLength(); j++) {
+                Attr attr = (Attr)attributeNodes.item(j);
+                level.put(attr.getName(), attr.getValue());
+            }
+            allData.add(level);
+        }
+        return allData;
+    }
+    
+    public void addRatingData(Set<Map<String,String>> additions) {
+        for (Map<String,String> rating : additions) {
+            Element level = doc.createElementNS(null, "level");
+            for (Map.Entry<String, String> attr : rating.entrySet()) {
+                level.setAttributeNS(null, attr.getKey(), attr.getValue());
+            }
+            levelsElem.appendChild(level);
+        }
+    }
+}


Property changes on: branches/eval/java/src/org/enigma_game/lev/RatingManager.java
___________________________________________________________________
Name: svn:eol-style
   + native

Added: branches/eval/java/src/org/enigma_game/lev/ScoreManager.java
===================================================================
--- branches/eval/java/src/org/enigma_game/lev/ScoreManager.java	2007-04-06 11:47:23 UTC (rev 683)
+++ branches/eval/java/src/org/enigma_game/lev/ScoreManager.java	2007-04-06 20:58:39 UTC (rev 684)
@@ -0,0 +1,259 @@
+/*
+ * Copyright (C) 2006, 2007 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+package org.enigma_game.lev;
+
+import java.io.*;
+import java.util.*; 
+import org.w3c.dom.*;
+import org.w3c.dom.ls.*;
+
+import org.enigma_game.EnigmaUtil;
+import org.enigma_game.lev.RatingManager;
+import org.enigma_game.lev.LevelScore;
+import org.enigma_game.lev.UserManager;
+
+public class ScoreManager {
+    EnigmaUtil theApp = org.enigma_game.EnigmaUtil.theApp;
+    Document doc;
+    NodeList propertyElems;
+    Element levelsElem;
+    NodeList levelElems;
+    boolean isProfessional = false;
+    short[] ctab = new short[256];
+    short pol = 0x1021;
+    
+    public ScoreManager(InputStream bStream) {
+        for (int i = 0; i < 256; i++) {
+            int r = i << 8;
+            for (int j = 0; j < 8; j++) {
+                boolean bit = (r & 0x8000) != 0;
+                r <<= 1;
+                if (bit)
+                    r ^= pol;
+            }
+            ctab[i] = (short)(r & 0xFFFF);
+        }
+        
+        LSInput input = theApp.domImpl.createLSInput();
+        input.setByteStream(bStream);
+        doc = theApp.domParser.parse(input);
+        
+        DOMConfiguration config = doc.getDomConfig();
+        config.setParameter("error-handler", theApp);
+        
+        propertyElems = doc.getElementsByTagName("property");
+        levelsElem = (Element) doc.getElementsByTagName("levels").item(0);
+        levelElems = doc.getElementsByTagName("level");
+    }
+    
+    public void save(OutputStream bStream) {
+        LSOutput dOut = theApp.domImpl.createLSOutput();
+        dOut.setByteStream(bStream);
+        theApp.domWriter.write(doc, dOut);
+    }
+    
+    public int getScoreElemsCount() {
+        return levelElems.getLength();
+    }
+
+    public String getProperty(String key) {
+        for (int i = 0; i < propertyElems.getLength(); i++) {
+            Element e = (Element) propertyElems.item(i);
+            if (e.getAttribute("key").equals(key)) {
+                if (key.equals("UserName"))
+                    return e.getAttribute("value").trim();
+                else
+                    return e.getAttribute("value");
+            }
+        }
+        return "";
+    }
+    
+    private String sec(String input) {
+        byte[] target = new byte[0];
+        try {
+            target = input.getBytes("UTF-8");
+        } catch (UnsupportedEncodingException e) {
+        }
+        int len = target.length;
+        int r = 0;
+        
+        for (int i = 0; i < len; i++)
+            r = (r<<8 & 0xFFFF) ^ ctab[((r >>> 8) ^ target[i]) & 0xFF];
+        Formatter formatter = new Formatter(Locale.US);
+        formatter.format("%04X", r & 0xFFFF);
+        return formatter.toString();
+    }
+    
+    public boolean checkUser(UserManager userMgr) {
+        String id = getProperty("UserId");
+        String id_1_00 = getProperty("UserId1.00");
+        String userName = userMgr.getValue(id, "name");
+        boolean result = false;
+        
+        if (getProperty("UserName").equals("") && userName.equals("")) {
+            System.out.println("No user name given in score file!");
+            return false;
+        } else if (getProperty("UserName").contains("+")) {
+            System.out.println("User name contains '+'!");
+            return false;
+        } else if (getProperty("UserName").length() > 20) {
+            System.out.println("User name too long");
+            return false;
+        }
+        
+        if (!id_1_00.equals("")) {
+            if (userMgr.getValue(id_1_00, "name").equals(getProperty("UserName"))) {
+                // the user did reId since last score registration - update
+                userMgr.setValue(id_1_00, "id", id);
+                System.out.println("User did reId! Old Id = '" + id_1_00 + "'");
+                userName = userMgr.getValue(id, "name");
+            } else if (!userMgr.getValue(id_1_00, "id").equals("")) {
+                // a user may have reId and renamed or it is another user
+                // that used the same 1.00 id.
+                System.out.println("User id 1.00 still in use by another user");
+                return false;
+            }
+        }
+        
+        if (userName.equals(getProperty("UserName"))) {
+            // user exists with same id and name
+            if (Integer.parseInt(getProperty("Count")) >
+                    Integer.parseInt(userMgr.getValue(id, "savecount"))) {
+                userMgr.setValue(id, "savecount", getProperty("Count"));
+                result = true;
+            } else {
+                System.out.println("Outdated scores not registered!");
+            }
+        } else if (userName.equals("")) {
+            // no user registered with the id
+            if (userMgr.isNameFree(getProperty("UserName"))) {
+                userMgr.setValue(id, "name", getProperty("UserName"));
+                userMgr.setValue(id, "savecount", getProperty("Count"));
+                result = true;
+            } else
+                System.out.println("Error - new user with name in use '"
+                        + getProperty("UserName") +"'");
+        } else {
+            // name mismatch - changed name or second user with same id
+            if (Integer.parseInt(getProperty("Count")) >
+                    Integer.parseInt(userMgr.getValue(id, "savecount"))) {
+                // looks like a valid name change
+                if (getProperty("UserName").equals("")) {
+                    // do not rename to an empty name
+                    userMgr.setValue(id, "savecount", getProperty("Count"));
+                    return true;
+                } else if (userMgr.isNameFree(getProperty("UserName")) ||
+                    userMgr.getValue(id, "newname").equals(getProperty("UserName"))) {
+                    System.out.println("Warning: user name change from '" 
+                            + userName + "' to '" + getProperty("UserName") + "'");
+                    userMgr.setValue(id, "newname", getProperty("UserName"));
+                    userMgr.setValue(id, "savecount", getProperty("Count"));
+                    result = true;
+                } else {
+                    // new name in use by another user
+                    System.out.println("Error: user name change from '" 
+                            + userName + "' to the already used name '"
+                            + getProperty("UserName") +"'");
+                }
+            } else {
+                // must be a second user with the same id
+                System.out.println("Id mismatch - id already in use!");
+            }
+        }
+        return result;
+    }
+    
+    public void checkScores(RatingManager ratingMgr, UserManager userMgr, boolean checkSec) {
+        ratingMgr.clearUserScores();
+        String user = getProperty("UserName");
+        String userId = getProperty("UserId");
+        int numRatings = 0;
+        int sumRatings = 0;
+        for (int i = 0; i < levelElems.getLength(); i++) {
+            Element e = (Element) levelElems.item(i);
+            LevelScore ls = ratingMgr.getLevelScore(e.getAttribute("id"),
+                    e.getAttribute("version"));
+            if (ls != null) {
+                String rating = e.getAttribute("rating");
+                int urat = -1;
+                if (rating.length() > 0)
+                    urat = Integer.parseInt(rating);
+                if (urat > -1) {
+                    numRatings++;
+                    sumRatings += urat;
+                }
+                ls.registerSolvage(user, e.getAttribute("diff1"), 
+                        e.getAttribute("easy1"));
+            }
+            if (checkSec) {
+                NamedNodeMap attrXMap = e.getAttributes();
+                Map<String, String> attrMap = new TreeMap<String, String>(); // sorted Map
+                for (int j = 0, k = attrXMap.getLength(); j < k; j++) {
+                    Attr levelAttr = (Attr)(attrXMap.item(j));
+                    if (!levelAttr.getName().equals("sec") && levelAttr.getSpecified()) 
+                        attrMap.put(levelAttr.getName(), levelAttr.getValue());
+                }
+                String target = "";
+                for (Map.Entry<String, String> attrEntry : attrMap.entrySet())
+                    target += attrEntry.getValue();
+                target += userId;
+                if (!sec(target).equals(e.getAttribute("sec")))
+                    System.out.println("Faulty score entry!! " + target + " is " 
+                            + sec(target) + "  should be " + e.getAttribute("sec"));
+            }
+        }
+        double avgRating = -1.0;
+        if (numRatings > 0)
+            avgRating = ((float)sumRatings)/numRatings;
+        Formatter formatter = new Formatter(Locale.US);
+        formatter.format("Ratings count %d, avg %5.2f", numRatings, avgRating);
+        System.out.println(formatter.toString());
+        
+        Formatter formatterRatcount = new Formatter(Locale.US);
+        formatterRatcount.format("%3d", numRatings);
+        userMgr.setValue(getProperty("UserId"), "ratcount", formatterRatcount.toString());
+        
+        Formatter formatterRatAvg = new Formatter(Locale.US);
+        formatterRatAvg.format("%5.2f",  avgRating);
+        userMgr.setValue(userId, "ratavg", formatterRatAvg.toString());
+                
+        isProfessional = ratingMgr.isUserProfessional(userMgr, getProperty("UserId"));
+    }
+    
+    public void evaluateScores(RatingManager ratingMgr) {
+        String user = getProperty("UserName");
+        for (int i = 0; i < levelElems.getLength(); i++) {
+            Element e = (Element) levelElems.item(i);
+            LevelScore ls = ratingMgr.getLevelScore(e.getAttribute("id"),
+                    e.getAttribute("version"));
+            if (ls != null) {
+                String rating = e.getAttribute("rating");
+                int urat = -1;
+                if (rating.length() > 0)
+                    urat = Integer.parseInt(rating);
+                ls.registerScore(user, isProfessional, rating,
+                        e.getAttribute("diff1"),  e.getAttribute("diff1rel"), 
+                        e.getAttribute("easy1"), e.getAttribute("easy1rel"),
+                        e.getAttribute("diff2"),  e.getAttribute("diff2rel"), 
+                        e.getAttribute("easy2"), e.getAttribute("easy2rel"));
+            }
+        }
+    }
+}


Property changes on: branches/eval/java/src/org/enigma_game/lev/ScoreManager.java
___________________________________________________________________
Name: svn:eol-style
   + native

Added: branches/eval/java/src/org/enigma_game/lev/UserManager.java
===================================================================
--- branches/eval/java/src/org/enigma_game/lev/UserManager.java	2007-04-06 11:47:23 UTC (rev 683)
+++ branches/eval/java/src/org/enigma_game/lev/UserManager.java	2007-04-06 20:58:39 UTC (rev 684)
@@ -0,0 +1,171 @@
+/*
+ * Copyright (C) 2006, 2007 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+package org.enigma_game.lev;
+
+import java.io.*;
+import java.text.*;
+import java.util.*; 
+import org.w3c.dom.*;
+import org.w3c.dom.ls.*;
+
+import org.enigma_game.EnigmaUtil;
+
+public class UserManager {
+    EnigmaUtil theApp = org.enigma_game.EnigmaUtil.theApp;
+    Document doc;
+    Element usersElem;
+    NodeList userElems;
+    Map<String, Element> idElementMap = new HashMap<String, Element>();
+    Set<String> nameSet = new HashSet<String>();
+    
+    public UserManager(String url) {
+        doc = theApp.domParser.parseURI(url);
+        
+        DOMConfiguration config = doc.getDomConfig();
+        config.setParameter("error-handler", theApp);
+        
+        usersElem = (Element) doc.getElementsByTagName("users").item(0);
+        userElems = doc.getElementsByTagName("user");
+        
+        for (int i = 0; i < userElems.getLength(); i++) {
+            Element e = (Element) userElems.item(i);
+            idElementMap.put(e.getAttribute("id"), e);
+            nameSet.add(e.getAttribute("name"));
+            String newname = e.getAttribute("newname");
+            if (!newname.equals("")) {
+                nameSet.add(newname);
+            }
+        }
+    }
+    
+    public Set<String> getUserIds() {
+        return idElementMap.keySet();
+    }
+    
+    public boolean isNameFree(String name) {
+        return !nameSet.contains(name);
+    }
+    
+    public String getValue(String id, String key) {
+        Element e = idElementMap.get(id);
+        return e == null ? "" : e.getAttribute(key);
+    }
+    
+    public void setValue(String id, String key, String value) {
+        Element e = idElementMap.get(id);
+        if (e == null && key.equals("name")) {
+            if (isNameFree(value)) {
+                nameSet.add(value);
+                // create element first
+                Element user = doc.createElementNS(null, "user");
+                user.setAttributeNS(null, "id", id);
+                user.setAttributeNS(null, "name", value);
+                usersElem.appendChild(user);
+                idElementMap.put(id, user);
+            }
+        } else if (e != null) {
+            if (key.equals("newname") && !value.equals("")) {
+                nameSet.add(value);
+            } else if (key.equals("id") && !value.equals("")) {
+                idElementMap.put(value, e);  // add element with new id
+                idElementMap.remove(id);     // remove element with old id
+            }
+            e.setAttributeNS(null, key, value);
+        }
+    }
+    
+    public void save(String url) {
+        //doc.normalizeDocument();
+        System.out.println("save " + url + " - "+ userElems.getLength());
+        theApp.domWriter.writeToURI(doc, url);
+    }
+    
+    public class ComparatorName implements Comparator<String> {
+        public ComparatorName() {
+        }
+        
+        public int compare(String id1, String id2) {
+            final Collator usCollator = Collator.getInstance(Locale.US);
+            return usCollator.compare(getValue(id1, "name"),getValue(id2, "name"));
+        }
+    }
+    
+    public class ComparatorWRTotal implements Comparator<String> {
+        public ComparatorWRTotal() {
+        }
+        
+        public int compare(String id1, String id2) {
+            String wrtotal1 = getValue(id1, "wrtotal");
+            int wrTotal1 = (!wrtotal1.equals("")) ? Integer.parseInt(wrtotal1.trim()) : 0;
+            String wrtotal2 = getValue(id2, "wrtotal");
+            int wrTotal2 = (!wrtotal2.equals("")) ? Integer.parseInt(wrtotal2.trim()) : 0;
+            String wrshared1 = getValue(id1, "wrshared");
+            int wrShared1 = (!wrshared1.equals("")) ? Integer.parseInt(wrshared1.trim()) : 0;
+            String wrshared2 = getValue(id2, "wrshared");
+            int wrShared2 = (!wrshared2.equals("")) ? Integer.parseInt(wrshared2.trim()) : 0;
+            int result = wrTotal2 - wrTotal1;
+            if (result == 0)
+                result = wrShared1 - wrShared2;
+            return result;
+        }
+    }
+    
+    public class ComparatorSolved implements Comparator<String> {
+        public ComparatorSolved() {
+        }
+        
+        public int compare(String id1, String id2) {
+            String solvedtotal1 = getValue(id1, "solvedtotal");
+            double solvedTotal1 = (!solvedtotal1.equals("")) ? Double.parseDouble(solvedtotal1.trim()) : 0;
+            String solvedtotal2 = getValue(id2, "solvedtotal");
+            double solvedTotal2 = (!solvedtotal2.equals("")) ? Double.parseDouble(solvedtotal2.trim()) : 0;
+            int result = ( solvedTotal1 < solvedTotal2) ? 1 : ((solvedTotal1 == solvedTotal2) ? 0 : -1);
+            return result;
+        }
+    }
+    
+    public class ComparatorHcpTotal implements Comparator<String> {
+        public ComparatorHcpTotal() {
+        }
+        
+        public int compare(String id1, String id2) {
+            String hcptotal1 = getValue(id1, "hcptotal");
+            double hcpTotal1 = (!hcptotal1.equals("")) ? Double.parseDouble(hcptotal1.trim()) : 100;
+            String hcptotal2 = getValue(id2, "hcptotal");
+            double hcpTotal2 = (!hcptotal2.equals("")) ? Double.parseDouble(hcptotal2.trim()) : 100;
+            int result = ( hcpTotal1 < hcpTotal2) ? -1 : ((hcpTotal1 == hcpTotal2) ? 0 : 1);
+            return result;
+        }
+    }
+    
+    public class ComparatorHcpSolved implements Comparator<String> {
+        public ComparatorHcpSolved() {
+        }
+        
+        public int compare(String id1, String id2) {
+            String hcpsolved1 = getValue(id1, "hcpsolved");
+            double hcpSolved1 = (!hcpsolved1.equals("")) ? Double.parseDouble(hcpsolved1.trim()) : 100;
+            String hcpsolved2 = getValue(id2, "hcpsolved");
+            double hcpSolved2 = (!hcpsolved2.equals("")) ? Double.parseDouble(hcpsolved2.trim()) : 100;
+            int result = ( hcpSolved1 < hcpSolved2) ? -1 : ((hcpSolved1 == hcpSolved2) ? 0 : 1);
+            return result;
+        }
+    }
+    
+}


Property changes on: branches/eval/java/src/org/enigma_game/lev/UserManager.java
___________________________________________________________________
Name: svn:eol-style
   + native

Added: branches/eval/java/src/org/enigma_game/resources/schemas/users.xsd
===================================================================
--- branches/eval/java/src/org/enigma_game/resources/schemas/users.xsd	2007-04-06 11:47:23 UTC (rev 683)
+++ branches/eval/java/src/org/enigma_game/resources/schemas/users.xsd	2007-04-06 20:58:39 UTC (rev 684)
@@ -0,0 +1,40 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<xs:schema xmlns:xs='http://www.w3.org/2001/XMLSchema' version="0.1" xml:lang="en">
+  <xs:annotation>
+    <xs:documentation>
+      XML schema definitions for Enigma user
+      Copyright ? 2007 Ronald Lamprecht
+      GPL2
+    </xs:documentation>
+  </xs:annotation>
+  <xs:element name="users">
+    <xs:annotation>
+      <xs:documentation>
+        User data:
+        id         - level id
+      </xs:documentation>
+    </xs:annotation>
+    <xs:complexType>
+      <xs:sequence>
+        <xs:element name="user" minOccurs="0" maxOccurs="unbounded" >
+          <xs:complexType>
+            <xs:attribute name="id" type="xs:string" use="required"/>
+            <xs:attribute name="name" type="xs:string" use="required"/>
+            <xs:attribute name="newname" type="xs:string" use="optional" default=""/>
+            <xs:attribute name="savecount" type="xs:int" use="optional" default="0"/>
+            <xs:attribute name="ratcount" type="xs:int" use="optional" default="0"/>
+            <xs:attribute name="ratavg" type="xs:float" use="optional" default="-1"/>
+            <xs:attribute name="wrtotal" type="xs:int" use="optional" default="0"/>
+            <xs:attribute name="wrshared" type="xs:int" use="optional" default="0"/>
+            <xs:attribute name="solvedtotal" type="xs:float" use="optional" default="0"/>
+            <xs:attribute name="solvede" type="xs:string" use="optional" default="0/0"/>
+            <xs:attribute name="solvedd" type="xs:string" use="optional" default="0/0"/>
+            <xs:attribute name="hcptotal" type="xs:float" use="optional" default="100"/>
+            <xs:attribute name="hcpsolved" type="xs:float" use="optional" default="100"/>
+            <xs:anyAttribute namespace="##targetNamespace" processContents="skip"/>
+          </xs:complexType>
+        </xs:element> <!-- user -->
+      </xs:sequence>
+    </xs:complexType>
+  </xs:element> <!-- users -->
+</xs:schema>


Property changes on: branches/eval/java/src/org/enigma_game/resources/schemas/users.xsd
___________________________________________________________________
Name: svn:eol-style
   + native

Added: branches/eval/java/src/org/enigma_game/util/LevelEvaluation.java
===================================================================
--- branches/eval/java/src/org/enigma_game/util/LevelEvaluation.java	2007-04-06 11:47:23 UTC (rev 683)
+++ branches/eval/java/src/org/enigma_game/util/LevelEvaluation.java	2007-04-06 20:58:39 UTC (rev 684)
@@ -0,0 +1,53 @@
+/*
+ * Copyright (C) 2006, 2007 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+package org.enigma_game.util;
+
+import java.io.*;
+import java.util.*; 
+import java.util.zip.*;
+import org.enigma_game.EnigmaUtil;
+import org.enigma_game.lev.RatingManager;
+import org.enigma_game.lev.ScoreManager;
+import org.enigma_game.lev.UserManager;
+
+public class LevelEvaluation {
+    EnigmaUtil theApp = org.enigma_game.EnigmaUtil.theApp;
+    
+    public LevelEvaluation(String rating, String userUrl, String levelPattern,
+            String[] scoreFiles, int firstIndex) {
+        try {
+            System.out.println("LevelEvaluation");
+            RatingManager ratingMgr = new RatingManager(rating);
+            ratingMgr.setUpLevelScores(levelPattern);
+            UserManager userMgr = new UserManager(userUrl);
+            
+            for (int i = firstIndex; i < scoreFiles.length; i++) {
+                ZipInputStream zin = new ZipInputStream(new BufferedInputStream(new FileInputStream(scoreFiles[i])));
+                zin.getNextEntry();
+                ScoreManager scm = new ScoreManager(zin);
+                scm.checkScores(ratingMgr, userMgr, false);
+            }
+            ratingMgr.evaluateLevels();
+            
+            System.out.println("LevelEvaluation finished");
+        } catch ( Exception ex ) {
+            ex.printStackTrace();
+        }
+    }
+}


Property changes on: branches/eval/java/src/org/enigma_game/util/LevelEvaluation.java
___________________________________________________________________
Name: svn:eol-style
   + native

Added: branches/eval/java/src/org/enigma_game/util/RatingDiff.java
===================================================================
--- branches/eval/java/src/org/enigma_game/util/RatingDiff.java	2007-04-06 11:47:23 UTC (rev 683)
+++ branches/eval/java/src/org/enigma_game/util/RatingDiff.java	2007-04-06 20:58:39 UTC (rev 684)
@@ -0,0 +1,85 @@
+/*
+ * Copyright (C) 2006, 2007 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+package org.enigma_game.util;
+
+import java.util.*; 
+import org.enigma_game.EnigmaUtil;
+import org.enigma_game.lev.RatingManager;
+
+public class RatingDiff {
+    EnigmaUtil theApp = org.enigma_game.EnigmaUtil.theApp;
+    
+    public RatingDiff(String oldRatingUrl, String newRatingUrl) {
+        try {
+            System.out.println("Start building ratings diff.");
+            System.out.println("parse " + oldRatingUrl);
+            RatingManager oldRating = new RatingManager(oldRatingUrl);
+            System.out.println("parse " + newRatingUrl);
+            RatingManager newRating = new RatingManager(newRatingUrl);
+
+            System.out.println("parse template for incremental ratings");
+            RatingManager incRating = new RatingManager(
+                    RatingDiff.class.getResource(theApp.RESOURCES + "schemas/ratings.xml").toString());
+            System.out.println("parse template for dummy incremental ratings");
+            RatingManager incDummyRating = new RatingManager(
+                    RatingDiff.class.getResource(theApp.RESOURCES + "schemas/ratings.xml").toString());
+            
+            incRating.setDate(newRating.getDate());
+            incDummyRating.setDate(newRating.getDate());
+            
+            newRating.setUrlFull(oldRating.getUrlFull());
+            incRating.setUrlFull(oldRating.getUrlFull());
+            incDummyRating.setUrlFull(oldRating.getUrlFull());
+            
+            String oldUrlIncr = oldRating.getUrlIncremental();
+            String incVersionString = oldUrlIncr.substring(oldUrlIncr.length() - 7,
+                    oldUrlIncr.length() - 4);
+            int incVersion = Integer.parseInt(incVersionString);
+            
+            int incNewVersion = incVersion + 1;
+            String incNewVersionString = Integer.toString(incNewVersion);
+            if (incNewVersionString.length() == 1)
+                incNewVersionString = "00" + incNewVersionString;
+            else if (incVersionString.length() == 2)
+                incNewVersionString = "0" + incNewVersionString;
+            
+            String newUrlIncr = oldUrlIncr.substring(0, oldUrlIncr.length() - 7)
+                    + incNewVersionString + ".xml";
+            
+            newRating.setUrlIncremental(newUrlIncr);
+            incRating.setUrlIncremental(newUrlIncr);
+            incDummyRating.setUrlIncremental(newUrlIncr);
+            
+            Set<Map<String,String>> oldLevels = oldRating.getRatingData();
+            Set<Map<String,String>> newLevels = newRating.getRatingData();
+            System.out.println("Level count old " + oldLevels.size() + " - new " + newLevels.size());
+            
+            newLevels.removeAll(oldLevels);
+            System.out.println("Level count diff " + newLevels.size());
+            incRating.addRatingData(newLevels);
+            
+            newRating.save("ratings.xml");
+            incRating.save("ratings_i" + incVersionString + ".xml");
+            incDummyRating.save("ratings_i" + incNewVersionString + ".xml");
+            System.out.println("Finished building ratings diff.");
+        } catch ( Exception ex ) {
+            ex.printStackTrace();
+        }
+    }
+}


Property changes on: branches/eval/java/src/org/enigma_game/util/RatingDiff.java
___________________________________________________________________
Name: svn:eol-style
   + native

Added: branches/eval/java/src/org/enigma_game/util/ScoreEvaluation.java
===================================================================
--- branches/eval/java/src/org/enigma_game/util/ScoreEvaluation.java	2007-04-06 11:47:23 UTC (rev 683)
+++ branches/eval/java/src/org/enigma_game/util/ScoreEvaluation.java	2007-04-06 20:58:39 UTC (rev 684)
@@ -0,0 +1,61 @@
+/*
+ * Copyright (C) 2006, 2007 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+package org.enigma_game.util;
+
+import java.io.*;
+import java.util.*; 
+import java.util.zip.*;
+import org.enigma_game.EnigmaUtil;
+import org.enigma_game.lev.RatingManager;
+import org.enigma_game.lev.ScoreManager;
+import org.enigma_game.lev.UserManager;
+
+public class ScoreEvaluation {
+    EnigmaUtil theApp = org.enigma_game.EnigmaUtil.theApp;
+    
+    public ScoreEvaluation(String ratingIn, String ratingOut, String userUrl,
+            String[] scoreFiles, int firstIndex) {
+        try {
+            System.out.println("ScoreEvaluation");
+            RatingManager ratingMgr = new RatingManager(ratingIn);
+            ratingMgr.setUpLevelScores("");
+            UserManager userMgr = new UserManager(userUrl);
+            
+            int numUsers = 0;
+            for (int i = firstIndex; i < scoreFiles.length; i++) {
+                ZipInputStream zin = new ZipInputStream(new BufferedInputStream(new FileInputStream(scoreFiles[i])));
+                zin.getNextEntry();
+                ScoreManager scm = new ScoreManager(zin);
+                scm.checkUser(userMgr);
+                scm.checkScores(ratingMgr, userMgr, false);
+                scm.evaluateScores(ratingMgr);
+                numUsers++;
+            }
+            
+            ratingMgr.finishLevelScores(numUsers, userMgr);
+            ratingMgr.setDate("");
+            ratingMgr.save(ratingOut);
+            userMgr.save(userUrl);
+            
+            System.out.println("ScoreEvaluation finished");
+        } catch ( Exception ex ) {
+            ex.printStackTrace();
+        }
+    }
+}


Property changes on: branches/eval/java/src/org/enigma_game/util/ScoreEvaluation.java
___________________________________________________________________
Name: svn:eol-style
   + native

Added: branches/eval/java/src/org/enigma_game/util/ScoreRegistration.java
===================================================================
--- branches/eval/java/src/org/enigma_game/util/ScoreRegistration.java	2007-04-06 11:47:23 UTC (rev 683)
+++ branches/eval/java/src/org/enigma_game/util/ScoreRegistration.java	2007-04-06 20:58:39 UTC (rev 684)
@@ -0,0 +1,108 @@
+/*
+ * Copyright (C) 2006, 2007 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+package org.enigma_game.util;
+
+import java.io.*;
+import java.util.*; 
+import java.util.zip.*;
+import org.enigma_game.EnigmaUtil;
+import org.enigma_game.lev.RatingManager;
+import org.enigma_game.lev.ScoreManager;
+import org.enigma_game.lev.UserManager;
+
+public class ScoreRegistration {
+    EnigmaUtil theApp = org.enigma_game.EnigmaUtil.theApp;
+    
+    public ScoreRegistration(String url, String ratingUrl, String userUrl) {
+        try {
+            System.out.println("ScoreRegistration");
+            
+            RatingManager ratingMgr = new RatingManager(ratingUrl);
+            ratingMgr.setUpLevelScores("");
+
+            BufferedInputStream bin = new BufferedInputStream(new FileInputStream(url));
+            ByteArrayOutputStream baout = new ByteArrayOutputStream();
+            int c;
+            while ((c = bin.read()) != -1)
+                baout.write(c ^ 0xE5);
+            byte[] ba = baout.toByteArray();
+            int basize = baout.size();
+            
+            if ((ba[0x06] & 0x08) == 0) {
+                // zipios++ patch needed for 1.00 beta scores:
+                //   1.00 beta did not patch the zips produced by zipios++.
+                //   The zips are malformed and unreadable by most zip 
+                //   programs including java. This is a just a minimum fix
+                //   to get the zips java readable. A more complete fix
+                //   is performed in the 1.00 Enigma sources.
+                ba[0x0E] = ba[basize - 61];  // copy CRC from end to start
+                ba[0x0F] = ba[basize - 60];
+                ba[0x10] = ba[basize - 59];
+                ba[0x11] = ba[basize - 58];
+                int compsize = basize - 77 - 39;
+                ba[0x12] = (byte)((char)(compsize & 0xFF)) ;  // copy compressed size
+                ba[0x13] = (byte)((char)(compsize & 0xFF00) >>> 8);
+                ba[0x14] = (byte)((char)(compsize & 0xFF0000) >>> 16);
+                ba[0x15] = (byte)((char)(compsize & 0xFF000000) >>> 24);
+                ba[0x16] = ba[basize - 53];  // copy orig size
+                ba[0x17] = ba[basize - 52];
+                ba[0x18] = ba[basize - 51];
+                ba[0x19] = ba[basize - 50];
+            }
+            
+//             BufferedOutputStream out = new BufferedOutputStream(new FileOutputStream("score.zip"));
+//             for (int i = 0; i < basize; i++)
+//                 out.write(ba[i]);
+//             out.flush();
+            
+            ZipInputStream zin = new ZipInputStream(new ByteArrayInputStream(ba));
+            zin.getNextEntry();
+
+//             BufferedOutputStream out = new BufferedOutputStream(new FileOutputStream("score.xml"));
+//             
+//             int co;
+//             while ((co = zin.read()) != -1)
+//                out.write(co);
+//             out.flush();
+
+            UserManager userMgr = new UserManager(userUrl);
+            
+            ScoreManager scm = new ScoreManager(zin);
+            String userId = scm.getProperty("UserId");
+            System.out.println("User '" + scm.getProperty("UserName") +
+                    "' - Id '" + userId + "'");
+            System.out.println("Score version = " + scm.getProperty("Count")
+                    + ", elements = " + scm.getScoreElemsCount());
+            
+            if (scm.checkUser(userMgr)) {
+                scm.checkScores(ratingMgr, userMgr, true);
+    
+                ZipOutputStream zout = new ZipOutputStream (new BufferedOutputStream(
+                        new FileOutputStream(userId +".zip")));
+                ZipEntry ze = new ZipEntry("score.xml");
+                zout.putNextEntry(ze);
+                scm.save(zout);
+                zout.close();
+                userMgr.save(userUrl);
+            }
+        } catch ( Exception ex ) {
+            ex.printStackTrace();
+        }
+    }
+}


Property changes on: branches/eval/java/src/org/enigma_game/util/ScoreRegistration.java
___________________________________________________________________
Name: svn:eol-style
   + native

Added: branches/eval/java/src/org/enigma_game/util/UserEvaluation.java
===================================================================
--- branches/eval/java/src/org/enigma_game/util/UserEvaluation.java	2007-04-06 11:47:23 UTC (rev 683)
+++ branches/eval/java/src/org/enigma_game/util/UserEvaluation.java	2007-04-06 20:58:39 UTC (rev 684)
@@ -0,0 +1,176 @@
+/*
+ * Copyright (C) 2006, 2007 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+package org.enigma_game.util;
+
+import java.io.*;
+import java.util.*; 
+import java.util.zip.*;
+import org.enigma_game.EnigmaUtil;
+import org.enigma_game.lev.RatingManager;
+import org.enigma_game.lev.ScoreManager;
+import org.enigma_game.lev.UserManager;
+
+public class UserEvaluation {
+    EnigmaUtil theApp = org.enigma_game.EnigmaUtil.theApp;
+    
+    public UserEvaluation(String rating, String userUrl,
+            String[] scoreFiles, int firstIndex) {
+        try {
+            System.out.println("UserEvaluation");
+            RatingManager ratingMgr = new RatingManager(rating);
+            ratingMgr.setUpLevelScores("");
+            UserManager userMgr = new UserManager(userUrl);
+            PrintWriter htmlOut;
+            
+            GregorianCalendar calendar = new GregorianCalendar(TimeZone.getTimeZone("GMT"));
+            Date now = new Date();
+            calendar.setTime(now);
+            calendar.add(Calendar.DATE, -15);  // monthly evaluation within first 2 weeks of next month
+            Formatter formatter = new Formatter(Locale.US);
+            formatter.format("%1$tB %1$tY",calendar);
+
+            int numUsers = 0;
+            for (int i = firstIndex; i < scoreFiles.length; i++) {
+                ZipInputStream zin = new ZipInputStream(new BufferedInputStream(new FileInputStream(scoreFiles[i])));
+                zin.getNextEntry();
+                ScoreManager scm = new ScoreManager(zin);
+                System.out.println("User '" + scm.getProperty("UserName") +
+                        "' - Id '" + scm.getProperty("UserId") + "'");
+                scm.checkScores(ratingMgr, userMgr, false);
+                ratingMgr.evaluateUser(userMgr, scm.getProperty("UserId"));
+                System.out.println("");
+                numUsers++;
+            }
+            userMgr.save(userUrl);
+            
+            System.out.println("");
+            System.out.println("User Names:");
+            htmlOut = new PrintWriter(new FileWriter(new File("userlist.html")), true);
+            htmlOut.println("<div class=\"usernames\">");
+            htmlOut.println("Names in use:");
+            htmlOut.println("  <ul>");
+            List<String> userName = new ArrayList<String>(userMgr.getUserIds());
+            UserManager.ComparatorName compName = userMgr.new ComparatorName();
+            Collections.sort(userName, compName);
+            for (String id : userName) {
+                System.out.println(userMgr.getValue(id, "name"));
+                htmlOut.println("    <li>" + userMgr.getValue(id, "name") + "</li>");
+            }
+            htmlOut.println("  </ul>");
+            htmlOut.println("</div>");
+            htmlOut.flush();
+            
+            htmlOut = new PrintWriter(new FileWriter(new File("table-wr.html")), true);
+            System.out.println("");
+            System.out.println("Worldrecord Statistics:");
+            System.out.print("total (shared) - users");
+            htmlOut.println("  <table>");
+            htmlOut.println("    <caption>Worldrecord Statistics of " + formatter.toString() + "</caption>");
+            htmlOut.println("    <colgroup><col width=\"80\"><col width=\"80\"><col width=\"470\"></colgroup>");
+            htmlOut.print("    <tr><th>total</th><th>shared</th><th class=\"left\">users</th></tr>");
+            List<String> userByWR = new ArrayList<String>(userMgr.getUserIds());
+            UserManager.ComparatorWRTotal compWRTotal = userMgr.new ComparatorWRTotal();
+            Collections.sort(userByWR, compWRTotal);
+            String lastId = "";
+            for (String id : userByWR) {
+                if (compWRTotal.compare(lastId, id) != 0) {
+                    System.out.println("");
+                    System.out.print("  " + userMgr.getValue(id, "wrtotal") + " ("
+                            + userMgr.getValue(id, "wrshared") + ") - '"
+                            + userMgr.getValue(id, "name") + "'");
+                    if (lastId.equals(""))
+                        htmlOut.println("");
+                    else
+                        htmlOut.println("</td></tr>");
+                    htmlOut.print("    <tr><td class=\"num\">" + userMgr.getValue(id, "wrtotal")
+                            + "</td><td class=\"num\">" + userMgr.getValue(id, "wrshared")
+                            + "</td><td class=\"left\">'" + userMgr.getValue(id, "name") + "'");
+                } else {
+                    System.out.print("+'" + userMgr.getValue(id, "name") + "'");
+                    htmlOut.print(" + '" + userMgr.getValue(id, "name") + "'");
+                }
+                lastId = id;
+            }
+            System.out.println("");
+            htmlOut.println("</td></tr>");
+            htmlOut.println("  </table>");
+            htmlOut.flush();
+
+            
+            htmlOut = new PrintWriter(new FileWriter(new File("table-solved.html")), true);
+            System.out.println("");
+            System.out.println("Solved Statistics:");
+            System.out.println("solved difficult - solved easy = total solved - user");
+            htmlOut.println("  <table>");
+            htmlOut.println("    <caption>Solved Level Statistics of " + formatter.toString() + "</caption>");
+            htmlOut.println("    <colgroup><col width=\"130\"><col width=\"130\"><col width=\"130\"><col width=\"240\"></colgroup>");
+            htmlOut.println("    <tr><th>difficult</th><th>easy</th><th>total</th><th class=\"left\">user</th></tr>");
+            List<String> userBySolved = new ArrayList<String>(userMgr.getUserIds());
+            UserManager.ComparatorSolved compSolved = userMgr.new ComparatorSolved();
+            Collections.sort(userBySolved, compSolved);
+            for (String id : userBySolved) {
+                String solvedtotal = userMgr.getValue(id, "solvedtotal");
+                double solvedTotal = (!solvedtotal.equals("")) ? Double.parseDouble(solvedtotal.trim()) : 0;
+                if (solvedTotal > 0) {
+                    System.out.println("  " + userMgr.getValue(id, "solvedd")
+                            + " - " + userMgr.getValue(id, "solvede")        
+                            + " = " + userMgr.getValue(id, "solvedtotal")        
+                            + "%  - '" + userMgr.getValue(id, "name") + "'");
+                    htmlOut.println("    <tr><td class=\"num\">" + userMgr.getValue(id, "solvedd")
+                            + "</td><td class=\"num\">" + userMgr.getValue(id, "solvede")
+                            + "</td><td class=\"num\">" + userMgr.getValue(id, "solvedtotal")
+                            + "%</td><td class=\"left\">'" + userMgr.getValue(id, "name") + "'</td></tr>");
+                }
+            }
+            System.out.println("");
+            htmlOut.println("  </table>");
+            htmlOut.flush();
+           
+            htmlOut = new PrintWriter(new FileWriter(new File("table-hcp.html")), true);
+            System.out.println("");
+            System.out.println("Handicap Statistics:");
+            System.out.println("total - solved hcp - user");
+            htmlOut.println("  <table>");
+            htmlOut.println("    <caption>Handicap Statistics of " + formatter.toString() + "</caption>");
+            htmlOut.println("    <colgroup><col width=\"130\"><col width=\"220\"></colgroup>");
+            htmlOut.println("    <tr><th>solved hcp</th><th class=\"left\">user</th></tr>");
+            List<String> userByHCP = new ArrayList<String>(userMgr.getUserIds());
+            UserManager.ComparatorHcpSolved compHCPSolved = userMgr.new ComparatorHcpSolved();
+            Collections.sort(userByHCP, compHCPSolved);
+            for (String id : userByHCP) {
+                String hcptotal = userMgr.getValue(id, "hcptotal");
+                double hcpTotal = (!hcptotal.equals("")) ? Double.parseDouble(hcptotal.trim()) : 100;
+                if (hcpTotal < 100) {
+                    System.out.println("  " + userMgr.getValue(id, "hcptotal")
+                            + "   " + userMgr.getValue(id, "hcpsolved")
+                            + " - '" + userMgr.getValue(id, "name") + "'");
+                    htmlOut.println("     <tr><td class=\"num\">" + userMgr.getValue(id, "hcpsolved")
+                            + "</td><td class=\"left\">'" + userMgr.getValue(id, "name") + "'</td></tr>");
+                }
+            }
+            System.out.println("");
+            htmlOut.println("  </table>");
+            htmlOut.flush();
+            
+            System.out.println("UserEvaluation finished");
+        } catch ( Exception ex ) {
+            ex.printStackTrace();
+        }
+    }
+}


Property changes on: branches/eval/java/src/org/enigma_game/util/UserEvaluation.java
___________________________________________________________________
Name: svn:eol-style
   + native

Added: branches/eval/java/src/org/enigma_game/util/UserRename.java
===================================================================
--- branches/eval/java/src/org/enigma_game/util/UserRename.java	2007-04-06 11:47:23 UTC (rev 683)
+++ branches/eval/java/src/org/enigma_game/util/UserRename.java	2007-04-06 20:58:39 UTC (rev 684)
@@ -0,0 +1,55 @@
+/*
+ * Copyright (C) 2006, 2007 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+package org.enigma_game.util;
+
+import java.io.*;
+import java.util.*; 
+import org.enigma_game.EnigmaUtil;
+import org.enigma_game.lev.RatingManager;
+import org.enigma_game.lev.UserManager;
+
+public class UserRename {
+    EnigmaUtil theApp = org.enigma_game.EnigmaUtil.theApp;
+    
+    public UserRename(String ratingIn, String ratingOut, String userUrl) {
+        try {
+            System.out.println("User renaming");
+            RatingManager ratingMgr = new RatingManager(ratingIn);
+            ratingMgr.setUpLevelScores("");
+            UserManager userMgr = new UserManager(userUrl);
+            for (String id : userMgr.getUserIds()) {
+                String newname = userMgr.getValue(id, "newname");
+                if (!newname.equals("")) {
+                    String oldname = userMgr.getValue(id, "name");
+                    System.out.println("Rename '" + oldname + "' to '" + newname + "'");
+                    ratingMgr.renameUser(oldname, newname);
+                    userMgr.setValue(id, "name", newname);
+                    userMgr.setValue(id, "newname", "");
+                }
+            }
+            ratingMgr.setDate("");
+            ratingMgr.save(ratingOut);
+            userMgr.save(userUrl);
+            
+            System.out.println("User renaming finished");
+        } catch ( Exception ex ) {
+            ex.printStackTrace();
+        }
+    }
+}


Property changes on: branches/eval/java/src/org/enigma_game/util/UserRename.java
___________________________________________________________________
Name: svn:eol-style
   + native



From raoul at mail.berlios.de  Sat Apr  7 01:05:55 2007
From: raoul at mail.berlios.de (raoul at BerliOS)
Date: Sat, 7 Apr 2007 01:05:55 +0200
Subject: [Enigma-game-svn] r685 - in branches/1.0/data/levels: enigma_cross
	enigma_esprit enigma_ii enigma_iii enigma_iv enigma_v enigma_vi
Message-ID: <200704062305.l36N5tjI008496@sheep.berlios.de>

Author: raoul
Date: 2007-04-07 01:05:52 +0200 (Sat, 07 Apr 2007)
New Revision: 685

Added:
   branches/1.0/data/levels/enigma_esprit/esprit37_3.xml
   branches/1.0/data/levels/enigma_ii/duffy120_2.xml
   branches/1.0/data/levels/enigma_iii/duffy85_2.xml
   branches/1.0/data/levels/enigma_iv/duffy117_2.xml
   branches/1.0/data/levels/enigma_iv/duffy124_2.xml
   branches/1.0/data/levels/enigma_v/alain26_2.xml
   branches/1.0/data/levels/enigma_v/duffy114_2.xml
   branches/1.0/data/levels/enigma_v/duffy133_2.xml
   branches/1.0/data/levels/enigma_v/spaceman01_2.xml
   branches/1.0/data/levels/enigma_vi/alain25_2.xml
Removed:
   branches/1.0/data/levels/enigma_esprit/esprit37_2.xml
   branches/1.0/data/levels/enigma_ii/duffy120_1.xml
   branches/1.0/data/levels/enigma_iii/duffy85_1.xml
   branches/1.0/data/levels/enigma_iv/duffy117_1.xml
   branches/1.0/data/levels/enigma_iv/duffy124_1.xml
   branches/1.0/data/levels/enigma_v/alain26_1.xml
   branches/1.0/data/levels/enigma_v/duffy114_1.xml
   branches/1.0/data/levels/enigma_v/duffy133_1.xml
   branches/1.0/data/levels/enigma_v/spaceman01_1.xml
   branches/1.0/data/levels/enigma_vi/alain25_1.xml
Modified:
   branches/1.0/data/levels/enigma_cross/enigma0_92_3.xml
   branches/1.0/data/levels/enigma_cross/newlevels.xml
   branches/1.0/data/levels/enigma_esprit/index.xml
   branches/1.0/data/levels/enigma_ii/index.xml
   branches/1.0/data/levels/enigma_iii/index.xml
   branches/1.0/data/levels/enigma_iv/index.xml
   branches/1.0/data/levels/enigma_v/index.xml
   branches/1.0/data/levels/enigma_vi/index.xml
Log:
-> Incremented score, rev and rel of levels with an easymode added in 
rev 605/640


Modified: branches/1.0/data/levels/enigma_cross/enigma0_92_3.xml
===================================================================
--- branches/1.0/data/levels/enigma_cross/enigma0_92_3.xml	2007-04-06 20:58:39 UTC (rev 684)
+++ branches/1.0/data/levels/enigma_cross/enigma0_92_3.xml	2007-04-06 23:05:52 UTC (rev 685)
@@ -17,7 +17,7 @@
     <level _seq="9" _title="Flood Zone" _xpath="enigma_iv/duffy82_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy82" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="10" _title="Fire Safety" _xpath="enigma_iv/duffy83_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy83" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="11" _title="Laser Tricks" _xpath="enigma_iii/duffy84_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy84" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="12" _title="Think Fast" _xpath="enigma_iii/duffy85_1" author="Jacob Scott" ctrl="force" easy="true" id="duffy85" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="12" _title="Think Fast" _xpath="enigma_iii/duffy85_2" author="Jacob Scott" ctrl="force" easy="true" id="duffy85" rel="2" rev="2" score="2" target="time" unit="duration"/>
     <level _seq="13" _title="Fly High" _xpath="enigma_iii/duffy86_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy86" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="14" _title="Puppet" _xpath="enigma_ii/duffy87_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy87" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="15" _title="Bomb Shelter" _xpath="enigma_iii/duffy88_2" author="Jacob Scott" ctrl="force" easy="false" id="duffy88" rel="2" rev="0" score="2" target="time" unit="duration"/>
@@ -52,17 +52,17 @@
     <level _seq="44" _title="Artillery" _xpath="enigma_iv/duffy111_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy111" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="45" _title="Versailles" _xpath="enigma_iii/duffy112_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy112" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="46" _title="Help Yourself" _xpath="enigma_v/duffy113_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy113" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="47" _title="Plan Ahead" _xpath="enigma_v/duffy114_1" author="Jacob Scott" ctrl="force" easy="true" id="duffy114" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="47" _title="Plan Ahead" _xpath="enigma_v/duffy114_2" author="Jacob Scott" ctrl="force" easy="true" id="duffy114" rel="2" rev="2" score="2" target="time" unit="duration"/>
     <level _seq="48" _title="Randomizer" _xpath="enigma_v/duffy115_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy115" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="49" _title="Just Stay Calm" _xpath="enigma_vi/duffy116_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy116" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="50" _title="Bad Nightmare" _xpath="enigma_iv/duffy117_1" author="Jacob Scott" ctrl="force" easy="true" id="duffy117" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="50" _title="Bad Nightmare" _xpath="enigma_iv/duffy117_2" author="Jacob Scott" ctrl="force" easy="true" id="duffy117" rel="2" rev="2" score="2" target="time" unit="duration"/>
     <level _seq="51" _title="Kaleidoscope" _xpath="enigma_ii/duffy118_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy118" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="52" _title="Reach the Dock" _xpath="enigma_v/duffy119_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy119" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="53" _title="Snowing" _xpath="enigma_ii/duffy120_1" author="Jacob Scott" ctrl="force" easy="true" id="duffy120" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="53" _title="Snowing" _xpath="enigma_ii/duffy120_2" author="Jacob Scott" ctrl="force" easy="true" id="duffy120" rel="2" rev="2" score="2" target="time" unit="duration"/>
     <level _seq="54" _title="Action at a Distance" _xpath="enigma_iv/duffy121_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy121" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="55" _title="Civil Engineer" _xpath="enigma_i/duffy122_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy122" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="56" _title="Electric Meditation" _xpath="enigma_iv/duffy123_1" author="Jacob Scott" ctrl="force" easy="true" id="duffy123" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="57" _title="Worse Nightmare" _xpath="enigma_iv/duffy124_1" author="Jacob Scott" ctrl="force" easy="true" id="duffy124" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="57" _title="Worse Nightmare" _xpath="enigma_iv/duffy124_2" author="Jacob Scott" ctrl="force" easy="true" id="duffy124" rel="2" rev="2" score="2" target="time" unit="duration"/>
     <level _seq="58" _title="Triple-Maze" _xpath="enigma_iv/duffy125_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy125" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="59" _title="Elaborate" _xpath="enigma_v/duffy126_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy126" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="60" _title="Now What?" _xpath="enigma_v/duffy127_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy127" rel="1" rev="0" score="1" target="time" unit="duration"/>

Modified: branches/1.0/data/levels/enigma_cross/newlevels.xml
===================================================================
--- branches/1.0/data/levels/enigma_cross/newlevels.xml	2007-04-06 20:58:39 UTC (rev 684)
+++ branches/1.0/data/levels/enigma_cross/newlevels.xml	2007-04-06 23:05:52 UTC (rev 685)
@@ -116,7 +116,7 @@
     <level _seq="108" _title="Tropical Island" _xpath="enigma_v/andreas08_1" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas08" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="109" _title="Ghost Islands" _xpath="enigma_v/raoul15_1" author="Raoul Bourquin" ctrl="force" easy="true" id="raoul15" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="110" _title="- Meditation -" _xpath="enigma_v/raoul02_1" author="Raoul Bourquin" ctrl="force" easy="true" id="raoul02" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="111" _title="Humid Maze" _xpath="enigma_v/duffy133_1" author="Jacob Scott" ctrl="force" easy="true" id="duffy133" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="111" _title="Humid Maze" _xpath="enigma_v/duffy133_2" author="Jacob Scott" ctrl="force" easy="true" id="duffy133" rel="2" rev="2" score="2" target="time" unit="duration"/>
     <level _seq="112" _title="Swamp of Balls" _xpath="enigma_v/luc08_1" author="Lukas Sch?ller" ctrl="force" easy="false" id="luc08" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="113" _title="Designed with love" _xpath="enigma_v/just01_1" author="JuSt" ctrl="force" easy="false" id="just01" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="114" _title="A bayou by you" _xpath="enigma_v/alain21_1" author="Alain Busser" ctrl="force" easy="false" id="alain21" rel="1" rev="0" score="1" target="time" unit="duration"/>
@@ -130,7 +130,7 @@
     <level _seq="122" _title="Gods of Enigma II" _xpath="enigma_v/mp02_1" author="moonpearl" ctrl="force" easy="false" id="mp02" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="123" _title="- Meditation -" _xpath="enigma_v/alain14_1" author="Alain Busser" ctrl="force" easy="false" id="alain14" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="124" _title="Frogger" _xpath="enigma_v/luc20_1" author="Lukas Sch?ller" ctrl="force" easy="false" id="luc20" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="125" _title="Fatal Attraction I" _xpath="enigma_v/spaceman01_1" author="Spaceman" ctrl="force" easy="true" id="spaceman1" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="125" _title="Fatal Attraction I" _xpath="enigma_v/spaceman01_2" author="Spaceman" ctrl="force" easy="true" id="spaceman1" rel="2" rev="2" score="2" target="time" unit="duration"/>
     <level _seq="126" _title="Acoustic Memory" _xpath="enigma_v/andreas25_2" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas25" rel="2" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="127" _title="Fatal Attraction II" _xpath="enigma_v/spaceman02_1" author="Spaceman" ctrl="force" easy="false" id="spaceman2" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="128" _title="Fatal Attraction III" _xpath="enigma_v/spaceman03_1" author="Spaceman" ctrl="force" easy="false" id="spaceman3" rel="1" rev="0" score="1" target="time" unit="duration"/>
@@ -157,7 +157,7 @@
     <level _seq="149" _title="Orbitting" _xpath="enigma_vi/andreas26_1" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas26" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="150" _title="Evil" _xpath="enigma_vi/spaceman04_1" author="Spaceman" ctrl="force" easy="false" id="spaceman4" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="151" _title="Meditation Disturbance" _xpath="enigma_vi/ral04_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20060429ral006" rel="1" rev="33" score="1" target="time" unit="duration"/>
-    <level _seq="152" _title="Banana Republic" _xpath="enigma_v/alain26_1" author="Alain Busser" ctrl="force" easy="true" id="alain26" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="152" _title="Banana Republic" _xpath="enigma_v/alain26_2" author="Alain Busser" ctrl="force" easy="true" id="alain26" rel="2" rev="2" score="2" target="time" unit="duration"/>
     <level _seq="153" _title="Zeus" _xpath="enigma_vi/raoul19_1" author="Raoul Bourquin" ctrl="force" easy="true" id="raoul19" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="154" _title="Rhapsody on Cracks" _xpath="enigma_vi/ral06_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20060510ral008" rel="1" rev="42" score="1" target="time" unit="duration"/>
     <level _seq="155" _title="Prepare Your Defense" _xpath="enigma_vi/duffy132_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy132" rel="1" rev="0" score="1" target="time" unit="duration"/>
@@ -166,7 +166,7 @@
     <level _seq="158" _title="Oxydmoron" _xpath="enigma_vi/raoul14_1" author="Raoul Bourquin" ctrl="force" easy="true" id="raoul14" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="159" _title="Bomb raider" _xpath="enigma_vi/alain27_1" author="Alain Busser" ctrl="force" easy="true" id="alain27" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="160" _title="Dancing on Light Beams" _xpath="enigma_vi/andreas28_1" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas28" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="161" _title="- Meditation -" _xpath="enigma_vi/alain25_1" author="Alain Busser + Raoul Bourquin" ctrl="force" easy="true" id="alain25" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="161" _title="- Meditation -" _xpath="enigma_vi/alain25_2" author="Alain Busser + Raoul Bourquin" ctrl="force" easy="true" id="alain25" rel="2" rev="2" score="2" target="time" unit="duration"/>
     <level _seq="162" _title="Checkmate I" _xpath="enigma_vi/andreas29_1" author="Andreas Lochmann" ctrl="force" easy="false" id="andreas29" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="163" _title="The Stable" _xpath="enigma_vi/andreas30_1" author="Andreas Lochmann" ctrl="force" easy="false" id="andreas30" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="164" _title="Chess, Bugs &amp; Rock'n'Roll" _xpath="enigma_vi/andreas31_1" author="Andreas Lochmann" ctrl="force" easy="false" id="andreas31" rel="1" rev="0" score="1" target="time" unit="duration"/>

Deleted: branches/1.0/data/levels/enigma_esprit/esprit37_2.xml
===================================================================
--- branches/1.0/data/levels/enigma_esprit/esprit37_2.xml	2007-04-06 20:58:39 UTC (rev 684)
+++ branches/1.0/data/levels/enigma_esprit/esprit37_2.xml	2007-04-06 23:05:52 UTC (rev 685)
@@ -1,152 +0,0 @@
-<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
-<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
-  <el:protected>
-    <el:info el:type="level">
-      <el:identity el:title="esprit 37" el:subtitle="esprit 37" el:id="ss_esp37"/>
-      <el:version el:score="2" el:release="2" el:revision="1" el:status="released"/>
-      <el:author  el:name="Sven Siggelkow" el:email="" el:homepage=""/>
-      <el:copyright>Copyright ? 2003 Sven Siggelkow</el:copyright>
-      <el:license el:type="GPL v2.0 or above" el:open="true"/>
-      <el:compatibility el:enigma="0.92">
-       <el:dependency el:path="lib/andreas_ghosts" el:id="lib/andreas_ghosts" el:release="1" el:preload="true"/>
-      </el:compatibility>
-      <el:modes el:easy="true" el:single="true" el:network="false"/>
-      <el:comments>
-        <el:code>Lua 5.1 and XML converted by Leveladministrators</el:code>
-      </el:comments>
-      <el:score el:easy="-" el:difficult="-"/>
-    </el:info>
-    <el:luamain><![CDATA[
--- change rotor with spermbird, if implemented
--- Apr.2003: Replaced the rotor with a ghost, and
---   changed the puzzle-mechanism to avoid a second
---   way to solve the puzzle -> Revision 2   Andreas
-
-levelw = 20
-levelh = 25
-create_world(levelw, levelh)
-oxyd_default_flavor = "c"       -- Default flavor for oxyd stones.
-set_actor("ac-blackball", 11.5,8.5, {player=0})
---set_actor("ac-rotor", 1.5,9.5, {range=30, force=40}) 
-ghosts_set_ghost(1,9,"ac-rotor",1,ghosts_direction_intelligent,
-                    {range=0, force=40, gohome=FALSE})
---fill_floor("fl-sand",0,0,levelw,levelh)
-ghosts_set_railarea(0,0,levelw,levelh,1,"fl-sand")
-function renderLine( line, pattern)
-    for i=1, strlen(pattern) do
-        local c = strsub( pattern, i, i)
-        if c ==   "#" then
-            set_stone("st-rock1", i-1,line)
-        elseif c=="1" then
-            set_item("it-wormhole", i-1,line, {targetx="4.5", targety="17.5",strength=0})         
-        elseif c=="2" then
-            set_item("it-wormhole", i-1,line, {targetx="1.5", targety="2.5",strength=0})   
-        elseif c=="3" then
-            set_item("it-wormhole", i-1,line, {targetx="4.5", targety="13.5",strength=0})   
-        elseif c=="5" then
-            puzzle(i-1,line, 7)  
-            set_item("it-trigger", i-1,line, {action="callback", target="s1"})
-        elseif c=="A" then
-            set_item("it-trigger", i-1,line, {action="callback", target="s2"})
-        elseif c=="B" then
-            set_item("it-trigger", i-1,line, {action="callback", target="s3"})
-        elseif c=="C" then
-            set_item("it-trigger", i-1,line, {action="callback", target="s4"})
-        elseif c=="6" then
-            puzzle(i-1,line, 4)      
-        elseif c=="7" then
-            puzzle(i-1,line, 13)        
-        elseif c=="8" then
-            puzzle(i-1,line, 10)  
-            --set_item("it-magicwand",i-1,line)
-        elseif c=="." then
-            set_stone("st-door_b", i-1,line, {type="v"})   
-        elseif c=="O" then
-            oxyd(i-1,line)
-        end
-    end  
-end
---               01234567890123456789
-renderLine(00 , "####################")
-renderLine(01 , "#1#             # O#")
-renderLine(02 , "# # ##### # ### #  #")
-renderLine(03 , "# # #   # #   # #..#")
-renderLine(04 , "# # # # # # # #    #")  
-renderLine(05 , "# # # # # # # #### #")
-renderLine(06 , "# # # #   # #      #")
-renderLine(07 , "# # # ####5A###### #")
-renderLine(08 , "# # # 7   BC       #")
-renderLine(09 , "#   # ##### #### # #")
-renderLine(10 , "##### #O  . . O#6# #")
-renderLine(11 , "#     #   . .  # # #")
-renderLine(12 , "# ######### #### # #")
-renderLine(13 , "# #2             # #")
-renderLine(14 , "# ####### # #### # #")
-renderLine(15 , "#       # # #O # # #")
-renderLine(16 , "####### # # #  # # #")
-renderLine(17 , "#    3# # # #..# # #")
-renderLine(18 , "# ##### # # #    # #")
-renderLine(19 , "# #     # # #  # # #")
-renderLine(20 , "# # ### # # #### # #")
-renderLine(21 , "# #       # #    # #")
-renderLine(22 , "# # #######8# #### #")
-renderLine(23 , "#           #      #")
-renderLine(24 , "####################")
---               01234567890123456789
-state_s1 = 1
-state_s2 = 1
-state_s3 = 1
-state_s4 = 1
-function msgthisdoor(x,y,msg)  
-  SendMessage(enigma.GetStone(x,y), msg)
-end
-function checkmydoors()
-  local msg
-  if      (state_s1 == 0) and (state_s2 == 0)
-      and (state_s3 == 0) and (state_s4 == 0) then
-    msg = "open"
-  else
-    msg = "close"
-  end
-  msgthisdoor(17,3,msg)
-  msgthisdoor(18,3,msg)
-  msgthisdoor(10,10,msg)
-  msgthisdoor(12,10,msg)
-  msgthisdoor(10,11,msg)
-  msgthisdoor(12,11,msg)
-  msgthisdoor(13,17,msg)
-  msgthisdoor(14,17,msg)
-end
-state_s1 = 1
-function s1()
-  state_s1 = 1 - state_s1
-  checkmydoors()
-end
-state_s2 = 1
-function s2()
-  state_s2 = 1 - state_s2
-  checkmydoors()
-end
-state_s3 = 1
-function s3()
-  state_s3 = 1 - state_s3
-  checkmydoors()
-end
-state_s4 = 1
-function s4()
-  state_s4 = 1 - state_s4
-  checkmydoors()
-end
-oxyd_shuffle()
-ghosts_init(0,0)
-if difficult then
-  enigma.SlopeForce=20
-end
-    ]]></el:luamain>
-    <el:i18n>
-      <el:string el:key="title">
-        <el:english el:translate="false"/>
-      </el:string>
-    </el:i18n>
-  </el:protected>
-</el:level>

Copied: branches/1.0/data/levels/enigma_esprit/esprit37_3.xml (from rev 683, branches/1.0/data/levels/enigma_esprit/esprit37_2.xml)
===================================================================
--- branches/1.0/data/levels/enigma_esprit/esprit37_2.xml	2007-04-06 11:47:23 UTC (rev 683)
+++ branches/1.0/data/levels/enigma_esprit/esprit37_3.xml	2007-04-06 23:05:52 UTC (rev 685)
@@ -0,0 +1,152 @@
+<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
+<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
+  <el:protected>
+    <el:info el:type="level">
+      <el:identity el:title="esprit 37" el:subtitle="esprit 37" el:id="ss_esp37"/>
+      <el:version el:score="3" el:release="3" el:revision="2" el:status="released"/>
+      <el:author  el:name="Sven Siggelkow" el:email="" el:homepage=""/>
+      <el:copyright>Copyright ? 2003 Sven Siggelkow</el:copyright>
+      <el:license el:type="GPL v2.0 or above" el:open="true"/>
+      <el:compatibility el:enigma="0.92">
+       <el:dependency el:path="lib/andreas_ghosts" el:id="lib/andreas_ghosts" el:release="1" el:preload="true"/>
+      </el:compatibility>
+      <el:modes el:easy="true" el:single="true" el:network="false"/>
+      <el:comments>
+        <el:code>Lua 5.1 and XML converted by Leveladministrators</el:code>
+      </el:comments>
+      <el:score el:easy="-" el:difficult="-"/>
+    </el:info>
+    <el:luamain><![CDATA[
+-- change rotor with spermbird, if implemented
+-- Apr.2003: Replaced the rotor with a ghost, and
+--   changed the puzzle-mechanism to avoid a second
+--   way to solve the puzzle -> Revision 2   Andreas
+
+levelw = 20
+levelh = 25
+create_world(levelw, levelh)
+oxyd_default_flavor = "c"       -- Default flavor for oxyd stones.
+set_actor("ac-blackball", 11.5,8.5, {player=0})
+--set_actor("ac-rotor", 1.5,9.5, {range=30, force=40}) 
+ghosts_set_ghost(1,9,"ac-rotor",1,ghosts_direction_intelligent,
+                    {range=0, force=40, gohome=FALSE})
+--fill_floor("fl-sand",0,0,levelw,levelh)
+ghosts_set_railarea(0,0,levelw,levelh,1,"fl-sand")
+function renderLine( line, pattern)
+    for i=1, strlen(pattern) do
+        local c = strsub( pattern, i, i)
+        if c ==   "#" then
+            set_stone("st-rock1", i-1,line)
+        elseif c=="1" then
+            set_item("it-wormhole", i-1,line, {targetx="4.5", targety="17.5",strength=0})         
+        elseif c=="2" then
+            set_item("it-wormhole", i-1,line, {targetx="1.5", targety="2.5",strength=0})   
+        elseif c=="3" then
+            set_item("it-wormhole", i-1,line, {targetx="4.5", targety="13.5",strength=0})   
+        elseif c=="5" then
+            puzzle(i-1,line, 7)  
+            set_item("it-trigger", i-1,line, {action="callback", target="s1"})
+        elseif c=="A" then
+            set_item("it-trigger", i-1,line, {action="callback", target="s2"})
+        elseif c=="B" then
+            set_item("it-trigger", i-1,line, {action="callback", target="s3"})
+        elseif c=="C" then
+            set_item("it-trigger", i-1,line, {action="callback", target="s4"})
+        elseif c=="6" then
+            puzzle(i-1,line, 4)      
+        elseif c=="7" then
+            puzzle(i-1,line, 13)        
+        elseif c=="8" then
+            puzzle(i-1,line, 10)  
+            --set_item("it-magicwand",i-1,line)
+        elseif c=="." then
+            set_stone("st-door_b", i-1,line, {type="v"})   
+        elseif c=="O" then
+            oxyd(i-1,line)
+        end
+    end  
+end
+--               01234567890123456789
+renderLine(00 , "####################")
+renderLine(01 , "#1#             # O#")
+renderLine(02 , "# # ##### # ### #  #")
+renderLine(03 , "# # #   # #   # #..#")
+renderLine(04 , "# # # # # # # #    #")  
+renderLine(05 , "# # # # # # # #### #")
+renderLine(06 , "# # # #   # #      #")
+renderLine(07 , "# # # ####5A###### #")
+renderLine(08 , "# # # 7   BC       #")
+renderLine(09 , "#   # ##### #### # #")
+renderLine(10 , "##### #O  . . O#6# #")
+renderLine(11 , "#     #   . .  # # #")
+renderLine(12 , "# ######### #### # #")
+renderLine(13 , "# #2             # #")
+renderLine(14 , "# ####### # #### # #")
+renderLine(15 , "#       # # #O # # #")
+renderLine(16 , "####### # # #  # # #")
+renderLine(17 , "#    3# # # #..# # #")
+renderLine(18 , "# ##### # # #    # #")
+renderLine(19 , "# #     # # #  # # #")
+renderLine(20 , "# # ### # # #### # #")
+renderLine(21 , "# #       # #    # #")
+renderLine(22 , "# # #######8# #### #")
+renderLine(23 , "#           #      #")
+renderLine(24 , "####################")
+--               01234567890123456789
+state_s1 = 1
+state_s2 = 1
+state_s3 = 1
+state_s4 = 1
+function msgthisdoor(x,y,msg)  
+  SendMessage(enigma.GetStone(x,y), msg)
+end
+function checkmydoors()
+  local msg
+  if      (state_s1 == 0) and (state_s2 == 0)
+      and (state_s3 == 0) and (state_s4 == 0) then
+    msg = "open"
+  else
+    msg = "close"
+  end
+  msgthisdoor(17,3,msg)
+  msgthisdoor(18,3,msg)
+  msgthisdoor(10,10,msg)
+  msgthisdoor(12,10,msg)
+  msgthisdoor(10,11,msg)
+  msgthisdoor(12,11,msg)
+  msgthisdoor(13,17,msg)
+  msgthisdoor(14,17,msg)
+end
+state_s1 = 1
+function s1()
+  state_s1 = 1 - state_s1
+  checkmydoors()
+end
+state_s2 = 1
+function s2()
+  state_s2 = 1 - state_s2
+  checkmydoors()
+end
+state_s3 = 1
+function s3()
+  state_s3 = 1 - state_s3
+  checkmydoors()
+end
+state_s4 = 1
+function s4()
+  state_s4 = 1 - state_s4
+  checkmydoors()
+end
+oxyd_shuffle()
+ghosts_init(0,0)
+if difficult then
+  enigma.SlopeForce=20
+end
+    ]]></el:luamain>
+    <el:i18n>
+      <el:string el:key="title">
+        <el:english el:translate="false"/>
+      </el:string>
+    </el:i18n>
+  </el:protected>
+</el:level>

Modified: branches/1.0/data/levels/enigma_esprit/index.xml
===================================================================
--- branches/1.0/data/levels/enigma_esprit/index.xml	2007-04-06 20:58:39 UTC (rev 684)
+++ branches/1.0/data/levels/enigma_esprit/index.xml	2007-04-06 23:05:52 UTC (rev 685)
@@ -41,7 +41,7 @@
     <level _seq="33" _title="esprit 34" _xpath="./esprit34_2" author="Sven Siggelkow" ctrl="force" easy="false" id="ss_esp34" rel="2" rev="0" score="2" target="time" unit="duration"/>
     <level _seq="34" _title="esprit 35" _xpath="./esprit35_1" author="Sven Siggelkow" ctrl="force" easy="false" id="ss_esp35" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="35" _title="esprit 36" _xpath="./esprit36_1" author="Sven Siggelkow" ctrl="force" easy="false" id="ss_esp36" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="36" _title="esprit 37" _xpath="./esprit37_2" author="Sven Siggelkow" ctrl="force" easy="true" id="ss_esp37" rel="2" rev="1" score="2" target="time" unit="duration"/>
+    <level _seq="36" _title="esprit 37" _xpath="./esprit37_3" author="Sven Siggelkow" ctrl="force" easy="true" id="ss_esp37" rel="3" rev="2" score="3" target="time" unit="duration"/>
     <level _seq="37" _title="esprit 38" _xpath="./esprit38_1" author="Sven Siggelkow" ctrl="force" easy="false" id="ss_esp38" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="38" _title="esprit 39" _xpath="./esprit39_1" author="Sven Siggelkow" ctrl="force" easy="false" id="ss_esp39" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="39" _title="- Meditation -" _xpath="./esprit40_2" author="anonymous" ctrl="force" easy="false" id="meditation7" rel="2" rev="0" score="2" target="time" unit="duration"/>

Deleted: branches/1.0/data/levels/enigma_ii/duffy120_1.xml
===================================================================
--- branches/1.0/data/levels/enigma_ii/duffy120_1.xml	2007-04-06 20:58:39 UTC (rev 684)
+++ branches/1.0/data/levels/enigma_ii/duffy120_1.xml	2007-04-06 23:05:52 UTC (rev 685)
@@ -1,94 +0,0 @@
-<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
-<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
-  <el:protected>
-    <el:info el:type="level">
-      <el:identity el:title="Snowing" el:subtitle="" el:id="duffy120"/>
-      <el:version el:score="1" el:release="1" el:revision="1" el:status="released"/>
-      <el:author  el:name="Jacob Scott" el:email="" el:homepage=""/>
-      <el:copyright>Copyright ? 2004 Jacob Scott</el:copyright>
-      <el:license el:type="GPL v2.0 or above" el:open="true"/>
-      <el:compatibility el:enigma="0.92">
-      </el:compatibility>
-      <el:modes el:easy="true" el:single="true" el:network="false"/>
-      <el:comments>
-        <el:code>Lua 5.1 and XML converted by Leveladministrators</el:code>
-      </el:comments>
-      <el:score el:easy="-" el:difficult="-"/>
-    </el:info>
-    <el:luamain><![CDATA[
-rooms_wide=1
-rooms_high=1
-
-levelw=1+(19*rooms_wide)+1
-levelh=1+(12*rooms_high)
-
-create_world( levelw, levelh)
-
-difficult = (options.Difficulty==2)
-
-fill_floor("fl-leaves", 0,0,levelw,levelh)
-
-function renderLine( line, pattern)
-    for i=1, strlen(pattern) do
-        local c = strsub( pattern, i, i)
-        if c =="#" then
-            set_stone( "st-death", i-1, line)
-        elseif c == "o" then
-            oxyd( i-1, line)
-        elseif c == "*" then
-            set_stone( "st-brownie", i-1, line)
-        elseif c == "!" then
-            abyss(i-1,line)
-        elseif c == "~" then
-           set_floor("fl-water",i-1,line)
-        elseif c=="z" then
-           set_actor("ac-blackball", i-.5,line+.5, {player=0})
-        elseif c=="y" then
-           set_actor("ac-whiteball", i-1,line+.5, {player=1})
-        elseif c=="t" then
-            if difficult==false then
-                set_actor("ac-top", i-.5,line+.5, {force=25,range=30,controllers=0,player=1})
-            else
-                set_actor("ac-top", i-.5,line+.5, {force=40,range=30,controllers=0,player=1})
-            end
-        elseif c == "g" then
-            draw_stones("st-grate1",{i-1,line}, {1,1}, 1)
-        elseif c=="+" then
-            set_stone( "st-wood", i-1, line)
-        elseif c=="=" then
-            set_floor("fl-space",i-1,line)
-        elseif c=="T" then
-           set_stone("st-timer",i-1,line,{loop=1,interval=0.2,action="callback",target="funcc1"})
-        end
-    end    
-end
-
-renderLine(00,"####################T")
-renderLine(01,"#       o  o       # ")
-renderLine(02,"#    o        o    # ")
-renderLine(03,"#  o            o  # ")
-renderLine(04,"#                  # ")
-renderLine(05,"#o                o# ")
-renderLine(06,"#    t   ##  z     # ")
-renderLine(07,"#o                o# ")
-renderLine(08,"#                  # ")
-renderLine(09,"#  o            o  # ")
-renderLine(10,"#    o        o    # ")
-renderLine(11,"#       o  o       # ")
-renderLine(12,"#################### ")
-
-oxyd_shuffle()
-
-function funcc1()
-   x=random(21)-1
-   y=random(13)-1
-   set_floor("fl-ice",x,y)
-end
-    ]]></el:luamain>
-    <el:i18n>
-      <el:string el:key="title">
-        <el:english el:translate="false"/>
-      </el:string>
-    </el:i18n>
-  </el:protected>
-</el:level>

Copied: branches/1.0/data/levels/enigma_ii/duffy120_2.xml (from rev 683, branches/1.0/data/levels/enigma_ii/duffy120_1.xml)
===================================================================
--- branches/1.0/data/levels/enigma_ii/duffy120_1.xml	2007-04-06 11:47:23 UTC (rev 683)
+++ branches/1.0/data/levels/enigma_ii/duffy120_2.xml	2007-04-06 23:05:52 UTC (rev 685)
@@ -0,0 +1,94 @@
+<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
+<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
+  <el:protected>
+    <el:info el:type="level">
+      <el:identity el:title="Snowing" el:subtitle="" el:id="duffy120"/>
+      <el:version el:score="2" el:release="2" el:revision="2" el:status="released"/>
+      <el:author  el:name="Jacob Scott" el:email="" el:homepage=""/>
+      <el:copyright>Copyright ? 2004 Jacob Scott</el:copyright>
+      <el:license el:type="GPL v2.0 or above" el:open="true"/>
+      <el:compatibility el:enigma="0.92">
+      </el:compatibility>
+      <el:modes el:easy="true" el:single="true" el:network="false"/>
+      <el:comments>
+        <el:code>Lua 5.1 and XML converted by Leveladministrators</el:code>
+      </el:comments>
+      <el:score el:easy="-" el:difficult="-"/>
+    </el:info>
+    <el:luamain><![CDATA[
+rooms_wide=1
+rooms_high=1
+
+levelw=1+(19*rooms_wide)+1
+levelh=1+(12*rooms_high)
+
+create_world( levelw, levelh)
+
+difficult = (options.Difficulty==2)
+
+fill_floor("fl-leaves", 0,0,levelw,levelh)
+
+function renderLine( line, pattern)
+    for i=1, strlen(pattern) do
+        local c = strsub( pattern, i, i)
+        if c =="#" then
+            set_stone( "st-death", i-1, line)
+        elseif c == "o" then
+            oxyd( i-1, line)
+        elseif c == "*" then
+            set_stone( "st-brownie", i-1, line)
+        elseif c == "!" then
+            abyss(i-1,line)
+        elseif c == "~" then
+           set_floor("fl-water",i-1,line)
+        elseif c=="z" then
+           set_actor("ac-blackball", i-.5,line+.5, {player=0})
+        elseif c=="y" then
+           set_actor("ac-whiteball", i-1,line+.5, {player=1})
+        elseif c=="t" then
+            if difficult==false then
+                set_actor("ac-top", i-.5,line+.5, {force=25,range=30,controllers=0,player=1})
+            else
+                set_actor("ac-top", i-.5,line+.5, {force=40,range=30,controllers=0,player=1})
+            end
+        elseif c == "g" then
+            draw_stones("st-grate1",{i-1,line}, {1,1}, 1)
+        elseif c=="+" then
+            set_stone( "st-wood", i-1, line)
+        elseif c=="=" then
+            set_floor("fl-space",i-1,line)
+        elseif c=="T" then
+           set_stone("st-timer",i-1,line,{loop=1,interval=0.2,action="callback",target="funcc1"})
+        end
+    end    
+end
+
+renderLine(00,"####################T")
+renderLine(01,"#       o  o       # ")
+renderLine(02,"#    o        o    # ")
+renderLine(03,"#  o            o  # ")
+renderLine(04,"#                  # ")
+renderLine(05,"#o                o# ")
+renderLine(06,"#    t   ##  z     # ")
+renderLine(07,"#o                o# ")
+renderLine(08,"#                  # ")
+renderLine(09,"#  o            o  # ")
+renderLine(10,"#    o        o    # ")
+renderLine(11,"#       o  o       # ")
+renderLine(12,"#################### ")
+
+oxyd_shuffle()
+
+function funcc1()
+   x=random(21)-1
+   y=random(13)-1
+   set_floor("fl-ice",x,y)
+end
+    ]]></el:luamain>
+    <el:i18n>
+      <el:string el:key="title">
+        <el:english el:translate="false"/>
+      </el:string>
+    </el:i18n>
+  </el:protected>
+</el:level>

Modified: branches/1.0/data/levels/enigma_ii/index.xml
===================================================================
--- branches/1.0/data/levels/enigma_ii/index.xml	2007-04-06 20:58:39 UTC (rev 684)
+++ branches/1.0/data/levels/enigma_ii/index.xml	2007-04-06 23:05:52 UTC (rev 685)
@@ -99,7 +99,7 @@
     <level _seq="91" _title="It's Magic" _xpath="./martin27_1" author="Martin Hawlisch" ctrl="force" easy="false" id="martin27" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="92" _title="Dirt Clod" _xpath="./xerxes02_1" author="Xerxes M. Dynatos" ctrl="force" easy="false" id="xerxes02" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="93" _title="Painting" _xpath="./siegfried21_1" author="Siegfried Fennig" ctrl="force" easy="false" id="level6d" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="94" _title="Snowing" _xpath="./duffy120_1" author="Jacob Scott" ctrl="force" easy="true" id="duffy120" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="94" _title="Snowing" _xpath="./duffy120_2" author="Jacob Scott" ctrl="force" easy="true" id="duffy120" rel="2" rev="2" score="2" target="time" unit="duration"/>
     <level _seq="95" _title="Eraser Please!" _xpath="./martin39_1" author="Martin Hawlisch" ctrl="force" easy="false" id="martin39" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="96" _title="Friend or Foe?" _xpath="./andreas05_1" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas05" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="97" _title="Tool Time" _xpath="./barry03_1" author="Barry &amp; Lori Mead" ctrl="force" easy="false" id="barry03" rel="1" rev="0" score="1" target="time" unit="duration"/>

Deleted: branches/1.0/data/levels/enigma_iii/duffy85_1.xml
===================================================================
--- branches/1.0/data/levels/enigma_iii/duffy85_1.xml	2007-04-06 20:58:39 UTC (rev 684)
+++ branches/1.0/data/levels/enigma_iii/duffy85_1.xml	2007-04-06 23:05:52 UTC (rev 685)
@@ -1,115 +0,0 @@
-<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
-<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
-  <el:protected>
-    <el:info el:type="level">
-      <el:identity el:title="Think Fast" el:subtitle="" el:id="duffy85"/>
-      <el:version el:score="1" el:release="1" el:revision="1" el:status="released"/>
-      <el:author  el:name="Jacob Scott" el:email="" el:homepage=""/>
-      <el:copyright>Copyright ? 2004 Jacob Scott</el:copyright>
-      <el:license el:type="GPL v2.0 or above" el:open="true"/>
-      <el:compatibility el:enigma="0.92">
-      </el:compatibility>
-      <el:modes el:easy="true" el:single="true" el:network="false"/>
-      <el:comments>
-        <el:code>Lua 5.1 and XML converted by Leveladministrators</el:code>
-      </el:comments>
-      <el:score el:easy="-" el:difficult="-"/>
-    </el:info>
-    <el:luamain><![CDATA[
-rooms_wide=1
-rooms_high=1
-
-levelw=1+(19*rooms_wide)
-levelh=1+(12*rooms_high)
-
-create_world( levelw, levelh)
-
-if not difficult then
-   tspeed=40
-else
-   tspeed=60
-end
-
-fill_floor("fl-rock", 0,0,levelw,levelh)
-
-function renderLine( line, pattern)
-    for i=1, strlen(pattern) do
-        local c = strsub( pattern, i, i)
-        if c =="#" then
-            set_stone( "st-greenbrown", i-1, line)
-        elseif c =="%" then
-            set_stone( "st-greenbrown", i-1, line)
-            set_floor("fl-water",i-1,line)
-        elseif c == "o" then
-            oxyd( i-1, line)
-        elseif c == "O" then
-            oxyd( i-1, line)
-            set_floor("fl-water",i-1,line)
-        elseif c == "*" then
-            set_stone( "st-brownie", i-1, line)
-            set_floor("fl-water",i-1,line)
-        elseif c == "!" then
-            abyss(i-1,line)
-        elseif c == "~" then
-            set_floor("fl-water",i-1,line)
-        elseif c=="z" then
-            set_actor("ac-blackball", i-1,line+.5, {player=0})
-        elseif c == "g" then
-            draw_stones("st-grate1",{i-1,line}, {1,1}, 1)
-        elseif c=="+" then
-            set_stone( "st-wood", i-1, line)
-        elseif c=="=" then
-            set_floor("fl-space",i-1,line)
-        elseif c=="S" then
-            set_actor("ac-top", i-.5,line+.5, {name="t1",player=1, mouseforce=0, range=1000, force=tspeed})
-            set_floor("fl-water",i-1,line)
-        elseif c=="T" then
-            set_actor("ac-top", i-.5,line+.5, {name="t2",player=1, mouseforce=0, range=1000, force=-tspeed})
-            set_floor("fl-water",i-1,line)
-        elseif c=="A" then
-            set_stone("st-switch",i-1,line,{action="callback",target="funcc1"})
-        end
-    end    
-end
-
-renderLine(00,"**O%##o##AA##o##%O**")
-renderLine(01,"*~~~            ~~~*")
-renderLine(02,"O~~S            ~~~O")
-renderLine(03,"%~~~            ~~~%")
-renderLine(04,"o                  o")
-renderLine(05,"#                  #")
-renderLine(06,"A         z        A")
-renderLine(07,"#                  #")
-renderLine(08,"o                  o")
-renderLine(09,"%~~~            ~~~%")
-renderLine(10,"O~~~            T~~O")
-renderLine(11,"*~~~            ~~~*")
-renderLine(12,"**O%##o##AA##o##%O**")
-
-oxyd_shuffle()
-
-t1=enigma.GetNamedObject("t1")
-t2=enigma.GetNamedObject("t2")
-
-ff1=0
-function funcc1()
-    if ff1==0 then
-        enigma.SetAttrib(t1,"force",-tspeed)
-        enigma.SetAttrib(t2,"force",tspeed)
-        ff1=1
-    elseif ff1==1 then
-        enigma.SetAttrib(t1,"force",tspeed)
-        enigma.SetAttrib(t2,"force",-tspeed)
-        ff1=0
-    end
-end
-
-display.SetFollowMode(display.FOLLOW_SCROLLING)
-    ]]></el:luamain>
-    <el:i18n>
-      <el:string el:key="title">
-        <el:english el:translate="false"/>
-      </el:string>
-    </el:i18n>
-  </el:protected>
-</el:level>

Copied: branches/1.0/data/levels/enigma_iii/duffy85_2.xml (from rev 683, branches/1.0/data/levels/enigma_iii/duffy85_1.xml)
===================================================================
--- branches/1.0/data/levels/enigma_iii/duffy85_1.xml	2007-04-06 11:47:23 UTC (rev 683)
+++ branches/1.0/data/levels/enigma_iii/duffy85_2.xml	2007-04-06 23:05:52 UTC (rev 685)
@@ -0,0 +1,115 @@
+<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
+<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
+  <el:protected>
+    <el:info el:type="level">
+      <el:identity el:title="Think Fast" el:subtitle="" el:id="duffy85"/>
+      <el:version el:score="2" el:release="2" el:revision="2" el:status="released"/>
+      <el:author  el:name="Jacob Scott" el:email="" el:homepage=""/>
+      <el:copyright>Copyright ? 2004 Jacob Scott</el:copyright>
+      <el:license el:type="GPL v2.0 or above" el:open="true"/>
+      <el:compatibility el:enigma="0.92">
+      </el:compatibility>
+      <el:modes el:easy="true" el:single="true" el:network="false"/>
+      <el:comments>
+        <el:code>Lua 5.1 and XML converted by Leveladministrators</el:code>
+      </el:comments>
+      <el:score el:easy="-" el:difficult="-"/>
+    </el:info>
+    <el:luamain><![CDATA[
+rooms_wide=1
+rooms_high=1
+
+levelw=1+(19*rooms_wide)
+levelh=1+(12*rooms_high)
+
+create_world( levelw, levelh)
+
+if not difficult then
+   tspeed=40
+else
+   tspeed=60
+end
+
+fill_floor("fl-rock", 0,0,levelw,levelh)
+
+function renderLine( line, pattern)
+    for i=1, strlen(pattern) do
+        local c = strsub( pattern, i, i)
+        if c =="#" then
+            set_stone( "st-greenbrown", i-1, line)
+        elseif c =="%" then
+            set_stone( "st-greenbrown", i-1, line)
+            set_floor("fl-water",i-1,line)
+        elseif c == "o" then
+            oxyd( i-1, line)
+        elseif c == "O" then
+            oxyd( i-1, line)
+            set_floor("fl-water",i-1,line)
+        elseif c == "*" then
+            set_stone( "st-brownie", i-1, line)
+            set_floor("fl-water",i-1,line)
+        elseif c == "!" then
+            abyss(i-1,line)
+        elseif c == "~" then
+            set_floor("fl-water",i-1,line)
+        elseif c=="z" then
+            set_actor("ac-blackball", i-1,line+.5, {player=0})
+        elseif c == "g" then
+            draw_stones("st-grate1",{i-1,line}, {1,1}, 1)
+        elseif c=="+" then
+            set_stone( "st-wood", i-1, line)
+        elseif c=="=" then
+            set_floor("fl-space",i-1,line)
+        elseif c=="S" then
+            set_actor("ac-top", i-.5,line+.5, {name="t1",player=1, mouseforce=0, range=1000, force=tspeed})
+            set_floor("fl-water",i-1,line)
+        elseif c=="T" then
+            set_actor("ac-top", i-.5,line+.5, {name="t2",player=1, mouseforce=0, range=1000, force=-tspeed})
+            set_floor("fl-water",i-1,line)
+        elseif c=="A" then
+            set_stone("st-switch",i-1,line,{action="callback",target="funcc1"})
+        end
+    end    
+end
+
+renderLine(00,"**O%##o##AA##o##%O**")
+renderLine(01,"*~~~            ~~~*")
+renderLine(02,"O~~S            ~~~O")
+renderLine(03,"%~~~            ~~~%")
+renderLine(04,"o                  o")
+renderLine(05,"#                  #")
+renderLine(06,"A         z        A")
+renderLine(07,"#                  #")
+renderLine(08,"o                  o")
+renderLine(09,"%~~~            ~~~%")
+renderLine(10,"O~~~            T~~O")
+renderLine(11,"*~~~            ~~~*")
+renderLine(12,"**O%##o##AA##o##%O**")
+
+oxyd_shuffle()
+
+t1=enigma.GetNamedObject("t1")
+t2=enigma.GetNamedObject("t2")
+
+ff1=0
+function funcc1()
+    if ff1==0 then
+        enigma.SetAttrib(t1,"force",-tspeed)
+        enigma.SetAttrib(t2,"force",tspeed)
+        ff1=1
+    elseif ff1==1 then
+        enigma.SetAttrib(t1,"force",tspeed)
+        enigma.SetAttrib(t2,"force",-tspeed)
+        ff1=0
+    end
+end
+
+display.SetFollowMode(display.FOLLOW_SCROLLING)
+    ]]></el:luamain>
+    <el:i18n>
+      <el:string el:key="title">
+        <el:english el:translate="false"/>
+      </el:string>
+    </el:i18n>
+  </el:protected>
+</el:level>

Modified: branches/1.0/data/levels/enigma_iii/index.xml
===================================================================
--- branches/1.0/data/levels/enigma_iii/index.xml	2007-04-06 20:58:39 UTC (rev 684)
+++ branches/1.0/data/levels/enigma_iii/index.xml	2007-04-06 23:05:52 UTC (rev 685)
@@ -93,7 +93,7 @@
     <level _seq="85" _title="Lost In Space" _xpath="./martin90_1" author="Martin Hawlisch" ctrl="force" easy="false" id="martin90" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="86" _title="Triple Threat" _xpath="./illmind10_1" author="illmind" ctrl="force" easy="false" id="illmind10" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="87" _title="Tilt Maze" _xpath="./duffy69_1" author="Jacob Scott" ctrl="force" easy="true" id="duffy69" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="88" _title="Think Fast" _xpath="./duffy85_1" author="Jacob Scott" ctrl="force" easy="true" id="duffy85" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="88" _title="Think Fast" _xpath="./duffy85_2" author="Jacob Scott" ctrl="force" easy="true" id="duffy85" rel="2" rev="2" score="2" target="time" unit="duration"/>
     <level _seq="89" _title="Overshoot" _xpath="./ss02_1" author="Sven Siggelkow" ctrl="force" easy="true" id="ss2" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="90" _title="Fool the Watchdog" _xpath="./duffy57_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy57" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="91" _title="The Sargasso Sea" _xpath="./martin17_1" author="Martin Hawlisch" ctrl="force" easy="false" id="martin17" rel="1" rev="0" score="1" target="time" unit="duration"/>

Deleted: branches/1.0/data/levels/enigma_iv/duffy117_1.xml
===================================================================
--- branches/1.0/data/levels/enigma_iv/duffy117_1.xml	2007-04-06 20:58:39 UTC (rev 684)
+++ branches/1.0/data/levels/enigma_iv/duffy117_1.xml	2007-04-06 23:05:52 UTC (rev 685)
@@ -1,151 +0,0 @@
-<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
-<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
-  <el:protected>
-    <el:info el:type="level">
-      <el:identity el:title="Bad Nightmare" el:subtitle="" el:id="duffy117"/>
-      <el:version el:score="1" el:release="1" el:revision="1" el:status="released"/>
-      <el:author  el:name="Jacob Scott" el:email="" el:homepage=""/>
-      <el:copyright>Copyright ? 2004 Jacob Scott</el:copyright>
-      <el:license el:type="GPL v2.0 or above" el:open="true"/>
-      <el:compatibility el:enigma="0.92">
-      </el:compatibility>
-      <el:modes el:easy="true" el:single="true" el:network="false"/>
-      <el:comments>
-        <el:code>Lua 5.1 and XML converted by Leveladministrators</el:code>
-      </el:comments>
-      <el:score el:easy="-" el:difficult="-"/>
-    </el:info>
-    <el:luamain><![CDATA[
--- Jan 06: Added easy-mode;   Andreas
-
-rooms_wide=3
-rooms_high=2
-
-levelw=1+(19*rooms_wide)
-levelh=1+(12*rooms_high)
-
-if difficult then
-  ffct=.4
-else
-  ffct=.25
-end
-
-create_world( levelw, levelh)
-enigma.FrictionFactor=-ffct
-
-fill_floor("fl-rough-blue", 0,0,levelw,levelh)
-
-function renderLine( line, pattern)
-    for i=1, strlen(pattern) do
-        local c = strsub( pattern, i, i)
-        if c =="#" then
-            set_stone( "st-stone1", i-1, line)
-        elseif c =="X" then
-            set_stone( "st-death", i-1, line)
-        elseif c =="&" then
-            set_stone( "st-death", i-1, line)
-            set_floor("fl-space",i-1,line)
-        elseif c =="R" then
-            set_stone( "st-stone1", i-1, line)
-            set_floor( "fl-rough-red", i-1, line)
-        elseif c == "o" then
-            oxyd( i-1, line)
-        elseif c == "%" then
-            oxyd( i-1, line)
-            set_floor("fl-space",i-1,line)
-        elseif c == "*" then
-            set_stone( "st-brownie", i-1, line)
-        elseif c == "!" then
-            abyss(i-1,line)
-        elseif c == "~" then
-            set_floor("fl-water",i-1,line)
-        elseif c == "r" then
-            set_floor("fl-rough-red",i-1,line)
-            set_item("it-trigger",i-1,line,{invisible=1,action="callback",target="funcc1"})
-        elseif c == "H" then
-            set_item("it-hammer",i-1,line)
-        elseif c == "h" then
-            set_stone("st-stone_break",i-1,line)
-        elseif c == "O" then
-            set_item("it-extralife",i-1,line)
-        elseif c == "F" then
-            set_item("it-flagblack",i-1,line)
-        elseif c == "L" then
-            set_item("it-landmine",i-1,line)
-        elseif c=="z" then
-            set_actor("ac-blackball", i-.5,line+.5, {player=0})
-        elseif c=="y" then
-            set_actor("ac-whiteball", i-1,line+.5, {player=1})
-        elseif c == "g" then
-            draw_stones("st-grate1",{i-1,line}, {1,1}, 1)
-        elseif c=="+" then
-            set_stone( "st-wood", i-1, line)
-        elseif c=="=" then
-            set_floor("fl-space",i-1,line)
-        elseif c=="N" then
-            set_stone("st-bolder", i-1,line, {direction=NORTH})
-        elseif c=="E" then
-            set_stone("st-bolder", i-1,line, {direction=EAST})
-        elseif c=="S" then
-            set_stone("st-bolder", i-1,line, {direction=SOUTH})
-        elseif c=="W" then
-            set_stone("st-bolder", i-1,line, {direction=WEST})
-        elseif c=="T" then
-            set_actor("ac-top", i-.5,line+.5, {player=1, mouseforce=0, range=6, force=10})
-        elseif c=="B" then
-            yy1( "black",  i-1, line)
-        end
-    end    
-end
-
-function yy1( color, x, y)
-        stone = format( "st-%s4", color)
-        set_stone( stone, x, y)
-end
-
-renderLine(00,"#############RR##RR####################XXXXXXXXXXXXXXXXXXX")
-renderLine(01,"#           #rr  rrRr r r r r r & r r #    XX      X     X")
-renderLine(02,"#  O        #rr  rrR r r r r r r r r r#            X     X")
-renderLine(03,"#           #rrrrrrRr r r r r r r & rX#        X   X     X")
-renderLine(04,"#           #  rrrrR r r r r rXrLr r r#  XXXXXXX         X")
-renderLine(05,"#           #  rr  RR#r r r r r r r r #     rrrX         X")
-renderLine(06,"#     z      rrrr      r r rLr r r rXr      rrrX      X  X")
-renderLine(07,"#           #rrrrrrRR#r r r r rXr r r #     rrrXXXXXXXX  X")
-renderLine(08,"#           #rr  rrR r r r rXr r r r r#    XXXXX         X")
-renderLine(09,"#           #rr  rrRr r r r r r rXr r #    X         X   X")
-renderLine(10,"#  F        #rrrrrrR r r r r & r rLr X#    X     X       X")
-renderLine(11,"#           #rrrr  Rr r r r r r & r r #    X             X")
-renderLine(12,"#############RRRR###########################B#XXXXXXXXXXXX")
-renderLine(13,"# % = =o= = % = =o=#      N   S       #                  #")
-renderLine(14,"#= = = = = = = = = #EhX  Eh  Eh  hW   #                  #")
-renderLine(15,"# = = = = = = = = =# SX   N   S       #                  #")
-renderLine(16,"#= = = = = = = = = #hS   Eh  Eh  hW   #                  #")
-renderLine(17,"# = = = = = = = = =#NS    N   S       #                  #")
-renderLine(18,"#=X= = & = =X= = &  NS   Eh  Eh  hW   B         T        #")
-renderLine(19,"# = = = = = = = = =#NS    N   S       #                  #")
-renderLine(20,"#= = = = = = = = = #Nh   Eh  Eh  hW   #                  #")
-renderLine(21,"# = = = = = = = = =#N X   N   S       #              H   #")
-renderLine(22,"#= = = = = = = = = #hWX  Eh  Eh  hW   #                  #")
-renderLine(23,"# % = =o= = % = =o=#      N   S       #                  #")
-renderLine(24,"##########################################################")
-
-oxyd_shuffle()
-
-ff1=0
-function funcc1()
-    if ff1==0 then
-        enigma.FrictionFactor=.6
-        ff1=1
-    elseif ff1==1 then
-        enigma.FrictionFactor=-ffct
-        ff1=0
-    end
-end
-    ]]></el:luamain>
-    <el:i18n>
-      <el:string el:key="title">
-        <el:english el:translate="false"/>
-      </el:string>
-    </el:i18n>
-  </el:protected>
-</el:level>

Copied: branches/1.0/data/levels/enigma_iv/duffy117_2.xml (from rev 683, branches/1.0/data/levels/enigma_iv/duffy117_1.xml)
===================================================================
--- branches/1.0/data/levels/enigma_iv/duffy117_1.xml	2007-04-06 11:47:23 UTC (rev 683)
+++ branches/1.0/data/levels/enigma_iv/duffy117_2.xml	2007-04-06 23:05:52 UTC (rev 685)
@@ -0,0 +1,151 @@
+<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
+<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
+  <el:protected>
+    <el:info el:type="level">
+      <el:identity el:title="Bad Nightmare" el:subtitle="" el:id="duffy117"/>
+      <el:version el:score="2" el:release="2" el:revision="2" el:status="released"/>
+      <el:author  el:name="Jacob Scott" el:email="" el:homepage=""/>
+      <el:copyright>Copyright ? 2004 Jacob Scott</el:copyright>
+      <el:license el:type="GPL v2.0 or above" el:open="true"/>
+      <el:compatibility el:enigma="0.92">
+      </el:compatibility>
+      <el:modes el:easy="true" el:single="true" el:network="false"/>
+      <el:comments>
+        <el:code>Lua 5.1 and XML converted by Leveladministrators</el:code>
+      </el:comments>
+      <el:score el:easy="-" el:difficult="-"/>
+    </el:info>
+    <el:luamain><![CDATA[
+-- Jan 06: Added easy-mode;   Andreas
+
+rooms_wide=3
+rooms_high=2
+
+levelw=1+(19*rooms_wide)
+levelh=1+(12*rooms_high)
+
+if difficult then
+  ffct=.4
+else
+  ffct=.25
+end
+
+create_world( levelw, levelh)
+enigma.FrictionFactor=-ffct
+
+fill_floor("fl-rough-blue", 0,0,levelw,levelh)
+
+function renderLine( line, pattern)
+    for i=1, strlen(pattern) do
+        local c = strsub( pattern, i, i)
+        if c =="#" then
+            set_stone( "st-stone1", i-1, line)
+        elseif c =="X" then
+            set_stone( "st-death", i-1, line)
+        elseif c =="&" then
+            set_stone( "st-death", i-1, line)
+            set_floor("fl-space",i-1,line)
+        elseif c =="R" then
+            set_stone( "st-stone1", i-1, line)
+            set_floor( "fl-rough-red", i-1, line)
+        elseif c == "o" then
+            oxyd( i-1, line)
+        elseif c == "%" then
+            oxyd( i-1, line)
+            set_floor("fl-space",i-1,line)
+        elseif c == "*" then
+            set_stone( "st-brownie", i-1, line)
+        elseif c == "!" then
+            abyss(i-1,line)
+        elseif c == "~" then
+            set_floor("fl-water",i-1,line)
+        elseif c == "r" then
+            set_floor("fl-rough-red",i-1,line)
+            set_item("it-trigger",i-1,line,{invisible=1,action="callback",target="funcc1"})
+        elseif c == "H" then
+            set_item("it-hammer",i-1,line)
+        elseif c == "h" then
+            set_stone("st-stone_break",i-1,line)
+        elseif c == "O" then
+            set_item("it-extralife",i-1,line)
+        elseif c == "F" then
+            set_item("it-flagblack",i-1,line)
+        elseif c == "L" then
+            set_item("it-landmine",i-1,line)
+        elseif c=="z" then
+            set_actor("ac-blackball", i-.5,line+.5, {player=0})
+        elseif c=="y" then
+            set_actor("ac-whiteball", i-1,line+.5, {player=1})
+        elseif c == "g" then
+            draw_stones("st-grate1",{i-1,line}, {1,1}, 1)
+        elseif c=="+" then
+            set_stone( "st-wood", i-1, line)
+        elseif c=="=" then
+            set_floor("fl-space",i-1,line)
+        elseif c=="N" then
+            set_stone("st-bolder", i-1,line, {direction=NORTH})
+        elseif c=="E" then
+            set_stone("st-bolder", i-1,line, {direction=EAST})
+        elseif c=="S" then
+            set_stone("st-bolder", i-1,line, {direction=SOUTH})
+        elseif c=="W" then
+            set_stone("st-bolder", i-1,line, {direction=WEST})
+        elseif c=="T" then
+            set_actor("ac-top", i-.5,line+.5, {player=1, mouseforce=0, range=6, force=10})
+        elseif c=="B" then
+            yy1( "black",  i-1, line)
+        end
+    end    
+end
+
+function yy1( color, x, y)
+        stone = format( "st-%s4", color)
+        set_stone( stone, x, y)
+end
+
+renderLine(00,"#############RR##RR####################XXXXXXXXXXXXXXXXXXX")
+renderLine(01,"#           #rr  rrRr r r r r r & r r #    XX      X     X")
+renderLine(02,"#  O        #rr  rrR r r r r r r r r r#            X     X")
+renderLine(03,"#           #rrrrrrRr r r r r r r & rX#        X   X     X")
+renderLine(04,"#           #  rrrrR r r r r rXrLr r r#  XXXXXXX         X")
+renderLine(05,"#           #  rr  RR#r r r r r r r r #     rrrX         X")
+renderLine(06,"#     z      rrrr      r r rLr r r rXr      rrrX      X  X")
+renderLine(07,"#           #rrrrrrRR#r r r r rXr r r #     rrrXXXXXXXX  X")
+renderLine(08,"#           #rr  rrR r r r rXr r r r r#    XXXXX         X")
+renderLine(09,"#           #rr  rrRr r r r r r rXr r #    X         X   X")
+renderLine(10,"#  F        #rrrrrrR r r r r & r rLr X#    X     X       X")
+renderLine(11,"#           #rrrr  Rr r r r r r & r r #    X             X")
+renderLine(12,"#############RRRR###########################B#XXXXXXXXXXXX")
+renderLine(13,"# % = =o= = % = =o=#      N   S       #                  #")
+renderLine(14,"#= = = = = = = = = #EhX  Eh  Eh  hW   #                  #")
+renderLine(15,"# = = = = = = = = =# SX   N   S       #                  #")
+renderLine(16,"#= = = = = = = = = #hS   Eh  Eh  hW   #                  #")
+renderLine(17,"# = = = = = = = = =#NS    N   S       #                  #")
+renderLine(18,"#=X= = & = =X= = &  NS   Eh  Eh  hW   B         T        #")
+renderLine(19,"# = = = = = = = = =#NS    N   S       #                  #")
+renderLine(20,"#= = = = = = = = = #Nh   Eh  Eh  hW   #                  #")
+renderLine(21,"# = = = = = = = = =#N X   N   S       #              H   #")
+renderLine(22,"#= = = = = = = = = #hWX  Eh  Eh  hW   #                  #")
+renderLine(23,"# % = =o= = % = =o=#      N   S       #                  #")
+renderLine(24,"##########################################################")
+
+oxyd_shuffle()
+
+ff1=0
+function funcc1()
+    if ff1==0 then
+        enigma.FrictionFactor=.6
+        ff1=1
+    elseif ff1==1 then
+        enigma.FrictionFactor=-ffct
+        ff1=0
+    end
+end
+    ]]></el:luamain>
+    <el:i18n>
+      <el:string el:key="title">
+        <el:english el:translate="false"/>
+      </el:string>
+    </el:i18n>
+  </el:protected>
+</el:level>

Deleted: branches/1.0/data/levels/enigma_iv/duffy124_1.xml
===================================================================
--- branches/1.0/data/levels/enigma_iv/duffy124_1.xml	2007-04-06 20:58:39 UTC (rev 684)
+++ branches/1.0/data/levels/enigma_iv/duffy124_1.xml	2007-04-06 23:05:52 UTC (rev 685)
@@ -1,88 +0,0 @@
-<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
-<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
-  <el:protected>
-    <el:info el:type="level">
-      <el:identity el:title="Worse Nightmare" el:subtitle="" el:id="duffy124"/>
-      <el:version el:score="1" el:release="1" el:revision="1" el:status="released"/>
-      <el:author  el:name="Jacob Scott" el:email="" el:homepage=""/>
-      <el:copyright>Copyright ? 2004 Jacob Scott</el:copyright>
-      <el:license el:type="GPL v2.0 or above" el:open="true"/>
-      <el:compatibility el:enigma="0.92">
-      </el:compatibility>
-      <el:modes el:easy="true" el:single="true" el:network="false"/>
-      <el:comments>
-        <el:code>Lua 5.1 and XML converted by Leveladministrators</el:code>
-      </el:comments>
-      <el:score el:easy="-" el:difficult="-"/>
-    </el:info>
-    <el:luamain><![CDATA[
--- Jan 06: Added easy-mode;   Andreas
-
-rooms_wide=1
-rooms_high=1
-
-levelw=1+(19*rooms_wide)
-levelh=1+(12*rooms_high)
-
-create_world( levelw, levelh)
-
-if difficult then
-  enigma.FrictionFactor=-0.5
-else
-  enigma.FrictionFactor=-0.3
-end
-
-fill_floor("fl-rough-blue", 0,0,levelw,levelh)
-
-function renderLine( line, pattern)
-    for i=1, strlen(pattern) do
-        local c = strsub( pattern, i, i)
-        if c =="#" then
-            set_stone( "st-stone1", i-1, line)
-        elseif c == "o" then
-            oxyd( i-1, line)
-        elseif c == "*" then
-            set_stone( "st-brownie", i-1, line)
-        elseif c == "!" then
-            abyss(i-1,line)
-        elseif c == "~" then
-            set_floor("fl-water",i-1,line)
-        elseif c == "L" then
-            set_item("it-landmine",i-1,line)
-        elseif c=="z" then
-            set_actor("ac-blackball", i-1,line+.5, {player=0})
-        elseif c=="y" then
-            set_actor("ac-whiteball", i-1,line+.5, {player=1})
-        elseif c == "g" then
-            draw_stones("st-grate1",{i-1,line}, {1,1}, 1)
-        elseif c=="+" then
-            set_stone( "st-wood", i-1, line)
-        elseif c=="=" then
-            set_floor("fl-space",i-1,line)
-        end
-    end    
-end
-
-renderLine(00,"####################")
-renderLine(01,"#oL    L oo   L L o#")
-renderLine(02,"#  L L   L LL L    #")
-renderLine(03,"#L L    L      L L #")
-renderLine(04,"#     L  L  L L   L#")
-renderLine(05,"#      L   L   L L #")
-renderLine(06,"#o  z    L   LL L o#")
-renderLine(07,"#     L  L LL     L#")
-renderLine(08,"#         L  L LL  #")
-renderLine(09,"# L  LL  L    L  L #")
-renderLine(10,"# L    L  L L   L  #")
-renderLine(11,"#o   L   oo   L  Lo#")
-renderLine(12,"####################")
-
-oxyd_shuffle()
-    ]]></el:luamain>
-    <el:i18n>
-      <el:string el:key="title">
-        <el:english el:translate="false"/>
-      </el:string>
-    </el:i18n>
-  </el:protected>
-</el:level>

Copied: branches/1.0/data/levels/enigma_iv/duffy124_2.xml (from rev 683, branches/1.0/data/levels/enigma_iv/duffy124_1.xml)
===================================================================
--- branches/1.0/data/levels/enigma_iv/duffy124_1.xml	2007-04-06 11:47:23 UTC (rev 683)
+++ branches/1.0/data/levels/enigma_iv/duffy124_2.xml	2007-04-06 23:05:52 UTC (rev 685)
@@ -0,0 +1,88 @@
+<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
+<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
+  <el:protected>
+    <el:info el:type="level">
+      <el:identity el:title="Worse Nightmare" el:subtitle="" el:id="duffy124"/>
+      <el:version el:score="2" el:release="2" el:revision="2" el:status="released"/>
+      <el:author  el:name="Jacob Scott" el:email="" el:homepage=""/>
+      <el:copyright>Copyright ? 2004 Jacob Scott</el:copyright>
+      <el:license el:type="GPL v2.0 or above" el:open="true"/>
+      <el:compatibility el:enigma="0.92">
+      </el:compatibility>
+      <el:modes el:easy="true" el:single="true" el:network="false"/>
+      <el:comments>
+        <el:code>Lua 5.1 and XML converted by Leveladministrators</el:code>
+      </el:comments>
+      <el:score el:easy="-" el:difficult="-"/>
+    </el:info>
+    <el:luamain><![CDATA[
+-- Jan 06: Added easy-mode;   Andreas
+
+rooms_wide=1
+rooms_high=1
+
+levelw=1+(19*rooms_wide)
+levelh=1+(12*rooms_high)
+
+create_world( levelw, levelh)
+
+if difficult then
+  enigma.FrictionFactor=-0.5
+else
+  enigma.FrictionFactor=-0.3
+end
+
+fill_floor("fl-rough-blue", 0,0,levelw,levelh)
+
+function renderLine( line, pattern)
+    for i=1, strlen(pattern) do
+        local c = strsub( pattern, i, i)
+        if c =="#" then
+            set_stone( "st-stone1", i-1, line)
+        elseif c == "o" then
+            oxyd( i-1, line)
+        elseif c == "*" then
+            set_stone( "st-brownie", i-1, line)
+        elseif c == "!" then
+            abyss(i-1,line)
+        elseif c == "~" then
+            set_floor("fl-water",i-1,line)
+        elseif c == "L" then
+            set_item("it-landmine",i-1,line)
+        elseif c=="z" then
+            set_actor("ac-blackball", i-1,line+.5, {player=0})
+        elseif c=="y" then
+            set_actor("ac-whiteball", i-1,line+.5, {player=1})
+        elseif c == "g" then
+            draw_stones("st-grate1",{i-1,line}, {1,1}, 1)
+        elseif c=="+" then
+            set_stone( "st-wood", i-1, line)
+        elseif c=="=" then
+            set_floor("fl-space",i-1,line)
+        end
+    end    
+end
+
+renderLine(00,"####################")
+renderLine(01,"#oL    L oo   L L o#")
+renderLine(02,"#  L L   L LL L    #")
+renderLine(03,"#L L    L      L L #")
+renderLine(04,"#     L  L  L L   L#")
+renderLine(05,"#      L   L   L L #")
+renderLine(06,"#o  z    L   LL L o#")
+renderLine(07,"#     L  L LL     L#")
+renderLine(08,"#         L  L LL  #")
+renderLine(09,"# L  LL  L    L  L #")
+renderLine(10,"# L    L  L L   L  #")
+renderLine(11,"#o   L   oo   L  Lo#")
+renderLine(12,"####################")
+
+oxyd_shuffle()
+    ]]></el:luamain>
+    <el:i18n>
+      <el:string el:key="title">
+        <el:english el:translate="false"/>
+      </el:string>
+    </el:i18n>
+  </el:protected>
+</el:level>

Modified: branches/1.0/data/levels/enigma_iv/index.xml
===================================================================
--- branches/1.0/data/levels/enigma_iv/index.xml	2007-04-06 20:58:39 UTC (rev 684)
+++ branches/1.0/data/levels/enigma_iv/index.xml	2007-04-06 23:05:52 UTC (rev 685)
@@ -90,9 +90,9 @@
     <level _seq="82" _title="Laser Pushing" _xpath="./just04_1" author="JuSt" ctrl="force" easy="false" id="just04" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="83" _title="Friction Nightmare" _xpath="./luc01_1" author="Lukas Sch?ller" ctrl="force" easy="true" id="luc01" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="84" _title="Prison Yard" _xpath="./nat20_1" author="Nat Pryce" ctrl="force" easy="true" id="nat20" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="85" _title="Bad Nightmare" _xpath="./duffy117_1" author="Jacob Scott" ctrl="force" easy="true" id="duffy117" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="85" _title="Bad Nightmare" _xpath="./duffy117_2" author="Jacob Scott" ctrl="force" easy="true" id="duffy117" rel="2" rev="2" score="2" target="time" unit="duration"/>
     <level _seq="86" _title="Laser Games" _xpath="./mp03_1" author="moonpearl" ctrl="force" easy="false" id="mp03" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="87" _title="Worse Nightmare" _xpath="./duffy124_1" author="Jacob Scott" ctrl="force" easy="true" id="duffy124" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="87" _title="Worse Nightmare" _xpath="./duffy124_2" author="Jacob Scott" ctrl="force" easy="true" id="duffy124" rel="2" rev="2" score="2" target="time" unit="duration"/>
     <level _seq="88" _title="Squaring the Circle" _xpath="./nat16_1" author="Nat Pryce" ctrl="force" easy="true" id="nat16" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="89" _title="Pain" _xpath="./ant27_1" author="Petr Machata" ctrl="force" easy="false" id="ant27" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="90" _title="Drunkard's Walk" _xpath="./duffy105_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy105" rel="1" rev="0" score="1" target="time" unit="duration"/>

Deleted: branches/1.0/data/levels/enigma_v/alain26_1.xml
===================================================================
--- branches/1.0/data/levels/enigma_v/alain26_1.xml	2007-04-06 20:58:39 UTC (rev 684)
+++ branches/1.0/data/levels/enigma_v/alain26_1.xml	2007-04-06 23:05:52 UTC (rev 685)
@@ -1,147 +0,0 @@
-<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
-<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
-  <el:protected>
-    <el:info el:type="level">
-      <el:identity el:title="Banana Republic" el:subtitle="" el:id="alain26"/>
-      <el:version el:score="1" el:release="1" el:revision="1" el:status="released"/>
-      <el:author  el:name="Alain Busser" el:email="" el:homepage=""/>
-      <el:copyright>Copyright ? 2006 Alain Busser</el:copyright>
-      <el:license el:type="GPL v2.0 or above" el:open="true"/>
-      <el:compatibility el:enigma="0.92">
-      </el:compatibility>
-      <el:modes el:easy="true" el:single="true" el:network="false"/>
-      <el:comments>
-        <el:code>Lua 5.1 and XML converted by Leveladministrators</el:code>
-      </el:comments>
-      <el:score el:easy="-" el:difficult="1:52"/>
-    </el:info>
-    <el:luamain><![CDATA[
-levelw = 39
-levelh = 25
-wealth=0
-
-if difficult then
-    gcforce=20
-else
-    gcforce=8
-end
-
-create_world(levelw, levelh)
-oxyd_default_flavor = "a"
-display.SetFollowMode(display.FOLLOW_SCROLLING)
-fill_floor("fl-leaves", 0,0, level_width,level_height)
-
-function renderLine( line, pattern)
-    for i=1, strlen(pattern) do
-        local c = strsub( pattern, i, i)
-        if c =="#" then
-            set_stone( "st-glass1", i-1, line)
-        elseif c=="z" then
-            set_actor("ac-blackball",i-0.5,line+0.5,{player=0})
-        elseif c=="-" then
-            set_floor("fl-swamp",i-1,line)
-        elseif c=="." then
-            set_floor("fl-sand",i-1,line)
-        elseif c=="t" then
-            set_actor("ac-top",i-0.5,line+0.5,{range=10,force=gcforce,name="guard1",gohome=TRUE})
-        elseif c=="b" then
-            set_item("it-banana", i-1,line)
-        elseif c=="c" then
-            if random(2)==1 then
-                set_item("it-trigger",i-1,line,{invisible=1,action="callback",target="plusdejus"})
-            else
-                set_item("it-coin1",i-1,line)
-                wealth=wealth+1
-            end
-        elseif c=="C" then
-            set_stone("st-coinslot",i-1,line,{action="callback", target="func1"}) 
-        elseif c=="e" then
-            set_item("it-dynamite", i-1,line)
-        elseif c=="B" then
-            set_item("it-blackbomb",i-1,line)
-        elseif c=="k" then
-            set_item("it-key_a",i-1,line)
-        elseif c=="w" then
-            set_stone("st-wood",i-1,line)
-        elseif c=="h" then
-            doorh(i-1,line, {name="door1"})
-        elseif c=="a" then
-            set_stone("st-key_a", i-1,line, {action="callback", target="riendutout"})
-        elseif c=="x" then
-            set_stone("st-knight", i-1,line)
-        elseif c=="1" then
-            set_attrib(laser(i-1,line,FALSE, SOUTH), "name", "lasero")
-        elseif c=="d" then
-            document(i-1,line,"text1")
-            document(i-1,line+1,"text3")
-        elseif c=="o" then
-            oxyd(i-1,line)
-        end
-    end    
-end
-
-function func1()
-    set_item("it-sword", 10,20)
-end
-
-function riendutout()
-    document(20,12,"text2")
-end
-
-function plusdejus()
-    SendMessage("lasero","off") 
-end
-
---               012345678901234567890123456789012345678
-renderLine(00 , "---------------------------------------")
-renderLine(01 , "---------------------------------------")
-renderLine(02 , "----......-----------------------------")
-renderLine(03 , "---........-------------------.....----")
-renderLine(04 , "--..t####t..-----------------..ttt..---")  
-renderLine(05 , "--.. #cc# ..-----------------..tkt..---")
-renderLine(06 , "--..B#cc# ..-----------------..ttt..---")
-renderLine(07 , "--.. #ah# ..------------------.....----")
-renderLine(08 , "---...tt...----------------------------")
-renderLine(09 , "----......-----------------------------")
-renderLine(10 , "----------------......-----------------")
-renderLine(11 , "---------------..z..d..----------------")
-renderLine(12 , "--------------..      ..---------------")
-renderLine(13 , "--------------..  1bwb..---------------")
-renderLine(14 , "--------------..   bbb..---------------")  
-renderLine(15 , "--------------..      ..---------------")
-renderLine(16 , "--------------..   B  ..---------------")
-renderLine(17 , "---------------........----------------")
-renderLine(18 , "------......----......------.......----")
-renderLine(19 , "-----..   e..--------------..xxxxx..---")
-renderLine(20 , "-----..B C ..--------------..xoxox..---")
-renderLine(21 , "-----...  ...--------------..xxxxx..---")
-renderLine(22 , "------......----------------.......----")
-renderLine(23 , "---------------------------------------")
-renderLine(24 , "---------------------------------------")
---               012345678901234567890123456789012345678
-
-oxyd_shuffle()
-if wealth==0 then
-    set_item("it-coin1",6,5)
-end
-    
-SendMessage("lasero","on") 
-    ]]></el:luamain>
-    <el:i18n>
-      <el:string el:key="title">
-        <el:english el:translate="false"/>
-      </el:string>
-      <el:string el:key="text1">
-        <el:english el:translate="true" el:comment="This is not real spanish, only an ambience">Caramba!! El Dictator has muchos pesos in his cristal safe but muchos costa guardia too; Hay!! Poor Bola Negra has only frutos and a lasero!!!</el:english>
-        <el:translation el:lang="fr">El Dictator a muchos pesetas dans son coffre de cristal mais muchos guardians; Caramba! Bola Negra n'a que des frutos et un lasero!!!</el:translation>
-      </el:string> 
-      <el:string el:key="text2">
-        <el:english el:translate="false">You have been seen using a forbidden key; costa guardia are chasing you now; El Dictator too.</el:english>
-        <el:translation el:lang="fr">On vous a vu utiliser une clef interdite; les costa guardia vous pourchassent!</el:translation>
-      </el:string> 
-      <el:string el:key="text3">
-        <el:english el:translate="false">Hasta la Enigma !!!</el:english>
-      </el:string> 
-    </el:i18n>
-  </el:protected>
-</el:level>

Copied: branches/1.0/data/levels/enigma_v/alain26_2.xml (from rev 683, branches/1.0/data/levels/enigma_v/alain26_1.xml)
===================================================================
--- branches/1.0/data/levels/enigma_v/alain26_1.xml	2007-04-06 11:47:23 UTC (rev 683)
+++ branches/1.0/data/levels/enigma_v/alain26_2.xml	2007-04-06 23:05:52 UTC (rev 685)
@@ -0,0 +1,147 @@
+<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
+<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
+  <el:protected>
+    <el:info el:type="level">
+      <el:identity el:title="Banana Republic" el:subtitle="" el:id="alain26"/>
+      <el:version el:score="2" el:release="2" el:revision="2" el:status="released"/>
+      <el:author  el:name="Alain Busser" el:email="" el:homepage=""/>
+      <el:copyright>Copyright ? 2006 Alain Busser</el:copyright>
+      <el:license el:type="GPL v2.0 or above" el:open="true"/>
+      <el:compatibility el:enigma="0.92">
+      </el:compatibility>
+      <el:modes el:easy="true" el:single="true" el:network="false"/>
+      <el:comments>
+        <el:code>Lua 5.1 and XML converted by Leveladministrators</el:code>
+      </el:comments>
+      <el:score el:easy="-" el:difficult="1:52"/>
+    </el:info>
+    <el:luamain><![CDATA[
+levelw = 39
+levelh = 25
+wealth=0
+
+if difficult then
+    gcforce=20
+else
+    gcforce=8
+end
+
+create_world(levelw, levelh)
+oxyd_default_flavor = "a"
+display.SetFollowMode(display.FOLLOW_SCROLLING)
+fill_floor("fl-leaves", 0,0, level_width,level_height)
+
+function renderLine( line, pattern)
+    for i=1, strlen(pattern) do
+        local c = strsub( pattern, i, i)
+        if c =="#" then
+            set_stone( "st-glass1", i-1, line)
+        elseif c=="z" then
+            set_actor("ac-blackball",i-0.5,line+0.5,{player=0})
+        elseif c=="-" then
+            set_floor("fl-swamp",i-1,line)
+        elseif c=="." then
+            set_floor("fl-sand",i-1,line)
+        elseif c=="t" then
+            set_actor("ac-top",i-0.5,line+0.5,{range=10,force=gcforce,name="guard1",gohome=TRUE})
+        elseif c=="b" then
+            set_item("it-banana", i-1,line)
+        elseif c=="c" then
+            if random(2)==1 then
+                set_item("it-trigger",i-1,line,{invisible=1,action="callback",target="plusdejus"})
+            else
+                set_item("it-coin1",i-1,line)
+                wealth=wealth+1
+            end
+        elseif c=="C" then
+            set_stone("st-coinslot",i-1,line,{action="callback", target="func1"}) 
+        elseif c=="e" then
+            set_item("it-dynamite", i-1,line)
+        elseif c=="B" then
+            set_item("it-blackbomb",i-1,line)
+        elseif c=="k" then
+            set_item("it-key_a",i-1,line)
+        elseif c=="w" then
+            set_stone("st-wood",i-1,line)
+        elseif c=="h" then
+            doorh(i-1,line, {name="door1"})
+        elseif c=="a" then
+            set_stone("st-key_a", i-1,line, {action="callback", target="riendutout"})
+        elseif c=="x" then
+            set_stone("st-knight", i-1,line)
+        elseif c=="1" then
+            set_attrib(laser(i-1,line,FALSE, SOUTH), "name", "lasero")
+        elseif c=="d" then
+            document(i-1,line,"text1")
+            document(i-1,line+1,"text3")
+        elseif c=="o" then
+            oxyd(i-1,line)
+        end
+    end    
+end
+
+function func1()
+    set_item("it-sword", 10,20)
+end
+
+function riendutout()
+    document(20,12,"text2")
+end
+
+function plusdejus()
+    SendMessage("lasero","off") 
+end
+
+--               012345678901234567890123456789012345678
+renderLine(00 , "---------------------------------------")
+renderLine(01 , "---------------------------------------")
+renderLine(02 , "----......-----------------------------")
+renderLine(03 , "---........-------------------.....----")
+renderLine(04 , "--..t####t..-----------------..ttt..---")  
+renderLine(05 , "--.. #cc# ..-----------------..tkt..---")
+renderLine(06 , "--..B#cc# ..-----------------..ttt..---")
+renderLine(07 , "--.. #ah# ..------------------.....----")
+renderLine(08 , "---...tt...----------------------------")
+renderLine(09 , "----......-----------------------------")
+renderLine(10 , "----------------......-----------------")
+renderLine(11 , "---------------..z..d..----------------")
+renderLine(12 , "--------------..      ..---------------")
+renderLine(13 , "--------------..  1bwb..---------------")
+renderLine(14 , "--------------..   bbb..---------------")  
+renderLine(15 , "--------------..      ..---------------")
+renderLine(16 , "--------------..   B  ..---------------")
+renderLine(17 , "---------------........----------------")
+renderLine(18 , "------......----......------.......----")
+renderLine(19 , "-----..   e..--------------..xxxxx..---")
+renderLine(20 , "-----..B C ..--------------..xoxox..---")
+renderLine(21 , "-----...  ...--------------..xxxxx..---")
+renderLine(22 , "------......----------------.......----")
+renderLine(23 , "---------------------------------------")
+renderLine(24 , "---------------------------------------")
+--               012345678901234567890123456789012345678
+
+oxyd_shuffle()
+if wealth==0 then
+    set_item("it-coin1",6,5)
+end
+    
+SendMessage("lasero","on") 
+    ]]></el:luamain>
+    <el:i18n>
+      <el:string el:key="title">
+        <el:english el:translate="false"/>
+      </el:string>
+      <el:string el:key="text1">
+        <el:english el:translate="true" el:comment="This is not real spanish, only an ambience">Caramba!! El Dictator has muchos pesos in his cristal safe but muchos costa guardia too; Hay!! Poor Bola Negra has only frutos and a lasero!!!</el:english>
+        <el:translation el:lang="fr">El Dictator a muchos pesetas dans son coffre de cristal mais muchos guardians; Caramba! Bola Negra n'a que des frutos et un lasero!!!</el:translation>
+      </el:string> 
+      <el:string el:key="text2">
+        <el:english el:translate="false">You have been seen using a forbidden key; costa guardia are chasing you now; El Dictator too.</el:english>
+        <el:translation el:lang="fr">On vous a vu utiliser une clef interdite; les costa guardia vous pourchassent!</el:translation>
+      </el:string> 
+      <el:string el:key="text3">
+        <el:english el:translate="false">Hasta la Enigma !!!</el:english>
+      </el:string> 
+    </el:i18n>
+  </el:protected>
+</el:level>

Deleted: branches/1.0/data/levels/enigma_v/duffy114_1.xml
===================================================================
--- branches/1.0/data/levels/enigma_v/duffy114_1.xml	2007-04-06 20:58:39 UTC (rev 684)
+++ branches/1.0/data/levels/enigma_v/duffy114_1.xml	2007-04-06 23:05:52 UTC (rev 685)
@@ -1,153 +0,0 @@
-<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
-<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
-  <el:protected>
-    <el:info el:type="level">
-      <el:identity el:title="Plan Ahead" el:subtitle="" el:id="duffy114"/>
-      <el:version el:score="1" el:release="1" el:revision="1" el:status="released"/>
-      <el:author  el:name="Jacob Scott" el:email="" el:homepage=""/>
-      <el:copyright>Copyright ? 2004 Jacob Scott</el:copyright>
-      <el:license el:type="GPL v2.0 or above" el:open="true"/>
-      <el:compatibility el:enigma="0.92">
-      </el:compatibility>
-      <el:modes el:easy="true" el:single="true" el:network="false"/>
-      <el:comments>
-        <el:code>Lua 5.1 and XML converted by Leveladministrators</el:code>
-      </el:comments>
-      <el:score el:easy="-" el:difficult="-"/>
-    </el:info>
-    <el:luamain><![CDATA[
-rooms_wide=1
-rooms_high=1
-
-levelw=1+(19*rooms_wide)
-levelh=1+(12*rooms_high)
-
-create_world( levelw, levelh)
-enigma.ConserveLevel=TRUE
-
-fill_floor("fl-rough-red", 0,0,levelw,levelh)
-
-function renderLine( line, pattern)
-    for i=1, strlen(pattern) do
-        local c = strsub( pattern, i, i)
-        if c =="#" then
-            set_stone( "st-rock1", i-1, line)
-        elseif c =="%" then
-            set_stone( "st-rock1", i-1, line)
-            set_floor("fl-water",i-1,line)
-        elseif c == "O" then
-            set_stone("st-oxyd", i-1, line,{color="0"})
-        elseif c == "P" then
-            set_stone("st-oxyd", i-1, line,{color="1"})
-        elseif c == "Q" then
-            set_stone("st-oxyd", i-1, line,{color="2"})
-        elseif c == "`" then
-            set_stone("st-oxyd", i-1, line,{color="3"})
-        elseif c == "^" then
-            set_stone("st-oxyd", i-1, line,{color="4"})
-        elseif c == "." then
-            if not difficult then
-                set_stone("st-oxyd", i-1, line,{color="2"})
-            else
-                set_stone("st-oxyd", i, line,{color="2"})
-                set_stone( "st-rock1", i-1, line)
-            end
-        elseif c == "*" then
-            set_stone( "st-brownie", i-1, line)
-        elseif c == "!" then
-            abyss(i-1,line)
-        elseif c == "~" then
-            set_floor("fl-water",i-1,line)
-        elseif c=="z" then
-            set_actor("ac-blackball", i-.5,line+.5, {player=0, essential=1})
-            set_item("it-yinyang",i-1,line)
-        elseif c=="y" then
-            if not difficult then
-                set_actor("ac-whiteball", i-1,line+.5, {player=1, essential=1})
-            else
-                set_actor("ac-whiteball", i-.5,line+.5, {player=1, essential=1})
-            end
-        elseif c=="C" then
-            set_item("it-crack3",i-1,line)
-            draw_stones("st-grate1",{i-1,line}, {1,1}, 1)
-        elseif c=="S" then
-            set_item("it-seed",i-1,line)
-        elseif c=="B" then
-            set_item("it-bag",i-1,line)
-        elseif c=="D" then
-            set_item("it-dynamite",i-1,line)
-        elseif c=="h" then
-            set_item("it-hollow",i-1,line)
-        elseif c == "g" then
-            draw_stones("st-grate1",{i-1,line}, {1,1}, 1)
-        elseif c == "G" then
-            if difficult==false then
-                --            draw_stones("st-grate1",{i-1,line}, {1,1}, 1)
-            else
-                draw_stones("st-grate1",{i-1,line}, {1,1}, 1)
-            end
-        elseif c == "H" then
-            set_stone("st-rock3_break",i-1,line)
-        elseif c == "$" then
-            set_stone("st-rock3",i-1,line)
-        elseif c=="+" then
-            set_stone( "st-wood", i-1, line)
-        elseif c=="=" then
-            set_floor("fl-space",i-1,line)
-        elseif c=="U" then
-            set_stone("st-oneway", i-1,line, {orientation=enigma.NORTH})    
-        elseif c=="R" then
-            set_stone("st-oneway", i-1,line, {orientation=enigma.EAST})    
-        elseif c=="D" then
-            set_stone("st-oneway", i-1,line, {orientation=enigma.SOUTH})    
-        elseif c=="L" then
-            set_stone("st-oneway", i-1,line, {orientation=enigma.WEST})
-        elseif c=="u" then
-            set_stone("st-oneway_black", i-1,line, {orientation=enigma.NORTH})
-        elseif c=="r" then
-            set_stone("st-oneway_black", i-1,line, {orientation=enigma.EAST})
-        elseif c=="d" then
-            set_stone("st-oneway_black", i-1,line, {orientation=enigma.SOUTH})
-        elseif c=="l" then
-            set_stone("st-oneway_black", i-1,line, {orientation=enigma.WEST})
-        elseif c=="w" then
-            set_stone("st-oneway_white", i-1,line, {orientation=enigma.WEST})
-        elseif c=="Z" then
-            yy1( "black",  i-1, line)
-        elseif c=="Y" then
-            yy1( "white",  i-1, line)
-            if not difficult then
-                set_item("it-yinyang",i-1,line)
-            end
-        elseif c=="q" then
-            yy1( "white",  i-1, line)
-        end
-    end    
-end
-
-function yy1( color, x, y)
-    stone = format( "st-%s4", color)
-    set_stone( stone, x, y)
-end
-
-renderLine(00,"####################")
-renderLine(01,"###    ######   SZO#")
-renderLine(02,"#Dw    lCCCCl   SZZ#")
-renderLine(03,"### qqq######    ZZ#")
-renderLine(04,"#O  qhH######Hh  ZP#")
-renderLine(05,"#P  qhH~~~~~ZHh  ZZ#")
-renderLine(06,"#. yqhH~~~~~ZHhBzSYQ")
-renderLine(07,"#`  qhH~~~~~ZHh  ZZ#")
-renderLine(08,"#^  qhH######Hh  Z`#")
-renderLine(09,"### qqq######    ZZ#")
-renderLine(10,"#Dl    rCCCCr   SZZ#")
-renderLine(11,"###    ######   SZ^#")
-renderLine(12,"####################")
-    ]]></el:luamain>
-    <el:i18n>
-      <el:string el:key="title">
-        <el:english el:translate="false"/>
-      </el:string>
-    </el:i18n>
-  </el:protected>
-</el:level>

Copied: branches/1.0/data/levels/enigma_v/duffy114_2.xml (from rev 683, branches/1.0/data/levels/enigma_v/duffy114_1.xml)
===================================================================
--- branches/1.0/data/levels/enigma_v/duffy114_1.xml	2007-04-06 11:47:23 UTC (rev 683)
+++ branches/1.0/data/levels/enigma_v/duffy114_2.xml	2007-04-06 23:05:52 UTC (rev 685)
@@ -0,0 +1,153 @@
+<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
+<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
+  <el:protected>
+    <el:info el:type="level">
+      <el:identity el:title="Plan Ahead" el:subtitle="" el:id="duffy114"/>
+      <el:version el:score="2" el:release="2" el:revision="2" el:status="released"/>
+      <el:author  el:name="Jacob Scott" el:email="" el:homepage=""/>
+      <el:copyright>Copyright ? 2004 Jacob Scott</el:copyright>
+      <el:license el:type="GPL v2.0 or above" el:open="true"/>
+      <el:compatibility el:enigma="0.92">
+      </el:compatibility>
+      <el:modes el:easy="true" el:single="true" el:network="false"/>
+      <el:comments>
+        <el:code>Lua 5.1 and XML converted by Leveladministrators</el:code>
+      </el:comments>
+      <el:score el:easy="-" el:difficult="-"/>
+    </el:info>
+    <el:luamain><![CDATA[
+rooms_wide=1
+rooms_high=1
+
+levelw=1+(19*rooms_wide)
+levelh=1+(12*rooms_high)
+
+create_world( levelw, levelh)
+enigma.ConserveLevel=TRUE
+
+fill_floor("fl-rough-red", 0,0,levelw,levelh)
+
+function renderLine( line, pattern)
+    for i=1, strlen(pattern) do
+        local c = strsub( pattern, i, i)
+        if c =="#" then
+            set_stone( "st-rock1", i-1, line)
+        elseif c =="%" then
+            set_stone( "st-rock1", i-1, line)
+            set_floor("fl-water",i-1,line)
+        elseif c == "O" then
+            set_stone("st-oxyd", i-1, line,{color="0"})
+        elseif c == "P" then
+            set_stone("st-oxyd", i-1, line,{color="1"})
+        elseif c == "Q" then
+            set_stone("st-oxyd", i-1, line,{color="2"})
+        elseif c == "`" then
+            set_stone("st-oxyd", i-1, line,{color="3"})
+        elseif c == "^" then
+            set_stone("st-oxyd", i-1, line,{color="4"})
+        elseif c == "." then
+            if not difficult then
+                set_stone("st-oxyd", i-1, line,{color="2"})
+            else
+                set_stone("st-oxyd", i, line,{color="2"})
+                set_stone( "st-rock1", i-1, line)
+            end
+        elseif c == "*" then
+            set_stone( "st-brownie", i-1, line)
+        elseif c == "!" then
+            abyss(i-1,line)
+        elseif c == "~" then
+            set_floor("fl-water",i-1,line)
+        elseif c=="z" then
+            set_actor("ac-blackball", i-.5,line+.5, {player=0, essential=1})
+            set_item("it-yinyang",i-1,line)
+        elseif c=="y" then
+            if not difficult then
+                set_actor("ac-whiteball", i-1,line+.5, {player=1, essential=1})
+            else
+                set_actor("ac-whiteball", i-.5,line+.5, {player=1, essential=1})
+            end
+        elseif c=="C" then
+            set_item("it-crack3",i-1,line)
+            draw_stones("st-grate1",{i-1,line}, {1,1}, 1)
+        elseif c=="S" then
+            set_item("it-seed",i-1,line)
+        elseif c=="B" then
+            set_item("it-bag",i-1,line)
+        elseif c=="D" then
+            set_item("it-dynamite",i-1,line)
+        elseif c=="h" then
+            set_item("it-hollow",i-1,line)
+        elseif c == "g" then
+            draw_stones("st-grate1",{i-1,line}, {1,1}, 1)
+        elseif c == "G" then
+            if difficult==false then
+                --            draw_stones("st-grate1",{i-1,line}, {1,1}, 1)
+            else
+                draw_stones("st-grate1",{i-1,line}, {1,1}, 1)
+            end
+        elseif c == "H" then
+            set_stone("st-rock3_break",i-1,line)
+        elseif c == "$" then
+            set_stone("st-rock3",i-1,line)
+        elseif c=="+" then
+            set_stone( "st-wood", i-1, line)
+        elseif c=="=" then
+            set_floor("fl-space",i-1,line)
+        elseif c=="U" then
+            set_stone("st-oneway", i-1,line, {orientation=enigma.NORTH})    
+        elseif c=="R" then
+            set_stone("st-oneway", i-1,line, {orientation=enigma.EAST})    
+        elseif c=="D" then
+            set_stone("st-oneway", i-1,line, {orientation=enigma.SOUTH})    
+        elseif c=="L" then
+            set_stone("st-oneway", i-1,line, {orientation=enigma.WEST})
+        elseif c=="u" then
+            set_stone("st-oneway_black", i-1,line, {orientation=enigma.NORTH})
+        elseif c=="r" then
+            set_stone("st-oneway_black", i-1,line, {orientation=enigma.EAST})
+        elseif c=="d" then
+            set_stone("st-oneway_black", i-1,line, {orientation=enigma.SOUTH})
+        elseif c=="l" then
+            set_stone("st-oneway_black", i-1,line, {orientation=enigma.WEST})
+        elseif c=="w" then
+            set_stone("st-oneway_white", i-1,line, {orientation=enigma.WEST})
+        elseif c=="Z" then
+            yy1( "black",  i-1, line)
+        elseif c=="Y" then
+            yy1( "white",  i-1, line)
+            if not difficult then
+                set_item("it-yinyang",i-1,line)
+            end
+        elseif c=="q" then
+            yy1( "white",  i-1, line)
+        end
+    end    
+end
+
+function yy1( color, x, y)
+    stone = format( "st-%s4", color)
+    set_stone( stone, x, y)
+end
+
+renderLine(00,"####################")
+renderLine(01,"###    ######   SZO#")
+renderLine(02,"#Dw    lCCCCl   SZZ#")
+renderLine(03,"### qqq######    ZZ#")
+renderLine(04,"#O  qhH######Hh  ZP#")
+renderLine(05,"#P  qhH~~~~~ZHh  ZZ#")
+renderLine(06,"#. yqhH~~~~~ZHhBzSYQ")
+renderLine(07,"#`  qhH~~~~~ZHh  ZZ#")
+renderLine(08,"#^  qhH######Hh  Z`#")
+renderLine(09,"### qqq######    ZZ#")
+renderLine(10,"#Dl    rCCCCr   SZZ#")
+renderLine(11,"###    ######   SZ^#")
+renderLine(12,"####################")
+    ]]></el:luamain>
+    <el:i18n>
+      <el:string el:key="title">
+        <el:english el:translate="false"/>
+      </el:string>
+    </el:i18n>
+  </el:protected>
+</el:level>

Deleted: branches/1.0/data/levels/enigma_v/duffy133_1.xml
===================================================================
--- branches/1.0/data/levels/enigma_v/duffy133_1.xml	2007-04-06 20:58:39 UTC (rev 684)
+++ branches/1.0/data/levels/enigma_v/duffy133_1.xml	2007-04-06 23:05:52 UTC (rev 685)
@@ -1,124 +0,0 @@
-<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
-<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
-  <el:protected>
-    <el:info el:type="level">
-      <el:identity el:title="Humid Maze" el:subtitle="" el:id="duffy133"/>
-      <el:version el:score="1" el:release="1" el:revision="1" el:status="released"/>
-      <el:author  el:name="Jacob Scott" el:email="" el:homepage=""/>
-      <el:copyright>Copyright ? 2005 Jacob Scott</el:copyright>
-      <el:license el:type="GPL v2.0 or above" el:open="true"/>
-      <el:compatibility el:enigma="0.92">
-      </el:compatibility>
-      <el:modes el:easy="true" el:single="true" el:network="false"/>
-      <el:comments>
-        <el:code>Lua 5.1 and XML converted by Leveladministrators</el:code>
-      </el:comments>
-      <el:score el:easy="-" el:difficult="-"/>
-    </el:info>
-    <el:luamain><![CDATA[
-rooms_wide=4
-rooms_high=3
-
-levelw=1+(19*rooms_wide)
-levelh=1+(12*rooms_high)
-
-create_world( levelw, levelh)
-enigma.WaterSinkSpeed=0.15
-enigma.SwampSinkSpeed=0.5
-
-fill_floor("fl-hay", 0,0,levelw,levelh)
-
-function renderLine( line, pattern)
-    for i=1, strlen(pattern) do
-        local c = strsub( pattern, i, i)
-        if c =="#" then
-            set_stone("st-invisible",i-1,line)
-            abyss(i-1,line)
-        elseif c == "o" then
-            oxyd( i-1, line)
-            set_floor("fl-water",i-1,line)
-        elseif c == "*" then
-            set_stone( "st-brownie", i-1, line)
-        elseif c == "!" then
-            abyss(i-1,line)
-        elseif c == " " then
-            abyss(i-1,line)
-        elseif c == "~" then
-            set_floor("fl-water",i-1,line)
-        elseif c == "S" then
-            set_floor("fl-swamp",i-1,line)
-        elseif c=="z" then
-            set_actor("ac-blackball", i-.5,line+.5, {player=0})
-            set_floor("fl-swamp",i-1,line)
-        elseif c == "g" then
-            draw_stones("st-grate1",{i-1,line}, {1,1}, 1)
-        elseif c=="+" then
-            set_stone( "st-wood", i-1, line)
-        elseif c=="=" then
-            set_floor("fl-space",i-1,line)
-        elseif c == "F" then
-            set_item("it-flagblack",i-1,line)
-            set_floor("fl-swamp",i-1,line)
-        elseif c == "s" then
-            if not difficult then
-                set_item("it-seed",i-1,line)
-            end
-            set_floor("fl-swamp",i-1,line)
-        elseif c == "O" then
-            if not difficult then
-                set_item("it-extralife",i-1,line)
-            end
-            set_floor("fl-swamp",i-1,line)
-        end
-    end    
-end
-
-renderLine(00,"#############################################################################")
-renderLine(01,"#                                                                           #")
-renderLine(02,"# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~    ~~~~~   ~~~~ #")
-renderLine(03,"#           ~                ~                ~           ~   SSS  ~~~~~  ~ #")
-renderLine(04,"# ~~~~~~~~  ~  ~~~~~~~~~~~~  ~~~~~~~~~~~~ ~~~ ~ ~~~~~~~   ~  SSSS         ~ #")
-renderLine(05,"# ~      ~~~~  ~          ~  ~          ~ ~   ~ ~     ~   ~ SSSSS ~~~ ~~~~~ #")
-renderLine(06,"# ~  SSS       ~   ~~~~~~ ~ SS ~~~~~~~~ ~ ~~~~~ ~ ~~~ ~   ~ SSSSS ~   ~     #")
-renderLine(07,"# ~ SSSSS~~~~~~~   ~    ~ ~ SS ~      ~ ~ ~     ~ ~ ~ ~   ~     ~ ~ ~ ~ ~ ~ #")
-renderLine(08,"# ~ SSSS       ~   ~    ~ ~ SS ~  ~~~ ~ ~ ~ ~~~~~ ~ ~ ~   ~ ~~~ ~ ~ ~ ~ ~ ~ #")
-renderLine(09,"# ~ SSSS ~~~~~ ~   ~ ~~~~ ~ SS ~  ~ ~ ~ ~ ~ ~     ~ ~ ~   ~~~ ~ ~ ~ ~ ~ ~ ~ #")
-renderLine(10,"# ~      ~   ~ ~   ~ ~    ~    ~  ~ ~ ~ ~ ~ ~~~~~ ~ ~ ~       ~ ~ ~ ~ ~ ~ ~ #")
-renderLine(11,"# ~~~~~~~~ ~ ~ ~   ~ ~ ~~~~~~~~~  ~ ~ ~ ~ ~       ~ ~ ~   ~~~ ~ ~ ~ ~ ~ ~ ~ #")
-renderLine(12,"# ~        ~ ~ ~   ~ ~ ~       ~  ~ ~ ~ ~ ~~~~~~~~~ ~ ~   ~ ~~~ ~ ~ ~ ~ ~ ~ #")
-renderLine(13,"# ~~~~~~~~~~ ~ ~~~~~ ~ ~ ~~~~~ ~  ~   ~ ~    ~    ~ ~ ~   ~     ~ ~ ~ ~ ~ ~ #")
-renderLine(14,"#            ~     ~ ~ ~ ~   ~ ~~ ~ ~~~ ~   ~~  ~ ~ ~ ~~~~~~~~~~~~~ ~ ~ ~ ~ #")
-renderLine(15,"# SS~~~~~~~~ ~~~~~ ~ ~ ~ ~~~ ~  ~ ~     ~   ~   ~ ~ ~               ~ ~ ~ ~ #")
-renderLine(16,"# SSS      ~ ~   ~ ~ ~ ~   ~ ~  ~ ~~~~~~~~  ~~  ~ ~ ~~~~~~~~~ ~~~~~~~ ~ ~ ~ #")
-renderLine(17,"# SSSS ~~~ ~ ~~~ ~ ~ ~ ~ ~~~ ~ ~~        ~~  ~  ~ ~           ~       ~ ~ ~ #")
-renderLine(18,"# SSSS ~ ~ ~ ~ ~ ~   ~ ~ ~   ~ ~    SSOS  ~~ ~~~~ ~~~~~~~~~~~ ~       ~ ~ ~ #")
-renderLine(19,"#  SSS ~ ~ ~ ~ ~ ~~~ ~ ~ ~~~ ~ ~~~~~SSSFS  ~            ~   ~ ~ ~~~~~~~ ~ ~ #")
-renderLine(20,"#    ~~~ ~ ~ ~ ~   ~ ~ ~   ~ ~      SSSSzS ~ ~~~~~~~~~~~~ ~~~ ~ ~       ~ ~ #")
-renderLine(21,"#        ~ ~ ~ ~~~ ~ ~ ~ ~~~ ~ ~~~~  SsSSS ~ ~ooo~            ~ ~ ~~~~~~~ ~ #")
-renderLine(22,"# ~~~~~~~~ ~ ~   ~ ~ ~ ~ ~   ~    ~     ~  ~ ~ooo~ ~~~~~~~~~~~~ ~ ~ ~ ~ ~ ~ #")
-renderLine(23,"# ~      ~ ~ ~~~ ~ ~ ~ ~ ~~~ ~~~~~~~~~~~~  ~ ~~~~~ ~            ~ ~ ~ ~ ~ ~ #")
-renderLine(24,"# ~~~~~~ ~ ~ ~ ~ ~ ~ ~     ~               ~       ~   ~~~~~~~~ ~ ~ ~ ~ ~ ~ #")
-renderLine(25,"# ~      ~ ~ ~ ~ ~ ~ ~~~~~ ~   ~~~~~~~~~~~~~~~~~~~~~   ~      ~ ~ ~ ~ ~ ~ ~ #")
-renderLine(26,"# ~ ~~~~~~ ~ ~ ~ ~ ~     ~     ~                       ~  SSS ~ ~ ~ ~ ~ ~ ~ #")
-renderLine(27,"# ~        ~ ~ ~ ~ ~ ~ SSSSSSS ~   ~~~~~~~~~~~~~~~~~~  ~ SSSS ~ ~ ~ ~ ~ ~ ~ #")
-renderLine(28,"# ~~~~~~~~ ~ ~ ~ ~ ~ ~ SSSSSSS ~~~~~                ~  ~ SSSS ~ ~ ~ ~ ~ ~~~ #")
-renderLine(29,"#        ~ ~ ~ ~ ~ ~ ~  SSS            ~~~~~~~~~~~  ~  ~ SSSS ~ ~ ~ ~     ~ #")
-renderLine(30,"# ~~~~~~~~ ~     ~   ~    ~~~~~~~~~~~~~~         ~~~~  ~   ~  ~ ~ ~ ~~~~~ ~ #")
-renderLine(31,"# ~        ~~~~~~~~~~~              ~    ~~~~~~~       ~   ~  ~ ~       ~ ~ #")
-renderLine(32,"# ~~~~~~~~                 ~~~~~~~  ~~~~~~     ~~~~~~~~~   ~  ~ ~~~~~~~~~ ~ #")
-renderLine(33,"# ~        ~~~   ~~~~~     ~     ~         ~~~             ~              ~ #")
-renderLine(34,"# ~~~~~~~~~~ ~~~~~   ~~~~~~~     ~~~~~~~~~~~ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #")
-renderLine(35,"#                                                                           #")
-renderLine(36,"#############################################################################")
-
-oxyd_shuffle()
-
-display.SetFollowMode(display.FOLLOW_SCROLLING)
-    ]]></el:luamain>
-    <el:i18n>
-      <el:string el:key="title">
-        <el:english el:translate="false"/>
-      </el:string>
-    </el:i18n>
-  </el:protected>
-</el:level>

Copied: branches/1.0/data/levels/enigma_v/duffy133_2.xml (from rev 683, branches/1.0/data/levels/enigma_v/duffy133_1.xml)
===================================================================
--- branches/1.0/data/levels/enigma_v/duffy133_1.xml	2007-04-06 11:47:23 UTC (rev 683)
+++ branches/1.0/data/levels/enigma_v/duffy133_2.xml	2007-04-06 23:05:52 UTC (rev 685)
@@ -0,0 +1,124 @@
+<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
+<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
+  <el:protected>
+    <el:info el:type="level">
+      <el:identity el:title="Humid Maze" el:subtitle="" el:id="duffy133"/>
+      <el:version el:score="2" el:release="2" el:revision="2" el:status="released"/>
+      <el:author  el:name="Jacob Scott" el:email="" el:homepage=""/>
+      <el:copyright>Copyright ? 2005 Jacob Scott</el:copyright>
+      <el:license el:type="GPL v2.0 or above" el:open="true"/>
+      <el:compatibility el:enigma="0.92">
+      </el:compatibility>
+      <el:modes el:easy="true" el:single="true" el:network="false"/>
+      <el:comments>
+        <el:code>Lua 5.1 and XML converted by Leveladministrators</el:code>
+      </el:comments>
+      <el:score el:easy="-" el:difficult="-"/>
+    </el:info>
+    <el:luamain><![CDATA[
+rooms_wide=4
+rooms_high=3
+
+levelw=1+(19*rooms_wide)
+levelh=1+(12*rooms_high)
+
+create_world( levelw, levelh)
+enigma.WaterSinkSpeed=0.15
+enigma.SwampSinkSpeed=0.5
+
+fill_floor("fl-hay", 0,0,levelw,levelh)
+
+function renderLine( line, pattern)
+    for i=1, strlen(pattern) do
+        local c = strsub( pattern, i, i)
+        if c =="#" then
+            set_stone("st-invisible",i-1,line)
+            abyss(i-1,line)
+        elseif c == "o" then
+            oxyd( i-1, line)
+            set_floor("fl-water",i-1,line)
+        elseif c == "*" then
+            set_stone( "st-brownie", i-1, line)
+        elseif c == "!" then
+            abyss(i-1,line)
+        elseif c == " " then
+            abyss(i-1,line)
+        elseif c == "~" then
+            set_floor("fl-water",i-1,line)
+        elseif c == "S" then
+            set_floor("fl-swamp",i-1,line)
+        elseif c=="z" then
+            set_actor("ac-blackball", i-.5,line+.5, {player=0})
+            set_floor("fl-swamp",i-1,line)
+        elseif c == "g" then
+            draw_stones("st-grate1",{i-1,line}, {1,1}, 1)
+        elseif c=="+" then
+            set_stone( "st-wood", i-1, line)
+        elseif c=="=" then
+            set_floor("fl-space",i-1,line)
+        elseif c == "F" then
+            set_item("it-flagblack",i-1,line)
+            set_floor("fl-swamp",i-1,line)
+        elseif c == "s" then
+            if not difficult then
+                set_item("it-seed",i-1,line)
+            end
+            set_floor("fl-swamp",i-1,line)
+        elseif c == "O" then
+            if not difficult then
+                set_item("it-extralife",i-1,line)
+            end
+            set_floor("fl-swamp",i-1,line)
+        end
+    end    
+end
+
+renderLine(00,"#############################################################################")
+renderLine(01,"#                                                                           #")
+renderLine(02,"# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~    ~~~~~   ~~~~ #")
+renderLine(03,"#           ~                ~                ~           ~   SSS  ~~~~~  ~ #")
+renderLine(04,"# ~~~~~~~~  ~  ~~~~~~~~~~~~  ~~~~~~~~~~~~ ~~~ ~ ~~~~~~~   ~  SSSS         ~ #")
+renderLine(05,"# ~      ~~~~  ~          ~  ~          ~ ~   ~ ~     ~   ~ SSSSS ~~~ ~~~~~ #")
+renderLine(06,"# ~  SSS       ~   ~~~~~~ ~ SS ~~~~~~~~ ~ ~~~~~ ~ ~~~ ~   ~ SSSSS ~   ~     #")
+renderLine(07,"# ~ SSSSS~~~~~~~   ~    ~ ~ SS ~      ~ ~ ~     ~ ~ ~ ~   ~     ~ ~ ~ ~ ~ ~ #")
+renderLine(08,"# ~ SSSS       ~   ~    ~ ~ SS ~  ~~~ ~ ~ ~ ~~~~~ ~ ~ ~   ~ ~~~ ~ ~ ~ ~ ~ ~ #")
+renderLine(09,"# ~ SSSS ~~~~~ ~   ~ ~~~~ ~ SS ~  ~ ~ ~ ~ ~ ~     ~ ~ ~   ~~~ ~ ~ ~ ~ ~ ~ ~ #")
+renderLine(10,"# ~      ~   ~ ~   ~ ~    ~    ~  ~ ~ ~ ~ ~ ~~~~~ ~ ~ ~       ~ ~ ~ ~ ~ ~ ~ #")
+renderLine(11,"# ~~~~~~~~ ~ ~ ~   ~ ~ ~~~~~~~~~  ~ ~ ~ ~ ~       ~ ~ ~   ~~~ ~ ~ ~ ~ ~ ~ ~ #")
+renderLine(12,"# ~        ~ ~ ~   ~ ~ ~       ~  ~ ~ ~ ~ ~~~~~~~~~ ~ ~   ~ ~~~ ~ ~ ~ ~ ~ ~ #")
+renderLine(13,"# ~~~~~~~~~~ ~ ~~~~~ ~ ~ ~~~~~ ~  ~   ~ ~    ~    ~ ~ ~   ~     ~ ~ ~ ~ ~ ~ #")
+renderLine(14,"#            ~     ~ ~ ~ ~   ~ ~~ ~ ~~~ ~   ~~  ~ ~ ~ ~~~~~~~~~~~~~ ~ ~ ~ ~ #")
+renderLine(15,"# SS~~~~~~~~ ~~~~~ ~ ~ ~ ~~~ ~  ~ ~     ~   ~   ~ ~ ~               ~ ~ ~ ~ #")
+renderLine(16,"# SSS      ~ ~   ~ ~ ~ ~   ~ ~  ~ ~~~~~~~~  ~~  ~ ~ ~~~~~~~~~ ~~~~~~~ ~ ~ ~ #")
+renderLine(17,"# SSSS ~~~ ~ ~~~ ~ ~ ~ ~ ~~~ ~ ~~        ~~  ~  ~ ~           ~       ~ ~ ~ #")
+renderLine(18,"# SSSS ~ ~ ~ ~ ~ ~   ~ ~ ~   ~ ~    SSOS  ~~ ~~~~ ~~~~~~~~~~~ ~       ~ ~ ~ #")
+renderLine(19,"#  SSS ~ ~ ~ ~ ~ ~~~ ~ ~ ~~~ ~ ~~~~~SSSFS  ~            ~   ~ ~ ~~~~~~~ ~ ~ #")
+renderLine(20,"#    ~~~ ~ ~ ~ ~   ~ ~ ~   ~ ~      SSSSzS ~ ~~~~~~~~~~~~ ~~~ ~ ~       ~ ~ #")
+renderLine(21,"#        ~ ~ ~ ~~~ ~ ~ ~ ~~~ ~ ~~~~  SsSSS ~ ~ooo~            ~ ~ ~~~~~~~ ~ #")
+renderLine(22,"# ~~~~~~~~ ~ ~   ~ ~ ~ ~ ~   ~    ~     ~  ~ ~ooo~ ~~~~~~~~~~~~ ~ ~ ~ ~ ~ ~ #")
+renderLine(23,"# ~      ~ ~ ~~~ ~ ~ ~ ~ ~~~ ~~~~~~~~~~~~  ~ ~~~~~ ~            ~ ~ ~ ~ ~ ~ #")
+renderLine(24,"# ~~~~~~ ~ ~ ~ ~ ~ ~ ~     ~               ~       ~   ~~~~~~~~ ~ ~ ~ ~ ~ ~ #")
+renderLine(25,"# ~      ~ ~ ~ ~ ~ ~ ~~~~~ ~   ~~~~~~~~~~~~~~~~~~~~~   ~      ~ ~ ~ ~ ~ ~ ~ #")
+renderLine(26,"# ~ ~~~~~~ ~ ~ ~ ~ ~     ~     ~                       ~  SSS ~ ~ ~ ~ ~ ~ ~ #")
+renderLine(27,"# ~        ~ ~ ~ ~ ~ ~ SSSSSSS ~   ~~~~~~~~~~~~~~~~~~  ~ SSSS ~ ~ ~ ~ ~ ~ ~ #")
+renderLine(28,"# ~~~~~~~~ ~ ~ ~ ~ ~ ~ SSSSSSS ~~~~~                ~  ~ SSSS ~ ~ ~ ~ ~ ~~~ #")
+renderLine(29,"#        ~ ~ ~ ~ ~ ~ ~  SSS            ~~~~~~~~~~~  ~  ~ SSSS ~ ~ ~ ~     ~ #")
+renderLine(30,"# ~~~~~~~~ ~     ~   ~    ~~~~~~~~~~~~~~         ~~~~  ~   ~  ~ ~ ~ ~~~~~ ~ #")
+renderLine(31,"# ~        ~~~~~~~~~~~              ~    ~~~~~~~       ~   ~  ~ ~       ~ ~ #")
+renderLine(32,"# ~~~~~~~~                 ~~~~~~~  ~~~~~~     ~~~~~~~~~   ~  ~ ~~~~~~~~~ ~ #")
+renderLine(33,"# ~        ~~~   ~~~~~     ~     ~         ~~~             ~              ~ #")
+renderLine(34,"# ~~~~~~~~~~ ~~~~~   ~~~~~~~     ~~~~~~~~~~~ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #")
+renderLine(35,"#                                                                           #")
+renderLine(36,"#############################################################################")
+
+oxyd_shuffle()
+
+display.SetFollowMode(display.FOLLOW_SCROLLING)
+    ]]></el:luamain>
+    <el:i18n>
+      <el:string el:key="title">
+        <el:english el:translate="false"/>
+      </el:string>
+    </el:i18n>
+  </el:protected>
+</el:level>

Modified: branches/1.0/data/levels/enigma_v/index.xml
===================================================================
--- branches/1.0/data/levels/enigma_v/index.xml	2007-04-06 20:58:39 UTC (rev 684)
+++ branches/1.0/data/levels/enigma_v/index.xml	2007-04-06 23:05:52 UTC (rev 685)
@@ -26,7 +26,7 @@
     <level _seq="18" _title="Double play" _xpath="./just06_1" author="JuSt" ctrl="force" easy="false" id="just06" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="19" _title="Oxyd-Puzzle" _xpath="./raoul05_1" author="Raoul Bourquin" ctrl="force" easy="false" id="raoul05" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="20" _title="- Meditation -" _xpath="./ralf12_1" author="Ralf Westram" ctrl="force" easy="true" id="ralf12" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="21" _title="Plan Ahead" _xpath="./duffy114_1" author="Jacob Scott" ctrl="force" easy="true" id="duffy114" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="21" _title="Plan Ahead" _xpath="./duffy114_2" author="Jacob Scott" ctrl="force" easy="true" id="duffy114" rel="2" rev="2" score="2" target="time" unit="duration"/>
     <level _seq="22" _title="Keystone" _xpath="./raoul12_1" author="Raoul Bourquin" ctrl="force" easy="true" id="raoul12" rel="1" rev="2" score="1" target="time" unit="duration"/>
     <level _seq="23" _title="Print 23" _xpath="./richi07_1" author="Richi B?tzer" ctrl="force" easy="false" id="richi07" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="24" _title="Space Pirates" _xpath="./siegfried19_2" author="Siegfried Fennig" ctrl="force" easy="false" id="level6a" rel="2" rev="0" score="2" target="time" unit="duration"/>
@@ -48,7 +48,7 @@
     <level _seq="40" _title="- Meditation -" _xpath="./raoul02_1" author="Raoul Bourquin" ctrl="force" easy="true" id="raoul02" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="41" _title="Clear the Path" _xpath="./duffy110_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy110" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="42" _title="Choo-Choo" _xpath="./duffy22_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy22" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="43" _title="Humid Maze" _xpath="./duffy133_1" author="Jacob Scott" ctrl="force" easy="true" id="duffy133" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="43" _title="Humid Maze" _xpath="./duffy133_2" author="Jacob Scott" ctrl="force" easy="true" id="duffy133" rel="2" rev="2" score="2" target="time" unit="duration"/>
     <level _seq="44" _title="Turnstile City" _xpath="./duffy39_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy39" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="45" _title="Psycho Pushing" _xpath="./ss03_1" author="Sven Siggelkow" ctrl="force" easy="true" id="ss3" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="46" _title="Turnstile Maze" _xpath="./duffy53_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy53" rel="1" rev="0" score="1" target="time" unit="duration"/>
@@ -61,7 +61,7 @@
     <level _seq="53" _title="A bayou by you" _xpath="./alain21_1" author="Alain Busser" ctrl="force" easy="false" id="alain21" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="54" _title="Mirror Shop" _xpath="./siegfried25_1" author="Siegfried Fennig" ctrl="force" easy="false" id="level9a" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="55" _title="Blet" _xpath="./alain24_1" author="Alain Busser" ctrl="force" easy="true" id="alain24" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="56" _title="Banana Republic" _xpath="./alain26_1" author="Alain Busser" ctrl="force" easy="true" id="alain26" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="56" _title="Banana Republic" _xpath="./alain26_2" author="Alain Busser" ctrl="force" easy="true" id="alain26" rel="2" rev="2" score="2" target="time" unit="duration"/>
     <level _seq="57" _title="Too Heavy?" _xpath="./martin101_1" author="Martin Hawlisch" ctrl="force" easy="true" id="martin101" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="58" _title="Now What?" _xpath="./duffy127_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy127" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="59" _title="Pneumatic Delivery" _xpath="./malla01_2" author="Manuel K?nig" ctrl="force" easy="true" id="malla01" rel="2" rev="2" score="2" target="time" unit="duration"/>
@@ -77,7 +77,7 @@
     <level _seq="69" _title="Gods of Enigma II" _xpath="./mp02_1" author="moonpearl" ctrl="force" easy="false" id="mp02" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="70" _title="- Meditation -" _xpath="./alain14_1" author="Alain Busser" ctrl="force" easy="false" id="alain14" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="71" _title="Frogger" _xpath="./luc20_1" author="Lukas Sch?ller" ctrl="force" easy="false" id="luc20" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="72" _title="Fatal Attraction I" _xpath="./spaceman01_1" author="Spaceman" ctrl="force" easy="true" id="spaceman1" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="72" _title="Fatal Attraction I" _xpath="./spaceman01_2" author="Spaceman" ctrl="force" easy="true" id="spaceman1" rel="2" rev="2" score="2" target="time" unit="duration"/>
     <level _seq="73" _title="Acoustic Memory" _xpath="./andreas25_2" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas25" rel="2" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="74" _title="Fatal Attraction II" _xpath="./spaceman02_1" author="Spaceman" ctrl="force" easy="false" id="spaceman2" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="75" _title="Stranded" _xpath="./duffy51_2" author="Jacob Scott" ctrl="force" easy="false" id="duffy51" rel="2" rev="3" score="2" target="time" unit="duration"/>

Deleted: branches/1.0/data/levels/enigma_v/spaceman01_1.xml
===================================================================
--- branches/1.0/data/levels/enigma_v/spaceman01_1.xml	2007-04-06 20:58:39 UTC (rev 684)
+++ branches/1.0/data/levels/enigma_v/spaceman01_1.xml	2007-04-06 23:05:52 UTC (rev 685)
@@ -1,95 +0,0 @@
-<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
-<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
-  <el:protected>
-    <el:info el:type="level">
-      <el:identity el:title="Fatal Attraction I" el:subtitle="" el:id="spaceman1"/>
-      <el:version el:score="1" el:release="1" el:revision="1" el:status="released"/>
-      <el:author  el:name="Spaceman" el:email="" el:homepage=""/>
-      <el:copyright>Copyright ? 2006 Spaceman</el:copyright>
-      <el:license el:type="GPL v2.0 or above" el:open="true"/>
-      <el:compatibility el:enigma="0.92">
-       <el:dependency el:path="lib/ant" el:id="lib/ant" el:release="1" el:preload="true"/>
-      </el:compatibility>
-      <el:modes el:easy="true" el:single="true" el:network="false"/>
-      <el:comments>
-        <el:code>Lua 5.1 and XML converted by Leveladministrators</el:code>
-      </el:comments>
-      <el:score el:easy="-" el:difficult="-"/>
-    </el:info>
-    <el:luamain><![CDATA[
--- Levelcode cleaned by raoul 3.2006
--- !!BBE105!! Do not delete this line
-
-function file_oxyd(x,y,f)
-    oxyd_default_flavor=f
-    oxyd(x,y)
-end
-
-levelh=13
-levelw=20
-
-cells={}
-stones={}
-
-stones[" "]=cell{}
-cells[" "]=cell{}
-
-cells["!"]=cell{floor="fl-normal"}
-
-if difficult then
-    stones["!"]=cell{stone="st-fart"}
-else
-    stones["!"]=cell{stone="st-likeoxydb"}
-end
-stones["#"]=cell{parent={{file_oxyd,"b"}}}
-
-level={"!!!!!!!!!!!!!!!!!!!!",
-       "!!!!!!!!!!!!!!!!!!!!",
-       "!!!!!!!!!!!!!!!!!!!!",
-       "!!!!!!!!!!!!!!!!!!!!",
-       "!!!!!!!!!!!!!!!!!!!!",
-       "!!!!!!!!!!!!!!!!!!!!",
-       "!!!!!!!!!!!!!!!!!!!!",
-       "!!!!!!!!!!!!!!!!!!!!",
-       "!!!!!!!!!!!!!!!!!!!!",
-       "!!!!!!!!!!!!!!!!!!!!",
-       "!!!!!!!!!!!!!!!!!!!!",
-       "!!!!!!!!!!!!!!!!!!!!",
-       "!!!!!!!!!!!!!!!!!!!!"}
-stmap={"!!!!!!!!!!!!!!!!!!!!",
-       "!                  !",
-       "!                  !",
-       "!                  !",
-       "!       #  #       !",
-       "!      #    #      !",
-       "!     #      #     !",
-       "!    #        #    !",
-       "!   #          #   !",
-       "!  #            #  !",
-       "! #              # !",
-       "!#                #!",
-       "!!!!!!!!!!!!!!!!!!!!"}
-
-create_world_by_map(level)
-draw_map(0,0,stmap,stones)
-
-set_actor("ac-blackball",10.5,1.5,{player=0,name="bb"})
-set_actor("ac-rotor",4.5,11.5,{range=20,force=20,name="rot1",gohome=TRUE})
-set_actor("ac-rotor",15.5,11.5,{range=20,force=20,name="rot2",gohome=TRUE})
-
-AddRubberBand(enigma.GetNamedObject("bb"),enigma.GetNamedObject("rot1"),10,100)
-AddRubberBand(enigma.GetNamedObject("bb"),enigma.GetNamedObject("rot2"),10,100)
-
-set_item("it-document",10,1,{text="text1"})
-oxyd_shuffle()
-    ]]></el:luamain>
-    <el:i18n>
-      <el:string el:key="title">
-        <el:english el:translate="false"/>
-      </el:string>
-      <el:string el:key="text1">
-        <el:english el:translate="true">Don't get too attracted!</el:english>
-      </el:string> 
-    </el:i18n>
-  </el:protected>
-</el:level>

Copied: branches/1.0/data/levels/enigma_v/spaceman01_2.xml (from rev 683, branches/1.0/data/levels/enigma_v/spaceman01_1.xml)
===================================================================
--- branches/1.0/data/levels/enigma_v/spaceman01_1.xml	2007-04-06 11:47:23 UTC (rev 683)
+++ branches/1.0/data/levels/enigma_v/spaceman01_2.xml	2007-04-06 23:05:52 UTC (rev 685)
@@ -0,0 +1,95 @@
+<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
+<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
+  <el:protected>
+    <el:info el:type="level">
+      <el:identity el:title="Fatal Attraction I" el:subtitle="" el:id="spaceman1"/>
+      <el:version el:score="2" el:release="2" el:revision="2" el:status="released"/>
+      <el:author  el:name="Spaceman" el:email="" el:homepage=""/>
+      <el:copyright>Copyright ? 2006 Spaceman</el:copyright>
+      <el:license el:type="GPL v2.0 or above" el:open="true"/>
+      <el:compatibility el:enigma="0.92">
+       <el:dependency el:path="lib/ant" el:id="lib/ant" el:release="1" el:preload="true"/>
+      </el:compatibility>
+      <el:modes el:easy="true" el:single="true" el:network="false"/>
+      <el:comments>
+        <el:code>Lua 5.1 and XML converted by Leveladministrators</el:code>
+      </el:comments>
+      <el:score el:easy="-" el:difficult="-"/>
+    </el:info>
+    <el:luamain><![CDATA[
+-- Levelcode cleaned by raoul 3.2006
+-- !!BBE105!! Do not delete this line
+
+function file_oxyd(x,y,f)
+    oxyd_default_flavor=f
+    oxyd(x,y)
+end
+
+levelh=13
+levelw=20
+
+cells={}
+stones={}
+
+stones[" "]=cell{}
+cells[" "]=cell{}
+
+cells["!"]=cell{floor="fl-normal"}
+
+if difficult then
+    stones["!"]=cell{stone="st-fart"}
+else
+    stones["!"]=cell{stone="st-likeoxydb"}
+end
+stones["#"]=cell{parent={{file_oxyd,"b"}}}
+
+level={"!!!!!!!!!!!!!!!!!!!!",
+       "!!!!!!!!!!!!!!!!!!!!",
+       "!!!!!!!!!!!!!!!!!!!!",
+       "!!!!!!!!!!!!!!!!!!!!",
+       "!!!!!!!!!!!!!!!!!!!!",
+       "!!!!!!!!!!!!!!!!!!!!",
+       "!!!!!!!!!!!!!!!!!!!!",
+       "!!!!!!!!!!!!!!!!!!!!",
+       "!!!!!!!!!!!!!!!!!!!!",
+       "!!!!!!!!!!!!!!!!!!!!",
+       "!!!!!!!!!!!!!!!!!!!!",
+       "!!!!!!!!!!!!!!!!!!!!",
+       "!!!!!!!!!!!!!!!!!!!!"}
+stmap={"!!!!!!!!!!!!!!!!!!!!",
+       "!                  !",
+       "!                  !",
+       "!                  !",
+       "!       #  #       !",
+       "!      #    #      !",
+       "!     #      #     !",
+       "!    #        #    !",
+       "!   #          #   !",
+       "!  #            #  !",
+       "! #              # !",
+       "!#                #!",
+       "!!!!!!!!!!!!!!!!!!!!"}
+
+create_world_by_map(level)
+draw_map(0,0,stmap,stones)
+
+set_actor("ac-blackball",10.5,1.5,{player=0,name="bb"})
+set_actor("ac-rotor",4.5,11.5,{range=20,force=20,name="rot1",gohome=TRUE})
+set_actor("ac-rotor",15.5,11.5,{range=20,force=20,name="rot2",gohome=TRUE})
+
+AddRubberBand(enigma.GetNamedObject("bb"),enigma.GetNamedObject("rot1"),10,100)
+AddRubberBand(enigma.GetNamedObject("bb"),enigma.GetNamedObject("rot2"),10,100)
+
+set_item("it-document",10,1,{text="text1"})
+oxyd_shuffle()
+    ]]></el:luamain>
+    <el:i18n>
+      <el:string el:key="title">
+        <el:english el:translate="false"/>
+      </el:string>
+      <el:string el:key="text1">
+        <el:english el:translate="true">Don't get too attracted!</el:english>
+      </el:string> 
+    </el:i18n>
+  </el:protected>
+</el:level>

Deleted: branches/1.0/data/levels/enigma_vi/alain25_1.xml
===================================================================
--- branches/1.0/data/levels/enigma_vi/alain25_1.xml	2007-04-06 20:58:39 UTC (rev 684)
+++ branches/1.0/data/levels/enigma_vi/alain25_1.xml	2007-04-06 23:05:52 UTC (rev 685)
@@ -1,148 +0,0 @@
-<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
-<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
-  <el:protected>
-    <el:info el:type="level">
-      <el:identity el:title="- Meditation -" el:subtitle="Pauli" el:id="alain25"/>
-      <el:version el:score="1" el:release="1" el:revision="1" el:status="released"/>
-      <el:author  el:name="Alain Busser + Raoul Bourquin" el:email="" el:homepage=""/>
-      <el:copyright>Copyright ? 2006 Alain Busser + Raoul Bourquin</el:copyright>
-      <el:license el:type="GPL v2.0 or above" el:open="true"/>
-      <el:compatibility el:enigma="0.92">
-      </el:compatibility>
-      <el:modes el:easy="true" el:single="true" el:network="false"/>
-      <el:comments>
-        <el:code>Lua 5.1 and XML converted by Leveladministrators</el:code>
-      </el:comments>
-      <el:score el:easy="-" el:difficult="1:54"/>
-    </el:info>
-    <el:luamain><![CDATA[
-levelw = 20
-levelh = 13
-
-nhol=8
-
-create_world(levelw, levelh)
-oxyd_default_flavor = "a"
-display.SetFollowMode(display.FOLLOW_SCROLLING)
-fill_floor("fl-leaves", 0,0, level_width,level_height)
-draw_border("st-rock1")
-
-function renderLine( line, pattern)
-    for i=1, strlen(pattern) do
-        local c = strsub( pattern, i, i)
-        if c =="#" then
-            set_item("it-hollow", i-1, line)
-        elseif c=="*" then
-            set_item("it-trigger",i-1,line,{invisible=1,action="callback",target="mix"})
-            --set_floor("fl-leavesb",i-1,line)
-            circle(i-1,line)
-        elseif c=="z" then
-            set_actor("ac-whiteball-small", i-.5,line+.5, {player=0})
-        end
-    end    
-end
-
-function mix()
-    for i=0,3 do
-        for j=0,2 do
-            for k=0,3 do
-                enigma.KillItem(5*i+j+1,k+1)
-                enigma.KillItem(5*i+j+1,k+8)
-            end
-        end
-    end
-    spade()
-end
-
-function spade()
-    holi[1]=random(4)-1
-    holj[1]=random(3)-1
-    holk[1]=random(4)-1
-    holl[1]=random(2)-1
-    for n=2,nhol do
-        repeat
-            ii=random(4)-1
-            jj=random(3)-1
-            kk=random(4)-1
-            ll=random(2)-1
-            vazy=1
-            m = 0
-            for p=1,n do
-                if holi[p]==ii and holj[p]==jj and holk[p]==kk and holl[p]==ll then
-                    vazy=0
-                end
-                if vazy==0 then
-                    m=m+1
-                end
-            end
-        until m == 0
-        holi[n]=ii
-        holj[n]=jj
-        holk[n]=kk
-        holl[n]=ll
-    end
-    for n=1,nhol do
-        set_item("it-hollow",5*holi[n]+holj[n]+1,holk[n]+7*holl[n]+1)
-    end
-end
-
---draw the green circles:
-function circle(x,y)
-    t=random(1,4)
-    if t==1 then
-        xk=x
-        yk=y
-    elseif t==2 then
-        xk=x-1
-        yk=y
-    elseif t==3 then
-        xk=x-1
-        yk=y-1
-    elseif t==4 then
-        xk=x
-        yk=y-1
-    end
- 
-    if difficult then
-        set_floor("fl-leavesd1",xk,yk)
-        set_floor("fl-leavesd3",xk+1,yk)
-        set_floor("fl-leavesd2",xk,yk+1)
-        set_floor("fl-leavesd4",xk+1,yk+1)
-    else
-        set_floor("fl-leavesc4",xk,yk)
-        set_floor("fl-leavesc2",xk+1,yk)
-        set_floor("fl-leavesc3",xk,yk+1)
-        set_floor("fl-leavesc1",xk+1,yk+1)
-    end
-end
-
---               01234567890123456789
-renderLine(00 , "                    ")
-renderLine(01 , "    *    *    *     ")
-renderLine(02 , "                    ")
-renderLine(03 , "    *    *    *     ")
-renderLine(04 , "                    ")  
-renderLine(05 , "  *  z  *   *  z  * ")
-renderLine(06 , " *  z z       z z   ")
-renderLine(07 , "  *  z  *   *  z  * ")
-renderLine(08 , "                    ")
-renderLine(09 , "     *    *    *    ")
-renderLine(10 , "                    ")
-renderLine(11 , "     *    *    *    ")
-renderLine(12 , "                    ")
---               012345678901234567890
-
-holi={}
-holj={}
-holk={}
-holl={}
-mix()
-oxyd_shuffle()
-    ]]></el:luamain>
-    <el:i18n>
-      <el:string el:key="title">
-        <el:english el:translate="false"/>
-      </el:string>
-    </el:i18n>
-  </el:protected>
-</el:level>

Copied: branches/1.0/data/levels/enigma_vi/alain25_2.xml (from rev 683, branches/1.0/data/levels/enigma_vi/alain25_1.xml)
===================================================================
--- branches/1.0/data/levels/enigma_vi/alain25_1.xml	2007-04-06 11:47:23 UTC (rev 683)
+++ branches/1.0/data/levels/enigma_vi/alain25_2.xml	2007-04-06 23:05:52 UTC (rev 685)
@@ -0,0 +1,148 @@
+<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
+<el:level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://enigma-game.org/schema/level/1 level.xsd" xmlns:el="http://enigma-game.org/schema/level/1">
+  <el:protected>
+    <el:info el:type="level">
+      <el:identity el:title="- Meditation -" el:subtitle="Pauli" el:id="alain25"/>
+      <el:version el:score="2" el:release="2" el:revision="2" el:status="released"/>
+      <el:author  el:name="Alain Busser + Raoul Bourquin" el:email="" el:homepage=""/>
+      <el:copyright>Copyright ? 2006 Alain Busser + Raoul Bourquin</el:copyright>
+      <el:license el:type="GPL v2.0 or above" el:open="true"/>
+      <el:compatibility el:enigma="0.92">
+      </el:compatibility>
+      <el:modes el:easy="true" el:single="true" el:network="false"/>
+      <el:comments>
+        <el:code>Lua 5.1 and XML converted by Leveladministrators</el:code>
+      </el:comments>
+      <el:score el:easy="-" el:difficult="1:54"/>
+    </el:info>
+    <el:luamain><![CDATA[
+levelw = 20
+levelh = 13
+
+nhol=8
+
+create_world(levelw, levelh)
+oxyd_default_flavor = "a"
+display.SetFollowMode(display.FOLLOW_SCROLLING)
+fill_floor("fl-leaves", 0,0, level_width,level_height)
+draw_border("st-rock1")
+
+function renderLine( line, pattern)
+    for i=1, strlen(pattern) do
+        local c = strsub( pattern, i, i)
+        if c =="#" then
+            set_item("it-hollow", i-1, line)
+        elseif c=="*" then
+            set_item("it-trigger",i-1,line,{invisible=1,action="callback",target="mix"})
+            --set_floor("fl-leavesb",i-1,line)
+            circle(i-1,line)
+        elseif c=="z" then
+            set_actor("ac-whiteball-small", i-.5,line+.5, {player=0})
+        end
+    end    
+end
+
+function mix()
+    for i=0,3 do
+        for j=0,2 do
+            for k=0,3 do
+                enigma.KillItem(5*i+j+1,k+1)
+                enigma.KillItem(5*i+j+1,k+8)
+            end
+        end
+    end
+    spade()
+end
+
+function spade()
+    holi[1]=random(4)-1
+    holj[1]=random(3)-1
+    holk[1]=random(4)-1
+    holl[1]=random(2)-1
+    for n=2,nhol do
+        repeat
+            ii=random(4)-1
+            jj=random(3)-1
+            kk=random(4)-1
+            ll=random(2)-1
+            vazy=1
+            m = 0
+            for p=1,n do
+                if holi[p]==ii and holj[p]==jj and holk[p]==kk and holl[p]==ll then
+                    vazy=0
+                end
+                if vazy==0 then
+                    m=m+1
+                end
+            end
+        until m == 0
+        holi[n]=ii
+        holj[n]=jj
+        holk[n]=kk
+        holl[n]=ll
+    end
+    for n=1,nhol do
+        set_item("it-hollow",5*holi[n]+holj[n]+1,holk[n]+7*holl[n]+1)
+    end
+end
+
+--draw the green circles:
+function circle(x,y)
+    t=random(1,4)
+    if t==1 then
+        xk=x
+        yk=y
+    elseif t==2 then
+        xk=x-1
+        yk=y
+    elseif t==3 then
+        xk=x-1
+        yk=y-1
+    elseif t==4 then
+        xk=x
+        yk=y-1
+    end
+ 
+    if difficult then
+        set_floor("fl-leavesd1",xk,yk)
+        set_floor("fl-leavesd3",xk+1,yk)
+        set_floor("fl-leavesd2",xk,yk+1)
+        set_floor("fl-leavesd4",xk+1,yk+1)
+    else
+        set_floor("fl-leavesc4",xk,yk)
+        set_floor("fl-leavesc2",xk+1,yk)
+        set_floor("fl-leavesc3",xk,yk+1)
+        set_floor("fl-leavesc1",xk+1,yk+1)
+    end
+end
+
+--               01234567890123456789
+renderLine(00 , "                    ")
+renderLine(01 , "    *    *    *     ")
+renderLine(02 , "                    ")
+renderLine(03 , "    *    *    *     ")
+renderLine(04 , "                    ")  
+renderLine(05 , "  *  z  *   *  z  * ")
+renderLine(06 , " *  z z       z z   ")
+renderLine(07 , "  *  z  *   *  z  * ")
+renderLine(08 , "                    ")
+renderLine(09 , "     *    *    *    ")
+renderLine(10 , "                    ")
+renderLine(11 , "     *    *    *    ")
+renderLine(12 , "                    ")
+--               012345678901234567890
+
+holi={}
+holj={}
+holk={}
+holl={}
+mix()
+oxyd_shuffle()
+    ]]></el:luamain>
+    <el:i18n>
+      <el:string el:key="title">
+        <el:english el:translate="false"/>
+      </el:string>
+    </el:i18n>
+  </el:protected>
+</el:level>

Modified: branches/1.0/data/levels/enigma_vi/index.xml
===================================================================
--- branches/1.0/data/levels/enigma_vi/index.xml	2007-04-06 20:58:39 UTC (rev 684)
+++ branches/1.0/data/levels/enigma_vi/index.xml	2007-04-06 23:05:52 UTC (rev 685)
@@ -25,7 +25,7 @@
     <level _seq="17" _title="Bomb raider" _xpath="./alain27_1" author="Alain Busser" ctrl="force" easy="true" id="alain27" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="18" _title="Evil" _xpath="./spaceman04_1" author="Spaceman" ctrl="force" easy="false" id="spaceman4" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="19" _title="Random space" _xpath="./edward21_1" author="Edward" ctrl="force" easy="true" id="edward21" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="20" _title="- Meditation -" _xpath="./alain25_1" author="Alain Busser + Raoul Bourquin" ctrl="force" easy="true" id="alain25" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="20" _title="- Meditation -" _xpath="./alain25_2" author="Alain Busser + Raoul Bourquin" ctrl="force" easy="true" id="alain25" rel="2" rev="2" score="2" target="time" unit="duration"/>
     <level _seq="21" _title="Checkmate I" _xpath="./andreas29_1" author="Andreas Lochmann" ctrl="force" easy="false" id="andreas29" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="22" _title="Edwards Second Level" _xpath="./edward02_1" author="Edward" ctrl="force" easy="false" id="edward02" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="23" _title="Prepare Your Defense" _xpath="./duffy132_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy132" rel="1" rev="0" score="1" target="time" unit="duration"/>



From raoul at mail.berlios.de  Tue Apr 10 00:04:12 2007
From: raoul at mail.berlios.de (raoul at BerliOS)
Date: Tue, 10 Apr 2007 00:04:12 +0200
Subject: [Enigma-game-svn] r686 - homepage/input
Message-ID: <200704092204.l39M4CET028423@sheep.berlios.de>

Author: raoul
Date: 2007-04-10 00:04:12 +0200 (Tue, 10 Apr 2007)
New Revision: 686

Modified:
   homepage/input/download.html
   homepage/input/download_de.html
Log:
-> Removed php session argument for all links to mag-heut



Modified: homepage/input/download.html
===================================================================
--- homepage/input/download.html	2007-04-06 23:05:52 UTC (rev 685)
+++ homepage/input/download.html	2007-04-09 22:04:12 UTC (rev 686)
@@ -134,6 +134,6 @@
     Berlios</a>&nbsp;&nbsp;for recent releases.</li>
   <li><a href="http://savannah.nongnu.org/download/enigma/">
     http://savannah.nongnu.org/download/enigma/</a>&nbsp;&nbsp;for previous releases</li>
-  <li><a href="http://www.mag-heut.net/blackball/index.php?act=ST&amp;f=2&amp;t=118&amp;s=1b5eee7f424b7bd5f9ef75e927a549e9">
+  <li><a href="http://www.mag-heut.net/blackball/index.php?act=ST&amp;f=2&amp;t=118">
     mag-heut.net</a>&nbsp;&nbsp;for old Windows versions.</li>
   </ul>

Modified: homepage/input/download_de.html
===================================================================
--- homepage/input/download_de.html	2007-04-06 23:05:52 UTC (rev 685)
+++ homepage/input/download_de.html	2007-04-09 22:04:12 UTC (rev 686)
@@ -147,6 +147,6 @@
     Berlios</a>&nbsp;&nbsp;f&uuml;r aktuellere Versionen,</li>
   <li><a href="http://savannah.nongnu.org/download/enigma/">
     http://savannah.nongnu.org/download/enigma/</a>&nbsp;&nbsp;f&uuml;r vorherige Versionen,</li>
-  <li><a href="http://www.mag-heut.net/blackball/index.php?act=ST&amp;f=2&amp;t=118&amp;s=1b5eee7f424b7bd5f9ef75e927a549e9">
+  <li><a href="http://www.mag-heut.net/blackball/index.php?act=ST&amp;f=2&amp;t=118">
     mag-heut.net</a>&nbsp;&nbsp;f&uuml;r alte Windows-Versionen.</li>
   </ul>



From andreasl at mail.berlios.de  Tue Apr 10 17:58:02 2007
From: andreasl at mail.berlios.de (andreasl at BerliOS)
Date: Tue, 10 Apr 2007 17:58:02 +0200
Subject: [Enigma-game-svn] r687 - in branches/1.0/data/levels: enigma_iii
	enigma_v
Message-ID: <200704101558.l3AFw2FU019687@sheep.berlios.de>

Author: andreasl
Date: 2007-04-10 17:58:02 +0200 (Tue, 10 Apr 2007)
New Revision: 687

Modified:
   branches/1.0/data/levels/enigma_iii/andreas04_1.xml
   branches/1.0/data/levels/enigma_v/andreas08_1.xml
Log:
Removed reference to fl-rock1 and fl-rock2 from my levels.


Modified: branches/1.0/data/levels/enigma_iii/andreas04_1.xml
===================================================================
--- branches/1.0/data/levels/enigma_iii/andreas04_1.xml	2007-04-09 22:04:12 UTC (rev 686)
+++ branches/1.0/data/levels/enigma_iii/andreas04_1.xml	2007-04-10 15:58:02 UTC (rev 687)
@@ -48,7 +48,6 @@
 cells[")"]=cell{floor="fl-gradient2"}
 stones["#"]=cell{stone="st-stoneimpulse"}
 cells["*"]=cell{floor="fl-gradient1"}
--- cells["+"]=cell{floor="fl-rock1"}
 cells["+"]=cell{floor="fl-rock"}
 items["!"]=cell{item="it-trigger"}
 stones["$"]=cell{stone="st-rock1_move"}
@@ -62,7 +61,6 @@
 cells["0"]=cell{floor="fl-gradient7"}
 stones["'"]=cell{parent={{file_oxyd,"a"}}}
 stones["("]=cell{stone="st-mirror-p-t"}
--- cells["1"]=cell{floor="fl-rock2"}
 cells["1"]=cell{floor="fl-rock"}
 items["$"]=cell{item="it-wormhole"}
 -- items["$"]=cell{item="it-vortex"}

Modified: branches/1.0/data/levels/enigma_v/andreas08_1.xml
===================================================================
--- branches/1.0/data/levels/enigma_v/andreas08_1.xml	2007-04-09 22:04:12 UTC (rev 686)
+++ branches/1.0/data/levels/enigma_v/andreas08_1.xml	2007-04-10 15:58:02 UTC (rev 687)
@@ -67,7 +67,6 @@
 set_actor("ac-top",x+0.5,y+0.5,{range=r,force=f,name=n,gohome=init})
 end
 actors["!"]=cell{parent={{ac_top}}}
--- cells["("]=cell{floor="fl-rock1"}
 cells["("]=cell{floor="fl-rock"}
 cells[")"]=cell{floor="fl-plank"}
 stones["&"]=cell{stone="st-grate1"}



From raoul at mail.berlios.de  Tue Apr 10 22:17:29 2007
From: raoul at mail.berlios.de (raoul at BerliOS)
Date: Tue, 10 Apr 2007 22:17:29 +0200
Subject: [Enigma-game-svn] r688 - branches/1.0/src
Message-ID: <200704102017.l3AKHTpk019936@sheep.berlios.de>

Author: raoul
Date: 2007-04-10 22:17:28 +0200 (Tue, 10 Apr 2007)
New Revision: 688

Modified:
   branches/1.0/src/items.cc
   branches/1.0/src/st_switches.cc
   branches/1.0/src/stones_complex.cc
   branches/1.0/src/stones_simple.cc
Log:
-> Fixed some crashes caused by unremoved gametimers in objectdestructors.



Modified: branches/1.0/src/items.cc
===================================================================
--- branches/1.0/src/items.cc	2007-04-10 15:58:02 UTC (rev 687)
+++ branches/1.0/src/items.cc	2007-04-10 20:17:28 UTC (rev 688)
@@ -1840,6 +1840,7 @@
         DECL_TRAITS_ARRAY(2, is_open());
     public:
         Vortex(bool opened);
+        virtual ~Vortex();
 
     private:
         static const double RANGE;
@@ -1913,6 +1914,12 @@
     set_attrib ("targety", Value());
 }
 
+Vortex::~Vortex() {
+    ASSERT(state != WARPING && state != SWALLOWING && state != EMITTING,
+        XLevelRuntime, "Tried to kill a busy vortex. Please use another way.");
+    GameTimer.remove_alarm(this);
+}
+
 void Vortex::prepare_for_warp (Actor *actor)
 {
     SendMessage(actor, "fallvortex");
@@ -2642,6 +2649,7 @@
         void alarm();
     public:
         Blocker(bool shrinked_recently);
+        ~Blocker();
     };
     DEF_TRAITSF(Blocker, "it-blocker", it_blocker, itf_static);
 };
@@ -2653,6 +2661,10 @@
 : state(shrinked_recently ? SHRINKED : IDLE)
 {}
 
+Blocker::~Blocker() {
+    GameTimer.remove_alarm (this);
+}
+
 void Blocker::on_creation (GridPos p)
 {
     if (state == SHRINKED) {
@@ -3176,12 +3188,14 @@
     public:
         Cross() : m_active(false) {
         }
-
-        virtual ~Cross() {
-            GameTimer.remove_alarm (this);
-        }
+        virtual ~Cross();
     };
     DEF_TRAITSF(Cross, "it-cross", it_cross, itf_static);
+
+    Cross::~Cross() {
+            GameTimer.remove_alarm(this);
+    }
+
 }
 
 /* -------------------- Bag -------------------- */

Modified: branches/1.0/src/st_switches.cc
===================================================================
--- branches/1.0/src/st_switches.cc	2007-04-10 15:58:02 UTC (rev 687)
+++ branches/1.0/src/st_switches.cc	2007-04-10 20:17:28 UTC (rev 688)
@@ -169,6 +169,8 @@
         CLONEOBJ(CoinSlot);
     public:
         CoinSlot();
+        ~CoinSlot();
+
     private:
         // Variables.
         enum State { ACTIVE, INACTIVE } state;
@@ -195,6 +197,11 @@
 {
 }
 
+CoinSlot::~CoinSlot() {
+    GameTimer.remove_alarm (this);
+}
+
+
 void CoinSlot::init_model() {
     set_model(state==ACTIVE ? "st-coinslot-active" : "st-coinslot");
 }
@@ -439,6 +446,7 @@
     class LaserTimeSwitchBase : public PhotoStone, public TimeHandler {
     public:
         LaserTimeSwitchBase(const char *kind);
+        virtual ~LaserTimeSwitchBase();
 
     private:
         // LaserTimeSwitchBase interface
@@ -510,6 +518,10 @@
 : PhotoStone(kind) , state(IDLE) 
 {}
 
+LaserTimeSwitchBase::~LaserTimeSwitchBase() {
+    GameTimer.remove_alarm (this);
+}
+
 void LaserTimeSwitchBase::change_state(State newstate) {
     if (state == newstate)
         return;
@@ -569,7 +581,6 @@
 
 /* ---------- LaserSwitch ---------- */
 
-
 LaserSwitch::LaserSwitch()
 : LaserTimeSwitchBase("st-laserswitch")
 {}

Modified: branches/1.0/src/stones_complex.cc
===================================================================
--- branches/1.0/src/stones_complex.cc	2007-04-10 15:58:02 UTC (rev 687)
+++ branches/1.0/src/stones_complex.cc	2007-04-10 20:17:28 UTC (rev 688)
@@ -204,6 +204,7 @@
 {}
 
 PullStone::~PullStone() {
+    GameTimer.remove_alarm(this);
     delete pull_info;
 }
 

Modified: branches/1.0/src/stones_simple.cc
===================================================================
--- branches/1.0/src/stones_simple.cc	2007-04-10 15:58:02 UTC (rev 687)
+++ branches/1.0/src/stones_simple.cc	2007-04-10 20:17:28 UTC (rev 688)
@@ -364,6 +364,7 @@
     class SwapStone : public Stone, public TimeHandler {
     public:
         SwapStone();
+        ~SwapStone();
     private:
         // Object interface
         SwapStone *clone();
@@ -395,6 +396,10 @@
   move_dir(NODIR)
 {}
 
+SwapStone::~SwapStone() {
+    GameTimer.remove_alarm(this);
+}
+
 SwapStone *SwapStone::clone() {
     SwapStone *other        = new SwapStone(*this);
     other->in_exchange_with = 0;
@@ -1256,9 +1261,7 @@
             // set_on(true);   DOESN'T WORK! calls init_model()
         }
         
-        virtual ~TimerStone() {
-            GameTimer.remove_alarm (this);
-        }
+        virtual ~TimerStone();
     private:
         int m_signalvalue;
 
@@ -1298,9 +1301,13 @@
             if (newon)
                 set_alarm();
             else
-                GameTimer.remove_alarm (this);
+                GameTimer.remove_alarm(this);
         }
     };
+
+    TimerStone::~TimerStone() {
+        GameTimer.remove_alarm(this);
+    }
 }
 
 



From raoul at mail.berlios.de  Sat Apr 14 00:20:34 2007
From: raoul at mail.berlios.de (raoul at BerliOS)
Date: Sat, 14 Apr 2007 00:20:34 +0200
Subject: [Enigma-game-svn] r689 - branches/1.0/src
Message-ID: <200704132220.l3DMKYmZ019720@sheep.berlios.de>

Author: raoul
Date: 2007-04-14 00:20:34 +0200 (Sat, 14 Apr 2007)
New Revision: 689

Modified:
   branches/1.0/src/items.cc
   branches/1.0/src/stones_complex.cc
Log:
-> Bugfix for circular mailpipes
-> Bugfix for recursive Vortex/Wormhole roundtrips



Modified: branches/1.0/src/items.cc
===================================================================
--- branches/1.0/src/items.cc	2007-04-10 20:17:28 UTC (rev 688)
+++ branches/1.0/src/items.cc	2007-04-13 22:20:34 UTC (rev 689)
@@ -1695,7 +1695,6 @@
 
     protected:
         virtual ~WormHole() {
-            ASSERT(!justWarping, XLevelRuntime, "Tried to kill a busy wormhole. Please use another way.");
             GameTimer.remove_alarm (this);
         }
     private:
@@ -1709,10 +1708,7 @@
             Item::on_creation (p);
             set_forcefield();
         }
-        void on_removal (GridPos p) {
-            world::RemoveForceField(&ff);
-            Item::on_removal(p);
-        }
+        void on_removal (GridPos p);
 
         void set_forcefield() {
             if (is_on()) {
@@ -1807,6 +1803,12 @@
         set_anim("it-wormhole-off");
 }
 
+void WormHole::on_removal(GridPos p) {
+    GameTimer.remove_alarm (this);
+    world::RemoveForceField(&ff);
+    Item::on_removal(p);
+    ASSERT(!justWarping, XLevelRuntime, "Tried to kill a busy wormhole. Please use another way.");
+}
 
 /* -------------------- Vortex -------------------- */
 
@@ -1876,6 +1878,8 @@
 
         bool is_open() const { return state == OPEN; }
 
+        void on_removal(GridPos p);
+
         // Variables
         enum State {
             OPEN,
@@ -1915,9 +1919,14 @@
 }
 
 Vortex::~Vortex() {
+    GameTimer.remove_alarm(this);
+}
+
+void Vortex::on_removal(GridPos p) {
+    GameTimer.remove_alarm(this);
+    Item::on_removal(p);
     ASSERT(state != WARPING && state != SWALLOWING && state != EMITTING,
         XLevelRuntime, "Tried to kill a busy vortex. Please use another way.");
-    GameTimer.remove_alarm(this);
 }
 
 void Vortex::prepare_for_warp (Actor *actor)

Modified: branches/1.0/src/stones_complex.cc
===================================================================
--- branches/1.0/src/stones_complex.cc	2007-04-10 20:17:28 UTC (rev 688)
+++ branches/1.0/src/stones_complex.cc	2007-04-13 22:20:34 UTC (rev 689)
@@ -2879,10 +2879,21 @@
     }
 }
 
+/** About recursion detection while finding the end of a mailpipe
+ *  
+ *  Since there are no possibilities for forking a mailpipe, there is only one 
+ *  cause that may lead to a closed, circular mailpipe. This is if a pipeitem is
+ *  placed exactly under the mailstone. But not every pipepiece is dangerous,
+ *  there are some that can be placed under the mailstone without problems.
+ * 
+ *  The mailpipe is only closed to a circular one if the pipepiece under the
+ *  mailstone has the same 'output'-direction as the stone.
+ */
 GridPos MailStone::find_pipe_endpoint() 
 {
     GridPos p = get_pos();
     Direction move_dir = m_dir;
+    GridPos q = p; // Store the stonepos for recursion detection.
 
     while (move_dir != NODIR) {
         p.move (move_dir);
@@ -2921,6 +2932,9 @@
             }
         } else
             move_dir = NODIR;
+
+        if (p == q)
+            ASSERT(move_dir != m_dir, XLevelRuntime, "Mailpipe is circular! Recursion detected!");   
     }
     return p;
 }



From ral at mail.berlios.de  Sat Apr 14 17:11:54 2007
From: ral at mail.berlios.de (ral at BerliOS)
Date: Sat, 14 Apr 2007 17:11:54 +0200
Subject: [Enigma-game-svn] r690 - in branches/1.0/src: . gui lev
Message-ID: <200704141511.l3EFBscC016544@sheep.berlios.de>

Author: ral
Date: 2007-04-14 17:11:51 +0200 (Sat, 14 Apr 2007)
New Revision: 690

Modified:
   branches/1.0/src/client.cc
   branches/1.0/src/gui/LevelInspector.cc
   branches/1.0/src/gui/LevelInspector.hh
   branches/1.0/src/gui/LevelMenu.cc
   branches/1.0/src/gui/LevelMenu.hh
   branches/1.0/src/gui/widgets.cc
   branches/1.0/src/gui/widgets.hh
   branches/1.0/src/lev/RatingManager.cc
   branches/1.0/src/lev/RatingManager.hh
   branches/1.0/src/server.cc
Log:
Branch 1.0: 
- WR hunt mode: eliminate restart of level after ESC menu
- Level Developer Inspector by F2 in standard inspector
- display level Id in Dev. Inspector and "info" command
- shorten WR holder strings where necessary for a proper display


Modified: branches/1.0/src/client.cc
===================================================================
--- branches/1.0/src/client.cc	2007-04-13 22:20:34 UTC (rev 689)
+++ branches/1.0/src/client.cc	2007-04-14 15:11:51 UTC (rev 690)
@@ -1,5 +1,6 @@
 /*
  * Copyright (C) 2004 Daniel Heck
+ * Copyright (C) 2006, 2007 Ronald Lamprecht
  *
  * This program is free software; you can redistribute it and/or
  * modify it under the terms of the GNU General Public License
@@ -533,9 +534,6 @@
     server::Msg_Pause (false);
     game::ResetGameTimer();
 
-    if (app.state->getInt("NextLevelMode") == lev::NEXT_LEVEL_NOT_BEST) 
-        server::Msg_Command ("restart"); // inhibit cheating
-
 }
 
 void Client::draw_screen()
@@ -657,7 +655,7 @@
                     }
 
                     client::Msg_PlaySound("shatter", 1.0);
-                    Msg_ShowText(message, false, 2.0);
+                    Msg_ShowText(message, true, 2.0);
                 }
                 else {
                     if (old_second<second && // tick every second
@@ -823,7 +821,7 @@
                     m_hunt_against_time%60);
 //+ _(" by ") +hunted;
 // makes the string too long in many levels
-            Msg_ShowText (displayed_info, false, 4.0);
+            Msg_ShowText (displayed_info, true, 4.0);
         }
         else {
             displayed_info = displayedLevelInfo(curProxy);

Modified: branches/1.0/src/gui/LevelInspector.cc
===================================================================
--- branches/1.0/src/gui/LevelInspector.cc	2007-04-13 22:20:34 UTC (rev 689)
+++ branches/1.0/src/gui/LevelInspector.cc	2007-04-14 15:11:51 UTC (rev 690)
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 2006 Ronald Lamprecht
+ * Copyright (C) 2006, 2007 Ronald Lamprecht
  *
  * This program is free software; you can redistribute it and/or
  * modify it under the terms of the GNU General Public License
@@ -173,8 +173,8 @@
          lev::Proxy *theLevel;        
      };
     
-LevelInspector::LevelInspector(lev::Proxy *aLevel):
-        levelProxy(aLevel), annotation (new TextField()),
+LevelInspector::LevelInspector(lev::Proxy *aLevel, bool showDeveloperInfo):
+        levelProxy(aLevel), isDeveloperMode(showDeveloperInfo), annotation (new TextField()),
         back (new StaticTextButton(N_("Ok"), this)),
         screenshot (new StaticTextButton(N_("Screenshot"), this))
     {
@@ -378,10 +378,11 @@
         int levelPathLines = 0;
         int annotationLines = 0; 
         int compatibilityLines = 0; 
+        int idLines = 0; 
         int vnext = vmargin+ (lowres?11:12)*25+(lowres?9:10)*vspacing+2*vspacing2;
         int textwidth = vminfo->width-3*hmargin-110-10;
         dispatchBottomLines(bestScoreHolderLines, creditsLines, dedicationLines,
-                levelPathLines, annotationLines, compatibilityLines,
+                levelPathLines, annotationLines, compatibilityLines, idLines,
                 (vminfo->height-vnext-vmargin-25-vspacing2)/27, textwidth);
         if (bestScoreHolderLines == 1) {
             add(new Label(N_("World Record Holders: "), HALIGN_RIGHT),Rect(hmargin,vnext,200,25));
@@ -396,7 +397,52 @@
                 holders += " -";
             else
                 holders += theRatingMgr->getBestScoreDifficultHolder(aLevel);
-            add(new Label(holders, HALIGN_LEFT), Rect(hmargin+200+10,vnext,textwidth-90,25));
+            Label *wrLabel = new Label(holders, HALIGN_LEFT);
+            add(wrLabel, Rect(hmargin+200+10,vnext,textwidth-90,25));
+            if (!wrLabel->text_fits()) {
+                int cutEasy = 0;
+                int cutDiff = 0;
+                std::string diffHolders = theRatingMgr->getBestScoreDifficultHolder(aLevel);
+                if (withEasy) {
+                    std::string easyHolders = theRatingMgr->getBestScoreEasyHolder(aLevel);
+                    bool hasEasyHolders = !easyHolders.empty();
+                    bool hasDiffHolders = !diffHolders.empty();
+                    int limit = 10;
+                    do {
+                        std::string cutHolders;
+                        wrLabel->set_text(easyHolders);
+                        if (!wrLabel->text_fits(0.48)) {
+                            cutHolders = theRatingMgr->getBestScoreEasyHolder(aLevel, ++cutEasy);
+                            if (cutHolders.empty())
+                                cutEasy--;
+                            else
+                                easyHolders = cutHolders;
+                        }
+                        wrLabel->set_text(diffHolders);
+                        if (!wrLabel->text_fits(0.48)) {
+                            cutHolders = theRatingMgr->getBestScoreDifficultHolder(aLevel, ++cutDiff);
+                            if (cutHolders.empty())
+                                cutDiff--;
+                            else
+                                diffHolders = cutHolders;
+                        }
+                        holders = (hasEasyHolders ? easyHolders : std::string("  - "))
+                            + " / " + (hasDiffHolders ? diffHolders : std::string(" -"));
+                        wrLabel->set_text(holders);
+                        limit--;
+                    } while (!wrLabel->text_fits() && limit > 0);
+                } else {
+                    std::string cutHolders;
+                    do {
+                        cutHolders = theRatingMgr->getBestScoreDifficultHolder(aLevel, ++cutDiff);
+                        wrLabel->set_text(cutHolders);
+                    } while (!wrLabel->text_fits());
+                    if (cutHolders.empty()) {
+                        // we did cut off to many holders, take last attempt even if it was too long
+                        wrLabel->set_text(theRatingMgr->getBestScoreDifficultHolder(aLevel, --cutDiff));
+                    }
+                }
+            }
             vnext += 25 + vspacing;
         }
         if (creditsLines >= 1) {
@@ -441,6 +487,11 @@
             }
             vnext += (25 + vspacing);
         }
+        if (idLines >= 1) {
+            add(new Label(N_("Id: "), HALIGN_RIGHT),Rect(hmargin,vnext,110,25));
+            add(new Label(levelProxy->getId(), HALIGN_LEFT),Rect(hmargin+110+10, vnext, textwidth, 25));
+            vnext += (25 + vspacing)*idLines;
+        }
         if (compatibilityLines >= 1) {
             add(new Label(N_("Compatibility: "), HALIGN_RIGHT),Rect(hmargin,vnext,110,25));
             std::string compString = ecl::strf("Enigma v%.2f  /  ", levelProxy->getEnigmaCompatibility()) +
@@ -448,9 +499,9 @@
             add(new Label(compString , HALIGN_LEFT),Rect(hmargin+110+10, vnext, textwidth, 25));
             vnext += (25 + vspacing)*compatibilityLines;
         }
+        annotation->set_text(app.state->getAnnotation(levelProxy->getId())); // field needs to initialized for saves
         if (annotationLines >= 1) {
             add(new Label(N_("Annotation: "), HALIGN_RIGHT),Rect(hmargin,vnext,110,25));
-            annotation->set_text(app.state->getAnnotation(levelProxy->getId()));
             add(annotation, Rect(hmargin+110+10, vnext, textwidth, 25));
             vnext += (25 + vspacing)*annotationLines;
         }
@@ -464,8 +515,42 @@
     LevelInspector::~LevelInspector () {
     }
     
+    bool LevelInspector::isEndDeveloperMode() {
+        return isDeveloperMode;
+    }
+    
     bool LevelInspector::on_event (const SDL_Event &e) {
-        return false;
+        bool handled = false;
+        if (e.type == SDL_KEYDOWN) {
+            handled=true;
+            switch (e.key.keysym.sym) {
+            case SDLK_F2:
+                if (!isDeveloperMode) {
+                    if (!annotation->getText().empty() || 
+                            !app.state->getAnnotation(levelProxy->getId()).empty()) {
+                        app.state->setAnnotation(levelProxy->getId(), annotation->getText());
+                    }
+                    LevelInspector m(levelProxy, true);
+                    m.manage();
+                    if (m.isEndDeveloperMode()) {
+                        // reinit user input fields
+                        annotation->set_text(app.state->getAnnotation(levelProxy->getId()));
+                        invalidate_all();
+                    } else {
+                        Menu::quit();
+                    }
+                } else {
+                    if (!annotation->getText().empty() || 
+                            !app.state->getAnnotation(levelProxy->getId()).empty()) {
+                        app.state->setAnnotation(levelProxy->getId(), annotation->getText());
+                    }
+                    Menu::quit();
+                }
+                break;
+            default: handled=false; break;
+            }
+        }
+        return handled;
     }
     
     void LevelInspector::on_action(gui::Widget *w) {
@@ -475,6 +560,7 @@
                     !app.state->getAnnotation(levelProxy->getId()).empty()) {
                 app.state->setAnnotation(levelProxy->getId(), annotation->getText());
             }
+            isDeveloperMode = false;
             Menu::quit();
         } else if (w == screenshot) {
             ScreenshotViewer m(levelProxy);
@@ -485,7 +571,8 @@
     
     void LevelInspector::draw_background(ecl::GC &gc) {
         const video::VMInfo *vminfo = video::GetInfo();
-        video::SetCaption (("Enigma - Level Inspector"));
+        video::SetCaption((std::string("Enigma - Level ") + 
+            (isDeveloperMode ? "Developer " : "") + "Inspector").c_str());
         blit(gc, 0,0, enigma::GetImage("menu_bg", ".jpg"));
         blit(gc, vminfo->width-vminfo->thumbw-10-hmargin, vmargin, previewImage);
         Surface *img_hard = enigma::GetImage("completed");
@@ -555,12 +642,16 @@
     
     void LevelInspector::dispatchBottomLines(int &bestScoreHolderLines, 
             int &creditsLines, int &dedicationLines, int &levelPathLines,
-            int &annotationLines, int &compatibilityLines, int numLines, int width) {
-        enum botType {holder, credits, dedication, path, annotation, compatibility};
+            int &annotationLines, int &compatibilityLines, int &idLines, int numLines, int width) {
+        enum botType {holder, credits, dedication, path, annotation, compatibility, id};
         const int sequenceSize = 13;
-        botType sequence[sequenceSize] = {credits, dedication, annotation, path,
+        botType sequence1[sequenceSize] = {credits, dedication, annotation, path,
                 holder, annotation, path, compatibility, credits, dedication, 
                 annotation, credits, annotation};
+        botType sequence2[sequenceSize] = {id, path, compatibility, holder, path, 
+                annotation, annotation, credits, dedication,
+                credits, dedication, annotation, annotation};
+        botType *sequence = isDeveloperMode ? sequence2 : sequence1;
         int j = 0;
         std::string creditsString = levelProxy->getCredits(true);
         std::string dedicationString = levelProxy->getDedication(true);
@@ -606,6 +697,10 @@
                         compatibilityLines++;
                         assigned = true;
                         break;
+                    case id: 
+                        idLines++;
+                        assigned = true;
+                        break;
                 }
                 
             } while (!assigned && j < sequenceSize);

Modified: branches/1.0/src/gui/LevelInspector.hh
===================================================================
--- branches/1.0/src/gui/LevelInspector.hh	2007-04-13 22:20:34 UTC (rev 689)
+++ branches/1.0/src/gui/LevelInspector.hh	2007-04-14 15:11:51 UTC (rev 690)
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 2006 Ronald Lamprecht
+ * Copyright (C) 2006, 2007 Ronald Lamprecht
  *
  * This program is free software; you can redistribute it and/or
  * modify it under the terms of the GNU General Public License
@@ -27,8 +27,9 @@
 namespace enigma { namespace gui {
     class LevelInspector : public gui::Menu {
     public:
-        LevelInspector (lev::Proxy *aLevel);
+        LevelInspector (lev::Proxy *aLevel, bool showDeveloperInfo = false);
         ~LevelInspector ();
+        bool isEndDeveloperMode();
     private:
         // ActionListener interface.                    
         bool on_event (const SDL_Event &e);
@@ -45,7 +46,7 @@
         std::string scoreToString(int score, lev::Proxy *aLevel);
         void dispatchBottomLines(int &bestScoreHolderLines, 
             int &creditsLines, int &dedicationLines, int &levelPathLines,
-            int &annotationLines, int &compatibilityLines, int numLines, int width);
+            int &annotationLines, int &compatibilityLines, int &idLines, int numLines, int width);
         // Variables.
         gui::Widget *back;
         gui::Widget *screenshot;
@@ -59,6 +60,7 @@
         int hmargin;
         bool withEasy;
         bool ratingInherited;
+        bool isDeveloperMode;
     };
 
 }} // namespace enigma::gui

Modified: branches/1.0/src/gui/LevelMenu.cc
===================================================================
--- branches/1.0/src/gui/LevelMenu.cc	2007-04-13 22:20:34 UTC (rev 689)
+++ branches/1.0/src/gui/LevelMenu.cc	2007-04-14 15:11:51 UTC (rev 690)
@@ -127,10 +127,10 @@
         hl->add_back (lbl_lpinfo, List::TIGHT);
         this->add (hl, Rect (5, Y2, vminfo.width - 10, 28));
     
-        hl = new HList;
-        hl->add_back (lbl_levelinfo, List::EXPAND); //Rect (c.leftborder, Y2+20,305, 28));
-        hl->add_back (lbl_statistics, List::TIGHT);
-        this->add (hl, Rect (5, Y2+20, vminfo.width - 10, 28));
+        hl_info_stat = new HList;
+        hl_info_stat->add_back (lbl_levelinfo, List::EXPAND); //Rect (c.leftborder, Y2+20,305, 28));
+        hl_info_stat->add_back (lbl_statistics, List::TIGHT);
+        this->add (hl_info_stat, Rect (5, Y2+20, vminfo.width - 10, 28));
     
         // Prepare level selection widget
         levelwidget = new LevelWidget();
@@ -331,6 +331,7 @@
                 bool is_par    = scm->parScoreReached(curProxy, difficulty);
                 int best_user_time = scm->getBestUserScore(curProxy, difficulty);
                 string wr_name = ratingMgr->getBestScoreHolder(curProxy, difficulty);
+                bool  wr_name_displayed = false;
     
                 string your_time;
                 string wr_text;
@@ -350,26 +351,34 @@
                 }
     
                 if (wr_text.length() == 0 && wr_time>0) {
-                    if (wr_name.length())
+                    if (wr_name.length()) {
+                        wr_name_displayed = true;
+                    } else
                         if (is_par || par_time < 0)
-                            wr_text = strf(_("World record by %s: %d:%02d"), 
-                                    wr_name.c_str(), wr_time/60, wr_time%60);
-                        else
-                            wr_text = strf(_("Par: %d:%02d World record by %s: %d:%02d"), 
-                                    par_time/60, par_time%60, wr_name.c_str(), wr_time/60, wr_time%60);
-                    else
-                        if (is_par || par_time < 0)
                             wr_text = strf(_("World record: %d:%02d"), wr_time/60, wr_time%60);
                         else
                             wr_text = strf(_("Par: %d:%02d World record: %d:%02d"), 
                                     par_time/60, par_time%60, wr_time/60, wr_time%60);
                 }
     
-                string time_text;
-                if (your_time.length()>0)   time_text = your_time+"  "+wr_text;
-                else                        time_text = your_time+wr_text;
-    
-                lbl_levelinfo->set_text(time_text.c_str());
+                if (!your_time.empty())
+                    your_time += "  ";
+
+                int wr_cut = 0;
+                do {
+                    if (wr_name_displayed) {
+                        std::string tmp = ratingMgr->getBestScoreHolder(curProxy, difficulty, wr_cut++);
+                        if (!tmp.empty())
+                            wr_name = tmp;
+                        if (is_par || par_time < 0)
+                            wr_text = strf(_("World record by %s: %d:%02d"), 
+                                    wr_name.c_str(), wr_time/60, wr_time%60);
+                        else
+                            wr_text = strf(_("Par: %d:%02d World record by %s: %d:%02d"), 
+                                    par_time/60, par_time%60, wr_name.c_str(), wr_time/60, wr_time%60);
+                    }
+                    lbl_levelinfo->set_text(your_time + wr_text);
+                } while (!hl_info_stat->fits() && wr_name_displayed && (wr_cut < 20));
             }
         }
     }

Modified: branches/1.0/src/gui/LevelMenu.hh
===================================================================
--- branches/1.0/src/gui/LevelMenu.hh	2007-04-13 22:20:34 UTC (rev 689)
+++ branches/1.0/src/gui/LevelMenu.hh	2007-04-14 15:11:51 UTC (rev 690)
@@ -63,6 +63,7 @@
         Widget      *but_back;          // "Back" button
         Widget      *but_difficulty;        // "Difficulty" button
         TextButton  *but_levelpack;     // "Levelpack" button
+        HList       *hl_info_stat;
         Label       *lbl_lpinfo;        // Levelpack information
         Label       *lbl_statistics;        // percentage solved
         Label       *lbl_levelname;

Modified: branches/1.0/src/gui/widgets.cc
===================================================================
--- branches/1.0/src/gui/widgets.cc	2007-04-13 22:20:34 UTC (rev 689)
+++ branches/1.0/src/gui/widgets.cc	2007-04-14 15:11:51 UTC (rev 690)
@@ -405,7 +405,6 @@
 
 
 
-
 /* -------------------- HList -------------------- */
 
 void HList::recalc()
@@ -449,6 +448,12 @@
     }
 }
 
+bool HList::fits() {
+    int targetw = this->get_w(); // The available space
+    int naturalw= calc_minimum_width();
+    return targetw >= naturalw;
+}
+
 
 /* -------------------- VList -------------------- */
 
@@ -493,6 +498,12 @@
     }
 }
 
+bool VList::fits() {
+    int targeth = this->get_h(); // The available space
+    int naturalh= calc_minimum_height();
+    return targeth >= naturalh;
+}
+
 
 /* -------------------- Label -------------------- */
 
@@ -530,6 +541,12 @@
     }
 }
 
+bool Label::text_fits(double area_fraction) {
+    int w, h;
+    naturalsize (w, h);
+    return w <= get_w()*area_fraction;
+}
+
 void Label::draw (ecl::GC &gc, const ecl::Rect &) 
 {
     Font *f = m_font;

Modified: branches/1.0/src/gui/widgets.hh
===================================================================
--- branches/1.0/src/gui/widgets.hh	2007-04-13 22:20:34 UTC (rev 689)
+++ branches/1.0/src/gui/widgets.hh	2007-04-14 15:11:51 UTC (rev 690)
@@ -215,6 +215,7 @@
 
         void set_default_size (int w, int h);
         void set_alignment (HAlignment halign, VAlignment valign);
+        virtual bool fits() = 0;
 
     protected:
         List(int spacing=5);
@@ -254,6 +255,7 @@
     class HList : public List {
     public:
         HList() : List() {}
+        virtual bool fits();
 
     private:
         // List interface
@@ -263,6 +265,7 @@
     class VList : public List {
     public:
         VList() : List() {}
+        virtual bool fits();
 
     private:
         // List interface
@@ -298,6 +301,7 @@
         std::string getText() const;
         void set_font (ecl::Font *font);
         void set_alignment (HAlignment halign, VAlignment valign=VALIGN_CENTER);
+        bool text_fits(double area_fraction = 1.0);
     protected:
         // Variables.
         std::string m_text;

Modified: branches/1.0/src/lev/RatingManager.cc
===================================================================
--- branches/1.0/src/lev/RatingManager.cc	2007-04-13 22:20:34 UTC (rev 689)
+++ branches/1.0/src/lev/RatingManager.cc	2007-04-14 15:11:51 UTC (rev 690)
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 2006 Ronald Lamprecht
+ * Copyright (C) 2006, 2007 Ronald Lamprecht
  *
  * This program is free software; you can redistribute it and/or
  * modify it under the terms of the GNU General Public License
@@ -28,6 +28,7 @@
 
 #include <iostream>
 #include <cstdlib>
+#include <sstream>
 #include <xercesc/dom/DOM.hpp>
 #include <xercesc/util/XercesVersion.hpp>
 #if _XERCES_VERSION < 30000
@@ -531,14 +532,37 @@
                 
     }
     
-    std::string RatingManager::getBestScoreHolder(Proxy *levelProxy, int difficulty) {
+    std::string RatingManager::cutHolders(std::string org, int factor) {
+        if (factor <= 0)
+            return org;
+        
+        int others = 0;
+        if (org.rfind(" others") == org.length() - 7) {
+            // ratings string is already cut
+            std::string::size_type lastPlus = org.rfind('+');
+            std::istringstream othersString(org.substr(lastPlus + 1));
+            othersString >> std::dec >> others;
+            org = org.substr(0, lastPlus);
+        }
+        std::string::size_type cutPlus;
+        for (int i=0; i< factor; i++) {
+            cutPlus = org.rfind('+');
+            if (cutPlus == std::string::npos)
+                return "";
+            org = org.substr(0, cutPlus);
+            others++;
+        }
+        return ecl::strf("%s+%d others", org.c_str(), others);
+    }
+    
+    std::string RatingManager::getBestScoreHolder(Proxy *levelProxy, int difficulty, int cut) {
         if (difficulty == DIFFICULTY_EASY && !levelProxy->hasEasymode())
             difficulty = DIFFICULTY_HARD;
         switch (difficulty) {
             case DIFFICULTY_EASY:
-                return getBestScoreEasyHolder(levelProxy);
+                return getBestScoreEasyHolder(levelProxy, cut);
             case DIFFICULTY_HARD:
-                return getBestScoreDifficultHolder(levelProxy);
+                return getBestScoreDifficultHolder(levelProxy, cut);
             default:
                 ecl::Assert <XFrontend> (false, "RatingManager::getBestScoreHolder illegal difficulty");
         }
@@ -552,10 +576,10 @@
         return -1;
     }
 
-    std::string RatingManager::getBestScoreEasyHolder(Proxy *levelProxy) {
+    std::string RatingManager::getBestScoreEasyHolder(Proxy *levelProxy, int cut) {
         Rating * theRating = findRating(levelProxy);
         if (theRating != NULL) {
-            return theRating->bestScoreEasyHolder;
+            return cutHolders(theRating->bestScoreEasyHolder, cut);
         }
         return "";
     }
@@ -568,10 +592,10 @@
         return -1;
     }
 
-    std::string RatingManager::getBestScoreDifficultHolder(Proxy *levelProxy) {
+    std::string RatingManager::getBestScoreDifficultHolder(Proxy *levelProxy, int cut) {
         Rating * theRating = findRating(levelProxy);
         if (theRating != NULL) {
-            return theRating->bestScoreDifficultHolder;
+            return cutHolders(theRating->bestScoreDifficultHolder, cut);
         }
         return "";
     }

Modified: branches/1.0/src/lev/RatingManager.hh
===================================================================
--- branches/1.0/src/lev/RatingManager.hh	2007-04-13 22:20:34 UTC (rev 689)
+++ branches/1.0/src/lev/RatingManager.hh	2007-04-14 15:11:51 UTC (rev 690)
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 2006 Ronald Lamprecht
+ * Copyright (C) 2006, 2007 Ronald Lamprecht
  *
  * This program is free software; you can redistribute it and/or
  * modify it under the terms of the GNU General Public License
@@ -128,11 +128,11 @@
         void setSpeed(Proxy *levelProxy, short speed);
         short getDifficulty(Proxy *levelProxy);
         short getBestScore(Proxy *levelProxy, int difficulty);
-        std::string getBestScoreHolder(Proxy *levelProxy, int difficulty);
+        std::string getBestScoreHolder(Proxy *levelProxy, int difficulty, int cut = 0);
         short getBestScoreEasy(Proxy *levelProxy);
-        std::string getBestScoreEasyHolder(Proxy *levelProxy);
+        std::string getBestScoreEasyHolder(Proxy *levelProxy, int cut = 0);
         short getBestScoreDifficult(Proxy *levelProxy);
-        std::string getBestScoreDifficultHolder(Proxy *levelProxy);
+        std::string getBestScoreDifficultHolder(Proxy *levelProxy, int cut = 0);
         short getParScore(Proxy *levelProxy, int difficulty);
         short getParScoreEasy(Proxy *levelProxy);
         short getParScoreDifficult(Proxy *levelProxy);
@@ -157,6 +157,7 @@
         short updateMinDelay;
         Rating * findRating(Proxy * levelProxy);
         Rating * registerNewRating(Proxy * levelProxy);
+        std::string cutHolders(std::string org, int factor);
         
         /**
          * Loads the ratings from a given URI and updates the cached ratings.

Modified: branches/1.0/src/server.cc
===================================================================
--- branches/1.0/src/server.cc	2007-04-13 22:20:34 UTC (rev 689)
+++ branches/1.0/src/server.cc	2007-04-14 15:11:51 UTC (rev 690)
@@ -497,8 +497,10 @@
     else if (cmd == "info") {
         string infotext       = 
             ecl::strf("Level #%i of '", ind->getCurrentLevel()) + ind->getName()
-            + "' (" + curProxy->getAbsLevelPath() + ")  -  \"" + curProxy->getTitle() + "\" by " + curProxy->getAuthor()
-            + ecl::strf(" (rev=%i)", curProxy->getReleaseVersion());
+            + "' (" + curProxy->getAbsLevelPath() + ")  -  \"" + curProxy->getTitle() 
+            + "\" by " + curProxy->getAuthor()
+            + ecl::strf(" (rev=%i,", curProxy->getReleaseVersion())
+            + "id=\"" + curProxy->getId() + "\")";
             
         client::Msg_ShowText(infotext, true);
     }



From raoul at mail.berlios.de  Sun Apr 15 23:45:19 2007
From: raoul at mail.berlios.de (raoul at BerliOS)
Date: Sun, 15 Apr 2007 23:45:19 +0200
Subject: [Enigma-game-svn] r691 - in trunk: . attic/gfx-templates data
	data/gfx32 data/gfx40 data/gfx48 data/gfx64
Message-ID: <200704152145.l3FLjJIg029212@sheep.berlios.de>

Author: raoul
Date: 2007-04-15 23:45:05 +0200 (Sun, 15 Apr 2007)
New Revision: 691

Added:
   trunk/attic/gfx-templates/banana.psd
   trunk/attic/gfx-templates/cherry.psd
   trunk/attic/gfx-templates/key.psd
   trunk/attic/gfx-templates/pin.psd
   trunk/attic/gfx-templates/ring.psd
   trunk/data/gfx32/fl-rock.png
   trunk/data/gfx32/st-beads.png
   trunk/data/gfx32/st-black1.png
   trunk/data/gfx32/st-black2.png
   trunk/data/gfx32/st-black3.png
   trunk/data/gfx32/st-black4.png
   trunk/data/gfx32/st-block.png
   trunk/data/gfx40/fl-rock.png
   trunk/data/gfx40/st-beads.png
   trunk/data/gfx40/st-black1.png
   trunk/data/gfx40/st-black2.png
   trunk/data/gfx40/st-black3.png
   trunk/data/gfx40/st-black4.png
   trunk/data/gfx40/st-block.png
   trunk/data/gfx48/fl-rock.png
   trunk/data/gfx48/st-beads.png
   trunk/data/gfx48/st-black1.png
   trunk/data/gfx48/st-black2.png
   trunk/data/gfx48/st-black3.png
   trunk/data/gfx48/st-black4.png
   trunk/data/gfx48/st-block.png
   trunk/data/gfx64/
   trunk/data/gfx64/Makefile.am
   trunk/data/gfx64/it-banana.png
   trunk/data/gfx64/it-cherry.png
   trunk/data/gfx64/it-key.png
   trunk/data/gfx64/it-pin.png
   trunk/data/gfx64/it-ring.png
Removed:
   trunk/data/gfx32/fl-bluegreen2.png
   trunk/data/gfx32/fl-bluegreenx2.png
   trunk/data/gfx32/fl-ice_001.png
   trunk/data/gfx32/fl-rock1.png
   trunk/data/gfx32/fl-rock2.png
   trunk/data/gfx32/it-brush.png.png
   trunk/data/gfx32/stones.png
   trunk/data/gfx40/fl-bluegreen2.png
   trunk/data/gfx40/fl-bluegreenx2.png
   trunk/data/gfx40/fl-ice_001.png
   trunk/data/gfx40/fl-rock1.png
   trunk/data/gfx40/fl-rock2.png
   trunk/data/gfx40/stones.png
   trunk/data/gfx48/fl-bluegreen2.png
   trunk/data/gfx48/fl-bluegreenx2.png
   trunk/data/gfx48/fl-ice_001.png
   trunk/data/gfx48/fl-rock1.png
   trunk/data/gfx48/fl-rock2.png
   trunk/data/gfx48/stones.png
Modified:
   trunk/configure.ac
   trunk/data/Makefile.am
   trunk/data/gfx32/fl-bluegreenx.png
   trunk/data/gfx32/fl-leaves.png
   trunk/data/gfx32/it-banana.png
   trunk/data/gfx32/it-cherry.png
   trunk/data/gfx32/it-key.png
   trunk/data/gfx32/it-pin.png
   trunk/data/gfx32/it-ring.png
   trunk/data/gfx40/fl-bluegreenx.png
   trunk/data/gfx40/fl-leaves.png
   trunk/data/gfx40/it-banana.png
   trunk/data/gfx40/it-cherry.png
   trunk/data/gfx40/it-key.png
   trunk/data/gfx40/it-pin.png
   trunk/data/gfx40/it-ring.png
   trunk/data/gfx48/fg-blackball.png
   trunk/data/gfx48/fg-whiteball-small.png
   trunk/data/gfx48/fg-whiteball.png
   trunk/data/gfx48/fl-bluegreenx.png
   trunk/data/gfx48/fl-leaves.png
   trunk/data/gfx48/inv-blackball.png
   trunk/data/gfx48/inv-whiteball.png
   trunk/data/gfx48/it-banana.png
   trunk/data/gfx48/it-cherry.png
   trunk/data/gfx48/it-key.png
   trunk/data/gfx48/it-pin.png
   trunk/data/gfx48/it-ring.png
   trunk/data/gfx48/sh-blackball.png
   trunk/data/gfx48/sh-brake.png
   trunk/data/gfx48/sh-floating.png
   trunk/data/gfx48/sh-glass.png
   trunk/data/gfx48/sh-grate1.png
   trunk/data/gfx48/sh-grate2.png
   trunk/data/gfx48/sh-grate3.png
   trunk/data/gfx48/sh-puzzle1.png
   trunk/data/gfx48/sh-round.png
   trunk/data/gfx48/sh-round2-growing.png
   trunk/data/gfx48/sh-round2.png
   trunk/data/gfx48/sh-shogun1.png
   trunk/data/gfx48/sh-shogun2.png
   trunk/data/gfx48/sh-shogun4.png
   trunk/data/gfx48/sh-solid.png
   trunk/data/gfx48/sh-white4.png
   trunk/data/gfx48/sh-whiteball-small.png
   trunk/data/models-2d.lua
   trunk/data/models.lua
Log:
-> Added the new gfx from Jennifer Robertson
--> Improved items and balls (only gfx48)
--> First 64px tiles

-> Cleaned up models.lua and models-2d.lua
--> removed fl-rock{1,2} in favour of fl-rock
--> fl-bluegreen[x] with two tilemodels each
--> splited stones.png in its parts
--> finally removed gfx for unsupported fl-ice_001



Added: trunk/attic/gfx-templates/banana.psd
===================================================================
(Binary files differ)


Property changes on: trunk/attic/gfx-templates/banana.psd
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/attic/gfx-templates/cherry.psd
===================================================================
(Binary files differ)


Property changes on: trunk/attic/gfx-templates/cherry.psd
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/attic/gfx-templates/key.psd
===================================================================
(Binary files differ)


Property changes on: trunk/attic/gfx-templates/key.psd
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/attic/gfx-templates/pin.psd
===================================================================
(Binary files differ)


Property changes on: trunk/attic/gfx-templates/pin.psd
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/attic/gfx-templates/ring.psd
===================================================================
(Binary files differ)


Property changes on: trunk/attic/gfx-templates/ring.psd
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Modified: trunk/configure.ac
===================================================================
--- trunk/configure.ac	2007-04-14 15:11:51 UTC (rev 690)
+++ trunk/configure.ac	2007-04-15 21:45:05 UTC (rev 691)
@@ -346,6 +346,7 @@
            data/gfx32/Makefile
            data/gfx40/Makefile
            data/gfx48/Makefile
+           data/gfx64/Makefile
            data/levels/Makefile
            data/levels/enigma_tutorial/Makefile
            data/levels/enigma_i/Makefile

Modified: trunk/data/Makefile.am
===================================================================
--- trunk/data/Makefile.am	2007-04-14 15:11:51 UTC (rev 690)
+++ trunk/data/Makefile.am	2007-04-15 21:45:05 UTC (rev 691)
@@ -1,4 +1,4 @@
-SUBDIRS = gfx fonts schemas levels sound gfx32 gfx40 gfx48 
+SUBDIRS = gfx fonts schemas levels sound gfx32 gfx40 gfx48 gfx64
 
 pkgdata_DATA = \
 	enigma_conf.lua \

Deleted: trunk/data/gfx32/fl-bluegreen2.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx32/fl-bluegreenx.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx32/fl-bluegreenx2.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx32/fl-ice_001.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx32/fl-leaves.png
===================================================================
(Binary files differ)

Added: trunk/data/gfx32/fl-rock.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx32/fl-rock.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Deleted: trunk/data/gfx32/fl-rock1.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx32/fl-rock2.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx32/it-banana.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx32/it-brush.png.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx32/it-cherry.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx32/it-key.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx32/it-pin.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx32/it-ring.png
===================================================================
(Binary files differ)

Added: trunk/data/gfx32/st-beads.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx32/st-beads.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx32/st-black1.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx32/st-black1.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx32/st-black2.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx32/st-black2.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx32/st-black3.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx32/st-black3.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx32/st-black4.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx32/st-black4.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx32/st-block.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx32/st-block.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Deleted: trunk/data/gfx32/stones.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx40/fl-bluegreen2.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx40/fl-bluegreenx.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx40/fl-bluegreenx2.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx40/fl-ice_001.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx40/fl-leaves.png
===================================================================
(Binary files differ)

Added: trunk/data/gfx40/fl-rock.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx40/fl-rock.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Deleted: trunk/data/gfx40/fl-rock1.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx40/fl-rock2.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx40/it-banana.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx40/it-cherry.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx40/it-key.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx40/it-pin.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx40/it-ring.png
===================================================================
(Binary files differ)

Added: trunk/data/gfx40/st-beads.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx40/st-beads.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx40/st-black1.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx40/st-black1.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx40/st-black2.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx40/st-black2.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx40/st-black3.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx40/st-black3.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx40/st-black4.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx40/st-black4.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx40/st-block.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx40/st-block.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Deleted: trunk/data/gfx40/stones.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx48/fg-blackball.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx48/fg-whiteball-small.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx48/fg-whiteball.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx48/fl-bluegreen2.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx48/fl-bluegreenx.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx48/fl-bluegreenx2.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx48/fl-ice_001.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx48/fl-leaves.png
===================================================================
(Binary files differ)

Added: trunk/data/gfx48/fl-rock.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx48/fl-rock.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Deleted: trunk/data/gfx48/fl-rock1.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx48/fl-rock2.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx48/inv-blackball.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx48/inv-whiteball.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx48/it-banana.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx48/it-cherry.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx48/it-key.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx48/it-pin.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx48/it-ring.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx48/sh-blackball.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx48/sh-brake.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx48/sh-floating.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx48/sh-glass.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx48/sh-grate1.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx48/sh-grate2.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx48/sh-grate3.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx48/sh-puzzle1.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx48/sh-round.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx48/sh-round2-growing.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx48/sh-round2.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx48/sh-shogun1.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx48/sh-shogun2.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx48/sh-shogun4.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx48/sh-solid.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx48/sh-white4.png
===================================================================
(Binary files differ)

Modified: trunk/data/gfx48/sh-whiteball-small.png
===================================================================
(Binary files differ)

Added: trunk/data/gfx48/st-beads.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx48/st-beads.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx48/st-black1.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx48/st-black1.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx48/st-black2.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx48/st-black2.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx48/st-black3.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx48/st-black3.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx48/st-black4.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx48/st-black4.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx48/st-block.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx48/st-block.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Deleted: trunk/data/gfx48/stones.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx64
___________________________________________________________________
Name: svn:ignore
   + Makefile.in
Makefile


Added: trunk/data/gfx64/Makefile.am
===================================================================
--- trunk/data/gfx64/Makefile.am	2007-04-14 15:11:51 UTC (rev 690)
+++ trunk/data/gfx64/Makefile.am	2007-04-15 21:45:05 UTC (rev 691)
@@ -0,0 +1,3 @@
+pkgdatadir = $(datadir)/@PACKAGE@/gfx64
+pkgdata_DATA = $(wildcard $(srcdir)/*.png $(srcdir)/*.jpg)
+EXTRA_DIST = $(pkgdata_DATA)


Property changes on: trunk/data/gfx64/Makefile.am
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/data/gfx64/it-banana.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx64/it-banana.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx64/it-cherry.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx64/it-cherry.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx64/it-key.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx64/it-key.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx64/it-pin.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx64/it-pin.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/data/gfx64/it-ring.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx64/it-ring.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Modified: trunk/data/models-2d.lua
===================================================================
--- trunk/data/models-2d.lua	2007-04-14 15:11:51 UTC (rev 690)
+++ trunk/data/models-2d.lua	2007-04-15 21:45:05 UTC (rev 691)
@@ -18,537 +18,476 @@
 ------------------------------------------------------------------------
 
 -- This file defines the models used in Enigma.
-
 dofile(FindDataFile("models.lua"))
 
-def_image("dummy")
-def_image("invisible")
+DefImage("dummy")
+DefImage("invisible")
 
-------------------------------------------------------------------------
--- padding is calculated as:
--- padding = (1.25 - 2*Actorradius)/2
+--------------------------------------------------------------------------------
+--                                 ACTOR MODELS                               --
+--------------------------------------------------------------------------------
+Progress(0, "Loading actor models")
 
-function SpriteImages(spriteimg, n, offsetfactor, padding)
-    local factor = offsetfactor or 0.5
-    local offset = -SpriteSize * factor
-    local pad = (padding or 0) * TileSize
-    return def_subimages(spriteimg,
-                         {h = n, imgw=SpriteSize, imgh=SpriteSize,
-                             xoff = offset, yoff = offset, padding=pad})
-end
+------------------------
+-- ball-shaped actors --
+------------------------
 
-function SpriteImage(spriteimg, offsetfactor, padding)
-    local factor = offsetfactor or 0.5
-    local offset = -SpriteSize * factor
-    local padding = (padding or 0) * TileSize
-    return def_image(spriteimg, {xoff = offset, yoff = offset, padding=padding})
-end
+-- ac-blackball and ac-whiteball--
+do
+    local images,frames,shadows
 
-function SpriteWithShadow()
+    -- Normal Blackball
+    images = SpriteImages("fg-blackball", 2, 0.5, 0.32)
+    shadows = SpriteImage("sh-blackball", 0.4, 0.29)
+    DefShModel("ac-blackball", "fg-blackball1", "sh-blackball")
+    DefShModel("ac-blackball-shine", "fg-blackball2", "sh-blackball")
 
-end
+    -- Normal Whiteball
+    -- Use shadow from black ball
+    DefAlias("sh-whiteball", "sh-blackball")
+    images = SpriteImages("fg-whiteball", 2, 0.5, 0.32)
+    DefShModel("ac-whiteball", "fg-whiteball1", "sh-whiteball")
+    DefShModel("ac-whiteball-shine", "fg-whiteball2", "sh-whiteball")
 
-function SpriteAnim(name, images, shadows, framelen, loop)
-    local frames={}
-    local nframes = getn(images)
-    for i=1,getn(images) do
-        def_shmodel(name..i, images[i], shadows[mod (i, getn(shadows))] )
-        table.insert(frames, name..i)
-    end
-    def_anim (name, buildframes(frames, framelen), loop)
-end
+    -- Falling Blackball
+    images = SpriteImages("ac-blackball-fall", 10)
+    frames = ComposeFrames(images,{70,65,60,55,50,50,50,50,50,50,50})
+    DefAnim("ac-blackball-fall", frames)
+    DefAlias("ac-blackball-fallen", "invisible")
 
-function Sprite(descr)
-    local imgfile = descr.imgfile or descr.name
-    local loop    = descr.loop or false
-    local img     = SpriteImages(imgfile, descr.nimages, 0.5, descr.padding)
-    def_anim(descr.name, buildframes(img, descr.framelen), loop)
-end
+    -- Appearing / disappearing Blackball
+    -- use the images from falling
+    DefAnim("ac-blackball-appear", ReverseFrames(BuildFrames(images, 25)))
+    DefAnim("ac-blackball-disappear", BuildFrames(images, 25))
 
---------------------------------------------------------------------------------
---                                 ACTOR MODELS                               --
---------------------------------------------------------------------------------
-Progress(0, "Loading sprite models")
+    -- Falling Whiteball
+    images = SpriteImages("ac-whiteball-fall", 10)
+    frames = ComposeFrames(images,{70,65,60,55,50,50,50,50,50,50,50})
+    DefAnim("ac-whiteball-fall", frames)
+    DefAlias("ac-whiteball-fallen", "invisible")
 
-------------------
--- Spinning top --
-------------------
-do
-    local img=SpriteImages("fg-top", 9, 0.5, 0.3)
-    SpriteImage("sh-top", 0.4, 0.3)
+    -- Appearing / disappearing Whiteball
+    -- use the images from falling
+    DefAnim("ac-whiteball-appear", ReverseFrames(BuildFrames(images, 25)))
+    DefAnim("ac-whiteball-disappear", BuildFrames(images, 25))
 
-    frames={}
-    for i=1,9 do
-        def_shmodel("ac-top"..i, img[i], "sh-top")
-        table.insert(frames, "ac-top"..i)
+    -- Jumping Blackball
+    images  = SpriteImages("ac-blackball-jump", 4)
+    shadows = SpriteImages("sh-blackball-jump", 4, 0.4)
+    frames  = {}
+    for i=1,4 do
+        DefShModel("bb-jump"..i, images[i], shadows[i])
+        table.insert(frames, "bb-jump"..i)
     end
-    def_anim("ac-top", buildframes(frames, 25), true)
-end
+    DefAnim("ac-blackball-jump", PingPong(BuildFrames(frames, 70)))
 
------------
--- Rotor --
------------
-do
-    local fg=SpriteImages("fg-rotor",9)
-    local bg=SpriteImages("sh-rotor", 9, 0.4)
+    -- Jumping Whiteball
+    -- Use shadow from black ball
+    images  = SpriteImages("ac-whiteball-jump", 4)
+    frames  = {}
+    for i=1,4 do
+        DefShModel("wb-jump"..i, images[i], shadows[i])
+        table.insert(frames, "wb-jump"..i)
+    end
+    DefAnim("ac-whiteball-jump", PingPong(BuildFrames(frames, 70)))
 
-    frames={}
-    for i=1,9 do
-        def_shmodel("ac-rotor"..i, fg[i], bg[i])
-        table.insert(frames, "ac-rotor"..i)
+    -- Sinking Blackball
+    shadows = SpriteImages("sh-blackball-sink", 7, 0.4)
+    images = SpriteImages("fg-blackball-sink", 7)
+    for i=1,table.getn(images) do
+        DefShModel("ac-blackball-sink"..(i-1), images[i], shadows[i])
     end
-    def_anim("ac-rotor", buildframes(frames, 30), true)
-end
+    DefAlias("ac-blackball-sunk", "invisible")
 
------------
--- Horse --
------------
-do
-    SpriteImage ("fg-horse",0.5,0.18)
-    SpriteImage ("sh-horse", 0.4)
-    def_shmodel ("ac-horse", "fg-horse", "sh-horse")
+    -- Sinking Whiteball
+    -- Use shadow from black ball
+    images = SpriteImages("fg-whiteball-sink", 7)
+    for i=1,table.getn(images) do
+        DefShModel("ac-whiteball-sink"..(i-1), images[i], shadows[i])
+    end
+    DefAlias("ac-whiteball-sunk", "invisible")
+
+    -- Shattering Blackball
+    Sprite({name="ac-blackball-shatter", nimages=5, framelen=60})
+    DefAlias("ac-blackball-shattered", "ac-blackball-shatter5")
+
+    -- Shattering Whiteball
+    Sprite({name="ac-whiteball-shatter", nimages=5, framelen=60})
+    DefAlias("ac-whiteball-shattered", "ac-whiteball-shatter5")
 end
 
-----------------------
--- Small white ball --
-----------------------
+-- ac-whiteball-small --
 do
-    local fg,img
+    local images, frames, shadows
 
     -- Normal
     SpriteImage ("sh-whiteball-small", 0.4, 0.41)
-    SpriteImage ("fg-whiteball-small", 0.5, 0.43) 
-    def_shmodel("ac-whiteball-small", "fg-whiteball-small", "sh-whiteball-small")
-    def_alias ("ac-whiteball-small-shine", "ac-whiteball-small")
+    SpriteImage ("fg-whiteball-small", 0.5, 0.43)
+    DefShModel("ac-whiteball-small", "fg-whiteball-small", "sh-whiteball-small")
+    DefAlias ("ac-whiteball-small-shine", "ac-whiteball-small")
 
     -- Falling
-    img=SpriteImages ("ac-whiteball-small-fall", 5, 0.5, 0.43)
-    table.insert(img, "invisible")
-    def_anim("ac-whiteball-small-fall", composeframes(img,{70,65,60,55,50,30}))
-    def_alias("ac-whiteball-small-fallen", "invisible")
+    images = SpriteImages ("ac-whiteball-small-fall", 5, 0.5, 0.43)
+    table.insert(images, "invisible")
+    DefAnim("ac-whiteball-small-fall", ComposeFrames(images,{70,65,60,55,50,30}))
+    DefAlias("ac-whiteball-small-fallen", "invisible")
 
     -- Appearing / disappearing
-    def_anim("ac-whiteball-small-appear", reverseframes(buildframes(img, 25)))
-    def_anim("ac-whiteball-small-disappear", buildframes(img, 25))
+    -- use the images from falling
+    DefAnim("ac-whiteball-small-appear", ReverseFrames(BuildFrames(images, 25)))
+    DefAnim("ac-whiteball-small-disappear", BuildFrames(images, 25))
 
-    -- Shattering
-    img=SpriteImages ("ac-whiteball-small-shatter", 5)
-    def_anim("ac-whiteball-small-shatter", buildframes(img, 60))
-    SpriteImage ("ac-whiteball-small-shattered")
-
-
-    -- sinking
-    def_alias ("ac-whiteball-small-sink0", "ac-whiteball-small-fall1")
-    def_alias ("ac-whiteball-small-sink1", "ac-whiteball-small-fall2")
-    def_alias ("ac-whiteball-small-sink2", "ac-whiteball-small-fall3")
-    def_alias ("ac-whiteball-small-sink3", "ac-whiteball-small-fall4")
-    def_alias ("ac-whiteball-small-sink4", "ac-whiteball-small-fall5")
-    def_alias ("ac-whiteball-small-sink5", "ac-whiteball-small-fall5")
-    def_alias ("ac-whiteball-small-sink6", "ac-whiteball-small-fall5")
-    def_alias ("ac-whiteball-small-sunk", "invisible")
-end
-
--- Jumping small balls --
-do
-    namelist = SpriteImages("ac-whiteball-small-jump", 4)
-    shadows  = SpriteImages("sh-whiteball-small-jump", 4, 0.4)
-    frames   = {}
+    -- Jumping
+    images  = SpriteImages("ac-whiteball-small-jump", 4)
+    shadows = SpriteImages("sh-whiteball-small-jump", 4, 0.4)
+    frames  = {}
     for i=1,4 do
-        def_shmodel("sb-jump"..i, namelist[i], shadows[i])
+        DefShModel("sb-jump"..i, images[i], shadows[i])
         table.insert(frames, "sb-jump"..i)
     end
-    def_anim("ac-whiteball-small-jump", pingpong(buildframes(frames, 70)))
-end
+    DefAnim("ac-whiteball-small-jump", PingPong(BuildFrames(frames, 70)))
 
-def_alias("ac-killerball", "ac-whiteball-small")
+    -- sinking
+    DefAlias ("ac-whiteball-small-sink0", "ac-whiteball-small-fall1")
+    DefAlias ("ac-whiteball-small-sink1", "ac-whiteball-small-fall2")
+    DefAlias ("ac-whiteball-small-sink2", "ac-whiteball-small-fall3")
+    DefAlias ("ac-whiteball-small-sink3", "ac-whiteball-small-fall4")
+    DefAlias ("ac-whiteball-small-sink4", "ac-whiteball-small-fall5")
+    DefAlias ("ac-whiteball-small-sink5", "ac-whiteball-small-fall5")
+    DefAlias ("ac-whiteball-small-sink6", "ac-whiteball-small-fall5")
+    DefAlias ("ac-whiteball-small-sunk", "invisible")
 
--------------------------
--- Balls (both colors) --
--------------------------
+    -- Shattering
+    images = SpriteImages ("ac-whiteball-small-shatter", 5)
+    DefAnim("ac-whiteball-small-shatter", BuildFrames(images, 60))
+    SpriteImage ("ac-whiteball-small-shattered")
+end
 
--- Shattering
-Sprite{name="ac-blackball-shatter", nimages=5, framelen=60}
-Sprite{name="ac-whiteball-shatter", nimages=5, framelen=60}
-
--- Sinking
+-- ac-killerball --
 do
-    local img, sh
-
-    sh = SpriteImages("sh-blackball-sink", 7, 0.4)
-    img = SpriteImages("fg-blackball-sink", 7)
-    for i=1,getn(img) do
-        def_shmodel("ac-blackball-sink"..(i-1), img[i], sh[i])
-    end
-    def_alias("ac-blackball-sunk", "invisible")
-
-    img=SpriteImages("fg-whiteball-sink", 7)
-    for i=1,getn(img) do
-        def_shmodel("ac-whiteball-sink"..(i-1), img[i], sh[i])
-    end
-    def_alias("ac-whiteball-sunk", "invisible")
+    DefAlias("ac-killerball", "ac-whiteball-small")
 end
 
-
-----------------
--- Black ball --
-----------------
+-- Marbles in inventory  --
 do
-    local img,f,sh
+    DefImage("inv-blackball")
+    DefImage("inv-whiteball")
+end
 
-    -- Normal
-    sh = SpriteImage("sh-blackball", 0.4, 0.29)
-    img = SpriteImages("fg-blackball", 2, 0.5, 0.32)
-    def_shmodel("ac-blackball", "fg-blackball1", "sh-blackball")
-    def_shmodel("ac-blackball-shine", "fg-blackball2", "sh-blackball")
+----------------------------
+-- not ball-shaped actors --
+----------------------------
 
-    -- Falling
-    img=SpriteImages("ac-blackball-fall", 10)
-    f=composeframes(img,{70,65,60,55,50,50,50,50,50,50,50})
-    def_anim("ac-blackball-fall", f)
-    def_alias("ac-blackball-fallen", "invisible")
-
-    -- Appearing / disappearing
-    def_anim("ac-blackball-appear", reverseframes(buildframes(img, 25)))
-    def_anim("ac-blackball-disappear", buildframes(img, 25))
-
-    def_alias("ac-blackball-shattered", "ac-blackball-shatter5")
+-- ac-bug --
+do
+    SpriteImage("fg-bug",0.5,0.44)
+    DefShModel("ac-bug", "fg-bug", "sh-whiteball-small")
 end
 
-
-
-----------------
--- White ball --
-----------------
-
+-- ac-cannonball --
 do
-    local img,f
+    DefAlias("ac-cannonball", "ac-blackball-jump")
+end
 
-    -- Normal
-    def_alias("sh-whiteball", "sh-blackball")
-    img=SpriteImage ("fg-whiteball", 0.5, 0.32)
---    def_image("fg-wb", {filename="ac-whiteball", xoff=-9, yoff=-9})
-    def_shmodel("ac-whiteball", "fg-whiteball", "sh-whiteball")
-    def_alias("ac-whiteball-shine", "ac-whiteball")
-
-    -- Falling
-    img=SpriteImages("ac-whiteball-fall", 10)
-    f=composeframes(img,{70,65,60,55,50,50,50,50,50,50,50})
-    def_anim("ac-whiteball-fall", f)
-    def_alias("ac-whiteball-fallen", "invisible")
-
-    -- Appearing / disappearing
-    def_anim("ac-whiteball-appear", reverseframes(buildframes(img, 25)))
-    def_anim("ac-whiteball-disappear", buildframes(img, 25))
-
-    -- Shattering
-
-    def_alias("ac-whiteball-shattered", "ac-whiteball-shatter5")
+-- ac-horse --
+do
+    SpriteImage("fg-horse",0.5,0.18)
+    SpriteImage("sh-horse", 0.4)
+    DefShModel("ac-horse", "fg-horse", "sh-horse")
 end
 
--- Jumping normal balls --
+-- ac-rotor --
 do
-    namelist = SpriteImages("ac-blackball-jump", 4)
-    shadows  = SpriteImages("sh-blackball-jump", 4, 0.4)
-    frames   = {}
-    for i=1,4 do
-        def_shmodel("bb-jump"..i, namelist[i], shadows[i])
-        table.insert(frames, "bb-jump"..i)
-    end
-    def_anim("ac-blackball-jump", pingpong(buildframes(frames, 70)))
+    local fg = SpriteImages("fg-rotor",9)
+    local bg = SpriteImages("sh-rotor", 9, 0.4)
 
-    namelist = SpriteImages("ac-whiteball-jump", 4)
-    frames   = {}
-    for i=1,4 do
-        def_shmodel("wb-jump"..i, namelist[i], shadows[i])
-        table.insert(frames, "wb-jump"..i)
+    frames = {}
+    for i=1,9 do
+        DefShModel("ac-rotor"..i, fg[i], bg[i])
+        table.insert(frames, "ac-rotor"..i)
     end
-    def_anim("ac-whiteball-jump", pingpong(buildframes(frames, 70)))
+    DefAnim("ac-rotor", BuildFrames(frames, 30), true)
 end
 
-----------------
--- Cannonball --
-----------------
-
-def_alias ("ac-cannonball", "ac-blackball-jump")
-
-
-
----------
--- Bug --
----------
+-- ac-top --
 do
-    SpriteImage("fg-bug",0.5,0.44)
-    def_shmodel("ac-bug", "fg-bug", "sh-whiteball-small")
+    local fg = SpriteImages("fg-top", 9, 0.5, 0.3)
+    local bg = SpriteImage("sh-top", 0.4, 0.3)
+
+    frames = {}
+    for i=1,9 do
+        DefShModel("ac-top"..i, fg[i], bg)
+        table.insert(frames, "ac-top"..i)
+    end
+    DefAnim("ac-top", BuildFrames(frames, 25), true)
 end
 
--- Marbles in inventory  --
-def_image("inv-blackball")
-def_image("inv-whiteball")
-
-
 --------------------------------------------------------------------------------
 --                                Floor models                                --
 --------------------------------------------------------------------------------
-Progress(10, "Loading floor models")
+Progress(15, "Loading floor models")
 
-function def_floors(floorlist)
-    for i,name in pairs(floorlist) do
-	def_image(name)
-    end
+------------------------
+-- single tile floors --
+------------------------
+do
+    floorlist = {
+        "fl-abyss",
+        "fl-acblack",
+        "fl-acwhite",
+        "fl-black",
+        "fl-bluegreen",
+        "fl-darkgray",
+        "fl-dummy",
+        "fl-dunes",
+        "fl-floor_001",
+        "fl-ice",
+        "fl-inverse",
+        "fl-inverse2",
+        "fl-light",
+        "fl-lightgray",
+        "fl-nomouse",
+        "fl-normal",
+        "fl-sand",
+        "fl-stone",
+        "fl-springboard",
+        "fl-trigger",
+        "fl-white",
+    }
+
+    DefImages(floorlist)
 end
 
-function def_randfloor(name, imagelist)
-    def_floors(imagelist)
-    display.DefineRandModel(name, getn(imagelist), imagelist)
+-----------------------------------------
+-- Floors with multiple (random) tiles --
+-----------------------------------------
+do
+    DefSubimages("fl-gradient2", {w=6, h=4, modelname="fl-gradient"})
+
+    DefRandFloorSi("fl-bluegray", 4)
+    DefRandFloorSi("fl-bluegreenx", 2)
+    DefRandFloorSi("fl-brick", 3)
+    DefRandFloorSi("fl-bumps", 2,2)
+    DefRandFloorSi("fl-concrete", 4)
+    DefRandFloorSi("fl-gravel", 4)
+    DefRandFloorSi("fl-gray", 5)
+    DefRandFloorSi("fl-hay", 4)
+    DefRandFloorSi("fl-himalaya", 4)
+    DefRandFloorSi("fl-marble", 4)
+    DefRandFloorSi("fl-metal", 6)
+    DefRandFloorSi("fl-mortar", 2, 2)
+    DefRandFloorSi("fl-plank", 4)
+    DefRandFloorSi("fl-red", 4)
+    DefRandFloorSi("fl-rock", 2)
+    DefRandFloorSi("fl-rough", 5)
+    DefRandFloorSi("fl-rough-blue", 4)
+    DefRandFloorSi("fl-rough-red", 4)
+    DefRandFloorSi("fl-sahara", 4)
+    DefRandFloorSi("fl-samba", 2)
+    DefRandFloorSi("fl-space", 3,2)
+    DefRandFloorSi("fl-stwood", 2)
+    DefRandFloorSi("fl-swamp", 4)
+    DefRandFloorSi("fl-tigris", 4)
+    DefRandFloorSi("fl-water", 4)
+    DefRandFloorSi("fl-woven", 5)
 end
 
--- _si for _subimage
-function def_randfloor_si(name, height, width)
-    imagelist=def_subimages(name, {h=height, w=width})
-    display.DefineRandModel(name, getn(imagelist), imagelist)
+-- leaves --
+do
+    DefSubimages("fl-leaves", {w=10, h=2, modelname="fl-leavesx"})
+    DefRandFloor("fl-leaves", {"fl-leavesx1", "fl-leavesx2", "fl-leavesx3", "fl-leavesx4"})
+    DefRandFloor("fl-leavesb", {"fl-leavesx5", "fl-leavesx6", "fl-leavesx7", "fl-leavesx8"})
+    DefAlias("fl-leavesc1", "fl-leavesx9")
+    DefAlias("fl-leavesc2", "fl-leavesx10")
+    DefAlias("fl-leavesc3", "fl-leavesx11")
+    DefAlias("fl-leavesc4", "fl-leavesx12")
+    DefAlias("fl-leavesd1", "fl-leavesx13")
+    DefAlias("fl-leavesd2", "fl-leavesx14")
+    DefAlias("fl-leavesd3", "fl-leavesx15")
+    DefAlias("fl-leavesd4", "fl-leavesx16")
+    DefAlias("fl-leavese1", "fl-leavesx17")
+    DefAlias("fl-leavese2", "fl-leavesx18")
+    DefAlias("fl-leavese3", "fl-leavesx19")
+    DefAlias("fl-leavese4", "fl-leavesx20")
 end
 
---if options.WizardMode > 0 then
---    def_subimages("fl-gradient-wiz", {modelname="fl-gradient",w=6, h=4})
---else
-def_subimages("fl-gradient2", {w=6, h=4, modelname="fl-gradient"})
---end
-
+-- wooden floor --
 do
-    def_subimages("fl-leaves", {w=10, h=2, modelname="fl-leavesx"})
-    display.DefineRandModel("fl-leaves", 4, {"fl-leavesx1", "fl-leavesx2", "fl-leavesx3", "fl-leavesx4"})
-    display.DefineRandModel("fl-leavesb", 4, {"fl-leavesx5", "fl-leavesx6", "fl-leavesx7", "fl-leavesx8"})
-    def_alias("fl-leavesc1", "fl-leavesx9")
-    def_alias("fl-leavesc2", "fl-leavesx10")
-    def_alias("fl-leavesc3", "fl-leavesx11")
-    def_alias("fl-leavesc4", "fl-leavesx12")
-    def_alias("fl-leavesd1", "fl-leavesx13")
-    def_alias("fl-leavesd2", "fl-leavesx14")
-    def_alias("fl-leavesd3", "fl-leavesx15")
-    def_alias("fl-leavesd4", "fl-leavesx16")
-    def_alias("fl-leavese1", "fl-leavesx17")
-    def_alias("fl-leavese2", "fl-leavesx18")
-    def_alias("fl-leavese3", "fl-leavesx19")
-    def_alias("fl-leavese4", "fl-leavesx20")
+    DefSubimages("fl-wood", {w=1, h=4, modelname="fl-woodx"})
+    DefRandFloor("fl-wood", {"fl-woodx1", "fl-woodx2", "fl-woodx3", "fl-woodx4"})
+    DefRandFloor("fl-wood1", {"fl-woodx3", "fl-woodx4"})
+    DefRandFloor("fl-wood2", {"fl-woodx1", "fl-woodx2"})
 end
 
--- To get different wood tiles with horizontal or vertical slats.
--- Each floortype has got 2 random images.
+--------------------------
+-- Simple floor aliases --
+--------------------------
 do
-    def_subimages("fl-wood", {w=1, h=4, modelname="fl-woodx"})
-    display.DefineRandModel("fl-wood", 4, {"fl-woodx1", "fl-woodx2", "fl-woodx3", "fl-woodx4"})
-    display.DefineRandModel("fl-wood1", 2, {"fl-woodx3", "fl-woodx4"})
-    display.DefineRandModel("fl-wood2", 2, {"fl-woodx1", "fl-woodx2"})
+    DefAlias("fl-abyss_fake", "fl-abyss")
+    DefAlias("fl-normal_x", "fl-normal")
+    DefAlias("fl-rough_medium", "fl-rough")
+    DefAlias("fl-rough_slow", "fl-rough")
+    DefAlias("fl-space-force", "fl-space")
 end
 
-def_randfloor("fl-rock", {"fl-rock1", "fl-rock2"})
-def_floors{"fl-abyss"}
-def_alias("fl-abyss_fake", "fl-abyss")
-def_floors{"fl-dunes", "fl-sand", "fl-bluegreen", "fl-bluegreenx"}
-def_floors{"fl-inverse", "fl-inverse2", "fl-white", "fl-black", "fl-acwhite", "fl-acblack"}
-def_floors{"fl-springboard"}
-def_image("fl-normal")
-def_randfloor_si("fl-hay", 4)
-def_floors{"fl-floor_001"}
-def_floors{"fl-ice"}
-def_floors{"fl-stone"}
-def_alias("fl-normal_x", "fl-normal")
-def_floors{"fl-dummy"}
-def_floors{"fl-light", "fl-lightgray", "fl-darkgray"}
-def_floors{"fl-trigger"}
-def_randfloor_si("fl-concrete", 4)
-def_randfloor_si("fl-gravel", 4)
-def_randfloor_si("fl-bumps", 2,2)
-def_randfloor_si("fl-mortar", 2, 2)
+----------------------
+-- Floor animations --
+----------------------
 
-def_randfloor_si("fl-brick", 3)
+-- bridges --
+do
+    DefImage("fl-bridgea-open")
+    DefImage("fl-bridgea-closed")
+    local namelist=DefSubimages("fl-bridgea", {h=10})
+    local frames = BuildFrames(namelist,70)
+    DefAnim("fl-bridgea-opening", ReverseFrames(frames))
+    DefAnim("fl-bridgea-closing", frames)
+end
 
-def_randfloor_si("fl-space", 3,2)
-def_alias("fl-space-force", "fl-space")
+do
+    DefImage("fl-bridgex-open")
+    DefImage("fl-bridgex-closed")
+    local namelist=DefSubimages("fl-bridgex", {h=9})
+    local frames = BuildFrames(namelist,70)
+    DefAnim("fl-bridgex-opening", frames)
+    DefAnim("fl-bridgex-closing", ReverseFrames(frames))
+end
 
-def_randfloor_si("fl-rough", 5)
-def_alias("fl-rough_medium", "fl-rough")
-def_alias("fl-rough_slow", "fl-rough")
-def_randfloor_si("fl-gray", 5)
-def_randfloor_si("fl-metal", 6)
-def_randfloor_si("fl-plank", 4)
-def_randfloor_si("fl-water", 4)
-def_randfloor_si("fl-swamp", 4)
-def_randfloor_si("fl-woven", 5)
-def_randfloor_si("fl-marble", 4)
---def_subimages("fl-stwood", {h=2})
-def_randfloor_si("fl-stwood", 2)
-def_randfloor_si("fl-bluegray", 4)
-def_randfloor_si("fl-red", 4)
-def_randfloor_si("fl-rough-blue", 4)
-def_randfloor_si("fl-rough-red", 4)
-def_randfloor_si("fl-sahara", 4)
-def_randfloor_si("fl-tigris", 4)
-def_randfloor_si("fl-samba", 2)
-def_randfloor_si("fl-himalaya", 4)
-def_floors{"fl-nomouse"}
+do
+    DefImage("fl-bridgey-open")
+    DefImage("fl-bridgey-closed")
+    local namelist=DefSubimages("fl-bridgey", {h=9})
+    local frames = BuildFrames(namelist,70)
+    DefAnim("fl-bridgey-opening", frames)
+    DefAnim("fl-bridgey-closing", ReverseFrames(frames))
+end
 
---
--- Bridges
---
-def_image("fl-bridgea-open")
-def_image("fl-bridgea-closed")
-namelist=def_subimages("fl-bridgea", {h=10})
-frames = buildframes(namelist,70)
-def_anim("fl-bridgea-opening", reverseframes(frames))
-def_anim("fl-bridgea-closing", frames)
-
-
-def_image("fl-bridgex-open")
-def_image("fl-bridgex-closed")
-namelist=def_subimages("fl-bridgex", {h=9})
-frames = buildframes(namelist,70)
-def_anim("fl-bridgex-opening", frames)
-def_anim("fl-bridgex-closing", reverseframes(frames))
-
-
-def_image("fl-bridgey-open")
-def_image("fl-bridgey-closed")
-namelist=def_subimages("fl-bridgey", {h=9})
-frames = buildframes(namelist,70)
-def_anim("fl-bridgey-opening", frames)
-def_anim("fl-bridgey-closing", reverseframes(frames))
-
 ------------------------
 -- Heating animations --
 ------------------------
+do
+    function heating_animation(basemodel)
+        local images = DefSubimages(basemodel.."-heating", {h=8});
+        local frames = BuildFrames(images, 240)
+        DefAnim(basemodel.."-heating", frames);
+    end
 
-function heating_animation(basemodel)
-    local img = def_subimages(basemodel.."-heating", {h=8});    
-    local f = buildframes(img, 240)
-    def_anim(basemodel.."-heating", f);
+    heating_animation("fl-ice")
+    heating_animation("fl-water")
+    heating_animation("fl-swamp")
 end
 
-heating_animation("fl-ice")
-heating_animation("fl-water")
-heating_animation("fl-swamp")
-
-
 --------------------------------------------------------------------------------
 --                                ITEM MODELS                                 --
 --------------------------------------------------------------------------------
-Progress(20, "Loading item models")
+Progress(25, "Loading item models")
 ------------------------------------------------------
 -- Single-Image-Items, non animated, e.g. it-banana --
 ------------------------------------------------------
 
-itemlist = {
-    "it-bag",
-    "it-banana",
-    "it-blackbomb",
-    "it-blocker",
-    "it-booze",
-    "it-booze-broken",
-    "it-brush",
-    "it-cherry",
-    "it-coin1",
-    "it-coin2",
-    "it-coin4",
-    "it-cross",
-    "it-document",
-    "it-drop",
-    "it-dummy",
-    "it-dynamite",
-    "it-extralife",
-    "it-flagblack",
-    "it-flagwhite",
-    "it-floppy",
-    "it-glasses",
-    "it-glasses-broken",
-    "it-hammer",
-    "it-hill",
-    "it-hollow",
-    "it-hstrip",
-    "it-key",
-    "it-landmine",
-    "it-magicwand",
-    "it-odometer",
-    "it-pencil",
-    "it-pin",
-    "it-ring",
-    "it-rubberband",
-    "it-spade",
-    "it-spoon",
-    "it-squashed",
-    "it-spring1",
-    "it-spring2",
-    "it-surprise",
-    "it-sword",
-    "it-tinyhill",
-    "it-tinyhollow",
-    "it-umbrella",
-    "it-vstrip",
-    "it-weight",
-    "it-whitebomb",
-    "it-wrench"
-}
+do
+    itemlist = {
+        "it-bag",
+        "it-banana",
+        "it-blackbomb",
+        "it-blocker",
+        "it-booze",
+        "it-booze-broken",
+        "it-brush",
+        "it-cherry",
+        "it-coin1",
+        "it-coin2",
+        "it-coin4",
+        "it-cross",
+        "it-document",
+        "it-drop",
+        "it-dummy",
+        "it-dynamite",
+        "it-extralife",
+        "it-flagblack",
+        "it-flagwhite",
+        "it-floppy",
+        "it-glasses",
+        "it-glasses-broken",
+        "it-hammer",
+        "it-hill",
+        "it-hollow",
+        "it-hstrip",
+        "it-key",
+        "it-landmine",
+        "it-magicwand",
+        "it-odometer",
+        "it-pencil",
+        "it-pin",
+        "it-ring",
+        "it-rubberband",
+        "it-spade",
+        "it-spoon",
+        "it-squashed",
+        "it-spring1",
+        "it-spring2",
+        "it-surprise",
+        "it-sword",
+        "it-tinyhill",
+        "it-tinyhollow",
+        "it-umbrella",
+        "it-vstrip",
+        "it-weight",
+        "it-whitebomb",
+        "it-wrench"
+    }
 
-def_images(itemlist)
+    DefImages(itemlist)
 
--- Aliases:
-def_alias("it-key_a", "it-key")
-def_alias("it-key_b", "it-key")
-def_alias("it-key_c", "it-key")
+    DefImage("it-brake", {filename="st-brake"})
+end
 
--- def_alias("it-bridge-oxyd", "invisible")
--- def_alias("it-sensor", "invisible")
--- def_alias("it-inversesensor", "invisible")
+-------------------------
+-- Simple item aliases --
+-------------------------
 
+do
+    DefAlias("it-key_a", "it-key")
+    DefAlias("it-key_b", "it-key")
+    DefAlias("it-key_c", "it-key")
+    -- DefAlias("it-bridge-oxyd", "invisible")
+    -- DefAlias("it-sensor", "invisible")
+    -- DefAlias("it-inversesensor", "invisible")
+end
+
 --------------------------------------------------------------
 -- Multiple-Image-Items, non animated, e.g. it-nurnable-oil --
 --------------------------------------------------------------
 
 -- it-extinguisher --
 do
-    local img = def_subimages("it-extinguisher", {h=3})
-    def_alias("it-extinguisher", img[1])
-    def_alias("it-extinguisher_medium", img[2])
-    def_alias("it-extinguisher_empty", img[3])
+    DefTiles("it-extinguisher", {"it-extinguisher", "it-extinguisher_medium", "it-extinguisher_empty"})
 end
 
 -- Oil --
-def_subimages("it-burnable_oil", {h=4})
+do
+    DefSubimages("it-burnable_oil", {h=4})
+end
 
 -- Laserbeams --
 do
-    local img = def_subimages("it-laser", {h=3})
-    def_alias("it-laserh", img[1])
-    def_alias("it-laserv", img[2])
-    def_alias("it-laserhv", img[3])
+    DefTiles("it-laser", {"it-laserh", "it-laserv", "it-laserhv"})
 end
 
 -- it-pipe --
-DefineTiles("it-pipe", {"it-pipe-e", "it-pipe-s", "it-pipe-es", "it-pipe-sw", "it-pipe-h",
-                        "it-pipe-w", "it-pipe-n", "it-pipe-ne", "it-pipe-wn", "it-pipe-v"})
-
--- it-puller --
 do
-    local img = def_subimages("it-puller", {h=4})
-    def_alias("it-puller-n", img[1])
-    def_alias("it-puller-e", img[2])
-    def_alias("it-puller-s", img[3])
-    def_alias("it-puller-w", img[4])
+    DefTiles("it-pipe", {"it-pipe-e", "it-pipe-s", "it-pipe-es", "it-pipe-sw", "it-pipe-h",
+                            "it-pipe-w", "it-pipe-n", "it-pipe-ne", "it-pipe-wn", "it-pipe-v"})
 end
 
 -- it-trigger --
 do
--- Why does this not work??
---    img = def_subimages("it-trigger", {h=2})
---    def_alias("it-trigger", img[1])
---    def_alias("it-trigger1", img[2])
-    DefineTiles("it-trigger", {"it-trigger","it-trigger1"})
+    DefTiles("it-trigger", {"it-trigger","it-trigger1"})
 end
 
 -- it-yinyang --
 do
-    local img = def_subimages("it-yinyang", {h=2})
-    def_alias("it-yinyang", img[1])
-    def_alias("it-yanying", img[2])
+    DefTiles("it-yinyang", {"it-yinyang", "it-yanying"})
 end
 
 ----------------------------------------
@@ -556,419 +495,664 @@
 ----------------------------------------
 
 -- Burning black bomb --
-img = def_subimages("it-blackbomb-burning", {h=9})
-frames = buildframes(img, 100)
-def_anim("it-blackbomb-burning", frames) --repeat_frames(frames,3,2))
+do
+    local images = DefSubimages("it-blackbomb-burning", {h=9})
+    local frames = BuildFrames(images, 100)
+    DefAnim("it-blackbomb-burning", frames)
+end
 
--- Burning black bomb --
-img = def_subimages("it-whitebomb-burning", {h=9})
-frames = buildframes(img, 100)
-def_anim("it-whitebomb-burning", frames) --repeat_frames(frames,3,2))
+-- Burning white bomb --
+do
+    local images = DefSubimages("it-whitebomb-burning", {h=9})
+    local frames = BuildFrames(images, 100)
+    DefAnim("it-whitebomb-burning", frames)
+end
 
 -- Burning dynamite --
-img = def_subimages("it-dynamite-burning", {h=15})
-frames = buildframes(img, 100)
-def_anim("it-dynamite-burning", frames) --repeat_frames(dyn_frames,3,2))
+do
+    local images = DefSubimages("it-dynamite-burning", {h=15})
+    local frames = BuildFrames(images, 100)
+    DefAnim("it-dynamite-burning", frames)
+end
 
 -- Burning Floor --
 do
-    local img = def_subimages("it-burnable_ignite", {h=8})
-    local frames = buildframes(img, 100)
-    def_anim("it-burnable_ignited", frames)
+    local images = DefSubimages("it-burnable_ignite", {h=8})
+    local frames = BuildFrames(images, 100)
+    DefAnim("it-burnable_ignited", frames)
 
-    img = def_subimages("it-burnable_burning", {h=8})
-    frames = buildframes(img, 100)
-    def_anim("it-burnable_burning", frames)
+    local images = DefSubimages("it-burnable_burning", {h=8})
+    local frames = BuildFrames(images, 100)
+    DefAnim("it-burnable_burning", frames)
 
-    -- Simple items:
-    def_images({"it-burnable_ash", "it-burnable_fireproof"})
-    def_alias("it-burnable", "invisible")
+    -- Simple fire related items:
+    DefImages({"it-burnable_ash", "it-burnable_fireproof"})
+    DefAlias("it-burnable", "invisible")
 end
 
 -- it-coffee --
 do
-    local n = def_subimages("it-coffee", {h=4})
-    local frames = buildframes(n,150)
-    def_anim("it-coffee", frames, true)
+    local images = DefSubimages("it-coffee", {h=4})
+    local frames = BuildFrames(images,150)
+    DefAnim("it-coffee", frames, true)
 end
 
 -- Cracks --
 do
-    namelist = def_subimages("it-crack", {h=8})
-    --frames=buildframes({"it-crack4", "it-crack6", "it-crack7", "it-crack8"},90)
-    frames = buildframes(namelist,50)
-    def_anim("it-debris", frames)
+    local images = DefSubimages("it-crack", {h=8})
+    local frames = BuildFrames(images,50)
+    DefAnim("it-debris", frames)
 
-    frames = buildframes({"it-crack4", "it-crack5"},120)
-    def_anim("it-crack_anim1", frames)
+    local frames = BuildFrames({"it-crack4", "it-crack5"},120)
+    DefAnim("it-crack_anim1", frames)
 
-    frames = buildframes({"it-crack6", "it-crack7", "it-crack8"},120)
-    def_anim("it-crack_anim2", frames)
+    local frames = BuildFrames({"it-crack6", "it-crack7", "it-crack8"},120)
+    DefAnim("it-crack_anim2", frames)
 end
 
 -- it-death --
 do
-    local img = def_subimages("it-death", {h=4})
-    def_alias("it-death", img[1])
-    def_anim("it-death-anim", buildframes(img, 100))
+    local images = DefSubimages("it-death", {h=4})
+    DefAlias("it-death", images[1])
+    DefAnim("it-death-anim", BuildFrames(images, 100))
 end
 
 -- Explosion --
-def_anim_images("expl", {{"expl", 50}})
-def_alias("it-explosion1", "expl")
-def_alias("it-explosion2", "expl")
-def_alias("it-explosion3", "expl")
+do
+    DefAnimImages("expl", {{"expl", 50}})
+    DefAlias("it-explosion1", "expl")
+    DefAlias("it-explosion2", "expl")
+    DefAlias("it-explosion3", "expl")
+end
 
 -- it-magnet --
-def_image("it-magnet-off")
-img = def_subimages("it-magnet-on", {h=5})
-frames = buildframes(img, 100)
-def_anim("it-magnet-on", frames, 1)
+do
+    DefImage("it-magnet-off")
+    local images = DefSubimages("it-magnet-on", {h=5})
+    local frames = BuildFrames(images, 100)
+    DefAnim("it-magnet-on", frames, 1)
+end
 
 -- it-puller --
 do
-    local img = {"it-puller-n", "it-puller-e", "it-puller-s", "it-puller-w"}
-    local frames = buildframes(img, 100)
-    def_anim("it-puller-active", repeatanim(frames, 4), false)
+    local images = {"it-puller-n", "it-puller-e", "it-puller-s", "it-puller-w"}
+    DefTiles("it-puller", images)
+    local frames = BuildFrames(images, 100)
+    DefAnim("it-puller-active", RepeatAnim(frames, 4), false)
 end
 
 -- it-seed --
 do
-    local n = def_subimages("it-seed", {h=5})
-    def_alias("it-seed", "it-seed1")
-    def_alias("it-seed_nowood", "it-seed")
-    def_alias("it-seed_volcano", "it-seed")
+    local images = DefSubimages("it-seed", {h=5})
+    DefAlias("it-seed", "it-seed1")
+    DefAlias("it-seed_nowood", "it-seed1")
+    DefAlias("it-seed_volcano", "it-seed1")
     local frames = {
         "it-seed1", "it-seed2", "it-seed1", "it-seed3", "it-seed1", "it-seed2",
         "it-seed1", "it-seed4", "it-seed5", "it-seed4", "it-seed1",
         "it-seed4", "it-seed5",
     }
-    def_anim("it-seed-growing", buildframes(frames, 120))
+    DefAnim("it-seed-growing", BuildFrames(frames, 120))
 end
 
 -- it-shogun --
-NewAnim("it-shogun-s", {img="it-shogun-small", h=3, speed=160, pingpong=1, loop=1})
-NewAnim("it-shogun-m", {img="it-shogun-med",   h=3, speed=160, pingpong=1, loop=1})
-NewAnim("it-shogun-l", {img="it-shogun-big",   h=3, speed=160, pingpong=1, loop=1})
+do
+    NewAnim("it-shogun-s", {img="it-shogun-small", h=3, speed=160, pingpong=1, loop=1})
+    NewAnim("it-shogun-m", {img="it-shogun-med",   h=3, speed=160, pingpong=1, loop=1})
+    NewAnim("it-shogun-l", {img="it-shogun-big",   h=3, speed=160, pingpong=1, loop=1})
+end
 
 -- it-springboard --
 do
-    local img = {"it-springboard1", "it-springboard2"}
-    DefineTiles ("it-springboard", img)
-    def_alias ("it-springboard", img[1])
-    def_anim("it-springboard_anim", buildframes(reverseframes(img),120))
+    local images = {"it-springboard1", "it-springboard2"}
+    DefTiles ("it-springboard", images)
+    DefAlias ("it-springboard", images[1])
+    DefAnim("it-springboard_anim", BuildFrames(ReverseFrames(images),120))
 end
 
 -- it-vortex --
 do
-    local img = def_subimages("it-vortex", {h=4})
-    def_alias("it-vortex-open", img[1])
-    def_alias("it-vortex-closed", img[4])
+    local images = DefSubimages("it-vortex", {h=4})
+    DefAlias("it-vortex-open", images[1])
+    DefAlias("it-vortex-closed", images[4])
 
-    def_anim("it-vortex-opening", reverseframes(buildframes(img, 100)))
-    def_anim("it-vortex-closing", buildframes(img, 100))
+    DefAnim("it-vortex-opening", ReverseFrames(BuildFrames(images, 100)))
+    DefAnim("it-vortex-closing", BuildFrames(images, 100))
 end
 
 -- it-wormhole --
 do
-    local img = def_subimages("it-wormhole", {h=2})
-    local frames = buildframes(img, 100)
-    def_anim("it-wormhole", frames, true)
-    def_alias("it-wormhole-off", "it-wormhole1")
+    local images = DefSubimages("it-wormhole", {h=2})
+    local frames = BuildFrames(images, 100)
+    DefAnim("it-wormhole", frames, true)
+    DefAlias("it-wormhole-off", "it-wormhole1")
 end
 
 --------------------------------------------------------------------------------
 --                                STONE MODELS                                --
 --------------------------------------------------------------------------------
-Progress(30, "Loading stone models")
+Progress(40, "Loading stone models")
 
 -------------------
 -- Stone shadows --
 -------------------
-def_image("sh-solid")
-def_image("sh-round")
-def_image("sh-round2")
-def_image("sh-grate1")
-def_image("sh-grate2")
-def_image("sh-grate3")
-def_image("sh-glass")
-def_image("sh-white4")
-def_image("sh-puzzle1")
-def_image("sh-brake")
-def_image("sh-floating")
+do
+    DefImage("sh-solid")
+    DefImage("sh-round")
+    DefImage("sh-round2")
+    DefImage("sh-grate1")
+    DefImage("sh-grate2")
+    DefImage("sh-grate3")
+    DefImage("sh-glass")
+    DefImage("sh-white4")
+    DefImage("sh-puzzle1")
+    DefImage("sh-brake")
+    DefImage("sh-floating")
+end
 
--- stone models
-def_stone("st-glass", "sh-glass");
+-------------------
+-- simple stones --
+-------------------
+do
+    DefStone("st-beads", "sh-glass")
+    DefStone("st-black1")
+    DefStone("st-black2")
+    DefStone("st-black3")
+    DefStone("st-black4", "sh-white4")
+    DefStone("st-blackballs")
+    DefStone("st-block")
+    DefStone("st-bluegray", "sh-round")
+    DefStone("st-bluegray_hole", "sh-round", {filename="st-bluegray"})
+    DefStone("st-blue-sand")
+    DefStone("st-brake", "sh-brake")
+    DefStone("st-brick")
+    DefStone("st-brick_magic", nil, {filename="st-brick"})
+    DefStone("st-brownie", "sh-round")
+    DefStone("st-bug")
+    DefStone("st-bumps")
+    DefStone("st-camouflage")
+    DefStone("st-dummy")
+    DefImage("st-easymode")
+    DefStone("st-flhay")
+    DefStone("st-firebreak")
+    DefStone("st-floppy0", "sh-round", {filename="st-floppy1"})
+    DefStone("st-floppy1", "sh-round", {filename="st-floppy2"})
+    DefStone("st-flrock")
+    DefStone("st-glass", "sh-glass");
+    DefStone("st-glass1", "sh-glass")
+    DefStone("st-glass2", "sh-glass")
+    DefStone("st-glass3", "sh-glass")
+    DefStone("st-grate1", "sh-grate1")
+    DefStone("st-grate2", "sh-grate2")
+    DefStone("st-grate3", "sh-grate3")
+    DefStone("st-greenbrown", "sh-round")
+    DefStone("st-key0", "sh-round", {filename="st-key1"})
+    DefStone("st-key1", "sh-round", {filename="st-key2"})
+    DefStone("st-marble", "sh-round")
+    DefStone("st-metal")
+    DefStone("st-redrock")
+    DefStone("st-rock1", "sh-round")
+    DefStone("st-rock2")
+    DefStone("st-rock3")
+    DefStone("st-rock3_cracked")
+    DefStone("st-rock4")
+    DefStone("st-rock5")
+    DefStone("st-rock6")
+    DefStone("st-rock7")
+    DefStone("st-rock8", "sh-round")
+    DefStone("st-rock9", "sh-round")
+    DefStone("st-rock10")
+    DefStone("st-rubberband")
+    DefStone("st-stone1")
+    DefStone("st-stone2")
+    DefStone("st-surprise")
+    DefStone("st-white1")
+    DefStone("st-white2")
+    DefStone("st-white3")
+    DefStone("st-white4", "sh-white4")
+    DefStone("st-whiteballs")
+    DefStone("st-wood_001")
+    DefStone("st-woven")
+    DefStone("st-yellow")
+    DefStone("st-yinyang1")
+    DefStone("st-yinyang2")
+end
 
-def_stone("st-bug")
+---------------------
+-- Animated stones --
+---------------------
 
--- Scissors
+-- st-actorimpulse --
 do
-    def_stone("st-scissors")
-    local n=def_subimages("st-scissors-snip", {h=1})
-    def_anim("st-scissors-snip-anim", buildframes(n, 130))
-    def_solidstone("st-scissors-snip", "st-scissors-snip-anim")
+    namelist = DefSubimages("st-actorimpulse", {h=3})
+    shnamelist = DefSubimages("sh-actorimpulse", {h=3,imgw=ShadowSize,imgh=ShadowSize})
+
+    DefAnim("st-ai-fg", PingPong(BuildFrames(namelist, 30)))
+    DefAnim("st-ai-sh", PingPong(BuildFrames(shnamelist, 30)))
+    DefShModel("st-actorimpulse-anim", "st-ai-fg", "st-ai-sh")
+
+    DefShModel("st-actorimpulse", namelist[1], shnamelist[1])
 end
 
-def_stone("st-rubberband")
+-- st-bigbluesand --
+do
+    DefSubimages("st-bigbluesand", {modelname="st-bigbluesandx",w=4,h=4})
+    for i=1,16 do DefSolidStone("st-bigbluesand"..i, "st-bigbluesandx"..i) end
+end
 
+-- st-bigbrick --
+do
+    DefSubimages("st-bigbrick", {modelname="st-bigbrickx",w=4,h=4})
+    for i=1,16 do DefSolidStone("st-bigbrick"..i, "st-bigbrickx"..i) end
+end
 
+-- st-bolder --
 do
-    local tiles = {
-        "st-disco-light",
-        "st-disco-medium",
-        "st-disco-dark"
-    }
-    map_tiles({h=3},
-              function (i, rect)
-                  local model = tiles[i]
-                  display.DefineSubImage(model, "st-disco", 0,0, rect)
-              end)
+    local img=DefSubimages("st-bolder", {w=4,h=3})
+    local imgfall=DefSubimages("st-bolder-fall", {w=4,h=3})
+
+    function def_bolder(orient, start)
+        local animname="st-bolder"..orient.."a"
+        local frames={img[start], img[start+1], img[start+2]}
+        DefAnim(animname, BuildFrames(frames, 120), false)
+        DefShModel("st-bolder-"..orient, animname, "sh-round")
+
+        animname="st-bolder-"..orient.."-fall-anim"
+        frames={imgfall[start],imgfall[start+1],imgfall[start+2]}
+        DefAnim(animname, BuildFrames(frames, 120), false)
+    end
+
+    def_bolder("n",1)
+    def_bolder("e",4)
+    def_bolder("s",7)
+    def_bolder("w",10)
 end
 
--- other
+-- st-break_*, breakable stones --
+do
+    DefSolidStoneWithAnim ("st-stone_break", 10, 50)
+    DefSolidStoneWithAnim ("st-break_bolder", 10, 50)
+    DefRoundStoneWithAnim ("st-break_acwhite", 10, 50)
+    DefRoundStoneWithAnim ("st-break_acblack", 10, 50)
+    DefRoundStoneWithAnim ("st-break_gray", 10, 50)
+end
 
+-- st-chage-plus, st-charge-zero, st-charge-minus --
 do
---    def_image("stones")
-    local stonetiles={
-        "st-black1#",
-        "st-black2#",
-        "st-black3#",
-        "st-black4#",
-        "st-block#",
-        "st-idontknowwhattonameit2",
-        "st-beads#"
-    }
-    DefineTiles("stones", stonetiles)
+    function def_chargestone(basename)
+        local n=DefSubimages(basename, {h=2})
+        DefSolidStone(basename, n[1])
+        DefAnim(basename.."-animfg", {{n[2], 140}})
+        DefSolidStone(basename.."-anim", basename.."-animfg")
+    end
+
+    def_chargestone("st-chargeplus")
+    def_chargestone("st-chargeminus")
+    def_chargestone("st-chargezero")
 end
 
-def_alias("st-explosion", "expl")
+-- st-chess_black, st-chess_white --
+do
+    function make_chess(colour)
+        local img1 = DefSubimages("st-chess"..colour, {h=5});
+        --local img2 = DefSubimages("st-chess"..colour.."-captured", {h=5});
+        local f1 = BuildFrames(img1, 120)
+        --local f2 = BuildFrames(img2, 40)
+        local f2 = f1
+        local f3 = BuildFrames(img1, 500)
+        DefAnim("st-chess"..colour.."-disappearing", f1);
+        DefAnim("st-chess"..colour.."-appearing", ReverseFrames(f1))
+        DefAnim("st-chess"..colour.."-captured", f2);
+        DefAnim("st-chess"..colour.."-swamp", f3);
+        DefRoundStone("st-chess"..colour, img1[1])
+    end
 
-def_stone2("st-black1")
-def_stone2("st-black2")
-def_stone2("st-black3")
-def_stone2("st-black4", "sh-white4")
-def_stone2("st-block")
-def_stone2("st-beads", "sh-glass")
+    make_chess("_black")
+    make_chess("_white")
+end
 
+-- st-coinslot --
+do
+    DefStone("st-coinslot")
+    local images = DefSubimages("st-coin2slot", {h=18})
+    DefAnim("st-coin2slot-anim", BuildFrames(images, 20))
+    DefSolidStone("st-coin2slot", "st-coin2slot-anim")
+    DefSolidStone("st-coinslot-active", "st-coin2slot18")
+end
 
-def_stone("st-glass1", "sh-glass")
-def_stone("st-glass2", "sh-glass")
-def_stone("st-glass3", "sh-glass")
-def_stone("st-rock1", "sh-round")
-def_stone("st-rock2")
-def_stone("st-rock3")
-def_stone("st-rock4")
-def_stone("st-rock5")
-def_stone("st-rock6")
-def_stone("st-rock7")
-def_stone("st-rock8", "sh-round")
-def_stone("st-rock9", "sh-round")
-def_stone("st-rock10")
-def_stone("st-redrock")
-def_stone("st-brownie", "sh-round")
-def_stone("st-stone1")
-def_stone("st-stone2")
-def_stone("st-bumps")
+-- st-disco --
+do
+    DefTiles("st-disco", {"st-disco-light","st-disco-medium","st-disco-dark"})
+end
 
-def_stone("st-camouflage")
-def_alias("st-camouflage_move", "st-camouflage")
-def_alias("st-camouflage_hole", "st-camouflage")
+-- st-death --
+do
+    DefRoundStoneWithAnim ("st-death", 3, 140)
+end
 
-def_alias("st-laserbreak", "st-rock3")
-def_alias("st-laserbreak-anim", "st-rock3_break-anim")
+-- st-dynamite, st-bombs, st-whitebombs --
+do
+    function make_bombstone(name)
+        local images = DefSubimages(name, {h=7})
+        DefRoundStone(name, name.."1")
+        DefAnim(name.."-anim", BuildFrames(images,50))
+    end
 
-def_alias("st-rock1_hole", "st-rock1")
-def_alias("st-rock1_move", "st-rock1")
+    make_bombstone("st-bombs")
+    make_bombstone("st-dynamite")
+    make_bombstone("st-whitebombs")
+end
 
-def_alias("st-rock2_hole", "st-rock2")
+-- st-flash --
+do
+    local images = DefSubimages("st-flash", {h=1})
+    DefSolidStone("st-flash", "st-flash1")
+end
 
-def_alias("st-rock3_hole", "st-rock3")
-def_alias("st-rock3_move", "st-rock3")
-def_alias("st-rock3_break", "st-rock3")
+-- st-fourswitch --
+do
+   DefSubimages("st-fourswitch",{h=4})
+   DefShModel("st-fourswitch-n", "st-fourswitch1", "sh-round")
+   DefShModel("st-fourswitch-e", "st-fourswitch2", "sh-round")
+   DefShModel("st-fourswitch-s", "st-fourswitch3", "sh-round")
+   DefShModel("st-fourswitch-w", "st-fourswitch4", "sh-round")
+end
 
-def_stone("st-marble", "sh-round")
-def_alias("st-marble_hole", "st-marble")
-def_alias("st-marble_move", "st-marble")
+-- st-knight --
+do
+    local images = DefSubimages("st-knight", {modelname="knight", h=5})
+    for i=1, table.getn(images) do
+        DefSolidStone("st-knight"..i, images[i])
+    end
+end
 
-def_alias("st-glass_move", "st-glass");
+-- st-laser --
+do
+    function make_laser(dir)
+        laseron=FrameNames("st-laser"..dir, 1, 9)
 
-def_alias("st-glass1_hole", "st-glass1")
-def_alias("st-glass1_move", "st-glass1")
-def_alias("st-glass2_hole", "st-glass2")
+        -- deactivated laser
+        DefOverlay("laser"..dir, {"st-laser-base", laseron[1]})
+        DefRoundStone("st-laser"..dir, "laser"..dir)
 
-def_stone("st-metal")
-def_alias("st-metal_hole", "st-metal")
-def_stone("st-blue-sand")
-def_stone("st-flrock")
-def_stone("st-flhay")
+        -- activated laser
+        names = {}
+        for i=1,table.getn(laseron) do
+	        names[i] = "st-laseron"..dir .. format("_%04d", i)
+	        DefOverlay (names[i], {"st-laser-base", laseron[i]})
+        end
+        frames = BuildFrames(names, 100)
+        DefAnim("st-laseron-anim"..dir, frames, 1)
+        DefRoundStone("st-laseron"..dir, "st-laseron-anim"..dir)
+    end
 
-def_stone("st-firebreak")
-def_alias("st-firebreak_move", "st-firebreak")
+    make_laser("-e")
+    make_laser("-s")
+    make_laser("-w")
+    make_laser("-n")
+end
 
+-- laserswitch --
 do
-   local sh=def_subimages("sh-round2-growing", {h=3,imgw=ShadowSize,imgh=ShadowSize})
+    DefStone("st-laserswitch0", nil, {filename="st-oxydb"})
+    DefAnimImages("laserswitch-blink",
+        RepeatAnim(PingPong(BuildFrames(FrameNames("st-fakeoxyd-blink", 1,4),50))), {loop=1})
+    DefSolidStone("st-laserswitch1", "laserswitch-blink")
+end
 
-   -- Wooden stones --
-   do
-      def_subimages("st-wood", {modelname="st-wood-fg",h=2})
-      def_shmodel("st-wood1", "st-wood-fg1", "sh-round")
-      def_shmodel("st-wood2", "st-wood-fg2", "sh-round")
+-- st-lightpassenger --
+do
+    local img = DefSubimages("st-lightpassenger", {h=7})
+    DefShModel("st-lightpassenger", img[1], "sh-glass")
+    DefAlias("st-lightpassenger_off", "st-glass2")
+    local frames = {img[2], img[3], img[4], img[5], img[6], img[7]}
+    DefAnim("st-lightpassenger-blink1", PingPong(BuildFrames(frames, 75)), true)
+    DefShModel("st-lightpassenger-blink", "st-lightpassenger-blink1", "sh-glass")
+    img = DefSubimages("st-lightpassenger-break-v", {h=7})
+    DefAnim("st-lightpassenger-break-v", BuildFrames(img, 50), false)
+    img = DefSubimages("st-lightpassenger-break-h", {h=7})
+    DefAnim("st-lightpassenger-break-h", BuildFrames(img, 50), false)
+    img = DefSubimages("st-lightpassenger-break-hv", {h=7})
+    DefAnim("st-lightpassenger-break-hv", BuildFrames(img, 50), false)
+end
 
-      local n=def_subimages("st-wood-growing", {h=3})
-      def_anim("wood-growing-fg", buildframes(n, 130))
-      def_anim("wood-growing-bg", buildframes(sh, 130))
-      def_shmodel("st-wood-growing", "wood-growing-fg", "wood-growing-bg")
-      def_shmodel("st-greenbrown-growing", "wood-growing-fg", "wood-growing-bg")
-   end
+-- st-magic :-) --
+do
+    local img = DefSubimages("st-magic", {h=4, modelname="st-magic-fg"})
+    local nlist = {}
+    for i=1, table.getn(img) do
+        nlist[i] = "st-magic"..i
+        DefRoundStone(nlist[i], img[i])
+    end
+    display.DefineRandModel("st-magic", table.getn(nlist), nlist)
+end
 
-   -- Blocker stone
-   do
-      local n=def_subimages("st-blocker", {h=4})
-      def_roundstone("st-blocker", n[1])
-      frames={}
-      for i=4,2,-1 do
-         table.insert(frames, "st-blocker"..i)
-      end
-      def_anim("blocker-growing-fg", buildframes(frames, 60))
-      def_anim("blocker-growing-bg", buildframes(sh, 60))
-      def_anim("blocker-shrinking-fg", reverseframes(buildframes(frames, 60)))
-      def_anim("blocker-shrinking-bg", reverseframes(buildframes(sh, 60)))
-      def_shmodel("st-blocker-shrinking", "blocker-shrinking-fg", "blocker-shrinking-bg");
-      def_shmodel("st-blocker-growing", "blocker-growing-fg", "blocker-growing-bg");
-   end
+-- st-mail --
+do
+    local images = DefSubimages("st-mail", {h=4})
+    DefSolidStone("st-mail-n", images[1])
+    DefSolidStone("st-mail-e", images[2])
+    DefSolidStone("st-mail-w", images[3])
+    DefSolidStone("st-mail-s", images[4])
 end
 
-def_alias("st-volcano-growing", "st-blocker-growing")
+-- st-oneway, st-oneway_black, st-oneway_white --
+do
+    local model_names = {
+        "st-oneway-e", "st-oneway-n", "st-oneway-s", "st-oneway-w",
+        "st-oneway_black-e", "st-oneway_black-n", "st-oneway_black-s", "st-oneway_black-w",
+        "st-oneway_white-e", "st-oneway_white-n", "st-oneway_white-s", "st-oneway_white-w"
+    }
+    DefSubimages("st-oneway", {modelname="st-onewayx",w=3,h=4})
+    for i=1,12 do DefFloatingStone(model_names[i], "st-onewayx"..i) end
+end
 
--- Rotator stones
+-- st-pull, st-swap --
 do
-    local n=def_subimages("st-rotator-left", {h=8})
-    def_anim("st-rotator-left-anim", buildframes(n, 70), false)
-    def_roundstone("st-rotator-left", "st-rotator-left-anim")
-    n=def_subimages("st-rotator-right", {h=8})
-    def_anim("st-rotator-right-anim", buildframes(n, 70), false)
-    def_roundstone("st-rotator-right", "st-rotator-right-anim")
+   DefSubimages("st-pull",{modelname="st-pull-fg",h=5})
+   DefSubimages("st-swap",{modelname="st-swap-fg",h=5})
+   DefSubimages("sh-pull",{h=4,imgw=ShadowSize,imgh=ShadowSize})
+
+   DefShModel("st-pull",   "st-pull-fg1", "sh-glass")
+   DefShModel("st-pull-n", "st-pull-fg2", "sh-pull1")
+   DefShModel("st-pull-s", "st-pull-fg3", "sh-pull2")
+   DefShModel("st-pull-e", "st-pull-fg4", "sh-pull3")
+   DefShModel("st-pull-w", "st-pull-fg5", "sh-pull4")
+
+   DefShModel("st-swap",   "st-swap-fg1", "sh-round")
+   DefShModel("st-swap-n", "st-swap-fg2", "sh-pull1")
+   DefShModel("st-swap-s", "st-swap-fg3", "sh-pull2")
+   DefShModel("st-swap-e", "st-swap-fg4", "sh-pull3")
+   DefShModel("st-swap-w", "st-swap-fg5", "sh-pull4")
 end
 
-def_stone("st-grate1", "sh-grate1")
-def_stone("st-grate2", "sh-grate2")
-def_stone("st-grate3", "sh-grate3")
+-- st-puzzle* --
+do
+    DefSubimages("st-puzzle", {modelname="st-puzzlex",w=8,h=4})
+    for i=2,16  do DefSolidStone("st-puzzle"..i, "st-puzzlex"..i) end
+    for i=18,32 do DefSolidStone("st-puzzle"..i, "st-puzzlex"..i) end
+    DefShModel("st-puzzle1", "st-puzzlex1", "sh-puzzle1")
+    DefShModel("st-puzzle17", "st-puzzlex17", "sh-puzzle1")
+end
 
-def_stone("st-brake", "sh-brake")
-def_image("it-brake", {filename="st-brake"})
+-- st-rock3-break --
+do
+    local images = DefSubimages("st-rock3-break", {h=6})
+    DefAnim("rock3_break-anim",BuildFrames(images,50))
+    DefSolidStone("st-rock3_break-anim", "rock3_break-anim")
+    DefAlias("st-rock3_movebreak", "st-rock3")
+end
 
-def_stone("st-greenbrown", "sh-round")
-def_alias("st-greenbrown_hole", "st-greenbrown")
-def_alias("st-greenbrown_move", "st-greenbrown")
+-- st-rock3-falling --
+do
+    local images = DefSubimages("st-rock3-falling", {h=4})
+    DefAnim("st-rock3-falling", BuildFrames(images, 100))
+end
 
---Progress(40)
+-- st-rotator --
+do
+    local images = DefSubimages("st-rotator-left", {h=8})
+    DefAnim("st-rotator-left-anim", BuildFrames(images, 70), false)
+    DefRoundStone("st-rotator-left", "st-rotator-left-anim")
+    local images = DefSubimages("st-rotator-right", {h=8})
+    DefAnim("st-rotator-right-anim", BuildFrames(images, 70), false)
+    DefRoundStone("st-rotator-right", "st-rotator-right-anim")
+end
 
+-- st-scissors --
+do
+    DefStone("st-scissors")
+    local images = DefSubimages("st-scissors-snip", {h=1})
+    DefAnim("st-scissors-snip-anim", BuildFrames(images, 130))
+    DefSolidStone("st-scissors-snip", "st-scissors-snip-anim")
+end
 
---def_stone("st-block")
-def_stone("st-brick")
-def_stone("st-woven")
-def_stone("st-brick_magic", nil, {filename="st-brick"})
+-- st-shogun* --
+do
+    DefImages{"sh-shogun1","sh-shogun2", "sh-shogun4"}
+    DefSubimages("st-shogun", {modelname="st-shogun-fg",h=7})
 
--- Switches --
+    DefShModel("st-shogun1", "st-shogun-fg1", "sh-shogun1")
+    DefShModel("st-shogun2", "st-shogun-fg2", "sh-shogun2")
+    DefShModel("st-shogun3", "st-shogun-fg3", "sh-shogun1")
+    DefShModel("st-shogun4", "st-shogun-fg4", "sh-shogun4")
+    DefShModel("st-shogun5", "st-shogun-fg5", "sh-shogun1")
+    DefShModel("st-shogun6", "st-shogun-fg6", "sh-shogun2")
+    DefShModel("st-shogun7", "st-shogun-fg7", "sh-shogun1")
+end
+
+-- st-stoneimpulse --
+--
+-- Note: It's important that the duration of the closing animation
+-- (anim2) is longer than the opening animation (anim1). Otherwise
+-- impulse stones do not work properly!
 do
+   local images = DefSubimages("st-stoneimpulse", {h=4})
+   DefRoundStone("st-stoneimpulse", images[1])
+   local frames = {}
+   for i=1,4 do table.insert(frames, images[i]) end
+   DefAnim("stoneimpulse-anim1", BuildFrames(frames, 55))
+   DefRoundStone("st-stoneimpulse-anim1", "stoneimpulse-anim1")
+   table.insert(frames, images[4]) -- add 1 frame to make closing anim longer!
+   DefAnim("stoneimpulse-anim2", ReverseFrames(BuildFrames(frames, 55)))
+   DefRoundStone("st-stoneimpulse-anim2", "stoneimpulse-anim2")
+end
+
+-- st-stoneimpulse-hollow --
+do
+   local images = DefSubimages("st-stoneimpulse-hollow", {h=4})
+   DefShModel("st-stoneimpulse-hollow", images[1], "sh-floating")
+   local frames = {}
+   for i=1,4 do table.insert(frames, images[i]) end
+   DefAnim("stoneimpulse-hollow-anim1", BuildFrames(frames, 55))
+   DefShModel("st-stoneimpulse-hollow-anim1", "stoneimpulse-hollow-anim1", "sh-floating")
+   table.insert(frames, images[4]) -- add 1 frame to make closing anim longer!
+   DefAnim("stoneimpulse-hollow-anim2", ReverseFrames(BuildFrames(frames, 55)))
+   DefShModel("st-stoneimpulse-hollow-anim2", "stoneimpulse-hollow-anim2", "sh-floating")
+end
+
+-- st-switch, st-switch_black, st-switch_white --
+do
     function mkswitch(modelname, basename)
-	local n = def_subimages(modelname, {h=3, modelname=basename.."-fg"})
-	local f = buildframes(n, 60)
-	def_roundstone(modelname.."-off", n[1])
-	def_roundstone(modelname.."-on", n[3])
-	def_anim(basename.."-turnon", f)
-	def_anim(basename.."-turnoff", reverseframes(f))
-	def_roundstone(modelname.."-turnon", basename.."-turnon")
-	def_roundstone(modelname.."-turnoff", basename.."-turnoff")
+    	local n = DefSubimages(modelname, {h=3, modelname=basename.."-fg"})
+    	local f = BuildFrames(n, 60)
+    	DefRoundStone(modelname.."-off", n[1])
+    	DefRoundStone(modelname.."-on", n[3])
+      	DefAnim(basename.."-turnon", f)
+	    DefAnim(basename.."-turnoff", ReverseFrames(f))
+	    DefRoundStone(modelname.."-turnon", basename.."-turnon")
+	    DefRoundStone(modelname.."-turnoff", basename.."-turnoff")
     end
     mkswitch("st-switch", "switch")
     mkswitch("st-switch_black", "switch_black")
     mkswitch("st-switch_white", "switch_white")
 end
 
--- 4-Switches --
+-- st-timer --
 do
-   def_subimages("st-fourswitch",{h=4})
+    local images = DefSubimages("st-timer", {h=4})
+    DefAnim("timer-anim", BuildFrames(images, 120), 1)
+    DefRoundStone("st-timer", "timer-anim")
+    DefRoundStone("st-timeroff", "st-timer1")
+end
 
-   def_shmodel("st-fourswitch-n", "st-fourswitch1", "sh-round")
-   def_shmodel("st-fourswitch-e", "st-fourswitch2", "sh-round")
-   def_shmodel("st-fourswitch-s", "st-fourswitch3", "sh-round")
-   def_shmodel("st-fourswitch-w", "st-fourswitch4", "sh-round")
+-- st-timeswitch --
+do
+    DefStone("st-timeswitch")
+    local images = DefSubimages("st-time1switch", {h=2})
+    DefAnim("st-time1switch-anim", BuildFrames (images, 180), 1)
+    DefSolidStone("st-time1switch", "st-time1switch-anim")
 end
 
-def_stone("st-floppy0", "sh-round", {filename="st-floppy1"})
-def_stone("st-floppy1", "sh-round", {filename="st-floppy2"})
+-- st-turnstile --
+do
+    local images = DefSubimages("st-turnstile", {h=2})
+    DefAnim("turnstile-anim", ReverseFrames(BuildFrames(images, 30)))
+    DefSolidStone("st-turnstile", images[1])
+    DefSolidStone("st-turnstile-anim", "turnstile-anim")
+end
 
-def_image("st-easymode")
+-- st-turnstle, arms --
+DefAlias("st-turnstile-e", "st-puzzle2")
+DefAlias("st-turnstile-w", "st-puzzle5")
+DefAlias("st-turnstile-s", "st-puzzle9")
+DefAlias("st-turnstile-n", "st-puzzle3")
 
+-- st-turnstile-green --
+do
+    local images = DefSubimages("st-turnstile-green", {h=2})
+    DefAnim("turnstile-green-anim", ReverseFrames(BuildFrames(images, 30)))
+    DefSolidStone("st-turnstile-green", images[1])
+    DefSolidStone("st-turnstile-green-anim", "turnstile-green-anim")
+end
 
-def_stone("st-laserswitch0", nil, {filename="st-oxydb"})
-def_anim_images("laserswitch-blink",
-                repeatanim(pingpong(
-                            buildframes(framenames("st-fakeoxyd-blink", 1,4),
-                            50))), {loop=1})
-def_solidstone("st-laserswitch1", "laserswitch-blink")
+-- st-wood*, growing stones, st-volcano, st-blocker --
+do
+   local sh=DefSubimages("sh-round2-growing", {h=3,imgw=ShadowSize,imgh=ShadowSize})
 
-def_stone("st-wood_001")
-def_stone("st-key0", "sh-round", {filename="st-key1"})
-def_stone("st-key1", "sh-round", {filename="st-key2"})
-def_stone("st-white1")
-def_stone("st-white2")
-def_stone("st-white3")
-def_stone("st-white4", "sh-white4")
-def_stone("st-yinyang1")
-def_stone("st-yinyang2")
-def_alias("st-yinyang3", "st-yinyang1")
-def_stone("st-bluegray", "sh-round")
-def_stone("st-bluegray_hole", "sh-round", {filename="st-bluegray"})
-def_stone("st-yellow")
-def_stone("st-dummy")
-def_stone("st-blackballs")
-def_stone("st-whiteballs")
+   -- Wooden stones --
+   do
+      DefSubimages("st-wood", {modelname="st-wood-fg",h=2})
+      DefShModel("st-wood1", "st-wood-fg1", "sh-round")
+      DefShModel("st-wood2", "st-wood-fg2", "sh-round")
 
+      local n=DefSubimages("st-wood-growing", {h=3})
+      DefAnim("wood-growing-fg", BuildFrames(n, 130))
+      DefAnim("wood-growing-bg", BuildFrames(sh, 130))
+      DefShModel("st-wood-growing", "wood-growing-fg", "wood-growing-bg")
+      DefShModel("st-greenbrown-growing", "wood-growing-fg", "wood-growing-bg")
+   end
 
-def_stone("st-rock3_cracked")
+   -- Blocker stone --
+   do
+      local n=DefSubimages("st-blocker", {h=4})
+      DefRoundStone("st-blocker", n[1])
+      frames={}
+      for i=4,2,-1 do
+         table.insert(frames, "st-blocker"..i)
+      end
+      DefAnim("blocker-growing-fg", BuildFrames(frames, 60))
+      DefAnim("blocker-growing-bg", BuildFrames(sh, 60))
+      DefAnim("blocker-shrinking-fg", ReverseFrames(BuildFrames(frames, 60)))
+      DefAnim("blocker-shrinking-bg", ReverseFrames(BuildFrames(sh, 60)))
+      DefShModel("st-blocker-shrinking", "blocker-shrinking-fg", "blocker-shrinking-bg");
+      DefShModel("st-blocker-growing", "blocker-growing-fg", "blocker-growing-bg");
+   end
+end
 
----------------
--- st-plain* --
----------------
-def_alias("st-plain", "st-rock3")
-def_alias("st-plain_hole", "st-rock3")
-def_alias("st-plain_breaking", "st-rock3_break-anim")
-def_alias("st-plain_break", "st-rock3")
-def_alias("st-plain_cracked", "st-rock3_cracked")
-def_alias("st-plain_move", "st-rock3")
-def_alias("st-plain_falling", "st-rock3-falling")
-
---------------------------
--- pull and swap stones --
---------------------------
-
---def_stone("st-swap", "sh-round")
-
 do
-   def_subimages("st-pull",{modelname="st-pull-fg",h=5})
-   def_subimages("st-swap",{modelname="st-swap-fg",h=5})
-   def_subimages("sh-pull",{h=4,imgw=ShadowSize,imgh=ShadowSize})
+    DefAlias("st-volcano-growing", "st-blocker-growing")
+end
 
-   def_shmodel("st-pull",   "st-pull-fg1", "sh-glass")
-   def_shmodel("st-pull-n", "st-pull-fg2", "sh-pull1")
-   def_shmodel("st-pull-s", "st-pull-fg3", "sh-pull2")
-   def_shmodel("st-pull-e", "st-pull-fg4", "sh-pull3")
-   def_shmodel("st-pull-w", "st-pull-fg5", "sh-pull4")
-
-   def_shmodel("st-swap",   "st-swap-fg1", "sh-round")
-   def_shmodel("st-swap-n", "st-swap-fg2", "sh-pull1")
-   def_shmodel("st-swap-s", "st-swap-fg3", "sh-pull2")
-   def_shmodel("st-swap-e", "st-swap-fg4", "sh-pull3")
-   def_shmodel("st-swap-w", "st-swap-fg5", "sh-pull4")
+-- st-window --
+do
+    DefSolidStoneWithAnim ("st-window", 4, 80)
 end
 
 -----------------
 -- Oxyd Stones --
 -----------------
-
+--
 -- Oxyd stones occur in different colors and different flavors and
 -- for each combination of these two attributes we need animations
 -- for the following internal states or state transitions:
@@ -982,8 +1166,8 @@
 -- them automatically.
 
 do
-    local colorspots = framenames("st-oxydbtempl", 2,9)
-    local openovls = framenames("st-oxydbtempl", 10,14)
+    local colorspots = FrameNames("st-oxydbtempl", 2,9)
+    local openovls = FrameNames("st-oxydbtempl", 10,14)
 
 -- Define "fading in" and "fading out" animations for oxyd stones.
 -- These two animations are combined with the stone images to
@@ -1002,16 +1186,16 @@
        d="sh-solid",
     }
     local fopening = {
-        a = buildframes(def_subimages("st-oxyda-opening", {h=9}), 60),
-        b = buildframes(def_subimages("st-oxydb-opening", {h=14}), 40),
-        c = buildframes(def_subimages("st-oxydc-opening", {h=5}), 70),
-        d = buildframes(def_subimages("st-oxydd-opening", {h=5}), 70),
+        a = BuildFrames(DefSubimages("st-oxyda-opening", {h=9}), 60),
+        b = BuildFrames(DefSubimages("st-oxydb-opening", {h=14}), 40),
+        c = BuildFrames(DefSubimages("st-oxydc-opening", {h=5}), 70),
+        d = BuildFrames(DefSubimages("st-oxydd-opening", {h=5}), 70),
     }
     local fclosing = {
-        a = reverseframes(fopening["a"]),
-        b = reverseframes(fopening["b"]),
-        c = reverseframes(fopening["c"]),
-        d = reverseframes(fopening["d"]),
+        a = ReverseFrames(fopening["a"]),
+        b = ReverseFrames(fopening["b"]),
+        c = ReverseFrames(fopening["c"]),
+        d = ReverseFrames(fopening["d"]),
     }
 
     function mkopenclose(flavor, color)
@@ -1019,51 +1203,51 @@
         local fadein = "oxyd"..flavor.."-fadein"
         local fadeout= "oxyd"..flavor.."-fadeout"
 
-        def_overlay(n.."-base", {baseimg[flavor], colorspots[color+1]})
+        DefOverlay(n.."-base", {baseimg[flavor], colorspots[color+1]})
         display.DefineComposite(n.."-opening-fg", n.."-base", fadein)
         display.DefineComposite(n.."-closing-fg", n.."-base", fadeout)
-        def_shmodel (n.."-opening", n.."-opening-fg", shadow[flavor])
-        def_shmodel (n.."-closing", n.."-closing-fg", shadow[flavor])
+        DefShModel (n.."-opening", n.."-opening-fg", shadow[flavor])
+        DefShModel (n.."-closing", n.."-closing-fg", shadow[flavor])
     end
 
     function mkblink(flavor, color)
         local n = "st-oxyd"..flavor..color.."-blink"
         local img={baseimg[flavor],colorspots[color+1], "st-oxyd-questmark"}
-        def_overlay(n..1, img)
-        def_overlay(n..2, {baseimg[flavor], colorspots[color+1]})
-        def_anim(n.."-anim", buildframes({n..1,n..2}, 500), 1)
-        def_shmodel(n, n.."-anim", shadow[flavor])
+        DefOverlay(n..1, img)
+        DefOverlay(n..2, {baseimg[flavor], colorspots[color+1]})
+        DefAnim(n.."-anim", BuildFrames({n..1,n..2}, 500), 1)
+        DefShModel(n, n.."-anim", shadow[flavor])
     end
 
     function mkopened(flavor, color)
         local n = "st-oxyd" .. flavor .. color .. "-open"
         local names = {}
 
-        for i=1,getn(openovls) do
+        for i=1, table.getn(openovls) do
             local images={baseimg[flavor],colorspots[color+1],openovls[i]}
             names[i] = n .. format("_%04d", i)
-            def_overlay(names[i], images)
+            DefOverlay(names[i], images)
         end
 
         -- compose these images into an animation
-        frames = pingpong(buildframes(names, 100))
-        def_anim(n.."-anim", frames, true)
+        frames = PingPong(BuildFrames(names, 100))
+        DefAnim(n.."-anim", frames, true)
 
         -- and finally add a shadow to make the model complete
-        def_shmodel(n, n.."-anim", shadow[flavor])
+        DefShModel(n, n.."-anim", shadow[flavor])
     end
 
     function mkoxyd(flavor)
-        def_stone("st-oxyd"..flavor, shadow[flavor])
-        def_shmodel("st-likeoxyd"..flavor, "st-oxyd"..flavor, shadow[flavor])
---        def_solidstone("st-likeoxyd"..flavor, "st-oxyd"..flavor)
-        img=def_image("st-oxyd"..flavor.."-open")
-        def_shmodel("st-likeoxyd"..flavor.."-open", img, shadow[flavor])
+        DefStone("st-oxyd"..flavor, shadow[flavor])
+        DefShModel("st-likeoxyd"..flavor, "st-oxyd"..flavor, shadow[flavor])
+--        DefSolidStone("st-likeoxyd"..flavor, "st-oxyd"..flavor)
+        img=DefImage("st-oxyd"..flavor.."-open")
+        DefShModel("st-likeoxyd"..flavor.."-open", img, shadow[flavor])
 
         local fadein = "oxyd"..flavor.."-fadein"
         local fadeout= "oxyd"..flavor.."-fadeout"
-        def_anim(fadein, fopening[flavor])
-        def_anim(fadeout, fclosing[flavor])
+        DefAnim(fadein, fopening[flavor])
+        DefAnim(fadeout, fclosing[flavor])
 
         for color=0,7 do
             mkopenclose(flavor, color)
@@ -1073,123 +1257,97 @@
     end
     mkoxyd("a")
     mkoxyd("b")
---    Progress(50)
     mkoxyd("d")
     mkoxyd("c")
 end
 
-def_alias("st-coffee", "st-oxydc")
+-- st-coffee --
+do
+    DefAlias("st-coffee", "st-oxydc")
+end
 
---Progress(60)
+-- st-doorh, st-doorv --
+do
+    local f,img,sh
 
------------------
--- Laser stone --
------------------
-function make_laser(dir)
-    laseron=framenames("st-laser"..dir, 1, 9)
+    img=DefSubimages("st-doorh", {h=7})
+    sh=DefSubimages("sh-doorh", {h=7,imgw=ShadowSize,imgh=ShadowSize})
+    DefShModel("st-doorh-open", img[1], sh[1])
+    DefShModel("st-doorh-closed", img[7], sh[7])
+    DefAnim("doorh-opening-fg", ReverseFrames(BuildFrames(img, 60)))
+    DefAnim("doorh-opening-bg", ReverseFrames(BuildFrames(sh, 60)))
+    DefShModel("st-doorh-opening", "doorh-opening-fg", "doorh-opening-bg")
+    DefAnim("doorh-closing-fg", BuildFrames(img, 60))
+    DefAnim("doorh-closing-bg", BuildFrames(sh, 60))
+    DefShModel("st-doorh-closing", "doorh-closing-fg", "doorh-closing-bg")
 
-    -- deactivated laser
-    def_overlay("laser"..dir, {"st-laser-base", laseron[1]})
-    def_roundstone("st-laser"..dir, "laser"..dir)
+    img=DefSubimages("st-doorv", {w=7})
+    sh=DefSubimages("sh-doorv", {w=7,imgw=ShadowSize,imgh=ShadowSize})
+    DefShModel("st-doorv-open", img[1], sh[1])
+    DefShModel("st-doorv-closed", img[7], sh[7])
+    DefAnim("doorv-opening-fg", ReverseFrames(BuildFrames(img, 60)))
+    DefAnim("doorv-opening-bg", ReverseFrames(BuildFrames(sh, 60)))
+    DefShModel("st-doorv-opening", "doorv-opening-fg", "doorv-opening-bg")
+    DefAnim("doorv-closing-fg", BuildFrames(img, 60))
+    DefAnim("doorv-closing-bg", BuildFrames(sh, 60))
+    DefShModel("st-doorv-closing", "doorv-closing-fg", "doorv-closing-bg")
+end
 
-    -- activated laser
-    names = {}
-    for i=1,getn(laseron) do
-	names[i] = "st-laseron"..dir .. format("_%04d", i)
-	def_overlay (names[i], {"st-laser-base", laseron[i]})
-    end
-    frames = buildframes(names, 100)
-    def_anim("st-laseron-anim"..dir, frames, 1)
-    def_roundstone("st-laseron"..dir, "st-laseron-anim"..dir)
+-- st-door_a --
+do
+    DefAlias("st-door_a-open", "st-grate1")
+    DefAlias("st-door_a-closed", "st-oxyda")
+    local f = BuildFrames({"st-door_a-closed", "st-door_a-open"},60)
+    DefAnim("st-door_a-opening", f)
+    DefAnim("st-door_a-closing", ReverseFrames(f))
 end
 
-make_laser("-e")
-make_laser("-s")
-make_laser("-w")
-make_laser("-n")
+-- st-door_b --
+do
+    DefAlias("st-door_b-open", "invisible")
+    DefAlias("st-door_b-closed", "st-rock3")
+    local img=DefSubimages("st-doorb", {modelname="doorb", h=8})
+    local f = BuildFrames(img,60)
+    DefAnim("st-door_b-opening", f)
+    DefAnim("st-door_b-closing", ReverseFrames(f))
+end
 
----------------------
--- Fake oxyd stone --
----------------------
-def_stone("st-fakeoxyd", "sh-round", {filename="st-oxydb"})
-def_anim_images("fakeoxyd-blink",
-                repeatanim(pingpong(
-                            buildframes(framenames("st-fakeoxyd-blink", 1,4),
-                                        50))))
-def_roundstone("st-fakeoxyd-blink", "fakeoxyd-blink")
-
-def_alias("st-fakeoxyda", "st-oxyda")
-
--- Fart stone
-def_stone("st-fart", "sh-round", {filename="st-oxydb"})
-def_anim_images("farting",
-                repeatanim(pingpong(
-                            buildframes(framenames("st-fakeoxyd-blink", 1,4),
-                                        50))))
-def_roundstone("st-farting", "farting")
-
-namelist = def_subimages("st-fart-break",{h=6})
-def_anim("fartbreak-anim", buildframes(namelist,50))
-def_roundstone("st-fartbreak-anim", "fartbreak-anim")
-
--- st-rock3_movebreak
-
-namelist = def_subimages("st-rock3-break", {h=6})
-def_anim("rock3_break-anim",buildframes(namelist,50))
-def_solidstone("st-rock3_break-anim", "rock3_break-anim")
-def_alias("st-rock3_movebreak", "st-rock3")
-
--- st-rock3-falling
-
+-- st-door_c --
 do
-    local n = def_subimages("st-rock3-falling", {h=4})
-    def_anim("st-rock3-falling", buildframes(n, 100))
+    DefAlias("st-door_c-open", "st-grate2")
+    DefAlias("st-door_c-closed", "st-rock3")
+    frames=BuildFrames({"st-door_c-closed","st-door_c-open"},60)
+    DefAnim("st-door_c-opening", frames)
+    DefAnim("st-door_c-closing", ReverseFrames(frames))
 end
 
--- Breaking stone
-
-def_alias("st-breaking", "st-rock3_break-anim")
-
--- Actor impulse stone
+-- st-fakeoxyd --
 do
-   namelist = def_subimages("st-actorimpulse", {h=3})
-   shnamelist = def_subimages("sh-actorimpulse", {h=3,imgw=ShadowSize,imgh=ShadowSize})
+    DefStone("st-fakeoxyd", "sh-round", {filename="st-oxydb"})
+    DefAnimImages("fakeoxyd-blink",
+        RepeatAnim(PingPong(BuildFrames(FrameNames("st-fakeoxyd-blink", 1,4),50))))
+    DefRoundStone("st-fakeoxyd-blink", "fakeoxyd-blink")
 
-   def_anim("st-ai-fg", pingpong(buildframes(namelist, 30)))
-   def_anim("st-ai-sh", pingpong(buildframes(shnamelist, 30)))
-   def_shmodel("st-actorimpulse-anim", "st-ai-fg", "st-ai-sh")
-
-   def_shmodel("st-actorimpulse", namelist[1], shnamelist[1])
+    DefAlias("st-fakeoxyda", "st-oxyda")
 end
 
--- Stone impulse stone
---
--- Note: It's important that the duration of the closing animation
--- (anim2) is longer than the opening animation (anim1). Otherwise
--- impulse stones do not work properly!
-
+-- st-fart --
 do
-   namelist = def_subimages("st-stoneimpulse", {h=4})
-   def_roundstone("st-stoneimpulse", namelist[1])
-   frames={}
-   for i=1,4 do table.insert(frames, namelist[i]) end
-   def_anim("stoneimpulse-anim1", buildframes(frames, 55))
-   def_roundstone("st-stoneimpulse-anim1", "stoneimpulse-anim1")
-   table.insert(frames, namelist[4]) -- add 1 frame to make closing anim longer!
-   def_anim("stoneimpulse-anim2", reverseframes(buildframes(frames, 55)))
-   def_roundstone("st-stoneimpulse-anim2", "stoneimpulse-anim2")
+    DefStone("st-fart", "sh-round", {filename="st-oxydb"})
+    DefAnimImages("farting",
+        RepeatAnim(PingPong(BuildFrames(FrameNames("st-fakeoxyd-blink", 1,4),50))))
+    DefRoundStone("st-farting", "farting")
+
+    namelist = DefSubimages("st-fart-break",{h=6})
+    DefAnim("fartbreak-anim", BuildFrames(namelist,50))
+    DefRoundStone("st-fartbreak-anim", "fartbreak-anim")
 end
 
+-- st-spitter --
 do
-   namelist = def_subimages("st-stoneimpulse-hollow", {h=4})
-   def_shmodel("st-stoneimpulse-hollow", namelist[1], "sh-floating")
-   frames={}
-   for i=1,4 do table.insert(frames, namelist[i]) end
-   def_anim("stoneimpulse-hollow-anim1", buildframes(frames, 55))
-   def_shmodel("st-stoneimpulse-hollow-anim1", "stoneimpulse-hollow-anim1", "sh-floating")
-   table.insert(frames, namelist[4]) -- add 1 frame to make closing anim longer!
-   def_anim("stoneimpulse-hollow-anim2", reverseframes(buildframes(frames, 55)))
-   def_shmodel("st-stoneimpulse-hollow-anim2", "stoneimpulse-hollow-anim2", "sh-floating")
+    DefAlias ("st-spitter", "st-timeswitch")
+    DefAlias ("st-spitter-loading", "st-fakeoxyd-blink")
+    DefAlias ("st-spitter-spitting", "st-fakeoxyd-blink")
 end
 
 ---------------------------
@@ -1200,203 +1358,73 @@
 
     local stonebase = "st-bluegray"
     local floorbase = "fl-bluegray"
-    local thiefovl = def_subimages("thief-template", {h = 7})
-    local capturedovl = def_subimages("thief-captured-template", {h = 12})
+    local thiefovl = DefSubimages("thief-template", {h = 7})
+    local capturedovl = DefSubimages("thief-captured-template", {h = 12})
 
     -- Creating st-thief
 
     local names = {}
-    for j = 1, getn(thiefovl) do
+    for j = 1, table.getn(thiefovl) do
         names[j] = "st-thief"..format("_%04d", j)
         display.DefineComposite(names[j], stonebase, thiefovl[j])
     end
 
-    local f1 = buildframes(names, 80)
-    def_anim("pre-st-thief-emerge", f1)
-    def_anim("pre-st-thief-retreat", reverseframes(f1))
-    def_roundstone("st-thief", stonebase)
-    def_roundstone("st-thief-emerge", "pre-st-thief-emerge")
-    def_roundstone("st-thief-retreat", "pre-st-thief-retreat")
+    local f1 = BuildFrames(names, 80)
+    DefAnim("pre-st-thief-emerge", f1)
+    DefAnim("pre-st-thief-retreat", ReverseFrames(f1))
+    DefRoundStone("st-thief", stonebase)
+    DefRoundStone("st-thief-emerge", "pre-st-thief-emerge")
+    DefRoundStone("st-thief-retreat", "pre-st-thief-retreat")
 
     -- Creating st-thief-captured
     --
     --   Note that this is done without template, as the whole
     --   stone has to disappear (e.g. via shrinking)
 
-    local img2 = def_subimages("st-thief-captured", {h = 12})
-    local f2 = buildframes(img2, 80)
-    def_anim("st-thief-captured", f2)
+    local img2 = DefSubimages("st-thief-captured", {h = 12})
+    local f2 = BuildFrames(img2, 80)
+    DefAnim("st-thief-captured", f2)
 
     -- Creating fl-thief
 
     local floornames = {}
     local floorcaptured = {}
-    local floorbases = def_subimages(floorbase, {h=4, modelname="fl-thief-base"})
+    local floorbases = DefSubimages(floorbase, {h=4, modelname="fl-thief-base"})
     for k = 1,4 do
       floornames[k] = {}
-      for j = 1, getn(thiefovl) do
+      for j = 1, table.getn(thiefovl) do
         floornames[k][j] = "fl-thief"..k..format("_%04d", j)
         display.DefineComposite(floornames[k][j], floorbases[k], thiefovl[j])
       end
       floorcaptured[k] = {}
-      for j = 1, getn(capturedovl) do
+      for j = 1, table.getn(capturedovl) do
         floorcaptured[k][j] = "fl-thief"..k.."-captured"..format("_%04d", j)
         display.DefineComposite(floorcaptured[k][j], floorbases[k], capturedovl[j])
       end
-      local f3 = buildframes(floornames[k], 80)
-      local f4 = buildframes(floorcaptured[k], 80)
-      def_alias("fl-thief"..k, floorbases[k])
-      def_anim("fl-thief"..k.."-emerge", f3)
-      def_anim("fl-thief"..k.."-retreat", reverseframes(f3))
-      def_anim("fl-thief"..k.."-captured", f4)
+      local f3 = BuildFrames(floornames[k], 80)
+      local f4 = BuildFrames(floorcaptured[k], 80)
+      DefAlias("fl-thief"..k, floorbases[k])
+      DefAnim("fl-thief"..k.."-emerge", f3)
+      DefAnim("fl-thief"..k.."-retreat", ReverseFrames(f3))
+      DefAnim("fl-thief"..k.."-captured", f4)
     end
 
 --do
---    local img = def_subimages("fl-thief", {h=7})
---    local f = buildframes(img, 80)
---    def_anim("thief-emerge", f)
---    def_anim("thief-retreat", reverseframes(f))
---    def_roundstone("fl-thief", img[1])
---    def_roundstone("fl-thief-emerge", "thief-emerge")
---    def_roundstone("fl-thief-retreat", "thief-retreat")
+--    local img = DefSubimages("fl-thief", {h=7})
+--    local f = BuildFrames(img, 80)
+--    DefAnim("thief-emerge", f)
+--    DefAnim("thief-retreat", ReverseFrames(f))
+--    DefRoundStone("fl-thief", img[1])
+--    DefRoundStone("fl-thief-emerge", "thief-emerge")
+--    DefRoundStone("fl-thief-retreat", "thief-retreat")
 --end
 
 end
 
------------------
--- Chess stone --
------------------
-function make_chess(colour)
-    local img1 = def_subimages("st-chess"..colour, {h=5});
-    --local img2 = def_subimages("st-chess"..colour.."-captured", {h=5});
-    local f1 = buildframes(img1, 120)
-    --local f2 = buildframes(img2, 40)
-    local f2 = f1
-    local f3 = buildframes(img1, 500)
-    def_anim("st-chess"..colour.."-disappearing", f1);
-    def_anim("st-chess"..colour.."-appearing", reverseframes(f1))
-    def_anim("st-chess"..colour.."-captured", f2);
-    def_anim("st-chess"..colour.."-swamp", f3);
-    def_roundstone("st-chess"..colour, img1[1])
-end
-
-make_chess("_black")
-make_chess("_white")
-
------------------
--- Timer stone --
------------------
-do
-    local img = def_subimages("st-timer", {h=4})
-    def_anim("timer-anim", buildframes(img, 120), 1)
-    def_roundstone("st-timer", "timer-anim")
-    def_roundstone("st-timeroff", "st-timer1")
-end
-
------------------
--- Bomb Stones --
------------------
-
-function make_bombstone(name)
-    local n=def_subimages(name, {h=7})
-    def_roundstone(name, name.."1")
-    def_anim(name.."-anim", buildframes(n,50))
-end
-
-make_bombstone("st-bombs")
-make_bombstone("st-dynamite")
-make_bombstone("st-whitebombs")
-
-----------------
--- Mail stone --
-----------------
-do
-    local n=def_subimages("st-mail", {h=4})
-    def_solidstone("st-mail-n", "st-mail1")
-    def_solidstone("st-mail-e", "st-mail2")
-    def_solidstone("st-mail-s", "st-mail4")
-    def_solidstone("st-mail-w", "st-mail3")
-end
-
-function def_solidstone_with_anim(name, npictures, frametime)
-    local n=def_subimages(name, {h=npictures})
-    def_anim(name.."-animfg", buildframes(n,frametime))
-    def_solidstone(name.."-anim", name.."-animfg")
-    def_solidstone(name, n[1])
-end
-function def_roundstone_with_anim(name, npictures, frametime)
-    local n=def_subimages(name, {h=npictures})
-    def_anim(name.."-animfg", buildframes(n,frametime))
-    def_roundstone(name.."-anim", name.."-animfg")
-    def_roundstone(name, n[1])
- end
-
-def_solidstone_with_anim ("st-window", 4, 80)
-def_solidstone_with_anim ("st-stone_break", 10, 50)
-def_solidstone_with_anim ("st-break_bolder", 10, 50)
-def_roundstone_with_anim ("st-break_acwhite", 10, 50)
-def_roundstone_with_anim ("st-break_acblack", 10, 50)
-def_roundstone_with_anim ("st-break_gray", 10, 50)
-def_roundstone_with_anim ("st-death", 3, 140)
-
-
--- Flash stone --
-do
-    local n=def_subimages("st-flash", {h=1})
-    def_solidstone("st-flash", "st-flash1")
-end
-
--- Surprise stone --
-do
-    def_stone ("st-surprise")
-end
-
--- Charge stones --
-do
-    function def_chargestone(basename)
-        local n=def_subimages(basename, {h=2})
-        def_solidstone(basename, n[1])
-        def_anim(basename.."-animfg", {{n[2], 140}})
-        def_solidstone(basename.."-anim", basename.."-animfg")
-    end
-    def_chargestone("st-chargeplus")
-    def_chargestone("st-chargeminus")
-    def_chargestone("st-chargezero")
-end
-
----------------
--- Turnstile --
----------------
-do
-   local img = def_subimages("st-turnstile", {h=2})
-   def_anim("turnstile-anim", reverseframes(buildframes(img, 30)))
-   def_solidstone("st-turnstile", img[1])
-   def_solidstone("st-turnstile-anim", "turnstile-anim")
-end
-
-do
-   local img = def_subimages("st-turnstile-green", {h=2})
-   def_anim("turnstile-green-anim", reverseframes(buildframes(img, 30)))
-   def_solidstone("st-turnstile-green", img[1])
-   def_solidstone("st-turnstile-green-anim", "turnstile-green-anim")
-end
-
-----------------
--- Timeswitch --
-----------------
-do
-    def_stone("st-timeswitch")
-    local img = def_subimages("st-time1switch", {h=2})
-    def_anim("st-time1switch-anim", buildframes (img, 180), 1)
-    def_solidstone("st-time1switch", "st-time1switch-anim")
-end
-
---Progress(70)
-
 -------------
 -- Mirrors --
 -------------
-
+--
 -- naming scheme for mirror models:
 --
 --	st-{3mirror,pmirror}-{m,s}{o,t}[1234]
@@ -1411,310 +1439,124 @@
 --	2	west	  "<"        "\"
 --	3	north	  "^"        "|"
 --	4	east	  ">"        "/"
-
-function make_mirror(basename, baseimg, overlays)
-    for i=1,4 do
-	mname = basename .. i
-	def_overlay (mname .. "-ovl", {baseimg, overlays[i]})
-	def_shmodel(mname, mname .. "-ovl", "sh-round2")
-    end
-end
-
-mirror3_opaque = framenames("st-mirrortempl", 1, 4)
-mirror3_transp = framenames("st-mirrortempl", 5, 8)
-mirrorp_opaque = framenames("st-mirrortempl", 9, 12)
-mirrorp_transp = framenames("st-mirrortempl", 13, 16)
-
-make_mirror("st-3mirror-mo", "st-mirror-movable", mirror3_opaque)
-make_mirror("st-3mirror-so", "st-mirror-static",  mirror3_opaque)
-make_mirror("st-3mirror-mt", "st-mirror-movable", mirror3_transp)
-make_mirror("st-3mirror-st", "st-mirror-static",  mirror3_transp)
-
-make_mirror("st-pmirror-mo", "st-mirror-movable", mirrorp_opaque)
-make_mirror("st-pmirror-so", "st-mirror-static",  mirrorp_opaque)
-make_mirror("st-pmirror-mt", "st-mirror-movable", mirrorp_transp)
-make_mirror("st-pmirror-st", "st-mirror-static",  mirrorp_transp)
-
--- OneWay --
 do
-   local model_names = {  
-       "st-oneway-e", "st-oneway-n", "st-oneway-s", "st-oneway-w",
-       "st-oneway_black-e", "st-oneway_black-n", "st-oneway_black-s", "st-oneway_black-w",
-       "st-oneway_white-e", "st-oneway_white-n", "st-oneway_white-s", "st-oneway_white-w"
-   }
-   def_subimages("st-oneway", {modelname="st-onewayx",w=3,h=4})
-   for i=1,12 do def_floatingstone(model_names[i], "st-onewayx"..i) end
-end
-
----------------
--- Coin slot --
----------------
-do
-    def_stone("st-coinslot")
-    local img=def_subimages("st-coin2slot", {h=18})
-    def_anim("st-coin2slot-anim", buildframes(img, 20))
-    def_solidstone("st-coin2slot", "st-coin2slot-anim")
-    def_solidstone("st-coinslot-active", "st-coin2slot18")
-end
-
-
---Progress(80)
-
--------------------
--- Puzzle stones --
--------------------
-do
-    def_subimages("st-puzzle", {modelname="st-puzzlex",w=8,h=4})
-    for i=2,16  do def_solidstone("st-puzzle"..i, "st-puzzlex"..i) end
-    for i=18,32 do def_solidstone("st-puzzle"..i, "st-puzzlex"..i) end
-    def_shmodel("st-puzzle1", "st-puzzlex1", "sh-puzzle1")
-    def_shmodel("st-puzzle17", "st-puzzlex17", "sh-puzzle1")
-end
-
-def_alias("st-turnstile-e", "st-puzzle2")
-def_alias("st-turnstile-w", "st-puzzle5")
-def_alias("st-turnstile-s", "st-puzzle9")
-def_alias("st-turnstile-n", "st-puzzle3")
---def_stone("st-turnstile")
-
----------------
--- Big brick --
----------------
-
-do
-   def_subimages("st-bigbrick", {modelname="st-bigbrickx",w=4,h=4})
-   for i=1,16 do def_solidstone("st-bigbrick"..i, "st-bigbrickx"..i) end
-end
-
---def_alias("st-bigbrick", "st-bigbrick1");
---def_alias("st-bigbrick-n", "st-bigbrick9");
---def_alias("st-bigbrick-e", "st-bigbrick5");
---def_alias("st-bigbrick-s", "st-bigbrick3");
---def_alias("st-bigbrick-w", "st-bigbrick2");
---def_alias("st-bigbrick-ne", "st-bigbrick13");
---def_alias("st-bigbrick-nw", "st-bigbrick10");
---def_alias("st-bigbrick-es", "st-bigbrick7");
---def_alias("st-bigbrick-sw", "st-bigbrick4");
---def_alias("st-bigbrick-ns", "st-bigbrick11");
---def_alias("st-bigbrick-ew", "st-bigbrick6");
---def_alias("st-bigbrick-nes", "st-bigbrick15");
---def_alias("st-bigbrick-new", "st-bigbrick14");
---def_alias("st-bigbrick-nsw", "st-bigbrick12");
---def_alias("st-bigbrick-esw", "st-bigbrick8");
---def_alias("st-bigbrick-nesw", "st-bigbrick16");
-
------------------
--- BigBlueSand --
------------------
-
-do
-   def_subimages("st-bigbluesand", {modelname="st-bigbluesandx",w=4,h=4})
-   for i=1,16 do def_solidstone("st-bigbluesand"..i, "st-bigbluesandx"..i) end
-end
-
------------
--- Doors --
------------
-do
-    local f,img,sh
-
-    img=def_subimages("st-doorh", {h=7})
-    sh=def_subimages("sh-doorh", {h=7,imgw=ShadowSize,imgh=ShadowSize})
-    def_shmodel("st-doorh-open", img[1], sh[1])
-    def_shmodel("st-doorh-closed", img[7], sh[7])
-    def_anim("doorh-opening-fg", reverseframes(buildframes(img, 60)))
-    def_anim("doorh-opening-bg", reverseframes(buildframes(sh, 60)))
-    def_shmodel("st-doorh-opening", "doorh-opening-fg", "doorh-opening-bg")
-    def_anim("doorh-closing-fg", buildframes(img, 60))
-    def_anim("doorh-closing-bg", buildframes(sh, 60))
-    def_shmodel("st-doorh-closing", "doorh-closing-fg", "doorh-closing-bg")
-
-
-    img=def_subimages("st-doorv", {w=7})
-    sh=def_subimages("sh-doorv", {w=7,imgw=ShadowSize,imgh=ShadowSize})
-    def_shmodel("st-doorv-open", img[1], sh[1])
-    def_shmodel("st-doorv-closed", img[7], sh[7])
-    def_anim("doorv-opening-fg", reverseframes(buildframes(img, 60)))
-    def_anim("doorv-opening-bg", reverseframes(buildframes(sh, 60)))
-    def_shmodel("st-doorv-opening", "doorv-opening-fg", "doorv-opening-bg")
-    def_anim("doorv-closing-fg", buildframes(img, 60))
-    def_anim("doorv-closing-bg", buildframes(sh, 60))
-    def_shmodel("st-doorv-closing", "doorv-closing-fg", "doorv-closing-bg")
-end
-
--- Door_a --
-do
-    def_alias("st-door_a-open", "st-grate1")
-    def_alias("st-door_a-closed", "st-oxyda")
-    local f = buildframes({"st-door_a-closed", "st-door_a-open"},60)
-    def_anim("st-door_a-opening", f)
-    def_anim("st-door_a-closing", reverseframes(f))
-end
-
--- Door_b --
-do
-    def_alias("st-door_b-open", "invisible")
-    def_alias("st-door_b-closed", "st-plain")
-    local img=def_subimages("st-doorb", {modelname="doorb", h=8})
-    local f = buildframes(img,60)
-    def_anim("st-door_b-opening", f)
-    def_anim("st-door_b-closing", reverseframes(f))
-end
-
--- Door_c --
-do
-    def_alias("st-door_c-open", "st-grate2")
-    def_alias("st-door_c-closed", "st-plain")
-    frames=buildframes({"st-door_c-closed","st-door_c-open"},60)
-    def_anim("st-door_c-opening", frames)
-    def_anim("st-door_c-closing", reverseframes(frames))
-end
-
-------------------
--- Knight stone --
-------------------
-do
-    local n = def_subimages("st-knight", {modelname="knight", h=5})
-    for i=1,getn(n) do
-        def_solidstone("st-knight"..i, n[i])
+    function make_mirror(basename, baseimg, overlays)
+        for i=1,4 do
+	        mname = basename .. i
+	        DefOverlay (mname .. "-ovl", {baseimg, overlays[i]})
+	        DefShModel(mname, mname .. "-ovl", "sh-round2")
+        end
     end
-end
 
--------------------
--- Shogun stones --
--------------------
-do
-    def_images{"sh-shogun1","sh-shogun2", "sh-shogun4"}
-    def_subimages("st-shogun", {modelname="st-shogun-fg",h=7})
+    mirror3_opaque = FrameNames("st-mirrortempl", 1, 4)
+    mirror3_transp = FrameNames("st-mirrortempl", 5, 8)
+    mirrorp_opaque = FrameNames("st-mirrortempl", 9, 12)
+    mirrorp_transp = FrameNames("st-mirrortempl", 13, 16)
 
-    def_shmodel("st-shogun1", "st-shogun-fg1", "sh-shogun1")
-    def_shmodel("st-shogun2", "st-shogun-fg2", "sh-shogun2")
-    def_shmodel("st-shogun3", "st-shogun-fg3", "sh-shogun1")
-    def_shmodel("st-shogun4", "st-shogun-fg4", "sh-shogun4")
-    def_shmodel("st-shogun5", "st-shogun-fg5", "sh-shogun1")
-    def_shmodel("st-shogun6", "st-shogun-fg6", "sh-shogun2")
-    def_shmodel("st-shogun7", "st-shogun-fg7", "sh-shogun1")
-end
+    make_mirror("st-3mirror-mo", "st-mirror-movable", mirror3_opaque)
+    make_mirror("st-3mirror-so", "st-mirror-static",  mirror3_opaque)
+    make_mirror("st-3mirror-mt", "st-mirror-movable", mirror3_transp)
+    make_mirror("st-3mirror-st", "st-mirror-static",  mirror3_transp)
 
---Progress(90)
-
--------------------
--- Bolder stones --
--------------------
-
-do
-    local img=def_subimages("st-bolder", {w=4,h=3})
-    local imgfall=def_subimages("st-bolder-fall", {w=4,h=3})
-
-    function def_bolder(orient, start)
-       local animname="st-bolder"..orient.."a"
-       local frames={img[start], img[start+1], img[start+2]}
-       def_anim(animname, buildframes(frames, 120), false)
-       def_shmodel("st-bolder-"..orient, animname, "sh-round")
-
-       animname="st-bolder-"..orient.."-fall-anim"
-       frames={imgfall[start],imgfall[start+1],imgfall[start+2]}
-       def_anim(animname, buildframes(frames, 120), false)
-    end
-
-    def_bolder("n",1)
-    def_bolder("e",4)
-    def_bolder("s",7)
-    def_bolder("w",10)
+    make_mirror("st-pmirror-mo", "st-mirror-movable", mirrorp_opaque)
+    make_mirror("st-pmirror-so", "st-mirror-static",  mirrorp_opaque)
+    make_mirror("st-pmirror-mt", "st-mirror-movable", mirrorp_transp)
+    make_mirror("st-pmirror-st", "st-mirror-static",  mirrorp_transp)
 end
 
--- Invisible stone --
-def_alias("st-invisible", "invisible")
-def_alias("st-invisible_magic", "invisible")
-def_alias("st-stonebrush", "invisible")
-def_alias("st-break_invisible", "invisible")
-def_alias("st-actorimpulse_invisible", "invisible")
-def_alias("st-death_invisible", "invisible")
-
-----------------------
--- Magic stones :-) --
-----------------------
+--------------------------
+-- Simple stone aliases --
+--------------------------
 do
-    local img = def_subimages("st-magic", {h=4, modelname="st-magic-fg"})
-    local nlist = {}
-    for i=1,getn(img) do
-        nlist[i] = "st-magic"..i
-        def_roundstone(nlist[i], img[i])
-    end
-    display.DefineRandModel("st-magic", getn(nlist), nlist)
+    DefAlias("st-breaking", "st-rock3_break-anim")
+    DefAlias("st-camouflage_move", "st-camouflage")
+    DefAlias("st-camouflage_hole", "st-camouflage")
+    DefAlias("st-explosion", "expl")
+    DefAlias("st-firebreak_move", "st-firebreak")
+    DefAlias("st-glass_move", "st-glass");
+    DefAlias("st-glass1_hole", "st-glass1")
+    DefAlias("st-glass1_move", "st-glass1")
+    DefAlias("st-glass2_hole", "st-glass2")
+    DefAlias("st-greenbrown_hole", "st-greenbrown")
+    DefAlias("st-greenbrown_move", "st-greenbrown")
+    DefAlias("st-laserbreak", "st-rock3")
+    DefAlias("st-laserbreak-anim", "st-rock3_break-anim")
+    DefAlias("st-marble_hole", "st-marble")
+    DefAlias("st-marble_move", "st-marble")
+    DefAlias("st-metal_hole", "st-metal")
+    DefAlias("st-plain", "st-rock3")
+    DefAlias("st-plain_break", "st-rock3")
+    DefAlias("st-plain_breaking", "st-rock3_break-anim")
+    DefAlias("st-plain_cracked", "st-rock3_cracked")
+    DefAlias("st-plain_falling", "st-rock3-falling")
+    DefAlias("st-plain_hole", "st-rock3")
+    DefAlias("st-plain_move", "st-rock3")
+    DefAlias("st-rock1_hole", "st-rock1")
+    DefAlias("st-rock1_move", "st-rock1")
+    DefAlias("st-rock2_hole", "st-rock2")
+    DefAlias("st-rock3_hole", "st-rock3")
+    DefAlias("st-rock3_move", "st-rock3")
+    DefAlias("st-rock3_break", "st-rock3")
+    DefAlias("st-yinyang3", "st-yinyang1")
 end
 
--------------------
--- Spitter stone --
--------------------
+-- Invisible stones --
 do
-    def_alias ("st-spitter", "st-timeswitch")
-    def_alias ("st-spitter-loading", "st-fakeoxyd-blink")
-    def_alias ("st-spitter-spitting", "st-fakeoxyd-blink")
+    DefAlias("st-actorimpulse_invisible", "invisible")
+    DefAlias("st-break_invisible", "invisible")
+    DefAlias("st-death_invisible", "invisible")
+    DefAlias("st-invisible", "invisible")
+    DefAlias("st-invisible_magic", "invisible")
+    DefAlias("st-stonebrush", "invisible")
 end
 
----------------------------
--- Light Passenger Stone --
----------------------------
-do
-    local img = def_subimages("st-lightpassenger", {h=7})
-    def_shmodel("st-lightpassenger", img[1], "sh-glass")
-    def_alias("st-lightpassenger_off", "st-glass2")
-    local frames={img[2], img[3], img[4], img[5], img[6], img[7]}
-    def_anim("st-lightpassenger-blink1", pingpong(buildframes(frames, 75)), true)
-    def_shmodel("st-lightpassenger-blink", "st-lightpassenger-blink1", "sh-glass")
-    img = def_subimages("st-lightpassenger-break-v", {h=7})
-    def_anim("st-lightpassenger-break-v", buildframes(img, 50), false)
-    img = def_subimages("st-lightpassenger-break-h", {h=7})
-    def_anim("st-lightpassenger-break-h", buildframes(img, 50), false)
-    img = def_subimages("st-lightpassenger-break-hv", {h=7})
-    def_anim("st-lightpassenger-break-hv", buildframes(img, 50), false)
-end
+--------------------------------------------------------------------------------
+--                               Sprite Effects                               --
+--------------------------------------------------------------------------------
+Progress(95, "Loading Sprite Effects")
 
--------------
--- Effects --
--------------
-
-Sprite{
-    name     = "ring-anim", 
+Sprite({
+    name     = "ring-anim",
     nimages  = 8,
     framelen = 50,
-    padding = 0.3
-}
+    padding  = 0.3
+})
 
-Sprite{
-    name    = "ac-drowned",
-    nimages = 5,
+Sprite({
+    name     = "ac-drowned",
+    nimages  = 5,
     framelen = 80,
-    padding = 0.3
-}
+    padding  = 0.3
+})
 
 -- Halo --
-Sprite{
+Sprite({
     name     = "halo",
     nimages  = 2,
     framelen = 30,
     loop     = true
-}
-Sprite{
+})
+
+Sprite({
     name     = "halo-blink",
     nimages  = 2,
     framelen = 30,
     loop     = true
-}
+})
 
 -- Halo for small balls --
-Sprite{
+Sprite({
     name     = "halo-small",
     nimages  = 2,
     framelen = 30,
     loop     = true
-}
-Sprite{
+})
+
+Sprite({
     name     = "halo-small-blink",
     nimages  = 2,
     framelen = 30,
     loop     = true
-}
+})
 
-Progress(100, "Loading Oxyd levels")
+Progress(100, "Loading levels")

Modified: trunk/data/models.lua
===================================================================
--- trunk/data/models.lua	2007-04-14 15:11:51 UTC (rev 690)
+++ trunk/data/models.lua	2007-04-15 21:45:05 UTC (rev 691)
@@ -20,20 +20,17 @@
 -- This file contains common routines for defining new Enigma models.
 -- It is used by all other model*.lua files.
 
----------------
--- FUNCTIONS --
----------------
+-- Display the loading progress
 function Progress(percent, text)
-    local fontname = "levelmenu"
-    local scr      = video.GetScreen();
-    local d = scr:get_surface()
-
+    local fontname   = "levelmenu"
+    local scr        = video.GetScreen()
+    local d          = scr:get_surface()
     local background = enigma.GetImage ("menu_bg", ".jpg")
-    local logo = enigma.GetImage("enigma_logo3")
-    local x = (d:width()  - logo:width())/2
-    local y = (d:height() - logo:height())/2
-    local gs = ecl.GS:new(d:size())
-    local font2 = enigma.GetFont("menufontsel")
+    local logo       = enigma.GetImage("enigma_logo3")
+    local x          = (d:width()  - logo:width())/2
+    local y          = (d:height() - logo:height())/2
+    local gs         = ecl.GS:new(d:size())
+    local font2      = enigma.GetFont("menufontsel")
 
     d:blit(gs, 0, 0, background)
     d:blit(gs, x , y-logo:height(), logo)
@@ -48,23 +45,27 @@
     gs:delete()
 end
 
+-- Return an unique modelname.
 modeltag = 0
-function unique_modelname()
+function UniqueModelname()
     modeltag = modeltag + 1
     return "xmodel" .. modeltag
 end
 
--- Define a new image model.  'name' is the name of the model being created
--- and 'opt' contains optional information about the image file.  The following
--- fields can be set in 'opt':
---
---     * filename
---     * xoff,yoff (hotspot coordinates inside the image)
---
+--------------------------------------
+--   Basic Single Image Functions   --
+--------------------------------------
+
+-- Define a new image model.
+-- * 'name' is the name of the model being created
+-- * 'opt' contains optional information about the image file.
+--   The following fields can be set in 'opt':
+--    * filename
+--    * xoff,yoff (hotspot coordinates inside the image)
 -- Suitable default values are used for all options
-function def_image(name, opt)
+function DefImage(name, opt)
     opt = opt or {}
-    name = name or unique_modelname()
+    name = name or UniqueModelname()
     local fname = opt.filename or name
     local err = display.DefineImage(name, fname, opt.xoff or 0, opt.yoff or 0, opt.padding or 0)
     if err ~= 0 then
@@ -74,17 +75,22 @@
 end
 
 -- Define multiple image models at once.  Use the same options for all
--- of them.
-function def_images(names, opt)
+-- of them. The namelist contains the modelnames to be created.
+function DefImages(namelist, opt)
     opt = opt or {}
-    for i,name in pairs(names) do
-	def_image(name,opt)
+    for i,name in pairs(namelist) do
+	    DefImage(name,opt)
     end
 end
 
+-------------------------------------
+--   Basic Subdivision Functions   --
+-------------------------------------
+
 -- Define many image models from one single big image file.
-
-function def_subimages(name, options)
+-- Inputarguments are the imagefilename and the options.
+-- The defined models are named 'modelname1', 'modelname2' ...
+function DefSubimages(name, options)
     local opts = options or { }
     local w = opts.w or 1
     local h = opts.h or 1
@@ -117,26 +123,11 @@
     return imagelist
 end
 
-function map_tiles (imginfo, func)
-    local w = imginfo.w or 1
-    local h = imginfo.h or 1
-    local tilew = imginfo.tilew or TileSize
-    local tileh = imginfo.tileh or TileSize
-    local r=ecl.Rect:new(0,0,0,0)
-    local n=1
-    for y=0,h-1 do
-        for x=0,w-1 do
-            r.x,r.y = x*tilew,y*tileh
-            r.w,r.h = tilew, tileh
-            func(n, r)
-            n=n+1
-        end
-    end
-    r:delete()
-end
-
-
-function DefineTile (imagename, modelname, x, y)
+-- Generates an image model by cutting it out of a larger image.
+-- Arguments are the imagefilename, the modelname and the position
+-- where to cut a square with length TileSize. The position is
+-- measured in multiples of TileSize.
+function DefTile(imagename, modelname, x, y)
     local image = GetSurface (imagename)
     local r=ecl.Rect:new(x * TileSize, y*TileSize, TileSize, TileSize)
     local subsurface = CropSurface (image, r)
@@ -144,11 +135,11 @@
     r:delete()
 end
 
-
 -- Generate multiple image models by tiling a big image into many
--- smaller subimages.  The parameters are currently hardcoded, see
--- "items.png" for an example image.
-function DefineTiles(imagename, modelnames)
+-- smaller subimages.  The parameters are currently hardcoded.
+-- Arguments are the filename of the image and a list of
+-- modelnames to be generated out of this image.
+function DefTiles(imagename, modelnames)
     local xoff = 0
     local yoff = 0
     local tilew = TileSize
@@ -159,9 +150,7 @@
     local r=ecl.Rect:new(0,0,TileSize,TileSize)
     for i,mname in pairs(modelnames) do
         r.x,r.y,r.w,r.h = xoff,yoff,tilew,tileh
---        local subsurface = CropSurface (image, r)
---        DefineImageModel (mname, subsurface)
-        DefineTile (imagename, mname, xoff/TileSize, yoff/TileSize)
+        DefTile(imagename, mname, xoff/TileSize, yoff/TileSize)
         xoff = xoff + tilew
         if xoff >= imgw then
             xoff = 0
@@ -171,73 +160,26 @@
     r:delete()
 end
 
+-----------------------------------
+--   Basic Animation Functions   --
+-----------------------------------
 
-function def_stone(name, shmodel, opt)
-    opt = opt or {}
-    shmodel = shmodel or "sh-solid"
-    opt.filename = opt.filename or name
-    display.DefineShadedModel(name, def_image(nil, opt), shmodel)
-end
-
-function def_stone2(model, shmodel)
-    shmodel = shmodel or "sh-solid"
-    display.DefineShadedModel (model, model.."#", shmodel)
-end
-
-function def_stones(names)
-    for i,name in names do def_stone(name) end
-end
-function def_roundstones(names)
-    for i,name in names do def_stone(name, "sh-round") end
-end
-
--- Define a shaded model named `name' with texture model `fg' and
--- shadow model `bg'.  Both are real models (not names of image files), so
--- you can combine animated images with shadows etc.
-function def_shmodel(name, fg, bg)
-    display.DefineShadedModel(name, fg, bg)
-end
-
-function def_overlay(name, imglist)
-    display.DefineOverlayImage(name, getn(imglist), imglist)
-end
-
-function def_solidstone(name, front)
-    def_shmodel(name, front, "sh-solid")
-end
-function def_roundstone(name, front)
-    def_shmodel(name, front, "sh-round")
-end
-
-function def_floatingstone(name, front)
-    def_shmodel(name, front, "sh-floating")
-end
-
-function def_alias(name, othername)
-    display.DefineAlias(name,othername)
-end
-
-----------------
--- ANIMATIONS --
-----------------
-
 -- Generate a list of frame names by appending increasing numerical
--- prefixes to a base name.  For example, 'framenames("hello", 1,2)'
+-- prefixes to a base name.  For example, 'FrameNames("hello", 1,2)'
 -- yields {"hello_0001", "hello_0002"}.
 -- [Filenames like this are created by Gimp's "Video/Split Image.."
 -- tool.]
-
-function framenames(prefix, first, last)
+function FrameNames(prefix, first, last)
     local fn = {}
     for i=first,last do
-	table.insert(fn, prefix .. format("_%04d", i))
+	    table.insert(fn, prefix .. format("_%04d", i))
     end
     return fn
 end
 
 -- Build a list of frames from a list of model names and a constant
 -- duration.
-function buildframes(names, msec)
+function BuildFrames(names, msec)
     local a={}
     for i,n in pairs(names) do a[i] = {n, msec} end
     return a
@@ -246,86 +188,210 @@
 -- Build a list of frames from (1) a list of names and (2) a list of
 -- frame durations.  These two list are assumed to have the same
 -- number of entries, or, more generally, to have the same index set.
-function composeframes(namelist, mseclist)
+function ComposeFrames(namelist, mseclist)
     local a={}
     for i=1,getn(namelist) do a[i] = {namelist[i], mseclist[i]} end
     return a
 end
 
-
 -- Given a list of frames, this function generates a new framelist
 -- with for a ping-pong style animation.  (For example, an "abcd"
 -- style animation would result in an "abcddcba"-style one.)
-
-function pingpong(framelist)
+function PingPong(framelist)
     local a=framelist
     local n=getn(framelist)
     for i = 0,n-1 do
-	a[n+i+1] = framelist[n-i]
+	    a[n+i+1] = framelist[n-i]
     end
     return a
 end
 
-function repeat_frames(framelist, blocksize, cnt)
+-- Given a list of frames, this function generates a new framelist
+-- with repeated framesequence.  (For example, an "abcd"
+-- style animation with a cnt of 3 would result in an "abcdabcdabcd"-style one.)
+function RepeatFrames(framelist, blocksize, cnt)
     local a={}
     for i=1,getn(framelist),blocksize do
-	for j=1,cnt do
-	    for k=i,i+blocksize-1 do
-		table.insert(a,framelist[k])
+	    for j=1,cnt do
+	        for k=i,i+blocksize-1 do
+		        table.insert(a,framelist[k])
+	        end
 	    end
-	end
     end
     return a
 end
 
-function repeatanim(framelist, cnt)
-    return repeat_frames(framelist, getn(framelist), cnt or 2)
+-- Given a list of frames, this function generates a new framelist
+-- with repeated framesequence.  (For example, an "abcd"
+-- style animation with a cnt of 3 would result in an "abcdabcdabcd"-style one.)
+function RepeatAnim(framelist, cnt)
+    return RepeatFrames(framelist, getn(framelist), cnt or 2)
 end
 
-function reverseframes(framelist)
+-- Given a list of frames, this function generates a new framelist
+-- with reversed frame order.  (For example, an "abcd"
+-- style animation would result in an "dcba"-style one.)
+function ReverseFrames(framelist)
     local a={}
     for i=getn(framelist),1,-1 do
-	table.insert(a, framelist[i])
+	    table.insert(a, framelist[i])
     end
     return a
 end
 
 -- Define an animation from a list of images.  `frames' is a
--- framelist, as built with `framenames()', but the model names in
+-- framelist, as built with `FrameNames()', but the model names in
 -- this list are interpreted as image filenames.
-
-function def_anim_images(name, frames, opt)
+function DefAnimImages(name, frames, opt)
     opt = opt or {}
     local loopbool = opt.loop and true or false
     display.DefineAnim(name, loopbool)
     for i=1,getn(frames) do
-	local frame=frames[i]
-	opt.filename = frame[1]
-	local immodel = def_image(nil, opt)
-	display.AddFrame(name, immodel, frame[2])
+	    local frame=frames[i]
+	    opt.filename = frame[1]
+	    local immodel = DefImage(nil, opt)
+	    display.AddFrame(name, immodel, frame[2])
     end
 end
 
-
 -- Define an animation from a list of models.
-
-function def_anim(name, frames, loop)
+-- * 'name' is the name of the animation being created
+-- * 'frames' is the list of modelnames used
+function DefAnim(name, frames, loop)
     local loopbool = loop and true or false
     display.DefineAnim(name,loopbool)
     for i=1,getn(frames) do
-	local frame = frames[i]
-	display.AddFrame(name, frame[1], frame[2])
+	    local frame = frames[i]
+	    display.AddFrame(name, frame[1], frame[2])
     end
 end
 
-function NewAnim(name,opts) -- name, img, h,w,speed,pingpong, loop)
+-- Define a new Animation.
+-- * 'name' is the name of the animation being created
+-- * 'opt' contains optional information about the animation.
+function NewAnim(name,opts)
     local imagefile = opts.img or name
-    local h=opts.h or 1
-    local w=opts.w or 1
+    local h = opts.h or 1
+    local w = opts.w or 1
     local speed = opts.speed or 100
-    local loop=opts.loop or 0
+    local loop = opts.loop or 0
 
-    local frames = def_subimages(imagefile, {["h"]=h, ["w"]=w})
-    if opts.pingpong then frames=pingpong(frames) end
-    def_anim(name, buildframes(frames, speed), loop)
+    local frames = DefSubimages(imagefile, {["h"]=h, ["w"]=w})
+    if opts.pingpong then frames=PingPong(frames) end
+    DefAnim(name, BuildFrames(frames, speed), loop)
 end
+
+--------------------------
+--   Sprite functions   --
+--------------------------
+
+-- padding is calculated as:
+-- padding = (1.25 - 2*Actorradius)/2
+function SpriteImages(spriteimg, n, offsetfactor, padding)
+    local factor = offsetfactor or 0.5
+    local offset = -SpriteSize * factor
+    local pad = (padding or 0) * TileSize
+    return DefSubimages(spriteimg,
+                         {h = n, imgw=SpriteSize, imgh=SpriteSize,
+                             xoff = offset, yoff = offset, padding=pad})
+end
+
+function SpriteImage(spriteimg, offsetfactor, padding)
+    local factor = offsetfactor or 0.5
+    local offset = -SpriteSize * factor
+    local padding = (padding or 0) * TileSize
+    return DefImage(spriteimg, {xoff = offset, yoff = offset, padding=padding})
+end
+
+function SpriteWithShadow()
+
+end
+
+function SpriteAnim(name, images, shadows, framelen, loop)
+    local frames={}
+    local nframes = getn(images)
+    for i=1,getn(images) do
+        DefShModel(name..i, images[i], shadows[mod (i, getn(shadows))] )
+        table.insert(frames, name..i)
+    end
+    DefAnim (name, BuildFrames(frames, framelen), loop)
+end
+
+function Sprite(descr)
+    local imgfile = descr.imgfile or descr.name
+    local loop    = descr.loop or false
+    local img     = SpriteImages(imgfile, descr.nimages, 0.5, descr.padding)
+    DefAnim(descr.name, BuildFrames(img, descr.framelen), loop)
+end
+
+---------------------------------
+--   Floor related Functions   --
+---------------------------------
+
+-- Defines a random floor tile out of a given list.
+function DefRandFloor(name, imagelist)
+    display.DefineRandModel(name, getn(imagelist), imagelist)
+end
+
+-- Defines a random floor tile out of a given image with multiple tiles.
+-- This is used for the most kinds of floors.
+function DefRandFloorSi(name, height, width)
+    imagelist = DefSubimages(name, {h=height, w=width})
+    display.DefineRandModel(name, getn(imagelist), imagelist)
+end
+
+---------------------------------
+--   Stone related Functions   --
+---------------------------------
+
+-- Define a stone together with its shadow model:
+function DefStone(name, shmodel, opt)
+    opt = opt or {}
+    shmodel = shmodel or "sh-solid"
+    opt.filename = opt.filename or name
+    display.DefineShadedModel(name, DefImage(nil, opt), shmodel)
+end
+
+-- Define a shaded model named `name' with texture model `fg' and
+-- shadow model `bg'.  Both are real models (not names of image files), so
+-- you can combine animated images with shadows etc.
+function DefShModel(name, fg, bg)
+    display.DefineShadedModel(name, fg, bg)
+end
+
+function DefSolidStone(name, front)
+    DefShModel(name, front, "sh-solid")
+end
+
+function DefRoundStone(name, front)
+    DefShModel(name, front, "sh-round")
+end
+
+function DefFloatingStone(name, front)
+    DefShModel(name, front, "sh-floating")
+end
+
+-- Animated Stones --
+function DefSolidStoneWithAnim(name, npictures, frametime)
+    local n=DefSubimages(name, {h=npictures})
+    DefAnim(name.."-animfg", BuildFrames(n,frametime))
+    DefSolidStone(name.."-anim", name.."-animfg")
+    DefSolidStone(name, n[1])
+end
+
+function DefRoundStoneWithAnim(name, npictures, frametime)
+    local n=DefSubimages(name, {h=npictures})
+    DefAnim(name.."-animfg", BuildFrames(n,frametime))
+    DefRoundStone(name.."-anim", name.."-animfg")
+    DefRoundStone(name, n[1])
+end
+
+-- Aliases --
+function DefAlias(name, othername)
+    display.DefineAlias(name,othername)
+end
+
+-- Define an overlay --
+function DefOverlay(name, imglist)
+    display.DefineOverlayImage(name, getn(imglist), imglist)
+end



From ral at mail.berlios.de  Wed Apr 18 00:46:29 2007
From: ral at mail.berlios.de (ral at BerliOS)
Date: Wed, 18 Apr 2007 00:46:29 +0200
Subject: [Enigma-game-svn] r692 - in branches/1.0/src: gui lev
Message-ID: <200704172246.l3HMkT86008120@sheep.berlios.de>

Author: ral
Date: 2007-04-18 00:46:27 +0200 (Wed, 18 Apr 2007)
New Revision: 692

Modified:
   branches/1.0/src/gui/widgets.cc
   branches/1.0/src/gui/widgets.hh
   branches/1.0/src/lev/PersistentIndex.cc
Log:
Branch 1.0: 
- enable mouse wheel for most buttons like ratings, lang, volume,...
- eliminate duplicate level entries in auto in case of xml + invalid lua file


Modified: branches/1.0/src/gui/widgets.cc
===================================================================
--- branches/1.0/src/gui/widgets.cc	2007-04-15 21:45:05 UTC (rev 691)
+++ branches/1.0/src/gui/widgets.cc	2007-04-17 22:46:27 UTC (rev 692)
@@ -710,9 +710,16 @@
 
     case SDL_KEYUP:
         if (e.key.keysym.sym != SDLK_RETURN &&
-            e.key.keysym.sym != SDLK_SPACE) break;
-        // fall-through
+            e.key.keysym.sym != SDLK_SPACE &&
+            e.key.keysym.sym != SDLK_PAGEDOWN &&
+            e.key.keysym.sym != SDLK_PAGEUP) break;
+        lastUpSym = e.key.keysym.sym;
+        lastUpBotton = 0;
+        m_pressedp = false;
+        break;
     case SDL_MOUSEBUTTONUP:
+        lastUpSym = SDLK_UNKNOWN;
+        lastUpBotton = e.button.button;
         m_pressedp = false;
         break;
     }
@@ -721,7 +728,8 @@
     if (changed) {
         invalidate();
         if (!m_pressedp) {
-            sound::SoundEvent ("menuok");
+            if (soundOk())
+                sound::SoundEvent("menuok");
             invoke_listener();
         }
     }
@@ -731,10 +739,23 @@
 
 void PushButton::deactivate() {
     m_pressedp = false;
+    lastUpSym = SDLK_UNKNOWN;
+    lastUpBotton = 0;
     invalidate();
     Button::deactivate();
 }
 
+SDLKey PushButton::getLastUpSym() {
+    return lastUpSym;
+}
+
+Uint8 PushButton::getLastUpButton() {
+    return lastUpBotton;
+}
+
+bool PushButton::soundOk() {
+    return true;
+}
 
 /* -------------------- TextButton -------------------- */
 
@@ -859,34 +880,38 @@
     return false;
 }
 
-bool ValueButton::on_event (const SDL_Event &e) {
-    // handles button movement and
-    bool handled = PushButton::on_event(e);
 
-    if (e.type == SDL_KEYDOWN) {
-        bool keyhandled   = true;
-        bool changed = false;
-
-        switch (e.key.keysym.sym) {
-        case SDLK_PAGEUP: changed = inc_value(1); break;
-        case SDLK_PAGEDOWN:  changed = inc_value(-1); break;
-        default : keyhandled = false; break;
+void ValueButton::on_action(Widget *) {
+    int incr = 1;
+    bool stop = false;
+    if (getLastUpSym() == SDLK_PAGEDOWN || getLastUpButton() == SDL_BUTTON_RIGHT ||
+            getLastUpButton() == 5) {  // wheel down
+        incr = -1;
+    }
+    if (getLastUpSym() == SDLK_PAGEDOWN || getLastUpSym() == SDLK_PAGEUP ||
+            getLastUpButton() == SDL_BUTTON_RIGHT ||
+            getLastUpButton() ==  4 || getLastUpButton() == 5) {
+        stop = true;
+    }
+    if (inc_value(incr)) {
+        sound::SoundEvent("menuswitch");
+    } else {
+        if (stop) {
+            sound::SoundEvent("menustop");
+        } else {
+            sound::SoundEvent("menuswitch");
+            if (incr == 1)
+                update_value(get_value(), min_value);
+            else
+                update_value(get_value(), max_value);
         }
-
-        if (keyhandled) {
-            handled = true;
-            sound::SoundEvent (changed ? "menuswitch" : "menustop");
-        }
     }
-    return handled;
 }
 
-void ValueButton::on_action(Widget *) {
-    if (!inc_value(1))
-        update_value(get_value(), min_value);
+bool ValueButton::soundOk() {
+    return false;
 }
 
-
 /* -------------------- ImageButton -------------------- */
 
 ImageButton::ImageButton(const string &unselected,

Modified: branches/1.0/src/gui/widgets.hh
===================================================================
--- branches/1.0/src/gui/widgets.hh	2007-04-15 21:45:05 UTC (rev 691)
+++ branches/1.0/src/gui/widgets.hh	2007-04-17 22:46:27 UTC (rev 692)
@@ -347,11 +347,17 @@
         PushButton();
 
         bool is_pressed() { return m_pressedp; }
+        
     protected:
         bool on_event(const SDL_Event &e);
         void deactivate();
+        SDLKey getLastUpSym();
+        Uint8 getLastUpButton();
+        virtual bool soundOk(); 
     private:
         bool m_pressedp;
+        SDLKey lastUpSym;
+        Uint8 lastUpBotton;
     };
 
 /* -------------------- TextButton -------------------- */
@@ -429,10 +435,10 @@
         virtual std::string get_text() const;
 
         // Widget interface.
-        virtual bool on_event(const SDL_Event &e);
         virtual void on_action(Widget *w);
     protected:
         void init(); // called in ctor of derived
+        virtual bool soundOk(); 
     private:
         int min_value;
         int max_value;

Modified: branches/1.0/src/lev/PersistentIndex.cc
===================================================================
--- branches/1.0/src/lev/PersistentIndex.cc	2007-04-15 21:45:05 UTC (rev 691)
+++ branches/1.0/src/lev/PersistentIndex.cc	2007-04-17 22:46:27 UTC (rev 692)
@@ -193,9 +193,10 @@
                     if (newProxy != NULL) {
                         // first check that the proxy is not in the index
                         //  - may occur if the level is stored as .xml and .lua in the folder
-                        
-                        // is it is new, add it
-                        autoIndex->appendProxy(newProxy);
+                        if (!autoIndex->containsProxy(newProxy)) {
+                            // it is new, add it
+                            autoIndex->appendProxy(newProxy);
+                        }
                     }
                 }
             }



From andreasl at mail.berlios.de  Fri Apr 20 14:02:58 2007
From: andreasl at mail.berlios.de (andreasl at BerliOS)
Date: Fri, 20 Apr 2007 14:02:58 +0200
Subject: [Enigma-game-svn] r693 - in branches/1.0: data doc/reference src
	src/gui src/lev
Message-ID: <200704201202.l3KC2wZs022032@sheep.berlios.de>

Author: andreasl
Date: 2007-04-20 14:02:41 +0200 (Fri, 20 Apr 2007)
New Revision: 693

Added:
   branches/1.0/data/sound-defaults.lua
Modified:
   branches/1.0/data/startup.lua
   branches/1.0/doc/reference/sound.lua
   branches/1.0/src/actors.cc
   branches/1.0/src/actors.hh
   branches/1.0/src/client.cc
   branches/1.0/src/enigma-lua.pkg
   branches/1.0/src/gui/LevelPackComposer.cc
   branches/1.0/src/gui/LevelWidget.cc
   branches/1.0/src/gui/Menu.cc
   branches/1.0/src/gui/OptionsMenu.cc
   branches/1.0/src/gui/OptionsMenu.hh
   branches/1.0/src/gui/TextField.cc
   branches/1.0/src/gui/widgets.cc
   branches/1.0/src/items.cc
   branches/1.0/src/laser.cc
   branches/1.0/src/lev/Index.cc
   branches/1.0/src/lev/Index.hh
   branches/1.0/src/lua-display.cc
   branches/1.0/src/lua-display.hh
   branches/1.0/src/lua-ecl.cc
   branches/1.0/src/lua-ecl.hh
   branches/1.0/src/lua-editor.cc
   branches/1.0/src/lua-editor.hh
   branches/1.0/src/lua-enigma.cc
   branches/1.0/src/lua-enigma.hh
   branches/1.0/src/lua-global.cc
   branches/1.0/src/lua-global.hh
   branches/1.0/src/lua.cc
   branches/1.0/src/lua.hh
   branches/1.0/src/main.cc
   branches/1.0/src/objects.cc
   branches/1.0/src/objects_decl.hh
   branches/1.0/src/oxyd.cc
   branches/1.0/src/oxyd.hh
   branches/1.0/src/oxyd_internal.hh
   branches/1.0/src/player.cc
   branches/1.0/src/sound.cc
   branches/1.0/src/sound.hh
   branches/1.0/src/sound_internal.hh
   branches/1.0/src/stones_complex.cc
   branches/1.0/src/world.cc
   branches/1.0/src/world.hh
   branches/1.0/src/world_internal.hh
Log:
Sound event rework, Part II
 - disentagled C++ and Lua parts: Sound effect data is transfered to C++ on startup,
   no lua requests during runtime for sound events anymore.
 - added user sound set support
 - moved damping code from world.cc to sound.cc
 - moved lots of sound option menu code from OptionsMenu.cc to sound.cc
 - moved not-oxyd-related parts of sound set initialisation from oxyd.cc to sound.cc
 - damping additionally depends on sound effect name
 - write "silence string" to command line when a non-existing sound is
   requested by lua (needed for "Acoustic Memory" when using incomplete user
   sound sets)
 - silent sound set (deactivated by default)
Todo:
 - rename data/sound to data/soundsets
 - move default sounds to data/soundsets/enigma (?)
 - documentation in reference manual
 - sound priorities
 - correctly coalesce sounds with different volumes


Added: branches/1.0/data/sound-defaults.lua
===================================================================
--- branches/1.0/data/sound-defaults.lua	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/data/sound-defaults.lua	2007-04-20 12:02:41 UTC (rev 693)
@@ -0,0 +1,401 @@
+------------------------------------------------------------------------
+-- Copyright (C) 2002,2003,2004,2005 Daniel Heck
+-- Copyright (C) 2007 Andreas Lochmann
+--
+-- This program is free software; you can redistribute it and/or
+-- modify it under the terms of the GNU General Public License
+-- as published by the Free Software Foundation; either version 2
+-- of the License, or (at your option) any later version.
+--
+-- This program is distributed in the hope that it will be useful,
+-- but WITHOUT ANY WARRANTY; without even the implied warranty of
+-- MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+-- GNU General Public License for more details.
+--
+-- You should have received a copy of the GNU General Public License along
+-- with this program; if not, write to the Free Software Foundation, Inc.,
+-- 59 Temple Place, Suite 330, Boston, MA 02111-1307, USA.
+--
+-- $Id: startup.lua,v 1.21 2004/02/15 11:54:36 dheck Exp $
+------------------------------------------------------------------------
+
+----------------------------------------------------------------------
+-- Sound handling
+----------------------------------------------------------------------
+
+default_sound = { name = "",
+                  file = "",
+                  volume = 1.0,
+                  loop = false,
+                  global = false,
+                  priority = 1,
+                  damp_max = 10.0,
+                  damp_inc = 1.0,
+                  damp_mult = 1.0,
+                  damp_min = 0.5,
+                  damp_tick = 0.9,
+                  silence_string = "$default$" }
+
+-- Complete a sound definition
+function complete_sound(k, t)
+    local tt = {}
+    if type(t) == "string" then
+        for key, value in pairs(default_sound) do
+            tt[key] = value
+        end
+        tt.file = t
+    elseif type(t) == "table" then
+        for key, value in pairs(default_sound) do
+            tt[key] = t[key] or value
+            -- Special fix for "global" and "loop" values of 1.00 sound sets
+            if (key == "global") or (key == "loop") then
+                if tt[key] == 1 then
+                    tt[key] = true
+                elseif tt[key] == 0 then
+                    tt[key] = false
+                end
+            end
+        end
+    else
+        error("Syntax error in sound table, effect name "..k..".")
+        return default_sound
+    end
+    -- Fill in the silence string if requested
+    if (tt.silence_string == "$default$") then
+        tt.silence_string = soundtable_silent[k].silence_string or k
+    end
+    return tt
+end
+
+-- Copy all key/value pairs only present in t1 to t2.
+function copy_missing (t1, t2)
+    for k,v in pairs(t1) do
+        t2[k] = t2[k] or v
+    end
+end
+
+-- Add a new sound set
+function AddSoundSet (tablename, t)
+    for key, value in pairs(t) do
+        r = complete_sound(key, value)  -- completed data set
+        sound.DefineSoundEffect(tablename, key, r.file, r.volume, r.loop,
+            r.global, r.priority, r.damp_max, r.damp_inc, r.damp_mult,
+            r.damp_min, r.damp_tick, r.silence_string)
+    end
+end
+
+-- Activate a sound set by name
+function ActivateSoundSet (name)
+    sound.SetActiveSoundSet(name)
+end
+
+-- Compatibility with 1.00 sound.lua's
+function Sound (t)  return t  end
+AddSoundTable = AddSoundSet
+
+---------------------------------
+-- Definition of sound effects --
+---------------------------------
+
+------------------------
+-- Enigma Sound table --
+------------------------
+
+-- Note that no "#" is allowed within a sound event name!
+
+soundtable_enigma = {
+    [""]           = "",        -- empty sound
+    ballcollision  = "ballcollision",
+    blackbomb      = "explosion1",
+    blockerdown    = "",
+    blockerup      = "",
+    booze          = "",
+    bumper         = "bumper",
+    cloth          = { file="st-thud", damp_max = 4.0 },
+    coinslotoff    = "",
+    coinsloton     = "st-coinslot",
+    crack          = "",
+    doorclose      = "doorclose",  -- missing
+    dooropen       = "dooropen",   -- missing
+    drown          = "drown",
+    dynamite       = "explosion2", -- replace?
+    electric       = "st-stone",   -- replace
+    exit           = { file="exit", global=true },  -- missing
+    extinguish     = "",
+    fakeoxyd       = { file="st-fakeoxyd", volume=0.3 },
+    falldown       = "falldown",   -- missing, unused (falling is shatter!)
+    fart           = "fart",
+    finished       = { file="finished", global=true },  -- missing
+    floordestroy   = "",
+    fourswitch     = "st-switch", 
+    glass          = "st-metal",   -- replace
+    hitfloor       = "stone",      -- missing, used by it-vortex
+    impulse        = "",
+    intro          = { file="intro", global=true },  -- missing
+    invrotate      = { file="invrotate", global=true },
+    itemtransform  = "st-magic",
+    jump           = "boink",
+    jumppad        = "",
+    landmine       = "explosion2",  -- replace?
+    laserloop      = "",
+    laseron        = { file="st-laser", damp_max = 20.0, damp_inc = 2.0 },
+    laseroff       = "",
+    lock           = "",
+    magneton       = "",
+    magnetoff      = "",
+    mail           = "",
+    menuexit        = { file="menuexit", global=true },
+    menumove        = { file="menumove", global=true },
+    menuok          = { file="menuok", global=true },
+    menustop        = { file="menustop", global=true },
+    menuswitch      = { file="menuswitch", global=true },
+    metal          = "st-metal",
+    mirrorturn     = "st-mirrorturn",
+    movebig        = "st-move",
+    moveslow       = "st-move",
+    movesmall      = { file="st-move", damp_max = 10.0, damp_inc = 2.0 },
+    oxydclose      = "st-oxydclose",  -- missing, not neccessary I think
+    oxydopen       = { file="st-oxydopen", damp_max = 2000.0, damp_inc = 50.0 },
+    oxydopened     = "st-oxydopened",
+    pickup         = { file="pickup", global=true },
+    puller         = "",
+    puzzlerotate   = "st-move",
+    rubberband     = "boing",
+    scissors       = "",
+    seedgrow       = "seedgrow",  -- missing
+    shatter        = "shatter",
+    shattersmall   = "shatter",   -- replace, "shattersmall" is missing
+    shogunoff      = "",
+    shogunon       = "",
+    skull          = "",
+    spade          = "",
+    squish         = "",
+    stone          = "st-stone",
+    stonedestroy   = "explosion0",
+    stonepaint     = "st-magic",
+    stonetransform = "st-magic",
+    swamp          = "swamped",
+    switchmarbles  = "warp",      -- missing
+    switchoff      = "",
+    switchon       = "st-switch",
+    switchplayer   = "switch",
+    sword          = "",
+    thief          = "thief",     -- missing
+    triggerdown    = "it-triggerdown",
+    triggerup      = "it-triggerup",
+    turnstileleft  = "turnstileleft",  -- missing
+    turnstileright = "turnstileright", -- missing
+    umbrellaoff    = "",
+    umbrellaon     = "",
+    umbrellawarn   = "",
+    unlock         = "unlock",    -- missing
+    vortexclose    = "doorclose", -- missing
+    vortexopen     = "dooropen",  -- missing
+    warp           = "warp",      -- missing, maybe suck2?
+    whitebomb      = "explosion1",
+    wood           = "wood",
+    yinyang        = "st-magic",
+}
+
+soundtable_silent = {
+    [""]           = "",        -- empty sound
+    ballcollision  = { silence_string = "tack" },
+    blackbomb      = { silence_string = "KABOOM!" },
+    blockerdown    = "",
+    blockerup      = "",
+    booze          = "",
+    bumper         = { silence_string = "Doinc" },
+    cloth          = { silence_string = "bump" },
+    coinslotoff    = "",
+    coinsloton     = { silence_string = "kachink" },
+    crack          = { silence_string = "Crrr..." },
+    doorclose      = "",
+    dooropen       = "",
+    drown          = { silence_string = "blupp" },
+    dynamite       = { silence_string = "Boom!" },
+    electric       = { silence_string = "cling" },
+    exit           = "",
+    extinguish     = { silence_string = "pfff..." },
+    fakeoxyd       = { silence_string = "ding-dang" },
+    falldown       = "",
+    fart           = { silence_string = "Prfft!" },
+    finished       = { silence_string = "Finished!" },
+    floordestroy   = { silence_string = "CrraaACK!" },
+    fourswitch     = { silence_string = "Clihick" }, 
+    glass          = { silence_string = "Cliorr" },
+    hitfloor       = { silence_string = "Bang" },
+    impulse        = "",
+    intro          = "",
+    invrotate      = "",
+    itemtransform  = { silence_string = "Tatam!" },
+    jump           = { silence_string = "Doink" },
+    jumppad        = { silence_string = "da-Doink" },
+    landmine       = { silence_string = "click-BANG!" },
+    laserloop      = "",
+    laseron        = { silence_string = "wuuiim!" },
+    laseroff       = "",
+    lock           = "",
+    magneton       = "",
+    magnetoff      = "",
+    mail           = "",
+    menuexit       = "",
+    menumove       = "",
+    menuok         = "",
+    menustop       = "",
+    menuswitch     = "",
+    metal          = { silence_string = "clang" },
+    mirrorturn     = { silence_string = "wrrr" },
+    movebig        = { silence_string = "swosh" },
+    moveslow       = { silence_string = "swosh" },
+    movesmall      = { silence_string = "swosh" },
+    oxydclose      = "",
+    oxydopen       = { silence_string = "da-Ding" },
+    oxydopened     = { silence_string = "da-Dang!" },
+    pickup         = { silence_string = "pick" },
+    puller         = "",
+    puzzlerotate   = { silence_string = "rot-rot" },
+    rubberband     = { silence_string = "Boing!" },
+    scissors       = "",
+    seedgrow       = { silence_string = "krk...krk" },
+    shatter        = { silence_string = "CLIRR!!" },
+    shattersmall   = { silence_string = "CLIRR!" },
+    shogunoff      = "",
+    shogunon       = "",
+    skull          = "",
+    spade          = "",
+    squish         = "",
+    stone          = { silence_string = "dopp" },
+    stonedestroy   = { silence_string = "BANG!" },
+    stonepaint     = { silence_string = "flatsh" },
+    stonetransform = { silence_string = "Tradam!" },
+    swamp          = { silence_string = "gulp" },
+    switchmarbles  = "",
+    switchoff      = "",
+    switchon       = { silence_string = "Click" },
+    switchplayer   = { silence_string = "switch-switch" },
+    sword          = "",
+    thief          = { silence_string = "hehee!" },
+    triggerdown    = { silence_string = "ca-lik" },
+    triggerup      = { silence_string = "ca-lak" },
+    turnstileleft  = "",
+    turnstileright = "",
+    umbrellaoff    = "",
+    umbrellaon     = "",
+    umbrellawarn   = "",
+    unlock         = "",
+    vortexclose    = "",
+    vortexopen     = "",
+    warp           = "",
+    whitebomb      = { silence_string = "KABOOOOM!!" },
+    wood           = { silence_string = "dok" },
+    yinyang        = { silence_string = "Tradim!" },
+}
+
+soundtable_oxyd = {
+    [""]           = "",        -- empty sound
+    ballcollision  = "OXKLICK3.SDD",
+    blackbomb      = "OXCRASH2.SDD",
+    blockerdown    = "",
+    blockerup      = "",
+    booze          = "",
+    bumper         = "OXWOUOU.SDD",
+    cloth          = "OXKLICK4.SDD",
+    coinslotoff    = "",
+    coinsloton     = "OXMONEY.SDD",
+    crack          = { file="OXCRACK.SDD", volume=0.7 },
+    doorclose      = "OXMOTOR.SDD",
+    dooropen       = "OXMOTOR.SDD",
+    drown          = "OXBLOOP.SDD",
+    dynamite       = "OXCRASH1.SDD",
+    electric       = "OXKLICK6.SDD",
+    exit           = { file="OXEXIT.SDD", global=true },
+    extinguish     = "",
+    fakeoxyd       = "",
+    falldown       = "",
+    fart           = "OXUNTITL.SDD",
+    finished       = { file="OXFINITO.SDD", global=true },
+    floordestroy   = "OXCRASH2",
+    fourswitch     = "",
+    glass          = "OXKLICK1.SDD",
+    hitfloor       = "OXKLICK1.SDD",
+    impulse        = "OXWOUOU.SDD",
+    intro          = { file="OXINTRO.SDD", global=true },
+    invrotate      = { file="OXINVROT.SDD", global=true },
+    itemtransform  = "OXMAGIC1.SDD",
+    jump           = "OXJUMP.SDD",
+    jumppad        = "",
+    landmine       = "explosion1",
+    laserloop      = "",
+    laseron        = "OXLASER.SDD",
+    laseroff       = "",
+    lock           = "",
+    magneton       = "",
+    magnetoff      = "",
+    mail           = "",
+    metal          = "OXKLICK2.SDD",
+    mirrorturn     = "OXTURN.SDD",
+    movebig        = "OXMOVE.SDD",
+    moveslow       = "OXMOVE.SDD",
+    movesmall      = "OXMOVE.SDD",
+    oxydclose      = "OXMEMCL.SDD",
+    oxydopen       = "OXMEMOP.SDD",
+    oxydopened     = "OXMEMOK.SDD",
+    pickup         = "OXINVENT.SDD",
+    puller         = "OXPULLER.SDD",
+    puzzlerotate   = "OXMOVE.SDD",
+    rubberband     = "OXBOING.SDD",
+    scissors       = "OXCUT.SDD",
+    seedgrow       = "",
+    shatter        = "OXKLIRR.SDD",
+    shattersmall   = "OXKLIRR.SDD",
+    shogunoff      = "",
+    shogunon       = "",
+    skull          = "",
+    spade          = "",
+    squish         = "OXMATSCH.SDD",
+    stone          = "OXKLICK1.SDD",
+    stonedestroy   = "OXCRASH2.SDD",
+    stonepaint     = "OXMAGIC.SDD",
+    stonetransform = "OXMAGIC.SDD",
+    swamp          = "OXBLOOP.SDD",
+    switchmarbles  = "",
+    switchoff      = "",
+    switchon       = "",
+    switchplayer   = "",
+    sword          = "",
+    thief          = "OXTHIEF.SDD",
+    triggerdown    = "OXSWON.SDD",
+    triggerup      = "OXSWOFF.SDD",
+    turnstileleft  = "OXMAGIC4.SDD",
+    turnstileright = "OXMAGIC3.SDD",
+    umbrellaoff    = "",
+    umbrellaon     = "",
+    umbrellawarn   = "",
+    unlock         = "",
+    vortexclose    = "OXMOTOR.SDD",
+    vortexopen     = "OXMOTOR.SDD",
+    warp           = "OXTRANS.SDD",
+    whitebomb      = "OXCRASH2.SDD",
+    wood           = "OXKLICK1.SDD",
+    yinyang        = "OXMAGIC.SDD",
+}    
+copy_missing (soundtable_enigma, soundtable_oxyd)
+
+soundtable_oxm = {
+    turnstileleft = "OXTURNL.SDD",
+    turnstileright = "OXTURNL.SDD"
+}
+copy_missing (soundtable_oxyd, soundtable_oxm)
+
+--------------------------------------
+-- Register predefined sound tables --
+--------------------------------------
+
+AddSoundSet ("Oxyd*", soundtable_oxyd)
+AddSoundSet ("Magnum*", soundtable_oxm)
+--AddSoundSet ("Silent", soundtable_silent)
+AddSoundSet ("Enigma", soundtable_enigma)
+
+ActivateSoundSet ("Enigma")
+
+

Modified: branches/1.0/data/startup.lua
===================================================================
--- branches/1.0/data/startup.lua	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/data/startup.lua	2007-04-20 12:02:41 UTC (rev 693)
@@ -42,10 +42,11 @@
     -- 0   = 'enigma' for enigma, appropriate oxyd sound sets for oxyd versions
     -- 1   = 'enigma'
     -- 2.. = OxydVersion-2
+    SoundSetName     = "Enigma",
 
     SkipSolvedLevels = 0,
     TimeHunting      = 0,
- 
+
     SoundVolume      = 1.0,
     MusicVolume      = 1.0,
     StereoSeparation = 10.0,
@@ -246,293 +247,3 @@
 def_floor("fl-trigger",      3.0,   1.5,    true,   "")
 def_floor("fl-abyss_fake",   3.0,   2.0,   false,   "")
 
-----------------------------------------------------------------------
--- Sound handling
-----------------------------------------------------------------------
-
--- Create a new sound definition
-function Sound(t)
-    local tt = {}
-    tt.file     = t.file
-    tt.volume   = t.volume or 1.0
-    tt.loop     = t.loop or nil
-    tt.global   = t.global or nil
-    tt.priority = t.priority or 1
-    return tt
-end
-
--- Copy all key/value pairs only present in t1 to t2.
-function copy_missing (t1, t2)
-    for k,v in pairs(t1) do
-        if not t2[k] then
-            t2[k] = v
-        end
-    end
-end
-
-
--- The list of available sound tables
-soundtables = {}
-
--- The currently active sound table
-soundtable = {}
-soundtable_name = ""
-
-
-function AddSoundTable (name, t)
-    e = {}
-    e.name = name
-    e.table = t
-    soundtables[name] = e
-
-    -- current soundtable has been replaced
-    if (name == soundtable_name) then
-        ActivateSoundTable (name)
-    end
-end
-
-
-function ActivateSoundTable (name)
-    st = soundtables[name]
-    if st then
-        soundtable = st.table
-        soundtable_name = name
-    end
-end
-
-function SoundEvent (eventname, xpos, ypos, volume) 
-    local s = soundtable[eventname]
-    if s then
-        if type(s) == "string" then
-            enigma.PlaySound (s, xpos, ypos, volume, 1.0)
-        elseif s.global then
-            enigma.PlaySoundGlobal (s.file, s.volume * volume, s.priority)
-        else
-            enigma.PlaySound (s.file, xpos, ypos, s.volume * volume, s.priority)
-        end
-        return 1
-    end
-    print ("Undefined sound event " .. eventname .. " @ " .. xpos .. "," .. ypos)
-    return nil
-end
-
-
----------------------------------
--- Definition of sound effects --
----------------------------------
-
-------------------------
--- Enigma Sound table --
-------------------------
-
-soundtable_enigma = {
-    [""]           = "",        -- empty sound
-    ballcollision  = "ballcollision",
-    blackbomb      = "explosion1",
-    blockerdown    = "",
-    blockerup      = "",
-    booze          = "",
-    bumper         = "bumper",
-    cloth          = "st-thud",
-    coinslotoff    = "",
-    coinsloton     = "st-coinslot",
-    crack          = "",
-    doorclose      = "doorclose",  -- missing
-    dooropen       = "dooropen",   -- missing
-    drown          = "drown",
-    dynamite       = "explosion2", -- replace?
-    electric       = "st-stone",   -- replace
-    exit           = Sound { file="exit", global=1 },  -- missing
-    extinguish     = "",
-    fakeoxyd       = Sound { file="st-fakeoxyd", volume=0.3 },
-    falldown       = "falldown",   -- missing, unused (falling is shatter!)
-    fart           = "fart",
-    finished       = Sound { file="finished", global=1 },  -- missing
-    floordestroy   = "",
-    fourswitch     = "st-switch", 
-    glass          = "st-metal",   -- replace
-    hitfloor       = "stone",      -- missing, used by it-vortex
-    impulse        = "",
-    intro          = Sound { file="intro", global=1 },  -- missing
-    invrotate      = Sound { file="invrotate", global=1 },
-    itemtransform  = "st-magic",
-    jump           = "boink",
-    jumppad        = "",
-    landmine       = "explosion2",  -- replace?
-    laserloop      = "",
-    laseron        = "st-laser",
-    laseroff       = "",
-    lock           = "",
-    magneton       = "",
-    magnetoff      = "",
-    mail           = "",
-    menuexit        = Sound { file="menuexit", global=1 },
-    menumove        = Sound { file="menumove",global=1 },
-    menuok          = Sound { file="menuok",global=1 },
-    menustop        = Sound { file="menustop",global=1 },
-    menuswitch      = Sound { file="menuswitch",global=1 },
-    metal          = "st-metal",
-    mirrorturn     = "st-mirrorturn",
-    movebig        = "st-move",
-    moveslow       = "st-move",
-    movesmall      = "st-move",
-    oxydclose      = "st-oxydclose",  -- missing, not neccessary I think
-    oxydopen       = "st-oxydopen",
-    oxydopened     = "st-oxydopened",
-    pickup         = Sound {file="pickup", global=1},
-    puller         = "",
-    puzzlerotate   = "st-move",
-    rubberband     = "boing",
-    scissors       = "",
-    seedgrow       = "seedgrow",  -- missing
-    shatter        = "shatter",
-    shattersmall   = "shatter",   -- replace, "shattersmall" is missing
-    shogunoff      = "",
-    shogunon       = "",
-    skull          = "",
-    spade          = "",
-    squish         = "",
-    stone          = "st-stone",
-    stonedestroy   = "explosion0",
-    stonepaint     = "st-magic",
-    stonetransform = "st-magic",
-    swamp          = "swamped",
-    switchmarbles  = "warp",      -- missing
-    switchoff      = "",
-    switchon       = "st-switch",
-    switchplayer   = "switch",
-    sword          = "",
-    thief          = "thief",     -- missing
-    triggerdown    = "it-triggerdown",
-    triggerup      = "it-triggerup",
-    turnstileleft  = "turnstileleft",  -- missing
-    turnstileright = "turnstileright", -- missing
-    umbrellaoff    = "",
-    umbrellaon     = "",
-    umbrellawarn   = "",
-    unlock         = "unlock",    -- missing
-    vortexclose    = "doorclose", -- missing
-    vortexopen     = "dooropen",  -- missing
-    warp           = "warp",      -- missing, maybe suck2?
-    whitebomb      = "explosion1",
-    wood           = "wood",
-    yinyang        = "st-magic",
-}
-
-
-
-soundtable_oxyd = {
-    [""]           = "",        -- empty sound
-    ballcollision  = "OXKLICK3.SDD",
-    blackbomb      = "OXCRASH2.SDD",
-    blockerdown    = "",
-    blockerup      = "",
-    booze          = "",
-    bumper         = "OXWOUOU.SDD",
-    cloth          = "OXKLICK4.SDD",
-    coinslotoff    = "",
-    coinsloton     = "OXMONEY.SDD",
-    crack          = Sound { file="OXCRACK.SDD", volume=0.7 },
-    doorclose      = "OXMOTOR.SDD",
-    dooropen       = "OXMOTOR.SDD",
-    drown          = "OXBLOOP.SDD",
-    dynamite       = "OXCRASH1.SDD",
-    electric       = "OXKLICK6.SDD",
-    exit           = Sound { file="OXEXIT.SDD", global=1 },
-    extinguish     = "",
-    fakeoxyd       = "",
-    falldown       = "",
-    fart           = "OXUNTITL.SDD",
-    finished       = Sound { file="OXFINITO.SDD", global=1 },
-    floordestroy   = "OXCRASH2",
-    fourswitch     = "",
-    glass          = "OXKLICK1.SDD",
-    hitfloor       = "OXKLICK1.SDD",
-    impulse        = "OXWOUOU.SDD",
-    intro          = Sound { file="OXINTRO.SDD", global=1 },
-    invrotate      = Sound { file="OXINVROT.SDD", global=1 },
-    itemtransform  = "OXMAGIC1.SDD",
-    jump           = "OXJUMP.SDD",
-    jumppad        = "",
-    landmine       = "explosion1",
-    laserloop      = "",
-    laseron        = "OXLASER.SDD",
-    laseroff       = "",
-    lock           = "",
-    magneton       = "",
-    magnetoff      = "",
-    mail           = "",
-    metal          = "OXKLICK2.SDD",
-    mirrorturn     = "OXTURN.SDD",
-    movebig        = "OXMOVE.SDD",
-    moveslow       = "OXMOVE.SDD",
-    movesmall      = "OXMOVE.SDD",
-    oxydclose      = "OXMEMCL.SDD",
-    oxydopen       = "OXMEMOP.SDD",
-    oxydopened     = "OXMEMOK.SDD",
-    pickup         = "OXINVENT.SDD",
-    puller         = "OXPULLER.SDD",
-    puzzlerotate   = "OXMOVE.SDD",
-    rubberband     = "OXBOING.SDD",
-    scissors       = "OXCUT.SDD",
-    seedgrow       = "",
-    shatter        = "OXKLIRR.SDD",
-    shattersmall   = "OXKLIRR.SDD",
-    shogunoff      = "",
-    shogunon       = "",
-    skull          = "",
-    spade          = "",
-    squish         = "OXMATSCH.SDD",
-    stone          = "OXKLICK1.SDD",
-    stonedestroy   = "OXCRASH2.SDD",
-    stonepaint     = "OXMAGIC.SDD",
-    stonetransform = "OXMAGIC.SDD",
-    swamp          = "OXBLOOP.SDD",
-    switchmarbles  = "",
-    switchoff      = "",
-    switchon       = "",
-    switchplayer   = "",
-    sword          = "",
-    thief          = "OXTHIEF.SDD",
-    triggerdown    = "OXSWON.SDD",
-    triggerup      = "OXSWOFF.SDD",
-    turnstileleft  = "OXMAGIC4.SDD",
-    turnstileright = "OXMAGIC3.SDD",
-    umbrellaoff    = "",
-    umbrellaon     = "",
-    umbrellawarn   = "",
-    unlock         = "",
-    vortexclose    = "OXMOTOR.SDD",
-    vortexopen     = "OXMOTOR.SDD",
-    warp           = "OXTRANS.SDD",
-    whitebomb      = "OXCRASH2.SDD",
-    wood           = "OXKLICK1.SDD",
-    yinyang        = "OXMAGIC.SDD",
-}    
-copy_missing (soundtable_enigma, soundtable_oxyd)
-
-soundtable_oxm = {
-    turnstileleft = "OXTURNL.SDD",
-    turnstileright = "OXTURNL.SDD"
-}
-copy_missing (soundtable_oxyd, soundtable_oxm)
-
---------------------------------------
--- Register predefined sound tables --
---------------------------------------
-
-AddSoundTable ("Oxyd", soundtable_oxyd)
-AddSoundTable ("OxydMag", soundtable_oxm)
-AddSoundTable ("Enigma", soundtable_enigma)
-
-ActivateSoundTable ("Enigma")
-
-------------------------------------------
--- Load external sound description file --
-------------------------------------------
--- local f = enigma.FindDataFile("sound/sound.lua")
--- if f then                       -- present?
---     dofile (f)
--- end
-
---soundtable = soundtable_enigma

Modified: branches/1.0/doc/reference/sound.lua
===================================================================
--- branches/1.0/doc/reference/sound.lua	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/doc/reference/sound.lua	2007-04-20 12:02:41 UTC (rev 693)
@@ -1,16 +1,16 @@
 --
--- This file demonstrates how to change Enigma's default sound set.
+-- This file demonstrates how to add a sound set to Enigma.
 --
 -- Sound effects are triggered by so-called "sound events".
--- These sound events usually have a name (like "dooropen") and an
--- associated location (the coordinates of the door) which
--- affect the way a sound effect is played.
+-- These sound events usually have a name (like "dooropen") and
+-- an associated location (the coordinates of the door) which
+-- affects the way a sound effect is played.
 --
 -- The sound event is converted into a real sound effect using
 -- tables similar to the one below.  Each entry in the table is
 -- either a string like "st-coinslot", which is interpreted as
--- referring to file "st-coinslot.wav" or a list of sound
--- attributes enclosed in curly braces "{ ... }".
+-- referring to file "st-coinslot.wav" and default properties or
+-- a list of sound attributes enclosed in curly braces "{ ... }".
 --
 -- Here is a complete example of such an attribute list:
 --
@@ -18,19 +18,33 @@
 --
 -- The meaning of these attributes is as follows:
 --
---      file     - The name of the sound file for this event, without
+--      file     - Path and name of the sound file for this event, without
 --                 the".wav" extension.
 --
 --      volume   - The sound volume: 1.0 is standard, 0.0 is silent.
 --
 --      priority - If many effects are active at the same time, high-priority
 --                 effects can replace lower-priority effects. Use an integer
---                 between 1 and 10.
+--                 between 1 and 10 (default 1).
 --
---      global   - Either 1 or 0.  If 1, no stereo effects are applied and
---                 there is no attenuation.  Used for menu sound, level end
---                 sounds, etc.
+--      global   - Either "true" or "false".  If true, no stereo effects are
+--                 applied and there is no attenuation.  Used for menu sound,
+--                 level end sounds, etc. Default is "false".
 --
+--      loop     - "true" or "false".  If true, the sound repeats infinitely
+--                 until canceled. Default is "false". 
+--
+--      damp_max, damp_inc, damp_mult, damp_min, damp_tick
+--               - Parameters for sound damping.  Sounds from noisy objects
+--                 like light passengers are damped to reduce the noise.
+--                 For this, the sound event's frequency is estimated.
+--                 damp_max calibrates the maximal damping factor (high means
+--                 quiet), damp_inc how fast the damping accumulates,
+--                 damp_mult is an overall factor, damp_min defines a lower
+--                 bound for the damping entries (beyond which they are
+--                 removed from memory) and damp_tick the factor that's
+--                 applied all 0.1 seconds. Defaults: 10.0, 1.0, 1.0, 0.5, 0.9.
+--
 -- To design a new sound set, proceed as follows.
 --
 -- 1) Create a new folder containing this file (named "sound.lua")
@@ -39,24 +53,30 @@
 -- 2) Move this new folder into Enigma's "sound" folder.  The directory
 --    structure should look something like this
 --
---      (enigma data folder)/sound/my_sounds/
---                                          /sound.lua
---                                          /a.wav
---                                          /b.wav
---                                          ...
---    [On Unix systems, you can use ~/.enigma/sound/ for testing purposes.]
+--      (user path)/sound/my_sounds/
+--                                 /sound.lua
+--                                 /a.wav
+--                                 /b.wav
+--                                 ...
 --
 -- 3) Run Enigma.  Since this file sets does not map any sound effect to a
 --    wav file, you should hear nothing
 --
--- 4) Edit the contents of this file to your liking.  If you need inspiration,
---    take a look at "startup.lua" shipped with Enigma, which contains the
---    default sound table.
+-- 4) Edit the contents of this file to your liking.  You can access the
+--    default sound files directly, but remember to add the subfolder for
+--    own sound files (like "{ file="my_sounds/b.wav" }").
 --
+-- 5) Replace "MY_SOUNDSET" by a suitable variable name, and "My Soundset"
+--    by the name you want to see in the sound options menu.  Remember to
+--    make it short enough to fit on the button.
+--
+-- If you need inspiration, take a look at "sound-defaults.lua" shipped with
+-- Enigma, which contains the default sound table.
+--
 -- If you have questions, don't hesitate to ask.  Have fun!
 --
 
-AddSoundTable ("Enigma", {
+soundtable_MY_SOUNDSET = {
     [""]           = "",        -- empty sound
     ballcollision  = "",
     blackbomb      = "",
@@ -148,4 +168,10 @@
     whitebomb      = "",
     wood           = "",
     yinyang        = "",
-})
+}
+
+-- Remove "--" from the line below to add missing sound entries
+-- from the default sound set.
+--copy_missing (soundtable_enigma, soundtable_MY_SOUNDSET)
+
+AddSoundSet ("My Soundset", soundtable_MY_SOUNDSET)

Modified: branches/1.0/src/actors.cc
===================================================================
--- branches/1.0/src/actors.cc	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/actors.cc	2007-04-20 12:02:41 UTC (rev 693)
@@ -224,8 +224,8 @@
     return Value();
 }
 
-bool Actor::sound_event (const char *name) {
-    return sound::SoundEvent (name, get_pos(), getVolume(name, this));
+bool Actor::sound_event (const char *name, double vol) {
+    return sound::EmitSoundEvent (name, get_pos(), getVolume(name, this, vol));
 }
 
 void Actor::set_attrib(const string& key, const Value &val)

Modified: branches/1.0/src/actors.hh
===================================================================
--- branches/1.0/src/actors.hh	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/actors.hh	2007-04-20 12:02:41 UTC (rev 693)
@@ -127,7 +127,7 @@
         void move ();
         virtual void move_screen ();
         void warp (const ecl::V2 &newpos);
-        bool sound_event (const char *name);
+        bool sound_event (const char *name, double vol = 1.0);
 
         void      respawn();
         void      set_respawnpos(const ecl::V2& p);

Modified: branches/1.0/src/client.cc
===================================================================
--- branches/1.0/src/client.cc	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/client.cc	2007-04-20 12:02:41 UTC (rev 693)
@@ -937,12 +937,12 @@
                             const ecl::V2 &pos,
                             double relative_volume)
 {
-    sound::SoundEvent (wavfile.c_str(), pos, relative_volume);
+    sound::EmitSoundEvent (wavfile.c_str(), pos, relative_volume);
 }
 
 void client::Msg_PlaySound (const std::string &wavfile, double relative_volume)
 {
-    sound::SoundEvent (wavfile.c_str(), V2(), relative_volume);
+    sound::EmitSoundEvent (wavfile.c_str(), V2(), relative_volume);
 }
 
 void client::Msg_Sparkle (const ecl::V2 &pos) {

Modified: branches/1.0/src/enigma-lua.pkg
===================================================================
--- branches/1.0/src/enigma-lua.pkg	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/enigma-lua.pkg	2007-04-20 12:02:41 UTC (rev 693)
@@ -111,3 +111,18 @@
     void HideMouse();
     void ShowMouse();
 }
+
+/* -------------------- sound.cc -------------------- */
+
+$#include "sound.hh"
+$using namespace sound;
+
+module sound
+{
+    // Note that EmitSound is defined in lua.cc, due to its object reference.
+    void DefineSoundEffect(string table, string name, string filename,
+                           double volume, bool loop, bool global, int priority,
+                           double damp_max, double damp_inc, double damp_mult,
+                           double damp_min, double damp_tick, string silence_string);
+    void SetActiveSoundSet(string table);
+}

Modified: branches/1.0/src/gui/LevelPackComposer.cc
===================================================================
--- branches/1.0/src/gui/LevelPackComposer.cc	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/gui/LevelPackComposer.cc	2007-04-20 12:02:41 UTC (rev 693)
@@ -283,9 +283,9 @@
                         var = curIndex->getVariation(curIndex->getCurrentPosition());
                     clipboard->appendProxy(curProxy, var.ctrl, 
                             var.unit, var.target, var.extensions);
-                    sound::SoundEvent ("menuok");
+                    sound::EmitSoundEvent ("menuok");
                 } else {
-                    sound::SoundEvent ("menustop");
+                    sound::EmitSoundEvent ("menustop");
                 }
             }
         } else if (w == but_back) {

Modified: branches/1.0/src/gui/LevelWidget.cc
===================================================================
--- branches/1.0/src/gui/LevelWidget.cc	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/gui/LevelWidget.cc	2007-04-20 12:02:41 UTC (rev 693)
@@ -75,9 +75,9 @@
             iselected = curIndex->getCurrentPosition();
             ifirst = curIndex->getScreenFirstPosition();
             invalidate();
-            sound::SoundEvent ("menumove");
+            sound::EmitSoundEvent ("menumove");
         } else if (iselected != curIndex->getCurrentPosition()) {
-            sound::SoundEvent ("menumove");            
+            sound::EmitSoundEvent ("menumove");            
         }
         // repair ifirst on boot and screen resolution changes
         set_selected(curIndex->getScreenFirstPosition(), 
@@ -191,9 +191,9 @@
             iselected = newsel;
     
             if (!m_areas.empty()) {
-                sound::SoundEvent ("menumove");
+                sound::EmitSoundEvent ("menumove");
                 if (oldsel != newsel) 
-                    sound::SoundEvent ("menuswitch");
+                    sound::EmitSoundEvent ("menuswitch");
                 invalidate();
             }
         }
@@ -201,7 +201,7 @@
             iselected = newsel;
     
             if (!m_areas.empty()) {
-                sound::SoundEvent ("menuswitch");
+                sound::EmitSoundEvent ("menuswitch");
                 invalidate_area(m_areas[oldsel-ifirst]); // old selection
                 invalidate_area(m_areas[iselected-ifirst]); // new selection
             }
@@ -414,7 +414,7 @@
             for (unsigned i=0; i<m_areas.size(); ++i)
                 if (m_areas[i].contains(e->button.x, e->button.y))
                 {
-                    sound::SoundEvent ("menuok");
+                    sound::EmitSoundEvent ("menuok");
                     iselected = ifirst+i;
                     syncToIndexMgr();
                     if (SDL_GetModState() & KMOD_CTRL && !(SDL_GetModState() & KMOD_SHIFT)) {
@@ -433,7 +433,7 @@
             for (unsigned i=0; i<m_areas.size(); ++i)
                 if (m_areas[i].contains(e->button.x, e->button.y))
                 {
-                    sound::SoundEvent ("menuok");
+                    sound::EmitSoundEvent ("menuok");
                     iselected = ifirst+i;
                     syncToIndexMgr();
                     LevelInspector m(curIndex->getProxy(iselected));

Modified: branches/1.0/src/gui/Menu.cc
===================================================================
--- branches/1.0/src/gui/Menu.cc	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/gui/Menu.cc	2007-04-20 12:02:41 UTC (rev 693)
@@ -75,7 +75,7 @@
             tick (0.01);
             refresh();
         }
-        sound::SoundEvent ("menuexit");
+        sound::EmitSoundEvent ("menuexit");
         // protection against ESC D.o.S. attacks
         Uint32 menuTickDuration = SDL_GetTicks() - enterTickTime;
         Uint32 minMenuTickDuration = 300;
@@ -106,7 +106,7 @@
             switch_active_widget(next_widget);
         }
         else { // no more widgets into that direction found
-            sound::SoundEvent ("menustop");
+            sound::EmitSoundEvent ("menustop");
         }
     }
     

Modified: branches/1.0/src/gui/OptionsMenu.cc
===================================================================
--- branches/1.0/src/gui/OptionsMenu.cc	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/gui/OptionsMenu.cc	2007-04-20 12:02:41 UTC (rev 693)
@@ -157,51 +157,23 @@
     /* -------------------- SoundSetButton -------------------- */
     
     SoundSetButton::SoundSetButton() : ValueButton(0, 1) {
-        using namespace OxydLib;
-        
-        availableSoundSets.push_back(0);
-        availableSoundSetsTitles.push_back(N_("Default"));
-        availableSoundSets.push_back(1);
-        availableSoundSetsTitles.push_back("Enigma");
-        int numAvail = 2;
-        for (int i = OxydVersion_First; i<= OxydVersion_Last; i++) {
-            if (oxyd::FoundOxyd(OxydVersion(i))) {
-                availableSoundSets.push_back(i+2);
-                std::string title;
-                switch (i) {
-                case OxydVersion_Oxyd1:          title = "Oxyd"; break;
-                case OxydVersion_OxydMagnum:     title = "Magnum"; break;
-                case OxydVersion_OxydMagnumGold: title = "Mag.Gold"; break;
-                case OxydVersion_OxydExtra:      title = "Extra"; break;
-                case OxydVersion_PerOxyd:        title = "Per.Oxyd"; break;
-                default:      title = "unknown"; break;
-                }
-                availableSoundSetsTitles.push_back(title);
-                numAvail++;
-            }
-        }
+        int numAvail = sound::GetOptionSoundSetCount();
         setMaxValue(numAvail - 1);
         init();
     }
-    
+
     int SoundSetButton::get_value() const {
-        int soundSet = options::GetInt("SoundSet");
-        for (int i = 0; i < availableSoundSets.size(); i++) {
-            if (availableSoundSets[i] == soundSet)
-                return i;
-        }
-        return 0;  // default soundset
+        return sound::GetOptionSoundSet();
     }
-    
+
     void SoundSetButton::set_value(int value) {
-        options::SetOption("SoundSet", availableSoundSets[value]);
-        oxyd::ChangeSoundset(availableSoundSets[value], false);        
+        sound::SetOptionSoundSet(value);
     }
-    
+
     string SoundSetButton::get_text(int value) const {
-        return _(availableSoundSetsTitles[value].c_str());
+        return _(sound::GetOptionSoundSetText(value).c_str());
     }
-    
+
     
     /* -------------------- StereoButton -------------------- */
     

Modified: branches/1.0/src/gui/OptionsMenu.hh
===================================================================
--- branches/1.0/src/gui/OptionsMenu.hh	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/gui/OptionsMenu.hh	2007-04-20 12:02:41 UTC (rev 693)
@@ -73,10 +73,6 @@
         int get_value() const;
         void set_value(int value);
         std::string get_text(int value) const;
-        
-    private:
-        std::vector<int> availableSoundSets;
-        std::vector<std::string> availableSoundSetsTitles;
     };
 
     class LanguageButton : public ValueButton {

Modified: branches/1.0/src/gui/TextField.cc
===================================================================
--- branches/1.0/src/gui/TextField.cc	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/gui/TextField.cc	2007-04-20 12:02:41 UTC (rev 693)
@@ -237,13 +237,13 @@
                         }
                         else {
                             // chars like ctrl-a - ctrl-z
-                            sound::SoundEvent ("menustop");
+                            sound::EmitSoundEvent ("menustop");
                             break;
                         }
                         if ((maxChars >= 0 && (charSizesPreCursor.size() + charSizesPostCursor.size()) >= maxChars) ||
                                 realChar < 0x100 && invalidChars.find((char)realChar) != std::string::npos) {
                             // string too long or invalid char
-                            sound::SoundEvent ("menustop");
+                            sound::EmitSoundEvent ("menustop");
                             break;
                         }
                         unsigned char utf8Char[4];
@@ -264,7 +264,7 @@
                     if (e.key.keysym.sym < 300 || e.key.keysym.sym > 314 ){
                         // chars like PageUp, F1 but not key state modifier
                         // like shift, alt,...
-                        sound::SoundEvent ("menustop");
+                        sound::EmitSoundEvent ("menustop");
                     }
                     break;
             }

Modified: branches/1.0/src/gui/widgets.cc
===================================================================
--- branches/1.0/src/gui/widgets.cc	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/gui/widgets.cc	2007-04-20 12:02:41 UTC (rev 693)
@@ -602,7 +602,7 @@
 
 void Button::activate() 
 {
-    sound::SoundEvent ("menuswitch");
+    sound::EmitSoundEvent ("menuswitch");
     m_activep = true;
     invalidate();
 }
@@ -729,7 +729,7 @@
         invalidate();
         if (!m_pressedp) {
             if (soundOk())
-                sound::SoundEvent("menuok");
+                sound::EmitSoundEvent("menuok");
             invoke_listener();
         }
     }
@@ -894,12 +894,12 @@
         stop = true;
     }
     if (inc_value(incr)) {
-        sound::SoundEvent("menuswitch");
+        sound::EmitSoundEvent("menuswitch");
     } else {
         if (stop) {
-            sound::SoundEvent("menustop");
+            sound::EmitSoundEvent("menustop");
         } else {
-            sound::SoundEvent("menuswitch");
+            sound::EmitSoundEvent("menuswitch");
             if (incr == 1)
                 update_value(get_value(), min_value);
             else
@@ -908,9 +908,10 @@
     }
 }
 
-bool ValueButton::soundOk() {
+bool ValueButton::soundOk() {
     return false;
 }
+
 
 /* -------------------- ImageButton -------------------- */
 

Modified: branches/1.0/src/items.cc
===================================================================
--- branches/1.0/src/items.cc	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/items.cc	2007-04-20 12:02:41 UTC (rev 693)
@@ -2161,7 +2161,7 @@
             // Switch to other marble
             player::SwapPlayers();
             // play_sound("switch");   // don't! wrong coordinates!
-            sound::SoundEvent ("switchplayer", p.center());
+            sound::EmitSoundEvent ("switchplayer", p.center());
             return ITEM_KEEP;
         }
     };
@@ -2178,7 +2178,7 @@
 
         ItemAction activate(Actor *, GridPos p) {
             if (Item *it=GetItem(p)) {
-                sound::SoundEvent ("spade", p.center());
+                sound::EmitSoundEvent ("spade", p.center());
                 SendMessage(it, "shovel");
                 return ITEM_KEEP;
             }

Modified: branches/1.0/src/laser.cc
===================================================================
--- branches/1.0/src/laser.cc	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/laser.cc	2007-04-20 12:02:41 UTC (rev 693)
@@ -369,8 +369,8 @@
     }
 
     if (count) {
-        sound::SoundEvent ("laseron", ecl::V2(x/count+.5, y/count+.5),
-                           getVolume("laseron", NULL));
+        sound::EmitSoundEvent ("laseron", ecl::V2(x/count+.5, y/count+.5),
+                               getVolume("laseron", NULL));
     }
 
     old_laser_positions.clear();

Modified: branches/1.0/src/lev/Index.cc
===================================================================
--- branches/1.0/src/lev/Index.cc	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/lev/Index.cc	2007-04-20 12:02:41 UTC (rev 693)
@@ -21,7 +21,7 @@
 #include "errors.hh"
 #include "main.hh"
 #include "options.hh"
-#include "oxyd.hh"
+#include "sound.hh"
 #include "PreferenceManager.hh"
 #include "StateManager.hh"
 #include "lev/ScoreManager.hh"
@@ -323,7 +323,7 @@
         Index * newIndex = findIndex(anIndexName);
         if (newIndex != NULL) {
             if (newIndex != currentIndex) {
-                oxyd::ChangeSoundset(newIndex->get_default_SoundSet(), true);
+                sound::SetDefaultSoundSet(newIndex->get_default_SoundSet());
                 currentIndex = newIndex;
                 std::string group = currentIndex->getGroupName();
                 if (group != INDEX_EVERY_GROUP && 
@@ -703,8 +703,8 @@
     
 
     /*! Return the default SoundSet (see options::SoundSet for meaning) */
-    int Index::get_default_SoundSet() const { 
-        return 1;
+    const char* Index::get_default_SoundSet() const { 
+        return "Enigma";
     }
 
     /*! Returns true if it's a twoplayer levelpack, but has no

Modified: branches/1.0/src/lev/Index.hh
===================================================================
--- branches/1.0/src/lev/Index.hh	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/lev/Index.hh	2007-04-20 12:02:41 UTC (rev 693)
@@ -129,8 +129,8 @@
         void updateFromProxies();
 
         // ---------- LevelPack legacy methods ---to be renamed ------- */
-       /*! Return the default SoundSet (see options::SoundSet for meaning) */
-        virtual int get_default_SoundSet() const;
+        /*! Return the default SoundSet (see options::SoundSet for meaning) */
+        virtual const char* get_default_SoundSet() const;
 
         /*! Returns true if it's a twoplayer levelpack, but has no
           it-yinyang (needed to add it-yinyang to inventory if

Modified: branches/1.0/src/lua-display.cc
===================================================================
--- branches/1.0/src/lua-display.cc	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/lua-display.cc	2007-04-20 12:02:41 UTC (rev 693)
@@ -1,6 +1,6 @@
 /*
 ** Lua binding: display
-** Generated automatically by tolua++-1.0.92 on Wed Sep 27 01:52:17 2006.
+** Generated automatically by tolua++-1.0.92 on Fri Apr 20 13:59:44 2007.
 */
 
 #ifndef __cplusplus

Modified: branches/1.0/src/lua-display.hh
===================================================================
--- branches/1.0/src/lua-display.hh	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/lua-display.hh	2007-04-20 12:02:41 UTC (rev 693)
@@ -1,6 +1,6 @@
 /*
 ** Lua binding: display
-** Generated automatically by tolua++-1.0.92 on Wed Sep 27 01:52:17 2006.
+** Generated automatically by tolua++-1.0.92 on Fri Apr 20 13:59:44 2007.
 */
 
 /* Exported function */

Modified: branches/1.0/src/lua-ecl.cc
===================================================================
--- branches/1.0/src/lua-ecl.cc	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/lua-ecl.cc	2007-04-20 12:02:41 UTC (rev 693)
@@ -1,6 +1,6 @@
 /*
 ** Lua binding: px
-** Generated automatically by tolua++-1.0.92 on Wed Sep 27 01:52:17 2006.
+** Generated automatically by tolua++-1.0.92 on Fri Apr 20 13:59:44 2007.
 */
 
 #ifndef __cplusplus

Modified: branches/1.0/src/lua-ecl.hh
===================================================================
--- branches/1.0/src/lua-ecl.hh	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/lua-ecl.hh	2007-04-20 12:02:41 UTC (rev 693)
@@ -1,6 +1,6 @@
 /*
 ** Lua binding: px
-** Generated automatically by tolua++-1.0.92 on Wed Sep 27 01:52:17 2006.
+** Generated automatically by tolua++-1.0.92 on Fri Apr 20 13:59:44 2007.
 */
 
 /* Exported function */

Modified: branches/1.0/src/lua-editor.cc
===================================================================
--- branches/1.0/src/lua-editor.cc	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/lua-editor.cc	2007-04-20 12:02:41 UTC (rev 693)
@@ -1,6 +1,6 @@
 /*
 ** Lua binding: editor
-** Generated automatically by tolua++-1.0.92 on Wed Sep 27 01:52:17 2006.
+** Generated automatically by tolua++-1.0.92 on Fri Apr 20 13:59:44 2007.
 */
 
 #ifndef __cplusplus

Modified: branches/1.0/src/lua-editor.hh
===================================================================
--- branches/1.0/src/lua-editor.hh	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/lua-editor.hh	2007-04-20 12:02:41 UTC (rev 693)
@@ -1,6 +1,6 @@
 /*
 ** Lua binding: editor
-** Generated automatically by tolua++-1.0.92 on Wed Sep 27 01:52:17 2006.
+** Generated automatically by tolua++-1.0.92 on Fri Apr 20 13:59:44 2007.
 */
 
 /* Exported function */

Modified: branches/1.0/src/lua-enigma.cc
===================================================================
--- branches/1.0/src/lua-enigma.cc	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/lua-enigma.cc	2007-04-20 12:02:41 UTC (rev 693)
@@ -1,6 +1,6 @@
 /*
 ** Lua binding: enigma
-** Generated automatically by tolua++-1.0.92 on Wed Sep 27 01:52:17 2006.
+** Generated automatically by tolua++-1.0.92 on Fri Apr 20 13:59:44 2007.
 */
 
 #ifndef __cplusplus
@@ -25,6 +25,8 @@
 #include "video.hh"
 using namespace video;
 using ecl::Screen;
+#include "sound.hh"
+using namespace sound;
 
 /* function to register type */
 static void tolua_reg_types (lua_State* tolua_S)
@@ -1133,6 +1135,86 @@
 }
 #endif //#ifndef TOLUA_DISABLE
 
+/* function: DefineSoundEffect */
+#ifndef TOLUA_DISABLE_tolua_enigma_sound_DefineSoundEffect00
+static int tolua_enigma_sound_DefineSoundEffect00(lua_State* tolua_S)
+{
+#ifndef TOLUA_RELEASE
+ tolua_Error tolua_err;
+ if (
+     !tolua_iscppstring(tolua_S,1,0,&tolua_err) ||
+     !tolua_iscppstring(tolua_S,2,0,&tolua_err) ||
+     !tolua_iscppstring(tolua_S,3,0,&tolua_err) ||
+     !tolua_isnumber(tolua_S,4,0,&tolua_err) ||
+     !tolua_isboolean(tolua_S,5,0,&tolua_err) ||
+     !tolua_isboolean(tolua_S,6,0,&tolua_err) ||
+     !tolua_isnumber(tolua_S,7,0,&tolua_err) ||
+     !tolua_isnumber(tolua_S,8,0,&tolua_err) ||
+     !tolua_isnumber(tolua_S,9,0,&tolua_err) ||
+     !tolua_isnumber(tolua_S,10,0,&tolua_err) ||
+     !tolua_isnumber(tolua_S,11,0,&tolua_err) ||
+     !tolua_isnumber(tolua_S,12,0,&tolua_err) ||
+     !tolua_iscppstring(tolua_S,13,0,&tolua_err) ||
+     !tolua_isnoobj(tolua_S,14,&tolua_err)
+ )
+  goto tolua_lerror;
+ else
+#endif
+ {
+  string table = ((string)  tolua_tocppstring(tolua_S,1,0));
+  string name = ((string)  tolua_tocppstring(tolua_S,2,0));
+  string filename = ((string)  tolua_tocppstring(tolua_S,3,0));
+  double volume = ((double)  tolua_tonumber(tolua_S,4,0));
+  bool loop = ((bool)  tolua_toboolean(tolua_S,5,0));
+  bool global = ((bool)  tolua_toboolean(tolua_S,6,0));
+  int priority = ((int)  tolua_tonumber(tolua_S,7,0));
+  double damp_max = ((double)  tolua_tonumber(tolua_S,8,0));
+  double damp_inc = ((double)  tolua_tonumber(tolua_S,9,0));
+  double damp_mult = ((double)  tolua_tonumber(tolua_S,10,0));
+  double damp_min = ((double)  tolua_tonumber(tolua_S,11,0));
+  double damp_tick = ((double)  tolua_tonumber(tolua_S,12,0));
+  string silence_string = ((string)  tolua_tocppstring(tolua_S,13,0));
+  {
+   DefineSoundEffect(table,name,filename,volume,loop,global,priority,damp_max,damp_inc,damp_mult,damp_min,damp_tick,silence_string);
+  }
+ }
+ return 0;
+#ifndef TOLUA_RELEASE
+ tolua_lerror:
+ tolua_error(tolua_S,"#ferror in function 'DefineSoundEffect'.",&tolua_err);
+ return 0;
+#endif
+}
+#endif //#ifndef TOLUA_DISABLE
+
+/* function: SetActiveSoundSet */
+#ifndef TOLUA_DISABLE_tolua_enigma_sound_SetActiveSoundSet00
+static int tolua_enigma_sound_SetActiveSoundSet00(lua_State* tolua_S)
+{
+#ifndef TOLUA_RELEASE
+ tolua_Error tolua_err;
+ if (
+     !tolua_iscppstring(tolua_S,1,0,&tolua_err) ||
+     !tolua_isnoobj(tolua_S,2,&tolua_err)
+ )
+  goto tolua_lerror;
+ else
+#endif
+ {
+  string table = ((string)  tolua_tocppstring(tolua_S,1,0));
+  {
+   SetActiveSoundSet(table);
+  }
+ }
+ return 0;
+#ifndef TOLUA_RELEASE
+ tolua_lerror:
+ tolua_error(tolua_S,"#ferror in function 'SetActiveSoundSet'.",&tolua_err);
+ return 0;
+#endif
+}
+#endif //#ifndef TOLUA_DISABLE
+
 /* Open function */
 TOLUA_API int tolua_enigma_open (lua_State* tolua_S)
 {
@@ -1210,6 +1292,11 @@
    tolua_function(tolua_S,"HideMouse",tolua_enigma_video_HideMouse00);
    tolua_function(tolua_S,"ShowMouse",tolua_enigma_video_ShowMouse00);
   tolua_endmodule(tolua_S);
+  tolua_module(tolua_S,"sound",0);
+  tolua_beginmodule(tolua_S,"sound");
+   tolua_function(tolua_S,"DefineSoundEffect",tolua_enigma_sound_DefineSoundEffect00);
+   tolua_function(tolua_S,"SetActiveSoundSet",tolua_enigma_sound_SetActiveSoundSet00);
+  tolua_endmodule(tolua_S);
  tolua_endmodule(tolua_S);
  return 1;
 }

Modified: branches/1.0/src/lua-enigma.hh
===================================================================
--- branches/1.0/src/lua-enigma.hh	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/lua-enigma.hh	2007-04-20 12:02:41 UTC (rev 693)
@@ -1,6 +1,6 @@
 /*
 ** Lua binding: enigma
-** Generated automatically by tolua++-1.0.92 on Wed Sep 27 01:52:17 2006.
+** Generated automatically by tolua++-1.0.92 on Fri Apr 20 13:59:44 2007.
 */
 
 /* Exported function */

Modified: branches/1.0/src/lua-global.cc
===================================================================
--- branches/1.0/src/lua-global.cc	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/lua-global.cc	2007-04-20 12:02:41 UTC (rev 693)
@@ -1,6 +1,6 @@
 /*
 ** Lua binding: global
-** Generated automatically by tolua++-1.0.92 on Wed Sep 27 01:52:17 2006.
+** Generated automatically by tolua++-1.0.92 on Fri Apr 20 13:59:44 2007.
 */
 
 #ifndef __cplusplus

Modified: branches/1.0/src/lua-global.hh
===================================================================
--- branches/1.0/src/lua-global.hh	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/lua-global.hh	2007-04-20 12:02:41 UTC (rev 693)
@@ -1,6 +1,6 @@
 /*
 ** Lua binding: global
-** Generated automatically by tolua++-1.0.92 on Wed Sep 27 01:52:17 2006.
+** Generated automatically by tolua++-1.0.92 on Fri Apr 20 13:59:44 2007.
 */
 
 /* Exported function */

Modified: branches/1.0/src/lua.cc
===================================================================
--- branches/1.0/src/lua.cc	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/lua.cc	2007-04-20 12:02:41 UTC (rev 693)
@@ -62,9 +62,8 @@
 
 namespace lua
 {
-    int PlaySoundGlobal (lua_State *L);
-    int PlaySound (lua_State *L);
     int EmitSound (lua_State *L);
+    int EmitSoundGlobal (lua_State *L);
     int MakeObject (lua_State *L);
 }
 
@@ -137,12 +136,6 @@
     lua_pop (L, 1);
 }
 
-void lua::SetSoundTable (const char *name)
-{
-    CallFunc (global_state, "ActivateSoundTable", name, NULL);
-}
-
-
 static void
 push_value(lua_State *L, const Value &val)
 {
@@ -391,42 +384,27 @@
     return 0;
 }
 
-int lua::PlaySound (lua_State *L)
-{
-    const char *soundname = lua_tostring (L, 1);
-    double      x         = lua_tonumber (L, 2);
-    double      y         = lua_tonumber (L, 3);
-    double      volume    = lua_tonumber (L, 4);
-
-    sound::PlaySound (soundname, ecl::V2 (x, y), volume);
-
-    return 0;
-}
-
-int lua::PlaySoundGlobal (lua_State *L)
-{
-    const char *soundname = lua_tostring (L, 1);
-    double      volume    = lua_tonumber (L, 2);
-    int         priority  = static_cast<int> (lua_tonumber (L, 3));
-
-    sound::PlaySoundGlobal (soundname, volume, priority);
-
-    return 0;
-}
-
-
 int lua::EmitSound (lua_State *L)
 {
     Object     *obj       = to_object(L, 1);
     const char *soundname = lua_tostring(L, 2);
+    double vol = 1.0;
 
+    if (lua_isnumber(L, 3)) 
+        vol  = lua_tonumber(L, 3);
     if (!soundname)
         throwLuaError(L,"Illegal sound");
     else if (obj) {
         GridObject *gobj = dynamic_cast<GridObject*>(obj);
         if (gobj) {
-            if (!gobj->sound_event (soundname)) 
-                throwLuaError(L, strf("Can't find sound '%s'", soundname).c_str());
+            if (!gobj->sound_event (soundname, vol)) {
+                //throwLuaError(L, strf("Can't find sound '%s'", soundname).c_str());
+                // Don't throw an error when no sound file was found.
+                // Remember that user sound sets might be incomplete, and
+                // absolutely correct levels could throw an error here.
+                // Instead, write the "silence string" to the command line:
+                sound::WriteSilenceString(soundname);
+            }
         }
     }
     else
@@ -435,11 +413,26 @@
     return 0;
 }
 
+int lua::EmitSoundGlobal (lua_State *L)
+{
+    const char *soundname = lua_tostring(L, 1);
+    double vol = 1.0;
+
+    if (lua_isnumber(L, 3)) 
+        vol  = lua_tonumber(L, 3);
+    if (!soundname)
+        throwLuaError(L,"Illegal sound");
+    else
+        sound::EmitSoundEventGlobal(soundname, vol);
+
+    return 0;
+}
+
 static int
 en_name_object(lua_State *L)
 {
     Object     *obj  = to_object(L, 1);
-    const char *name = lua_tostring(L,2);
+    const char *name = lua_tostring(L, 2);
 
     if (!obj) 
         throwLuaError(L, "NameObject: Illegal object");
@@ -632,8 +625,8 @@
 
 static CFunction globalfuncs[] = {
     {FindDataFile,          "FindDataFile"},
-    {lua::PlaySoundGlobal,  "PlaySoundGlobal"},
-    {lua::PlaySound,        "PlaySound"},
+//    {lua::PlaySoundGlobal,  "PlaySoundGlobal"},
+//    {lua::PlaySound,        "PlaySound"},
     {en_get_ticks,             "GetTicks"},
     {0,0}
 };
@@ -672,7 +665,6 @@
     // sound effects
 
     {lua::EmitSound,        "EmitSound"},
-    {lua::PlaySound,        "PlaySound"},
 
     // manipulating level
 

Modified: branches/1.0/src/lua.hh
===================================================================
--- branches/1.0/src/lua.hh	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/lua.hh	2007-04-20 12:02:41 UTC (rev 693)
@@ -72,8 +72,6 @@
 
     int FindDataFile (lua_State *L);
 
-    void SetSoundTable (const char *name);
-
 /* -------------------- Helper routines -------------------- */
 
     /*! Register the C functions in `funcs'.  The end of the array is

Modified: branches/1.0/src/main.cc
===================================================================
--- branches/1.0/src/main.cc	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/main.cc	2007-04-20 12:02:41 UTC (rev 693)
@@ -319,12 +319,13 @@
     errorInit = true;
 
     // ----- Initialize sound subsystem
-    lua::DoSubfolderfile (L, "sound", "sound.lua");
     if (ap.nosound)
         sound::DisableSound();
     else if (ap.nomusic)
         sound::DisableMusic();
     sound::Init();
+    lua::CheckedDoFile (L, app.systemFS, "sound-defaults.lua");
+    lua::DoSubfolderfile (L, "sound", "sound.lua");
 
     // ----- Initialize network layer
     if (enet_initialize () != 0) {
@@ -357,10 +358,11 @@
                     INDEX_DEFAULT_GROUP, emptyList, INDEX_SEARCH_PACK_LOCATION));
     }
 
-    oxyd::ChangeSoundset(options::GetInt("SoundSet"), false);
-
     lev::Proxy::countLevels();
 
+    // ----- Initialize sound tables -- needs sound, oxyd, video (error messages!)
+    sound::InitSoundSets();
+
     // initialize random
     enigma::Randomize();
     

Modified: branches/1.0/src/objects.cc
===================================================================
--- branches/1.0/src/objects.cc	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/objects.cc	2007-04-20 12:02:41 UTC (rev 693)
@@ -213,9 +213,9 @@
     return m;
 }
 
-bool GridObject::sound_event (const char *name)
+bool GridObject::sound_event (const char *name, double vol)
 {
-    return sound::SoundEvent (name, get_pos().center(), getVolume(name, this));
+    return sound::EmitSoundEvent (name, get_pos().center(), getVolume(name, this, vol));
 }
 
 void GridObject::warning(const char *format, ...) const 

Modified: branches/1.0/src/objects_decl.hh
===================================================================
--- branches/1.0/src/objects_decl.hh	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/objects_decl.hh	2007-04-20 12:02:41 UTC (rev 693)
@@ -120,7 +120,7 @@
         void warning(const char *format, ...) const;
 
         // Helper functions
-        bool sound_event (const char *name);
+        bool sound_event (const char *name, double vol = 1.0);
         display::Model *set_anim (const std::string &mname);
 
     protected:

Modified: branches/1.0/src/oxyd.cc
===================================================================
--- branches/1.0/src/oxyd.cc	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/oxyd.cc	2007-04-20 12:02:41 UTC (rev 693)
@@ -760,10 +760,9 @@
     Log << "Levelpack '" << get_name() << "' has " << nlevels << " levels." << endl;
 }
 
-
-int LevelPack_Oxyd::get_default_SoundSet() const 
+const char* LevelPack_Oxyd::get_default_SoundSet() const 
 { 
-    return m_datfile->getVersion() + 2; 
+    return sound::GetOxydSoundSet(m_datfile->getVersion()).c_str();
 }
 
 bool LevelPack_Oxyd::needs_twoplayers() const 
@@ -1017,11 +1016,6 @@
 namespace
 {
     vector<GameInfo*> games;
-
-    int active_soundset              = 1; // 1: enigma  2..: OxydVersion+2;
-
-    typedef std::map <std::string, std::string> SoundMap;
-    SoundMap soundfx_map;
 }
 
 
@@ -1054,61 +1048,13 @@
     return games[ver]->is_present();
 }
 
-
-void oxyd::ChangeSoundset(int new_sound_set, bool isDefault) 
+bool oxyd::InitOxydSoundSet(OxydVersion ver)
 {
-    static int last_default_sound_set = 1; // default is Enigma
-    static int last_user_sound_set = 0;    // user selection of default 
-    int sound_set = last_user_sound_set;
-    
-    if (isDefault) {
-        // new levelpack sets a default soundset
-        ASSERT(new_sound_set > 0, XFrontend, "Default Soundset 0");
-        
-        // remember current default
-        last_default_sound_set = new_sound_set;
-        
-        // select it if default is users selection
-        if (last_user_sound_set == 0)
-            sound_set = new_sound_set;
-    } else {
-        // user selects a soundset 
-        last_user_sound_set = new_sound_set;
-        if (new_sound_set == 0) 
-            sound_set = last_default_sound_set;
-        else
-            sound_set = new_sound_set;
-    }
-
-    if (sound_set == active_soundset) {
-        return;
-    }
-
-    // reset to enigma soundset
-    soundfx_map.clear();
-    active_soundset = 1;
-
-    sound::ClearCache();
-
-    if (sound_set == 1) {       // enigma -> no mapping
-        lua::SetSoundTable ("Enigma");
-        return;
-    }
-
-    OxydVersion ver = OxydVersion(sound_set-2);
     GameInfo&   gi  = *(games[ver]);
 
     if (!gi.is_present())
-        return;                 // not installed -> use enigma soundset
+        return false;                 // not installed -> use enigma soundset
 
-    if (ver == OxydVersion_OxydMagnum || ver == OxydVersion_OxydMagnumGold) {
-        lua::SetSoundTable ("Oxydm");
-    }
-    else {
-        lua::SetSoundTable ("Oxyd");
-    }
-    active_soundset = sound_set;
-
     static const char *oxydsounds[] = {
         "OXBLOOP.SDD", "OXBOING.SDD", "OXBOLD.SDD", "OXCRACK.SDD",
         "OXCRASH1.SDD", "OXCRASH2.SDD", "OXCUT.SDD", "OXDROP.SDD",
@@ -1129,7 +1075,7 @@
         const OxydLib::ByteVec *snddata = datfile->getChunk(chunkname);
 
         if (snddata) {
-            enigma::Log << "Loaded sound file " << chunkname<< "\n";
+            //enigma::Log << "Loaded sound file " << chunkname<< "\n";
 
             sound::SoundData snd;
             snd.buf.assign (snddata->begin(), snddata->end() - 4);
@@ -1141,4 +1087,6 @@
             sound::DefineSound (oxydsounds[i], snd);
         }
     }
+
+    return true;
 }

Modified: branches/1.0/src/oxyd.hh
===================================================================
--- branches/1.0/src/oxyd.hh	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/oxyd.hh	2007-04-20 12:02:41 UTC (rev 693)
@@ -28,13 +28,8 @@
 
     bool FoundOxyd (OxydLib::OxydVersion ver);
 
-    /**
-     * Select soundset or set default soundset.
-     * @arg new_sound_set  Enigma = 1, OxydVersion number +2, or 0 for "use default"
-     * @arg isDefault      true if a levelpack declares it default soundset,
-     *                     false if the user selected soundset is given 
-     */
-    void ChangeSoundset(int new_sound_set, bool isDefault);
+    // Initialise an oxyd sound set
+    bool InitOxydSoundSet(OxydLib::OxydVersion ver);
 }
 
 #endif

Modified: branches/1.0/src/oxyd_internal.hh
===================================================================
--- branches/1.0/src/oxyd_internal.hh	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/oxyd_internal.hh	2007-04-20 12:02:41 UTC (rev 693)
@@ -155,7 +155,7 @@
         /* ---------- LevelPack interface ---------- */
         string get_name() const;
         int size() const { return nlevels; }
-        int get_default_SoundSet() const;
+        const char* get_default_SoundSet() const;
         bool needs_twoplayers() const;
     protected:
         virtual bool has_easymode(size_t /*index*/) const;

Modified: branches/1.0/src/player.cc
===================================================================
--- branches/1.0/src/player.cc	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/player.cc	2007-04-20 12:02:41 UTC (rev 693)
@@ -558,7 +558,7 @@
             item->on_pickup(a);
             inv->add_item(item);
             RedrawInventory (inv);
-            sound::SoundEvent ("pickup", p.center());
+            sound::EmitSoundEvent ("pickup", p.center());
         }
     }
 }
@@ -578,7 +578,7 @@
                 world::DisposeObject (stone);
                 inv->add_item(item);
                 player::RedrawInventory(inv);
-                sound::SoundEvent ("pickup", p.center());
+                sound::EmitSoundEvent ("pickup", p.center());
             }
         }
     }
@@ -621,7 +621,7 @@
 
 void player::RotateInventory(int dir) 
 {
-    sound::SoundEvent ("invrotate", ecl::V2());
+    sound::EmitSoundEvent ("invrotate", ecl::V2());
     Inventory &inv = players[icurrent_player].inventory;
     if (dir == 1)
         inv.rotate_left ();

Modified: branches/1.0/src/sound.cc
===================================================================
--- branches/1.0/src/sound.cc	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/sound.cc	2007-04-20 12:02:41 UTC (rev 693)
@@ -1,5 +1,6 @@
 /*
  * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2007 Andreas Lochmann
  *
  * This program is free software; you can redistribute it and/or
  * modify it under the terms of the GNU General Public License
@@ -16,11 +17,15 @@
  * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
  *
  */
+#include "errors.hh"
 #include "enigma.hh"
 #include "options.hh"
 #include "sound.hh"
 #include "main.hh"
-#include "lua.hh"
+#include "oxyd.hh"
+#include "oxydlib/OxydVersion.h"
+#include "nls.hh"
+#include "client.hh"
 
 #include "SDL.h"
 #include "SDL_mixer.h"
@@ -30,18 +35,10 @@
 #include <cassert>
 #include <memory>
 
-#ifndef CXXLUA
-extern "C" {
-#include "lua.h"
-}
-#else
-#include "lua.h"
-#endif 
-
-
 using namespace std;
 using namespace enigma;
 using namespace sound;
+using namespace OxydLib;
 
 #include "sound_internal.hh"
 
@@ -52,8 +49,8 @@
                          int freq, int format, int channels);
 
 
-/* -------------------- SoundEffect implementation -------------------- */
-SoundEffect::SoundEffect ()
+/* -------------------- SoundEvent implementation -------------------- */
+SoundEvent::SoundEvent ()
 : name(""), has_position(false), position(),
   priority (0), volume (0.0),
   left (0), right(0), active (false),
@@ -61,12 +58,12 @@
 {
 }
 
-bool not_active (const SoundEffect &s)
+bool not_active (const SoundEvent &s)
 {
     return !s.active;
 }
 
-bool lower_priority (const SoundEffect &s, const SoundEffect &t)
+bool lower_priority (const SoundEvent &s, const SoundEvent &t)
 {
     return s.priority < t.priority;
 }
@@ -153,7 +150,6 @@
 void SoundEngine_SDL::clear_cache() 
 {
     for (ecl::Dict<Mix_Chunk*>::iterator it = wav_cache.begin(); it != wav_cache.end(); ++it)
-
         Mix_FreeChunk(it->second);
     wav_cache.clear();
 }
@@ -218,7 +214,7 @@
     // How far can sound travel?
     const double range = 30;    
 
-    SoundEffect &se = m_channelinfo[channel];
+    SoundEvent &se = m_channelinfo[channel];
 
     double volume;
     int    left;
@@ -249,7 +245,7 @@
 int SoundEngine_SDL::already_playing (const SoundName &name)
 {
     for (size_t i=0; i<m_channelinfo.size(); ++i) {
-        const SoundEffect &se = m_channelinfo[i];
+        const SoundEvent &se = m_channelinfo[i];
 
         if (se.active && se.name == name && se.playing_time < 0.05)
             return static_cast<int> (i);
@@ -269,48 +265,51 @@
         if (ch != 0)
             wav_cache.insert(name, ch);
         else
-	    enigma::Log << "Couldn't load sample '" << name << "': " << Mix_GetError() << endl;
+            enigma::Log << "Couldn't load sample '" << name << "': "
+                        << Mix_GetError() << endl;
         return ch;
     } else
         return i->second;
 }
 
-void SoundEngine_SDL::play_sound (const SoundEffect &s)
+bool SoundEngine_SDL::play_sound (const SoundEvent &s)
 {
     int channel = already_playing (s.name);
     if (channel != -1) {
         MutexLock (m_instance->m_mutex);
-        SoundEffect &se = m_channelinfo [channel];
+        SoundEvent &se = m_channelinfo [channel];
         if (se.has_position) {
             se.position = (se.position + s.position) / 2;
             update_channel (channel);
-            return;
+            return true;
         }
     }
     
     if (Mix_Chunk *chunk = cache_sound(s.name)) {
-	channel = -1; //Mix_GroupOldest(-1);
+        channel = -1; //Mix_GroupOldest(-1);
 
         channel = Mix_PlayChannel(channel, chunk, 0);
 
         if (channel != -1) {
             {
                 MutexLock (m_instance->m_mutex);
-                SoundEffect &se = m_channelinfo[channel];
+                SoundEvent &se = m_channelinfo[channel];
                 se = s;
                 se.active       = true;
                 se.playing_time = 0.0;
             }
             update_channel (channel);
         }
-    }
+        return true; // even if no free channel was found
+    } else
+        return false;
 }
 
 void SoundEngine_SDL::tick (double dtime)
 {
     MutexLock (m_instance->m_mutex);
     for (size_t i=0; i<m_channelinfo.size(); ++i) {
-        SoundEffect &se = m_channelinfo[i];
+        SoundEvent &se = m_channelinfo[i];
         if (se.active)
             se.playing_time += dtime;
     }
@@ -337,7 +336,7 @@
 void SoundEngine_SDL::channel_finished (int channel)
 {
     MutexLock (m_instance->m_mutex);
-    SoundEffect &se = m_instance->m_channelinfo[channel];
+    SoundEvent &se = m_instance->m_channelinfo[channel];
     se.active = false;
 }
 
@@ -378,7 +377,7 @@
 void sound::Shutdown() 
 {
     if (sound_engine.get())
-	sound_engine->shutdown();
+        sound_engine->shutdown();
 }
 
 void sound::Tick (double dtime)
@@ -418,12 +417,12 @@
     sound_engine->set_listenerpos (pos);
 }
 
-void sound::PlaySound (const SoundName &name, const ecl::V2 &pos, double volume, int priority) 
+bool sound::PlaySound (const SoundName &name, const ecl::V2 &pos, double volume, int priority) 
 {
     if (!sound_enabled)
-        return;
+        return false;
 
-    SoundEffect se;
+    SoundEvent se;
     se.name         = name;
     se.has_position = true;
     se.position     = pos;
@@ -431,12 +430,12 @@
     se.volume       = volume * options::GetDouble("SoundVolume");
     se.left = se.right = 0;
 
-    sound_engine->play_sound (se);
+    return sound_engine->play_sound (se);
 }
 
-void sound::PlaySoundGlobal (const SoundName &name, double volume, int priority) 
+bool sound::PlaySoundGlobal (const SoundName &name, double volume, int priority) 
 {
-    SoundEffect se;
+    SoundEvent se;
     se.name         = name;
     se.has_position = false;
     se.position     = ecl::V2();
@@ -445,7 +444,7 @@
     se.left         = 255;
     se.right        = 255;
 
-    sound_engine->play_sound (se);
+    return sound_engine->play_sound (se);
 }
 
 void sound::FadeoutMusic() 
@@ -686,18 +685,352 @@
     return chunk;
 }
 
-bool sound::SoundEvent (const std::string &eventname, const ecl::V2 &pos, double volume)
+
+/* ------------- Conversion and helper functions ------------- */
+
+/*! This function defines how to put soundset_key and eventname together to
+  create an eventkey. */
+
+string SoundEngine::effectKey(string effect_name, string soundset_name)
 {
-    lua_State *L = lua::GlobalState();
+    if (soundset_name == "")
+        return getActiveSoundSetKey() + "#" + effect_name;
+    else
+        return soundset_name + "#" + effect_name;
+}
 
-    lua_getglobal (L, "SoundEvent");
-    lua_pushstring (L, eventname.c_str());
-    lua_pushnumber (L, pos[0]);
-    lua_pushnumber (L, pos[1]);
-    lua_pushnumber (L, volume);
-    lua_call (L, 4, 1);
+/*! This function searches the known sound sets for a sound set with given
+  oxyd version, and returns the sound set name (or empty string if none). */
 
-    int success = static_cast<int> (lua_tonumber (L, 1));
-    lua_pop (L, 1);
-    return success != 0;
+string SoundEngine::getOxydSoundSet(OxydVersion oxyd_ver)
+{
+    for (SoundSetRepository::iterator i = sound_sets.begin();
+             i != sound_sets.end(); ++i)
+        if((*i).second.getOxydVersion() == oxyd_ver)
+            return (*i).first;
+    return "";
 }
+
+string sound::GetOxydSoundSet(OxydVersion oxyd_ver)
+{
+    return sound_engine->getOxydSoundSet(oxyd_ver);
+}
+
+/*! Enigma 1.00 only knew the option "SoundSet", which was an integer. This
+  was quite unhandy if one wanted to add additional sound sets. Since 1.01
+  Enigma features the option "SoundSetName". Still, old "SoundSet" is needed
+  if user wants to switch to <= 1.00 again; so here are the conversion
+  functions. Any user sound set is mapped to 0 ("Default").  */
+
+int SoundEngine::convertToOldSoundSetNumber(string soundset_name)
+{
+    if(soundset_name == "Default")  return 0;
+    if(soundset_name == "Enigma")   return 1;
+    SoundSet sd = sound_sets[soundset_name];
+    if(sd.isOxyd())
+        return ((int) sd.getOxydVersion()) + 2;
+    return 0;
+}
+
+string SoundEngine::convertFromOldSoundSetNumber(int soundset_number)
+{
+    if(soundset_number == 0)  return "Default";
+    if(soundset_number == 1)  return "Enigma";
+    return getOxydSoundSet((OxydVersion) (soundset_number - 2));
+}
+
+/* -------------------- Sound set handling -------------------- */
+
+/*! These functions fill in data for the sound sets, initialises and
+  activates them. Return false, if something went wrong, e.g. when an
+  oxyd sound set is mentioned to not accessible oxyd version. */
+
+bool SoundEngine::defineSoundSet(string soundset_name, string soundset_key,
+                                 int button_position)
+{
+    sound_sets[soundset_name] = SoundSet(soundset_key, button_position);
+    Log << "Added sound set '" << soundset_name << "' (key '" << soundset_key
+        << "') on position " << button_position << ".\n";
+    return true;
+}
+
+bool SoundEngine::defineSoundSetOxyd(string soundset_name, string soundset_key,
+                                     OxydVersion oxyd_ver, int button_position)
+{
+    if(oxyd::FoundOxyd(oxyd_ver)) {
+        sound_sets[soundset_name] =
+            SoundSet(soundset_key, button_position, (OxydVersion) oxyd_ver);
+        Log << "Added sound set '" << soundset_name << "' (key '" << soundset_key
+            << "') on position " << button_position << ".\n";
+        return true;
+    } else {
+        Log << "Skipped sound set '" << soundset_name << "'.\n";
+        return false;
+    }
+}
+
+bool SoundSet::activate()
+{
+    if(getSoundSetKey() == "")
+        return false;
+    if(isOxyd() &&  !oxyd::InitOxydSoundSet(getOxydVersion()))
+        return false;
+    sound_engine->setActiveSoundSetKey(getSoundSetKey());
+    return true;
+}
+
+void sound::InitSoundSets() {
+    sound_engine->initSoundSets();
+}
+
+void SoundEngine::initSoundSets()
+{
+    // Define sound sets
+    sound_sets.clear();
+    assert(sound_sets.empty());
+    assert(defineSoundSet ("Enigma",   "Enigma",  1));
+    int pos = 2; // position in options menu button
+    if (defineSoundSetOxyd ("Oxyd",     "Oxyd*",   OxydVersion_Oxyd1,          pos))  pos++;
+    if (defineSoundSetOxyd ("Magnum",   "Magnum*", OxydVersion_OxydMagnum,     pos))  pos++;
+    if (defineSoundSetOxyd ("Mag.Gold", "Magnum*", OxydVersion_OxydMagnumGold, pos))  pos++;
+    if (defineSoundSetOxyd ("Per.Oxyd", "Oxyd*",   OxydVersion_PerOxyd,        pos))  pos++;
+    if (defineSoundSetOxyd ("Extra",    "Oxyd*",   OxydVersion_OxydExtra,      pos))  pos++;
+    // Define user sound sets, as given by sound_effects
+    for (SoundEffectRepository::iterator i = sound_effects.begin();
+         i != sound_effects.end(); ++i) {
+        string soundset_key = (*i).second.getSoundSetKey();
+        bool found = false;
+        // ignore Oxyd* and Magnum* sound effects, if no 
+        if ((soundset_key != "Oxyd*") && (soundset_key != "Magnum*")) {
+            for (SoundSetRepository::iterator j = sound_sets.begin();
+                 j != sound_sets.end(); ++j)
+                if((*j).second.getSoundSetKey() == soundset_key)
+                    found = true;
+            if(!found)
+                if (defineSoundSet (soundset_key, soundset_key, pos))  pos++;
+        }
+    }
+    Log << "Found " << pos - 1 << " different sound sets.\n";
+    setSoundSetCount(pos - 1);
+    setDefaultSoundSet("Enigma");
+    // Extract sound set names and keys from options; activate!
+    string soundset_name = options::GetString("SoundSetName");
+    if (soundset_name == "") { // just switched from 1.00 to higher
+        soundset_name = convertFromOldSoundSetNumber(options::GetInt("SoundSet"));
+        options::SetOption("SoundSetName", soundset_name);
+    }
+    if (soundset_name == "Default")
+        soundset_name = getDefaultSoundSet();
+    clear_cache();
+    if (sound_sets[soundset_name].activate()) 
+        Log << "Activated sound set '" << soundset_name << "'.\n";
+    else {
+        // Fallback, happens e.g. when oxyd sound set can't be established or 
+        // a user soundset is given which doesn't exist anymore.
+        Log << "Warning: Soundset '" << soundset_name << "' not available.\n";
+        if (sound_sets["Enigma"].activate()) {
+            options::SetOption("SoundSetName", "Enigma");
+            options::SetOption("SoundSet", convertToOldSoundSetNumber("Enigma"));
+        } else
+            ASSERT(false, XFrontend,
+                "Soundsets defect and fallback 'Enigma' not available.");
+    }
+}
+
+void SoundEngine::setActiveSoundSet(string soundset_name)
+{
+    string soundset_key = sound_sets[soundset_name].getSoundSetKey();
+    if (soundset_key == getActiveSoundSetKey())
+        return;
+    if (soundset_key == "Default") {
+        Log << "Warning: Tried to choose 'Default' as effective sound set.\n";
+        return;
+    }
+    if (soundset_key == "") {
+        Log << "Warning: Tried to choose empty sound set key as effective sound set.\n";
+        return;
+    }
+    clear_cache();
+    if (sound_sets[soundset_name].activate()) {
+        Log << "Switched to sound set '" << soundset_name << "' (key '" 
+            << soundset_key << "').\n";
+    } else
+        Log << "Warning: Problems loading sound set '" << soundset_name << "' (key'"
+            << soundset_key << "').\n";
+}
+
+void sound::SetActiveSoundSet(string soundset_name)
+{
+    sound_engine->setActiveSoundSet(soundset_name);
+}
+
+void sound::SetDefaultSoundSet(string soundset_name)
+{
+    sound_engine->setDefaultSoundSet(soundset_name);
+    if(options::GetString("SoundSetName") == "Default")
+        SetActiveSoundSet(soundset_name);
+}
+
+string SoundEngine::getSoundSetByPosition(int button_position)
+{
+    for (SoundSetRepository::iterator i = sound_sets.begin();
+             i != sound_sets.end(); ++i)
+        if((*i).second.getButtonPosition() == button_position)
+            return (*i).first;
+    return "";
+}
+
+/* -------------------- Playing sound events -------------------- */
+
+/*! The first function creates an interface to add sound events to Enigma.
+  It is accessed via sound-defaults.lua and user sound definitions.
+  The second method is the interface between the formal SoundEffect
+  and the sound engine (via PlaySound[Global]). The last two functions
+  define the interface between level objects and SoundEffect. */
+
+void sound::DefineSoundEffect(string soundset_key, string name, string filename,
+                              double volume, bool loop, bool global, int priority,
+                              double damp_max, double damp_inc, double damp_mult,
+                              double damp_min, double damp_tick, string silence_string) {
+    assert(sound_engine.get());
+    if(soundset_key == "") {
+        Log << "Warning: Tried to define sound event '" << name
+            << "' without sound set key. Skipped.\n";
+        return;
+    }
+    sound_engine->defineSoundEffect(soundset_key, name,
+        SoundEffect(name, soundset_key, filename, volume, loop, global, priority,
+        damp_max, damp_inc, damp_mult, damp_min, damp_tick, silence_string));
+}
+
+bool SoundEffect::play(const ecl::V2 &pos, double vol, bool glob)
+{
+    if (filename == "") {
+        Log << "No soundfile given for sound event " << name << ".\n";
+        return false;
+    }
+    if (glob || global)
+        return PlaySoundGlobal (filename, volume * vol, priority);
+    else
+        return PlaySound (filename, pos, volume * vol, priority);
+}
+
+bool SoundEngine::emitSoundEvent (const std::string &eventname, const ecl::V2 &pos,
+                            double volume, bool force_global)
+{
+    string effectkey = effectKey(eventname);
+    SoundEffectRepository::iterator i = sound_effects.find(effectkey);
+    if (i == sound_effects.end()) {
+        Log << "Undefined sound event " << effectkey << " @ " 
+            << pos[0] << "," << pos[1] << "\n";
+        return false;
+    } else {
+        return (*i).second.play(pos, volume, force_global);
+    }
+}
+
+bool sound::EmitSoundEvent (const std::string &eventname, const ecl::V2 &pos,
+                            double volume, bool force_global)
+{
+    return sound_engine->emitSoundEvent(eventname, pos, volume, force_global);
+}
+
+bool sound::EmitSoundEventGlobal (const std::string &eventname, double volume)
+{
+    return sound_engine->emitSoundEvent(eventname, ecl::V2(), volume, true);
+}
+
+void SoundEngine::writeSilenceString (const std::string &eventname)
+{
+    string effectkey = effectKey(eventname);
+    SoundEffectRepository::iterator i = sound_effects.find(effectkey);
+    if (i != sound_effects.end()) {
+        string silence_string = (*i).second.getSilenceString();
+        if (silence_string != "")
+            client::Msg_ShowText (silence_string, true);
+    }
+}
+
+void sound::WriteSilenceString (const std::string &eventname)
+{
+    sound_engine->writeSilenceString(eventname);
+}
+
+/* -------------------- Sound damping implementation -------------------- */
+
+/*! These methods are connected to the sound damping mechanism, designed
+  to reduce the noise created by some objects like st-lightpassenger. */
+
+SoundDamping::SoundDamping(std::string effect_name_, const void *origin_)
+: effect_name(effect_name_), origin(origin_)
+{
+    damp = sound_engine->getDampingData(effect_name_);
+    factor = damp.incr;
+    //Log << "New damping entry " << effect_name << " with " << damp.incr << ".\n";
+}
+
+float SoundDamping::get_volume(float def_volume) {
+    if (factor < damp.maxi)
+        factor += damp.incr;
+    //Log << "  Found entry " << effect_name << ". Factor is now " << i->factor << ".\n";
+    float q = factor * damp.mult;
+    if (q > 1.0)
+        return def_volume / q;
+    return def_volume;
+}
+
+bool SoundDamping::tick() {
+    // return true, if this entity is to be destroyed.
+    factor *= damp.tick;
+    return (factor <= damp.mini);
+}
+
+/* -------------------- Sound option helpers -------------------- */
+
+/*! These functions are used in OptionsMenu.cc for the Soundset-Button. */
+
+int sound::GetOptionSoundSetCount()
+{        
+    return sound_engine->getSoundSetCount() + 1;
+}
+
+int sound::GetOptionSoundSet()
+{
+    string soundSet = options::GetString("SoundSetName");
+    if (soundSet == "Default")
+        return 0;
+    int pos = sound_engine->getButtonPosition(soundSet);
+    assert(pos > 0);
+    return pos;
+}
+
+void sound::SetOptionSoundSet(int value)
+{
+    if(value == 0) {
+        // settting to default sound set
+        if (options::GetString("SoundSetName") == "Default")
+            return;
+        options::SetOption("SoundSetName", "Default");
+        options::SetOption("SoundSet", sound_engine->convertToOldSoundSetNumber("Default"));
+        SetActiveSoundSet(sound_engine->getDefaultSoundSet());
+    } else {
+        string newSet = sound_engine->getSoundSetByPosition(value);
+        assert(newSet != "");
+        if (options::GetString("SoundSetName") == newSet)
+            return;
+        options::SetOption("SoundSetName", newSet);
+        options::SetOption("SoundSet", sound_engine->convertToOldSoundSetNumber(newSet));
+        SetActiveSoundSet(newSet);
+    }
+}
+
+string sound::GetOptionSoundSetText(int value)
+{
+    if(value == 0)
+        return N_("Default");
+    string soundset_name = sound_engine->getSoundSetByPosition(value);
+    if(soundset_name == "")
+        return "INVALID";
+    return soundset_name;
+}
+

Modified: branches/1.0/src/sound.hh
===================================================================
--- branches/1.0/src/sound.hh	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/sound.hh	2007-04-20 12:02:41 UTC (rev 693)
@@ -1,5 +1,6 @@
 /*
  * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2007 Andreas Lochmann
  *
  * This program is free software; you can redistribute it and/or
  * modify it under the terms of the GNU General Public License
@@ -20,10 +21,114 @@
 #define SOUND_HH
 
 #include "ecl_math.hh"
+#include "oxydlib/OxydVersion.h"
 
 #include <string>
 #include <vector>
 
+/** ----------- Survey of the formal data structure -----------
+ *
+ *  The wav-files are not to be accessed directly. There are several layers
+ *  between the wav-data and the final EmitSoundEvent-function, to allow for the
+ *  following uses:
+ *    (a) Sound Sets, possibly user defined,
+ *    (b) Access to oxyd's sound data,
+ *    (c) Sound damping for loud objects with user defined data,
+ *    (d) A "Default" mode which switches the sound set between level packs.
+ *    (e) A "silence string" that can be written instead of playing the sound.
+ *  For this, six layers of sound information exist.
+ *  Note: A sound effect is given by a wav-file and several data how to play it.
+ *        An object may choose a sound effect to play. Then it becomes a sound
+ *        event (= sound effect + position etc.).
+ *
+ *    (1) SoundEngine
+ *         -> Providing global information and methods for using SDL.
+ *    (2) SoundData
+ *         -> Holding technical details about how to play the wav-files.
+ *    (3) SoundEffect
+ *         -> Holding game-related information about how to play a sound
+ *            effect. This includes the effect's filename, default volume,
+ *            if it's looped, if it's played on a global scale by default,
+ *            the default damping information for this event, etc.
+ *    (4) SoundSet
+ *         -> Holding the sound set key of a sound set (see below), and if
+ *            it is connected to Oxyd. It also provides methods to
+ *            activate a sound set.
+ *    (5) SoundEvent
+ *         -> A struct to hold information about a sound event, like the
+ *            effect's name, position, priority, volume etc.
+ *    (6) SoundDamping
+ *         -> Each time an object makes noise, a SoundDamping-record
+ *            is created with an entry of the objects address (as void *).
+ *            This class modulates the volume with which the next effect
+ *            connected to this object is played.
+ *
+ *  Sound events are normally invoked by "EmitSoundEvent(EFFECTNAME, ...)".
+ *  EFFECTNAME can then be e.g. "pickup" or "laseron". This effect name does not
+ *  yet define the sound effect completely. Instead, the actually activated sound
+ *  set is looked up. It holds a string called sound set key (e.g. "Enigma" or
+ *  "Oxyd*"), and together with the effect name they form the effect key, here
+ *  "Enigma#pickup" or "Oxyd*#laseron". This effect key is looked up in the sound
+ *  effect repository and results in a SoundEffect-entry, which is then played.
+ *
+ */
+
+/** -------------- About the sound damping system --------------
+ *
+ *  The sound damping is not automatically used. Instead, it is called through
+ *  the "World::getVolume"-function:
+ *    sound::EmitSoundEvent (NAME, POS, getVolume(NAME, OBJECT_CALLING, DEF_VOLUME))
+ *  OBJECT_CALLING need not be a real address, it is never dereferenced. It just
+ *  holds as a representative of the calling object. The SoundDamping-records
+ *  are evaluated and finally erased by World::tick_sound_dampings. 
+ *
+ *  The values used in the sound damping systes can be user defined. In the
+ *  following, we use the defaults:
+ *
+ *  tick_sound_dampings is only to be evaluated every 10th tick (0.1s).
+ *  Each damping factor (the ivar connected to the noisy object and its sound
+ *  effect name) is reduced by 0.9. This is less than the 10th root of 0.5 (0.933),
+ *  so after 1s the damping factor is reduced by more than one half. If the factor
+ *  shrinks under 0.5, it is considered 0.
+ *
+ *  Examples:
+ *    1) Frequency less than one sound event per 0.6 seconds.
+ *       Then there is no damping at all.
+ *    2) N events per second. For each event, factor (F) is raised by
+ *       one. And each 0.1 seconds it is multiplied with 0.9. We now
+ *       have N/10 events per 0.1 seconds, hence in equilibrium f
+ *       oscillates between
+ *            f = (f + N/10) * 0.9   =>   f = N
+ *       and  f + N/10 = N * 1.1 (geometric series!).
+ *  In particular, for large enough N, f is approximately proportional
+ *  to N with half-life of less than a second. This is then evaluated
+ *  in getVolume.
+ * 
+ *  World::getVolume returns the volume, if object OBJECT_CALLING wants
+ *  to play sound effect NAME with default volume DEF_VOLUME. Often played
+ *  sounds from always the same object are damped to reduce noise-level.
+ *  Note that OBJECT_CALLING == NULL is explicitly allowed and used e.g.
+ *  for all laser-sounds. The damping factor is increased by 1.0 for each
+ *  event, and multiplied with 0.9 each 0.1 seconds, thereby approximately
+ *  equals the average number of events per second.
+ *
+ */
+
+/** -------------- Compatibility with 1.00 --------------
+ *
+ *  Enigma 1.01 uses a new option "SoundSetName", which replaces "SoundSet".
+ *  To enable Enigma 1.00 to run on the same system, the "SoundSet" variable
+ *  still exists. It is set to 0 (= "Default") for all user sound sets:
+ *  When exiting 1.01 with a user sound set and starting 1.00, the default
+ *  sound set will be activated for 1.00. Yet, as "SoundSetName" still shows
+ *  the old value, 1.01 will use it to find its user sound set. Even if
+ *  you change the sound set in 1.00, this will have no effect on the
+ *  chosen sound set for 1.01. In contrast to this, if you change the 1.01
+ *  sound set, the 1.00 "SoundSet"-variable will be adapted. Except for this
+ *  "restriction", you can use two different sound sets for 1.00 and 1.01.
+ *
+ */
+
 namespace sound
 {
 /* -------------------- Data types -------------------- */
@@ -40,6 +145,35 @@
         int      nchannels;
     };
 
+/* -------------------- SoundDampingList ---------------- */
+
+/*! This class stores object addresses and assigns volumes to
+    sound events, based on the frequency of the event. */
+
+    struct DampingData {
+        double incr;
+        double maxi;
+        double mult;
+        double mini;
+        double tick;
+    };
+
+    class SoundDamping {
+    private:
+        std::string effect_name;
+        const void *origin;
+        float factor;
+        DampingData damp;
+
+    public:
+        SoundDamping(std::string effect_name_, const void *origin_);
+        bool is_equal(std::string name2, const void *origin2) {
+            return (origin2 == origin) && (effect_name == name2);
+        }
+        float get_volume(float def_volume);
+        bool tick();  // returns true if this entry should be erased
+    };
+
 /* -------------------- Functions -------------------- */
 
     void Init();
@@ -55,8 +189,9 @@
     void TempReEnableSound();
 
     void SetListenerPosition (const ecl::V2 &pos);
-    void PlaySound (const SoundName &, const ecl::V2 &pos, double relative_volume = 1.0, int priority=0);
-    void PlaySoundGlobal (const SoundName &, double relative_volume = 1.0, int priority=0);
+    bool PlaySound (const SoundName &, const ecl::V2 &pos,
+                    double relative_volume = 1.0, int priority=0);
+    bool PlaySoundGlobal (const SoundName &, double relative_volume = 1.0, int priority=0);
 
     void PlayMusic (const std::string &name);
     void FadeoutMusic();
@@ -68,18 +203,39 @@
       continue playing. */
     void StopMusic (const std::string &name);
 
-    /*! Trigger a sound event that is dispatched to the Lua function
-      `SoundEvent'.  Return true if the event was handles, false
-      otherwise. */
-    bool SoundEvent (const std::string &eventname,
-                     const ecl::V2 &pos = ecl::V2 (), 
-                     double volume = 1.0);
-
     void ClearCache();
     void DefineSound (const SoundName &, const SoundData &);
     void SetSoundVolume (double vol);
     void SetMusicVolume (double vol);
 
+    /*! Helper function for oxyd.cc */
+    std::string GetOxydSoundSet(OxydLib::OxydVersion oxyd_ver);
+
+    /*! Sound set handling */
+    void InitSoundSets();
+    void SetActiveSoundSet(std::string soundset_name);
+    void SetDefaultSoundSet(std::string soundset_name);
+
+    /*! Define a new sound event. */
+    void DefineSoundEffect(std::string soundset_key, std::string name, std::string filename,
+                           double volume, bool loop, bool global, int priority,
+                           double damp_max, double damp_inc, double damp_mult,
+                           double damp_min, double damp_tick, std::string silence_string);
+
+    /*! Trigger a sound event.  Return whether the event was handled. */
+    bool EmitSoundEvent (const std::string &eventname,
+                         const ecl::V2 &pos = ecl::V2 (), 
+                         double volume = 1.0, bool force_global = false);
+    bool EmitSoundEventGlobal (const std::string &eventname, double volume = 1.0);
+
+    /*! Send the silence string of a sound effect to command line. */
+    void WriteSilenceString (const std::string &eventname);
+
+    /*! Helper functions for options menu */
+    int GetOptionSoundSetCount();
+    int GetOptionSoundSet();
+    void SetOptionSoundSet(int value);
+    std::string GetOptionSoundSetText(int value);
 }
 
 #endif

Modified: branches/1.0/src/sound_internal.hh
===================================================================
--- branches/1.0/src/sound_internal.hh	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/sound_internal.hh	2007-04-20 12:02:41 UTC (rev 693)
@@ -1,13 +1,13 @@
 namespace
 {
 
-/* -------------------- SoundEffect -------------------- */
+/* -------------------- SoundEvent -------------------- */
 
-    struct SoundEffect {
+    struct SoundEvent {
         // Variables
         SoundName name;
         bool      has_position;
-        ecl::V2    position;
+        ecl::V2   position;
         int       priority;
         double    volume;           // Volume between 0.0 and 1.0
         int       left;
@@ -18,9 +18,89 @@
         double    playing_time;
 
         // Constructor
-        SoundEffect ();
+        SoundEvent ();
     };
 
+/* -------------------- SoundEffect and SoundEffectRepository ---------------- */
+
+/*! This class stores information about how to play sound events
+    and provides methods to play them. */
+
+    class SoundEffect {
+    public:
+        SoundEffect(string name_, string soundset_key_, string filename_,
+                       double volume_, bool loop_, bool global_, int priority_,
+                       double damp_max_, double damp_inc_, double damp_mult_,
+                       double damp_min_, double damp_tick_, string silence_string_)
+        : name(name_), soundset_key(soundset_key_), filename(filename_), volume(volume_),
+          loop(loop_), global(global_), priority(priority_),
+          silence_string(silence_string_) {
+            damp.maxi = damp_max_;
+            damp.incr = damp_inc_;
+            damp.mult = damp_mult_;
+            damp.mini = damp_min_;
+            damp.tick = damp_tick_;
+        }
+
+        SoundEffect()  // standard empty data set, compare sound-defaults.lua
+        : name("EMPTY_EVENT"), filename(""), soundset_key(""), volume(1.0),
+          loop(false), global(false), priority(1), silence_string("") {
+            damp.maxi = 20.0;
+            damp.incr =  1.0;
+            damp.mult =  1.0;
+            damp.mini =  0.5;
+            damp.tick =  0.9;
+        }
+
+        void setFilename(string filename_) { filename = filename_; }
+        bool play(const ecl::V2 &pos = ecl::V2(), double vol = 1.0, bool glob = false);
+        DampingData getDampingData() { return damp; }
+        string getSoundSetKey() { return soundset_key; }
+        string getSilenceString() { return silence_string; }
+
+    private:
+        string name;
+        string filename;
+        string soundset_key;
+        string silence_string;
+        double volume;
+        bool loop;
+        bool global;
+        int priority;
+        DampingData damp;
+    };
+
+    class SoundSet {
+    public:
+        SoundSet(string soundset_key_, int button_position_, OxydLib::OxydVersion oxyd_ver_)
+        : soundset_key(soundset_key_), is_oxyd(true), oxyd_ver(oxyd_ver_),
+          button_position(button_position_) {}
+
+        SoundSet(string soundset_key_, int button_position_)
+        : soundset_key(soundset_key_), is_oxyd(false),
+          oxyd_ver(OxydLib::OxydVersion_Invalid), button_position(button_position_) {}
+
+        SoundSet()
+        : soundset_key(""), is_oxyd(false),
+          oxyd_ver(OxydLib::OxydVersion_Invalid), button_position(-1) {}
+
+        bool activate();
+        OxydLib::OxydVersion getOxydVersion() { return oxyd_ver; }
+        bool isOxyd() { return is_oxyd; }
+        string getSoundSetKey() { return soundset_key; }
+        int getButtonPosition() { return button_position; }
+        void setButtonPosition(int pos) { button_position = pos; }
+
+    private:
+        string soundset_key;
+        bool is_oxyd;
+        OxydLib::OxydVersion oxyd_ver;
+        int button_position;
+    };
+
+    typedef map<string, SoundEffect> SoundEffectRepository;
+    typedef map<string, SoundSet> SoundSetRepository;
+        
 /* -------------------- SoundEngine -------------------- */
 
     class SoundEngine {
@@ -46,13 +126,48 @@
         virtual void clear_cache() = 0;
         virtual void define_sound (const SoundName &, const std::string &filename)=0;
         virtual void define_sound (const SoundName &, const SoundData &)=0;
-        virtual void play_sound (const SoundEffect &s) = 0;
+        virtual bool play_sound (const SoundEvent &s) = 0;
         virtual void set_listenerpos (ecl::V2 pos) = 0;
-        virtual void tick (double dtime) 
-        {}
+        virtual void tick (double dtime) {}
+
+        // ---------- Sound effect repository and sound sets ----------
+
+        void setActiveSoundSetKey(string soundset_key) {active_sound_set_key=soundset_key;}
+        string getActiveSoundSetKey() { return active_sound_set_key; }
+        void setDefaultSoundSet(string soundset_name) {default_sound_set=soundset_name;}
+        string getDefaultSoundSet() { return default_sound_set; }
+        string effectKey(string effect_name, string soundset_name = "");
+        DampingData getDampingData(string effect_name) {
+            return sound_effects[effectKey(effect_name)].getDampingData(); }
+        void defineSoundEffect(string soundset_key, string name, SoundEffect se) {
+            sound_effects[effectKey(name, soundset_key)] = se;
+        }
+        bool emitSoundEvent (const std::string &eventname, const ecl::V2 &pos = ecl::V2 (), 
+                             double volume = 1.0, bool force_global = false);
+        void writeSilenceString (const std::string &eventname);
+        void initSoundSets();
+        bool defineSoundSet(string soundset_name, string soundset_key, int button_position);
+        bool defineSoundSetOxyd(string soundset_name, string soundset_key,
+                                OxydLib::OxydVersion oxyd_ver, int button_position);
+        string getOxydSoundSet(OxydLib::OxydVersion oxyd_ver);
+        int convertToOldSoundSetNumber(string soundset_name);
+        string convertFromOldSoundSetNumber(int soundset_number);
+        void setActiveSoundSet(string soundset_name);
+        void setSoundSetCount(int count) { sound_set_count = count; }
+        int getSoundSetCount() { return sound_set_count; }
+        int getButtonPosition(string soundset_name) {
+            return sound_sets[soundset_name].getButtonPosition();
+        }
+        string getSoundSetByPosition(int button_position);
+
+    private:
+        SoundSetRepository       sound_sets;
+        SoundEffectRepository    sound_effects;
+        string                   active_sound_set_key;
+        string                   default_sound_set;
+        int                      sound_set_count;
     };
 
-
     class SoundEngine_Null : public SoundEngine {
     public:
 
@@ -60,35 +175,16 @@
         bool init() { return true; }
         void shutdown() {}
         void clear_cache() {}
-
-        bool is_initialized() const 
-        { return true; }
-
-        void set_sound_volume(double /*soundvol*/)
-        {}
-
-        void set_music_volume(double /*musicvol*/) 
-        {}
-
-        bool play_music (const std::string &/*filename*/) 
-        { return false; }
-
-        void stop_music() 
-        {}
-
-        void fadeout_music() 
-        {}
-
-        void play_sound (const SoundEffect &)
-        {}
-
-        void define_sound (const SoundName &, const std::string &/*filename*/)
-        {}
-
-        void define_sound (const SoundName &, const SoundData &)
-        {}
-        void set_listenerpos (ecl::V2 pos) 
-        {}
+        bool is_initialized() const { return true; }
+        void set_sound_volume(double /*soundvol*/) {}
+        void set_music_volume(double /*musicvol*/) {}
+        bool play_music (const std::string &/*filename*/) { return false; }
+        void stop_music() {}
+        void fadeout_music() {}
+        bool play_sound (const SoundEvent &) {}
+        void define_sound (const SoundName &, const std::string &/*filename*/) {}
+        void define_sound (const SoundName &, const SoundData &) {}
+        void set_listenerpos (ecl::V2 pos) {}
     };
 
     class SoundEngine_SDL : public SoundEngine {
@@ -108,7 +204,7 @@
         void stop_music();
         void fadeout_music();
 
-        void play_sound(const SoundEffect &s);
+        bool play_sound(const SoundEvent &s);
         void clear_cache();
         void define_sound (const SoundName &, const std::string &filename);
         void define_sound (const SoundName &, const SoundData &);
@@ -136,7 +232,7 @@
         Uint16     m_format;
         int        m_channels;
         ecl::Dict<Mix_Chunk*> wav_cache;
-        vector<SoundEffect> m_channelinfo;
+        vector<SoundEvent> m_channelinfo;
         ecl::V2      m_listenerpos;
         SDL_mutex  *m_mutex;
         static SoundEngine_SDL *m_instance;

Modified: branches/1.0/src/stones_complex.cc
===================================================================
--- branches/1.0/src/stones_complex.cc	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/stones_complex.cc	2007-04-20 12:02:41 UTC (rev 693)
@@ -1853,7 +1853,7 @@
         NameObject(target, old_name);
 
     server::IncMoveCounter();
-    sound::SoundEvent ("movesmall", my_pos.center());
+    sound::EmitSoundEvent ("movesmall", my_pos.center());
 }
 
 

Modified: branches/1.0/src/world.cc
===================================================================
--- branches/1.0/src/world.cc	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/world.cc	2007-04-20 12:02:41 UTC (rev 693)
@@ -829,7 +829,7 @@
                         double volume = std::max (0.25, length(ai.vel)/8);
                         volume = std::min (1.0, volume);
                         volume = getVolume(sc.sound.c_str(), a, volume);
-                        sound::SoundEvent (sc.sound.c_str(), sc.contact_point, volume);
+                        sound::EmitSoundEvent (sc.sound.c_str(), sc.contact_point, volume);
                     }
                 }
             }
@@ -923,8 +923,10 @@
             if (!has_nearby_contact (a1.contacts, contact)) {
                 double volume = length (force) * ActorTimeStep;
                 volume = std::min(1.0, volume);
-                if (volume > 0.4)
-                    sound::SoundEvent ("ballcollision", contact.pos, volume);
+                if (volume > 0.4) {
+                    volume = getVolume("ballcollision", NULL, volume);
+                    sound::EmitSoundEvent ("ballcollision", contact.pos, volume);
+                }
             }
         }
     }
@@ -1076,24 +1078,7 @@
 
 void World::tick_sound_dampings ()
 {
-    /* tick_sound_dampings is only to be evaluated every 10th tick (0.1s).
-       Each damping factor is reduced by 0.9. This is less than the 10th
-       root of 0.5 (0.933), so after 1s the damping factor is reduced by more
-       than one half. If the factor shrinks under 0.5, it is considered 0.
-
-       Examples:
-         1) Frequency less than one sound event per 0.6 seconds.
-            Then there is no damping at all.
-         2) N events per second. For each event, factor (F) is raised by
-            one. And each 0.1 seconds it is multiplied with 0.9. We now
-            have N/10 events per 0.1 seconds, hence in equilibrium f
-            oscillates between
-                 f = (f + N/10) * 0.9   =>   f = N
-            and  f + N/10 = N * 1.1 (geometric series!).
-       In particular, for large enough N, f is approximately proportional
-       to N with half-life of less than a second. This is then evaluated
-       in getVolume. */
-    
+    // See sound.hh and sound.cc for details.
     static int counter = 0;
     ++counter;
 
@@ -1103,12 +1088,10 @@
             end = level->sound_dampings.end();
         int count = 0;
         while (i != end) {
-            i->factor *= 0.933;
-            if (i->factor <= 0.5) {
+            if(i->tick()) // return true if damping entry should be deleted
                 i = level->sound_dampings.erase(i);
-            } else {
+            else
                 ++i;
-            }
         }
     }
 }
@@ -1840,33 +1823,16 @@
 
 float world::getVolume(const char *name, Object *obj, float def_volume)
 {
-    /* Return volume, if object OBJ wants to play sound event NAME with
-       default volume DEF_VOLUME. Often played sounds from always the
-       same object are damped to reduce noise-level. Note that OBJ == NULL
-       is explicitly allowed and used e.g. for all laser-sounds. 
-       The damping factor is increased by 1.0 for each event, and
-       multiplied with 0.9 each 0.1 seconds, thereby approximately equals
-       the average number of events per second (see tick_sound_dampings). */
-
+    // See sound.hh and sound.cc for details.
     SoundDampingList::iterator i = level->sound_dampings.begin(),
         end = level->sound_dampings.end();
-    //int count = 0; // only used for log-purposes
     while (i != end) {
-        //++count;
-        if ((i->origin == obj) && (i->event_name == name)) {
-            if (i->factor < 20.0)
-                ++(i->factor);
-	    //Log << "  Found entry " << count << ". Factor is now " << i->factor << ".\n";
-            float vol = def_volume;
-            if (i->factor > 1.0)
-                vol /= i->factor;
-            return vol;
-        }
+        if (i->is_equal(name, obj))
+            return i->get_volume(def_volume);
         ++i;
     }
-    // No entry found for this object. Create a new one with debt 1.
-    //Log << "Creating new entry.\n";
-    level->sound_dampings.push_back(SoundDamping(name, obj, 1));
+    // No entry found for this object. Create a new one.
+    level->sound_dampings.push_back(sound::SoundDamping(name, obj));
     return def_volume;
 }
 

Modified: branches/1.0/src/world.hh
===================================================================
--- branches/1.0/src/world.hh	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/world.hh	2007-04-20 12:02:41 UTC (rev 693)
@@ -364,7 +364,7 @@
     };
     void SendExplosionEffect (GridPos p, ExplosionType type);
 
-/* -------------------- Sound Damping -------------------- */
+/* -------------------- Sound Events and Damping -------------------- */
 
     float getVolume(const char *name, Object *obj, float def_volume = 1.0);
 

Modified: branches/1.0/src/world_internal.hh
===================================================================
--- branches/1.0/src/world_internal.hh	2007-04-17 22:46:27 UTC (rev 692)
+++ branches/1.0/src/world_internal.hh	2007-04-20 12:02:41 UTC (rev 693)
@@ -186,23 +186,6 @@
 
     typedef list<DelayedImpulse> ImpulseList;
 
-/* -------------------- SoundDampingList ---------------- */
-
-/*! This class stores object addresses and assigns volumes to
-    sound events, based on the frequency of the event. */
-
-    class SoundDamping {
-    public:
-        const char *event_name;
-        const Object *origin;
-        float factor;
-
-        SoundDamping(const char *event_name_, const Object *origin_, float factor_)
-        : event_name(event_name_), origin(origin_), factor(factor_) {}
-    };
-
-    typedef list<SoundDamping> SoundDampingList;
-
 /* -------------------- Layer -------------------- */
 
     template <class T>
@@ -273,7 +256,10 @@
         BorderStone borderstone;
     };
 
+/* ------------- Sound Damping List -------------- */
 
+typedef list<sound::SoundDamping> SoundDampingList;
+
 /* -------------------- World -------------------- */
 
     /*! Contains the level information (in theory everything that is
@@ -354,7 +340,7 @@
         ImpulseList          delayed_impulses;
         vector<GridPos>      changed_stones;
 
-        SoundDampingList     sound_dampings;
+        SoundDampingList     sound_dampings; // see sound.hh for details
 
         FloorLayer      fl_layer;
         ItemLayer       it_layer;



From andreasl at mail.berlios.de  Fri Apr 20 21:09:49 2007
From: andreasl at mail.berlios.de (andreasl at BerliOS)
Date: Fri, 20 Apr 2007 21:09:49 +0200
Subject: [Enigma-game-svn] r694 - branches/1.0/data/levels/lib
Message-ID: <200704201909.l3KJ9nMG008151@sheep.berlios.de>

Author: andreasl
Date: 2007-04-20 21:09:48 +0200 (Fri, 20 Apr 2007)
New Revision: 694

Modified:
   branches/1.0/data/levels/lib/andreas_itemfreeze.xml
Log:
Revised itemfreeze-library:
 - check for existence by default to avoid crashs
 - added optional "modern fire" support



Modified: branches/1.0/data/levels/lib/andreas_itemfreeze.xml
===================================================================
--- branches/1.0/data/levels/lib/andreas_itemfreeze.xml	2007-04-20 12:02:41 UTC (rev 693)
+++ branches/1.0/data/levels/lib/andreas_itemfreeze.xml	2007-04-20 19:09:48 UTC (rev 694)
@@ -2,7 +2,7 @@
   <el:protected>
     <el:info el:type="library">
       <el:identity el:title="" el:id="lib/andreas_itemfreeze"/>
-      <el:version el:score="1" el:release="1" el:revision="0" el:status="released"/>
+      <el:version el:score="1" el:release="1" el:revision="2" el:status="released"/>
       <el:author  el:name="Andreas Lochmann" el:email="" el:homepage=""/>
       <el:copyright>Copyright ? 2006 Andreas Lochmann</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
@@ -18,7 +18,7 @@
 
 -- andreas_itemfreeze, a lua-library for Enigma
 --
--- Version 1/2
+-- Version 26/50
 --
 -- Usage:
 --
@@ -126,13 +126,14 @@
 --
 --  itemfreeze_test_for_explosion:  (default 1)
 --  itemfreeze_test_for_fire:  (default 0)
---  itemfreeze_test_for_existence:  (default 0)
+--  itemfreeze_test_for_existence:  (default 1)
 --    Set to one/zero to activate/deactivate checking for explosions
 --    respectively fire. Deactivation might heighten the performance.
---    If your st-itemfreeze might disappear in another way than
---    melting or shattering (e.g. by it-seed), you should activate
---    itemfreeze_test_for_existence to avoid crashs, but this again
---    might result in a worse performance.
+--    If your st-itemfreeze can't disappear in another way than
+--    melting or shattering (e.g. by it-seed), you could deactivate
+--    itemfreeze_test_for_existence, resulting in a better performance.
+--    Remember that this might cause crashs, when itemfreezes are
+--    destroyed in an unusual way.
 --
 --  itemfreeze_melt_on_damage:  (default 20)
 --    If fire is detected near st-itemfreeze, it increases
@@ -149,6 +150,13 @@
 --    so you might want to deactivate this feature by setting
 --    itemfreeze_remove_hollow to zero.
 --
+--  itemfreeze_modern_fire:  (default 0)
+--    Burnables are removed by itemfreeze explosions by default.
+--    The main goal of this is to extinguish near fire. However,
+--    the 1.0 Fire System contains it-burnable_oil, which is
+--    removed as well, which doesn't make sense. So set this
+--    variable to 1 to adapt it to 1.0 (burnables are not removed,
+--    but a "stopfire" message is sent to the floor).
 --
 -- Further comments:
 --
@@ -157,6 +165,12 @@
 --  which is by default 0 (= every cycle). This way you can also add
 --  randomness to the itemfreeze-explosions.
 --
+--
+-- Changes in version 26/50
+--
+--  - added itemfreeze_modern_fire option
+--  - set itemfreeze_test_for_existence to 1 for default
+--
 
 --------------------------------------
 --  Global variables and constants  --
@@ -168,9 +182,10 @@
 itemfreeze_option = 5
 itemfreeze_test_for_explosion = 1
 itemfreeze_test_for_fire = 0
-itemfreeze_test_for_existence = 0
+itemfreeze_test_for_existence = 1
 itemfreeze_melt_on_damage = 20
 itemfreeze_remove_hollow = 1
+itemfreeze_modern_fire = 0
 
 -- shouldn't-be-changed-options --
 
@@ -205,12 +220,17 @@
 
 
 function itemfreeze_remove_burnables(pos_x, pos_y)
-  local myitem = enigma.GetItem(pos_x, pos_y)
-  if myitem ~= nil then
-    local kind = enigma.GetKind(myitem)
-    if (kind == "it-burnable") or (kind == "it-burnable_ignited") 
-             or (kind == "it-burnable_burning") then
-      kill_item(pos_x, pos_y)
+  if itemfreeze_modern_fire == 1 then
+    local myfloor = enigma.GetFloor(pos_x, pos_y)
+    SendMessage(myfloor, "stopfire")
+  else
+    local myitem = enigma.GetItem(pos_x, pos_y)
+    if myitem ~= nil then
+      local kind = enigma.GetKind(myitem)
+      if (kind == "it-burnable") or (kind == "it-burnable_ignited") 
+               or (kind == "it-burnable_burning") then
+        kill_item(pos_x, pos_y)
+      end
     end
   end
 end



From ral at mail.berlios.de  Mon Apr 23 19:57:44 2007
From: ral at mail.berlios.de (ral at BerliOS)
Date: Mon, 23 Apr 2007 19:57:44 +0200
Subject: [Enigma-game-svn] r695 - in branches/1.0/src: . gui lev
Message-ID: <200704231757.l3NHvieH003628@sheep.berlios.de>

Author: ral
Date: 2007-04-23 19:57:43 +0200 (Mon, 23 Apr 2007)
New Revision: 695

Modified:
   branches/1.0/src/gui/MainMenu.cc
   branches/1.0/src/lev/Proxy.cc
   branches/1.0/src/main.hh
Log:
Branch 1.0
- update contributors
- fix r565 compatibility mode for levels that load a lib
- increase compatibility version to 1.01


Modified: branches/1.0/src/gui/MainMenu.cc
===================================================================
--- branches/1.0/src/gui/MainMenu.cc	2007-04-20 19:09:48 UTC (rev 694)
+++ branches/1.0/src/gui/MainMenu.cc	2007-04-23 17:57:43 UTC (rev 695)
@@ -142,12 +142,16 @@
         0,
         N_("Special Thanks:"),
         "  Johannes Fortmann  (Mac OS X port, some programming, graphics)",
+        "  illmind  (Forum mag-heut.net administration, Level design)",
+        "  Jennifer Robertson  (Graphics second generation)",
         "  Jeremy Sawicki  (Oxydlib)",
         "  Erich Schubert  (Debian packages)",
+        "  Lukas Sch?ller  (Level design)",
         "  Andrew \'Necros\' Sega (Menu music \'Pentagonal Dreams\')",
 // waiting for licence to add the sounds
 //        "  \'Cellar of Rats\'  (Sound effects)", 
         "  David W. Skinner  (Many Sokoban Levels)",
+        "  Clifford J. Tasner  (Music second generation, Proof reading)",
         0,
         N_("Contributors:"),
         "  Roberto Bardin  (Level design)",
@@ -162,7 +166,6 @@
         "  Roberto Garc?a (Spanish translation)",
         "  Edwin Groothuis  (FreeBSD port)",
         "  Immanuel Herrmann  (Level design)",
-        "  illmind  (Level design)",
         "  M?t? Lehel Juh?sz  (Hungarian translation)",
         0,
         "  Samuele Kaplun  (Italian translation)",
@@ -178,7 +181,7 @@
         "  Krishnamurti L.L.V. Nunes (Portuguese translation)",
         "  Daniel Nylander  (Swedish translation)",
         "  Peter Santo  (Level design)",
-        "  Lukas Sch?ller  (Level design)",
+        "  Tobias Schmidbauer  (Windows installer and icon)",
         "  Achim Settelmeier  (RPM specfile)",
         0,
         "  Jon Sneyers  (Level design)",
@@ -191,6 +194,7 @@
         "  Michael Terry  (.desktop file)",
         "  Ray Wick  (Level design)",
         "  Joe Wreschnig  (Manual page)",
+        "  ???? ????????? - Yuriy Zhyromskiy  (Russian Manual)",
         0,
     };
     

Modified: branches/1.0/src/lev/Proxy.cc
===================================================================
--- branches/1.0/src/lev/Proxy.cc	2007-04-20 19:09:48 UTC (rev 694)
+++ branches/1.0/src/lev/Proxy.cc	2007-04-23 17:57:43 UTC (rev 695)
@@ -614,7 +614,9 @@
         if (getEnigmaCompatibility() > ENIGMACOMPATIBITLITY)
             throw XLevelLoading(ecl::strf("Level is incompatible: %s requires Enigma %.2f or above", 
                     absLevelPath.c_str(), getEnigmaCompatibility()));
-        server::SetCompatibility(this);
+	if (this == currentLevel) {
+	    server::SetCompatibility(this);
+	}
         processDependencies();
         loadLuaCode();
     }

Modified: branches/1.0/src/main.hh
===================================================================
--- branches/1.0/src/main.hh	2007-04-20 19:09:48 UTC (rev 694)
+++ branches/1.0/src/main.hh	2007-04-23 17:57:43 UTC (rev 695)
@@ -19,7 +19,7 @@
 #ifndef ENIGMA_MAIN_HH
 #define ENIGMA_MAIN_HH
 
-#define ENIGMACOMPATIBITLITY 1.00
+#define ENIGMACOMPATIBITLITY 1.01
 #define PREFFILENAME "enigmarc.xml"
 #define RATINGSFILENAME "ratings.xml"
 



From ral at mail.berlios.de  Tue Apr 24 23:02:14 2007
From: ral at mail.berlios.de (ral at BerliOS)
Date: Tue, 24 Apr 2007 23:02:14 +0200
Subject: [Enigma-game-svn] r696 - in branches/1.0: . data/gfx doc doc/images
	doc/images/flags25x15 etc src
Message-ID: <200704242102.l3OL2EFI021911@sheep.berlios.de>

Author: ral
Date: 2007-04-24 23:01:57 +0200 (Tue, 24 Apr 2007)
New Revision: 696

Added:
   branches/1.0/doc/images/enigma.css
   branches/1.0/doc/images/flags25x15/
   branches/1.0/doc/images/flags25x15/Makefile.am
   branches/1.0/doc/images/flags25x15/de.png
   branches/1.0/doc/images/flags25x15/fr.png
   branches/1.0/doc/images/flags25x15/gb.png
   branches/1.0/doc/images/flags25x15/ru.png
   branches/1.0/doc/images/nav_cornerul.gif
   branches/1.0/doc/images/nav_cornerur.gif
   branches/1.0/doc/images/nav_enigma.gif
Removed:
   branches/1.0/doc/images/enigma2.css
   branches/1.0/doc/images/navbar.png
Modified:
   branches/1.0/configure.ac
   branches/1.0/data/gfx/enigma_marble.png
   branches/1.0/doc/images/Makefile.am
   branches/1.0/doc/images/favicon.png
   branches/1.0/doc/index.html
   branches/1.0/etc/enigma.icns
   branches/1.0/etc/mingw32-dist.sh.in
   branches/1.0/src/enigma.ico
Log:
Branch 1.0
- new marble logo as Vista compatible icon
- doc/index.html updated to new look&feel


Modified: branches/1.0/configure.ac
===================================================================
--- branches/1.0/configure.ac	2007-04-23 17:57:43 UTC (rev 695)
+++ branches/1.0/configure.ac	2007-04-24 21:01:57 UTC (rev 696)
@@ -356,6 +356,7 @@
            data/schemas/Makefile
 	   doc/Makefile
 	   doc/images/Makefile
+	   doc/images/flags25x15/Makefile
 	   doc/manual/Makefile
 	   doc/manual/images/Makefile
 	   doc/reference/Makefile

Modified: branches/1.0/data/gfx/enigma_marble.png
===================================================================
(Binary files differ)

Modified: branches/1.0/doc/images/Makefile.am
===================================================================
--- branches/1.0/doc/images/Makefile.am	2007-04-23 17:57:43 UTC (rev 695)
+++ branches/1.0/doc/images/Makefile.am	2007-04-24 21:01:57 UTC (rev 696)
@@ -1,5 +1,7 @@
+SUBDIRS = flags25x15
+
 pngdir=@datadir@/doc/enigma/images
-png_DATA= enigma2.css menu_bg.jpg navbar.png favicon.png
+png_DATA= enigma.css menu_bg.jpg nav_enigma.gif nav_cornerul.gif nav_cornerur.gif favicon.png
 
 
 EXTRA_DIST = $(png_DATA)

Added: branches/1.0/doc/images/enigma.css
===================================================================
--- branches/1.0/doc/images/enigma.css	2007-04-23 17:57:43 UTC (rev 695)
+++ branches/1.0/doc/images/enigma.css	2007-04-24 21:01:57 UTC (rev 696)
@@ -0,0 +1,456 @@
+/* Copyright (C) 2007 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+body { 
+    margin: 0;
+    padding: 0;
+    height: 100%;
+    background-color: #aaaaaa;
+    text-align: center;
+    font-family: sans-serif;
+    font-size: small;
+}
+
+:link  { 
+    color: #930; 
+    text-decoration: none;
+}
+
+:visited  { 
+    color: #930; 
+    text-decoration: none;
+}
+
+:link:hover, :visited:hover {
+    color: #777;
+    text-decoration: none;
+}
+
+:link:active, :link:active {
+    color: #000;
+}
+
+.dbody { 
+    min-width: 700px;
+    max-width: 1000px;
+    margin: auto;
+    padding: 10px;
+    position: relative;
+    font-size: 110%;
+}
+
+li {
+    padding: 1px 4px;
+}
+
+.note {
+    background-color: #eeeeee;
+    border: thin solid black;
+    padding: 5px;
+}
+
+.navbar {
+    background-color: #666666;
+    height: 100px;
+    top: 0;
+    border-bottom: 1px solid black;
+}
+
+.navbar .navcornerul {
+    float: left;
+    width: 15px;
+    height: 15px;
+    overflow:hidden;
+}
+
+.navbar .navcornerur {
+    float: right;
+    width: 15px;
+    height: 15px;
+    overflow:hidden;
+}
+
+.navbar .navlink {
+    margin-left: 15px;
+    margin-right: 15px;
+    text-align: left;
+}
+
+.navbar .navlink .navenigma {
+    float: left;
+    margin: 0;
+}
+
+.navbar .navlink .navlang {
+    float: right;
+    margin-bottom: 10px;
+}
+
+.navbar .navlink .navmain {
+    clear: right;
+    margin-left: 0px;
+    padding-bottom: 10px;
+}
+
+.navbar .navlink .navmain tr {
+    padding-left: 0;
+}
+
+.navbar .navmain a:hover {   /* IE */
+    background-color: #ffffff;
+}
+
+.navbar .navmain a:hover img {  /* Firefox,... */
+    background-color: #ffffff;
+}
+
+.mainbody {
+    text-align: left;
+    padding-left: 1.0em;
+    padding-right: 1.0em;
+    padding-top: 1.0em;
+    padding-bottom: 1em;
+    margin-top: 0;
+    border-left: 1px solid black;
+    border-right: 1px solid black;
+}
+
+.leftcolumn {
+    float: left;
+    width: 20%;
+    min-width: 144px;
+}
+
+
+.mainbody .menu {
+    margin-bottom: 1em;
+    font-size: 100%;
+    padding-left: 0px;
+    padding-top: 0;
+}
+
+.menu ul  {
+    margin-left: 0;
+    padding: 0;
+    list-style: none;
+    margin-top: 0;
+}
+
+.mlist {
+    margin: 0 0 1em 0;
+}
+
+.mlist li {
+    display: inline;
+    padding: 0;
+    margin: 0;
+}
+
+.mlist li a  { 
+    text-decoration: none; 
+    background: #ededed; 
+    display: block; 
+    padding: 3px 10px; 
+    border-top: 1px solid #fff; 
+    border-right: 1px solid #ddd; 
+    border-bottom: 1px solid #ddd 
+}
+
+.mlist li li a {
+    padding: 3px 8px 3px 20px;
+}
+
+.mlist li li li a {
+    padding: 3px 8px 3px 30px;
+}
+
+.mlist :link:hover, .mlist :visited:hover {
+    color: #555;
+    text-decoration: none;
+}
+
+.mlist :link:active, .mlist :link:active {
+    color: #555;
+}
+
+
+.menusubtitle  { 
+    color: #666; 
+    font-size: 80%;
+}
+
+.rightcolumn {
+    float: right;
+    width: 195px;
+}
+
+.infobody {
+    width: 180px;
+    font-size: 90%;    
+    border:1px solid black;
+    background-color: #a8a8a8;
+    margin-left: 1em;
+    margin-bottom: 20px;
+}
+
+.info {
+    margin: 10px;
+}
+
+.info h3 {
+    width: auto;
+    border-bottom: 1px dotted #333;
+    font-size: 110%;
+}
+
+.imagetitle {
+    text-align: center;
+    padding-top: 1em;
+}
+
+.info :link:hover, .info :visited:hover {
+    color: #555;
+    text-decoration: none;
+}
+
+.info :link:active, .info :link:active {
+    color: #555;
+}
+
+.screenshot img {
+    border-width: 4px;
+}
+
+.screenshot a:link, .screenshot  a:visited {
+    color: #777;   /* IE needs body attributes for image coloring */
+}
+
+.screenshot a:link:hover, .screenshot a:visited:hover {
+    color: #333;   /* IE needs body attributes for image coloring */
+}
+
+.powered-by {
+    margin-top: 1.5em;
+    border-top: 1px solid #666;
+}
+
+.powered-by a:link, .powered-by  a:visited {
+    color: #777;   /* IE needs body attributes for image coloring */
+}
+
+.powered-by a:link:hover, .powered-by a:visited:hover {
+    color: #333;   /* IE needs body attributes for image coloring */
+}
+
+.bottombar {
+    /*  border-top: 1px solid black; */
+    padding: 1px;
+    background-color: #666666;
+    color: #aaaaaa;
+    text-align: center;
+    border-left: 1px solid black;
+    border-right: 1px solid black;
+    border-bottom: 1px solid black;
+}
+
+.bottombar :link  { 
+    color: #333; 
+    text-decoration: none;
+}
+
+.bottombar :visited  { 
+    color: #333; 
+    text-decoration: none;
+}
+
+.bottombar :link:hover, .bottombar :visited:hover {
+    color: #ccc;
+    text-decoration: none;
+}
+
+.bottombar :link:active, .bottombar :link:active {
+    color: #000;
+}
+
+
+.bottombar p { 
+    padding-left: 1.0em;
+    font-size: 80%;
+}
+
+
+.main {
+    margin-left: 1.0em;
+    line-height: 130%;
+}
+
+.main h2 {
+}
+
+.main h3 {
+    width: auto;
+    border-bottom: 1px dotted #777;
+}
+
+.date {
+    color: gray;
+}
+
+.testimonial .quote {
+    padding-right: 3em;
+    padding-left: 2em;
+    font-family: serif;
+    margin-top: 1.7em;
+    margin-bottom: 0px;
+}
+
+.testimonial .author {
+    margin-top: 0px;
+    margin-bottom: 0px;
+    padding-right: 3em;
+    padding-left: 2em;
+    text-align: right;
+    font-size: 90%;
+}
+
+.faq h4 {
+    font-size: 100%;
+    color: #333;
+    border-bottom: none;
+}
+
+.faq p {
+    padding-left: 1em;
+}
+
+.arrowup {
+    float: right;
+}
+
+.faq ul ul {
+    margin-left: 0em;    /* overwrite IE indention */
+    padding-left: 1em;   /* overwrite Firefox indention */
+}
+
+.usernames {
+    font-size: 100%;
+    margin-top: 4em;
+    border:1px solid black;
+    padding-left: 0.5em;
+}
+
+.usernames ul {
+    font-size: 85%;
+    list-style-type: none;
+    text-indent: -3em;
+}
+
+.stat-help {
+    float: right;
+    width: 40%;
+    font-size: 90%;
+    border:1px solid black;
+    padding: 1em;
+}
+
+.statistics table {
+    margin-bottom: 50px;
+    text-align: center;
+    line-height: 120%;
+}
+.statistics caption {
+    font-weight: bold;
+    font-size: 110%;
+    line-height: 130%;
+}
+.statistics .left{
+    text-align: left;
+}
+.statistics .num {
+    text-align: right;
+    padding-right: 20px;
+}
+.statistics .text {
+    text-align: left;
+}
+
+.statistics .normalcaption {
+    font-size: 100%;
+}
+
+.repository {
+    font-size: 90%;
+    margin-bottom: 1em;
+}
+
+.repository td {
+    padding-left: 2em;
+    line-height: 120%;
+}
+
+.repository .path {
+    font-family: Courier, monospace;
+}
+
+.tasks .diff {
+    text-align: right;
+    font-style: italic;
+}
+
+.lotmpic {
+    float: right;
+    padding-left: 2em;
+    padding-bottom: 1em;
+}
+
+.lotm .lotmpic img {
+    border-width: 4px;
+    border-color: #777;
+    padding-right: 0em;
+    margin-top: 1em;
+    padding-top: 0em;
+    padding-bottom: 0em;
+}
+
+.lotmpic .imagetitle {
+    font-size: 90%;
+}
+
+.lotm img {
+    padding-right: 1em;
+    padding-top: 0.5em;
+    padding-bottom: 0.5em;
+}
+.lotm .quote {
+    padding-right: 3em;
+    padding-left: 2em;
+    font-family: serif;
+    margin-top: 1em;
+    margin-bottom: 0px;
+}
+
+.lotm .author {
+    margin-top: 0px;
+    margin-bottom: 0px;
+    padding-right: 3em;
+    padding-left: 2em;
+    text-align: right;
+    font-size: 90%;
+}
+
+.credits table td {
+    padding-right: 1em;
+}


Property changes on: branches/1.0/doc/images/enigma.css
___________________________________________________________________
Name: svn:eol-style
   + native

Deleted: branches/1.0/doc/images/enigma2.css
===================================================================
--- branches/1.0/doc/images/enigma2.css	2007-04-23 17:57:43 UTC (rev 695)
+++ branches/1.0/doc/images/enigma2.css	2007-04-24 21:01:57 UTC (rev 696)
@@ -1,99 +0,0 @@
-body { 
-  margin: 0;
-  padding: 0;
-  height: 100%;
-  background-color: #8f8f8f;
-  text-align: center;
-}
-
-.dbody { 
-  width: 800px;
-left:50%;
-margin-left:-400px;
-  padding: 5px;
-  position: relative;
-}
-
-li {
-  padding: 4px;
-}
-
-.note {
-  background-color: #eeeeee;
-  border: thin solid black;
-  padding: 5px;
-}
-
-.navbar {
-  width: 800px;
-/*  background-color: #88bbee; */
-  top: 0;
-  border-bottom: 1px solid black;
-}
-
-.navbar p { 
-}
-
-.navbar .head {
-  background-color: #88eeff;
-  font-weight: bold;
-  margin: 0;
-  padding: 5px;
-  border-top: thin solid black;
-  border-bottom: thin solid black;
-}
-
-.bottombar 
-{
-  /*  border-top: 1px solid black; */
-  padding: 1px;
-  background-color: #333333;
-  color: #8f8f8f;
-  text-align: center;
-  border-left: thin solid black;
-  border-right: thin solid black;
-  border-bottom: thin solid black;
-}
-
-.bottombar p { 
-  padding-left: 1.0em;
-  font-size: 70%;
-}
-
-div.logo { background: #88bbee; width:100%; }
-
-.logo a:link { color: #88bbee; }
-.logo a:visited { color: #88bbee; }
-
-.main {
-   text-align: left;
- padding-left: 1.0em;
-  padding-right: 1.0em;
-  padding-top: 0.1em;
-  padding-bottom: 1em;
-  margin-top: 0;
-  border-left: thin solid black;
-  border-right: thin solid black;
-}
-
-.main h2 {
-}
-
-.main h3 {
-  border-bottom: 1px dotted #999;
-}
-
-.news .date {
-  color: gray;
-}  
-
-table.download {
-  background-color: lightgray;
-  border-spacing: 0.6em;
-}
-
-.download th {
-  padding: 5px;
-  font-size: 120%;
-  border-bottom: thin solid black;
-}

Modified: branches/1.0/doc/images/favicon.png
===================================================================
(Binary files differ)


Property changes on: branches/1.0/doc/images/flags25x15
___________________________________________________________________
Name: svn:ignore
   + Makefile
Makefile.in


Added: branches/1.0/doc/images/flags25x15/Makefile.am
===================================================================
--- branches/1.0/doc/images/flags25x15/Makefile.am	2007-04-23 17:57:43 UTC (rev 695)
+++ branches/1.0/doc/images/flags25x15/Makefile.am	2007-04-24 21:01:57 UTC (rev 696)
@@ -0,0 +1,6 @@
+PNG = $(wildcard $(srcdir)/*.png)
+
+pngdir=@datadir@/doc/enigma/images/flags25x15
+png_DATA=$(PNG)
+
+EXTRA_DIST = $(png_DATA)


Property changes on: branches/1.0/doc/images/flags25x15/Makefile.am
___________________________________________________________________
Name: svn:eol-style
   + native

Added: branches/1.0/doc/images/flags25x15/de.png
===================================================================
(Binary files differ)


Property changes on: branches/1.0/doc/images/flags25x15/de.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: branches/1.0/doc/images/flags25x15/fr.png
===================================================================
(Binary files differ)


Property changes on: branches/1.0/doc/images/flags25x15/fr.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: branches/1.0/doc/images/flags25x15/gb.png
===================================================================
(Binary files differ)


Property changes on: branches/1.0/doc/images/flags25x15/gb.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: branches/1.0/doc/images/flags25x15/ru.png
===================================================================
(Binary files differ)


Property changes on: branches/1.0/doc/images/flags25x15/ru.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: branches/1.0/doc/images/nav_cornerul.gif
===================================================================
(Binary files differ)


Property changes on: branches/1.0/doc/images/nav_cornerul.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: branches/1.0/doc/images/nav_cornerur.gif
===================================================================
(Binary files differ)


Property changes on: branches/1.0/doc/images/nav_cornerur.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: branches/1.0/doc/images/nav_enigma.gif
===================================================================
(Binary files differ)


Property changes on: branches/1.0/doc/images/nav_enigma.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Deleted: branches/1.0/doc/images/navbar.png
===================================================================
(Binary files differ)

Modified: branches/1.0/doc/index.html
===================================================================
--- branches/1.0/doc/index.html	2007-04-23 17:57:43 UTC (rev 695)
+++ branches/1.0/doc/index.html	2007-04-24 21:01:57 UTC (rev 696)
@@ -1,61 +1,103 @@
-<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
-   "http://www.w3.org/TR/REC-html40/loose.dtd">
-<html lang="en">
-
-<head>
-  <title>
-Enigma Homepage</title>
-<link rel="stylesheet" href="images/enigma2.css" type="text/css" />
-<link rel="shortcut icon" href="images/favicon.png" />
-<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
-</head>
-
-<body>
-<div class="dbody">
-  <div class="navbar">
-    <img src="images/navbar.png"  border="0" />
-</div>
-  
-<div class="main"  style="background-image:url(images/menu_bg.jpg)">
- 
-<h2 id="Readme">Readme</h2>
-
-  <ul>
-    <li><a href="README">Readme (txt)</a>
-    <li><a href="COPYING">COPYING (txt)</a>
-    <li><a href="CHANGES">Changes (txt)</a>
-  </ul>
-
-<h2 id="manual">Manual</h2>
-
-  <ul>
-    <li><a href="manual/enigma.html">English User manual 1.00 (html)</a>
-    <li><a href="manual/enigma_de.html">Deutsches Benutzerhandbuch 1.00 (html)</a>
-    <li><a href="manual/enigma_fr.html">Manuel Fran&ccedil;ais 0.92 (html)</a>
-  </ul>
-
-  <p>Documentation updates, new translations and pdf versions of the above
-  manuals may be available at our homepage 
-  <a href="http://www.nongnu.org/enigma/documentation.html">support page</a>.
-  </p>
-  
-<h2 id="reference">Reference</h2>
-
-  <ul>
-    <li><a href="reference/enigma-ref.html">English Reference manual (html)</a>
-    <li><a href="reference/ant_lua.txt">"ant" library manual (txt)</a>
-  </ul>
-
-
-<h2 id="links">Links</h2>  
-  <ul>
-    <li><a href="http://www.nongnu.org/enigma">Enigma Homepage</a>
-  </ul>
-
-<hr>
-
-</div><div class="bottombar">
-</div>
-</div>
-</body>
-</html>
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
+   "http://www.w3.org/TR/REC-html40/loose.dtd">
+<html lang="en">
+
+<head>
+  <title>Enigma Bundled Documention</title>
+  <link rel="stylesheet" href="images/enigma.css" type="text/css">
+  <link rel="shortcut icon" href="images/favicon.png" type="image/png">
+  <meta name="keywords" content="enigma,puzzle,game,oxyd,per.oxyd,dongleware,linux,windows,mac">
+  <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
+</head>
+
+<body link="#777777" vlink="#777777"  alink="#333333"> <!-- fake IE6 to color images -->
+<div class="dbody">
+  <div class="navbar">
+    <a name="navbar" id="navbar"></a>
+    <div class="navcornerul">
+      <img src="images/nav_cornerul.gif" alt="" border="0">
+    </div>
+    <div class="navcornerur">
+      <img src="images/nav_cornerur.gif" alt="" border="0">
+    </div>
+    <div class="navlink">
+      <div class="navenigma">
+        <table border="0" cellpadding="0" cellspacing="0">
+          <tr>
+            <td><a href="index.html"><img src="images/nav_enigma.gif" alt="Enigma Logo" border="0" title="Enigma Main"></a></td>
+          </tr>
+        </table>
+      </div>
+      <table  class="navlang" border="0" cellpadding="3" cellspacing="5">
+        <tr>
+        </tr>
+      </table>
+      &nbsp;   <!-- fake IE to accept the clear of flow -->
+      <div class="navmain">
+      <table border="0" cellpadding="0" cellspacing="0">
+        <tr>
+        </tr>
+      </table></div>
+    </div>
+
+  </div>
+  <div class="mainbody" style="background-image:url(images/menu_bg.jpg)">
+    <table border="0" cellpadding="0" cellspacing="0"><tr><td> <!-- fake IE6 to draw above background -->
+      <div class="main">
+<h2>Bundled Documentation</h2>
+
+<h3>Readme</h3>
+<ul>
+  <li><a href="README">Readme (txt)</a></li>
+  <li><a href="COPYING">COPYING (txt)</a></li>
+  <li><a href="CHANGES">Changes (txt)</a></li>
+</ul>
+
+<h3>Manuals</h3>
+  <p>The complete user manual is included in multiple languages with every release
+  of Enigma.</p>
+
+  <ul> <!-- keep space in first li entry - IE needs it -->
+    <li> <img src="images/flags25x15/gb.png" border="0" width="25" height="15" alt="English" title="English">&nbsp;&nbsp;
+      <a href="manual/enigma.html">English User manual (html)</a></li>
+    <li><img src="images/flags25x15/de.png" border="0" width="25" height="15" alt="German" title="German">&nbsp;&nbsp;
+      <a href="manual/enigma_de.html">Deutsches Benutzerhandbuch (html)</a></li>
+    <li><img src="images/flags25x15/fr.png" border="0" width="25" height="15" alt="French" title="French">&nbsp;&nbsp;
+      <a href="manual/enigma_fr.html">Manuel Fran&ccedil;ais (html)</a></li>
+    <li><img src="images/flags25x15/ru.png" border="0" width="25" height="15" alt="Russian" title="Russian">&nbsp;&nbsp;
+      <a href="manual/enigma_ru.html">Russian User manual (html)</a></li>
+  </ul>
+
+  <p>Documentation updates, new translations and pdf versions of the above
+  manuals may be available at our homepage 
+  <a href="http://www.nongnu.org/enigma/documentation.html">support page</a>.
+  </p>
+  
+
+<h3>Reference</h3>
+
+  <p>Further on we provide a reference manual which is included in the Enigma
+  package, too. Many details listed here will be helpful not only for
+  power users and developers.</p>
+  <ul> <!-- keep space in first li entry - IE needs it -->
+    <li> <img src="images/flags25x15/gb.png" border="0" width="25" height="15" alt="English" title="English">&nbsp;&nbsp;
+      <a href="reference/enigma-ref.html">English Reference manual (html)</a></li>
+    <li> <img src="images/flags25x15/gb.png" border="0" width="25" height="15" alt="English" title="English">&nbsp;&nbsp;
+      <a href="reference/ant_lua.txt">"ant" library manual (txt)</a></li>
+  </ul>
+
+<h3>Links</h3>
+  <p>Please visit our homepage for up to date links and a lot of info.</p>
+  <ul>
+    <li><a href="http://www.nongnu.org/enigma">Enigma Homepage</a></li>
+  </ul>
+
+
+      </div>
+    </td></tr></table> <!-- fake IE6 to draw above background -->
+  </div>
+  <div class="bottombar">
+  </div>
+</div> </body>
+</html>
+

Modified: branches/1.0/etc/enigma.icns
===================================================================
(Binary files differ)

Modified: branches/1.0/etc/mingw32-dist.sh.in
===================================================================
--- branches/1.0/etc/mingw32-dist.sh.in	2007-04-23 17:57:43 UTC (rev 695)
+++ branches/1.0/etc/mingw32-dist.sh.in	2007-04-24 21:01:57 UTC (rev 696)
@@ -108,7 +108,7 @@
 function copy_doc
 {
     echo "... copying documentation"
-    mkdir $DDIR/images
+    mkdir $DDIR/images $DDIR/images/flags25x15
     cptext README                       README
     cptext COPYING                      COPYING
     cptext CHANGES                      CHANGES
@@ -116,10 +116,13 @@
     cptext doc/index.html 		index.html
     cptext doc/gpl.txt   		gpl.txt
     cptext doc/lgpl.txt 		lgpl.txt
-    cptext doc/images/enigma2.css	images/enigma2.css
-    cpfile doc/images/navbar.png	images/
+    cptext doc/images/enigma.css	images/enigma.css
+    cpfile doc/images/nav_enigma.gif	images/
+    cpfile doc/images/nav_cornerul.gif	images/
+    cpfile doc/images/nav_cornerur.gif	images/
     cpfile doc/images/favicon.png	images/
     cpfile doc/images/menu_bg.jpg	images/
+    cpfile doc/images/flags25x15/*.png	images/flags25x15
     cptext etc/README-SDL.txt 	        README-SDL.txt
     cptext doc/reference/ant_lua.txt 	reference/ant_lua.txt
     cptext doc/reference/sounds.txt	reference/sounds.txt

Modified: branches/1.0/src/enigma.ico
===================================================================
(Binary files differ)



From ral at mail.berlios.de  Wed Apr 25 21:43:01 2007
From: ral at mail.berlios.de (ral at BerliOS)
Date: Wed, 25 Apr 2007 21:43:01 +0200
Subject: [Enigma-game-svn] r697 - branches/1.0/src
Message-ID: <200704251943.l3PJh12M008954@sheep.berlios.de>

Author: ral
Date: 2007-04-25 21:43:00 +0200 (Wed, 25 Apr 2007)
New Revision: 697

Modified:
   branches/1.0/src/Inventory.cc
   branches/1.0/src/Inventory.hh
   branches/1.0/src/items.cc
   branches/1.0/src/player.cc
   branches/1.0/src/player.hh
Log:
Branch 1.0
- fix add of empty it-bag's to a full inventory


Modified: branches/1.0/src/Inventory.cc
===================================================================
--- branches/1.0/src/Inventory.cc	2007-04-24 21:01:57 UTC (rev 696)
+++ branches/1.0/src/Inventory.cc	2007-04-25 19:43:00 UTC (rev 697)
@@ -144,7 +144,20 @@
         std::rotate(m_items.begin(), m_items.end()-1, m_items.end());
 }
 
+bool Inventory::willAddItem(Item *it) {
+    ItemHolder *holder = dynamic_cast<ItemHolder*>(it);
+    if (is_full()) {
+	return false;
+    } else if (holder != NULL && holder->is_empty() &&
+	    (m_items.size() >= max_items || dynamic_cast<ItemHolder*>(get_item(0)) != NULL)) {
+	// should add a bag that is empty, but first item in Inventory is itself
+	// a bag or Inventory is full -- avoid recursive bags
+	return false;
+    }
+    return true;  // we have space and item is not critical
+}
 
+
 int Inventory::find(const std::string& kind, size_t start_idx) const 
 {
     size_t size_ = size();

Modified: branches/1.0/src/Inventory.hh
===================================================================
--- branches/1.0/src/Inventory.hh	2007-04-24 21:01:57 UTC (rev 696)
+++ branches/1.0/src/Inventory.hh	2007-04-25 19:43:00 UTC (rev 697)
@@ -50,6 +50,7 @@
         void rotate_right();
         Item *get_item (size_t idx) const;
         Item *yield_item (size_t idx);
+	bool willAddItem(Item *it);
 
         int find(const std::string& kind, size_t start_idx = 0) const;
 

Modified: branches/1.0/src/items.cc
===================================================================
--- branches/1.0/src/items.cc	2007-04-24 21:01:57 UTC (rev 696)
+++ branches/1.0/src/items.cc	2007-04-25 19:43:00 UTC (rev 697)
@@ -3220,7 +3220,7 @@
         // Item interface
         bool actor_hit (Actor *a) {
             if (Item::actor_hit(a)) {
-                if (Inventory *inv = player::MayPickup(a)) {
+                if (Inventory *inv = player::MayPickup(a, NULL)) {
                     std::vector<Item *>::size_type oldSize = m_contents.size();
                     inv->takeItemsFrom(this);
                     if (oldSize != m_contents.size() && inv->is_full()) {

Modified: branches/1.0/src/player.cc
===================================================================
--- branches/1.0/src/player.cc	2007-04-24 21:01:57 UTC (rev 696)
+++ branches/1.0/src/player.cc	2007-04-25 19:43:00 UTC (rev 697)
@@ -34,6 +34,7 @@
 
 using namespace std;
 using namespace enigma;
+using namespace world;
 using world::Actor;
 using enigma::Inventory;
 
@@ -533,7 +534,7 @@
 
 /*! Return pointer to inventory if actor may pick up items, 0
    otherwise. */
-Inventory *player::MayPickup(Actor *a) 
+Inventory *player::MayPickup(Actor *a, Item *it) 
 {
     int iplayer=-1;
     a->int_attrib("player", &iplayer);
@@ -545,7 +546,7 @@
     Inventory *inv = GetInventory(iplayer);
     bool dont_pickup = players[iplayer].inhibit_pickup 
         || a->is_flying()
-        || inv->is_full()
+        || !inv->willAddItem(it)
         || a->is_dead();
 
     return dont_pickup ? 0 : inv;
@@ -553,7 +554,7 @@
 
 void player::PickupItem (Actor *a, GridPos p) 
 {
-    if (Inventory *inv = MayPickup(a)) {
+    if (Inventory *inv = MayPickup(a, GetField(p)->item)) {
         if (Item *item = world::YieldItem(p)) {
             item->on_pickup(a);
             inv->add_item(item);
@@ -565,7 +566,7 @@
 
 void player::PickupStoneAsItem (Actor *a, enigma::GridPos p) 
 {
-    if (Inventory *inv = MayPickup(a)) 
+    if (Inventory *inv = MayPickup(a, GetField(p)->item)) 
     {
         if (world::Stone *stone = world::YieldStone(p)) 
         {

Modified: branches/1.0/src/player.hh
===================================================================
--- branches/1.0/src/player.hh	2007-04-24 21:01:57 UTC (rev 696)
+++ branches/1.0/src/player.hh	2007-04-25 19:43:00 UTC (rev 697)
@@ -71,7 +71,7 @@
         unsigned NumberOfRealPlayers();
 
 
-        Inventory *MayPickup(Actor *a);
+        Inventory *MayPickup(Actor *a, Item *it);
         Inventory *GetInventory(int iplayer);
         Inventory *GetInventory(Actor *a);
         bool       WieldedItemIs(Actor *a, const std::string &kind);



From ral at mail.berlios.de  Fri Apr 27 21:04:07 2007
From: ral at mail.berlios.de (ral at BerliOS)
Date: Fri, 27 Apr 2007 21:04:07 +0200
Subject: [Enigma-game-svn] r698 - branches/1.0/src
Message-ID: <200704271904.l3RJ47Ma030784@sheep.berlios.de>

Author: ral
Date: 2007-04-27 21:04:06 +0200 (Fri, 27 Apr 2007)
New Revision: 698

Modified:
   branches/1.0/src/display.cc
   branches/1.0/src/stones.hh
   branches/1.0/src/world.cc
   branches/1.0/src/world.hh
   branches/1.0/src/world_internal.hh
Log:
Branch 1.0: merge some urgent patches from 1.1 to 1.0
- r560 border collision crash fix
- r560&573 minimize sprite redraws on show/hide


Modified: branches/1.0/src/display.cc
===================================================================
--- branches/1.0/src/display.cc	2007-04-25 19:43:00 UTC (rev 697)
+++ branches/1.0/src/display.cc	2007-04-27 19:04:06 UTC (rev 698)
@@ -835,13 +835,23 @@
 }
 
 void SpriteHandle::hide() const {
-    layer->get_sprite(id)->visible = false;
-    layer->get_sprite(id)->mayNeedRedraw = false;
+    if (layer) {
+        Sprite * s = layer->get_sprite(id);
+        if(s->visible) {
+            s->visible = false;
+            layer->redraw_sprite_region(id);
+        }
+    }
 }
 
 void SpriteHandle::show() const {
-    layer->get_sprite(id)->visible = true;
-    layer->get_sprite(id)->mayNeedRedraw = true;
+    if (layer) {
+        Sprite * s = layer->get_sprite(id);
+        if(!s->visible) {
+            s->visible = true;
+            layer->redraw_sprite_region(id);
+        }
+    }
 }
 
 

Modified: branches/1.0/src/stones.hh
===================================================================
--- branches/1.0/src/stones.hh	2007-04-25 19:43:00 UTC (rev 697)
+++ branches/1.0/src/stones.hh	2007-04-27 19:04:06 UTC (rev 698)
@@ -30,7 +30,8 @@
         st_FIRST = 0,
         st_none = 0,
 
-        st_black1,
+        st_borderstone,
+	st_black1,
         st_black2,
         st_black3,
         st_black4,

Modified: branches/1.0/src/world.cc
===================================================================
--- branches/1.0/src/world.cc	2007-04-25 19:43:00 UTC (rev 697)
+++ branches/1.0/src/world.cc	2007-04-27 19:04:06 UTC (rev 698)
@@ -758,6 +758,7 @@
         c.ignore   = false;
         c.actor    = a;
         c.stonepos = p;
+	c.stoneid  = stone->get_traits().id;
         c.response = stone->collision_response(c);
         c.sound    = stone->collision_sound();
     }
@@ -805,7 +806,7 @@
     ActorInfo &ai          = *a->get_actorinfo();
     double     restitution = 1.0; //0.85;
 
-    if (server::NoCollisions)
+    if (server::NoCollisions  && (sc.stoneid != st_borderstone))
         return;
 
     Contact contact (sc.contact_point, sc.normal);

Modified: branches/1.0/src/world.hh
===================================================================
--- branches/1.0/src/world.hh	2007-04-25 19:43:00 UTC (rev 697)
+++ branches/1.0/src/world.hh	2007-04-27 19:04:06 UTC (rev 698)
@@ -81,6 +81,7 @@
         // Variables.
         Actor           *actor;
         GridPos         stonepos;
+	StoneID         stoneid;
         StoneResponse   response;
 
         V2      contact_point;  // Where do the shapes meet? (world coordinates)

Modified: branches/1.0/src/world_internal.hh
===================================================================
--- branches/1.0/src/world_internal.hh	2007-04-25 19:43:00 UTC (rev 697)
+++ branches/1.0/src/world_internal.hh	2007-04-27 19:04:06 UTC (rev 698)
@@ -251,6 +251,12 @@
             BorderStone() : Stone("borderstone") {}
             Stone *clone() { return this; }
             void dispose() {}
+            virtual const StoneTraits &get_traits() const {
+                static StoneTraits border_traits = {
+                        "INVALID", st_borderstone, stf_none, material_stone, 1.0
+                };
+                return border_traits;
+            }
         };
 
         BorderStone borderstone;



From raoul at mail.berlios.de  Fri Apr 27 23:14:29 2007
From: raoul at mail.berlios.de (raoul at BerliOS)
Date: Fri, 27 Apr 2007 23:14:29 +0200
Subject: [Enigma-game-svn] r700 - in branches/1.0/data/levels: enigma_cross
	enigma_experimental enigma_iii enigma_oxyd enigma_peroxyd
	enigma_v enigma_vi
Message-ID: <200704272114.l3RLETqu007199@sheep.berlios.de>

Author: raoul
Date: 2007-04-27 23:14:27 +0200 (Fri, 27 Apr 2007)
New Revision: 700

Modified:
   branches/1.0/data/levels/enigma_cross/newlevels.xml
   branches/1.0/data/levels/enigma_cross/newlevels_1.0.1.xml
   branches/1.0/data/levels/enigma_experimental/puzzle_demo_2.xml
   branches/1.0/data/levels/enigma_experimental/puzzle_testarea_1.xml
   branches/1.0/data/levels/enigma_iii/index.xml
   branches/1.0/data/levels/enigma_iii/just07_1.xml
   branches/1.0/data/levels/enigma_oxyd/index.xml
   branches/1.0/data/levels/enigma_oxyd/oxyd70_1.xml
   branches/1.0/data/levels/enigma_oxyd/oxydlink33_1.xml
   branches/1.0/data/levels/enigma_oxyd/oxydlink68_1.xml
   branches/1.0/data/levels/enigma_peroxyd/index.xml
   branches/1.0/data/levels/enigma_peroxyd/peroxyd62_1.xml
   branches/1.0/data/levels/enigma_peroxyd/peroxydlink06_1.xml
   branches/1.0/data/levels/enigma_peroxyd/peroxydlink13_1.xml
   branches/1.0/data/levels/enigma_v/index.xml
   branches/1.0/data/levels/enigma_v/just03_1.xml
   branches/1.0/data/levels/enigma_v/just06_1.xml
   branches/1.0/data/levels/enigma_v/raoul05_1.xml
   branches/1.0/data/levels/enigma_v/raoul12_1.xml
   branches/1.0/data/levels/enigma_v/raoul23_1.xml
   branches/1.0/data/levels/enigma_vi/index.xml
   branches/1.0/data/levels/enigma_vi/just11_1.xml
   branches/1.0/data/levels/enigma_vi/raoul13_1.xml
   branches/1.0/data/levels/enigma_vi/raoul26_1.xml
   branches/1.0/data/levels/enigma_vi/raoul30_1.xml
Log:
-> Corrected the wrong libpuzzle path in all levels from "lib/libpuzzle_2" to "lib/libpuzzle". 


Modified: branches/1.0/data/levels/enigma_cross/newlevels.xml
===================================================================
--- branches/1.0/data/levels/enigma_cross/newlevels.xml	2007-04-27 20:47:00 UTC (rev 699)
+++ branches/1.0/data/levels/enigma_cross/newlevels.xml	2007-04-27 21:14:27 UTC (rev 700)
@@ -64,7 +64,7 @@
     <level _seq="56" _title="Set Me Free" _xpath="enigma_iii/illmind06_1" author="illmind" ctrl="force" easy="false" id="illmind06" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="57" _title="Danger Slide" _xpath="enigma_iii/luc15_1" author="Lukas Sch?ller" ctrl="force" easy="false" id="luc15" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="58" _title="White Contrast" _xpath="enigma_iii/illmind07_1" author="illmind" ctrl="force" easy="false" id="illmind07" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="59" _title="Manamana" _xpath="enigma_iii/just07_1" author="JuSt" ctrl="force" easy="false" id="just07" rel="1" rev="2" score="1" target="time" unit="duration"/>
+    <level _seq="59" _title="Manamana" _xpath="enigma_iii/just07_1" author="JuSt" ctrl="force" easy="false" id="just07" rel="1" rev="3" score="1" target="time" unit="duration"/>
     <level _seq="60" _title="Bad Flowers" _xpath="enigma_iii/nat30_1" author="Nat Pryce" ctrl="force" easy="true" id="nat30" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="61" _title="Don't Touch" _xpath="enigma_iii/raoul07_2" author="Raoul Bourquin" ctrl="force" easy="true" id="raoul07" rel="2" rev="1" score="2" target="time" unit="duration"/>
     <level _seq="62" _title="Laser Castle" _xpath="enigma_iii/andreas04_1" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas04" rel="1" rev="0" score="1" target="time" unit="duration"/>
@@ -105,9 +105,9 @@
     <level _seq="97" _title="Jesusbond" _xpath="enigma_v/richi02_1" author="Richi B?tzer" ctrl="force" easy="false" id="richi02" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="98" _title="Sentry Duty" _xpath="enigma_v/nat25_1" author="Nat Pryce" ctrl="force" easy="true" id="nat25" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="99" _title="Thievish Alleys" _xpath="enigma_v/andreas33_1" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas33" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="100" _title="Double play" _xpath="enigma_v/just06_1" author="JuSt" ctrl="force" easy="false" id="just06" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="101" _title="Oxyd-Puzzle" _xpath="enigma_v/raoul05_1" author="Raoul Bourquin" ctrl="force" easy="false" id="raoul05" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="102" _title="Keystone" _xpath="enigma_v/raoul12_1" author="Raoul Bourquin" ctrl="force" easy="true" id="raoul12" rel="1" rev="2" score="1" target="time" unit="duration"/>
+    <level _seq="100" _title="Double play" _xpath="enigma_v/just06_1" author="JuSt" ctrl="force" easy="false" id="just06" rel="1" rev="2" score="1" target="time" unit="duration"/>
+    <level _seq="101" _title="Oxyd-Puzzle" _xpath="enigma_v/raoul05_1" author="Raoul Bourquin" ctrl="force" easy="false" id="raoul05" rel="1" rev="2" score="1" target="time" unit="duration"/>
+    <level _seq="102" _title="Keystone" _xpath="enigma_v/raoul12_1" author="Raoul Bourquin" ctrl="force" easy="true" id="raoul12" rel="1" rev="3" score="1" target="time" unit="duration"/>
     <level _seq="103" _title="Print 23" _xpath="enigma_v/richi07_1" author="Richi B?tzer" ctrl="force" easy="false" id="richi07" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="104" _title="Laser Crossing" _xpath="enigma_v/luc24_1" author="Lukas Sch?ller" ctrl="force" easy="true" id="luc24" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="105" _title="The Carousel" _xpath="enigma_v/luc30_1" author="Lukas Sch?ller" ctrl="force" easy="false" id="luc30" rel="1" rev="0" score="1" target="time" unit="duration"/>
@@ -134,7 +134,7 @@
     <level _seq="126" _title="Acoustic Memory" _xpath="enigma_v/andreas25_2" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas25" rel="2" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="127" _title="Fatal Attraction II" _xpath="enigma_v/spaceman02_1" author="Spaceman" ctrl="force" easy="false" id="spaceman2" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="128" _title="Fatal Attraction III" _xpath="enigma_v/spaceman03_1" author="Spaceman" ctrl="force" easy="false" id="spaceman3" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="129" _title="Doors forever" _xpath="enigma_v/just03_1" author="JuSt" ctrl="force" easy="true" id="just03" rel="1" rev="2" score="1" target="time" unit="duration"/>
+    <level _seq="129" _title="Doors forever" _xpath="enigma_v/just03_1" author="JuSt" ctrl="force" easy="true" id="just03" rel="1" rev="3" score="1" target="time" unit="duration"/>
     <level _seq="130" _title="Catwalk Meditation" _xpath="enigma_v/ral05_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20060505ral007" rel="1" rev="42" score="1" target="time" unit="duration"/>
     <level _seq="131" _title="Dynamice" _xpath="enigma_v/andreas20_1" author="Andreas Lochmann" ctrl="force" easy="false" id="andreas20" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="132" _title="Cold Mail" _xpath="enigma_v/andreas18_1" author="Andreas Lochmann" ctrl="force" easy="false" id="andreas18" rel="1" rev="0" score="1" target="time" unit="duration"/>
@@ -147,11 +147,11 @@
     <level _seq="139" _title="You need them" _xpath="enigma_v/raoul11_1" author="Raoul Bourquin" ctrl="force" easy="false" id="raoul11" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="140" _title="Pipes and Plumbing" _xpath="enigma_v/andreas27_1" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas27" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="141" _title="The Chamber" _xpath="enigma_v/luc31_2" author="Lukas Sch?ller" ctrl="force" easy="false" id="luc31" rel="2" rev="1" score="2" target="time" unit="duration"/>
-    <level _seq="142" _title="Spacestation" _xpath="enigma_v/raoul23_1" author="Raoul Bourquin" ctrl="force" easy="true" id="raoul23" rel="1" rev="2" score="1" target="time" unit="duration"/>
+    <level _seq="142" _title="Spacestation" _xpath="enigma_v/raoul23_1" author="Raoul Bourquin" ctrl="force" easy="true" id="raoul23" rel="1" rev="3" score="1" target="time" unit="duration"/>
     <level _seq="143" _title="A-way" _xpath="enigma_vi/richi06_1" author="Richi B?tzer" ctrl="force" easy="true" id="richi06" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="144" _title="Toreador" _xpath="enigma_vi/ral02_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20060213ral004" rel="1" rev="43" score="1" target="time" unit="duration"/>
     <level _seq="145" _title="Laser Splitting" _xpath="enigma_vi/luc29_1" author="Lukas Sch?ller" ctrl="force" easy="false" id="luc29" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="146" _title="Oxydrings" _xpath="enigma_vi/raoul13_1" author="Raoul Bourquin" ctrl="force" easy="false" id="raoul13" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="146" _title="Oxydrings" _xpath="enigma_vi/raoul13_1" author="Raoul Bourquin" ctrl="force" easy="false" id="raoul13" rel="1" rev="2" score="1" target="time" unit="duration"/>
     <level _seq="147" _title="Pac Marble" _xpath="enigma_vi/andreas22_1" author="Andreas Lochmann" ctrl="force" easy="false" id="andreas22" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="148" _title="Basketball" _xpath="enigma_vi/ral03_2" author="Ronald Lamprecht" ctrl="force" easy="true" id="20060213ral005" rel="2" rev="43" score="2" target="time" unit="duration"/>
     <level _seq="149" _title="Orbitting" _xpath="enigma_vi/andreas26_1" author="Andreas Lochmann" ctrl="force" easy="true" id="andreas26" rel="1" rev="0" score="1" target="time" unit="duration"/>
@@ -201,7 +201,7 @@
     <level _seq="193" _title="Ariadne" _xpath="enigma_vi/andreas40_1" author="Andreas Lochmann" ctrl="force" easy="false" id="andreas40" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="194" _title="Oiltrace" _xpath="enigma_vi/raoul25_1" author="Raoul Bourquin" ctrl="force" easy="false" id="raoul25" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="195" _title="The Cube" _xpath="enigma_vi/malaire01_1" author="Markus Laire" ctrl="force" easy="true" id="20061120malaire901" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="196" _title="Puzzle Puzzles" _xpath="enigma_vi/raoul26_1" author="Raoul Bourquin" ctrl="force" easy="true" id="raoul26" rel="1" rev="24" score="1" target="time" unit="duration"/>
+    <level _seq="196" _title="Puzzle Puzzles" _xpath="enigma_vi/raoul26_1" author="Raoul Bourquin" ctrl="force" easy="true" id="raoul26" rel="1" rev="25" score="1" target="time" unit="duration"/>
     <level _seq="197" _title="Checkmate II" _xpath="enigma_vi/andreas35_1" author="Andreas Lochmann" ctrl="force" easy="false" id="andreas35" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="198" _title="be quick or be dead" _xpath="enigma_vi/illmind12_1" author="illmind" ctrl="force" easy="true" id="illmind12" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="199" _title="Tarzan" _xpath="enigma_vi/ulf03_1" author="Ulf Stegemann" ctrl="force" easy="true" id="20060629ulf003" rel="1" rev="0" score="1" target="time" unit="duration"/>

Modified: branches/1.0/data/levels/enigma_cross/newlevels_1.0.1.xml
===================================================================
--- branches/1.0/data/levels/enigma_cross/newlevels_1.0.1.xml	2007-04-27 20:47:00 UTC (rev 699)
+++ branches/1.0/data/levels/enigma_cross/newlevels_1.0.1.xml	2007-04-27 21:14:27 UTC (rev 700)
@@ -17,7 +17,7 @@
     <level _seq="9" _title="Counterclockwise" _xpath="enigma_vi/ulf05_1" author="Ulf Stegemann" ctrl="force" easy="true" id="20070126ulf020" rel="1" rev="93" score="1" target="time" unit="duration"/>
     <level _seq="10" _title="Check the light" _xpath="enigma_vi/just10_1" author="JuSt" ctrl="force" easy="false" id="just10" rel="1" rev="4" score="1" target="time" unit="duration"/>
     <level _seq="11" _title="Twokoban I" _xpath="enigma_vi/raoul28_1" author="Raoul Bourquin" ctrl="force" easy="true" id="raoul28" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="12" _title="The passage" _xpath="enigma_vi/just11_1" author="JuSt" ctrl="force" easy="false" id="just11" rel="1" rev="5" score="1" target="time" unit="duration"/>
+    <level _seq="12" _title="The passage" _xpath="enigma_vi/just11_1" author="JuSt" ctrl="force" easy="false" id="just11" rel="1" rev="6" score="1" target="time" unit="duration"/>
     <level _seq="13" _title="Magic triangle" _xpath="enigma_vi/just13_1" author="JuSt" ctrl="force" easy="false" id="just13" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="14" _title="Revolver" _xpath="enigma_vi/ral16_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20070214ral703" rel="1" rev="59" score="1" target="time" unit="duration"/>
     <level _seq="15" _title="Devil's bolder" _xpath="enigma_vi/just14_1" author="JuSt" ctrl="force" easy="true" id="just14" rel="1" rev="2" score="1" target="time" unit="duration"/>
@@ -27,7 +27,7 @@
     <level _seq="19" _title="jumping ball flash" _xpath="enigma_vi/illmind13_1" author="illmind" ctrl="force" easy="false" id="2007ill001" rel="1" rev="3" score="1" target="time" unit="duration"/>
     <level _seq="20" _title="Cold Meditation" _xpath="enigma_vi/ral18_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20070314ral728" rel="1" rev="67" score="1" target="time" unit="duration"/>
     <level _seq="21" _title="Same task ..." _xpath="enigma_vi/raoul29_1" author="Raoul Bourquin" ctrl="force" easy="true" id="raoul29" rel="1" rev="2" score="1" target="time" unit="duration"/>
-    <level _seq="22" _title="Industrial puzzles" _xpath="enigma_vi/raoul30_1" author="Raoul Bourquin" ctrl="force" easy="false" id="raoul30" rel="1" rev="3" score="1" target="time" unit="duration"/>
+    <level _seq="22" _title="Industrial puzzles" _xpath="enigma_vi/raoul30_1" author="Raoul Bourquin" ctrl="force" easy="false" id="raoul30" rel="1" rev="4" score="1" target="time" unit="duration"/>
     <level _seq="23" _title="Odyssey" _xpath="enigma_vi/ant39_1" author="Petr Machata" ctrl="force" easy="false" id="ant39" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="24" _title="Tandem Chess" _xpath="enigma_vi/luc34_1" author="Lukas Sch?ller" ctrl="force" easy="false" id="luc342007" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="25" _title="Magic Trinity" _xpath="enigma_vi/duffy146_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy146" rel="1" rev="0" score="1" target="time" unit="duration"/>

Modified: branches/1.0/data/levels/enigma_experimental/puzzle_demo_2.xml
===================================================================
--- branches/1.0/data/levels/enigma_experimental/puzzle_demo_2.xml	2007-04-27 20:47:00 UTC (rev 699)
+++ branches/1.0/data/levels/enigma_experimental/puzzle_demo_2.xml	2007-04-27 21:14:27 UTC (rev 700)
@@ -3,12 +3,12 @@
   <el:protected>
     <el:info el:type="level">
       <el:identity el:title="Puzzle Demo" el:subtitle="Demolevel for libpuzzle" el:id="puzzle_demo"/>
-      <el:version el:score="2" el:release="2" el:revision="2" el:status="stable"/>
+      <el:version el:score="2" el:release="2" el:revision="3" el:status="stable"/>
       <el:author  el:name="Raoul Bourquin" el:email="" el:homepage=""/>
       <el:copyright>Copyright ? 2006, 2007 Raoul Bourquin</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
       <el:compatibility el:enigma="1.00">
-       <el:dependency el:path="lib/libpuzzle_2" el:id="lib/libpuzzle" el:release="2" el:preload="true"/>
+       <el:dependency el:path="lib/libpuzzle" el:id="lib/libpuzzle" el:release="2" el:preload="true"/>
       </el:compatibility>
       <el:modes el:easy="false" el:single="true" el:network="false"/>
       <el:comments>

Modified: branches/1.0/data/levels/enigma_experimental/puzzle_testarea_1.xml
===================================================================
--- branches/1.0/data/levels/enigma_experimental/puzzle_testarea_1.xml	2007-04-27 20:47:00 UTC (rev 699)
+++ branches/1.0/data/levels/enigma_experimental/puzzle_testarea_1.xml	2007-04-27 21:14:27 UTC (rev 700)
@@ -3,12 +3,12 @@
   <el:protected>
     <el:info el:type="level">
       <el:identity el:title="Puzzle Labor" el:subtitle="Testlevel to examine new puzzles" el:id="puzzle_testarea"/>
-      <el:version el:score="1" el:release="1" el:revision="1" el:status="stable"/>
+      <el:version el:score="1" el:release="1" el:revision="2" el:status="stable"/>
       <el:author  el:name="Raoul Bourquin" el:email="" el:homepage=""/>
       <el:copyright>Copyright ? 2005, 2007 Raoul Bourquin</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
       <el:compatibility el:enigma="1.00">
-       <el:dependency el:path="lib/libpuzzle_2" el:id="lib/libpuzzle" el:release="2" el:preload="true"/>
+       <el:dependency el:path="lib/libpuzzle" el:id="lib/libpuzzle" el:release="2" el:preload="true"/>
       </el:compatibility>
       <el:modes el:easy="false" el:single="true" el:network="false"/>
       <el:comments>

Modified: branches/1.0/data/levels/enigma_iii/index.xml
===================================================================
--- branches/1.0/data/levels/enigma_iii/index.xml	2007-04-27 20:47:00 UTC (rev 699)
+++ branches/1.0/data/levels/enigma_iii/index.xml	2007-04-27 21:14:27 UTC (rev 700)
@@ -62,7 +62,7 @@
     <level _seq="54" _title="White Contrast" _xpath="./illmind07_1" author="illmind" ctrl="force" easy="false" id="illmind07" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="55" _title="Laser Tricks" _xpath="./duffy84_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy84" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="56" _title="Space Fishing" _xpath="./martin73_1" author="Martin Hawlisch" ctrl="force" easy="false" id="martin73" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="57" _title="Manamana" _xpath="./just07_1" author="JuSt" ctrl="force" easy="false" id="just07" rel="1" rev="2" score="1" target="time" unit="duration"/>
+    <level _seq="57" _title="Manamana" _xpath="./just07_1" author="JuSt" ctrl="force" easy="false" id="just07" rel="1" rev="3" score="1" target="time" unit="duration"/>
     <level _seq="58" _title="Sacrifice" _xpath="./duffy49_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy49" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="59" _title="Double-Maze" _xpath="./duffy09_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy9" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="60" _title="Bad Flowers" _xpath="./nat30_1" author="Nat Pryce" ctrl="force" easy="true" id="nat30" rel="1" rev="0" score="1" target="time" unit="duration"/>

Modified: branches/1.0/data/levels/enigma_iii/just07_1.xml
===================================================================
--- branches/1.0/data/levels/enigma_iii/just07_1.xml	2007-04-27 20:47:00 UTC (rev 699)
+++ branches/1.0/data/levels/enigma_iii/just07_1.xml	2007-04-27 21:14:27 UTC (rev 700)
@@ -3,12 +3,12 @@
   <el:protected>
     <el:info el:type="level">
       <el:identity el:title="Manamana" el:subtitle="" el:id="just07"/>
-      <el:version el:score="1" el:release="1" el:revision="2" el:status="released"/>
+      <el:version el:score="1" el:release="1" el:revision="3" el:status="released"/>
       <el:author  el:name="JuSt" el:email="" el:homepage=""/>
       <el:copyright>Copyright ? 2005 JuSt</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
       <el:compatibility el:enigma="1.00">
-       <el:dependency el:path="lib/libpuzzle_2" el:id="lib/libpuzzle" el:release="2" el:preload="true"/>
+       <el:dependency el:path="lib/libpuzzle" el:id="lib/libpuzzle" el:release="2" el:preload="true"/>
       </el:compatibility>
       <el:modes el:easy="false" el:single="true" el:network="false"/>
       <el:comments>

Modified: branches/1.0/data/levels/enigma_oxyd/index.xml
===================================================================
--- branches/1.0/data/levels/enigma_oxyd/index.xml	2007-04-27 20:47:00 UTC (rev 699)
+++ branches/1.0/data/levels/enigma_oxyd/index.xml	2007-04-27 21:14:27 UTC (rev 700)
@@ -36,7 +36,7 @@
     <level _seq="28" _title="Moonwalking" _xpath="./oxyd52_1" author="Ulf Stegemann" ctrl="force" easy="false" id="20060629ulf006" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="29" _title="Scrooge" _xpath="./oxyd53_1" author="Siegfried Fennig" ctrl="force" easy="false" id="siegfried100" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="30" _title="Soaring High" _xpath="./oxyd54_1" author="Siegfried Fennig" ctrl="force" easy="false" id="siegfried101" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="31" _title="Oxyd 70" _xpath="./oxyd70_1" author="Raoul Bourquin" ctrl="force" easy="false" id="oxyd70" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="31" _title="Oxyd 70" _xpath="./oxyd70_1" author="Raoul Bourquin" ctrl="force" easy="false" id="oxyd70" rel="1" rev="2" score="1" target="time" unit="duration"/>
     <level _seq="32" _title="Oxyd 77" _xpath="./oxyd77_1" author="Raoul Bourquin" ctrl="force" easy="false" id="oxyd77" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="33" _title="Oxyd 79" _xpath="./oxyd79_1" author="Ulf Stegemann" ctrl="force" easy="false" id="20070103ulf015" rel="1" rev="68" score="1" target="time" unit="duration"/>
     <level _seq="34" _title="Oxyd 90" _xpath="./oxyd90_1" author="Raoul Bourquin" ctrl="force" easy="false" id="oxyd90" rel="1" rev="0" score="1" target="time" unit="duration"/>
@@ -51,12 +51,12 @@
     <level _seq="43" _title="OxydLink 23" _xpath="./oxydlink23_1" author="Siegfried Fennig" ctrl="force" easy="false" id="siegfried104" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="44" _title="Preferences" _xpath="./oxydlink28_1" author="Siegfried Fennig" ctrl="force" easy="false" id="level10d" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="45" _title="Letter Bomb" _xpath="./oxydlink31_1" author="Siegfried Fennig" ctrl="force" easy="false" id="oxydlink31" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="46" _title="Oxyd Link 33" _xpath="./oxydlink33_1" author="Raoul Bourquin" ctrl="force" easy="false" id="oxyd2p33" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="46" _title="Oxyd Link 33" _xpath="./oxydlink33_1" author="Raoul Bourquin" ctrl="force" easy="false" id="oxyd2p33" rel="1" rev="2" score="1" target="time" unit="duration"/>
     <level _seq="47" _title="Mirror III" _xpath="./oxydlink41_1" author="Siegfried Fennig" ctrl="force" easy="false" id="siegfried80" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="48" _title="My Way, Your Way" _xpath="./oxydlink46_1" author="Siegfried Fennig" ctrl="force" easy="false" id="level10e" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="49" _title="Center Court" _xpath="./oxydlink61_1" author="Siegfried Fennig" ctrl="force" easy="false" id="level11c" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="50" _title="Parcours" _xpath="./oxydlink65_1" author="Siegfried Fennig" ctrl="force" easy="false" id="level8a" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="51" _title="Oxyd Link 68" _xpath="./oxydlink68_1" author="Raoul Bourquin" ctrl="force" easy="false" id="oxyd2p68" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="51" _title="Oxyd Link 68" _xpath="./oxydlink68_1" author="Raoul Bourquin" ctrl="force" easy="false" id="oxyd2p68" rel="1" rev="2" score="1" target="time" unit="duration"/>
     <level _seq="52" _title="Slide Show" _xpath="./oxydlink72_1" author="Siegfried Fennig" ctrl="force" easy="false" id="level8c" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="53" _title="Oxyd Link 87" _xpath="./oxydlink87_1" author="Raoul Bourquin" ctrl="force" easy="false" id="oxyd2p87" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="54" _title="OxydLink 95" _xpath="./oxydlink95_1" author="Siegfried Fennig" ctrl="force" easy="false" id="siegfried103" rel="1" rev="0" score="1" target="time" unit="duration"/>

Modified: branches/1.0/data/levels/enigma_oxyd/oxyd70_1.xml
===================================================================
--- branches/1.0/data/levels/enigma_oxyd/oxyd70_1.xml	2007-04-27 20:47:00 UTC (rev 699)
+++ branches/1.0/data/levels/enigma_oxyd/oxyd70_1.xml	2007-04-27 21:14:27 UTC (rev 700)
@@ -3,12 +3,12 @@
   <el:protected>
     <el:info el:type="level">
       <el:identity el:title="Oxyd 70" el:subtitle="Oxyd 70" el:id="oxyd70"/>
-      <el:version el:score="1" el:release="1" el:revision="1" el:status="released"/>
+      <el:version el:score="1" el:release="1" el:revision="2" el:status="released"/>
       <el:author  el:name="Raoul Bourquin" el:email="" el:homepage=""/>
       <el:copyright>Copyright ? 2005 Raoul Bourquin</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
       <el:compatibility el:enigma="1.00" el:engine="oxyd1">
-       <el:dependency el:path="lib/libpuzzle_2" el:id="lib/libpuzzle" el:release="2" el:preload="true"/>
+       <el:dependency el:path="lib/libpuzzle" el:id="lib/libpuzzle" el:release="2" el:preload="true"/>
       </el:compatibility>
       <el:modes el:easy="false" el:single="true" el:network="false"/>
       <el:comments>

Modified: branches/1.0/data/levels/enigma_oxyd/oxydlink33_1.xml
===================================================================
--- branches/1.0/data/levels/enigma_oxyd/oxydlink33_1.xml	2007-04-27 20:47:00 UTC (rev 699)
+++ branches/1.0/data/levels/enigma_oxyd/oxydlink33_1.xml	2007-04-27 21:14:27 UTC (rev 700)
@@ -3,12 +3,12 @@
   <el:protected>
     <el:info el:type="level">
       <el:identity el:title="Oxyd Link 33" el:subtitle="Oxyd Link 33" el:id="oxyd2p33"/>
-      <el:version el:score="1" el:release="1" el:revision="1" el:status="released"/>
+      <el:version el:score="1" el:release="1" el:revision="2" el:status="released"/>
       <el:author  el:name="Raoul Bourquin" el:email="" el:homepage=""/>
       <el:copyright>Copyright ? 2005,2006 Raoul Bourquin</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
       <el:compatibility el:enigma="1.00" el:engine="oxyd1">
-       <el:dependency el:path="lib/libpuzzle_2" el:id="lib/libpuzzle" el:release="2" el:preload="true"/>
+       <el:dependency el:path="lib/libpuzzle" el:id="lib/libpuzzle" el:release="2" el:preload="true"/>
       </el:compatibility>
       <el:modes el:easy="false" el:single="true" el:network="true"/>
       <el:comments>

Modified: branches/1.0/data/levels/enigma_oxyd/oxydlink68_1.xml
===================================================================
--- branches/1.0/data/levels/enigma_oxyd/oxydlink68_1.xml	2007-04-27 20:47:00 UTC (rev 699)
+++ branches/1.0/data/levels/enigma_oxyd/oxydlink68_1.xml	2007-04-27 21:14:27 UTC (rev 700)
@@ -3,12 +3,12 @@
   <el:protected>
     <el:info el:type="level">
       <el:identity el:title="Oxyd Link 68" el:subtitle="Oxyd Link 68" el:id="oxyd2p68"/>
-      <el:version el:score="1" el:release="1" el:revision="1" el:status="released"/>
+      <el:version el:score="1" el:release="1" el:revision="2" el:status="released"/>
       <el:author  el:name="Raoul Bourquin" el:email="" el:homepage=""/>
       <el:copyright>Copyright ? 2006 Raoul Bourquin</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
       <el:compatibility el:enigma="1.00" el:engine="oxyd1">
-       <el:dependency el:path="lib/libpuzzle_2" el:id="lib/libpuzzle" el:release="2" el:preload="true"/>
+       <el:dependency el:path="lib/libpuzzle" el:id="lib/libpuzzle" el:release="2" el:preload="true"/>
       </el:compatibility>
       <el:modes el:easy="false" el:single="true" el:network="true"/>
       <el:comments>

Modified: branches/1.0/data/levels/enigma_peroxyd/index.xml
===================================================================
--- branches/1.0/data/levels/enigma_peroxyd/index.xml	2007-04-27 20:47:00 UTC (rev 699)
+++ branches/1.0/data/levels/enigma_peroxyd/index.xml	2007-04-27 21:14:27 UTC (rev 700)
@@ -36,7 +36,7 @@
     <level _seq="28" _title="Cliffhanger" _xpath="./peroxyd54_1" author="Siegfried Fennig" ctrl="force" easy="false" id="level10f" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="29" _title="Per.Oxyd 55" _xpath="./peroxyd55_2" author="Sven Siggelkow" ctrl="force" easy="false" id="ss_pox55" rel="2" rev="0" score="2" target="time" unit="duration"/>
     <level _seq="30" _title="Roadblock" _xpath="./peroxyd58_1" author="Siegfried Fennig" ctrl="force" easy="false" id="level7b" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="31" _title="Per.Oxyd 62" _xpath="./peroxyd62_1" author="Raoul Bourquin" ctrl="force" easy="false" id="peroxyd62" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="31" _title="Per.Oxyd 62" _xpath="./peroxyd62_1" author="Raoul Bourquin" ctrl="force" easy="false" id="peroxyd62" rel="1" rev="2" score="1" target="time" unit="duration"/>
     <level _seq="32" _title="Serious Patching" _xpath="./peroxyd73_1" author="Siegfried Fennig" ctrl="force" easy="false" id="level8f" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="33" _title="One Single Try" _xpath="./peroxyd75_1" author="Siegfried Fennig" ctrl="force" easy="false" id="siegfried78" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="34" _title="Plumbing" _xpath="./peroxyd79_1" author="Siegfried Fennig" ctrl="force" easy="false" id="level7e" rel="1" rev="0" score="1" target="time" unit="duration"/>
@@ -48,8 +48,8 @@
     <level _seq="40" _title="It Takes Two" _xpath="./peroxydlink01_1" author="Martin Hawlisch" ctrl="force" easy="false" id="martin43" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="41" _title="Oops, Sorry!" _xpath="./peroxydlink02_1" author="Siegfried Fennig" ctrl="force" easy="false" id="level7f" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="42" _title="Good Company" _xpath="./peroxydlink03_1" author="Siegfried Fennig" ctrl="force" easy="false" id="level10a" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="43" _title="Per.Oxyd Link 6" _xpath="./peroxydlink06_1" author="Raoul Bourquin" ctrl="force" easy="false" id="peroxyd2p6" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="44" _title="Per.Oxyd Link 13" _xpath="./peroxydlink13_1" author="Raoul Bourquin" ctrl="force" easy="false" id="peroxyd2p13" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="43" _title="Per.Oxyd Link 6" _xpath="./peroxydlink06_1" author="Raoul Bourquin" ctrl="force" easy="false" id="peroxyd2p6" rel="1" rev="2" score="1" target="time" unit="duration"/>
+    <level _seq="44" _title="Per.Oxyd Link 13" _xpath="./peroxydlink13_1" author="Raoul Bourquin" ctrl="force" easy="false" id="peroxyd2p13" rel="1" rev="2" score="1" target="time" unit="duration"/>
     <level _seq="45" _title="Monolith" _xpath="./peroxydlink22_1" author="Siegfried Fennig" ctrl="force" easy="false" id="level10c" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="46" _title="Let Me Out!" _xpath="./peroxydlink44_1" author="Siegfried Fennig" ctrl="force" easy="false" id="siegfried92" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="47" _title="Crisscross" _xpath="./peroxydlink45_1" author="Martin Hawlisch" ctrl="force" easy="false" id="martin62" rel="1" rev="0" score="1" target="time" unit="duration"/>

Modified: branches/1.0/data/levels/enigma_peroxyd/peroxyd62_1.xml
===================================================================
--- branches/1.0/data/levels/enigma_peroxyd/peroxyd62_1.xml	2007-04-27 20:47:00 UTC (rev 699)
+++ branches/1.0/data/levels/enigma_peroxyd/peroxyd62_1.xml	2007-04-27 21:14:27 UTC (rev 700)
@@ -3,12 +3,12 @@
   <el:protected>
     <el:info el:type="level">
       <el:identity el:title="Per.Oxyd 62" el:subtitle="Per.Oxyd 62" el:id="peroxyd62"/>
-      <el:version el:score="1" el:release="1" el:revision="1" el:status="released"/>
+      <el:version el:score="1" el:release="1" el:revision="2" el:status="released"/>
       <el:author  el:name="Raoul Bourquin" el:email="" el:homepage=""/>
       <el:copyright>Copyright ? 2005 Raoul Bourquin</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
       <el:compatibility el:enigma="1.00" el:engine="per.oxyd">
-       <el:dependency el:path="lib/libpuzzle_2" el:id="lib/libpuzzle" el:release="2" el:preload="true"/>
+       <el:dependency el:path="lib/libpuzzle" el:id="lib/libpuzzle" el:release="2" el:preload="true"/>
       </el:compatibility>
       <el:modes el:easy="false" el:single="true" el:network="false"/>
       <el:comments>

Modified: branches/1.0/data/levels/enigma_peroxyd/peroxydlink06_1.xml
===================================================================
--- branches/1.0/data/levels/enigma_peroxyd/peroxydlink06_1.xml	2007-04-27 20:47:00 UTC (rev 699)
+++ branches/1.0/data/levels/enigma_peroxyd/peroxydlink06_1.xml	2007-04-27 21:14:27 UTC (rev 700)
@@ -3,12 +3,12 @@
   <el:protected>
     <el:info el:type="level">
       <el:identity el:title="Per.Oxyd Link 6" el:subtitle="Per.Oxyd Link 6" el:id="peroxyd2p6"/>
-      <el:version el:score="1" el:release="1" el:revision="1" el:status="released"/>
+      <el:version el:score="1" el:release="1" el:revision="2" el:status="released"/>
       <el:author  el:name="Raoul Bourquin" el:email="" el:homepage=""/>
       <el:copyright>Copyright ? 2006 Raoul Bourquin</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
       <el:compatibility el:enigma="1.00" el:engine="per.oxyd">
-       <el:dependency el:path="lib/libpuzzle_2" el:id="lib/libpuzzle" el:release="2" el:preload="true"/>
+       <el:dependency el:path="lib/libpuzzle" el:id="lib/libpuzzle" el:release="2" el:preload="true"/>
       </el:compatibility>
       <el:modes el:easy="false" el:single="true" el:network="true"/>
       <el:comments>

Modified: branches/1.0/data/levels/enigma_peroxyd/peroxydlink13_1.xml
===================================================================
--- branches/1.0/data/levels/enigma_peroxyd/peroxydlink13_1.xml	2007-04-27 20:47:00 UTC (rev 699)
+++ branches/1.0/data/levels/enigma_peroxyd/peroxydlink13_1.xml	2007-04-27 21:14:27 UTC (rev 700)
@@ -3,12 +3,12 @@
   <el:protected>
     <el:info el:type="level">
       <el:identity el:title="Per.Oxyd Link 13" el:subtitle="Per.Oxyd Link 13" el:id="peroxyd2p13"/>
-      <el:version el:score="1" el:release="1" el:revision="1" el:status="released"/>
+      <el:version el:score="1" el:release="1" el:revision="2" el:status="released"/>
       <el:author  el:name="Raoul Bourquin" el:email="" el:homepage=""/>
       <el:copyright>Copyright ? 2006 Raoul Bourquin</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
       <el:compatibility el:enigma="0.92" el:engine="per.oxyd">
-       <el:dependency el:path="lib/libpuzzle_2" el:id="lib/libpuzzle" el:release="2" el:preload="true"/>
+       <el:dependency el:path="lib/libpuzzle" el:id="lib/libpuzzle" el:release="2" el:preload="true"/>
       </el:compatibility>
       <el:modes el:easy="false" el:single="true" el:network="true"/>
       <el:comments>

Modified: branches/1.0/data/levels/enigma_v/index.xml
===================================================================
--- branches/1.0/data/levels/enigma_v/index.xml	2007-04-27 20:47:00 UTC (rev 699)
+++ branches/1.0/data/levels/enigma_v/index.xml	2007-04-27 21:14:27 UTC (rev 700)
@@ -23,11 +23,11 @@
     <level _seq="15" _title="Solvable?" _xpath="./barry01_2" author="Barry &amp; Lori Mead" ctrl="force" easy="false" id="barry01" rel="2" rev="0" score="2" target="time" unit="duration"/>
     <level _seq="16" _title="Draggers" _xpath="./ant21_1" author="Petr Machata" ctrl="force" easy="false" id="ant21" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="17" _title="Break and Enter" _xpath="./siegfried16_1" author="Siegfried Fennig" ctrl="force" easy="false" id="level5b" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="18" _title="Double play" _xpath="./just06_1" author="JuSt" ctrl="force" easy="false" id="just06" rel="1" rev="1" score="1" target="time" unit="duration"/>
-    <level _seq="19" _title="Oxyd-Puzzle" _xpath="./raoul05_1" author="Raoul Bourquin" ctrl="force" easy="false" id="raoul05" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="18" _title="Double play" _xpath="./just06_1" author="JuSt" ctrl="force" easy="false" id="just06" rel="1" rev="2" score="1" target="time" unit="duration"/>
+    <level _seq="19" _title="Oxyd-Puzzle" _xpath="./raoul05_1" author="Raoul Bourquin" ctrl="force" easy="false" id="raoul05" rel="1" rev="2" score="1" target="time" unit="duration"/>
     <level _seq="20" _title="- Meditation -" _xpath="./ralf12_1" author="Ralf Westram" ctrl="force" easy="true" id="ralf12" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="21" _title="Plan Ahead" _xpath="./duffy114_2" author="Jacob Scott" ctrl="force" easy="true" id="duffy114" rel="2" rev="2" score="2" target="time" unit="duration"/>
-    <level _seq="22" _title="Keystone" _xpath="./raoul12_1" author="Raoul Bourquin" ctrl="force" easy="true" id="raoul12" rel="1" rev="2" score="1" target="time" unit="duration"/>
+    <level _seq="22" _title="Keystone" _xpath="./raoul12_1" author="Raoul Bourquin" ctrl="force" easy="true" id="raoul12" rel="1" rev="3" score="1" target="time" unit="duration"/>
     <level _seq="23" _title="Print 23" _xpath="./richi07_1" author="Richi B?tzer" ctrl="force" easy="false" id="richi07" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="24" _title="Space Pirates" _xpath="./siegfried19_2" author="Siegfried Fennig" ctrl="force" easy="false" id="level6a" rel="2" rev="0" score="2" target="time" unit="duration"/>
     <level _seq="25" _title="Laser Crossing" _xpath="./luc24_1" author="Lukas Sch?ller" ctrl="force" easy="true" id="luc24" rel="1" rev="0" score="1" target="time" unit="duration"/>
@@ -82,7 +82,7 @@
     <level _seq="74" _title="Fatal Attraction II" _xpath="./spaceman02_1" author="Spaceman" ctrl="force" easy="false" id="spaceman2" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="75" _title="Stranded" _xpath="./duffy51_2" author="Jacob Scott" ctrl="force" easy="false" id="duffy51" rel="2" rev="3" score="2" target="time" unit="duration"/>
     <level _seq="76" _title="Fatal Attraction III" _xpath="./spaceman03_1" author="Spaceman" ctrl="force" easy="false" id="spaceman3" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="77" _title="Doors forever" _xpath="./just03_1" author="JuSt" ctrl="force" easy="true" id="just03" rel="1" rev="2" score="1" target="time" unit="duration"/>
+    <level _seq="77" _title="Doors forever" _xpath="./just03_1" author="JuSt" ctrl="force" easy="true" id="just03" rel="1" rev="3" score="1" target="time" unit="duration"/>
     <level _seq="78" _title="Don't Be Greedy" _xpath="./duffy71_2" author="Jacob Scott" ctrl="force" easy="false" id="duffy71" rel="2" rev="0" score="2" target="time" unit="duration"/>
     <level _seq="79" _title="Help Yourself" _xpath="./duffy113_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy113" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="80" _title="Catwalk Meditation" _xpath="./ral05_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20060505ral007" rel="1" rev="42" score="1" target="time" unit="duration"/>
@@ -104,7 +104,7 @@
     <level _seq="96" _title="The Chamber" _xpath="./luc31_2" author="Lukas Sch?ller" ctrl="force" easy="false" id="luc31" rel="2" rev="1" score="2" target="time" unit="duration"/>
     <level _seq="97" _title="Automaton" _xpath="./duffy95_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy95" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="98" _title="Caterpillar" _xpath="./nat15_1" author="Nat Pryce" ctrl="force" easy="false" id="nat15" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="99" _title="Spacestation" _xpath="./raoul23_1" author="Raoul Bourquin" ctrl="force" easy="true" id="raoul23" rel="1" rev="2" score="1" target="time" unit="duration"/>
+    <level _seq="99" _title="Spacestation" _xpath="./raoul23_1" author="Raoul Bourquin" ctrl="force" easy="true" id="raoul23" rel="1" rev="3" score="1" target="time" unit="duration"/>
     <level _seq="100" _title="Island Labyrinth" _xpath="./duffy129_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy129" rel="1" rev="0" score="1" target="time" unit="duration"/>
   </levels>
 

Modified: branches/1.0/data/levels/enigma_v/just03_1.xml
===================================================================
--- branches/1.0/data/levels/enigma_v/just03_1.xml	2007-04-27 20:47:00 UTC (rev 699)
+++ branches/1.0/data/levels/enigma_v/just03_1.xml	2007-04-27 21:14:27 UTC (rev 700)
@@ -3,12 +3,12 @@
   <el:protected>
     <el:info el:type="level">
       <el:identity el:title="Doors forever" el:subtitle="" el:id="just03"/>
-      <el:version el:score="1" el:release="1" el:revision="2" el:status="released"/>
+      <el:version el:score="1" el:release="1" el:revision="3" el:status="released"/>
       <el:author  el:name="JuSt" el:email="" el:homepage=""/>
       <el:copyright>Copyright ? 2005 JuSt</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
       <el:compatibility el:enigma="1.00">
-       <el:dependency el:path="lib/libpuzzle_2" el:id="lib/libpuzzle" el:release="2" el:preload="true"/>
+       <el:dependency el:path="lib/libpuzzle" el:id="lib/libpuzzle" el:release="2" el:preload="true"/>
       </el:compatibility>
       <el:modes el:easy="true" el:single="true" el:network="false"/>
       <el:comments>

Modified: branches/1.0/data/levels/enigma_v/just06_1.xml
===================================================================
--- branches/1.0/data/levels/enigma_v/just06_1.xml	2007-04-27 20:47:00 UTC (rev 699)
+++ branches/1.0/data/levels/enigma_v/just06_1.xml	2007-04-27 21:14:27 UTC (rev 700)
@@ -3,13 +3,13 @@
   <el:protected>
     <el:info el:type="level">
       <el:identity el:title="Double play" el:subtitle="" el:id="just06"/>
-      <el:version el:score="1" el:release="1" el:revision="1" el:status="released"/>
+      <el:version el:score="1" el:release="1" el:revision="2" el:status="released"/>
       <el:author  el:name="JuSt" el:email="" el:homepage=""/>
       <el:copyright>Copyright ? 2005 JuSt</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
       <el:compatibility el:enigma="0.92">
        <el:dependency el:path="lib/ant" el:id="lib/ant" el:release="1" el:preload="true"/>
-       <el:dependency el:path="lib/libpuzzle_2" el:id="lib/libpuzzle" el:release="2" el:preload="true"/>
+       <el:dependency el:path="lib/libpuzzle" el:id="lib/libpuzzle" el:release="2" el:preload="true"/>
       </el:compatibility>
       <el:modes el:easy="false" el:single="true" el:network="false"/>
       <el:comments>

Modified: branches/1.0/data/levels/enigma_v/raoul05_1.xml
===================================================================
--- branches/1.0/data/levels/enigma_v/raoul05_1.xml	2007-04-27 20:47:00 UTC (rev 699)
+++ branches/1.0/data/levels/enigma_v/raoul05_1.xml	2007-04-27 21:14:27 UTC (rev 700)
@@ -3,12 +3,12 @@
   <el:protected>
     <el:info el:type="level">
       <el:identity el:title="Oxyd-Puzzle" el:subtitle="" el:id="raoul05"/>
-      <el:version el:score="1" el:release="1" el:revision="1" el:status="released"/>
+      <el:version el:score="1" el:release="1" el:revision="2" el:status="released"/>
       <el:author  el:name="Raoul Bourquin" el:email="raoul at users.berlios.de" el:homepage=""/>
       <el:copyright>Copyright ? 2005,2006 Raoul Bourquin</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
       <el:compatibility el:enigma="0.92">
-       <el:dependency el:path="lib/libpuzzle_2" el:id="lib/libpuzzle" el:release="2" el:preload="true"/>
+       <el:dependency el:path="lib/libpuzzle" el:id="lib/libpuzzle" el:release="2" el:preload="true"/>
       </el:compatibility>
       <el:modes el:easy="false" el:single="true" el:network="false"/>
       <el:comments>

Modified: branches/1.0/data/levels/enigma_v/raoul12_1.xml
===================================================================
--- branches/1.0/data/levels/enigma_v/raoul12_1.xml	2007-04-27 20:47:00 UTC (rev 699)
+++ branches/1.0/data/levels/enigma_v/raoul12_1.xml	2007-04-27 21:14:27 UTC (rev 700)
@@ -3,12 +3,12 @@
   <el:protected>
     <el:info el:type="level">
       <el:identity el:title="Keystone" el:subtitle="" el:id="raoul12"/>
-      <el:version el:score="1" el:release="1" el:revision="2" el:status="released"/>
+      <el:version el:score="1" el:release="1" el:revision="3" el:status="released"/>
       <el:author  el:name="Raoul Bourquin" el:email="raoul at users.berlios.de" el:homepage=""/>
       <el:copyright>Copyright ? 2006 Raoul Bourquin</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
       <el:compatibility el:enigma="0.92">
-       <el:dependency el:path="lib/libpuzzle_2" el:id="lib/libpuzzle" el:release="2" el:preload="true"/>
+       <el:dependency el:path="lib/libpuzzle" el:id="lib/libpuzzle" el:release="2" el:preload="true"/>
       </el:compatibility>
       <el:modes el:easy="true" el:single="true" el:network="false"/>
       <el:comments>

Modified: branches/1.0/data/levels/enigma_v/raoul23_1.xml
===================================================================
--- branches/1.0/data/levels/enigma_v/raoul23_1.xml	2007-04-27 20:47:00 UTC (rev 699)
+++ branches/1.0/data/levels/enigma_v/raoul23_1.xml	2007-04-27 21:14:27 UTC (rev 700)
@@ -3,13 +3,13 @@
   <el:protected>
     <el:info el:type="level">
       <el:identity el:title="Spacestation" el:subtitle="" el:id="raoul23"/>
-      <el:version el:score="1" el:release="1" el:revision="2" el:status="released"/>
+      <el:version el:score="1" el:release="1" el:revision="3" el:status="released"/>
       <el:author  el:name="Raoul Bourquin" el:email="raoul at users.berlios.de" el:homepage=""/>
       <el:copyright>Copyright ? 2006 Raoul Bourquin</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
       <el:compatibility el:enigma="1.0">
        <el:dependency el:path="lib/ant" el:id="lib/ant" el:release="1" el:preload="true"/>
-       <el:dependency el:path="lib/libpuzzle_2" el:id="lib/libpuzzle" el:release="2" el:preload="true"/>
+       <el:dependency el:path="lib/libpuzzle" el:id="lib/libpuzzle" el:release="2" el:preload="true"/>
       </el:compatibility>
       <el:modes el:easy="true" el:single="true" el:network="true"/>
       <el:score el:easy="-" el:difficult="7:29"/>

Modified: branches/1.0/data/levels/enigma_vi/index.xml
===================================================================
--- branches/1.0/data/levels/enigma_vi/index.xml	2007-04-27 20:47:00 UTC (rev 699)
+++ branches/1.0/data/levels/enigma_vi/index.xml	2007-04-27 21:14:27 UTC (rev 700)
@@ -30,7 +30,7 @@
     <level _seq="22" _title="Edwards Second Level" _xpath="./edward02_1" author="Edward" ctrl="force" easy="false" id="edward02" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="23" _title="Prepare Your Defense" _xpath="./duffy132_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy132" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="24" _title="The Stable" _xpath="./andreas30_1" author="Andreas Lochmann" ctrl="force" easy="false" id="andreas30" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="25" _title="Oxydrings" _xpath="./raoul13_1" author="Raoul Bourquin" ctrl="force" easy="false" id="raoul13" rel="1" rev="1" score="1" target="time" unit="duration"/>
+    <level _seq="25" _title="Oxydrings" _xpath="./raoul13_1" author="Raoul Bourquin" ctrl="force" easy="false" id="raoul13" rel="1" rev="2" score="1" target="time" unit="duration"/>
     <level _seq="26" _title="Dialers" _xpath="./edward05_1" author="Edward" ctrl="force" easy="true" id="edward05" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="27" _title="Persecution Mania" _xpath="./ral12_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20060911ral294" rel="1" rev="58" score="1" target="time" unit="duration"/>
     <level _seq="28" _title="Holes!" _xpath="./edward14_1" author="Edward" ctrl="force" easy="false" id="edward14" rel="1" rev="1" score="1" target="time" unit="duration"/>
@@ -65,7 +65,7 @@
     <level _seq="57" _title="- Meditation -" _xpath="./raoul18_1" author="Raoul Bourquin" ctrl="force" easy="true" id="raoul18" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="58" _title="Pool with a pole" _xpath="./alain28_1" author="Alain Busser" ctrl="force" easy="false" id="alain28" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="59" _title="- Meditation -" _xpath="./edward30_1" author="Edward" ctrl="force" easy="true" id="edward30" rel="1" rev="2" score="1" target="time" unit="duration"/>
-    <level _seq="60" _title="Puzzle Puzzles" _xpath="./raoul26_1" author="Raoul Bourquin" ctrl="force" easy="true" id="raoul26" rel="1" rev="24" score="1" target="time" unit="duration"/>
+    <level _seq="60" _title="Puzzle Puzzles" _xpath="./raoul26_1" author="Raoul Bourquin" ctrl="force" easy="true" id="raoul26" rel="1" rev="25" score="1" target="time" unit="duration"/>
     <level _seq="61" _title="Tarzan" _xpath="./ulf03_1" author="Ulf Stegemann" ctrl="force" easy="true" id="20060629ulf003" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="62" _title="Houdini" _xpath="./ral11_2" author="Ronald Lamprecht" ctrl="force" easy="true" id="20060816ral719" rel="2" rev="58" score="2" target="time" unit="duration"/>
     <level _seq="63" _title="Walk the line" _xpath="./erich02_1" author="Erich Schubert" ctrl="force" easy="true" id="erich02" rel="1" rev="0" score="1" target="time" unit="duration"/>
@@ -79,7 +79,7 @@
     <level _seq="71" _title="Counterclockwise" _xpath="./ulf05_1" author="Ulf Stegemann" ctrl="force" easy="true" id="20070126ulf020" rel="1" rev="93" score="1" target="time" unit="duration"/>
     <level _seq="72" _title="Check the light" _xpath="./just10_1" author="JuSt" ctrl="force" easy="false" id="just10" rel="1" rev="4" score="1" target="time" unit="duration"/>
     <level _seq="73" _title="Twokoban I" _xpath="./raoul28_1" author="Raoul Bourquin" ctrl="force" easy="true" id="raoul28" rel="1" rev="0" score="1" target="time" unit="duration"/>
-    <level _seq="74" _title="The passage" _xpath="./just11_1" author="JuSt" ctrl="force" easy="false" id="just11" rel="1" rev="5" score="1" target="time" unit="duration"/>
+    <level _seq="74" _title="The passage" _xpath="./just11_1" author="JuSt" ctrl="force" easy="false" id="just11" rel="1" rev="6" score="1" target="time" unit="duration"/>
     <level _seq="75" _title="Magic triangle" _xpath="./just13_1" author="JuSt" ctrl="force" easy="false" id="just13" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="76" _title="Revolver" _xpath="./ral16_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20070214ral703" rel="1" rev="59" score="1" target="time" unit="duration"/>
     <level _seq="77" _title="Devil's bolder" _xpath="./just14_1" author="JuSt" ctrl="force" easy="true" id="just14" rel="1" rev="2" score="1" target="time" unit="duration"/>
@@ -89,7 +89,7 @@
     <level _seq="81" _title="The wrong place?" _xpath="./just17_1" author="JuSt" ctrl="force" easy="false" id="just17" rel="1" rev="1" score="1" target="time" unit="duration"/>
     <level _seq="82" _title="Cold Meditation" _xpath="./ral18_1" author="Ronald Lamprecht" ctrl="force" easy="true" id="20070314ral728" rel="1" rev="67" score="1" target="time" unit="duration"/>
     <level _seq="83" _title="Same task ..." _xpath="./raoul29_1" author="Raoul Bourquin" ctrl="force" easy="true" id="raoul29" rel="1" rev="2" score="1" target="time" unit="duration"/>
-    <level _seq="84" _title="Industrial puzzles" _xpath="./raoul30_1" author="Raoul Bourquin" ctrl="force" easy="false" id="raoul30" rel="1" rev="3" score="1" target="time" unit="duration"/>
+    <level _seq="84" _title="Industrial puzzles" _xpath="./raoul30_1" author="Raoul Bourquin" ctrl="force" easy="false" id="raoul30" rel="1" rev="4" score="1" target="time" unit="duration"/>
     <level _seq="85" _title="Odyssey" _xpath="./ant39_1" author="Petr Machata" ctrl="force" easy="false" id="ant39" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="86" _title="Magic Trinity" _xpath="./duffy146_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy146" rel="1" rev="0" score="1" target="time" unit="duration"/>
     <level _seq="87" _title="Rotor Guards" _xpath="./duffy144_1" author="Jacob Scott" ctrl="force" easy="false" id="duffy144" rel="1" rev="0" score="1" target="time" unit="duration"/>

Modified: branches/1.0/data/levels/enigma_vi/just11_1.xml
===================================================================
--- branches/1.0/data/levels/enigma_vi/just11_1.xml	2007-04-27 20:47:00 UTC (rev 699)
+++ branches/1.0/data/levels/enigma_vi/just11_1.xml	2007-04-27 21:14:27 UTC (rev 700)
@@ -3,12 +3,12 @@
   <el:protected>
     <el:info el:type="level">
       <el:identity el:title="The passage" el:subtitle="" el:id="just11"/>
-      <el:version el:score="1" el:release="1" el:revision="5" el:status="released"/>
+      <el:version el:score="1" el:release="1" el:revision="6" el:status="released"/>
       <el:author  el:name="JuSt" el:email="" el:homepage=""/>
       <el:copyright>Copyright ? 2007 JuSt</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
       <el:compatibility el:enigma="1.00">
-       <el:dependency el:path="lib/libpuzzle_2" el:id="lib/libpuzzle" el:release="2" el:preload="true"/>
+       <el:dependency el:path="lib/libpuzzle" el:id="lib/libpuzzle" el:release="2" el:preload="true"/>
       </el:compatibility>
       <el:modes el:easy="false" el:single="true" el:network="false"/>
       <el:score el:easy="-" el:difficult="4:24"/>

Modified: branches/1.0/data/levels/enigma_vi/raoul13_1.xml
===================================================================
--- branches/1.0/data/levels/enigma_vi/raoul13_1.xml	2007-04-27 20:47:00 UTC (rev 699)
+++ branches/1.0/data/levels/enigma_vi/raoul13_1.xml	2007-04-27 21:14:27 UTC (rev 700)
@@ -3,12 +3,12 @@
   <el:protected>
     <el:info el:type="level">
       <el:identity el:title="Oxydrings" el:subtitle="" el:id="raoul13"/>
-      <el:version el:score="1" el:release="1" el:revision="1" el:status="released"/>
+      <el:version el:score="1" el:release="1" el:revision="2" el:status="released"/>
       <el:author  el:name="Raoul Bourquin" el:email="raoul at users.berlios.de" el:homepage=""/>
       <el:copyright>Copyright ? 2006 Raoul Bourquin</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
       <el:compatibility el:enigma="0.92">
-       <el:dependency el:path="lib/libpuzzle_2" el:id="lib/libpuzzle" el:release="2" el:preload="true"/>
+       <el:dependency el:path="lib/libpuzzle" el:id="lib/libpuzzle" el:release="2" el:preload="true"/>
       </el:compatibility>
       <el:modes el:easy="false" el:single="true" el:network="false"/>
       <el:comments>

Modified: branches/1.0/data/levels/enigma_vi/raoul26_1.xml
===================================================================
--- branches/1.0/data/levels/enigma_vi/raoul26_1.xml	2007-04-27 20:47:00 UTC (rev 699)
+++ branches/1.0/data/levels/enigma_vi/raoul26_1.xml	2007-04-27 21:14:27 UTC (rev 700)
@@ -3,12 +3,12 @@
   <el:protected>
     <el:info el:type="level">
       <el:identity el:title="Puzzle Puzzles" el:subtitle="look forward!" el:id="raoul26"/>
-      <el:version el:score="1" el:release="1" el:revision="24" el:status="released"/>
+      <el:version el:score="1" el:release="1" el:revision="25" el:status="released"/>
       <el:author  el:name="Raoul Bourquin" el:email="" el:homepage=""/>
       <el:copyright>Copyright ? 2006 Raoul Bourquin</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
       <el:compatibility el:enigma="1.0">
-       <el:dependency el:path="lib/libpuzzle_2" el:id="lib/libpuzzle" el:release="2" el:preload="true"/>
+       <el:dependency el:path="lib/libpuzzle" el:id="lib/libpuzzle" el:release="2" el:preload="true"/>
       </el:compatibility>
       <el:modes el:easy="true" el:single="true" el:network="false"/>
       <el:comments>

Modified: branches/1.0/data/levels/enigma_vi/raoul30_1.xml
===================================================================
--- branches/1.0/data/levels/enigma_vi/raoul30_1.xml	2007-04-27 20:47:00 UTC (rev 699)
+++ branches/1.0/data/levels/enigma_vi/raoul30_1.xml	2007-04-27 21:14:27 UTC (rev 700)
@@ -3,12 +3,12 @@
   <el:protected>
     <el:info el:type="level">
       <el:identity el:title="Industrial puzzles" el:subtitle="" el:id="raoul30"/>
-      <el:version el:score="1" el:release="1" el:revision="3" el:status="released"/>
+      <el:version el:score="1" el:release="1" el:revision="4" el:status="released"/>
       <el:author  el:name="Raoul Bourquin" el:email="" el:homepage=""/>
       <el:copyright>Copyright ? 2007 Raoul Bourquin</el:copyright>
       <el:license el:type="GPL v2.0 or above" el:open="true"/>
       <el:compatibility el:enigma="1.00">
-       <el:dependency el:path="lib/libpuzzle_2" el:id="lib/libpuzzle" el:release="2" el:preload="true"/>
+       <el:dependency el:path="lib/libpuzzle" el:id="lib/libpuzzle" el:release="2" el:preload="true"/>
       </el:compatibility>
       <el:modes el:easy="false" el:single="true" el:network="false"/>
       <el:score el:easy="-" el:difficult="4:54"/>



From andreasl at mail.berlios.de  Sat Apr 28 00:57:33 2007
From: andreasl at mail.berlios.de (andreasl at BerliOS)
Date: Sat, 28 Apr 2007 00:57:33 +0200
Subject: [Enigma-game-svn] r701 - branches/1.0/data
Message-ID: <200704272257.l3RMvXaj029533@sheep.berlios.de>

Author: andreasl
Date: 2007-04-28 00:57:32 +0200 (Sat, 28 Apr 2007)
New Revision: 701

Modified:
   branches/1.0/data/Makefile.am
Log:
Fixing rev.693 ("Sound event rework, part II")
 - added sound-defaults.lua to Makefile


Modified: branches/1.0/data/Makefile.am
===================================================================
--- branches/1.0/data/Makefile.am	2007-04-27 21:14:27 UTC (rev 700)
+++ branches/1.0/data/Makefile.am	2007-04-27 22:57:32 UTC (rev 701)
@@ -11,6 +11,7 @@
 	models-48.lua \
 	init.lua \
 	startup.lua \
+	sound-defaults.lua \
 	compat.lua \
 	security.lua \
 	ratings.xml



From andreasl at mail.berlios.de  Sun Apr 29 13:58:22 2007
From: andreasl at mail.berlios.de (andreasl at BerliOS)
Date: Sun, 29 Apr 2007 13:58:22 +0200
Subject: [Enigma-game-svn] r702 - branches/1.0/src
Message-ID: <200704291158.l3TBwMN3018379@sheep.berlios.de>

Author: andreasl
Date: 2007-04-29 13:58:22 +0200 (Sun, 29 Apr 2007)
New Revision: 702

Modified:
   branches/1.0/src/sound.cc
   branches/1.0/src/sound_internal.hh
Log:
Workaround to fix "silent F3 bug":
 - Coalesce sounds only when their positions are at most
   in 30 grids distance.
(Explanation: When pressing F3 in levels with two actors at
large distances, sometimes you can't hear the shatter. This
is due to the missing volume-readjustment during coalescing.
This workaround here is only temporary until the volume can
be readjusted or coalescing is removed in favour of a priority
system.)


Modified: branches/1.0/src/sound.cc
===================================================================
--- branches/1.0/src/sound.cc	2007-04-27 22:57:32 UTC (rev 701)
+++ branches/1.0/src/sound.cc	2007-04-29 11:58:22 UTC (rev 702)
@@ -242,12 +242,14 @@
     Mix_Volume(channel, ecl::Clamp(mixvol, 0, MIX_MAX_VOLUME));
 }
 
-int SoundEngine_SDL::already_playing (const SoundName &name)
+int SoundEngine_SDL::already_playing (const SoundEvent &s)
 {
     for (size_t i=0; i<m_channelinfo.size(); ++i) {
         const SoundEvent &se = m_channelinfo[i];
 
-        if (se.active && se.name == name && se.playing_time < 0.05)
+        if (se.active && se.name == s.name && se.playing_time < 0.05
+            && (!se.has_position || !s.has_position ||
+		ecl::length(se.position - s.position) < 30))
             return static_cast<int> (i);
     }
     return -1;
@@ -274,7 +276,7 @@
 
 bool SoundEngine_SDL::play_sound (const SoundEvent &s)
 {
-    int channel = already_playing (s.name);
+    int channel = already_playing (s);
     if (channel != -1) {
         MutexLock (m_instance->m_mutex);
         SoundEvent &se = m_channelinfo [channel];

Modified: branches/1.0/src/sound_internal.hh
===================================================================
--- branches/1.0/src/sound_internal.hh	2007-04-27 22:57:32 UTC (rev 701)
+++ branches/1.0/src/sound_internal.hh	2007-04-29 11:58:22 UTC (rev 702)
@@ -217,7 +217,7 @@
         Mix_Chunk *cache_sound(const std::string &name);
 
         void update_channel (int channel);
-        int already_playing (const SoundName &name);
+        int already_playing (const SoundEvent &s);
 
 
         static void channel_finished (int channel);



From ral at mail.berlios.de  Sun Apr 29 15:12:30 2007
From: ral at mail.berlios.de (ral at BerliOS)
Date: Sun, 29 Apr 2007 15:12:30 +0200
Subject: [Enigma-game-svn] r703 - in branches/1.0: lib-src/enigma-core
	src/lev
Message-ID: <200704291312.l3TDCUNL023702@sheep.berlios.de>

Author: ral
Date: 2007-04-29 15:12:28 +0200 (Sun, 29 Apr 2007)
New Revision: 703

Modified:
   branches/1.0/lib-src/enigma-core/ecl_system.hh
   branches/1.0/lib-src/enigma-core/ecl_system_unix.cc
   branches/1.0/src/lev/Index.cc
   branches/1.0/src/lev/PersistentIndex.cc
   branches/1.0/src/lev/PersistentIndex.hh
Log:
Branch 1.0: 
- fix double LP menu entry on same pack on system and user path
- fix double LP menu entry on Windows on "Pack\"+"pack.zip" like cases
- evaluate index compatibility, release and revision: allow updates of
  system LPs on user data path.


Modified: branches/1.0/lib-src/enigma-core/ecl_system.hh
===================================================================
--- branches/1.0/lib-src/enigma-core/ecl_system.hh	2007-04-29 11:58:22 UTC (rev 702)
+++ branches/1.0/lib-src/enigma-core/ecl_system.hh	2007-04-29 13:12:28 UTC (rev 703)
@@ -21,6 +21,7 @@
 
 #include <string>
 #include <ctime>
+#include <set>
 
 namespace ecl
 {
@@ -38,6 +39,8 @@
 
 #ifdef __MINGW32__
     std::string ApplicationDataPath();
+    void ToLowerCase(std::string &filename);
+    std::set<std::string> UniqueFilenameSet(std::set<std::string> inSet);
 #endif
 
 /* -------------------- Locales -------------------- */

Modified: branches/1.0/lib-src/enigma-core/ecl_system_unix.cc
===================================================================
--- branches/1.0/lib-src/enigma-core/ecl_system_unix.cc	2007-04-29 11:58:22 UTC (rev 702)
+++ branches/1.0/lib-src/enigma-core/ecl_system_unix.cc	2007-04-29 13:12:28 UTC (rev 703)
@@ -142,6 +142,29 @@
     return result;
 }
 
+void ecl::ToLowerCase(std::string &filename) {
+    for (int i = 0; i < filename.length(); i++) {
+	char c = filename[i];
+	if (c >= 'A' && c <= 'Z')
+	    filename.replace(i, 1, 1, c - 'A' + 'a');
+    }
+}
+
+std::set<std::string> ecl::UniqueFilenameSet(std::set<std::string> inSet) {
+    std::set<std::string>::iterator it = inSet.begin();
+    std::set<std::string> outSet;
+    std::set<std::string> lowerSet;
+    for (; it != inSet.end(); it++) {
+	std::string name = *it;
+	ecl::ToLowerCase(name);
+	if (lowerSet.find(name) == lowerSet.end()) {
+	    outSet.insert(*it);
+	    lowerSet.insert(name);
+	}
+    }
+    return outSet;
+}
+
 #endif
 
 

Modified: branches/1.0/src/lev/Index.cc
===================================================================
--- branches/1.0/src/lev/Index.cc	2007-04-29 11:58:22 UTC (rev 702)
+++ branches/1.0/src/lev/Index.cc	2007-04-29 13:12:28 UTC (rev 703)
@@ -52,7 +52,8 @@
             return;
         
         // check for uniqueness of index name
-        
+	if (findIndex(anIndex->getName()) != NULL)
+	    return;
             
         indices.insert(std::make_pair(anIndex->getName(), anIndex));
         
@@ -111,6 +112,7 @@
             for (itg = indexGroups.begin(); itg != indexGroups.end(); itg++)
                 addIndexToGroup(anIndex, (*itg).second);
         }
+	return;
     }
     
     void Index::addIndexToGroup(Index *anIndex, std::vector<Index *> * aGroup) {

Modified: branches/1.0/src/lev/PersistentIndex.cc
===================================================================
--- branches/1.0/src/lev/PersistentIndex.cc	2007-04-29 11:58:22 UTC (rev 702)
+++ branches/1.0/src/lev/PersistentIndex.cc	2007-04-29 13:12:28 UTC (rev 703)
@@ -63,7 +63,32 @@
     }
     
     PersistentIndex * PersistentIndex::historyIndex = NULL;
+    std::vector<PersistentIndex *> PersistentIndex::indexCandidates;
     
+    void PersistentIndex::checkCandidate(PersistentIndex * candidate) {
+	if (candidate->getName().empty() ||
+		candidate->getCompatibility() > ENIGMACOMPATIBITLITY) {
+	    delete candidate;
+	} else {
+	    // check if new Index is an update of another
+	    for (int i = 0; i < indexCandidates.size(); i++) {
+		if (indexCandidates[i]->getName() != candidate->getName()) {
+		    continue;
+		} else if (indexCandidates[i]->getRelease() != candidate->getRelease() ||
+			indexCandidates[i]->getRevision() >= candidate->getRevision()) {
+		    delete candidate;
+		    return;
+		} else {
+		    // it is an update
+		    delete indexCandidates[i];
+		    indexCandidates[i] = candidate;
+		    return;
+		}
+	    }
+	    indexCandidates.push_back(candidate);
+	}
+    }
+    
     void PersistentIndex::registerPersistentIndices(bool onlySystemIndices) {
         DirIter * dirIter;
         DirEntry dirEntry;
@@ -72,7 +97,6 @@
         std::vector<std::string> sysPaths = app.systemFS->getPaths();
         std::set<std::string> candidates;
         std::set<std::string> candidates2;
-        std::set<std::string> registered;
         for (int i = 0; i < sysPaths.size(); i++) {
             dirIter = DirIter::instance(sysPaths[i] + "/levels");
             while (dirIter->get_next(dirEntry)) {
@@ -92,15 +116,13 @@
 
         for (std::set<std::string>::iterator i = candidates.begin(); 
                 i != candidates.end(); i++) {
-//            Log << "PersistentIndexCandidate1 " << *i <<"\n";
-            PersistentIndex * anIndex = new PersistentIndex(*i, true);
+            // register the index just on the system path even if the
+	    // user has an update on his path. We need to know the release to
+	    // decide if a user copy is an update
+	    PersistentIndex * anIndex = new PersistentIndex(*i, true);
             anIndex->isUserOwned = false;
-            if (!(anIndex->getName().empty())) {
-                Index::registerIndex(anIndex);
-                registered.insert(*i);
-            } else {
-                delete anIndex;
-            }
+	    Log << "precheck: " << *i << "\n";
+	    checkCandidate(anIndex);
         }
 
         //add system cross indices
@@ -109,16 +131,10 @@
             while (dirIter->get_next(dirEntry)) {
                 if (!dirEntry.is_dir && dirEntry.name.size() > 4 && 
                         (dirEntry.name.rfind(".xml") == dirEntry.name.size() - 4)) {
-//                    Log << "PersistentIndexCandidate scorss " << dirEntry.name <<"\n";
                     PersistentIndex * anIndex = new PersistentIndex("enigma_cross", true,
                             INDEX_DEFAULT_PACK_LOCATION, "", dirEntry.name);
                     anIndex->isUserOwned = false;
-                    if (!(anIndex->getName().empty()) && 
-                            Index::findIndex(anIndex->getName()) == NULL) {
-                        Index::registerIndex(anIndex);
-                    } else {
-                        delete anIndex;
-                    }
+		    checkCandidate(anIndex);
                 }
             }
         }
@@ -134,13 +150,11 @@
                     dirEntry.name != ".svn" && dirEntry.name != "auto" &&
                     dirEntry.name != "cross" && dirEntry.name != "enigma_cross" && 
                     dirEntry.name != "legacy_dat") {
-                if (registered.find(dirEntry.name) == registered.end())
                     candidates2.insert(dirEntry.name);
             }
             else {
                 std::string::size_type zipPos = dirEntry.name.rfind(".zip");
                 if (zipPos != std::string::npos && zipPos == dirEntry.name.size() - 4) {
-                    if (registered.find(dirEntry.name) == registered.end()) 
                         candidates2.insert(dirEntry.name.substr(0, dirEntry.name.size() - 4));
                 }
             }
@@ -148,36 +162,34 @@
         delete dirIter;
 
         candidates2.insert("");
+#ifdef __MINGW32__
+	// eliminate logical duplicates as Windows does not distinguish
+	// upper and lower case filenames but we can have e.g. an uppercase zip
+	// and a lower case dir
+	candidates2 = ecl::UniqueFilenameSet(candidates2);
+#endif
         for (std::set<std::string>::iterator i = candidates2.begin(); 
                 i != candidates2.end(); i++) {
-//            Log << "PersistentIndexCandidate2 " << *i <<"\n";
             PersistentIndex * anIndex = new PersistentIndex(*i, false);
-            if (!(anIndex->getName().empty())) {
-                Index::registerIndex(anIndex);
-                registered.insert(*i);
-            } else {
-                delete anIndex;
-            }
+	    checkCandidate(anIndex);
         }
-        
        
         //add user cross indices
         dirIter = DirIter::instance(app.userPath + "/levels/cross");
         while (dirIter->get_next(dirEntry)) {
             if (!dirEntry.is_dir && dirEntry.name.size() > 4 && 
                     (dirEntry.name.rfind(".xml") == dirEntry.name.size() - 4)) {
-//                Log << "PersistentIndexCandidate4 " << dirEntry.name <<"\n";
                 PersistentIndex * anIndex = new PersistentIndex("cross", false, 
                         INDEX_DEFAULT_PACK_LOCATION, "", dirEntry.name);
-                if (!(anIndex->getName().empty())) {
-                    Index::registerIndex(anIndex);
-                } else {
-                    delete anIndex;
-                }
+                checkCandidate(anIndex);
             }
         }
         delete dirIter;
         
+	for (int i = 0; i < indexCandidates.size(); i++) {
+	    Index::registerIndex(indexCandidates[i]);
+	}
+	
         // register auto not yet registered new files
         PersistentIndex * autoIndex = new PersistentIndex("auto", false, 
                 INDEX_AUTO_PACK_LOCATION, INDEX_AUTO_PACK_NAME);

Modified: branches/1.0/src/lev/PersistentIndex.hh
===================================================================
--- branches/1.0/src/lev/PersistentIndex.hh	2007-04-29 11:58:22 UTC (rev 702)
+++ branches/1.0/src/lev/PersistentIndex.hh	2007-04-29 13:12:28 UTC (rev 703)
@@ -112,11 +112,13 @@
         bool isUserOwned;
         bool isEditable;
     private:
+	static std::vector<PersistentIndex *> indexCandidates;
         std::string absIndexPath;
         XERCES_CPP_NAMESPACE_QUALIFIER DOMDocument *doc;
         XERCES_CPP_NAMESPACE_QUALIFIER DOMElement *infoElem;
         XERCES_CPP_NAMESPACE_QUALIFIER DOMElement *levelsElem;
         
+	static void checkCandidate(PersistentIndex * candidate);
         // legacy 0.92
         void parsePar(const string& par, int& par_value, std::string& par_text);
     };



From ral at mail.berlios.de  Sun Apr 29 19:43:42 2007
From: ral at mail.berlios.de (ral at BerliOS)
Date: Sun, 29 Apr 2007 19:43:42 +0200
Subject: [Enigma-game-svn] r704 - in branches/1.0/src: gui lev
Message-ID: <200704291743.l3THhg6M019998@sheep.berlios.de>

Author: ral
Date: 2007-04-29 19:43:41 +0200 (Sun, 29 Apr 2007)
New Revision: 704

Modified:
   branches/1.0/src/gui/LevelPackConfig.cc
   branches/1.0/src/lev/PersistentIndex.cc
Log:
Branch 1.0: 
- enable edit of LP Metadata of system LPs in wizard mode for level admins
- allow LP names with '.' as long as it is no leading char.


Modified: branches/1.0/src/gui/LevelPackConfig.cc
===================================================================
--- branches/1.0/src/gui/LevelPackConfig.cc	2007-04-29 13:12:28 UTC (rev 703)
+++ branches/1.0/src/gui/LevelPackConfig.cc	2007-04-29 17:43:41 UTC (rev 704)
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 2006 Ronald Lamprecht
+ * Copyright (C) 2006, 2007 Ronald Lamprecht
  *
  * This program is free software; you can redistribute it and/or
  * modify it under the terms of the GNU General Public License
@@ -224,19 +224,19 @@
         if (!isReasignOnly) {
             metaVList->add_back(but_metadata);
             metaVList->add_back(new Label());
-#ifdef ENABLE_EXPERIMENTAL
-            metaVList->add_back(releaseLabel);
-            metaVList->add_back(revisionLabel);
-#else
-            metaVList->add_back(new Label());
-            metaVList->add_back(new Label());
-#endif
+	    if (WizardMode) {
+		metaVList->add_back(releaseLabel);
+		metaVList->add_back(revisionLabel);
+	    } else {
+		metaVList->add_back(new Label());
+		metaVList->add_back(new Label());
+	    }
             metaVList->add_back(crossmodeLabel);
-#ifdef ENABLE_EXPERIMENTAL
-            metaVList->add_back(compatibilityLabel);
-#else
-            metaVList->add_back(new Label());
-#endif
+	    if (WizardMode) {
+		metaVList->add_back(compatibilityLabel);
+	    } else {
+		metaVList->add_back(new Label());
+	    }
             metaVList->add_back(defLocationLabel);
             metaVList->add_back(new Label());
         }
@@ -261,19 +261,19 @@
         if (!isReasignOnly) {
             valueMetaVList->add_back(new Label());
             valueMetaVList->add_back(new Label());
-#ifdef ENABLE_EXPERIMENTAL
-            valueMetaVList->add_back(releaseValueLabel);
-            valueMetaVList->add_back(revisionValueLabel);
-#else
+	    if (WizardMode) {
+		valueMetaVList->add_back(releaseValueLabel);
+		valueMetaVList->add_back(revisionValueLabel);
+	    } else {
             valueMetaVList->add_back(new Label());
             valueMetaVList->add_back(new Label());
-#endif
+	    }
             valueMetaVList->add_back(levelmodeWidget);
-#ifdef ENABLE_EXPERIMENTAL
-            valueMetaVList->add_back(compatibilityValueLabel);
-#else
-            valueMetaVList->add_back(new Label());
-#endif
+	    if (WizardMode) {
+		valueMetaVList->add_back(compatibilityValueLabel);
+	    } else {
+		valueMetaVList->add_back(new Label());
+	    }
             valueMetaVList->add_back(defLocationValueLabel);
             valueMetaVList->add_back(new Label());
         }
@@ -348,17 +348,17 @@
             defLocationTF = new TextField(defLocationValueLabel->getText()); 
             valueMetaVList->exchange_child(defLocationValueLabel, defLocationTF);
             delete defLocationValueLabel;
-#ifdef ENABLE_EXPERIMENTAL
-            releaseTF = new TextField(releaseValueLabel->getText()); 
-            valueMetaVList->exchange_child(releaseValueLabel, releaseTF);
-            delete releaseValueLabel;
-            revisionTF = new TextField(revisionValueLabel->getText()); 
-            valueMetaVList->exchange_child(revisionValueLabel, revisionTF);
-            delete revisionValueLabel;
-            compatibilityTF = new TextField(compatibilityValueLabel->getText()); 
-            valueMetaVList->exchange_child(compatibilityValueLabel, compatibilityTF);
-            delete compatibilityValueLabel;
-#endif
+	    if (WizardMode) {
+		releaseTF = new TextField(releaseValueLabel->getText()); 
+		valueMetaVList->exchange_child(releaseValueLabel, releaseTF);
+		delete releaseValueLabel;
+		revisionTF = new TextField(revisionValueLabel->getText()); 
+		valueMetaVList->exchange_child(revisionValueLabel, revisionTF);
+		delete revisionValueLabel;
+		compatibilityTF = new TextField(compatibilityValueLabel->getText()); 
+		valueMetaVList->exchange_child(compatibilityValueLabel, compatibilityTF);
+		delete compatibilityValueLabel;
+	    }
         }
     }
     
@@ -388,8 +388,9 @@
             if (newtitle != persIndex->getName()) {
                 if (isNewIndex) {
                     // check for filename usability of title
-                    const std::string validChars("_- #0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ");
-                    if (newtitle.find_first_not_of(validChars, 0) != std::string::npos) {
+                    const std::string validChars("_- .#0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ");
+                    if (newtitle.find_first_not_of(validChars, 0) != std::string::npos ||
+			    (newtitle.length() >= 1 && newtitle[0] == '.')) {
                         errorLabel->set_text(N_("Error: use only \"a-zA-Z0-9 _-#\" for levelpack title"));
                         return false;               
                     }
@@ -420,35 +421,35 @@
                 }
             }
             
-#ifdef ENABLE_EXPERIMENTAL
-            if (releaseTF->getText() != ecl::strf("%d", persIndex->getRelease())) {
-                int i = 0;
-                // check value - keep old value on error 
-                if ((sscanf(releaseTF->getText().c_str(),"%d", &i) == 1) &&
-                        i > 0) {
-                    persIndex->setRelease(i);
-                    needSave = true;
-                }
-            }
-            if (revisionTF->getText() != ecl::strf("%d", persIndex->getRevision())) {
-                int i = 0;
-                // check value - keep old value on error 
-                if ((sscanf(revisionTF->getText().c_str(),"%d", &i) == 1) &&
-                        i > 0) {
-                    persIndex->setRevision(i);
-                    needSave = true;
-                }
-            }
-            if (compatibilityTF->getText() != ecl::strf("%.2f", persIndex->getCompatibility())) {
-                double d = 0;
-                // check value - keep old value on error 
-                if ((sscanf(compatibilityTF->getText().c_str(),"%lg", &d) == 1) &&
-                        d >= 1) {
-                    persIndex->setCompatibility(d);
-                    needSave = true;
-                }
-            }
-#endif
+	    if (WizardMode) {
+		if (releaseTF->getText() != ecl::strf("%d", persIndex->getRelease())) {
+		    int i = 0;
+		    // check value - keep old value on error 
+		    if ((sscanf(releaseTF->getText().c_str(),"%d", &i) == 1) &&
+			    i > 0) {
+			persIndex->setRelease(i);
+			needSave = true;
+		    }
+		}
+		if (revisionTF->getText() != ecl::strf("%d", persIndex->getRevision())) {
+		    int i = 0;
+		    // check value - keep old value on error 
+		    if ((sscanf(revisionTF->getText().c_str(),"%d", &i) == 1) &&
+			    i > 0) {
+			persIndex->setRevision(i);
+			needSave = true;
+		    }
+		}
+		if (compatibilityTF->getText() != ecl::strf("%.2f", persIndex->getCompatibility())) {
+		    double d = 0;
+		    // check value - keep old value on error 
+		    if ((sscanf(compatibilityTF->getText().c_str(),"%lg", &d) == 1) &&
+			    d >= 1) {
+			persIndex->setCompatibility(d);
+			needSave = true;
+		    }
+		}
+	    }
             
             // save
             if (needSave)

Modified: branches/1.0/src/lev/PersistentIndex.cc
===================================================================
--- branches/1.0/src/lev/PersistentIndex.cc	2007-04-29 13:12:28 UTC (rev 703)
+++ branches/1.0/src/lev/PersistentIndex.cc	2007-04-29 17:43:41 UTC (rev 704)
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 2006 Ronald Lamprecht
+ * Copyright (C) 2006, 2007 Ronald Lamprecht
  *
  * This program is free software; you can redistribute it and/or
  * modify it under the terms of the GNU General Public License
@@ -101,7 +101,7 @@
             dirIter = DirIter::instance(sysPaths[i] + "/levels");
             while (dirIter->get_next(dirEntry)) {
                 if (dirEntry.is_dir && dirEntry.name != "." && dirEntry.name != ".." &&
-                        dirEntry.name != ".svn" && dirEntry.name != "cross") {
+                        dirEntry.name != ".svn" && dirEntry.name != "enigma_cross") {
                     candidates.insert(dirEntry.name);
                 }
                 else {



From andreasl at mail.berlios.de  Mon Apr 30 00:19:56 2007
From: andreasl at mail.berlios.de (andreasl at BerliOS)
Date: Mon, 30 Apr 2007 00:19:56 +0200
Subject: [Enigma-game-svn] r705 - in homepage: images/lotm input input/lotm
Message-ID: <200704292219.l3TMJuKd010034@sheep.berlios.de>

Author: andreasl
Date: 2007-04-30 00:19:49 +0200 (Mon, 30 Apr 2007)
New Revision: 705

Added:
   homepage/images/lotm/lotm_200705.png
   homepage/images/lotm/lotm_200705_a.png
   homepage/images/lotm/lotm_200705_b.png
   homepage/input/lotm/lotm_200705.html
   homepage/input/lotm/lotm_200705_de.html
Modified:
   homepage/input/development_de.html
   homepage/input/infobox.html
   homepage/input/infobox_de.html
   homepage/input/lotm/lotm_core.html
   homepage/input/lotm/lotm_core_de.html
   homepage/input/output-files.lua
Log:
Homepage:
 - English version for LotM May '07
Todo:
 - Proofread
 - German translation


Added: homepage/images/lotm/lotm_200705.png
===================================================================
(Binary files differ)


Property changes on: homepage/images/lotm/lotm_200705.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: homepage/images/lotm/lotm_200705_a.png
===================================================================
(Binary files differ)


Property changes on: homepage/images/lotm/lotm_200705_a.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: homepage/images/lotm/lotm_200705_b.png
===================================================================
(Binary files differ)


Property changes on: homepage/images/lotm/lotm_200705_b.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Modified: homepage/input/development_de.html
===================================================================
--- homepage/input/development_de.html	2007-04-29 17:43:41 UTC (rev 704)
+++ homepage/input/development_de.html	2007-04-29 22:19:49 UTC (rev 705)
@@ -81,7 +81,7 @@
       kombinieren - und wir haben uns tats&auml;chlich schon an einigen
       &Auml;rgernissen dieser Art den Kopf gesto&szlig;en. Wir w&uuml;nschen
       uns daf&uuml;r eine Kontaktperson, die sich mit diesem Themenbereich
-      auskennt, und die wir von Zeit zu Zeit befragen k&ouml;nnen
+      auskennt, und die wir von Zeit zu Zeit befragen k&ouml;nnen.
       <div class="diff">Einfach-Mittelschwer</div></li>
   </ul>
 

Modified: homepage/input/infobox.html
===================================================================
--- homepage/input/infobox.html	2007-04-29 17:43:41 UTC (rev 704)
+++ homepage/input/infobox.html	2007-04-29 22:19:49 UTC (rev 705)
@@ -4,10 +4,10 @@
          New homepage, now with Top News!<br>
 	 Read brief news around Enigma here.
          <h3>Level of the Month</h3>
-         <a href="$$lotm_200704$$"><img src="$$imagedir$$/lotm/lotm_200704.png"
+         <a href="$$lotm_200705$$"><img src="$$imagedir$$/lotm/lotm_200705.png"
          alt="Level of the month" border="0"></a>
          <div class="imagetitle">
-           <a href="$$lotm_200704$$">&quot;Pneumatic Delivery&quot;</a>
+           <a href="$$lotm_200705$$">&quot;The Aztec Temple&quot;</a>
          </div>
          <h3>100 000 Downloads</h3>
 	 Enigma 1.00 has been downloaded more than 100&nbsp;000 times from

Modified: homepage/input/infobox_de.html
===================================================================
--- homepage/input/infobox_de.html	2007-04-29 17:43:41 UTC (rev 704)
+++ homepage/input/infobox_de.html	2007-04-29 22:19:49 UTC (rev 705)
@@ -4,10 +4,10 @@
          Neue Homepage, jetzt mit Top News!<br>
 	 Lesen Sie Kurznachrichten rund um Enigma hier.
          <h3>Level des Monats</h3>
-         <a href="$$lotm_200704$$"><img src="$$imagedir$$/lotm/lotm_200704.png"
+         <a href="$$lotm_200705$$"><img src="$$imagedir$$/lotm/lotm_200705.png"
          alt="Level des Monats" border="0"></a>
          <div class="imagetitle">
-           <a href="$$lotm_200704$$">&quot;Pneumatic Delivery&quot;</a>
+           <a href="$$lotm_200705$$">&quot;The Aztec Temple&quot;</a>
          </div>
          <h3>100 000 Downloads</h3>
 	 Enigma 1.00 wurde mehr als 100.000 mal alleine von

Added: homepage/input/lotm/lotm_200705.html
===================================================================
--- homepage/input/lotm/lotm_200705.html	2007-04-29 17:43:41 UTC (rev 704)
+++ homepage/input/lotm/lotm_200705.html	2007-04-29 22:19:49 UTC (rev 705)
@@ -0,0 +1,248 @@
+<div class="lotm">
+<h2>Level of the Month</h2>
+
+  <p>Each month, we take a closer look at excellent Enigma levels. Excellent
+  levels are those with the highest average user ratings and the greatest
+  number of ratings altogether. Thus it is your vote that determines the
+  Level of the Month. So please rate the levels you play and do not forget to
+  submit your ratings together with your scores at the end of each month. You
+  can find all previous Levels of the Month in our <a href="$$lotm$$"
+  >archive</a>.</p>
+
+  <h3 class="lotm">
+    <span class="date">May 2007: </span>
+    &quot;The Aztec Temple&quot; by Dominik Lehmann
+  </h3>
+
+  <p>&quot;Welcome to Chile! Eight hours ago, your plane arrived at the
+  Airport of &apos;Llamas&apos;, which is a small village surrounded by
+  unexplored jungle terrain. Now you find yourself in front of an impressing
+  temple, which seems to be a relict of the ancient Aztec ages. But the temple
+  is in a surprising good condition ...&quot; Welcome to the Level of
+  the Month! And enter &quot;The Aztec Temple&quot;!</p>
+
+  <div class="lotmpic">
+    <img src="$$imagedir$$/lotm/lotm_200705_a.png" alt="Level of the month" border="0">
+    <div class="imagetitle">Enigma VI # 39</div>
+  </div>
+
+  <table cellpadding="0" cellspacing="1" class="statistics">
+    <caption class="normalcaption">Some records of April 2007</caption>
+    <colgroup>
+       <col width="80">
+       <col width="160">
+    </colgroup>
+    <tr><td class="num">11:39</td>
+        <td class="left">Moneymaker</td></tr>
+    <tr><td class="num">24:32</td>
+        <td class="left">Ale</td></tr>
+    <tr><td class="num">29:45</td>
+        <td class="left">Duffy</td></tr>
+    <tr><td class="num">36:16</td>
+        <td class="left">Taztunes</td></tr>
+    <tr><td class="num">41:10</td>
+        <td class="left">Tarim</td></tr>
+  </table>
+
+  <p>3 votes, resulting in an overwhelming 9.33 in April. There is not a
+  single level that polarizes Enigma's community the way &quot;The Aztec
+  Temple&quot; does. A dedicated storyline, wonderful puzzles, interwoven to a
+  great unity versus intangible difficulty and infinite frustration. Just
+  count the forum entries on mag-heut.net <a 
+  href="http://www.mag-heut.net/blackball/index.php?s=5403e7dbb27c673a6a6adb1952279db2&act=ST&f=8&t=574&st=0"
+  >here</a>;
+  it's the only two-pages-thread in the hints sections!</p>
+
+  <h4>&quot;I still felt a compulsion to come back and explore some
+  more&quot;</h4>
+
+  <p class="quote">There are many levels of Enigma that you can look at and
+  immediately  know exactly what it is you have to do to solve them.  These
+  aren't  my favorite levels of the game.  I prefer the levels that require
+  exploration and discovery - that unfold before you through trial and error
+  - that offer a solution to you that you have to strive to  earn.
+  &quot;Aztec Temple&quot; is one of these.  It is a challenging level.  You
+  have to execute certain maneuvers exactly right, or you're back to square
+  one.</p>
+
+  <p class="quote">There is a very crucial moment (for me at least) where you
+  have to hit a wood stone just right to avoid recoiling against an impulse
+  stone and ruining all your hard work up until that point.  Retrieving the
+  key from the swamp requires some serious focus and agility.  And there are
+  rotors to dodge.</p>
+
+  <p class="quote">In Dominik Lehmann's amusing story, those rotors are guard
+  dogs protecting the temple.  While not all the facts are historically
+  accurate (the Aztecs never got anywhere near Chile or South America for that
+  matter), his tale is a delightful component in this level.  It tells of a
+  scrappy little black marble who takes on a greedy,  unscrupulous villain
+  (who looks a lot like a deadly, rotating top),  defeats him, and gains
+  access to the inner sanctum of the temple and all its treasure.  I know that
+  I want to be just like that true-hearted, valiant marble in my own personal
+  life!</p>
+
+  <p class="quote">In playing &quot;Aztec Temple&quot;, I found myself
+  defeated again and again, but I still felt a compulsion to come back and
+  explore some more while I tried out potential solutions to the many
+  challenging puzzles.  I gained access to the inner sanctum a few times
+  before I made all the right moves to enable me to reach the endorphin rush
+  that a solution to a level like this brings with it.</p>
+
+  <p class="quote">&quot;Aztec Temple&quot; is not for the faint of heart, but
+  it's a terrific journey to take with a very satisfying solution.  Have a
+  nice journey, and stay calm!</p>
+  <p class="author">Taztunes</p>
+
+  <p>That's totally right: The story Dominik tells us through his level
+  somehow makes this level different. He binds us to it, by curiousity of
+  course, but also by means of identification. Most games draw their tension
+  from the identification of the player with some character of a story, and
+  then unfold the story to keep the gamer at playing. It's another kind of
+  entertainment, that's sometimes missing in Enigma's rational
+  world. &quot;The Aztec Temple&quot; closes this gap.</p>
+
+  <h4>&quot;There's still one small mystery&quot;</h4>
+
+  <p>Tarim found another delightful aspect of this level:</p>
+
+  <div class="lotmpic">
+    <img src="$$imagedir$$/lotm/lotm_200705_b.png" alt="Level of the month" border="0">
+    <div class="imagetitle">Rescuing Xila</div>
+  </div>
+
+  <p class="quote">Aztec Temple is more than just about rolling a marble
+  around; it's a complete alternate reality with some great reversals.  The
+  Aztecs are in Chile; their treasure is diamonds and you are a black hero
+  rescuing a white native girl. There are some lovely puzzles which are
+  entangled with each other like the overgrown jungle they're set in.
+  Although the game play can be somewhat unforgiving (one slip and it's
+  shifteffthree time) this just adds to the overall atmosphere.  You can spend
+  a long time thinking about what to do next, but if you get it wrong then
+  you've had it; the evil Gerald Gregory Goshers will win and you will never
+  receive any thanks from the delightfully rounded Xila...</p>
+
+  <p class="quote">Having finished it - there's still one small mystery - what
+  to do with the stone you've carefully extracted from the side entrance of
+  the temple? Let's hope it's a clue for Aztec Temple, part 2 (come on
+  Dominik, you know you want to write it).</p>
+  <p class="author">Tarim</p>
+
+  <p>At least I hope so!</p>
+
+  <h4>&quot;&apos;Aztec Temple&apos; outclasses
+  everything we know in this respect&quot;</h4>
+
+  <p>I already pointed at the trench &quot;Aztec Temple&quot; drew through the
+  community. Reflecting this outside world, the trench spread into the
+  developers' circle as well ...</p>
+
+  <p class="quote">Aztec Temple surely is the first (and last?) level that
+  talks to the gamer for a long time and tells them a story. The first that
+  doesn't use the documents only to give hints to the player. But it starts a
+  real dialogue and thereby draws the gamer into its mystical world. I think,
+  it is the level with the most &quot;it-documents&quot :-)</p>
+
+  <p class="quote">The level belongs to a seldom and very suspenseful kind of
+  levels, which I want to call &quot;journey levels&quot; or maybe better
+  &quot;levels with story&quot;.</p>
+
+  <p class="quote">It's a level that takes you on a thrilling expedition with
+  lots of smaller and bigger puzzles at the roadside. Of course there are
+  levels that give a similar sensation with their linear layout, like the
+  &quot;Gods of Enigma&quot;. However, &quot;Aztec Temple&quot; outclasses
+  everything we know in this respect.</p>
+
+  <p class="quote">Only too obvious, why the level kept unsolved for many
+  weeks after the release of Enigma 1.00. And we asked ourselves, is it really
+  too difficult? Fortunately, &quot;Moneymaker&quot; put us out of this
+  misery. However, till today, only very few players were able to solve
+  &quot;Aztec Temple&quot;. I failed, too.</p>
+
+  <p class="quote">Such a hard level earns a special place, doesn't it? Until
+  recently, it was part of the &quot;mythology&quot; decade in level pack
+  VI. However, with the release of Enigma 1.01 it will meritedly be the master
+  level of pack VI, level number 100.</p>
+  <p class="author">Raoul Bourquin</p>
+
+  <p>Indeed, &quot;The Aztec Temple&quot; will move from position 39 to
+  100. There it will still define a counterpoint to the Roman/Greek mythology
+  decade and in a somewhat deeper sense to the second decade as well. The hole
+  it leaves in the mythology decade will be filled by a very old level which
+  only shortly appeared in Enigma 0.70, then suddenly disappeared and after
+  its own odyssey found its way back home; but that's another story! ;-)</p>
+
+  <h4>&quot;I didn't plan the level to be this difficult&quot;</h4>
+
+  <p>Although he's heavily busy with school at the moment, Dominik found some
+  time to write us his thoughts on Enigma, level writing and our well known
+  temple:</p>
+
+  <p class="quote">I think, Enigma crossed my way the first time in version
+  0.70. This was about 4 years ago. Until then, I never saw a game similar to
+  Enigma (like Oxyd). For myself, games are only interesting when I can tinker
+  with it in a creative way, mostly by designing levels. Directly after I
+  started to play Enigma, I wanted to build own levels, too. And due to the
+  rastered environment of the game a level editor seemed quite
+  reasonable.</p>
+
+  <p class="quote"> Unfortunately, no editor was integrated in the game, so I
+  took a look at the level files. Awaiting a binary file, I was quite amazed
+  to see a scripting language as elementary component of the level in my hex
+  editor. I then read Enigma's documentation, which was still rather short in
+  those days. I still found Lua to be too cumbersome and a graphical editor
+  environment not only possible, but indicated. Hence, I searched on
+  mag-heut.net and found the BlackBallED. With this editor I started to build
+  &quot;The Aztec Temple&quot;. After I designed the first room, the controls 
+  of this otherwise good editors annoyed me so much that I decided to write
+  one myself.</p>
+
+  <p class="quote">It needed quite long (3 months or so) until I finished my
+  own editor in VB. This way I could setup the user interface the way I
+  want. With this editor I then finished &quot;The Aztec Temple&quot;.</p>
+
+  <p class="quote">Actually, I didn't plan the level to be this
+  difficult. But I had so many ideas for puzzles in my head, and I wanted to
+  use all of them, without remembering that already their total count would
+  make the level more and more difficult and frustrating. I developed the
+  single components of the level in the sequence in which they're to be solved
+  today.</p>
+
+  <p class="quote">When I finished writing the level I said to myself
+  &quot;Okay, just one time gambling through it, then it's finished&quot;. As
+  I noticed that it's really fierce to solve one of the partly lethal puzzles
+  after the other, it was too late to ease it anymore; just because all the
+  elements are interdependent. I think I needed just as long for solving the
+  level as I did for writing it. Then I got the affirmation that it's
+  difficult, but solvable, I just left it the way it was. And set out to not
+  overcharge my next creations that much.</p>
+
+  <p class="quote">The story the level tells, doesn't really have a
+  background. As I constructed the first room, I thought that I had to explain
+  to the gamer what he sees (as it isn't obvious from graphics that there is
+  some jungle and a temple). Thus I tried to explain with each puzzle, what
+  the elements mean. As I met the purely technically inspired need of adding a
+  second actor, the further course of the randomly started storyline was just
+  a logical consequence. The room in which the white marble started became
+  the &quot;Wild's Cage&quot; all by itself. And a simple
+  &quot;it-document&quot; at the corresponding trigger made the story
+  consistent.</p>
+
+  <p class="quote">Well, as I said. The level is indeed disproportionately
+  hard; however, I have no idea how to change this without affecting the
+  overall structure of it. The flags (being another point of criticism on
+  mag-heut.net) were meant to simulate a kind of save-game function. The
+  shortcuts that result from them are nevertheless undesirable.</p>
+  <p class="author">Dominik Lehmann</p>
+
+  <p>Dominik added a way to resolve this problem, and some thoughts about an
+  easier easy-mode. We'll discuss this and will hopefully come back with a
+  solution - though not yet with 1.01. We shouldn't rush through providing a
+  better easy-mode, just as the level itself shouldn't be rushed through while
+  gaming. It's a wonderful creation, not neccesarily made for solving, but at
+  all means made for enjoyment! Thank you very much for this jewel of a level,
+  Dominik!</p>
+
+  <p>Greets,<br/>
+  <i>Andreas</i></p>
+
+</div>

Added: homepage/input/lotm/lotm_200705_de.html
===================================================================
--- homepage/input/lotm/lotm_200705_de.html	2007-04-29 17:43:41 UTC (rev 704)
+++ homepage/input/lotm/lotm_200705_de.html	2007-04-29 22:19:49 UTC (rev 705)
@@ -0,0 +1,336 @@
+<div class="lotm">
+<h2>Level of the Month</h2>
+
+  <p>Each month, we take a closer look at excellent Enigma levels. Excellent
+  levels are those with the highest average user ratings and the greatest
+  number of ratings altogether. Thus it is your vote that determines the
+  Level of the Month. So please rate the levels you play and do not forget to
+  submit your ratings together with your scores at the end of each month. You
+  can find all previous Levels of the Month in our <a href="$$lotm$$"
+  >archive</a>.</p>
+
+  <h3 class="lotm">
+    <span class="date">May 2007: </span>
+    &quot;The Aztec Temple&quot; by Dominik Lehmann
+  </h3>
+
+  <p>&quot;Welcome to Mexico! Eight hours ago, your plane arrived at the
+  Airport of &apos;Coatlicue&apos;, which is a small village surrounded by
+  unexplored jungle terrain. Now you find yourself in front of an impressive
+  temple, which seems to be a relic of the ancient Aztec empire. But the
+  temple is in surprisingly good condition ...&quot; Welcome to the Level of
+  the Month! Welcome to &quot;The Aztec Temple&quot;!</p>
+
+  <div class="lotmpic">
+    <img src="$$imagedir$$/lotm/lotm_200705_a.png" alt="Level of the month" border="0">
+    <div class="imagetitle">Enigma VI # 39</div>
+  </div>
+
+  <table cellpadding="0" cellspacing="1" class="statistics">
+    <caption class="normalcaption">Some records of April 2007</caption>
+    <colgroup>
+       <col width="80">
+       <col width="160">
+    </colgroup>
+    <tr><td class="num">11:39</td>
+        <td class="left">Moneymaker</td></tr>
+    <tr><td class="num">24:32</td>
+        <td class="left">Ale</td></tr>
+    <tr><td class="num">29:45</td>
+        <td class="left">Duffy</td></tr>
+    <tr><td class="num">36:16</td>
+        <td class="left">Taztunes</td></tr>
+    <tr><td class="num">41:10</td>
+        <td class="left">Tarim</td></tr>
+  </table>
+
+  <p>3 votes, resulting in an overwhelming 9.33 in April. There is not a
+  single level that polarizes Enigma's community the way &quot;The Aztec
+  Temple&quot; does. A dedicated storyline, wonderful puzzles, interwoven to a
+  great unity on the one hand - intangible difficulty and infinite frustration
+  on the other. Just count the forum entries on mag-heut.net <a
+  href="http://www.mag-heut.net/blackball/index.php?s=5403e7dbb27c673a6a6adb1952279db2&act=ST&f=8&t=574&st=0"
+  >here</a>;
+  it's the only two-pages-thread in the hints sections!</p>
+
+  <p class="quote">There are many levels of Enigma that you can look at and
+  immediately  know exactly what it is you have to do to solve them.  These
+  aren't  my favorite levels of the game.  I prefer the levels that require
+  exploration and discovery - that unfold before you through trial and error
+  - that offer a solution to you that you have to strive to  earn.
+  &quot;Aztec Temple&quot; is one of these.  It is a challenging level.  You
+  have to execute certain maneuvers exactly right, or you're back to square
+  one.
+
+  There is a very crucial moment (for me at least) where you have to hit a
+  wood stone just right to avoid recoiling against an impulse stone and
+  ruining all your hard work up until that point.  Retrieving the key from
+  the swamp requires some serious focus and agility.  And there are rotors to
+  dodge.
+
+  In Dominik Lehmann's amusing story, those rotors are guard dogs protecting
+  the temple.  While not all the facts are historically accurate (the Aztecs
+  never got anywhere near Chile or South America for that matter), his tale
+  is a delightful component in this level.  It tells of a scrappy little
+  black marble who takes on a greedy,  unscrupulous villain (who looks a lot
+  like a deadly, rotating top),  defeats him, and gains access to the inner
+  sanctum of the temple and all its treasure.  I know that I want to be just
+  like that true-hearted, valiant marble in my own personal life!
+
+  In playing &quot;Aztec Temple&quot;, I found myself defeated again and
+  again, but I still felt a compulsion to come back and explore some more
+  while I tried out potential solutions to the many challenging puzzles.  I
+  gained access to the inner sanctum a few times before I made all the right
+  moves to enable me to reach the endorphin rush  that a solution to a level
+  like this brings with it.
+
+  &quot;Aztec Temple&quot; is not for the faint of heart, but it's a terrific
+  journey to take with a very satisfying solution.  Have a nice journey, and
+  stay calm!</p>
+  <p class="author">Taztunes</p>
+
+  <h4>&quot;Next section&quot;</h4>
+
+  <p class="quote">
+Aztec Temple ist wohl das erste (und einzige?) Level, das sich mit dem Spieler
+?ber eine l?ngere Zeit unterh?lt und ihm eine Geschichte erz?hlt. Das erste, das
+die Dokumente nicht bloss benutzt, um dem Spieler Hinweise zu geben, sondern einen
+richtigen Dialog aufbaut und so den Spieler noch mehr in seine geheimnisvolle Welt
+hineinzieht. Ich glaube, es ist das Level mit den meisten "it-documents" :-)
+
+Das Level geh?rt zu einer seltenen und sehr spannenden Art von Levels,
+die ich einfach mal "Reiselevel" oder besser "Level mit Geschichte" nennen will.
+
+Es ist ein Level, dass einem mit nimmt auf eine spannende Entdeckungsreise mit vielen
+kleineren und gr?sseren Puzzles am Wegrand. Nat?rlich gibt es auch andere Level,
+etwa die "Gods of Enigma", die mit diesem relativ linearen Aufbau ein ?hnliches
+Gef?hl vermitteln. Aber "Aztec Temple" ?bertrifft alles, was wir bisher in
+dieser Hinsicht kennen.
+
+Das "Public Rating" dieses Levels erreicht dem entsprechend einen sehr hohen Wert
+von 84 Punkten. Es besitzt damit zur Zeit das h?chste Rating ?berhaupt. (Dicht
+gefolgt von "Puzzle Puzzles" mit 83 Punkten ;-))
+
+Somit wird auch klar, warum das Level nach dem Erscheinen von Enigma 1.00
+?ber viele Wochen ungel?st blieb; Und wir uns schon fragten, ob es wohl wirklich
+zu schwer geraten ist. Gl?cklicherweise aber hat "Moneymaker" und von dieser Frage
+erl?st. Bis heute ist "Aztec Temple" allerdings erst von sehr wenigen Spielern
+gel?st worden, auch ich habe es noch nicht geschafft ...
+
+Ein solch schweres Level verdient doch einen speziellen Platz, nicht? Bisher war
+es in der Themendekade "Mythologie" im Levelpack VI eingereiht. In
+allen Enigma-Levelpacks existieren jeweils 2 Themendekaden (Level 31-40 und 81-90);
+alle Level einer solchen Dekade verbindet ein gemeinsames Thema. Mit dem Release
+von Enigma 1.01 geben wir ihm aber den verdienten Platz des Masterlevels, das
+ist Level Nummer 100, des Packs VI.
+
+</p>
+
+<p>
+Ich glaube das erste Mal ist mir Enigma in der Version 0.70 ?ber den Weg
+gelaufen. Das war vor ca. 4 Jahren. Bis dahin hatte ich noch nie ein
+enigma-?hnliches Spiel (wie z.B. Oxyd) gesehen.
+F?r mich werden Spiele erst dann interessant, wenn sich kreativ
+(meistens in irgendeiner Form der Levelgestaltung) daran herumbasteln
+l?sst. Direkt nachdem ich angefangen hatte Enigma zu spielen, wollte ich
+auch eigene Levels bauen und bei der gerasterten Spielumgebung erschien
+mir ein Leveleditor durchaus sinnvoll. Da leider keiner im Spiel
+integriert war habe ich mir die Leveldateien genauer angesehen. In
+Erwartung einer Bin?rdatei habe ich eine solche in einen HEX-Editor
+geladen und war relativ ?berrascht, als ich da eine Scriptsprache als
+elementaren Bestandteil der Level zu Gesicht bekam. Ich hab dann die
+damals noch sehr kurze Dokumentation durchgelesen, die bei Enigma
+mitinstalliert war. Mir erschien LUA allerdings immer noch zu
+umst?ndlich und eine grafische Editoroberfl?che nicht nur m?glich,
+sondern sogar angebracht und habe daraufhin auf mag-heut.net den
+BlackBallED gefunden. Mit diesem Editor habe ich dann angefangen
+TheAtztecTemple zu bauen. Nachdem ich aber den ersten Raum gebaut hatte
+ging mit die Steuerung dieses ansonsten guten Editors so auf die Nerven,
+dass ich beschloss mir selbst einen zu schreiben.
+Es hat ziemlich lange gedauert (3 Monate oder so) bis ich meinen eigenen
+Editor in VB fertig hatte. So konnte ich mir die Bedienoberfl?che so
+einrichten, wie es mir gef?llt. In dem Editor habe ich dann auch
+TheAtztecTemple fertig gestellt.
+
+Eigentlich war das Level gar nicht so schwer geplant. Ich hatte aber
+ziemlich viele Ideen f?r R?tsel im Kopf, die ich alle in das Level
+eingebaut habe, ohne daran zu denken, dass allein durch die Anzahl das
+Level immer schwerer und frustrierender wurde. Die Levelbestandteile
+haben sich in genau der Reihenfolge entwickelt, wie sie jetzt auch zu
+spielen sind. Als das Level fertig war, sagte ich mir "So, jetzt nur
+noch einmal durchzocken, das isses fertig.". Als mir dann auffiel, dass
+es doch ziemlich heftig ist so viele mitunter t?dliche R?tsel
+nacheinander zu l?sen, war es allerdings kaum mehr m?glich etwas zu
+vereinfachen; einfach deswegen, weil die Elemente gr??tenteils
+interdependent sind. Ich glaube ich habe f?r das Durchspielen fast
+genauso lange gebraucht wie f?r den Bau. Als ich dann die Best?tigung
+hatte, dass das Level zwar schwer, aber l?sbar ist, habe ich es einfach
+so gelassen, und mir vorgenommen meine n?chsten Kreationen nicht so sehr
+zu ?berladen.
+
+Die Geschichte, die das Level erz?hlt, hat nicht wirklich irgendeinen
+Hintergrund. Als ich den ersten Raum gebastelt habe, dachte ich mir,
+dass ich dem Spieler schon erkl?ren m?sse, was er da sieht (denn aus der
+Grafik heraus ist es nicht erkennbar, dass es sich um Urwald und einen
+Tempel handelt). Also habe ich bei jedem R?tsel versucht zu erkl?ren,
+was die Elemente darstellen. Als ich dann die rein spieltechnische
+Notwendigkeit sah, einen zweiten Actor zu implementieren, war der
+weitere Verlauf der so zuf?llig begonnenen Storyline eigentlich nur die
+logische Konsequenz. Der Raum, in dem die wei?e Marble beginnt, wurde
+dann wie von selbst zum "Wild's Cage" und ein einfaches "it-document" am
+Trigger der das Teil ?ffnet, macht die Geschichte konsistent.
+
+Nun ja, wie gesagt. Das Level ist tats?chlich etwas ?bertrieben schwer;
+allerdings habe ich keine Idee wie das zu ?ndern w?re, ohne die
+?bergreifende Struktur anzugreifen. Die Flaggen (die auf mag-heut.net
+auch zum Kritikpunkt wurden) waren eigentlich daf?r da, sowas wie eine
+savegame-Funktion zu simulieren. Die Abk?rzungen die dadurch m?glich
+sind, sind allerdings nicht w?nschenswert. Es ist tats?chlich von
+Vorteil die Flaggen zu entfernen (obwohl das Level dadurch noch schwerer
+wird, als es sowieso schon ist. Folgendes ist meine Idee (die ich hier
+nur f?r den Fall wiedergebe, dass der Mailanhang nicht ankommt):
+Man entferne cells["Q"] und cells["9"] aus dem "level"-Array f?r die
+Items und kommentiere die Zeilen 140 und 164 aus. Um allerdings das
+Level wieder spielbar zu machen (denn nach entfernen der Steine von den
+das Gef?ngnis ?ffnenden Triggern ist die Xila unwiederbringlich im
+Kerker eingepfercht, sollte sie ein Leben verlieren) ersetze man das
+Leerzeichen in Zeile 197, Spalte 39 (der Sourcedatei, nicht des
+Level-Arrays) durch ein "U" und definiere sodann das Element
+
+cells["U"]=cell{item={face="it-trigger",attr={action="callback",invisible=1,target="DisableWhiteDoor"}}}
+
+um danach die Lua-Funktion "DisableWhiteDoor" zu implementieren, die wie
+folgt aussieht:
+
+function DisableWhiteDoor()
+ SetAttrib(enigma.GetNamedObject("WhiteTrigger1"),"target","")
+ SetAttrib(enigma.GetNamedObject("WhiteTrigger2"),"target","")
+end
+
+welche es erfordert die Items "@" und "A" mit den Namen "WhiteTrigger1"
+und "WhiteTrigger2" auszustatten. Damit bleiben die T?ren des
+Gef?ngnisses offen, auch wenn der Spiegel und die Kiste von den f?r die
+?ffnung der Gef?ngnist?ren vorgesehenen Triggern entfernt werden.
+
+Damit sind Abk?rzungen nicht mehr m?glich. Zur Vereinfachung k?nnte der
+Startpunkt der schwarzen Marble etwas mehr in die Mitte des Bildschirms
+ger?ckt werden, sodass die oben links gefangenen "Hunde" nicht sofort
+den Spieler anfallen, sollte er ein Leben verlieren.
+
+Den Easymode weiter zu vereinfachen ist eine gute Idee. Man k?nnte zum
+Beispiel die Deathstones aus dem Sumpf entfernen und die Taschendiebe am
+Tempeleingang durch normale st-bluegray ersetzen. Das Wasser im
+Tempelnebenraum k?nnte auch entfernt werden. Die Rotoren im Tempel sind
+im Easymode ja schon nicht mehr da und wenn es so richtig einfach sein
+soll, k?nnte man auch die Wachhunde au?en auf zwei ihrer Art reduzieren.
+
+Nun gut: jetzt hab ich massenweise Zeugs geschrieben, wovon dreiviertel
+wohl nicht zu gebrauchen sind. Ich hoffe es macht keine allzu gro?en
+Umst?nde, dass ich erst so sp?t antworte, weil diese und letzte Woche
+Abiklausuren waren.
+
+Dominik
+
+PS: Ich h?tte nie gedacht, dass das Level so eine hohe
+Durchschnittsbewertung hat, wo es doch auf mag-heut.net so kritisiert
+wurde (und das gr??tenteils zu recht).
+
+</p>
+
+  <p class="quote">
+  If you've ever planned an Enigma level, you surely know that it's similar to
+  poetry or architecture. The level provides a frame for your piece of art
+  like that you have to touch all the oxyds. But when an idea comes up in
+  your mind or some content that you would like to wrap in a puzzle it's up
+  to you what to create. You seem to be free in it. However the more you rely
+  on a pattern, the more clear and comprehensible will be your creation. You
+  see, each written story is constructed of letters next to each other but if
+  it has a beginning and leads you somewhere, you may understand it. So you
+  won't feel any emotion at all and you won't start thinking of a level
+  unless you conceive it's basic idea. For this reason a storyline or a
+  well-defined theme can make a level more fascinating than the other
+  ones.</p>
+
+  <p class="quote">
+  I can't say that Pneumatic Delivery is my favourite level but I admit that
+  it's well-organized, that it contains five engaging puzzles even though it's
+  not larger than two screens. What makes it more exciting is that the first
+  four puzzles are only the preparation of the last one, which is actually a
+  one-way enigma that you can't retry. By the way, it really moved me that
+  Manuel has dedicated this level to his father.</p>
+  <p class="author">Hubai Andr&aacute;s</p>
+
+  <p>Andr&aacute;s also saw similarities with the &quot;Gods of Enigma&quot;
+  series, &quot;Doors Forever&quot; (&quot;but it contains
+  dexterity-requiring parts&quot;), and &quot;Automaton&quot;, which he likes
+  as well. I want to add the Oxyd Magnum 82 clone &quot;Puller Mailing&quot;,
+  which features a somewhat similar puzzle, but ironically can be solved
+  without mailing any pullers ...</p>
+
+  <h4>&quot;I had no experience concerning level programming&quot;</h4>
+
+  <p>Vigilant players will have noticed that levels by Manuel are very
+  rare. Hardly to believe that this masterpiece is his debut feature!</p>
+
+  <p class="quote">
+  Indeed, &quot;Pneumatic Delivery&quot; was my very first level. I had no
+  experience concerning level programming. Nevertheless I wanted to design a
+  level for my father, who is a strong fan of Oxyd and Enigma. So I created a
+  first &quot;draft&quot; of the level with BlackBallEd and afterwards
+  programmed it in Lua. After a long search I still found a screenshot of this
+  first &quot;draft&quot;, I attached it [see below] (the screenshot dates
+  back to Sept. 28th, 2004). As one can see, the level at that time comprised
+  of only one room, but the most important - namely the part with the
+  turnstiles - already existed. But the pipes as well as the puller items were
+  supposed to be gathered by the player through further puzzles and as there
+  wasn't enough room, I added a second room.</p>
+  <p class="author">Manuel K&ouml;nig</p>
+
+  <div class="lotmpic">
+    <img src="$$imagedir$$/lotm/lotm_200704_b.png" alt="A draft version" border="0">
+    <div class="imagetitle">A draft version from 2004</div>
+  </div>
+
+  <p>This explains why the marbles start in the middle of the level! In many
+  levels the marbles start at the far left, at the top or one of the other
+  borders ... in this case the level &quot;grew around the
+  marbles&quot;. This gives a distinctive feeling of being already in the
+  middle of the game. Compare it e.g. with &quot;Teamplay Doors&quot; or
+  &quot;Doors Forever&quot;.</p>
+
+  <h4>An Easy Mode?</h4>
+
+  <p class="quote">
+  In the second version of the level [stored on mag-heut.net] the level offers
+  an &quot;easy mode&quot;. I added it afterwards, as I hold that many of Enigma's
+  levels are by far too difficult for beginners and my level unfortunately is
+  no exception to this. However, it wasn't simple to ease this level
+  noticeably, without changing the level as a whole. So I tried to remove
+  some stones and already place some of the items on their designated
+  places. In the hope that unexperienced players can enjoy &quot;Pneumatic
+  Delivery&quot; as well.</p>
+  <p class="author">Manuel K&ouml;nig</p>
+
+  <p>There is an easy mode?! Well, I didn't know too, until Manuel drew my
+  attention to it. Indeed, the version in Enigma 1.00 has an easy mode coded
+  but we forgot to activate it ... unfortunately, we can't reconstruct if the
+  world records achieved and listed above are done in normal or easy mode.
+  So I'm very sorry to announce an update of &quot;Pneumatic Delivery&quot;
+  in Enigma 1.01, with corrected easy mode, which will make all prior
+  records of PD obsolete. If you see any more levels with internal easy modes
+  that are not marked as such, please inform us.</p>
+
+  <p class="quote">
+  Personally I think I created this landscape quite well, and what is even
+  more important: My father likes it. He needed weeks (or even months?) to
+  solve it. When I replay this level today, the orange puzzle drives me mad
+  each time - I hope other players feel the same. ;-)</p>
+  <p class="author">Manuel K&ouml;nig</p>
+
+  <p>Thanks to you, Manuel, for this wonderful fivefold puzzle, and the
+  stories we can now connect to it!</p>
+
+  <p>Greets,<br/>
+  <i>Andreas</i></p>
+
+</div>

Modified: homepage/input/lotm/lotm_core.html
===================================================================
--- homepage/input/lotm/lotm_core.html	2007-04-29 17:43:41 UTC (rev 704)
+++ homepage/input/lotm/lotm_core.html	2007-04-29 22:19:49 UTC (rev 705)
@@ -19,7 +19,7 @@
     <tr><th class="right">Month</th>
         <th class="left">Title</th>
         <th class="left">Author</th>
-        <th class="num">Position</th>
+        <th class="num">Position (1.00)</th>
     </tr>
     <tr><td class="right">March 2007</td>
         <td class="left"><a href="$$lotm_200703$$">Island Labyrinth</a></td>
@@ -31,6 +31,11 @@
         <td class="left">Manuel K&ouml;nig</td>
         <td class="num">V/59</td>
     </tr>
+    <tr><td class="right">May 2007</td>
+        <td class="left"><a href="$$lotm_200705$$">The Aztec Temple</a></td>
+        <td class="left">Dominik Lehmann</td>
+        <td class="num">VI/39</td>
+    </tr>
   </table>
 
 </div>

Modified: homepage/input/lotm/lotm_core_de.html
===================================================================
--- homepage/input/lotm/lotm_core_de.html	2007-04-29 17:43:41 UTC (rev 704)
+++ homepage/input/lotm/lotm_core_de.html	2007-04-29 22:19:49 UTC (rev 705)
@@ -33,6 +33,11 @@
         <td class="left">Manuel K&ouml;nig</td>
         <td class="num">V/59</td>
     </tr>
+    <tr><td class="right">Mai 2007</td>
+        <td class="left"><a href="$$lotm_200705$$">The Aztec Temple</a></td>
+        <td class="left">Dominik Lehmann</td>
+        <td class="num">VI/39</td>
+    </tr>
   </table>
 
 </div>

Modified: homepage/input/output-files.lua
===================================================================
--- homepage/input/output-files.lua	2007-04-29 17:43:41 UTC (rev 704)
+++ homepage/input/output-files.lua	2007-04-29 22:19:49 UTC (rev 705)
@@ -207,4 +207,12 @@
     body = {"lotm/lotm_200704"}
 }
 
+html.lotm_200705 = {
+    outfile = "lotm_200705.html",
+    title = "Level of the Month: May 2007",
+    title_de = "Level des Monats: Mai 2007",
+    rightcolumn = {},
+    body = {"lotm/lotm_200705"}
+}
+
 ----------------------------------------------------------------------



From raoul at mail.berlios.de  Mon Apr 30 01:09:23 2007
From: raoul at mail.berlios.de (raoul at BerliOS)
Date: Mon, 30 Apr 2007 01:09:23 +0200
Subject: [Enigma-game-svn] r706 - homepage/input/lotm
Message-ID: <200704292309.l3TN9NUJ005580@sheep.berlios.de>

Author: raoul
Date: 2007-04-30 01:09:22 +0200 (Mon, 30 Apr 2007)
New Revision: 706

Modified:
   homepage/input/lotm/lotm_200705.html
   homepage/input/lotm/lotm_200705_de.html
Log:
-> Validated HTML, Part I
--> Replaced invalid "&apos;" by "&#39;"

-> Removed php session from links to magheut.



Modified: homepage/input/lotm/lotm_200705.html
===================================================================
--- homepage/input/lotm/lotm_200705.html	2007-04-29 22:19:49 UTC (rev 705)
+++ homepage/input/lotm/lotm_200705.html	2007-04-29 23:09:22 UTC (rev 706)
@@ -15,7 +15,7 @@
   </h3>
 
   <p>&quot;Welcome to Chile! Eight hours ago, your plane arrived at the
-  Airport of &apos;Llamas&apos;, which is a small village surrounded by
+  Airport of &#39;Llamas&#39;, which is a small village surrounded by
   unexplored jungle terrain. Now you find yourself in front of an impressing
   temple, which seems to be a relict of the ancient Aztec ages. But the temple
   is in a surprising good condition ...&quot; Welcome to the Level of
@@ -49,7 +49,7 @@
   Temple&quot; does. A dedicated storyline, wonderful puzzles, interwoven to a
   great unity versus intangible difficulty and infinite frustration. Just
   count the forum entries on mag-heut.net <a 
-  href="http://www.mag-heut.net/blackball/index.php?s=5403e7dbb27c673a6a6adb1952279db2&act=ST&f=8&t=574&st=0"
+  href="http://www.mag-heut.net/blackball/index.php?act=ST&amp;f=8&amp;t=574&amp;st=0"
   >here</a>;
   it's the only two-pages-thread in the hints sections!</p>
 
@@ -129,7 +129,7 @@
 
   <p>At least I hope so!</p>
 
-  <h4>&quot;&apos;Aztec Temple&apos; outclasses
+  <h4>&quot;&#39;Aztec Temple&#39; outclasses
   everything we know in this respect&quot;</h4>
 
   <p>I already pointed at the trench &quot;Aztec Temple&quot; drew through the

Modified: homepage/input/lotm/lotm_200705_de.html
===================================================================
--- homepage/input/lotm/lotm_200705_de.html	2007-04-29 22:19:49 UTC (rev 705)
+++ homepage/input/lotm/lotm_200705_de.html	2007-04-29 23:09:22 UTC (rev 706)
@@ -15,7 +15,7 @@
   </h3>
 
   <p>&quot;Welcome to Mexico! Eight hours ago, your plane arrived at the
-  Airport of &apos;Coatlicue&apos;, which is a small village surrounded by
+  Airport of &#39;Coatlicue&#39;, which is a small village surrounded by
   unexplored jungle terrain. Now you find yourself in front of an impressive
   temple, which seems to be a relic of the ancient Aztec empire. But the
   temple is in surprisingly good condition ...&quot; Welcome to the Level of
@@ -49,7 +49,7 @@
   Temple&quot; does. A dedicated storyline, wonderful puzzles, interwoven to a
   great unity on the one hand - intangible difficulty and infinite frustration
   on the other. Just count the forum entries on mag-heut.net <a
-  href="http://www.mag-heut.net/blackball/index.php?s=5403e7dbb27c673a6a6adb1952279db2&act=ST&f=8&t=574&st=0"
+  href="http://www.mag-heut.net/blackball/index.php?act=ST&amp;f=8&amp;t=574&amp;st=0"
   >here</a>;
   it's the only two-pages-thread in the hints sections!</p>
 



From ral at mail.berlios.de  Mon Apr 30 20:32:23 2007
From: ral at mail.berlios.de (ral at BerliOS)
Date: Mon, 30 Apr 2007 20:32:23 +0200
Subject: [Enigma-game-svn] r707 - in branches/1.0: . doc/reference src/gui
Message-ID: <200704301832.l3UIWNnJ008306@sheep.berlios.de>

Author: ral
Date: 2007-04-30 20:32:22 +0200 (Mon, 30 Apr 2007)
New Revision: 707

Modified:
   branches/1.0/CHANGES
   branches/1.0/doc/reference/enigma-ref.texi
   branches/1.0/src/gui/MainMenu.cc
Log:
Branch 1.0: 
- update credits with new level authors
- update changes
- refman fixing technical typos


Modified: branches/1.0/CHANGES
===================================================================
--- branches/1.0/CHANGES	2007-04-29 23:09:22 UTC (rev 706)
+++ branches/1.0/CHANGES	2007-04-30 18:32:22 UTC (rev 707)
@@ -1,3 +1,32 @@
+Changes in Version 1.01
+=======================
+
+User-Visible changes
+--------------------
+
+    - 50++ new level
+    - added easy mode to some existing levels
+    - Fixes of all levels with shortcuts
+    - Finnish translation
+    - French and Russian 1.0 manuals
+    - Sound damping for noisy levels
+    - mouse wheel enabled for many buttons like user ratings, volume,...
+    - logo cleaned
+    - moved backup of score and state to backup subdirectory
+    - level menu optimization of level title display
+    - visualize inherited user rating in level inspector
+    - vista compatible marble icon
+    - windows installer reengineering to modern NSI
+
+Internal changes
+----------------
+
+    - fix of various enigne bugs that did not yet show up with bundled levels
+    - fixed properties of various glass stones
+    - sound handling reengineering
+    - support of user sound sets
+    - autorecovery from state / score mismatches
+
 Changes in Version 1.00
 =======================
 

Modified: branches/1.0/doc/reference/enigma-ref.texi
===================================================================
--- branches/1.0/doc/reference/enigma-ref.texi	2007-04-29 23:09:22 UTC (rev 706)
+++ branches/1.0/doc/reference/enigma-ref.texi	2007-04-30 18:32:22 UTC (rev 707)
@@ -2721,7 +2721,7 @@
 @item fl-bridge
 open by default
 @item fl-bridge-open
- at item fl-bridge-close
+ at item fl-bridge-closed
 @end table
 
 
@@ -4592,7 +4592,7 @@
 These stones apply an impulse to actors that touch them.  The amount
 of force applied can be controlled by setting
 @code{enigma.BumperForce} (see @ref{Variables}) accordingly (the
-default is 800). Alternatively, the @code{force} attribute can be used
+default is 200). Alternatively, the @code{force} attribute can be used
 to set this factor for @emph{individual} bumper stones.
 
 @strong{Attributes}

Modified: branches/1.0/src/gui/MainMenu.cc
===================================================================
--- branches/1.0/src/gui/MainMenu.cc	2007-04-29 23:09:22 UTC (rev 706)
+++ branches/1.0/src/gui/MainMenu.cc	2007-04-30 18:32:22 UTC (rev 707)
@@ -145,7 +145,7 @@
         "  illmind  (Forum mag-heut.net administration, Level design)",
         "  Jennifer Robertson  (Graphics second generation)",
         "  Jeremy Sawicki  (Oxydlib)",
-        "  Erich Schubert  (Debian packages)",
+        "  Erich Schubert  (Debian/Ubuntu packages, level design)",
         "  Lukas Sch?ller  (Level design)",
         "  Andrew \'Necros\' Sega (Menu music \'Pentagonal Dreams\')",
 // waiting for licence to add the sounds
@@ -164,6 +164,7 @@
         "  Edward  (Level design)",
         "  Stephanie Fabian  (Invaluable bug reports)",
         "  Roberto Garc?a (Spanish translation)",
+        "  Andy Geldmacher  (Level design)",
         "  Edwin Groothuis  (FreeBSD port)",
         "  Immanuel Herrmann  (Level design)",
         "  M?t? Lehel Juh?sz  (Hungarian translation)",
@@ -171,6 +172,8 @@
         "  Samuele Kaplun  (Italian translation)",
         "  Jens-Christian Korth  (Level design)",
         "  Manuel K?nig  (Level design, bug reports)",
+        "  Johannes Laire  (Level design)",
+        "  Joona Laire  (Level design)",
         "  Markus Laire  (Level design)",
         "  Dominik Lehmann  (Level design)",
         "  Edward Leuf  (Feedback, bug reports)",
@@ -180,10 +183,10 @@
         "  moonpearl  (Level design)",
         "  Krishnamurti L.L.V. Nunes (Portuguese translation)",
         "  Daniel Nylander  (Swedish translation)",
+        0,
         "  Peter Santo  (Level design)",
         "  Tobias Schmidbauer  (Windows installer and icon)",
         "  Achim Settelmeier  (RPM specfile)",
-        0,
         "  Jon Sneyers  (Level design)",
         "  Spaceman  (Level design)",
         "  Ulf Stegemann  (Level design)",



