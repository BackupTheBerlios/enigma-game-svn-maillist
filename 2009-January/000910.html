<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Enigma-game-svn] r1481 - in trunk: data data/gfx32 data/gfx40	data/gfx48 data/schemas src src/actors src/floors src/stones
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/enigma-game-svn/2009-January/index.html" >
   <LINK REL="made" HREF="mailto:enigma-game-svn%40lists.berlios.de?Subject=Re%3A%20%5BEnigma-game-svn%5D%20r1481%20-%20in%20trunk%3A%20data%20data/gfx32%20data/gfx40%0A%09data/gfx48%20data/schemas%20src%20src/actors%20src/floors%20src/stones&In-Reply-To=%3C200901242059.n0OKxRXJ000092%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000909.html">
   <LINK REL="Next"  HREF="000911.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Enigma-game-svn] r1481 - in trunk: data data/gfx32 data/gfx40	data/gfx48 data/schemas src src/actors src/floors src/stones</H1>
    <B>ral at BerliOS</B> 
    <A HREF="mailto:enigma-game-svn%40lists.berlios.de?Subject=Re%3A%20%5BEnigma-game-svn%5D%20r1481%20-%20in%20trunk%3A%20data%20data/gfx32%20data/gfx40%0A%09data/gfx48%20data/schemas%20src%20src/actors%20src/floors%20src/stones&In-Reply-To=%3C200901242059.n0OKxRXJ000092%40sheep.berlios.de%3E"
       TITLE="[Enigma-game-svn] r1481 - in trunk: data data/gfx32 data/gfx40	data/gfx48 data/schemas src src/actors src/floors src/stones">ral at mail.berlios.de
       </A><BR>
    <I>Sat Jan 24 21:59:27 CET 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="000909.html">[Enigma-game-svn] r1480 - team_levelpacks/team_test_new_api
</A></li>
        <LI>Next message: <A HREF="000911.html">[Enigma-game-svn] r1482 - in trunk: data data/schemas src src/stones
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#910">[ date ]</a>
              <a href="thread.html#910">[ thread ]</a>
              <a href="subject.html#910">[ subject ]</a>
              <a href="author.html#910">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: ral
Date: 2009-01-24 21:59:23 +0100 (Sat, 24 Jan 2009)
New Revision: 1481

Added:
   trunk/data/gfx32/st_plop_slate.png
   trunk/data/gfx40/st_plop_slate.png
   trunk/data/gfx48/st_plop_slate.png
   trunk/src/floors/ThiefFloor.cc
   trunk/src/floors/ThiefFloor.hh
   trunk/src/stones/ThiefStone.cc
   trunk/src/stones/ThiefStone.hh
Removed:
   trunk/data/gfx32/st-block.png
   trunk/data/gfx40/st-block.png
   trunk/data/gfx48/st-block.png
Modified:
   trunk/data/api1init.lua
   trunk/data/api2init.lua
   trunk/data/models-2d.lua
   trunk/data/schemas/objects.xml
   trunk/src/Makefile.am
   trunk/src/actors.hh
   trunk/src/actors/KillerActor.cc
   trunk/src/actors/KillerActor.hh
   trunk/src/floors.cc
   trunk/src/ox_extra.cc
   trunk/src/ox_magnum.cc
   trunk/src/ox_oxyd1.cc
   trunk/src/ox_peroxyd.cc
   trunk/src/stones.cc
   trunk/src/stones.hh
   trunk/src/stones/GreenBrownStone.cc
   trunk/src/stones/SimpleStones.cc
   trunk/src/stones/SimpleStones.hh
   trunk/src/stones_simple.cc
Log:
Trunk 1.1: new API reengineering
- fix st_greenbrown_movable that had been marked hollow
- fix typo on constant &quot;NNW&quot;
- reengineering of thieves:
  - st-thief -&gt; st_thief
  - fl-thief -&gt; fl_thief
  - thieves do no longer steal from rotor, top, horse, bug
  - floor thieves do steal only from actors that are on floor
- all actors can drop items
- reengineering of st-block
  - new stone class: st_plop that falls in water, swamp, abyss with a plop
  - st_plop_slate is successor of st-block


Modified: trunk/data/api1init.lua
===================================================================
--- trunk/data/api1init.lua	2009-01-24 16:16:32 UTC (rev 1480)
+++ trunk/data/api1init.lua	2009-01-24 20:59:23 UTC (rev 1481)
@@ -116,6 +116,7 @@
     fl_space = &quot;fl-space&quot;,
     fl_stone = &quot;fl-stone&quot;,
     fl_swamp = &quot;fl-swamp&quot;,
+    fl_thief = &quot;fl-thief&quot;,
     fl_tigris = &quot;fl-tigris&quot;,
     fl_trigger = &quot;fl-trigger&quot;,
     fl_water = &quot;fl-water&quot;,
@@ -394,10 +395,11 @@
     st_plaster_movable = &quot;st-rock3_move&quot;,
     st_plaster_breakable = &quot;st-rock3_break&quot;,
     st_plaster_movebreakable = &quot;st-rock3_movebreak&quot;,
-    
+    st_plop = &quot;st-block&quot;,
     st_pull = &quot;st-pull&quot;,
     st_purplegray = &quot;st-rock6&quot;,
     st_purplemarble = &quot;st-rock4&quot;,
+    
     st_puzzle = &quot;st-puzzle&quot;,
     st_puzzle_blue_w = &quot;st-puzzle-w&quot;,
     st_puzzle_blue_s = &quot;st-puzzle-s&quot;,
@@ -461,6 +463,7 @@
     st_switch = &quot;st-switch&quot;,
     st_switch_black = &quot;st-switch_black&quot;,
     st_switch_white = &quot;st-switch_white&quot;,
+    st_thief = &quot;st-thief&quot;,
     st_tigris = &quot;st-rock5&quot;,
     st_timer = &quot;st-timer&quot;,
     st_turnstile_red = &quot;st-turnstile&quot;,

Modified: trunk/data/api2init.lua
===================================================================
--- trunk/data/api2init.lua	2009-01-24 16:16:32 UTC (rev 1480)
+++ trunk/data/api2init.lua	2009-01-24 20:59:23 UTC (rev 1481)
@@ -134,7 +134,7 @@
 SSW = po(-1, 2)
 WSW = po(-2, 1)
 WNW = po(-2, -1)
-NNW = po(-2, -1)
+NNW = po(-1, -2)
 
 -- essential
 DISPENSIBLE   = 0

Deleted: trunk/data/gfx32/st-block.png
===================================================================
(Binary files differ)

Copied: trunk/data/gfx32/st_plop_slate.png (from rev 1479, trunk/data/gfx32/st-block.png)

Deleted: trunk/data/gfx40/st-block.png
===================================================================
(Binary files differ)

Copied: trunk/data/gfx40/st_plop_slate.png (from rev 1479, trunk/data/gfx40/st-block.png)

Deleted: trunk/data/gfx48/st-block.png
===================================================================
(Binary files differ)

Copied: trunk/data/gfx48/st_plop_slate.png (from rev 1479, trunk/data/gfx48/st-block.png)

Modified: trunk/data/models-2d.lua
===================================================================
--- trunk/data/models-2d.lua	2009-01-24 16:16:32 UTC (rev 1480)
+++ trunk/data/models-2d.lua	2009-01-24 20:59:23 UTC (rev 1481)
@@ -746,7 +746,7 @@
     DefStone(&quot;st-black3&quot;)
     DefStone(&quot;st-black4&quot;, &quot;sh-white4&quot;)
     DefStone(&quot;st-blackballs&quot;)
-    DefStone(&quot;st-block&quot;)
+    DefStone(&quot;st_plop_slate&quot;)
     DefStone(&quot;st_bluegray&quot;, &quot;sh-round&quot;)
     DefStone(&quot;st-brake&quot;, &quot;sh-brake&quot;)
     DefStone(&quot;st_brownie&quot;, &quot;sh-round&quot;)
@@ -1647,9 +1647,9 @@
     local f1 = BuildFrames(names, 80)
     DefAnim(&quot;pre-st-thief-emerge&quot;, f1)
     DefAnim(&quot;pre-st-thief-retreat&quot;, ReverseFrames(f1))
-    DefRoundStone(&quot;st-thief&quot;, stonebase)
-    DefRoundStone(&quot;st-thief-emerge&quot;, &quot;pre-st-thief-emerge&quot;)
-    DefRoundStone(&quot;st-thief-retreat&quot;, &quot;pre-st-thief-retreat&quot;)
+    DefRoundStone(&quot;st_thief&quot;, stonebase)
+    DefRoundStone(&quot;st_thief_emerge&quot;, &quot;pre-st-thief-emerge&quot;)
+    DefRoundStone(&quot;st_thief_retreat&quot;, &quot;pre-st-thief-retreat&quot;)
 
     -- Creating st-thief-captured
     --
@@ -1658,7 +1658,7 @@
 
     local img2 = DefSubimages(&quot;st-thief-captured&quot;, {h = 12})
     local f2 = BuildFrames(img2, 80)
-    DefAnim(&quot;st-thief-captured&quot;, f2)
+    DefAnim(&quot;st_thief_captured&quot;, f2)
 
     -- Creating fl-thief
 
@@ -1678,10 +1678,10 @@
       end
       local f3 = BuildFrames(floornames[k], 80)
       local f4 = BuildFrames(floorcaptured[k], 80)
-      DefAlias(&quot;fl-thief&quot;..k, floorbases[k])
-      DefAnim(&quot;fl-thief&quot;..k..&quot;-emerge&quot;, f3)
-      DefAnim(&quot;fl-thief&quot;..k..&quot;-retreat&quot;, ReverseFrames(f3))
-      DefAnim(&quot;fl-thief&quot;..k..&quot;-captured&quot;, f4)
+      DefAlias(&quot;fl_thief&quot;..k, floorbases[k])
+      DefAnim(&quot;fl_thief&quot;..k..&quot;_emerge&quot;, f3)
+      DefAnim(&quot;fl_thief&quot;..k..&quot;_retreat&quot;, ReverseFrames(f3))
+      DefAnim(&quot;fl_thief&quot;..k..&quot;_captured&quot;, f4)
     end
 
 --do

Modified: trunk/data/schemas/objects.xml
===================================================================
--- trunk/data/schemas/objects.xml	2009-01-24 16:16:32 UTC (rev 1480)
+++ trunk/data/schemas/objects.xml	2009-01-24 20:59:23 UTC (rev 1481)
@@ -335,6 +335,9 @@
       &lt;attr name=&quot;adhesion&quot; default=&quot;1.0&quot;/&gt;
       &lt;attr name=&quot;$heattransform&quot; default=&quot;fl_dunes&quot;/&gt;
     &lt;/object&gt;
+    &lt;object name=&quot;fl_thief&quot;&gt;
+      &lt;msg name=&quot;_capture&quot;/&gt;
+    &lt;/object&gt;
     &lt;object name=&quot;fl_water&quot; super=&quot;fl_floodstream&quot;&gt;
       &lt;attr name=&quot;friction&quot; default=&quot;5.0&quot;/&gt;
       &lt;attr name=&quot;adhesion&quot; default=&quot;1.0&quot;/&gt;
@@ -1328,6 +1331,8 @@
       &lt;attr name=&quot;movable&quot; value=&quot;true&quot;/&gt;
       &lt;attr name=&quot;breakable&quot; value=&quot;true&quot;/&gt;
     &lt;/object&gt;
+    &lt;object name=&quot;st_plop&quot;/&gt;
+    &lt;object name=&quot;st_plop_slate&quot; init=&quot;true&quot;/&gt;
     &lt;object name=&quot;st_polarswitch&quot;&gt;
       &lt;msg name=&quot;on&quot;/&gt;
       &lt;msg name=&quot;off&quot;/&gt;
@@ -1470,6 +1475,9 @@
     &lt;object name=&quot;st_switch_white&quot;&gt;
       &lt;attr name=&quot;color&quot; value=&quot;1&quot;/&gt;
     &lt;/object&gt;
+    &lt;object name=&quot;st_thief&quot;&gt;
+      &lt;msg name=&quot;_capture&quot;/&gt;
+    &lt;/object&gt;
     &lt;object name=&quot;st_tigris&quot;/&gt;
     &lt;object name=&quot;st_timer&quot;&gt;
       &lt;attr name=&quot;invisible&quot;/&gt;

Modified: trunk/src/Makefile.am
===================================================================
--- trunk/src/Makefile.am	2009-01-24 16:16:32 UTC (rev 1480)
+++ trunk/src/Makefile.am	2009-01-24 20:59:23 UTC (rev 1481)
@@ -160,6 +160,8 @@
 	floors/FloodStream.hh	\
 	floors/SimpleFloors.cc	\
 	floors/SimpleFloors.hh	\
+	floors/ThiefFloor.cc	\
+	floors/ThiefFloor.hh	\
 	gui/ErrorMenu.cc	\
 	gui/ErrorMenu.hh	\
 	gui/GameMenu.cc		\
@@ -348,6 +350,8 @@
 	stones/SwapStone.hh	\
 	stones/Switch.cc	\
 	stones/Switch.hh	\
+	stones/ThiefStone.cc	\
+	stones/ThiefStone.hh	\
 	stones/TimerStone.cc	\
 	stones/TimerStone.hh	\
 	stones/Turnstile.cc	\

Modified: trunk/src/actors/KillerActor.cc
===================================================================
--- trunk/src/actors/KillerActor.cc	2009-01-24 16:16:32 UTC (rev 1480)
+++ trunk/src/actors/KillerActor.cc	2009-01-24 20:59:23 UTC (rev 1481)
@@ -44,6 +44,10 @@
     bool Killer::is_dead() const {
         return false;
     }
+    
+    bool Killer::has_shield() const {
+        return false;
+    }
 
     void Killer::on_collision(Actor *a) {
         SendMessage(a, &quot;_shatter&quot;);

Modified: trunk/src/actors/KillerActor.hh
===================================================================
--- trunk/src/actors/KillerActor.hh	2009-01-24 16:16:32 UTC (rev 1480)
+++ trunk/src/actors/KillerActor.hh	2009-01-24 20:59:23 UTC (rev 1481)
@@ -41,6 +41,7 @@
 
         // Actor interface
         virtual bool is_dead() const;
+        virtual bool has_shield() const;
         virtual void on_collision(Actor *a);
     };
 

Modified: trunk/src/actors.hh
===================================================================
--- trunk/src/actors.hh	2009-01-24 16:16:32 UTC (rev 1480)
+++ trunk/src/actors.hh	2009-01-24 20:59:23 UTC (rev 1481)
@@ -138,10 +138,10 @@
         virtual bool is_drunken() const { return false; }
         virtual bool is_invisible() const { return false; }
 
-        virtual bool can_drop_items() const { return false; }
+        virtual bool can_drop_items() const { return true; }
         virtual bool can_move() const;
         virtual bool can_be_warped() const { return false; }
-        virtual bool has_shield() const { return false; }
+        virtual bool has_shield() const { return true; }
 
         virtual void init();
 

Added: trunk/src/floors/ThiefFloor.cc
===================================================================
--- trunk/src/floors/ThiefFloor.cc	2009-01-24 16:16:32 UTC (rev 1480)
+++ trunk/src/floors/ThiefFloor.cc	2009-01-24 20:59:23 UTC (rev 1481)
@@ -0,0 +1,158 @@
+/*
+ * Copyright (C) 2007 Andreas Lochmann
+ * Copyright (C) 2007 Raoul Bourquin
+ * Copyright (C) 2009 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *  
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include &quot;floors/ThiefFloor.hh&quot;
+#include &quot;errors.hh&quot;
+#include &quot;Inventory.hh&quot;
+#include &quot;items/GlassesItem.hh&quot;
+#include &quot;player.hh&quot;
+#include &quot;world.hh&quot;
+//#include &quot;main.hh&quot;
+
+namespace enigma {
+    ThiefFloor::ThiefFloor() : Floor(&quot;fl_thief&quot;, 2.0, 1), victimId (0), bag (NULL) {
+        
+    }
+    
+    ThiefFloor::~ThiefFloor() {
+        if (bag != NULL)
+            delete bag;
+    }
+
+    std::string ThiefFloor::getClass() const {
+        return &quot;fl_thief&quot;;
+    }
+    
+    Value ThiefFloor::message(const Message &amp;m) {
+        if (m.message == &quot;_capture&quot; &amp;&amp; state == IDLE &amp;&amp; isDisplayable()) {            
+            // add items on grid pos that can be picked up to our bag
+            Item * it =  GetItem(get_pos());
+            if (it != NULL &amp;&amp; !(it-&gt;get_traits().flags &amp; itf_static) &amp;&amp; bag != NULL) {
+                dynamic_cast&lt;ItemHolder *&gt;(bag)-&gt;add_item(YieldItem(get_pos()));
+            }
+            // drop bag if pos is not occupied by a static item
+            if (GetItem(get_pos()) == NULL) {
+                SetItem(get_pos(), bag);
+                bag = NULL;
+            }
+            state = CAPTURED;
+            init_model();
+            return true;
+        }
+        return Floor::message(m);
+    }
+   
+    void ThiefFloor::setState(int extState) {
+        // block all state writes
+    }
+    
+    void ThiefFloor::on_creation(GridPos p) {
+        objFlags |= (IntegerRand(0, 3) &lt;&lt; 24);
+        Floor::on_creation(p);
+    }
+    
+    void ThiefFloor::init_model() {
+        std::string basename = ecl::strf(&quot;fl_thief%d&quot;, ((objFlags &amp; OBJBIT_MODEL) &gt;&gt; 24) + 1);
+        switch (state) {
+            case IDLE:
+                set_model(basename); 
+                break;
+            case EMERGING:
+                set_anim(basename + &quot;_emerge&quot;);
+                break;
+            case RETREATING:
+                set_anim(basename + &quot;_retreat&quot;);
+                break;
+            case CAPTURED:
+                set_anim(basename + &quot;_captured&quot;);
+                break;
+        }
+    }
+    
+    void ThiefFloor::actor_enter(Actor *a) {
+        if (state == IDLE &amp;&amp; a-&gt;is_on_floor()) {
+            state = EMERGING;
+            victimId = a-&gt;getId();
+            init_model();
+        }
+    }
+
+    void ThiefFloor::animcb() {
+        switch (state) {
+            case EMERGING:
+                doSteal();
+                state = RETREATING;
+                init_model();
+                break;
+            case RETREATING:
+                state = IDLE;
+                init_model();
+                break;
+            case CAPTURED:
+                KillStone(get_pos());
+                break;
+            default:
+                ASSERT(0, XLevelRuntime, &quot;ThiefFloor: animcb called with inconsistent state&quot;);
+        }
+    }
+
+    void ThiefFloor::doSteal() {
+        bool didSteal = false;
+        
+        // the actor that hit the thief may no longer exist!
+        if (Actor *victim = dynamic_cast&lt;Actor *&gt;(Object::getObject(victimId))) {
+            if (Value owner = victim-&gt;getAttr(&quot;owner&quot;)) {
+                if (!(victim-&gt;has_shield())) {
+                    enigma::Inventory *inv = player::GetInventory(owner);
+                    if (inv &amp;&amp; inv-&gt;size() &gt; 0) {
+                        if (bag == NULL) {
+                            bag = MakeItem(&quot;it-bag&quot;);
+                            bag-&gt;setOwnerPos(get_pos());
+                        }
+                        int i = IntegerRand(0, int (inv-&gt;size()-1));
+                        dynamic_cast&lt;ItemHolder *&gt;(bag)-&gt;add_item(inv-&gt;yield_item(i));
+                        didSteal = true;
+                        Glasses::updateGlasses();
+                        player::RedrawInventory(inv);
+                    }
+                }
+            }
+        }
+        // steal from grid
+        if(Item *it = GetItem(get_pos())) {
+            if (!(it-&gt;get_traits().flags &amp; itf_static)) {
+                if (bag == NULL) {
+                    bag = MakeItem(&quot;it-bag&quot;);
+                    bag-&gt;setOwnerPos(get_pos());                
+                }
+                dynamic_cast&lt;ItemHolder *&gt;(bag)-&gt;add_item(YieldItem(get_pos()));
+                didSteal = true;
+            }
+        }
+        if (didSteal)
+            sound_event(&quot;thief&quot;);
+    }
+        
+    BOOT_REGISTER_START
+        BootRegister(new ThiefFloor(), &quot;fl_thief&quot;);
+    BOOT_REGISTER_END
+
+} // namespace enigma


Property changes on: trunk/src/floors/ThiefFloor.cc
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/floors/ThiefFloor.hh
===================================================================
--- trunk/src/floors/ThiefFloor.hh	2009-01-24 16:16:32 UTC (rev 1480)
+++ trunk/src/floors/ThiefFloor.hh	2009-01-24 20:59:23 UTC (rev 1481)
@@ -0,0 +1,75 @@
+/*
+ * Copyright (C) 2007 Andreas Lochmann
+ * Copyright (C) 2007 Raoul Bourquin
+ * Copyright (C) 2009 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef THIEFFLOOR_HH
+#define THIEFFLOOR_HH
+
+#include &quot;floors.hh&quot;
+
+namespace enigma {
+
+    /** 
+     * 
+     */
+    class ThiefFloor : public Floor {
+        CLONEOBJ(ThiefFloor);
+        
+    private:
+        enum iState {
+            IDLE,         ///&lt; 
+            EMERGING,     ///&lt; 
+            RETREATING,   ///&lt; 
+            CAPTURED      ///&lt; 
+        };
+        
+        enum ObjectPrivatFlagsBits {
+            OBJBIT_MODEL =   2&lt;&lt;24,   ///&lt; 
+        };
+
+    public:
+        ThiefFloor();
+        ~ThiefFloor();
+
+        // Object interface
+        virtual std::string getClass() const;
+        virtual Value message(const Message &amp;m);
+        
+        // StateObject interface
+        virtual void setState(int extState);
+
+        // GridObject interface
+        virtual void init_model();
+        virtual void on_creation(GridPos p);
+        virtual void actor_enter(Actor *a);
+                
+        // ModelCallback interface  - Animation callback
+        virtual void animcb();
+
+    private:
+        int victimId;
+        Item  *bag;
+        
+        // Private methods.
+        void doSteal();
+    };
+
+} // namespace enigma
+
+#endif


Property changes on: trunk/src/floors/ThiefFloor.hh
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/src/floors.cc
===================================================================
--- trunk/src/floors.cc	2009-01-24 16:16:32 UTC (rev 1480)
+++ trunk/src/floors.cc	2009-01-24 20:59:23 UTC (rev 1481)
@@ -613,140 +613,11 @@
 }
 
 
-/* -------------------- Thief Floor -------------------- */
-namespace{
-    class Thief : public Floor {
-        CLONEOBJ(Thief);
-    public:
-        Thief();
-        ~Thief();
-    private:
-        string modelname;
-        enum State { IDLE, EMERGING, RETREATING, CAPTURED } state;
-        Actor *m_affected_actor;
-        int affected_player;
-        Item *bag;
-        string get_modelname();
-        void init_model();
-        void actor_enter(Actor* a);
-        void animcb();
-        void steal();
-        virtual Value message(const Message &amp;m);        
-    };
-}
 
-Thief::Thief() : Floor(&quot;fl-thief&quot;, 2.0, 1), state(IDLE), m_affected_actor (0),
-        affected_player (-1), modelname(&quot;&quot;), bag(NULL) {
-}
-
-Thief::~Thief() {
-    if (bag != NULL)
-        delete bag;
-}
-
-string Thief::get_modelname() {
-    if(modelname == &quot;&quot;) {
-        // initialize on first call
-        modelname = ecl::strf(&quot;fl-thief%d&quot;, IntegerRand(1, 4));
-    }
-    return modelname;
-}
-
-void Thief::init_model() {
-    set_model(get_modelname());
-}
-
-void Thief::actor_enter(Actor *a) {
-    ActorID id = get_id(a);
-    if (state == IDLE) {
-        set_anim(get_modelname() + string(&quot;-emerge&quot;));
-        state = EMERGING;
-        m_affected_actor = a;
-        affected_player = -1;
-        if (Value v = m_affected_actor-&gt;getAttr(&quot;owner&quot;)) affected_player = v;
-    }
-}
-
-void Thief::animcb() {
-    switch (state) {
-    case EMERGING:
-        steal();
-        state = RETREATING;
-        set_anim(get_modelname() + string(&quot;-retreat&quot;));
-        break;
-    case RETREATING:
-        state = IDLE;
-        init_model();
-        break;
-    case CAPTURED:
-        // Floor is not killed or replaced - it just keeps inactive.
-        init_model();
-        break;
-    default:
-        ASSERT(0, XLevelRuntime, &quot;Thief (floor): animcb called with inconsistent state&quot;);
-    }
-}
-
-void Thief::steal() 
-{
-    bool didSteal = false;
-    // steal from player -- the actor that hit the thief may no longer exist!
-    if (m_affected_actor &amp;&amp; affected_player &gt;= 0 &amp;&amp;
-            player::HasActor(affected_player, m_affected_actor) &amp;&amp; 
-            !m_affected_actor-&gt;has_shield()) {
-        enigma::Inventory *inv = player::GetInventory(m_affected_actor);
-        if (inv &amp;&amp; inv-&gt;size() &gt; 0) {
-            if (bag == NULL) {
-                bag = MakeItem(&quot;it-bag&quot;);
-                bag-&gt;setOwnerPos(get_pos());
-            }
-            int i = IntegerRand (0, int (inv-&gt;size()-1));
-            dynamic_cast&lt;ItemHolder *&gt;(bag)-&gt;add_item(inv-&gt;yield_item(i));
-            Glasses::updateGlasses();
-            player::RedrawInventory (inv);
-            didSteal = true;
-        }
-    }
-    // steal from grid
-    if(Item *it = GetItem(get_pos())) {
-        if (!(it-&gt;get_traits().flags &amp; itf_static)) {
-            if (bag == NULL) {
-                bag = MakeItem(&quot;it-bag&quot;);
-                bag-&gt;setOwnerPos(get_pos());                
-            }
-            dynamic_cast&lt;ItemHolder *&gt;(bag)-&gt;add_item(YieldItem(get_pos()));
-            didSteal = true;
-        }
-    }
-    if (didSteal)
-        sound_event(&quot;thief&quot;);
-}
-
-Value Thief::message(const Message &amp;m) {
-    if(m.message == &quot;_capture&quot; &amp;&amp; state == IDLE) {
-        state = CAPTURED;
-        Item * it =  GetItem(get_pos());
-        
-        // add items on grid pos that can be picked up to our bag
-        if (it != NULL &amp;&amp; !(it-&gt;get_traits().flags &amp; itf_static) &amp;&amp; bag != NULL) {
-            dynamic_cast&lt;ItemHolder *&gt;(bag)-&gt;add_item(YieldItem(get_pos()));
-        }
-        // drop bag if pos is not occupied by a static item
-        if (GetItem(get_pos()) == NULL)
-            SetItem(get_pos(), bag);
-        bag = NULL;
-        set_anim(get_modelname() + string(&quot;-captured&quot;));
-        return true;
-    }
-    return Floor::message(m);
-}
-
-
 void InitFloors()
 {
     // Floors (most floors are defined in init.lua)
     Register(new DummyFloor);
-    Register(new Thief);
 
     Register(new Gradient);
     Register(&quot;fl-gradient1&quot;, new Gradient(1));

Modified: trunk/src/ox_extra.cc
===================================================================
--- trunk/src/ox_extra.cc	2009-01-24 16:16:32 UTC (rev 1480)
+++ trunk/src/ox_extra.cc	2009-01-24 20:59:23 UTC (rev 1481)
@@ -217,7 +217,7 @@
     UNUSED,              // OxydExtra stone 0x62
     UNUSED,              // OxydExtra stone 0x63
     &quot;st_coinslot_instant&quot;, // OxydExtra stone 0x64
-    &quot;st-thief&quot;,          // OxydExtra stone 0x65
+    &quot;st_thief&quot;,          // OxydExtra stone 0x65
     &quot;st_shogun_s&quot;,       // OxydExtra stone 0x66
     UNUSED,              // OxydExtra stone 0x67
     UNUSED,              // OxydExtra stone 0x68

Modified: trunk/src/ox_magnum.cc
===================================================================
--- trunk/src/ox_magnum.cc	2009-01-24 16:16:32 UTC (rev 1480)
+++ trunk/src/ox_magnum.cc	2009-01-24 20:59:23 UTC (rev 1481)
@@ -223,7 +223,7 @@
     &quot;st-bombs&quot;,                 // OxydMagnum stone 0x68 (common was 'st-shogun-l')
     &quot;st-flash&quot;,                 // OxydMagnum stone 0x69
     &quot;st_coinslot_instant&quot;,      // OxydMagnum stone 0x6a
-    &quot;st-thief&quot;,                 // OxydMagnum stone 0x6b
+    &quot;st_thief&quot;,                 // OxydMagnum stone 0x6b
     &quot;st_shogun_s&quot;,              // OxydMagnum stone 0x6c
     &quot;st_stoneimpulse&quot;,          // OxydMagnum stone 0x6d
     &quot;st_laserflop&quot;,             // OxydMagnum stone 0x6e

Modified: trunk/src/ox_oxyd1.cc
===================================================================
--- trunk/src/ox_oxyd1.cc	2009-01-24 16:16:32 UTC (rev 1480)
+++ trunk/src/ox_oxyd1.cc	2009-01-24 20:59:23 UTC (rev 1481)
@@ -255,7 +255,7 @@
     &quot;st-bombs&quot;,                 // Oxyd1 stone 0x68
     &quot;st-flash&quot;,                 // Oxyd1 stone 0x69
     &quot;st_coinslot_instant&quot;,      // Oxyd1 stone 0x6a
-    &quot;st-thief&quot;,                 // Oxyd1 stone 0x6b
+    &quot;st_thief&quot;,                 // Oxyd1 stone 0x6b
     &quot;st_shogun_s&quot;,              // Oxyd1 stone 0x6c
     &quot;st_stoneimpulse&quot;,          // Oxyd1 stone 0x6d
     &quot;st_laserflop&quot;,             // Oxyd1 stone 0x6e

Modified: trunk/src/ox_peroxyd.cc
===================================================================
--- trunk/src/ox_peroxyd.cc	2009-01-24 16:16:32 UTC (rev 1480)
+++ trunk/src/ox_peroxyd.cc	2009-01-24 20:59:23 UTC (rev 1481)
@@ -289,7 +289,7 @@
     &quot;st-bombs&quot;,                 // PerOxyd stone 0x62
     &quot;st_flash&quot;,                 // PerOxyd stone 0x63
     &quot;st_coinslot_instant&quot;,      // PerOxyd stone 0x64
-    &quot;st-thief&quot;,                 // PerOxyd stone 0x65
+    &quot;st_thief&quot;,                 // PerOxyd stone 0x65
     &quot;st_shogun_s&quot;,              // PerOxyd stone 0x66
     &quot;st_shogun_m&quot;,              // PerOxyd stone 0x67
     &quot;st_shogun_l&quot;,              // PerOxyd stone 0x68

Modified: trunk/src/stones/GreenBrownStone.cc
===================================================================
--- trunk/src/stones/GreenBrownStone.cc	2009-01-24 16:16:32 UTC (rev 1480)
+++ trunk/src/stones/GreenBrownStone.cc	2009-01-24 20:59:23 UTC (rev 1481)
@@ -124,7 +124,7 @@
     BOOT_REGISTER_START
         BootRegister(new GreenBrownStone(false, false), &quot;st_greenbrown&quot;);
         BootRegister(new GreenBrownStone(true, false),  &quot;st_greenbrown_hollow&quot;);
-        BootRegister(new GreenBrownStone(true, true),  &quot;st_greenbrown_movable&quot;);
+        BootRegister(new GreenBrownStone(false, true),  &quot;st_greenbrown_movable&quot;);
         BootRegister(new GreenBrownStone(false, false, true),  &quot;st_greenbrown_growing&quot;);
     BOOT_REGISTER_END
 

Modified: trunk/src/stones/SimpleStones.cc
===================================================================
--- trunk/src/stones/SimpleStones.cc	2009-01-24 16:16:32 UTC (rev 1480)
+++ trunk/src/stones/SimpleStones.cc	2009-01-24 20:59:23 UTC (rev 1481)
@@ -20,6 +20,7 @@
  */
 
 #include &quot;stones/SimpleStones.hh&quot;
+#include &quot;client.hh&quot;
 #include &quot;errors.hh&quot;
 //#include &quot;main.hh&quot;
 #include &quot;player.hh&quot;
@@ -191,6 +192,33 @@
             return sc.actor-&gt;is_on_floor() ? STONE_PASS : STONE_REBOUND;
     }
     
+/* -------------------- Plop stone -------------------- */
+    PlopStone::PlopStone() : Stone () {
+    }
+    
+    std::string PlopStone::getClass() const {
+        return &quot;st_plop&quot;;
+    }
+        
+    void PlopStone::init_model() {
+        set_model(&quot;st_plop_slate&quot;);
+    }
+    
+    void PlopStone::on_floor_change() {
+        if (Floor *fl = GetFloor(get_pos())) {
+            const std::string &amp;k = fl-&gt;get_kind();
+            if (k==&quot;fl_water&quot; || k==&quot;fl_abyss&quot; || k == &quot;fl_swamp&quot;) {
+                sound_event(&quot;drown&quot;);
+                client::Msg_Sparkle(get_pos().center());
+                KillStone(get_pos());
+            }
+        }
+    }
+    
+    DEF_TRAITSM(PlopStone, &quot;st_plop&quot;, st_plop, MOVABLE_STANDARD);
+
+
+
     BOOT_REGISTER_START
         BootRegister(new BlurStone(0), &quot;st_blur&quot;);
         BootRegister(new BlurStone(0), &quot;st_blur_straight&quot;);
@@ -204,6 +232,8 @@
         BootRegister(new GrateStone(0), &quot;st_grate&quot;);
         BootRegister(new GrateStone(0), &quot;st_grate_cross&quot;);
         BootRegister(new GrateStone(1), &quot;st_grate_framed&quot;);
+        BootRegister(new PlopStone(), &quot;st_plop&quot;);
+        BootRegister(new PlopStone(), &quot;st_plop_slate&quot;);
     BOOT_REGISTER_END
 
 } // namespace enigma

Modified: trunk/src/stones/SimpleStones.hh
===================================================================
--- trunk/src/stones/SimpleStones.hh	2009-01-24 16:16:32 UTC (rev 1480)
+++ trunk/src/stones/SimpleStones.hh	2009-01-24 20:59:23 UTC (rev 1481)
@@ -127,6 +127,24 @@
         virtual StoneResponse collision_response(const StoneContact &amp;sc);
     };
 
+    /** 
+     * PlopStone
+     */
+   class PlopStone : public Stone {
+        CLONEOBJ(PlopStone);
+        DECL_TRAITS;
+    public:
+        PlopStone();
+        
+         // Object interface
+        virtual std::string getClass() const;        
+        
+        // GridObject interface
+        virtual void init_model();
+        
+        // Stone interface
+        virtual void on_floor_change();
+   };
 } // namespace enigma
 
 #endif /*SIMPLESTONES_HH*/

Added: trunk/src/stones/ThiefStone.cc
===================================================================
--- trunk/src/stones/ThiefStone.cc	2009-01-24 16:16:32 UTC (rev 1480)
+++ trunk/src/stones/ThiefStone.cc	2009-01-24 20:59:23 UTC (rev 1481)
@@ -0,0 +1,149 @@
+/*
+ * Copyright (C) 2007 Andreas Lochmann
+ * Copyright (C) 2009 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *  
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include &quot;stones/ThiefStone.hh&quot;
+#include &quot;errors.hh&quot;
+#include &quot;Inventory.hh&quot;
+#include &quot;items/GlassesItem.hh&quot;
+#include &quot;player.hh&quot;
+#include &quot;world.hh&quot;
+//#include &quot;main.hh&quot;
+
+namespace enigma {
+    ThiefStone::ThiefStone() : Stone(), victimId (0), bag (NULL) {
+        
+    }
+    
+    ThiefStone::~ThiefStone() {
+        if (bag != NULL)
+            delete bag;
+    }
+
+    std::string ThiefStone::getClass() const {
+        return &quot;st_thief&quot;;
+    }
+    
+    Value ThiefStone::message(const Message &amp;m) {
+        if (m.message == &quot;signal&quot; &amp;&amp; server::GameCompatibility != GAMET_ENIGMA) {
+            performAction(!m.value.to_bool());  // inverse signal multiplier
+            return Value();
+        } else if (m.message == &quot;_capture&quot; &amp;&amp; state == IDLE &amp;&amp; isDisplayable()) {            
+            // add items on grid pos that can be picked up to our bag
+            Item * it =  GetItem(get_pos());
+            if (it != NULL &amp;&amp; !(it-&gt;get_traits().flags &amp; itf_static) &amp;&amp; bag != NULL) {
+                dynamic_cast&lt;ItemHolder *&gt;(bag)-&gt;add_item(YieldItem(get_pos()));
+            }
+            // drop bag if pos is not occupied by a static item
+            if (GetItem(get_pos()) == NULL) {
+                SetItem(get_pos(), bag);
+                bag = NULL;
+            }
+            state = CAPTURED;
+            init_model();
+            return true;
+        }
+        return Stone::message(m);
+    }
+   
+    void ThiefStone::setState(int extState) {
+        // block all state writes
+    }
+    
+    void ThiefStone::init_model() {
+        switch (state) {
+            case IDLE:
+                set_model(&quot;st_thief&quot;); 
+                break;
+            case EMERGING:
+                set_anim(&quot;st_thief_emerge&quot;);
+                break;
+            case RETREATING:
+                set_anim(&quot;st_thief_retreat&quot;);
+                break;
+            case CAPTURED:
+                set_anim(&quot;st_thief_captured&quot;);
+                break;
+        }
+    }
+    
+    void ThiefStone::animcb() {
+        switch (state) {
+            case EMERGING:
+                doSteal();
+                state = RETREATING;
+                init_model();
+                break;
+            case RETREATING:
+                state = IDLE;
+                init_model();
+                break;
+            case CAPTURED:
+                KillStone(get_pos());
+                break;
+            default:
+                ASSERT(0, XLevelRuntime, &quot;ThiefStone: animcb called with inconsistent state&quot;);
+        }
+    }
+
+    const char *ThiefStone::collision_sound() {
+        return &quot;cloth&quot;;
+    }
+    
+    void ThiefStone::actor_touch(const StoneContact &amp;sc) {
+        actor_hit(sc);   // even a slight touch should steal from the actor:
+    }
+    
+    void ThiefStone::actor_hit(const StoneContact &amp;sc) {
+        if (state == IDLE) {
+            state = EMERGING;
+            victimId = sc.actor-&gt;getId();
+            init_model();
+        }
+    }
+
+    void ThiefStone::doSteal() {
+        // the actor that hit the thief may no longer exist!
+        if (Actor *victim = dynamic_cast&lt;Actor *&gt;(Object::getObject(victimId))) {
+            if (Value owner = victim-&gt;getAttr(&quot;owner&quot;)) {
+                if (!(victim-&gt;has_shield())) {
+                    enigma::Inventory *inv = player::GetInventory(owner);
+                    if (inv &amp;&amp; inv-&gt;size() &gt; 0) {
+                        if (bag == NULL) {
+                            bag = MakeItem(&quot;it-bag&quot;);
+                            bag-&gt;setOwnerPos(get_pos());
+                        }
+                        int i = IntegerRand(0, int (inv-&gt;size()-1));
+                        dynamic_cast&lt;ItemHolder *&gt;(bag)-&gt;add_item(inv-&gt;yield_item(i));
+                        Glasses::updateGlasses();
+                        player::RedrawInventory(inv);
+                        sound_event(&quot;thief&quot;);
+                    }
+                }
+            }
+        }
+    }
+    
+    DEF_TRAITSM(ThiefStone, &quot;st_thief&quot;, st_thief, MOVABLE_BREAKABLE);
+    
+    BOOT_REGISTER_START
+        BootRegister(new ThiefStone(), &quot;st_thief&quot;);
+    BOOT_REGISTER_END
+
+} // namespace enigma


Property changes on: trunk/src/stones/ThiefStone.cc
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/stones/ThiefStone.hh
===================================================================
--- trunk/src/stones/ThiefStone.hh	2009-01-24 16:16:32 UTC (rev 1480)
+++ trunk/src/stones/ThiefStone.hh	2009-01-24 20:59:23 UTC (rev 1481)
@@ -0,0 +1,75 @@
+/*
+ * Copyright (C) 2009 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef THIEFSTONE_HH
+#define THIEFSTONE_HH
+
+#include &quot;stones.hh&quot;
+
+#include &quot;stones_internal.hh&quot;
+
+namespace enigma {
+
+    /** 
+     * 
+     */
+    class ThiefStone : public Stone {
+        CLONEOBJ(ThiefStone);
+        DECL_TRAITS;
+        
+    private:
+        enum iState {
+            IDLE,         ///&lt; 
+            EMERGING,     ///&lt; 
+            RETREATING,   ///&lt; 
+            CAPTURED      ///&lt; 
+        };
+        
+    public:
+        ThiefStone();
+        ~ThiefStone();
+        
+        // Object interface
+        virtual std::string getClass() const;        
+//        virtual Value getAttr(const std::string &amp;key) const;
+        virtual Value message(const Message &amp;m);
+        
+        // StateObject interface
+        virtual void setState(int extState);
+
+        // GridObject interface
+        virtual void init_model();
+        
+        // ModelCallback interface
+        virtual void animcb();
+        
+        // Stone interface
+        virtual const char *collision_sound();
+        virtual void actor_touch(const StoneContact &amp;sc);
+        virtual void actor_hit(const StoneContact &amp;sc);
+
+    private:
+        int victimId;
+        Item  *bag;
+        
+        void doSteal();
+    };
+
+} // namespace enigma
+
+#endif


Property changes on: trunk/src/stones/ThiefStone.hh
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/src/stones.cc
===================================================================
--- trunk/src/stones.cc	2009-01-24 16:16:32 UTC (rev 1480)
+++ trunk/src/stones.cc	2009-01-24 20:59:23 UTC (rev 1481)
@@ -425,7 +425,7 @@
                 &quot;st_lightglass_hollow&quot;,
                 &quot;st-magic&quot;,
                 &quot;st_knight&quot;,
-                &quot;st-thief&quot;,
+                &quot;st_thief&quot;,
                 &quot;st_flat_breakable&quot;,
                 &quot;st_flat_breaking&quot;
             };

Modified: trunk/src/stones.hh
===================================================================
--- trunk/src/stones.hh	2009-01-24 16:16:32 UTC (rev 1480)
+++ trunk/src/stones.hh	2009-01-24 20:59:23 UTC (rev 1481)
@@ -40,7 +40,6 @@
         st_passage_black_slash,
         st_passage_black_cross,
         st_passage_black_frame,
-        st_block,
         st_boulder,
         st_brake,
         st_break_black,
@@ -73,6 +72,7 @@
         st_oxyd_0x18,
         st_peroxyd_0xb8,
         st_peroxyd_0xb9,
+        st_plop,
         st_pull,
         st_puzzle,
         st_rotator,

Modified: trunk/src/stones_simple.cc
===================================================================
--- trunk/src/stones_simple.cc	2009-01-24 16:16:32 UTC (rev 1480)
+++ trunk/src/stones_simple.cc	2009-01-24 20:59:23 UTC (rev 1481)
@@ -176,36 +176,6 @@
     DEF_TRAITS(ChameleonStone, &quot;st-chameleon&quot;, st_chameleon);
 }
 
-/* -------------------- BlockStone -------------------- */
-
-namespace
-{
-    class BlockStone : public Stone {
-        CLONEOBJ(BlockStone);
-        DECL_TRAITS;
-    public:
-        BlockStone()
-        {}
-    private:
-        V2 get_center() const {
-            return get_pos().center();
-        }
-
-        void on_floor_change() {
-            if (Floor *fl=GetFloor(get_pos())) {
-                const string &amp;k = fl-&gt;get_kind();
-                if (k==&quot;fl_water&quot; || k==&quot;fl_abyss&quot; || k == &quot;fl_swamp&quot;) {
-                    client::Msg_Sparkle (get_center());
-                    KillStone(get_pos());
-                }
-            }
-        }
-    };
-    DEF_TRAITSM(BlockStone, &quot;st-block&quot;, st_block, MOVABLE_STANDARD);
-    
-};
-
-
 /* -------------------- BrickMagic -------------------- */
 
 /** \page st-brick_magic Magic Brick Stone
@@ -373,116 +343,6 @@
     };
 }
 
-
-/* -------------------- Thief -------------------- */
-namespace
-{
-    /*! Steals one item from the player's inventory when hit. */
-    class ThiefStone : public Stone {
-        CLONEOBJ(ThiefStone);
-        DECL_TRAITS;
-
-        enum State { IDLE, EMERGING, RETREATING, CAPTURED } state;
-        Actor *m_affected_actor;
-        Item * bag;
-    public:
-        ThiefStone();
-        virtual ~ThiefStone();
-    private:
-        void steal_from_player();
-
-        void actor_hit(const StoneContact &amp;sc);
-        // even a slight touch should steal from the actor: 
-        void actor_touch(const StoneContact &amp;sc) { actor_hit(sc); }
-        void animcb();
-        virtual Value message(const Message &amp;m);        
-
-        const char *collision_sound() { return &quot;cloth&quot;; }
-        int affected_player;
-    };
-    DEF_TRAITSM(ThiefStone, &quot;st-thief&quot;, st_thief, MOVABLE_BREAKABLE);
-}
-
-ThiefStone::ThiefStone() 
-: state(IDLE), m_affected_actor (0), affected_player (-1), bag(NULL) {}
-
-ThiefStone::~ThiefStone() {
-    if (bag != NULL)
-        delete bag;
-}
-
-void ThiefStone::actor_hit(const StoneContact &amp;sc) {
-    ActorID id = get_id(sc.actor);
-    if (state == IDLE) {
-        set_anim(&quot;st-thief-emerge&quot;);
-        state = EMERGING;
-        m_affected_actor = sc.actor;
-        affected_player = m_affected_actor-&gt;getDefaultedAttr(&quot;owner&quot;, -1);
-    }
-}
-
-void ThiefStone::animcb() {
-    switch (state) {
-    case EMERGING:
-        steal_from_player();
-        state = RETREATING;
-        set_anim(&quot;st-thief-retreat&quot;);
-        break;
-    case RETREATING:
-        state = IDLE;
-        init_model();
-        break;
-    case CAPTURED:
-        KillStone(get_pos());
-        break;
-    default:
-        ASSERT(0, XLevelRuntime, &quot;ThiefStone: animcb called with inconsistent state&quot;);
-    }
-}
-
-void ThiefStone::steal_from_player() 
-{
-    // the actor that hit the thief may no longer exist!
-    if (m_affected_actor &amp;&amp; affected_player &gt;= 0 &amp;&amp;
-            player::HasActor(affected_player, m_affected_actor) &amp;&amp; 
-            !m_affected_actor-&gt;has_shield()) {
-        enigma::Inventory *inv = player::GetInventory(m_affected_actor);
-        if (inv &amp;&amp; inv-&gt;size() &gt; 0) {
-            if (bag == NULL) {
-                bag = MakeItem(&quot;it-bag&quot;);
-                bag-&gt;setOwnerPos(get_pos());
-            }
-            int i = IntegerRand (0, int (inv-&gt;size()-1));
-            dynamic_cast&lt;ItemHolder *&gt;(bag)-&gt;add_item(inv-&gt;yield_item(i));
-            Glasses::updateGlasses();
-            player::RedrawInventory (inv);
-            sound_event(&quot;thief&quot;);
-        }
-    }
-}
-
-Value ThiefStone::message(const Message &amp;m) {
-    if(m.message == &quot;signal&quot; &amp;&amp; server::GameCompatibility != GAMET_ENIGMA) {
-        performAction(!m.value.to_bool());  // inverse signal multiplier
-        return Value();
-    } else if (m.message == &quot;_capture&quot; &amp;&amp; state == IDLE) {
-        state = CAPTURED;
-        Item * it =  GetItem(get_pos());
-        
-        // add items on grid pos that can be picked up to our bag
-        if (it != NULL &amp;&amp; !(it-&gt;get_traits().flags &amp; itf_static) &amp;&amp; bag != NULL) {
-            dynamic_cast&lt;ItemHolder *&gt;(bag)-&gt;add_item(YieldItem(get_pos()));
-        }
-        // drop bag if pos is not occupied by a static item
-        if (GetItem(get_pos()) == NULL)
-            SetItem(get_pos(), bag);
-        bag = NULL;
-        set_anim(string(get_kind()) + &quot;-captured&quot;);
-        return true;
-    }
-    return Stone::message(m);
-}
-
 /* -------------------- BombStone -------------------- */
 
 namespace
@@ -576,7 +436,6 @@
 
 void Init_simple()
 {
-    Register(new BlockStone);
     Register(new BombStone(&quot;st-bombs&quot;, &quot;it-blackbomb&quot;));
     //Register(new BombStone(&quot;st-dynamite&quot;, &quot;it-dynamite&quot;));
     //Register(new BombStone(&quot;st-whitebombs&quot;, &quot;it-whitebomb&quot;));
@@ -593,7 +452,6 @@
     Register(new InvisibleMagic);
     Register(new MagicStone);
     Register(new Stonebrush);
-    Register(new ThiefStone);
 }
 
 } // namespace enigma


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000909.html">[Enigma-game-svn] r1480 - team_levelpacks/team_test_new_api
</A></li>
	<LI>Next message: <A HREF="000911.html">[Enigma-game-svn] r1482 - in trunk: data data/schemas src src/stones
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#910">[ date ]</a>
              <a href="thread.html#910">[ thread ]</a>
              <a href="subject.html#910">[ subject ]</a>
              <a href="author.html#910">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/enigma-game-svn">More information about the Enigma-game-svn
mailing list</a><br>
</body></html>
