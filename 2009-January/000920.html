<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Enigma-game-svn] r1491 - in trunk: data data/gfx32 data/gfx40	data/gfx48 data/schemas src src/gui src/items src/lev
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/enigma-game-svn/2009-January/index.html" >
   <LINK REL="made" HREF="mailto:enigma-game-svn%40lists.berlios.de?Subject=Re%3A%20%5BEnigma-game-svn%5D%20r1491%20-%20in%20trunk%3A%20data%20data/gfx32%20data/gfx40%0A%09data/gfx48%20data/schemas%20src%20src/gui%20src/items%20src/lev&In-Reply-To=%3C200901282342.n0SNg2bh014789%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000919.html">
   <LINK REL="Next"  HREF="000921.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Enigma-game-svn] r1491 - in trunk: data data/gfx32 data/gfx40	data/gfx48 data/schemas src src/gui src/items src/lev</H1>
    <B>ral at BerliOS</B> 
    <A HREF="mailto:enigma-game-svn%40lists.berlios.de?Subject=Re%3A%20%5BEnigma-game-svn%5D%20r1491%20-%20in%20trunk%3A%20data%20data/gfx32%20data/gfx40%0A%09data/gfx48%20data/schemas%20src%20src/gui%20src/items%20src/lev&In-Reply-To=%3C200901282342.n0SNg2bh014789%40sheep.berlios.de%3E"
       TITLE="[Enigma-game-svn] r1491 - in trunk: data data/gfx32 data/gfx40	data/gfx48 data/schemas src src/gui src/items src/lev">ral at mail.berlios.de
       </A><BR>
    <I>Thu Jan 29 00:42:02 CET 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="000919.html">[Enigma-game-svn] r1490 - in trunk/data/levels: enigma_cross	enigma_ii enigma_iii enigma_iv enigma_tutorial enigma_v	enigma_vi enigma_vii enigma_viii
</A></li>
        <LI>Next message: <A HREF="000921.html">[Enigma-game-svn] r1492 - in trunk/data/levels: enigma_cross	enigma_iv enigma_v enigma_vii enigma_viii
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#920">[ date ]</a>
              <a href="thread.html#920">[ thread ]</a>
              <a href="subject.html#920">[ subject ]</a>
              <a href="author.html#920">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: ral
Date: 2009-01-29 00:41:44 +0100 (Thu, 29 Jan 2009)
New Revision: 1491

Added:
   trunk/data/gfx32/it_extinguisher.png
   trunk/data/gfx32/it_spring_drop.png
   trunk/data/gfx32/it_spring_keep.png
   trunk/data/gfx32/it_springboard.png
   trunk/data/gfx40/it_extinguisher.png
   trunk/data/gfx40/it_spring_drop.png
   trunk/data/gfx40/it_spring_keep.png
   trunk/data/gfx40/it_springboard.png
   trunk/data/gfx48/it_extinguisher.png
   trunk/data/gfx48/it_spring_drop.png
   trunk/data/gfx48/it_spring_keep.png
   trunk/data/gfx48/it_springboard.png
   trunk/src/items/Extinguisher.cc
   trunk/src/items/Extinguisher.hh
Removed:
   trunk/data/gfx32/it-extinguisher.png
   trunk/data/gfx32/it-spring1.png
   trunk/data/gfx32/it-spring2.png
   trunk/data/gfx32/it-springboard.png
   trunk/data/gfx40/it-extinguisher.png
   trunk/data/gfx40/it-spring1.png
   trunk/data/gfx40/it-spring2.png
   trunk/data/gfx40/it-springboard.png
   trunk/data/gfx48/it-extinguisher.png
   trunk/data/gfx48/it-spring1.png
   trunk/data/gfx48/it-spring2.png
   trunk/data/gfx48/it-springboard.png
Modified:
   trunk/data/api1init.lua
   trunk/data/api2init.lua
   trunk/data/models-2d.lua
   trunk/data/schemas/objects.xml
   trunk/src/Makefile.am
   trunk/src/gui/LevelInspector.cc
   trunk/src/gui/LevelWidget.cc
   trunk/src/items.cc
   trunk/src/items.hh
   trunk/src/items/SimpleItems.cc
   trunk/src/items/SimpleItems.hh
   trunk/src/lev/PersistentIndex.cc
   trunk/src/lev/Proxy.cc
   trunk/src/lev/Proxy.hh
   trunk/src/lev/RatingManager.cc
   trunk/src/lev/ScoreManager.cc
   trunk/src/lua.cc
   trunk/src/ox_magnum.cc
   trunk/src/ox_oxyd1.cc
   trunk/src/ox_peroxyd.cc
   trunk/src/server.cc
Log:
Trunk 1.1: new API reengineering
- new object method &quot;sound&quot;:
  - obj:sound(&quot;soundname&quot;, vol) plays a sound for grid based objects
- evaluation of XML level mode attribute &quot;network&quot;:
  - levels with network flag true get it_yinyang added to both inventories
- reengineering extinguisher:
  - it-extinguisher -&gt; it_extinguisher, it_extinguisher_full
  - it-extinguisher_medium -&gt; it_extinguisher_medium
  - it-extinguisher_empty -&gt; it_extinguisher_empty
  - full usage of StateObject:
    - old attribute &quot;load&quot; -&gt; &quot;state&quot;
    - toggle fills up the extinguisher
- reengineering springs:
  - it-spring1 -&gt; it_spring, it_spring_keep
  - it-spring2 -&gt; it_spring_drop
- reengineering springboard:
  - it-springboard -&gt; it_springboard
  - fix active area from circle to square

Modified: trunk/data/api1init.lua
===================================================================
--- trunk/data/api1init.lua	2009-01-28 02:24:09 UTC (rev 1490)
+++ trunk/data/api1init.lua	2009-01-28 23:41:44 UTC (rev 1491)
@@ -147,6 +147,9 @@
     it_crack_l = &quot;it-crack3&quot;,
     it_cross = &quot;it-cross&quot;,
     it_document = &quot;it-document&quot;,
+    it_extinguisher_empty = &quot;it-extinguisher_empty&quot;,
+    it_extinguisher_medium = &quot;it-extinguisher_medium&quot;,
+    it_extinguisher_full = &quot;it-extinguisher&quot;,
     it_extralife = &quot;it-extralife&quot;,
     it_death = &quot;it-death&quot;,
     it_floppy = &quot;it-floppy&quot;,
@@ -185,6 +188,9 @@
     it_seed_volcano = &quot;it-seed_volcano&quot;,
     it_spade = &quot;it-spade&quot;,
     it_spoon = &quot;it-spoon&quot;,
+    it_spring_keep = &quot;it-spring1&quot;,
+    it_spring_drop = &quot;it-spring2&quot;,
+    it_springboard = &quot;it-springboard&quot;,
     it_squashed = &quot;it-squashed&quot;,
     it_shogun_s = &quot;it-shogun-s&quot;,
     it_shogun_m = &quot;it-shogun-m&quot;,
@@ -761,6 +767,9 @@
      if key == &quot;value&quot; then
          _key = &quot;coin_value&quot;
      end
+     if key == &quot;load&quot; then
+         _key = &quot;state&quot;
+     end
      if key == &quot;force&quot; and (_obj_name == &quot;st-actorimpulse&quot; or
              _obj_name == &quot;st-actorimpulse_invisible&quot; or _obj_name == &quot;ac-horse&quot; or
              _obj_name == &quot;ac-rotor&quot; or _obj_name == &quot;ac-top&quot;)  then
@@ -915,6 +924,9 @@
      if key == &quot;on&quot; then
          _key = &quot;state&quot;
      end
+     if key == &quot;load&quot; then
+         _key = &quot;state&quot;
+     end
      if key == &quot;blinking&quot; then
          _key = &quot;state&quot;
      end

Modified: trunk/data/api2init.lua
===================================================================
--- trunk/data/api2init.lua	2009-01-28 02:24:09 UTC (rev 1490)
+++ trunk/data/api2init.lua	2009-01-28 23:41:44 UTC (rev 1491)
@@ -78,6 +78,8 @@
 LARGE     = 2
 YIN       = 0
 YANG      = 1
+EMPTY     = 0
+FULL      = 2
 
 -- color
 BLACK  = 0

Deleted: trunk/data/gfx32/it-extinguisher.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx32/it-spring1.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx32/it-spring2.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx32/it-springboard.png
===================================================================
(Binary files differ)

Copied: trunk/data/gfx32/it_extinguisher.png (from rev 1483, trunk/data/gfx32/it-extinguisher.png)

Copied: trunk/data/gfx32/it_spring_drop.png (from rev 1483, trunk/data/gfx32/it-spring2.png)

Copied: trunk/data/gfx32/it_spring_keep.png (from rev 1483, trunk/data/gfx32/it-spring1.png)

Copied: trunk/data/gfx32/it_springboard.png (from rev 1483, trunk/data/gfx32/it-springboard.png)

Deleted: trunk/data/gfx40/it-extinguisher.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx40/it-spring1.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx40/it-spring2.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx40/it-springboard.png
===================================================================
(Binary files differ)

Copied: trunk/data/gfx40/it_extinguisher.png (from rev 1483, trunk/data/gfx40/it-extinguisher.png)

Copied: trunk/data/gfx40/it_spring_drop.png (from rev 1483, trunk/data/gfx40/it-spring2.png)

Copied: trunk/data/gfx40/it_spring_keep.png (from rev 1483, trunk/data/gfx40/it-spring1.png)

Copied: trunk/data/gfx40/it_springboard.png (from rev 1483, trunk/data/gfx40/it-springboard.png)

Deleted: trunk/data/gfx48/it-extinguisher.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx48/it-spring1.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx48/it-spring2.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx48/it-springboard.png
===================================================================
(Binary files differ)

Copied: trunk/data/gfx48/it_extinguisher.png (from rev 1483, trunk/data/gfx48/it-extinguisher.png)

Copied: trunk/data/gfx48/it_spring_drop.png (from rev 1483, trunk/data/gfx48/it-spring2.png)

Copied: trunk/data/gfx48/it_spring_keep.png (from rev 1483, trunk/data/gfx48/it-spring1.png)

Copied: trunk/data/gfx48/it_springboard.png (from rev 1483, trunk/data/gfx48/it-springboard.png)

Modified: trunk/data/models-2d.lua
===================================================================
--- trunk/data/models-2d.lua	2009-01-28 02:24:09 UTC (rev 1490)
+++ trunk/data/models-2d.lua	2009-01-28 23:41:44 UTC (rev 1491)
@@ -466,8 +466,8 @@
         &quot;it_ring&quot;,
         &quot;it_spade&quot;,
         &quot;it_spoon&quot;,
-        &quot;it-spring1&quot;,
-        &quot;it-spring2&quot;,
+        &quot;it_spring_keep&quot;,
+        &quot;it_spring_drop&quot;,
         &quot;it-surprise&quot;,
         &quot;it_weight&quot;,
         &quot;it-whitebomb&quot;
@@ -523,7 +523,7 @@
 
 -- it-extinguisher --
 do
-    DefTiles(&quot;it-extinguisher&quot;, {&quot;it-extinguisher&quot;, &quot;it-extinguisher_medium&quot;, &quot;it-extinguisher_empty&quot;})
+    DefTiles(&quot;it_extinguisher&quot;, {&quot;it_extinguisher_full&quot;, &quot;it_extinguisher_medium&quot;, &quot;it_extinguisher_empty&quot;})
 end
 
 -- it-dummy
@@ -681,10 +681,10 @@
 
 -- it-springboard --
 do
-    local images = {&quot;it-springboard1&quot;, &quot;it-springboard2&quot;}
-    DefTiles (&quot;it-springboard&quot;, images)
-    DefAlias (&quot;it-springboard&quot;, images[1])
-    DefAnim(&quot;it-springboard_anim&quot;, BuildFrames(ReverseFrames(images),120))
+    local images = {&quot;it_springboard1&quot;, &quot;it_springboard2&quot;}
+    DefTiles (&quot;it_springboard&quot;, images)
+    DefAlias (&quot;it_springboard&quot;, images[1])
+    DefAnim(&quot;it_springboard_anim&quot;, BuildFrames(ReverseFrames(images),120))
 end
 
 -- it-vortex --

Modified: trunk/data/schemas/objects.xml
===================================================================
--- trunk/data/schemas/objects.xml	2009-01-28 02:24:09 UTC (rev 1490)
+++ trunk/data/schemas/objects.xml	2009-01-28 23:41:44 UTC (rev 1491)
@@ -426,6 +426,18 @@
     &lt;object name=&quot;it_document&quot;&gt;
       &lt;attr name=&quot;text&quot;/&gt;
     &lt;/object&gt;
+     &lt;object name=&quot;it_extinguisher&quot;&gt;
+      &lt;attr name=&quot;state&quot; max=&quot;2&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;it_extinguisher_empty&quot;&gt;
+      &lt;attr name=&quot;state&quot; value=&quot;0&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;it_extinguisher_medium&quot;&gt;
+      &lt;attr name=&quot;state&quot; value=&quot;1&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;it_extinguisher_full&quot;&gt;
+      &lt;attr name=&quot;state&quot; value=&quot;2&quot;/&gt;
+    &lt;/object&gt;
     &lt;object name=&quot;it_extralife&quot;/&gt;
     &lt;object name=&quot;it_extralife_new&quot; init=&quot;true&quot;/&gt;
     &lt;object name=&quot;it_floppy&quot;/&gt;
@@ -576,6 +588,15 @@
     &lt;object name=&quot;it_shogun_l&quot;&gt;
       &lt;attr name=&quot;flavor&quot; value=&quot;l&quot;/&gt;
     &lt;/object&gt;
+    &lt;object name=&quot;it_spring&quot;&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;it_spring_keep&quot;&gt;
+      &lt;attr name=&quot;state&quot; value=&quot;0&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;it_spring_drop&quot;&gt;
+      &lt;attr name=&quot;state&quot; value=&quot;1&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;it_springboard&quot;/&gt;
     &lt;object name=&quot;it_squashed&quot;&gt;
       &lt;msg name=&quot;_brush&quot;/&gt;
     &lt;/object&gt;

Modified: trunk/src/Makefile.am
===================================================================
--- trunk/src/Makefile.am	2009-01-28 02:24:09 UTC (rev 1490)
+++ trunk/src/Makefile.am	2009-01-28 23:41:44 UTC (rev 1491)
@@ -216,6 +216,8 @@
 	items/CrossItem.hh	\
 	items/DocumentItem.cc	\
 	items/DocumentItem.hh	\
+	items/Extinguisher.cc	\
+	items/Extinguisher.hh	\
 	items/ExtraLife.cc	\
 	items/ExtraLife.hh	\
 	items/GlassesItem.cc	\

Modified: trunk/src/gui/LevelInspector.cc
===================================================================
--- trunk/src/gui/LevelInspector.cc	2009-01-28 02:24:09 UTC (rev 1490)
+++ trunk/src/gui/LevelInspector.cc	2009-01-28 23:41:44 UTC (rev 1491)
@@ -215,7 +215,7 @@
         std::string tmp, tmp2;
         lev::RatingManager *theRatingMgr = lev::RatingManager::instance();
         lev::ScoreManager  *theScoreMgr = lev::ScoreManager::instance();
-        withEasy = aLevel-&gt;hasEasymode();
+        withEasy = aLevel-&gt;hasEasyMode();
         ratingInherited = theScoreMgr-&gt;isRatingInherited(aLevel);
         ecl::Font *menufont = enigma::GetFont(&quot;menufont&quot;);
         levelPathString = 

Modified: trunk/src/gui/LevelWidget.cc
===================================================================
--- trunk/src/gui/LevelWidget.cc	2009-01-28 02:24:09 UTC (rev 1490)
+++ trunk/src/gui/LevelWidget.cc	2009-01-28 23:41:44 UTC (rev 1491)
@@ -243,7 +243,7 @@
             //   Silver + Gold: Level beaten in all modes - easy available
             Surface *useAsEasy = NULL;
             Surface *useAsDifficult = NULL;
-            if (proxy-&gt;hasEasymode()) {
+            if (proxy-&gt;hasEasyMode()) {
                 useAsEasy = img_feather;
                 if (scoreMgr-&gt;isSolved(proxy, DIFFICULTY_EASY))
                     useAsEasy = img_easy;
@@ -274,7 +274,7 @@
             if (scoreMgr-&gt;bestScoreReached(proxy, app.state-&gt;getInt(&quot;Difficulty&quot;))) {
                 blit(gc, x+35, y+5, 
                         (app.state-&gt;getInt(&quot;Difficulty&quot;) != DIFFICULTY_HARD &amp;&amp;
-                        proxy-&gt;hasEasymode()) ? img_wrEasy : img_wrDifficult);
+                        proxy-&gt;hasEasyMode()) ? img_wrEasy : img_wrDifficult);
             } else if (scoreMgr-&gt;parScoreReached(proxy, app.state-&gt;getInt(&quot;Difficulty&quot;))){
                 blit(gc, x+30, y+12, img_par);
             }

Added: trunk/src/items/Extinguisher.cc
===================================================================
--- trunk/src/items/Extinguisher.cc	2009-01-28 02:24:09 UTC (rev 1490)
+++ trunk/src/items/Extinguisher.cc	2009-01-28 23:41:44 UTC (rev 1491)
@@ -0,0 +1,110 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *  
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include &quot;items/Extinguisher.hh&quot;
+//#include &quot;errors.hh&quot;
+//#include &quot;main.hh&quot;
+#include &quot;player.hh&quot;
+#include &quot;world.hh&quot;
+
+namespace enigma {
+
+    Extinguisher::Extinguisher(int load) {
+        state = load;
+    }
+    
+    std::string Extinguisher::getClass() const {
+        return &quot;it_extinguisher&quot;;
+    }
+    
+    int Extinguisher::maxState() const {
+        return FULL;
+    }
+    
+    void Extinguisher::toggleState() {
+        if (state &lt; FULL)
+            setState(state + 1);
+    }
+    
+    void Extinguisher::setState(int extState) {
+        Item::setState(extState);
+        if (!isDisplayable())
+            player::RedrawInventory();            
+    }
+    
+    void Extinguisher::init_model() {
+        set_model(get_traits().name);
+    }
+    
+    ItemAction Extinguisher::activate(Actor* a, GridPos p) {
+        if (state &gt;= MEDIUM) {
+            extinguish(p);
+            extinguish(move(p, NORTH));
+            extinguish(move(p, SOUTH));
+            extinguish(move(p, EAST));
+            extinguish(move(p, WEST));
+            if (state == FULL) {
+                // full extinguisher has a larger range
+                extinguish(move(p, NORTH, NORTH));
+                extinguish(move(p, NORTH, EAST));
+                extinguish(move(p, SOUTH, SOUTH));
+                extinguish(move(p, SOUTH, WEST));
+                extinguish(move(p, EAST, EAST));
+                extinguish(move(p, EAST, SOUTH));
+                extinguish(move(p, WEST, WEST));
+                extinguish(move(p, WEST, NORTH));
+            }
+            --state;
+    
+            // Redraw the player's inventory, the visual representation of
+            // the extinguisher has changed.
+            player::RedrawInventory();
+        } else
+            return ITEM_DROP;
+    }
+
+    void Extinguisher::extinguish(GridPos p) {
+        if (Item *it = GetItem(p)) {
+            // try to extinguish fire - burnable items
+            SendMessage (it, &quot;extinguish&quot;);
+        } else {
+            // set extinguishing foam to prevent upcoming fire
+            SetItem (p, MakeItem(&quot;it-burnable_fireproof&quot;));
+        }
+    }
+    
+    int Extinguisher::traitsIdx() const {
+        return state;
+    }
+    
+    ItemTraits Extinguisher::traits[3] = {
+        {&quot;it_extinguisher_empty&quot;,  it_extinguisher_empty,  itf_none, 0.0},
+        {&quot;it_extinguisher_medium&quot;, it_extinguisher_medium, itf_fireproof, 0.0},
+        {&quot;it_extinguisher_full&quot;,   it_extinguisher,        itf_fireproof, 0.0},
+    };
+
+    BOOT_REGISTER_START
+        BootRegister(new Extinguisher(2), &quot;it_extinguisher&quot;);
+        BootRegister(new Extinguisher(0), &quot;it_extinguisher_empty&quot;);
+        BootRegister(new Extinguisher(1), &quot;it_extinguisher_medium&quot;);
+        BootRegister(new Extinguisher(2), &quot;it_extinguisher_full&quot;);
+    BOOT_REGISTER_END
+
+} // namespace enigma


Property changes on: trunk/src/items/Extinguisher.cc
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/items/Extinguisher.hh
===================================================================
--- trunk/src/items/Extinguisher.hh	2009-01-28 02:24:09 UTC (rev 1490)
+++ trunk/src/items/Extinguisher.hh	2009-01-28 23:41:44 UTC (rev 1491)
@@ -0,0 +1,65 @@
+/*
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef EXTINGUISHERITEM_HH
+#define EXTINGUISHERITEM_HH
+
+#include &quot;items.hh&quot;
+
+//#include &quot;enigma.hh&quot;
+
+namespace enigma {
+    /**
+     */
+
+    class Extinguisher : public Item {
+        CLONEOBJ(Extinguisher);
+        DECL_ITEMTRAITS_ARRAY(3, traitsIdx());
+
+    private:
+        enum iState {
+            EMPTY      =  0,       ///&lt; 
+            MEDIUM     =  1,       ///&lt; 
+            FULL       =  2       ///&lt;
+        };
+
+    public:
+        Extinguisher(int load);
+        
+        // Object interface
+        virtual std::string getClass() const;
+
+        // StateObject interface
+        virtual int maxState() const;
+        virtual void toggleState();
+        virtual void setState(int extState);
+
+        // GridObject interface
+        virtual void init_model();
+        
+        // Item interface
+        virtual ItemAction activate(Actor* a, GridPos p);
+        
+    private:
+        void extinguish(GridPos p);
+        int traitsIdx() const;
+    };
+   
+} // namespace enigma
+
+#endif


Property changes on: trunk/src/items/Extinguisher.hh
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/src/items/SimpleItems.cc
===================================================================
--- trunk/src/items/SimpleItems.cc	2009-01-28 02:24:09 UTC (rev 1490)
+++ trunk/src/items/SimpleItems.cc	2009-01-28 23:41:44 UTC (rev 1491)
@@ -196,6 +196,62 @@
 
     DEF_ITEMTRAITS(Spoon, &quot;it_spoon&quot;, it_spoon);
 
+/* -------------------- Spring -------------------- */
+    Spring::Spring(int type) {
+        state = type;
+    }
+    
+    void Spring::setState(int extState) {
+        // block all write attempts
+    }
+    
+    ItemAction Spring::activate(Actor *a, GridPos p) {
+        if (state == KEEP) {
+            SendMessage(a, &quot;_jump&quot;);
+            return ITEM_KEEP;
+        } else if (state == DROP) {
+            Item *it = GetItem(p);
+            if (!it || has_flags(it, itf_static)) {
+                SendMessage(a, &quot;_jump&quot;);
+                return ITEM_DROP;  // drop if grid has no item
+            } else {
+                // don't jump if a regular item is on the grid
+                return ITEM_KEEP;
+            }
+        }
+    }
+    
+    int Spring::traitsIdx() const {
+        return state;
+    }
+    
+    ItemTraits Spring::traits[2] = {
+        {&quot;it_spring_keep&quot;, it_spring_keep,  itf_none, 0.0},
+        {&quot;it_spring_drop&quot;, it_spring_drop,  itf_none, 0.0},
+    };
+
+/* -------------------- Springboard -------------------- */
+    Springboard::Springboard() {
+    }
+    
+    bool Springboard::actor_hit(Actor *a) {
+        const double MAXDIST = 0.3;
+        double ycenter = get_pos().y + 0.5;
+        double xcenter = get_pos().x + 0.5;
+        ecl::V2 apos = a-&gt;get_pos();
+        if ((fabs(apos[1] - ycenter) &lt;= MAXDIST) &amp;&amp; (fabs(apos[0] - xcenter) &lt;= MAXDIST)) {
+            set_anim(&quot;it_springboard_anim&quot;);
+            SendMessage(a, &quot;_jump&quot;);
+        }
+        return false;
+    }
+
+    void Springboard::animcb() {
+        set_model(&quot;it_springboard&quot;);
+    }
+
+    DEF_ITEMTRAITSF(Springboard, &quot;it_springboard&quot;, it_springboard, itf_static);
+    
 /* -------------------- Squashed Cherry -------------------- */
 
     Squashed::Squashed() {
@@ -289,6 +345,10 @@
         BootRegister(new Ring(), &quot;it_ring&quot;);
         BootRegister(new Spade(), &quot;it_spade&quot;);
         BootRegister(new Spoon(), &quot;it_spoon&quot;);
+        BootRegister(new Spring(0), &quot;it_spring&quot;);
+        BootRegister(new Spring(0), &quot;it_spring_keep&quot;);
+        BootRegister(new Spring(1), &quot;it_spring_drop&quot;);
+        BootRegister(new Springboard(), &quot;it_springboard&quot;);
         BootRegister(new Squashed(), &quot;it_squashed&quot;);
         BootRegister(new Weight(), &quot;it_weight&quot;);
         BootRegister(new Wrench(), &quot;it_wrench&quot;);

Modified: trunk/src/items/SimpleItems.hh
===================================================================
--- trunk/src/items/SimpleItems.hh	2009-01-28 02:24:09 UTC (rev 1490)
+++ trunk/src/items/SimpleItems.hh	2009-01-28 23:41:44 UTC (rev 1491)
@@ -180,8 +180,48 @@
         virtual ItemAction activate(Actor* a, GridPos p);
     };
 
+    /**
+     * Spring
+     */
+    class Spring : public Item {
+        CLONEOBJ(Spring);
+        DECL_ITEMTRAITS_ARRAY(2, traitsIdx());
+    private:
+        enum iState {
+            KEEP     =  0,    ///&lt; 
+            DROP     =  1     ///&lt; 
+        };
+    public:
+        Spring(int type);
+        
+        // StateObject interface
+        virtual void setState(int extState);
+
+        // Item interface
+        virtual ItemAction activate(Actor* a, GridPos p);
+        
+    private:
+        int traitsIdx() const;
+    };
     
     /**
+     * Spring
+     */
+    class Springboard : public Item {
+        CLONEOBJ(Springboard);
+        DECL_ITEMTRAITS;
+
+    public:
+        Springboard();
+        
+        // ModelCallback interface
+        virtual void animcb();
+        
+        // ItemObject interface
+        virtual bool actor_hit(Actor *a);
+    };
+
+    /**
      * Squashed
      */
     class Squashed : public Item {

Modified: trunk/src/items.cc
===================================================================
--- trunk/src/items.cc	2009-01-28 02:24:09 UTC (rev 1490)
+++ trunk/src/items.cc	2009-01-28 23:41:44 UTC (rev 1491)
@@ -235,83 +235,6 @@
     DEF_ITEMTRAITSF(BrokenBooze, &quot;it-booze-broken&quot;, it_booze_broken, itf_static | itf_indestructible);
 }
 
-/* -------------------- Springs -------------------- */
-
-/** \page it-spring Spring
-
-Activating a spring will make the marble jump.
-A jumping marble does not fall into abyss or water.
-
-Springs come in two flavors: it-spring1 stays in the inventory,
-whereas it-spring2 drops to the floor when you activate it.
-
-\image html it-spring1.png
-*/
-namespace
-{
-    class Spring1 : public Item {
-        CLONEOBJ(Spring1);
-        DECL_ITEMTRAITS;
-    public:
-        Spring1() {}
-    private:
-        ItemAction activate(Actor *a, GridPos)
-        {
-            SendMessage(a, &quot;_jump&quot;);
-            return ITEM_KEEP;
-        }
-    };
-    DEF_ITEMTRAITS(Spring1, &quot;it-spring1&quot;, it_spring1);
-
-    class Spring2 : public Item {
-        CLONEOBJ(Spring2);
-        DECL_ITEMTRAITS;
-    public:
-        Spring2() {}
-    private:
-        ItemAction activate(Actor *a, GridPos p)
-        {
-            Item *it = GetItem(p);
-            if (!it || has_flags(it, itf_static)) {
-                SendMessage(a, &quot;_jump&quot;);
-                return ITEM_DROP;  // drop if grid has no item
-            } else {
-                // don't jump if a regular item is on the grid
-                return ITEM_KEEP;
-            }
-        }
-    };
-    DEF_ITEMTRAITS(Spring2, &quot;it-spring2&quot;, it_spring2);
-}
-
-
-/* -------------------- Springboard -------------------- */
-namespace
-{
-    class Springboard : public Item {
-        CLONEOBJ(Springboard);
-        DECL_ITEMTRAITS;
-
-        bool actor_hit(Actor *a) {
-            const double ITEM_RADIUS = 0.3;
-            ecl::V2 item_center(get_pos().x + 0.5, get_pos().y + 0.5);
-            double dist = length(a-&gt;get_pos() - item_center);
-            if (dist &lt; ITEM_RADIUS) {
-                set_anim(&quot;it-springboard_anim&quot;);
-                SendMessage(a, &quot;_jump&quot;);
-            }
-            return false;
-        }
-
-        void animcb() {
-            set_model(&quot;it-springboard&quot;);
-        }
-    public:
-        Springboard() {}
-    };
-    DEF_ITEMTRAITSF(Springboard, &quot;it-springboard&quot;, it_springboard, itf_static);
-}
-
 /* -------------------- Explosion -------------------- */
 namespace
 {
@@ -700,78 +623,6 @@
 }
 
 
-/* -------------------- Fire Extinguisher -------------------- */
-namespace
-{
-    /*! This items can extinguish burning floor. */
-    class Extinguisher : public Item {
-        CLONEOBJ(Extinguisher);
-        DECL_ITEMTRAITS_ARRAY(3, get_load());
-    public:
-        static void setup() {
-            RegisterItem (new Extinguisher(0));
-            RegisterItem (new Extinguisher(1));
-            RegisterItem (new Extinguisher(2));
-        }
-
-    private:
-        Extinguisher (int load) {
-    	    setAttr(&quot;load&quot;, load);
-        }
-
-        int get_load() const { return ecl::Clamp&lt;int&gt;(getAttr(&quot;load&quot;),0,2); }
-        void set_load (int load) { setAttr(&quot;load&quot;, ecl::Clamp&lt;int&gt;(load,0,2)); }
-
-        void extinguish (GridPos p) {
-            if (Item *it = GetItem(p)) {
-                SendMessage (it, &quot;extinguish&quot;);
-            } else {
-                SetItem (p, MakeItem(&quot;it-burnable_fireproof&quot;));
-            }
-        }
-
-        /* ---------- Item interface ---------- */
-
-        ItemAction activate(Actor *a, GridPos p);
-    };
-
-    ItemTraits Extinguisher::traits[3] = {
-        {&quot;it-extinguisher_empty&quot;,  it_extinguisher_empty,  itf_none, 0.0},
-        {&quot;it-extinguisher_medium&quot;, it_extinguisher_medium, itf_fireproof, 0.0},
-        {&quot;it-extinguisher&quot;,        it_extinguisher,        itf_fireproof, 0.0},
-    };
-}
-
-ItemAction Extinguisher::activate(Actor *a, GridPos p)
-{
-    int load = get_load();
-    if (load &gt; 0) {
-        extinguish (p);
-        extinguish (move(p, NORTH));
-        extinguish (move(p, SOUTH));
-        extinguish (move(p, EAST));
-        extinguish (move(p, WEST));
-        if (load &gt; 1) {
-            // full extinguisher has a larger range
-            extinguish (move(p, NORTH, NORTH));
-            extinguish (move(p, NORTH, EAST));
-            extinguish (move(p, SOUTH, SOUTH));
-            extinguish (move(p, SOUTH, WEST));
-            extinguish (move(p, EAST, EAST));
-            extinguish (move(p, EAST, SOUTH));
-            extinguish (move(p, WEST, WEST));
-            extinguish (move(p, WEST, NORTH));
-        }
-        set_load(load - 1);
-
-        // Redraw the player's inventory, the visual representation of
-        // the extinguisher has changed.
-        player::RedrawInventory();
-    }
-    return ITEM_DROP;
-}
-
-
 /* -------------------- Flags -------------------- */
 
 namespace
@@ -898,11 +749,11 @@
         // before stones are created.
         if (server::GetDifficulty() == DIFFICULTY_EASY) {
             if (Stone *st = GetStone (get_pos())) {
-                if (st-&gt;is_kind (&quot;st-death&quot;) ||
-                    st-&gt;is_kind (&quot;st-flash&quot;) ||
-                    st-&gt;is_kind (&quot;st-thief&quot;))
+                if (st-&gt;is_kind (&quot;st_death&quot;) ||
+                    st-&gt;is_kind (&quot;st_flash&quot;) ||
+                    st-&gt;is_kind (&quot;st_thief&quot;))
                 {
-                    SetStone (get_pos(), MakeStone (&quot;st-plain&quot;));
+                    SetStone (get_pos(), MakeStone (&quot;st_flat&quot;));
                 }
                 else
                     KillStone(get_pos());
@@ -993,7 +844,7 @@
         void on_drop (Actor *) {
             static char *items[] = {
                 &quot;it_umbrella&quot;,
-                &quot;it-spring1&quot;,
+                &quot;it_spring_keep&quot;,
                 &quot;it-dynamite&quot;,
                 &quot;it_coffee&quot;,
                 &quot;it_hammer&quot;
@@ -1109,16 +960,12 @@
     RegisterItem (new Explosion1);
     RegisterItem (new Explosion2);
     RegisterItem (new Explosion3);
-    Extinguisher::setup();
     RegisterItem (new FlagBlack);
     RegisterItem (new FlagWhite);
     RegisterItem (new Odometer);
     RegisterItem (new OnePKillStone);
     RegisterItem (new OxydBridge);
     RegisterItem (new OxydBridgeActive);
-    RegisterItem (new Spring1);
-    RegisterItem (new Spring2);
-    RegisterItem (new Springboard);
     RegisterItem (new SurpriseItem);
     RegisterItem (new TwoPKillStone);
     RegisterItem (new WhiteBomb);

Modified: trunk/src/items.hh
===================================================================
--- trunk/src/items.hh	2009-01-28 02:24:09 UTC (rev 1490)
+++ trunk/src/items.hh	2009-01-28 23:41:44 UTC (rev 1491)
@@ -117,8 +117,8 @@
         it_signalfilter1,
         it_spade,
         it_spoon,
-        it_spring1,
-        it_spring2,
+        it_spring_keep,
+        it_spring_drop,
         it_springboard,
         it_squashed,
         it_strip,

Modified: trunk/src/lev/PersistentIndex.cc
===================================================================
--- trunk/src/lev/PersistentIndex.cc	2009-01-28 02:24:09 UTC (rev 1490)
+++ trunk/src/lev/PersistentIndex.cc	2009-01-28 23:41:44 UTC (rev 1491)
@@ -770,7 +770,7 @@
             levelElem-&gt;setAttribute( Utf8ToXML(&quot;rev&quot;).x_str(),
                     Utf8ToXML(ecl::strf(&quot;%d&quot;,level-&gt;getRevisionNumber())).x_str());
             levelElem-&gt;setAttribute( Utf8ToXML(&quot;easy&quot;).x_str(),
-                    Utf8ToXML(level-&gt;hasEasymode() ? &quot;true&quot; : &quot;false&quot;).x_str());
+                    Utf8ToXML(level-&gt;hasEasyMode() ? &quot;true&quot; : &quot;false&quot;).x_str());
             std::string control;
             switch (variations[i].ctrl) {
             case lev::force:

Modified: trunk/src/lev/Proxy.cc
===================================================================
--- trunk/src/lev/Proxy.cc	2009-01-28 02:24:09 UTC (rev 1490)
+++ trunk/src/lev/Proxy.cc	2009-01-28 23:41:44 UTC (rev 1491)
@@ -251,7 +251,7 @@
     std::set&lt;std::string&gt; Proxy::getLevelIds(bool withEasy) {
         std::set&lt;std::string&gt; result;
         for (std::map&lt;std::string, Proxy *&gt;::iterator i= cache.begin(); i != cache.end(); i++) {
-            if ((*i).second-&gt;hasEasymode() == withEasy)
+            if ((*i).second-&gt;hasEasyMode() == withEasy)
                 result.insert((*i).second-&gt;getId());
         }
         return result;
@@ -272,7 +272,7 @@
             isLibraryFlag (proxyIsLibrary), normPathType(thePathType), normLevelPath(theNormLevelPath), 
             id(levelId), title(levelTitle), author(levelAuthor),
             scoreVersion(levelScoreVersion), releaseVersion(levelRelease),
-            revisionNumber(levelRevision), hasEasymodeFlag(levelHasEasymode), 
+            revisionNumber(levelRevision), hasEasyModeFlag(levelHasEasymode), 
             engineCompatibility(levelCompatibilty), levelStatus (status), 
             scoreUnit (duration), doc(NULL) {
     }
@@ -401,7 +401,7 @@
         
         // create new proxy
         return registerLevel(std::string(&quot;./&quot;)+filenameBase, newPackPath, id, title,
-                        author, scoreVersion, releaseVersion, hasEasymodeFlag, 
+                        author, scoreVersion, releaseVersion, hasEasyModeFlag, 
                         engineCompatibility, levelStatus, revisionNumber);
     }
     
@@ -605,7 +605,9 @@
                 getRevisionNumber();
                 getLevelStatus();
                 getAuthor();
-                hasEasymode();
+                hasEasyMode();
+                hasSingleMode();
+                hasNetworkMode();
                 getScoreUnit();
                 getEngineCompatibility();
                 if (!onlyMetadata){   
@@ -624,6 +626,7 @@
         if (this == currentLevel) {    // just level - no libs
             server::SetCompatibility(this);
             server::EnigmaCompatibility = getEnigmaCompatibility();
+            server::TwoPlayerGame = hasNetworkMode();
             server::LevelStatus = getLevelStatus();
             if (server::EnigmaCompatibility &lt; 1.10) {
                 server::AllowSingleOxyds = true;
@@ -1011,17 +1014,39 @@
         return title;
     }
 
-    bool Proxy::hasEasymode() {
+    bool Proxy::hasEasyMode() {
         if (doc != NULL) {
             DOMElement *modesElem = 
                     dynamic_cast&lt;DOMElement *&gt;(infoElem-&gt;getElementsByTagNameNS(
                     levelNS, Utf8ToXML(&quot;modes&quot;).x_str())-&gt;item(0));
-            hasEasymodeFlag = boolValue(modesElem-&gt;getAttributeNS(levelNS, 
+            hasEasyModeFlag = boolValue(modesElem-&gt;getAttributeNS(levelNS, 
                         Utf8ToXML(&quot;easy&quot;).x_str()));
         }
-        return hasEasymodeFlag;
+        return hasEasyModeFlag;
     }
 
+    bool Proxy::hasSingleMode() {
+        if (doc != NULL) {
+            DOMElement *modesElem = 
+                    dynamic_cast&lt;DOMElement *&gt;(infoElem-&gt;getElementsByTagNameNS(
+                    levelNS, Utf8ToXML(&quot;modes&quot;).x_str())-&gt;item(0));
+            hasSingleModeFlag = boolValue(modesElem-&gt;getAttributeNS(levelNS, 
+                        Utf8ToXML(&quot;single&quot;).x_str()));
+        }
+        return hasSingleModeFlag;
+    }
+
+    bool Proxy::hasNetworkMode() {
+        if (doc != NULL) {
+            DOMElement *modesElem = 
+                    dynamic_cast&lt;DOMElement *&gt;(infoElem-&gt;getElementsByTagNameNS(
+                    levelNS, Utf8ToXML(&quot;modes&quot;).x_str())-&gt;item(0));
+            hasNetworkModeFlag = boolValue(modesElem-&gt;getAttributeNS(levelNS, 
+                        Utf8ToXML(&quot;network&quot;).x_str()));
+        }
+        return hasNetworkModeFlag;
+    }
+
     std::string Proxy::getContact() {
         std::string contact;
         if (doc != NULL) {

Modified: trunk/src/lev/Proxy.hh
===================================================================
--- trunk/src/lev/Proxy.hh	2009-01-28 02:24:09 UTC (rev 1490)
+++ trunk/src/lev/Proxy.hh	2009-01-28 23:41:44 UTC (rev 1491)
@@ -109,7 +109,9 @@
         levelStatusType getLevelStatus();
         std::string getAuthor();
         std::string getTitle(); // english title
-        bool hasEasymode();
+        bool hasEasyMode();
+        bool hasSingleMode();
+        bool hasNetworkMode();
         std::string getContact();
         std::string getHomepage();
         controlType getControl();
@@ -161,7 +163,9 @@
         int releaseVersion;
         int revisionNumber;
         levelStatusType levelStatus;
-        bool hasEasymodeFlag;
+        bool hasEasyModeFlag;
+        bool hasSingleModeFlag;
+        bool hasNetworkModeFlag;
         scoreUnitType scoreUnit;
         /**
          * The compatibility that needs to be preset on level load.

Modified: trunk/src/lev/RatingManager.cc
===================================================================
--- trunk/src/lev/RatingManager.cc	2009-01-28 02:24:09 UTC (rev 1490)
+++ trunk/src/lev/RatingManager.cc	2009-01-28 23:41:44 UTC (rev 1491)
@@ -519,7 +519,7 @@
     }
     
     short RatingManager::getBestScore(Proxy *levelProxy, int difficulty) {
-        if (difficulty == DIFFICULTY_EASY &amp;&amp; !levelProxy-&gt;hasEasymode())
+        if (difficulty == DIFFICULTY_EASY &amp;&amp; !levelProxy-&gt;hasEasyMode())
             difficulty = DIFFICULTY_HARD;
         switch (difficulty) {
             case DIFFICULTY_EASY:
@@ -556,7 +556,7 @@
     }
     
     std::string RatingManager::getBestScoreHolder(Proxy *levelProxy, int difficulty, int cut) {
-        if (difficulty == DIFFICULTY_EASY &amp;&amp; !levelProxy-&gt;hasEasymode())
+        if (difficulty == DIFFICULTY_EASY &amp;&amp; !levelProxy-&gt;hasEasyMode())
             difficulty = DIFFICULTY_HARD;
         switch (difficulty) {
             case DIFFICULTY_EASY:
@@ -602,7 +602,7 @@
     
     
     short RatingManager::getParScore(Proxy *levelProxy, int difficulty) {
-        if (difficulty == DIFFICULTY_EASY &amp;&amp; !levelProxy-&gt;hasEasymode())
+        if (difficulty == DIFFICULTY_EASY &amp;&amp; !levelProxy-&gt;hasEasyMode())
             difficulty = DIFFICULTY_HARD;
         switch (difficulty) {
             case DIFFICULTY_EASY:

Modified: trunk/src/lev/ScoreManager.cc
===================================================================
--- trunk/src/lev/ScoreManager.cc	2009-01-28 02:24:09 UTC (rev 1490)
+++ trunk/src/lev/ScoreManager.cc	2009-01-28 23:41:44 UTC (rev 1491)
@@ -518,7 +518,7 @@
     bool ScoreManager::isSolved(lev::Proxy *levelProxy, int difficulty) {
         ecl::Assert &lt;XFrontend&gt; (difficulty &gt;= DIFFICULTY_EASY &amp;&amp;  
                 difficulty &lt;= DIFFICULTY_ANY, &quot;ScoreManager::isSolved illegal difficulty&quot;);
-        if (difficulty == DIFFICULTY_EASY &amp;&amp; !levelProxy-&gt;hasEasymode())
+        if (difficulty == DIFFICULTY_EASY &amp;&amp; !levelProxy-&gt;hasEasyMode())
             difficulty = DIFFICULTY_HARD;
         
         DOMElement * level = getLevel(levelProxy);
@@ -533,7 +533,7 @@
     bool ScoreManager::isOutdated(lev::Proxy *levelProxy, int difficulty) {
         ecl::Assert &lt;XFrontend&gt; (difficulty &gt;= DIFFICULTY_EASY &amp;&amp;  
                 difficulty &lt;= DIFFICULTY_HARD, &quot;ScoreManager::isOutdated illegal difficulty&quot;);
-        if (difficulty == DIFFICULTY_EASY &amp;&amp; !levelProxy-&gt;hasEasymode())
+        if (difficulty == DIFFICULTY_EASY &amp;&amp; !levelProxy-&gt;hasEasyMode())
             difficulty = DIFFICULTY_HARD;
         
         DOMElement * level = getLevel(levelProxy);
@@ -552,7 +552,7 @@
     int ScoreManager::getBestUserScore(lev::Proxy *levelProxy, int difficulty) {
         ecl::Assert &lt;XFrontend&gt; (difficulty &gt;= DIFFICULTY_EASY &amp;&amp;  
                 difficulty &lt;= DIFFICULTY_HARD, &quot;ScoreManager::getBestUserScore illegal difficulty&quot;);
-        if (difficulty == DIFFICULTY_EASY &amp;&amp; !levelProxy-&gt;hasEasymode())
+        if (difficulty == DIFFICULTY_EASY &amp;&amp; !levelProxy-&gt;hasEasyMode())
             difficulty = DIFFICULTY_HARD;
         
         DOMElement * level = getLevel(levelProxy);
@@ -572,7 +572,7 @@
         if (levelProxy-&gt;getLevelStatus() != lev::STATUS_RELEASED)
             return;
         
-        if (difficulty == DIFFICULTY_EASY &amp;&amp; !levelProxy-&gt;hasEasymode())
+        if (difficulty == DIFFICULTY_EASY &amp;&amp; !levelProxy-&gt;hasEasyMode())
             difficulty = DIFFICULTY_HARD;
         
         if (score &gt; SCORE_MAX)
@@ -686,7 +686,7 @@
     }
     
     bool ScoreManager::bestScoreReached(lev::Proxy *levelProxy, int difficulty) {
-        if (difficulty == DIFFICULTY_EASY &amp;&amp; !levelProxy-&gt;hasEasymode())
+        if (difficulty == DIFFICULTY_EASY &amp;&amp; !levelProxy-&gt;hasEasyMode())
             difficulty = DIFFICULTY_HARD;
         
         int bestUserScore = getBestUserScore(levelProxy, difficulty);
@@ -695,7 +695,7 @@
     }
     
     bool ScoreManager::parScoreReached(lev::Proxy *levelProxy, int difficulty) {
-        if (difficulty == DIFFICULTY_EASY &amp;&amp; !levelProxy-&gt;hasEasymode())
+        if (difficulty == DIFFICULTY_EASY &amp;&amp; !levelProxy-&gt;hasEasyMode())
             difficulty = DIFFICULTY_HARD;
         
         int bestUserScore = getBestUserScore(levelProxy, difficulty);

Modified: trunk/src/lua.cc
===================================================================
--- trunk/src/lua.cc	2009-01-28 02:24:09 UTC (rev 1490)
+++ trunk/src/lua.cc	2009-01-28 23:41:44 UTC (rev 1491)
@@ -1773,6 +1773,32 @@
     return 0;
 }
 
+static int objectSound(lua_State *L) {
+    if (lua_gettop(L) &lt; 1 || !is_object(L, 1)) {
+        throwLuaError(L, &quot;Syntax error - usage of '.' instead of ':'&quot;);
+        return 0;        
+    }
+    if (!(lua_gettop(L) &gt;= 2 &amp;&amp; lua_isstring(L, 2))) {
+        throwLuaError(L, &quot;Sound name expected as first argument&quot;);
+        return 0;        
+    }
+    double vol = 1.0;
+    if (lua_gettop(L) &gt;=3 &amp;&amp; lua_isnumber(L, 3))
+        vol = lua_tonumber(L, 3);
+    
+    GridObject *gobj = dynamic_cast&lt;GridObject*&gt;(to_object(L, 1));
+    if (gobj != NULL) {
+        if (!gobj-&gt;sound_event(lua_tostring(L, 2), vol)) {
+            //throwLuaError(L, strf(&quot;Can't find sound '%s'&quot;, soundname).c_str());
+            // Don't throw an error when no sound file was found.
+            // Remember that user sound sets might be incomplete, and
+            // absolutely correct levels could throw an error here.
+            // Instead, write the &quot;silence string&quot; to the command line:
+            sound::WriteSilenceString(lua_tostring(L, 2));
+        }
+    }
+    return 0;
+}
 
 
 static int xyPosition(lua_State *L) {
@@ -3287,6 +3313,7 @@
     {objectGetKind,                 &quot;kind&quot;},
     {killObject,                    &quot;kill&quot;},
     {objectMessage,                 &quot;message&quot;},
+    {objectSound,                   &quot;sound&quot;},
     {setAttributes,                 &quot;set&quot;},
     {xyObject,                      &quot;xy&quot;},
     {0,0}

Modified: trunk/src/ox_magnum.cc
===================================================================
--- trunk/src/ox_magnum.cc	2009-01-28 02:24:09 UTC (rev 1490)
+++ trunk/src/ox_magnum.cc	2009-01-28 23:41:44 UTC (rev 1491)
@@ -328,8 +328,8 @@
     UNUSED,        // OxydMagnum item 0x23
     &quot;it_pin&quot;,           // OxydMagnum item 0x24
     &quot;it_seed&quot;,          // OxydMagnum item 0x25
-    &quot;it-spring2&quot;,       // OxydMagnum item 0x26
-    &quot;it-spring1&quot;,       // OxydMagnum item 0x27
+    &quot;it_spring_drop&quot;,   // OxydMagnum item 0x26
+    &quot;it_spring_keep&quot;,   // OxydMagnum item 0x27
     &quot;it_bag&quot;,           // OxydMagnum item 0x28
     &quot;it_magnet_off&quot;,    // OxydMagnum item 0x29
     &quot;it_inversesensor&quot;, // OxydMagnum item 0x2a
@@ -344,7 +344,7 @@
     &quot;it_meditation_dent&quot;,   // OxydMagnum item 0x33
     &quot;it_strip_ns&quot;,      // OxydMagnum item 0x34
     &quot;it_strip_ew&quot;,      // OxydMagnum item 0x35
-    &quot;it-springboard&quot;,   // OxydMagnum item 0x36
+    &quot;it_springboard&quot;,   // OxydMagnum item 0x36
     IT_MISSING,       // OxydMagnum item 0x37
     &quot;it-bridge-oxyd&quot;,   // OxydMagnum item 0x38
     UNUSED,        // OxydMagnum item 0x39
@@ -366,7 +366,7 @@
     UNUSED,        // OxydMagnum item 0x49
     UNUSED,        // OxydMagnum item 0x4a
     UNUSED,        // OxydMagnum item 0x4b
-    &quot;it-springboard&quot;,   // OxydMagnum item 0x4c
+    &quot;it_springboard&quot;,   // OxydMagnum item 0x4c
     UNUSED,        // OxydMagnum item 0x4d
     UNUSED,        // OxydMagnum item 0x4e
     UNUSED,        // OxydMagnum item 0x4f

Modified: trunk/src/ox_oxyd1.cc
===================================================================
--- trunk/src/ox_oxyd1.cc	2009-01-28 02:24:09 UTC (rev 1490)
+++ trunk/src/ox_oxyd1.cc	2009-01-28 23:41:44 UTC (rev 1491)
@@ -344,8 +344,8 @@
     &quot;it-surprise&quot;,                // 0x23
     &quot;it_pin&quot;,                     // 0x24
     &quot;it_seed&quot;,                    // 0x25
-    &quot;it-spring2&quot;,                 // 0x26
-    &quot;it-spring1&quot;,                 // 0x27
+    &quot;it_spring_drop&quot;,             // 0x26
+    &quot;it_spring_keep&quot;,             // 0x27
     &quot;it_bag&quot;,                     // 0x28
     &quot;it_magnet_off&quot;,              // 0x29
     &quot;it_inversesensor&quot;,           // 0x2a
@@ -360,7 +360,7 @@
     &quot;it_meditation_dent&quot;,         // 0x33
     &quot;it_strip_ns&quot;,                // 0x34
     &quot;it_strip_ew&quot;,                // 0x35
-    &quot;it-springboard&quot;,             // 0x36
+    &quot;it_springboard&quot;,             // 0x36
     &quot;it-bridge-oxyd&quot;,             // 0x37 bridge active
     &quot;it-bridge-oxyd&quot;,             // 0x38 bridge inactive
     &quot;it-bridge-oxyd_active&quot;,      // 0x39 walkable bridge (?&quot;

Modified: trunk/src/ox_peroxyd.cc
===================================================================
--- trunk/src/ox_peroxyd.cc	2009-01-28 02:24:09 UTC (rev 1490)
+++ trunk/src/ox_peroxyd.cc	2009-01-28 23:41:44 UTC (rev 1491)
@@ -416,8 +416,8 @@
     &quot;it-surprise&quot;,                // 0x22
     &quot;it_pin&quot;,                     // 0x23
     &quot;it_seed&quot;,                    // 0x24
-    &quot;it-spring2&quot;,                 // 0x25
-    &quot;it-spring1&quot;,                 // 0x26
+    &quot;it_spring_board&quot;,            // 0x25
+    &quot;it_spring_keep&quot;,             // 0x26
     &quot;it_bag&quot;,                     // 0x27
     &quot;it_magnet_off&quot;,              // 0x28
     &quot;it_sensor_filter0&quot;,          // 0x29
@@ -433,7 +433,7 @@
     &quot;it_meditation_dent&quot;,         // 0x33
     &quot;it_strip_ns&quot;,                // 0x34
     &quot;it_strip_ew&quot;,                // 0x35
-    &quot;it-springboard&quot;,             // 0x36
+    &quot;it_springboard&quot;,             // 0x36
     IT_MISSING,                   // 0x37
     &quot;it-bridge-oxyd&quot;,             // 0x38
     UNUSED,                  // 0x39

Modified: trunk/src/server.cc
===================================================================
--- trunk/src/server.cc	2009-01-28 02:24:09 UTC (rev 1490)
+++ trunk/src/server.cc	2009-01-28 23:41:44 UTC (rev 1491)
@@ -517,7 +517,7 @@
     // ------------------------------ quick options
     else if (cmd == &quot;easy&quot;) {
         if (app.state-&gt;getInt(&quot;Difficulty&quot;) == DIFFICULTY_HARD) {
-            if (curProxy-&gt;hasEasymode()) {
+            if (curProxy-&gt;hasEasyMode()) {
                 client::Msg_ShowText(&quot;Restarting in easy mode&quot;, false, 2);
                 app.state-&gt;setProperty(&quot;Difficulty&quot;, DIFFICULTY_EASY);
                 server::Msg_Command(&quot;restart&quot;);
@@ -531,7 +531,7 @@
     else if (cmd == &quot;noeasy&quot;) {
         if (app.state-&gt;getInt(&quot;Difficulty&quot;) == DIFFICULTY_EASY) {
             app.state-&gt;setProperty(&quot;Difficulty&quot;, DIFFICULTY_HARD);
-            if (curProxy-&gt;hasEasymode()) {
+            if (curProxy-&gt;hasEasyMode()) {
                 client::Msg_ShowText(&quot;Restarting in normal mode&quot;, false, 2);
                 server::Msg_Command(&quot;restart&quot;);
             }
@@ -639,7 +639,7 @@
     lev::Index *ind = lev::Index::getCurrentIndex();
     lev::Proxy *curProxy = ind-&gt;getCurrent();
     int i= app.state-&gt;getInt(&quot;Difficulty&quot;);
-    if (i == DIFFICULTY_EASY &amp;&amp; !server::CreatingPreview &amp;&amp; curProxy-&gt;hasEasymode())
+    if (i == DIFFICULTY_EASY &amp;&amp; !server::CreatingPreview &amp;&amp; curProxy-&gt;hasEasyMode())
         return DIFFICULTY_EASY;
     else
         return DIFFICULTY_HARD;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000919.html">[Enigma-game-svn] r1490 - in trunk/data/levels: enigma_cross	enigma_ii enigma_iii enigma_iv enigma_tutorial enigma_v	enigma_vi enigma_vii enigma_viii
</A></li>
	<LI>Next message: <A HREF="000921.html">[Enigma-game-svn] r1492 - in trunk/data/levels: enigma_cross	enigma_iv enigma_v enigma_vii enigma_viii
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#920">[ date ]</a>
              <a href="thread.html#920">[ thread ]</a>
              <a href="subject.html#920">[ subject ]</a>
              <a href="author.html#920">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/enigma-game-svn">More information about the Enigma-game-svn
mailing list</a><br>
</body></html>
