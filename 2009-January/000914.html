<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Enigma-game-svn] r1485 - in trunk: data data/gfx32 data/gfx40	data/gfx48 data/schemas src src/items
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/enigma-game-svn/2009-January/index.html" >
   <LINK REL="made" HREF="mailto:enigma-game-svn%40lists.berlios.de?Subject=Re%3A%20%5BEnigma-game-svn%5D%20r1485%20-%20in%20trunk%3A%20data%20data/gfx32%20data/gfx40%0A%09data/gfx48%20data/schemas%20src%20src/items&In-Reply-To=%3C200901252158.n0PLwjcZ025056%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000913.html">
   <LINK REL="Next"  HREF="000915.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Enigma-game-svn] r1485 - in trunk: data data/gfx32 data/gfx40	data/gfx48 data/schemas src src/items</H1>
    <B>ral at BerliOS</B> 
    <A HREF="mailto:enigma-game-svn%40lists.berlios.de?Subject=Re%3A%20%5BEnigma-game-svn%5D%20r1485%20-%20in%20trunk%3A%20data%20data/gfx32%20data/gfx40%0A%09data/gfx48%20data/schemas%20src%20src/items&In-Reply-To=%3C200901252158.n0PLwjcZ025056%40sheep.berlios.de%3E"
       TITLE="[Enigma-game-svn] r1485 - in trunk: data data/gfx32 data/gfx40	data/gfx48 data/schemas src src/items">ral at mail.berlios.de
       </A><BR>
    <I>Sun Jan 25 22:58:45 CET 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="000913.html">[Enigma-game-svn] r1484 - in trunk: data src
</A></li>
        <LI>Next message: <A HREF="000915.html">[Enigma-game-svn] r1486 - team_levelpacks/team_test_new_api
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#914">[ date ]</a>
              <a href="thread.html#914">[ thread ]</a>
              <a href="subject.html#914">[ subject ]</a>
              <a href="author.html#914">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: ral
Date: 2009-01-25 22:58:42 +0100 (Sun, 25 Jan 2009)
New Revision: 1485

Added:
   trunk/data/gfx32/it_document.png
   trunk/data/gfx32/it_pencil.png
   trunk/data/gfx32/it_puller.png
   trunk/data/gfx40/it_document.png
   trunk/data/gfx40/it_pencil.png
   trunk/data/gfx40/it_puller.png
   trunk/data/gfx48/it_document.png
   trunk/data/gfx48/it_pencil.png
   trunk/data/gfx48/it_puller.png
   trunk/src/items/CrossItem.cc
   trunk/src/items/CrossItem.hh
   trunk/src/items/DocumentItem.cc
   trunk/src/items/DocumentItem.hh
   trunk/src/items/Landmine.cc
   trunk/src/items/Landmine.hh
   trunk/src/items/PullerItem.cc
   trunk/src/items/PullerItem.hh
   trunk/src/items/TrapItem.cc
   trunk/src/items/TrapItem.hh
Removed:
   trunk/data/gfx32/it-document.png
   trunk/data/gfx32/it-pencil.png
   trunk/data/gfx32/it-puller.png
   trunk/data/gfx40/it-document.png
   trunk/data/gfx40/it-pencil.png
   trunk/data/gfx40/it-puller.png
   trunk/data/gfx48/it-document.png
   trunk/data/gfx48/it-pencil.png
   trunk/data/gfx48/it-puller.png
Modified:
   trunk/data/api1init.lua
   trunk/data/api2init.lua
   trunk/data/models-2d.lua
   trunk/data/schemas/objects.xml
   trunk/src/Makefile.am
   trunk/src/items.cc
   trunk/src/items/SimpleItems.cc
   trunk/src/items/SimpleItems.hh
   trunk/src/ox_magnum.cc
   trunk/src/ox_peroxyd.cc
   trunk/src/oxyd.cc
Log:
Trunk 1.1: new API reengineering
- reenigineering document item:
  - renaming it-document -&gt; it_document
- reengineering pencil:
  - renaming it-pencil -&gt; it_pencil
  - no more marking on floor bridges
  - pencil transfers identity on floor marking to the resulting cross
- reengineering puller item - renaming:
  - it-puller-w -&gt; it_puller_w
  - it-puller-s -&gt; it_puller_s
  - it-puller-e -&gt; it_puller_e
  - it-puller-n -&gt; it_puller_n
- some code cleanup

Modified: trunk/data/api1init.lua
===================================================================
--- trunk/data/api1init.lua	2009-01-25 18:17:10 UTC (rev 1484)
+++ trunk/data/api1init.lua	2009-01-25 21:58:42 UTC (rev 1485)
@@ -145,6 +145,7 @@
     it_crack_m = &quot;it-crack2&quot;,
     it_crack_l = &quot;it-crack3&quot;,
     it_cross = &quot;it-cross&quot;,
+    it_document = &quot;it-document&quot;,
     it_extralife = &quot;it-extralife&quot;,
     it_death = &quot;it-death&quot;,
     it_floppy = &quot;it-floppy&quot;,
@@ -160,6 +161,7 @@
     it_meditation_dent = &quot;it-tinyhollow&quot;,
     it_meditation_bump = &quot;it-tinyhill&quot;,
     it_meditation_hill = &quot;it-hill&quot;,
+    it_pencil = &quot;it-pencil&quot;,
     it_pipe_w = &quot;it-pipe-w&quot;,
     it_pipe_s = &quot;it-pipe-s&quot;,
     it_pipe_sw = &quot;it-pipe-sw&quot;,
@@ -170,6 +172,10 @@
     it_pipe_nw = &quot;it-pipe-wn&quot;,
     it_pipe_ns = &quot;it-pipe-v&quot;,
     it_pipe_ne = &quot;it-pipe-ne&quot;,
+    it_puller_w = &quot;it-puller-w&quot;,
+    it_puller_s = &quot;it-puller-s&quot;,
+    it_puller_e = &quot;it-puller-e&quot;,
+    it_puller_n = &quot;it-puller-n&quot;,
     it_ring = &quot;it-ring&quot;,
     it_rubberband = &quot;it-rubberband&quot;,
     it_seed = &quot;it-seed&quot;,

Modified: trunk/data/api2init.lua
===================================================================
--- trunk/data/api2init.lua	2009-01-25 18:17:10 UTC (rev 1484)
+++ trunk/data/api2init.lua	2009-01-25 21:58:42 UTC (rev 1485)
@@ -519,7 +519,7 @@
         if tile == nil then
             tile = subtile
         else
-            tile = tile .. subtile
+            tile = subtile .. tile
         end
         if #key == 3 then
             subkey = string.sub(key, 1, i-1) .. &quot; &quot; .. string.sub(key, i+1)

Deleted: trunk/data/gfx32/it-document.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx32/it-pencil.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx32/it-puller.png
===================================================================
(Binary files differ)

Copied: trunk/data/gfx32/it_document.png (from rev 1483, trunk/data/gfx32/it-document.png)

Copied: trunk/data/gfx32/it_pencil.png (from rev 1483, trunk/data/gfx32/it-pencil.png)

Copied: trunk/data/gfx32/it_puller.png (from rev 1483, trunk/data/gfx32/it-puller.png)

Deleted: trunk/data/gfx40/it-document.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx40/it-pencil.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx40/it-puller.png
===================================================================
(Binary files differ)

Copied: trunk/data/gfx40/it_document.png (from rev 1483, trunk/data/gfx40/it-document.png)

Copied: trunk/data/gfx40/it_pencil.png (from rev 1483, trunk/data/gfx40/it-pencil.png)

Copied: trunk/data/gfx40/it_puller.png (from rev 1483, trunk/data/gfx40/it-puller.png)

Deleted: trunk/data/gfx48/it-document.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx48/it-pencil.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx48/it-puller.png
===================================================================
(Binary files differ)

Copied: trunk/data/gfx48/it_document.png (from rev 1483, trunk/data/gfx48/it-document.png)

Copied: trunk/data/gfx48/it_pencil.png (from rev 1483, trunk/data/gfx48/it-pencil.png)

Copied: trunk/data/gfx48/it_puller.png (from rev 1483, trunk/data/gfx48/it-puller.png)

Modified: trunk/data/models-2d.lua
===================================================================
--- trunk/data/models-2d.lua	2009-01-25 18:17:10 UTC (rev 1484)
+++ trunk/data/models-2d.lua	2009-01-25 21:58:42 UTC (rev 1485)
@@ -455,13 +455,13 @@
         &quot;it-blocker&quot;,
         &quot;it-booze&quot;,
         &quot;it-booze-broken&quot;,
-        &quot;it-document&quot;,
+        &quot;it_document&quot;,
         &quot;it-drop&quot;,
         &quot;it-dynamite&quot;,
         &quot;it-flagblack&quot;,
         &quot;it-flagwhite&quot;,
         &quot;it-odometer&quot;,
-        &quot;it-pencil&quot;,
+        &quot;it_pencil&quot;,
         &quot;it-pin&quot;,
         &quot;it_ring&quot;,
         &quot;it_spade&quot;,
@@ -645,10 +645,10 @@
 
 -- it-puller --
 do
-    local images = {&quot;it-puller-n&quot;, &quot;it-puller-e&quot;, &quot;it-puller-s&quot;, &quot;it-puller-w&quot;}
-    DefTiles(&quot;it-puller&quot;, images)
+    local images = {&quot;it_puller_n&quot;, &quot;it_puller_e&quot;, &quot;it_puller_s&quot;, &quot;it_puller_w&quot;}
+    DefTiles(&quot;it_puller&quot;, images)
     local frames = BuildFrames(images, 100)
-    DefAnim(&quot;it-puller-active&quot;, RepeatAnim(frames, 4), false)
+    DefAnim(&quot;it_puller_active&quot;, RepeatAnim(frames, 4), false)
 end
 
 -- it-seed --

Modified: trunk/data/schemas/objects.xml
===================================================================
--- trunk/data/schemas/objects.xml	2009-01-25 18:17:10 UTC (rev 1484)
+++ trunk/data/schemas/objects.xml	2009-01-25 21:58:42 UTC (rev 1485)
@@ -79,6 +79,7 @@
     &lt;attr name=&quot;steady&quot; type=&quot;bool&quot; default=&quot;false&quot; rw=&quot;rw&quot;/&gt;
     &lt;attr name=&quot;strength&quot; type=&quot;double&quot; default=&quot;1&quot; rw=&quot;rw&quot;/&gt;
     &lt;attr name=&quot;target&quot; type=&quot;tokens&quot; default=&quot;nil&quot; rw=&quot;rw&quot;/&gt;
+    &lt;attr name=&quot;text&quot; type=&quot;string&quot; default=&quot;nil&quot; rw=&quot;rw&quot;/&gt;
     &lt;attr name=&quot;transparent&quot; type=&quot;bool&quot; default=&quot;false&quot; rw=&quot;rw&quot;/&gt;
     &lt;attr name=&quot;threshold&quot; type=&quot;double&quot; default=&quot;0&quot; rw=&quot;rw&quot;/&gt;
     &lt;attr name=&quot;velocity_x&quot; type=&quot;double&quot; default=&quot;nil&quot; rw=&quot;rw&quot;/&gt;
@@ -420,6 +421,9 @@
       &lt;msg name=&quot;signal&quot;/&gt;
     &lt;/object&gt;
     &lt;object name=&quot;it_death&quot;/&gt;
+    &lt;object name=&quot;it_document&quot;&gt;
+      &lt;attr name=&quot;text&quot;/&gt;
+    &lt;/object&gt;
     &lt;object name=&quot;it_extralife&quot;/&gt;
     &lt;object name=&quot;it_extralife_new&quot; init=&quot;true&quot;/&gt;
     &lt;object name=&quot;it_floppy&quot;/&gt;
@@ -476,6 +480,7 @@
     &lt;object name=&quot;it_meditation_volcano&quot;&gt;
       &lt;attr name=&quot;state&quot; value=&quot;3&quot;/&gt;
     &lt;/object&gt;
+    &lt;object name=&quot;it_pencil&quot;/&gt;
     &lt;object name=&quot;it_pipe&quot;&gt;
       &lt;attr name=&quot;connections&quot;/&gt;
       &lt;msg name=&quot;_explosion&quot;/&gt;
@@ -510,6 +515,21 @@
     &lt;object name=&quot;it_pipe_ne&quot;&gt;
       &lt;attr name=&quot;connections&quot; value=&quot;ne&quot;/&gt;
     &lt;/object&gt;
+    &lt;object name=&quot;it_puller&quot;&gt;
+      &lt;attr name=&quot;orientation&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;it_puller_w&quot;&gt;
+      &lt;attr name=&quot;orientation&quot; value=&quot;0&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;it_puller_s&quot;&gt;
+      &lt;attr name=&quot;orientation&quot; value=&quot;1&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;it_puller_e&quot;&gt;
+      &lt;attr name=&quot;orientation&quot; value=&quot;2&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;it_puller_n&quot;&gt;
+      &lt;attr name=&quot;orientation&quot; value=&quot;3&quot;/&gt;
+    &lt;/object&gt;
     &lt;object name=&quot;it_rubberband&quot;&gt;
       &lt;attr name=&quot;anchor2&quot;/&gt;
       &lt;attr name=&quot;strength&quot; default=&quot;10&quot;/&gt;

Modified: trunk/src/Makefile.am
===================================================================
--- trunk/src/Makefile.am	2009-01-25 18:17:10 UTC (rev 1484)
+++ trunk/src/Makefile.am	2009-01-25 21:58:42 UTC (rev 1485)
@@ -210,18 +210,26 @@
 	items/Coin.hh		\
 	items/Crack.cc		\
 	items/Crack.hh		\
+	items/CrossItem.cc	\
+	items/CrossItem.hh	\
+	items/DocumentItem.cc	\
+	items/DocumentItem.hh	\
 	items/ExtraLife.cc	\
 	items/ExtraLife.hh	\
 	items/GlassesItem.cc	\
 	items/GlassesItem.hh	\
 	items/Hammer.cc		\
 	items/Hammer.hh		\
+	items/Landmine.cc	\
+	items/Landmine.hh	\
 	items/Magnet.cc		\
 	items/Magnet.hh		\
 	items/Meditation.cc	\
 	items/Meditation.hh	\
 	items/PipeItem.cc	\
 	items/PipeItem.hh	\
+	items/PullerItem.cc	\
+	items/PullerItem.hh	\
 	items/RubberbandItem.cc	\
 	items/RubberbandItem.hh	\
 	items/SeedItem.cc	\
@@ -236,6 +244,8 @@
 	items/StripItem.hh	\
 	items/Sword.cc		\
 	items/Sword.hh		\
+	items/TrapItem.cc	\
+	items/TrapItem.hh	\
 	items/Trigger.cc	\
 	items/Trigger.hh	\
 	items/Umbrella.cc	\

Added: trunk/src/items/CrossItem.cc
===================================================================
--- trunk/src/items/CrossItem.cc	2009-01-25 18:17:10 UTC (rev 1484)
+++ trunk/src/items/CrossItem.cc	2009-01-25 21:58:42 UTC (rev 1485)
@@ -0,0 +1,79 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2009 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *  
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include &quot;items/CrossItem.hh&quot;
+//#include &quot;errors.hh&quot;
+//#include &quot;main.hh&quot;
+//#include &quot;player.hh&quot;
+#include &quot;server.hh&quot;
+#include &quot;world.hh&quot;
+
+namespace enigma {
+
+    CrossItem::~CrossItem() {
+        GameTimer.remove_alarm(this);
+    }
+    
+    Value CrossItem::message(const Message &amp;m) {
+        if (server::GameCompatibility == enigma::GAMET_PEROXYD) {
+            // CrossItemes can be used to invert signals in Per.Oxyd
+            if (m.message == &quot;signal&quot;) {
+                performAction(!m.value.to_bool()); // convert 1/0 values to true/false
+                return Value();
+            }
+        } else if (enigma_server::GameCompatibility == GAMET_ENIGMA) {
+            if (m.message == &quot;_brush&quot;) {
+                KillItem(this-&gt;get_pos());
+                return Value();
+            }
+        }
+        return Item::message(m);
+    }
+    
+    void CrossItem::setState(int extState) {
+        return;   // ignore any write attempts
+    }
+
+    void CrossItem::actor_enter(Actor *a) {
+        if ((state == 0) &amp;&amp; a-&gt;getAttr(&quot;owner&quot;)) {
+            state = 1;
+            GameTimer.set_alarm (this, getAttr(&quot;interval&quot;));
+        }
+    }
+
+    void CrossItem::actor_leave(Actor *) {
+        if (state == 1) {
+            GameTimer.remove_alarm (this);
+            state = 0;
+        }
+    }
+
+    void CrossItem::alarm() {
+        state = 0;
+        performAction(true);
+    }
+    
+    DEF_ITEMTRAITSF(CrossItem, &quot;it_cross&quot;, it_cross, itf_static);
+
+    BOOT_REGISTER_START
+        BootRegister(new CrossItem(), &quot;it_cross&quot;);
+    BOOT_REGISTER_END
+
+} // namespace enigma


Property changes on: trunk/src/items/CrossItem.cc
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/items/CrossItem.hh
===================================================================
--- trunk/src/items/CrossItem.hh	2009-01-25 18:17:10 UTC (rev 1484)
+++ trunk/src/items/CrossItem.hh	2009-01-25 21:58:42 UTC (rev 1485)
@@ -0,0 +1,52 @@
+/*
+ * Copyright (C) 2009 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef CROSSITEM_HH
+#define CROSSITEM_HH
+
+#include &quot;items.hh&quot;
+
+#include &quot;util.hh&quot;
+
+namespace enigma {
+    /**
+     */
+    class CrossItem : public Item, public TimeHandler {
+        CLONEOBJ(CrossItem);
+        DECL_ITEMTRAITS;
+
+    public:
+        virtual ~CrossItem();
+        
+        // Object interface
+        virtual Value message(const Message &amp;m);
+        
+        // StateObject interface
+        virtual void setState(int extState);
+        
+        // Item interface
+        virtual void actor_enter(Actor *a);
+        virtual void actor_leave(Actor *a);
+
+        // TimeHandler interface
+        virtual void alarm();
+    };
+   
+} // namespace enigma
+
+#endif


Property changes on: trunk/src/items/CrossItem.hh
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/items/DocumentItem.cc
===================================================================
--- trunk/src/items/DocumentItem.cc	2009-01-25 18:17:10 UTC (rev 1484)
+++ trunk/src/items/DocumentItem.cc	2009-01-25 21:58:42 UTC (rev 1485)
@@ -0,0 +1,71 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2009 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *  
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include &quot;items/DocumentItem.hh&quot;
+#include &quot;client.hh&quot;
+//#include &quot;errors.hh&quot;
+//#include &quot;main.hh&quot;
+//#include &quot;player.hh&quot;
+#include &quot;lev/Proxy.hh&quot;
+#include &quot;world.hh&quot;
+
+namespace enigma {
+
+    DocumentItem::DocumentItem() : Item() {
+    }
+    
+    Value DocumentItem::message(const Message &amp;m) {
+        bool explode = false;
+
+        if (m.message == &quot;ignite&quot;) {
+            // dynamite does not blow up Documents in Oxyd1
+            explode = server::GameCompatibility != GAMET_OXYD1;
+        } else if (m.message == &quot;_explosion&quot; || m.message == &quot;_bombstone&quot;) {
+            explode = true;
+        } else {
+            return Item::message(m);
+        }
+
+        if (explode)
+            replace(&quot;it-explosion1&quot;);
+        return Value();
+    }
+    
+    ItemAction DocumentItem::activate(Actor *a, GridPos) {
+        if (Value v = getAttr(&quot;text&quot;)) {
+            std::string txt(v);
+            lev::Proxy *level = lev::Proxy::loadedLevel();
+            // after complete switch to Proxy as levelloader the following
+            // conditional can be abolished
+            if (level)
+                // translate text
+                txt = level-&gt;getLocalizedString(txt);
+            client::Msg_ShowText(txt, true);
+        }
+        return ITEM_KILL;          // remove from inventory
+    }
+
+    DEF_ITEMTRAITSF(DocumentItem, &quot;it_document&quot;, it_document, itf_inflammable);
+
+    BOOT_REGISTER_START
+        BootRegister(new DocumentItem(), &quot;it_document&quot;);
+    BOOT_REGISTER_END
+
+} // namespace enigma


Property changes on: trunk/src/items/DocumentItem.cc
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/items/DocumentItem.hh
===================================================================
--- trunk/src/items/DocumentItem.hh	2009-01-25 18:17:10 UTC (rev 1484)
+++ trunk/src/items/DocumentItem.hh	2009-01-25 21:58:42 UTC (rev 1485)
@@ -0,0 +1,43 @@
+/*
+ * Copyright (C) 2009 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef DOCUMENTITEM_HH
+#define DOCUMENTITEM_HH
+
+#include &quot;items.hh&quot;
+
+namespace enigma {
+    /**
+     */
+    class DocumentItem : public Item {
+        CLONEOBJ(DocumentItem);
+        DECL_ITEMTRAITS;
+
+    public:
+        DocumentItem();
+
+        // Object interface
+        virtual Value message(const Message &amp;m);
+        
+        // Item interface
+        virtual ItemAction activate(Actor* a, GridPos p);
+    };
+   
+} // namespace enigma
+
+#endif


Property changes on: trunk/src/items/DocumentItem.hh
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/items/Landmine.cc
===================================================================
--- trunk/src/items/Landmine.cc	2009-01-25 18:17:10 UTC (rev 1484)
+++ trunk/src/items/Landmine.cc	2009-01-25 21:58:42 UTC (rev 1485)
@@ -0,0 +1,58 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2009 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *  
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include &quot;items/Landmine.hh&quot;
+//#include &quot;errors.hh&quot;
+//#include &quot;main.hh&quot;
+//#include &quot;player.hh&quot;
+#include &quot;world.hh&quot;
+
+namespace enigma {
+
+    Landmine::Landmine() {
+    }
+    
+    bool Landmine::actor_hit (Actor *a) {
+        const double ITEM_RADIUS = 0.3;
+        if (!a-&gt;is_flying()) {
+            double dist = length(a-&gt;get_pos() - get_pos().center());
+            if (dist &lt; ITEM_RADIUS)
+                explode();
+        }
+        return false;
+    }
+    
+    void Landmine::on_stonehit(Stone *st) { 
+        explode();
+    }
+    
+    void Landmine::explode() {
+        sound_event (&quot;landmine&quot;);
+        replace(&quot;it-explosion2&quot;);
+    }
+
+    DEF_ITEMTRAITSF(Landmine, &quot;it_landmine&quot;, it_landmine, itf_static);
+        
+
+    BOOT_REGISTER_START
+        BootRegister(new Landmine(), &quot;it_landmine&quot;);
+    BOOT_REGISTER_END
+
+} // namespace enigma


Property changes on: trunk/src/items/Landmine.cc
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/items/Landmine.hh
===================================================================
--- trunk/src/items/Landmine.hh	2009-01-25 18:17:10 UTC (rev 1484)
+++ trunk/src/items/Landmine.hh	2009-01-25 21:58:42 UTC (rev 1485)
@@ -0,0 +1,44 @@
+/*
+ * Copyright (C) 2009 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef LANDMINEITEM_HH
+#define LANDMINEITEM_HH
+
+#include &quot;items.hh&quot;
+
+namespace enigma {
+    /**
+     */
+    class Landmine : public Item {
+        CLONEOBJ(Landmine);
+        DECL_ITEMTRAITS;
+
+    public:
+        Landmine();
+
+        // Item interface
+        virtual bool actor_hit(Actor *a);
+        virtual void on_stonehit(Stone *st);
+    
+    private:
+        void explode();
+    };
+   
+} // namespace enigma
+
+#endif


Property changes on: trunk/src/items/Landmine.hh
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/items/PullerItem.cc
===================================================================
--- trunk/src/items/PullerItem.cc	2009-01-25 18:17:10 UTC (rev 1484)
+++ trunk/src/items/PullerItem.cc	2009-01-25 21:58:42 UTC (rev 1485)
@@ -0,0 +1,100 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2009 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *  
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include &quot;items/PullerItem.hh&quot;
+//#include &quot;errors.hh&quot;
+//#include &quot;main.hh&quot;
+#include &quot;world.hh&quot;
+
+namespace enigma {
+
+    PullerItem::PullerItem(int dir) {
+        objFlags |= (dir &lt;&lt; 24);
+    }
+    
+    std::string PullerItem::getClass() const {
+        return &quot;it_puller&quot;;
+    }
+    
+    void PullerItem::setAttr(const string&amp; key, const Value &amp;val) {
+        if (key == &quot;orientation&quot;) {
+            objFlags = (objFlags &amp; ~OBJBIT_ORIENTATION) | ((int)(val) &gt;&gt; 24);
+        }
+        Item::setAttr(key, val);
+    }
+
+    Value PullerItem::getAttr(const std::string &amp;key) const {
+        if (key == &quot;orientation&quot;) {
+            return orientation();
+        }
+        return Item::getAttr(key);
+    }
+    
+    void PullerItem::animcb() {
+        Direction dir = (Direction)orientation();
+        
+        // usage within a st-window
+        Stone *stone = GetStone(get_pos());
+        if (stone &amp;&amp; (stone-&gt;getClass() == &quot;st_window&quot;) &amp;&amp;
+                to_bool(SendMessage(stone, &quot;inner_pull&quot;, dir))) {
+        }
+        
+        // usage in front of a stone
+        else {
+            GridPos stonepos = move(get_pos(), reverse(dir));
+            send_impulse(stonepos, dir);
+        }
+        
+        sound_event (&quot;dynamite&quot;);
+        replace(&quot;it-explosion1&quot;);
+    }
+    
+    bool PullerItem::isStatic() const {
+        return state == ACTIVE;  // active puller is static
+    }
+
+    void PullerItem::on_drop(Actor *) {
+        // the puller needs to be dropped first before we can activate it
+        state = ACTIVE;
+        set_anim(&quot;it_puller_active&quot;);
+        sound_event(&quot;puller&quot;);
+    }
+    
+    int PullerItem::orientation() const {
+        return (objFlags &amp; OBJBIT_ORIENTATION) &gt;&gt; 24;
+    }
+
+    ItemTraits PullerItem::traits[4] = {
+        { &quot;it_puller_w&quot;, it_puller_w, itf_none, 0.0 },
+        { &quot;it_puller_s&quot;, it_puller_s, itf_none, 0.0 },
+        { &quot;it_puller_e&quot;, it_puller_e, itf_none, 0.0 },
+        { &quot;it_puller_n&quot;, it_puller_n, itf_none, 0.0 },
+    };
+        
+
+    BOOT_REGISTER_START
+        BootRegister(new PullerItem(0), &quot;it_puller&quot;);
+        BootRegister(new PullerItem(0), &quot;it_puller_w&quot;);
+        BootRegister(new PullerItem(1), &quot;it_puller_s&quot;);
+        BootRegister(new PullerItem(2), &quot;it_puller_e&quot;);
+        BootRegister(new PullerItem(3), &quot;it_puller_n&quot;);
+    BOOT_REGISTER_END
+
+} // namespace enigma


Property changes on: trunk/src/items/PullerItem.cc
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/items/PullerItem.hh
===================================================================
--- trunk/src/items/PullerItem.hh	2009-01-25 18:17:10 UTC (rev 1484)
+++ trunk/src/items/PullerItem.hh	2009-01-25 21:58:42 UTC (rev 1485)
@@ -0,0 +1,61 @@
+/*
+ * Copyright (C) 2009 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef PULLERITEM_HH
+#define PULLERITEM_HH
+
+#include &quot;items.hh&quot;
+
+namespace enigma {
+    /**
+     */
+    class PullerItem : public Item {
+        CLONEOBJ(PullerItem);
+        DECL_ITEMTRAITS_ARRAY(4, orientation());
+
+    private:
+        enum iState {
+            IDLE, 
+            ACTIVE 
+        };
+        enum ObjectPrivatFlagsBits {
+            OBJBIT_ORIENTATION =   3&lt;&lt;24,    ///&lt;
+        };
+         
+    public:
+        PullerItem(int dir);
+
+        // Object interface
+        virtual std::string getClass() const;
+        virtual void setAttr(const string&amp; key, const Value &amp;val);
+        virtual Value getAttr(const std::string &amp;key) const;
+
+        // ModelCallback interface
+        virtual void animcb();
+        
+        // Item interface
+        virtual bool isStatic() const;
+        virtual void on_drop(Actor *a);
+    
+    private:
+        int orientation() const;
+    };
+   
+} // namespace enigma
+
+#endif


Property changes on: trunk/src/items/PullerItem.hh
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/src/items/SimpleItems.cc
===================================================================
--- trunk/src/items/SimpleItems.cc	2009-01-25 18:17:10 UTC (rev 1484)
+++ trunk/src/items/SimpleItems.cc	2009-01-25 21:58:42 UTC (rev 1485)
@@ -97,12 +97,50 @@
     
     DEF_ITEMTRAITSF(DeathItem, &quot;it_death&quot;, it_death, itf_static | itf_indestructible);
 
+/* -------------------- Pencil -------------------- */
+
+    Pencil::Pencil() {
+    }
+    
+    ItemAction Pencil::activate(Actor *a, GridPos p) {
+        if (enigma_server::GameCompatibility == GAMET_ENIGMA) {
+            if (Item *it=GetItem(p)) {
+                return ITEM_KEEP;
+            }
+            // If the actor is flying and tries to make a cross, drop the it-pencil
+            if (a-&gt;is_flying()) {
+                return ITEM_DROP;
+            }
+
+            Floor *fl = GetFloor(p);
+            std::string floor = fl-&gt;getClass();
+
+            /* do not allow markings on this floortypes:
+               fl_abyss, fl_water, fl_swamp
+               fl-bridge[{-closed,-open}]?
+               markings on fl_ice will result as it-crack1
+            */
+            if (floor == &quot;fl_abyss&quot; || floor == &quot;fl_water&quot; || floor == &quot;fl_swamp&quot; || floor == &quot;fl_bridge&quot; ) {
+                return ITEM_KEEP;
+            } else if (floor == &quot;fl_ice&quot;) {
+                SetItem(p, MakeItem(&quot;it_crack_s&quot;));
+            } else {
+                Item *newItem = MakeItem(&quot;it_cross&quot;);
+                transferIdentity(newItem);
+                SetItem(p, newItem);
+            }
+            return ITEM_KILL;
+        }
+    }
+    
+    DEF_ITEMTRAITS(Pencil, &quot;it_pencil&quot;, it_pencil);
+    
 /* -------------------- Ring -------------------- */
 
     Ring::Ring() {
     }
     
-    ItemAction Ring::activate(Actor *a, GridPos) {
+    ItemAction Ring::activate(Actor *a, GridPos p) {
         if (ExchangeMarbles(a)) {
             sound_event(&quot;switchmarbles&quot;);
         }
@@ -189,6 +227,7 @@
         BootRegister(new Floppy(), &quot;it_floppy&quot;);
         BootRegister(new MagicWand(), &quot;it_magicwand&quot;);
         BootRegister(new Key(), &quot;it_key&quot;);
+        BootRegister(new Pencil(), &quot;it_pencil&quot;);
         BootRegister(new Ring(), &quot;it_ring&quot;);
         BootRegister(new Spade(), &quot;it_spade&quot;);
         BootRegister(new Spoon(), &quot;it_spoon&quot;);

Modified: trunk/src/items/SimpleItems.hh
===================================================================
--- trunk/src/items/SimpleItems.hh	2009-01-25 18:17:10 UTC (rev 1484)
+++ trunk/src/items/SimpleItems.hh	2009-01-25 21:58:42 UTC (rev 1485)
@@ -111,6 +111,21 @@
     DEF_ITEM(Key, &quot;it_key&quot;, it_key);
 
     /**
+     * Pencil
+     */
+    class Pencil : public Item {
+        CLONEOBJ(Pencil);
+        DECL_ITEMTRAITS;
+
+    public:
+        Pencil();
+        
+        // Item interface
+        virtual ItemAction activate(Actor* a, GridPos p);
+    };
+
+
+    /**
      * Ring
      */
     class Ring : public Item {

Added: trunk/src/items/TrapItem.cc
===================================================================
--- trunk/src/items/TrapItem.cc	2009-01-25 18:17:10 UTC (rev 1484)
+++ trunk/src/items/TrapItem.cc	2009-01-25 21:58:42 UTC (rev 1485)
@@ -0,0 +1,77 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2009 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *  
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include &quot;items/TrapItem.hh&quot;
+//#include &quot;errors.hh&quot;
+//#include &quot;main.hh&quot;
+//#include &quot;player.hh&quot;
+#include &quot;items/GlassesItem.hh&quot;
+#include &quot;world.hh&quot;
+
+namespace enigma {
+
+    TrapItem::TrapItem() {
+    }
+    
+    Value TrapItem::message(const Message &amp;m) {
+        if (m.message == &quot;_glasses&quot;) {
+            if (isDisplayable())
+                init_model();            
+        }
+        return Item::message(m);
+    }
+    
+    void TrapItem::setState(int extState) {
+        if (state == 0) {       // no toggle back of a broken (open) trap
+            state == extState;
+            init_model();
+        }
+    }
+    
+    void TrapItem::init_model() {
+        if (state == 0 &amp;&amp; ((server::GlassesVisibility &amp; Glasses::TRAP) == 0))
+            set_model(&quot;invisible&quot;);
+        else
+            set_model(&quot;it_trap&quot;);
+        
+    }
+    
+    void TrapItem::animcb() {
+        init_model();
+    }
+    
+    bool TrapItem::actor_hit(Actor *a) {
+        if (!a-&gt;is_flying()) {
+            SendMessage(a, &quot;_fall&quot;);
+            if (state == 0) {
+                state = 1;
+                set_anim(&quot;it_trap_breaking&quot;);
+            }
+        }
+        return false;
+    }
+        
+    DEF_ITEMTRAITSF(TrapItem, &quot;it_trap&quot;, it_trap, itf_static | itf_fireproof);
+
+    BOOT_REGISTER_START
+        BootRegister(new TrapItem(), &quot;it_trap&quot;);
+    BOOT_REGISTER_END
+
+} // namespace enigma


Property changes on: trunk/src/items/TrapItem.cc
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/items/TrapItem.hh
===================================================================
--- trunk/src/items/TrapItem.hh	2009-01-25 18:17:10 UTC (rev 1484)
+++ trunk/src/items/TrapItem.hh	2009-01-25 21:58:42 UTC (rev 1485)
@@ -0,0 +1,52 @@
+/*
+ * Copyright (C) 2009 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef TRAPITEM_HH
+#define TRAPITEM_HH
+
+#include &quot;items.hh&quot;
+
+namespace enigma {
+    /**
+     */
+    class TrapItem : public Item {
+        CLONEOBJ(TrapItem);
+        DECL_ITEMTRAITS;
+    
+    public:
+        TrapItem();
+        
+        // Object interface
+        virtual Value message(const Message &amp;m);
+        
+        // StateObject interface
+        virtual void setState(int extState);
+        
+        // GridObject interface
+        virtual void init_model();
+
+        // ModelCallback interface
+        virtual void animcb();
+
+        // Item interface
+        virtual bool actor_hit(Actor *a);        
+    };
+   
+} // namespace enigma
+
+#endif


Property changes on: trunk/src/items/TrapItem.hh
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/src/items.cc
===================================================================
--- trunk/src/items.cc	2009-01-25 18:17:10 UTC (rev 1484)
+++ trunk/src/items.cc	2009-01-25 21:58:42 UTC (rev 1485)
@@ -419,54 +419,6 @@
 }
 
 
-
-
-/* -------------------- Document -------------------- */
-namespace
-{
-    class Document : public Item {
-        CLONEOBJ(Document);
-        DECL_ITEMTRAITS;
-
-        ItemAction activate(Actor *, GridPos)
-        {
-            if (Value v = getAttr(&quot;text&quot;)) {
-                std::string txt(v);
-                lev::Proxy *level = lev::Proxy::loadedLevel();
-                // after complete switch to Proxy as levelloader the following
-                // conditional can be abolished
-                if (level)
-                    // translate text
-                    txt = level-&gt;getLocalizedString(txt);
-                client::Msg_ShowText (txt, true);
-            }
-            return ITEM_KILL;	       // remove from inventory
-        }
-        virtual Value message(const Message &amp;m) {
-            bool explode = false;
-
-            if (m.message == &quot;ignite&quot;) {
-                // dynamite does not blow up Documents in Oxyd1
-                explode = server::GameCompatibility != GAMET_OXYD1;
-            } else if (m.message == &quot;_explosion&quot; || m.message == &quot;_bombstone&quot;) {
-                explode = true;
-            } else {
-                return Item::message(m);
-            }
-
-            if (explode)
-                replace(&quot;it-explosion1&quot;);
-            return Value();
-        }
-    public:
-        Document() {
-            setAttr(&quot;text&quot;, &quot;&quot;);
-        }
-    };
-    DEF_ITEMTRAITSF(Document, &quot;it-document&quot;, it_document, itf_inflammable);
-}
-
-
 /* -------------------- Dynamite -------------------- */
 namespace
 {
@@ -677,71 +629,6 @@
                 itf_static | itf_indestructible | itf_fireproof);
 }
 
-/* -------------------- Pullers -------------------- */
-namespace
-{
-    class Puller : public Item {
-        CLONEOBJ (Puller);
-        DECL_ITEMTRAITS_ARRAY(4, get_orientation());
-
-        bool active;
-        Direction m_direction;
-
-        void on_drop(Actor *) { activate(); }
-
-        void activate() {
-            active=true;
-            set_anim(&quot;it-puller-active&quot;);
-            sound_event (&quot;puller&quot;);
-        }
-        void animcb() {
-            Direction dir = get_orientation();
-            
-            // usage within a st-window
-            Stone *stone = GetStone(get_pos());
-            if (stone &amp;&amp; (stone-&gt;get_traits().id == st_window) &amp;&amp;
-                    to_bool(SendMessage(stone, &quot;inner_pull&quot;, dir))) {
-            }
-            
-            // usage in front of a stone
-            else {
-                GridPos   stonepos = move(get_pos(), reverse(dir));
-                send_impulse(stonepos, dir);
-            }
-            
-            sound_event (&quot;dynamite&quot;);
-            replace(&quot;it-explosion1&quot;);
-        }
-
-	Direction get_orientation() const {
-	    return m_direction;
-	}
-
-        Puller(Direction dir)
-        : active(false), m_direction(dir)
-	{ }
-    
-        virtual bool isStatic() const {
-            return active;  // active puller is static
-        }
-        
-    public:
-        static void setup() {
-            RegisterItem (new Puller(NORTH));
-            RegisterItem (new Puller(EAST));
-            RegisterItem (new Puller(SOUTH));
-            RegisterItem (new Puller(WEST));
-        }
-    };
-
-    ItemTraits Puller::traits[4] = {
-        { &quot;it-puller-w&quot;, it_puller_w, itf_none, 0.0 },
-        { &quot;it-puller-s&quot;, it_puller_s, itf_none, 0.0 },
-        { &quot;it-puller-e&quot;, it_puller_e, itf_none, 0.0 },
-        { &quot;it-puller-n&quot;, it_puller_n, itf_none, 0.0 },
-    };
-}
-
 /* -------------------- Debris -------------------- */
 namespace
 {
@@ -1129,184 +1016,6 @@
                 itf_invisible | itf_fireproof);
 }
 
-/* -------------------- Invisible Trap -------------------- */
-    class Trap : public Item {
-        CLONEOBJ(Trap);
-        DECL_ITEMTRAITS;
-    
-    public:
-        Trap();
-        
-        // Object interface
-        virtual Value message(const Message &amp;m);
-        
-        // StateObject interface
-        virtual void setState(int extState);
-        
-        // GridObject interface
-        virtual void init_model();
-
-        // ModelCallback interface
-        virtual void animcb();
-
-        // Item interface
-        virtual bool actor_hit(Actor *a);        
-    };
-    
-    Trap::Trap() {
-    }
-    
-    Value Trap::message(const Message &amp;m) {
-        if (m.message == &quot;_glasses&quot;) {
-            if (isDisplayable())
-                init_model();            
-        }
-        return Item::message(m);
-    }
-    
-    void Trap::setState(int extState) {
-        if (state == 0) {       // no toggle back of a broken (open) trap
-            state == extState;
-            init_model();
-        }
-    }
-    
-    void Trap::init_model() {
-        if (state == 0 &amp;&amp; ((server::GlassesVisibility &amp; Glasses::TRAP) == 0))
-            set_model(&quot;invisible&quot;);
-        else
-            set_model(&quot;it_trap&quot;);
-        
-    }
-    
-    void Trap::animcb() {
-        init_model();
-    }
-    
-    bool Trap::actor_hit(Actor *a) {
-        if (!a-&gt;is_flying()) {
-            SendMessage(a, &quot;_fall&quot;);
-            if (state == 0) {
-                state = 1;
-                set_anim(&quot;it_trap_breaking&quot;);
-            }
-        }
-        return false;
-    }
-        
-    DEF_ITEMTRAITSF(Trap, &quot;it_trap&quot;, it_trap, itf_static | itf_fireproof);
-
-
-/* -------------------- Landmine -------------------- */
-    class Landmine : public Item {
-        CLONEOBJ(Landmine);
-        DECL_ITEMTRAITS;
-
-    public:
-        Landmine();
-
-        // Item interface
-        virtual bool actor_hit(Actor *a);
-        virtual void on_stonehit(Stone *st);
-    
-    private:
-        void explode();
-    };
-
-    Landmine::Landmine() {
-    }
-    
-    bool Landmine::actor_hit (Actor *a) {
-        const double ITEM_RADIUS = 0.3;
-        if (!a-&gt;is_flying()) {
-            double dist = length(a-&gt;get_pos() - get_pos().center());
-            if (dist &lt; ITEM_RADIUS)
-                explode();
-        }
-        return false;
-    }
-    
-    void Landmine::on_stonehit(Stone *st) { 
-        explode();
-    }
-    
-	void Landmine::explode() {
-        sound_event (&quot;landmine&quot;);
-        replace(&quot;it-explosion2&quot;);
-	}
-
-    DEF_ITEMTRAITSF(Landmine, &quot;it_landmine&quot;, it_landmine, itf_static);
-
-
-/* -------------------- Cross -------------------- */
-    class Cross : public Item, public TimeHandler {
-        CLONEOBJ(Cross);
-        DECL_ITEMTRAITS;
-
-    public:
-        virtual ~Cross();
-        
-        // Object interface
-        virtual Value message(const Message &amp;m);
-        
-        // StateObject interface
-        virtual void setState(int extState);
-        
-        // Item interface
-        virtual void actor_enter(Actor *a);
-        virtual void actor_leave(Actor *a);
-
-        // TimeHandler interface
-        virtual void alarm();
-    };
-        
-    Cross::~Cross() {
-        GameTimer.remove_alarm(this);
-    }
-    
-    Value Cross::message(const Message &amp;m) {
-        if (server::GameCompatibility == enigma::GAMET_PEROXYD) {
-            // Crosses can be used to invert signals in Per.Oxyd
-            if (m.message == &quot;signal&quot;) {
-                performAction(!m.value.to_bool()); // convert 1/0 values to true/false
-                return Value();
-            }
-        } else if (enigma_server::GameCompatibility == GAMET_ENIGMA) {
-            if (m.message == &quot;_brush&quot;) {
-                KillItem(this-&gt;get_pos());
-                return Value();
-            }
-        }
-        return Item::message(m);
-    }
-    
-    void Cross::setState(int extState) {
-        return;   // ignore any write attempts
-    }
-
-    void Cross::actor_enter(Actor *a) {
-        if ((state == 0) &amp;&amp; a-&gt;getAttr(&quot;owner&quot;)) {
-            state = 1;
-            GameTimer.set_alarm (this, getAttr(&quot;interval&quot;));
-        }
-    }
-
-    void Cross::actor_leave(Actor *) {
-        if (state == 1) {
-            GameTimer.remove_alarm (this);
-            state = 0;
-        }
-    }
-
-    void Cross::alarm() {
-        state = 0;
-        performAction(true);
-    }
-    
-    DEF_ITEMTRAITSF(Cross, &quot;it_cross&quot;, it_cross, itf_static);
-
-
-
 /* -------------------- Bag -------------------- */
 namespace
 {
@@ -1410,49 +1119,6 @@
     DEF_ITEMTRAITS(Bag, &quot;it-bag&quot;, it_bag);
 }
 
-/* -------------------- pencil -------------------- */
-namespace
-{
-    class Pencil : public Item {
-        CLONEOBJ(Pencil);
-        DECL_ITEMTRAITS;
-
-        ItemAction activate(Actor * a, GridPos p) {
-            if (enigma_server::GameCompatibility == GAMET_ENIGMA) {
-                if (Item *it=GetItem(p)) {
-                    return ITEM_KEEP;
-                }
-                // If the actor is flying and tries to make a cross, drop the it-pencil
-                if (a-&gt;is_flying()) {
-                    return ITEM_DROP;
-                }
-
-                Floor *fl = GetFloor(p);
-                string model = fl-&gt;get_kind();
-
-                /* do not allow markings on this floortypes:
-                   fl_abyss, fl_water, fl_swamp
-                   fl-bridge[{-closed,-open}]?
-                   markings on fl_ice will result as it-crack1
-                */
-                if (model == &quot;fl_abyss&quot; || model == &quot;fl_water&quot; || model == &quot;fl_swamp&quot;) {
-                    return ITEM_KEEP;
-                } else  if (model == &quot;fl_ice&quot;) {
-                    SetItem (p, MakeItem(&quot;it_crack_s&quot;));
-                } else {
-                    SetItem (p, MakeItem(&quot;it_cross&quot;));
-                }
-                return ITEM_KILL;
-            }
-        }
-
-    public:
-        Pencil() {}
-    };
-
-    DEF_ITEMTRAITS(Pencil, &quot;it-pencil&quot;, it_pencil);
-}
-
 /* -------------------- it-surprise -------------------- */
 namespace
 {
@@ -1572,9 +1238,7 @@
     RegisterItem (new Booze);
     RegisterItem (new BrokenBooze);
     Burnable::setup();
-    RegisterItem (new Cross);
     RegisterItem (new Debris);
-    RegisterItem (new Document);
     RegisterItem (new Drop);
     RegisterItem (new Dummyitem);
     RegisterItem (new Dynamite);
@@ -1586,15 +1250,11 @@
     Extinguisher::setup();
     RegisterItem (new FlagBlack);
     RegisterItem (new FlagWhite);
-    RegisterItem (new Trap);
-    RegisterItem (new Landmine);
     RegisterItem (new Odometer);
     RegisterItem (new OnePKillStone);
     RegisterItem (new OxydBridge);
     RegisterItem (new OxydBridgeActive);
-    RegisterItem (new Pencil);
     RegisterItem (new Pin);
-    Puller::setup();
     RegisterItem (new Spring1);
     RegisterItem (new Spring2);
     RegisterItem (new Springboard);

Modified: trunk/src/ox_magnum.cc
===================================================================
--- trunk/src/ox_magnum.cc	2009-01-25 18:17:10 UTC (rev 1484)
+++ trunk/src/ox_magnum.cc	2009-01-25 21:58:42 UTC (rev 1485)
@@ -390,9 +390,9 @@
     UNUSED,        // OxydMagnum item 0x61 (rev. breaking are)
     UNUSED,        // OxydMagnum item 0x62 (player exchange)
     &quot;it_trigger&quot;,       // OxydMagnum item 0x63
-    &quot;it-puller-n&quot;,      // OxydMagnum item 0x64
-    &quot;it-puller-s&quot;,      // OxydMagnum item 0x65
-    &quot;it-puller-w&quot;,      // OxydMagnum item 0x66
-    &quot;it-puller-e&quot;,      // OxydMagnum item 0x67
+    &quot;it_puller_n&quot;,      // OxydMagnum item 0x64
+    &quot;it_puller_s&quot;,      // OxydMagnum item 0x65
+    &quot;it_puller_w&quot;,      // OxydMagnum item 0x66
+    &quot;it_puller_e&quot;,      // OxydMagnum item 0x67
     // codes &gt;= 0x68 are unused
 };

Modified: trunk/src/ox_peroxyd.cc
===================================================================
--- trunk/src/ox_peroxyd.cc	2009-01-25 18:17:10 UTC (rev 1484)
+++ trunk/src/ox_peroxyd.cc	2009-01-25 21:58:42 UTC (rev 1485)
@@ -446,7 +446,7 @@
     &quot;it_trigger&quot;,                 // 0x40
     &quot;it_brush&quot;,                   // 0x41
     &quot;it_banana&quot;,                  // 0x42
-    &quot;it-pencil&quot;,                  // 0x43
+    &quot;it_pencil&quot;,                  // 0x43
     &quot;it_brake&quot;,                   // 0x44
     &quot;it_squashed&quot;,                // 0x45
     &quot;it_blocker&quot;,                 // 0x46
@@ -454,10 +454,10 @@
     &quot;it_wrench&quot;,                  // 0x48
     UNUSED,                  // 0x49
     &quot;it-odometer&quot;,                // 0x4a
-    &quot;it-puller-n&quot;,                // 0x4b
-    &quot;it-puller-s&quot;,                // 0x4c
-    &quot;it-puller-w&quot;,                // 0x4d
-    &quot;it-puller-e&quot;,                // 0x4e
+    &quot;it_puller_n&quot;,                // 0x4b
+    &quot;it_puller_s&quot;,                // 0x4c
+    &quot;it_puller_w&quot;,                // 0x4d
+    &quot;it_puller_e&quot;,                // 0x4e
     UNUSED,                       // 0x4f
     UNUSED,                       // 0x50
     IT_MISSING,                   // 0x51 puller left, active

Modified: trunk/src/oxyd.cc
===================================================================
--- trunk/src/oxyd.cc	2009-01-25 18:17:10 UTC (rev 1484)
+++ trunk/src/oxyd.cc	2009-01-25 21:58:42 UTC (rev 1485)
@@ -376,11 +376,11 @@
     switch (type) {
         case 0x00: break;           // ignore
         case 0x02:                  // note 1
-    	    it = MakeItem(&quot;it-document&quot;);
+    	    it = MakeItem(&quot;it_document&quot;);
     	    it-&gt;setAttr (&quot;text&quot;, convert_encoding(level.getNoteText(0, lang)).c_str());
             break;
         case 0x03:                  // note 2
-            it = MakeItem(&quot;it-document&quot;);
+            it = MakeItem(&quot;it_document&quot;);
             it-&gt;setAttr (&quot;text&quot;, convert_encoding(level.getNoteText(1, lang)).c_str());
             break;
         case 0x14:                  // key a


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000913.html">[Enigma-game-svn] r1484 - in trunk: data src
</A></li>
	<LI>Next message: <A HREF="000915.html">[Enigma-game-svn] r1486 - team_levelpacks/team_test_new_api
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#914">[ date ]</a>
              <a href="thread.html#914">[ thread ]</a>
              <a href="subject.html#914">[ subject ]</a>
              <a href="author.html#914">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/enigma-game-svn">More information about the Enigma-game-svn
mailing list</a><br>
</body></html>
