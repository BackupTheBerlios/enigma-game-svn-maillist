<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Enigma-game-svn] r1678 - in trunk: data data/gfx32 data/gfx40	data/gfx48 data/levels/lib data/schemas src src/stones
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/enigma-game-svn/2009-May/index.html" >
   <LINK REL="made" HREF="mailto:enigma-game-svn%40lists.berlios.de?Subject=Re%3A%20%5BEnigma-game-svn%5D%20r1678%20-%20in%20trunk%3A%20data%20data/gfx32%20data/gfx40%0A%09data/gfx48%20data/levels/lib%20data/schemas%20src%20src/stones&In-Reply-To=%3C200905222304.n4MN4nSG030699%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001107.html">
   <LINK REL="Next"  HREF="001109.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Enigma-game-svn] r1678 - in trunk: data data/gfx32 data/gfx40	data/gfx48 data/levels/lib data/schemas src src/stones</H1>
    <B>ral at BerliOS</B> 
    <A HREF="mailto:enigma-game-svn%40lists.berlios.de?Subject=Re%3A%20%5BEnigma-game-svn%5D%20r1678%20-%20in%20trunk%3A%20data%20data/gfx32%20data/gfx40%0A%09data/gfx48%20data/levels/lib%20data/schemas%20src%20src/stones&In-Reply-To=%3C200905222304.n4MN4nSG030699%40sheep.berlios.de%3E"
       TITLE="[Enigma-game-svn] r1678 - in trunk: data data/gfx32 data/gfx40	data/gfx48 data/levels/lib data/schemas src src/stones">ral at mail.berlios.de
       </A><BR>
    <I>Sat May 23 01:04:49 CEST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="001107.html">[Enigma-game-svn] r1677 - trunk/doc/reference
</A></li>
        <LI>Next message: <A HREF="001109.html">[Enigma-game-svn] r1679 - team_levelpacks/team_test_new_api
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1108">[ date ]</a>
              <a href="thread.html#1108">[ thread ]</a>
              <a href="subject.html#1108">[ subject ]</a>
              <a href="author.html#1108">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: ral
Date: 2009-05-23 01:04:42 +0200 (Sat, 23 May 2009)
New Revision: 1678

Added:
   trunk/data/gfx32/it_death.png
   trunk/data/gfx32/st_death.png
   trunk/data/gfx32/st_death_light.png
   trunk/data/gfx40/it_death.png
   trunk/data/gfx40/st_death.png
   trunk/data/gfx40/st_death_light.png
   trunk/data/gfx48/it_death.png
   trunk/data/gfx48/st_death.png
   trunk/data/gfx48/st_death_light.png
Removed:
   trunk/data/gfx32/it-death.png
   trunk/data/gfx32/st-death.png
   trunk/data/gfx40/it-death.png
   trunk/data/gfx40/st-death.png
   trunk/data/gfx48/it-death.png
   trunk/data/gfx48/st-death.png
Modified:
   trunk/data/levels/lib/libmaze_2.xml
   trunk/data/models-2d.lua
   trunk/data/schemas/objects.xml
   trunk/src/lua.cc
   trunk/src/stones.hh
   trunk/src/stones/DeathStone.cc
   trunk/src/stones/DeathStone.hh
Log:
Trunk 1.1:
- st_death add new subkind &quot;st_death_movable&quot;:
  - can be pushed by protected and death proven actors, per wire and all
    stoneimpulses like rotator, lightpassenger,...
  - new attribute &quot;interval&quot;, default 10 seconds, defines the average time
    interval between two animations - this allows user to locate movable death,
    value of 0.0 switches the anim off
  - movable death will show in lighter gray when seen through glasses.
  - death can be moved by pushing st_boulder, too
- identify Lua datatypes &quot;default&quot;, &quot;maze&quot; and &quot;cell&quot;

Deleted: trunk/data/gfx32/it-death.png
===================================================================
(Binary files differ)

Copied: trunk/data/gfx32/it_death.png (from rev 1677, trunk/data/gfx32/it-death.png)

Deleted: trunk/data/gfx32/st-death.png
===================================================================
(Binary files differ)

Copied: trunk/data/gfx32/st_death.png (from rev 1677, trunk/data/gfx32/st-death.png)

Added: trunk/data/gfx32/st_death_light.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx32/st_death_light.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Deleted: trunk/data/gfx40/it-death.png
===================================================================
(Binary files differ)

Copied: trunk/data/gfx40/it_death.png (from rev 1677, trunk/data/gfx40/it-death.png)

Deleted: trunk/data/gfx40/st-death.png
===================================================================
(Binary files differ)

Copied: trunk/data/gfx40/st_death.png (from rev 1677, trunk/data/gfx40/st-death.png)

Added: trunk/data/gfx40/st_death_light.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx40/st_death_light.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Deleted: trunk/data/gfx48/it-death.png
===================================================================
(Binary files differ)

Copied: trunk/data/gfx48/it_death.png (from rev 1677, trunk/data/gfx48/it-death.png)

Deleted: trunk/data/gfx48/st-death.png
===================================================================
(Binary files differ)

Copied: trunk/data/gfx48/st_death.png (from rev 1677, trunk/data/gfx48/st-death.png)

Added: trunk/data/gfx48/st_death_light.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx48/st_death_light.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Modified: trunk/data/levels/lib/libmaze_2.xml
===================================================================
--- trunk/data/levels/lib/libmaze_2.xml	2009-05-19 21:54:28 UTC (rev 1677)
+++ trunk/data/levels/lib/libmaze_2.xml	2009-05-22 23:04:42 UTC (rev 1678)
@@ -76,6 +76,7 @@
             maze:renderer(context.renderer_args)
         end
     setmetatable(context,{
+          _type = &quot;maze&quot;,
           __index = function (context, key)
                   if type(key) == &quot;number&quot; and key &gt;= 99 then
                       return rawget(context, &quot;cells&quot;)[key]
@@ -89,7 +90,7 @@
               end,
           __newindex = function (context, key, value)
                   if type(key) == &quot;number&quot; and key &gt;= 100 then
-                      assert_type(value, &quot;maze value (illegal set)&quot;, 2, &quot;table&quot;)
+                      assert_type(value, &quot;maze value (illegal set)&quot;, 2, &quot;cell&quot;)
                       local cellmeta = getmetatable(value)
                       assert_bool(cellmeta ~= nil and cellmeta.maze == context, &quot;Maze expected unassigned cell set but got something else&quot;)
                       local cells = rawget(context, &quot;cells&quot;)
@@ -119,6 +120,7 @@
               end
         })
     context.cellmeta = {
+          _type = &quot;cell&quot;,
           __index = function (cell, key)
                   if type(key) == &quot;number&quot; then
                       return rawget(cell, key)

Modified: trunk/data/models-2d.lua
===================================================================
--- trunk/data/models-2d.lua	2009-05-19 21:54:28 UTC (rev 1677)
+++ trunk/data/models-2d.lua	2009-05-22 23:04:42 UTC (rev 1678)
@@ -661,9 +661,9 @@
 
 end
 
--- it-death --
+-- it_death --
 do
-    local images = DefSubimages(&quot;it-death&quot;, {h=4})
+    local images = DefSubimages(&quot;it_death&quot;, {h=4})
     DefAlias(&quot;it_death&quot;, images[1])
     DefAnim(&quot;it_death_anim&quot;, BuildFrames(images, 100))
 end
@@ -987,9 +987,10 @@
     DefTiles(&quot;st-disco&quot;, {&quot;st_disco0&quot;,&quot;st_disco1&quot;,&quot;st_disco2&quot;})
 end
 
--- st-death --
+-- st_death --
 do
-    DefRoundStoneWithAnim (&quot;st-death&quot;, 3, 140)
+    DefRoundStoneWithAnim (&quot;st_death&quot;, 3, 140)
+    DefRoundStoneWithAnim (&quot;st_death_light&quot;, 3, 140)
 end
 
 -- st_yinyang --
@@ -1852,7 +1853,7 @@
 -- Invisible stones --
 do
     DefAlias(&quot;st-actorimpulse_invisible&quot;, &quot;invisible&quot;)
-    DefAlias(&quot;st-death_invisible&quot;, &quot;invisible&quot;)
+    DefAlias(&quot;st_death_invisible&quot;, &quot;invisible&quot;)
     DefAlias(&quot;st_invisible&quot;, &quot;invisible&quot;)
 end
 

Modified: trunk/data/schemas/objects.xml
===================================================================
--- trunk/data/schemas/objects.xml	2009-05-19 21:54:28 UTC (rev 1677)
+++ trunk/data/schemas/objects.xml	2009-05-22 23:04:42 UTC (rev 1678)
@@ -1218,11 +1218,15 @@
     &lt;/object&gt;
     &lt;object name=&quot;st_death&quot;&gt;
       &lt;attr name=&quot;invisible&quot;/&gt;
+      &lt;attr name=&quot;interval&quot; default=&quot;10&quot;/&gt;
       &lt;msg name=&quot;_model_reanimated&quot;/&gt;
     &lt;/object&gt;
     &lt;object name=&quot;st_death_invisible&quot;&gt;
       &lt;attr name=&quot;invisible&quot; value=&quot;true&quot;/&gt;
     &lt;/object&gt;
+    &lt;object name=&quot;st_death_movable&quot;&gt;
+      &lt;attr name=&quot;movable&quot; value=&quot;true&quot;/&gt;
+    &lt;/object&gt;
     &lt;object name=&quot;st_disco&quot;&gt;
       &lt;msg name=&quot;lighten&quot;/&gt;
       &lt;msg name=&quot;darken&quot;/&gt;

Modified: trunk/src/lua.cc
===================================================================
--- trunk/src/lua.cc	2009-05-19 21:54:28 UTC (rev 1677)
+++ trunk/src/lua.cc	2009-05-22 23:04:42 UTC (rev 1678)
@@ -213,6 +213,7 @@
     else if (is_group(L, -1)) type = &quot;group&quot;;
     else if (is_world(L, -1)) type = &quot;world&quot;;
     else if (is_polist(L, -1)) type = &quot;polist&quot;;
+    else if (is_default(L, -1)) type = &quot;default&quot;;
     
     lua_pushstring(L, type.c_str());
     return 1;

Modified: trunk/src/stones/DeathStone.cc
===================================================================
--- trunk/src/stones/DeathStone.cc	2009-05-19 21:54:28 UTC (rev 1677)
+++ trunk/src/stones/DeathStone.cc	2009-05-22 23:04:42 UTC (rev 1678)
@@ -21,16 +21,22 @@
 #include &quot;stones/DeathStone.hh&quot;
 
 #include &quot;items/GlassesItem.hh&quot;
-//#include &quot;main.hh&quot;
+#include &quot;main.hh&quot;
 
 namespace enigma {
-    DeathStone::DeathStone(bool isInvisible) : Stone () {
+    DeathStone::DeathStone(bool isInvisible, bool isMovable) : Stone () {
         if (isInvisible)
             objFlags |= OBJBIT_INVISIBLE;
+        if (isMovable)
+            objFlags |= OBJBIT_MOVABLE;
             
         state = IDLE;
     }
 
+    DeathStone::~DeathStone() {
+        GameTimer.remove_alarm(this);
+    }
+    
     std::string DeathStone::getClass() const {
         return &quot;st_death&quot;;
     }
@@ -43,6 +49,20 @@
                 if (isDisplayable())
                     init_model();
             }
+            if ((objFlags &amp; OBJBIT_INVISIBLE) &amp;&amp; (objFlags &amp; OBJBIT_INVISIBLE))
+                objFlags &amp;= ~OBJBIT_MOVABLE;    // there is no invisible movable death
+        } else if (key == &quot;movable&quot;) {
+            GameTimer.remove_alarm(this);
+            if (val.to_bool()) {
+                objFlags |= OBJBIT_MOVABLE;
+                if (objFlags &amp; OBJBIT_INVISIBLE)  // there is no invisible movable death
+                    objFlags &amp;= ~OBJBIT_INVISIBLE;
+                if (isDisplayable())
+                    setAlarm();
+            } else
+                objFlags &amp;= ~OBJBIT_MOVABLE;
+            if (isDisplayable())
+                init_model();
         } else
             Stone::setAttr(key, val);
     }
@@ -50,6 +70,8 @@
     Value DeathStone::getAttr(const std::string &amp;key) const {
         if (key == &quot;invisible&quot;) {
             return (objFlags &amp; OBJBIT_INVISIBLE) != 0;
+        } else if (key == &quot;movable&quot;) {
+            return (bool)(objFlags &amp; OBJBIT_MOVABLE);
         } else
             return Stone::getAttr(key);
     }
@@ -59,8 +81,16 @@
             state = IDLE;   // reset any running anim, be ready to bump again on new grid
             init_model();   // visibility might have changed
         } else if (m.message == &quot;_glasses&quot;) {
-            init_model();
+            if (state == IDLE)   // avoid restart of animations
+                init_model();
             return Value();
+        } else if (m.message == &quot;_trigger&quot; &amp;&amp; !m.value.to_bool()) {
+            Direction incoming = NODIR;
+            if (m.sender != NULL)
+                incoming = direction_fromto(dynamic_cast&lt;GridObject *&gt;(m.sender)-&gt;get_pos(), get_pos());
+            if (incoming != NODIR)
+                move_stone(incoming);
+            return Value();
         }
         return Stone::message(m);
     }
@@ -76,12 +106,32 @@
         if (state == IDLE) {
             if ((objFlags &amp; OBJBIT_INVISIBLE) &amp;&amp; ((server::GlassesVisibility &amp; Glasses::DEATH) == 0))
                 set_model(&quot;invisible&quot;);
+            else if ((objFlags &amp; OBJBIT_MOVABLE) &amp;&amp; ((server::GlassesVisibility &amp; Glasses::DEATH) != 0))
+                set_model(&quot;st_death_light&quot;);
             else
-                set_model(&quot;st-death&quot;);
+                set_model(&quot;st_death&quot;);
+        } else {
+            if ((objFlags &amp; OBJBIT_MOVABLE) &amp;&amp; ((server::GlassesVisibility &amp; Glasses::DEATH) != 0))
+                set_anim(&quot;st_death_light-anim&quot;);
+            else
+                set_anim(&quot;st_death-anim&quot;);
         }
         // PULSING anim is always visible and should continue independent on init_model calls
     }
     
+    void DeathStone::on_creation (GridPos p) {
+        if (objFlags &amp; OBJBIT_MOVABLE)
+            setAlarm();
+
+        Stone::on_creation(p);    // init the model
+    }
+    
+    void DeathStone::on_removal(GridPos p) {
+        if (objFlags &amp; OBJBIT_MOVABLE)
+            GameTimer.remove_alarm(this);
+        Stone::on_removal(p);
+    }
+    
     void DeathStone::animcb() {
         if (state == PULSING) {
             state = IDLE;
@@ -90,31 +140,49 @@
     }
     
     void DeathStone::actor_hit(const StoneContact &amp;sc) {
+        actor_touch(sc);
+        Stone::actor_hit(sc);
+    }
+
+    void DeathStone::actor_touch(const StoneContact &amp;sc) {
+        // even a slight touch should shatter the actor: 
         SendMessage(sc.actor, &quot;_shatter&quot;);
         if (state == IDLE) {
             state = PULSING;
-            set_anim(&quot;st-death-anim&quot;);
+            init_model();
         }
     }
+    
+    void DeathStone::alarm() {
+        if (state == IDLE) {
+            state = PULSING;
+            init_model();
+        }
+        setAlarm();
+    }
 
-    void DeathStone::actor_touch(const StoneContact &amp;sc) {
-        // even a slight touch should shatter the actor: 
-         actor_hit(sc);
+    void DeathStone::setAlarm() {
+        double dt = (double)getAttr(&quot;interval&quot;);
+        if (dt &gt; 0) {
+            dt *= DoubleRand(0.8, 1.2);
+            GameTimer.set_alarm(this, dt, false);
+        }
     }
-
+    
     int DeathStone::traitsIdx() const {
-        return (objFlags &amp; OBJBIT_INVISIBLE) ? 1 : 0;
+        return (objFlags &amp; OBJBIT_INVISIBLE) ? 1 : ((objFlags &amp; OBJBIT_MOVABLE) ? 2 : 0);
     }
-
     
-    StoneTraits DeathStone::traits[2] = {
+    StoneTraits DeathStone::traits[3] = {
         {&quot;st_death&quot;, st_death, stf_none, material_stone, 1.0, MOVABLE_PERSISTENT},
         {&quot;st_death_invisible&quot;, st_death_invisible, stf_none, material_stone, 1.0, MOVABLE_PERSISTENT},
+        {&quot;st_death_movable&quot;, st_death_movable, stf_none, material_stone, 1.0, MOVABLE_STANDARD},
     };
     
     BOOT_REGISTER_START
         BootRegister(new DeathStone(false), &quot;st_death&quot;);
         BootRegister(new DeathStone(true), &quot;st_death_invisible&quot;);
+        BootRegister(new DeathStone(false, true), &quot;st_death_movable&quot;);
     BOOT_REGISTER_END
 
 } // namespace enigma

Modified: trunk/src/stones/DeathStone.hh
===================================================================
--- trunk/src/stones/DeathStone.hh	2009-05-19 21:54:28 UTC (rev 1677)
+++ trunk/src/stones/DeathStone.hh	2009-05-22 23:04:42 UTC (rev 1678)
@@ -29,9 +29,9 @@
     /** 
      * 
      */
-    class DeathStone : public Stone {
+    class DeathStone : public Stone, public TimeHandler {
         CLONEOBJ(DeathStone);
-        DECL_TRAITS_ARRAY(2, traitsIdx());
+        DECL_TRAITS_ARRAY(3, traitsIdx());
     private:
         enum iState {
             IDLE,     ///&lt; 
@@ -40,9 +40,11 @@
         
         enum ObjectPrivatFlagsBits {
             OBJBIT_INVISIBLE   =   1&lt;&lt;24,  ///&lt; Object is invisible 
+            OBJBIT_MOVABLE     =   1&lt;&lt;25,  ///&lt; Object is movable 
         };
     public:
-        DeathStone(bool isInvisible);
+        DeathStone(bool isInvisible, bool isMovable =false);
+        ~DeathStone();
         
         // Object interface
         virtual std::string getClass() const;
@@ -55,6 +57,8 @@
 
         // GridObject interface
         virtual void init_model();
+        virtual void on_creation(GridPos p);
+        virtual void on_removal(GridPos p);
         
         // ModelCallback interface
         virtual void animcb();
@@ -63,7 +67,11 @@
         virtual void actor_hit(const StoneContact &amp;sc);
         virtual void actor_touch (const StoneContact &amp;sc);
 
+        // TimeHandler interface
+        virtual void alarm();
+
     private:
+        void setAlarm();
         int traitsIdx() const;
     };
 

Modified: trunk/src/stones.hh
===================================================================
--- trunk/src/stones.hh	2009-05-19 21:54:28 UTC (rev 1677)
+++ trunk/src/stones.hh	2009-05-22 23:04:42 UTC (rev 1678)
@@ -57,6 +57,7 @@
         st_coinslot,
         st_death,
         st_death_invisible,
+        st_death_movable,
         st_disco,
         st_dispenser,
         st_door,


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001107.html">[Enigma-game-svn] r1677 - trunk/doc/reference
</A></li>
	<LI>Next message: <A HREF="001109.html">[Enigma-game-svn] r1679 - team_levelpacks/team_test_new_api
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1108">[ date ]</a>
              <a href="thread.html#1108">[ thread ]</a>
              <a href="subject.html#1108">[ subject ]</a>
              <a href="author.html#1108">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/enigma-game-svn">More information about the Enigma-game-svn
mailing list</a><br>
</body></html>
