<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Enigma-game-svn] r1298 - in trunk: data data/schemas src src/items
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/enigma-game-svn/2008-August/index.html" >
   <LINK REL="made" HREF="mailto:enigma-game-svn%40lists.berlios.de?Subject=Re%3A%20%5BEnigma-game-svn%5D%20r1298%20-%20in%20trunk%3A%20data%20data/schemas%20src%20src/items&In-Reply-To=%3C200808312118.m7VLICGx005877%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000727.html">
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Enigma-game-svn] r1298 - in trunk: data data/schemas src src/items</H1>
    <B>ral at BerliOS</B> 
    <A HREF="mailto:enigma-game-svn%40lists.berlios.de?Subject=Re%3A%20%5BEnigma-game-svn%5D%20r1298%20-%20in%20trunk%3A%20data%20data/schemas%20src%20src/items&In-Reply-To=%3C200808312118.m7VLICGx005877%40sheep.berlios.de%3E"
       TITLE="[Enigma-game-svn] r1298 - in trunk: data data/schemas src src/items">ral at mail.berlios.de
       </A><BR>
    <I>Sun Aug 31 23:18:12 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000727.html">[Enigma-game-svn] r1297 - trunk/doc/reference
</A></li>
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#728">[ date ]</a>
              <a href="thread.html#728">[ thread ]</a>
              <a href="subject.html#728">[ subject ]</a>
              <a href="author.html#728">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: ral
Date: 2008-08-31 23:18:10 +0200 (Sun, 31 Aug 2008)
New Revision: 1298

Added:
   trunk/src/items/Meditation.cc
   trunk/src/items/Meditation.hh
Modified:
   trunk/data/api1init.lua
   trunk/data/api2init.lua
   trunk/data/models-2d.lua
   trunk/data/schemas/objects.xml
   trunk/src/GridObject.hh
   trunk/src/Makefile.am
   trunk/src/WorldProxy.cc
   trunk/src/items.cc
   trunk/src/items.hh
   trunk/src/ox_extra.cc
   trunk/src/ox_magnum.cc
   trunk/src/ox_oxyd1.cc
   trunk/src/ox_peroxyd.cc
Log:
Trunk 1.1: new API reengineering
- pipe item: fix wrong api 1 mapping of it-pipe-wn
- meditation item:
  - rename it-hollow, it-tinyhollow, it-hill, it-tinyhill to
      it_meditation(_hollow), it_meditation_dent, it_meditation_hill,
      it_meditation_bump
  - fix all known &quot;holes&quot; in registration of meditatin marbles keeping
    the new fast O(1) algorithm
  - keep identity on item &quot;transformation&quot; (just the state changes)
  - add &quot;state&quot; attribute and constants (MEDITATION_HOLLOW,...)
  - prepare new types VOLCANO and CALDERA (just images are missing)
  - refine attribute &quot;essential&quot; - keep it on transformations
- rename global attribute &quot;HoleForce&quot; to &quot;MeditationForce&quot;


Modified: trunk/data/api1init.lua
===================================================================
--- trunk/data/api1init.lua	2008-08-31 19:38:31 UTC (rev 1297)
+++ trunk/data/api1init.lua	2008-08-31 21:18:10 UTC (rev 1298)
@@ -63,6 +63,10 @@
     it_magicwand = &quot;it-magicwand&quot;,
     it_magnet = &quot;it-magnet&quot;,
     it_magnet_on = &quot;it-magnet-on&quot;,
+    it_meditation_hollow = &quot;it-hollow&quot;,
+    it_meditation_dent = &quot;it-tinyhollow&quot;,
+    it_meditation_bump = &quot;it-tinyhill&quot;,
+    it_meditation_hill = &quot;it-hill&quot;,
     it_pipe_w = &quot;it-pipe-w&quot;,
     it_pipe_s = &quot;it-pipe-s&quot;,
     it_pipe_sw = &quot;it-pipe-sw&quot;,
@@ -70,7 +74,7 @@
     it_pipe_ew = &quot;it-pipe-h&quot;,
     it_pipe_es = &quot;it-pipe-es&quot;,
     it_pipe_n = &quot;it-pipe-n&quot;,
-    it_pipe_nw = &quot;it-pipe-nw&quot;,
+    it_pipe_nw = &quot;it-pipe-wn&quot;,
     it_pipe_ns = &quot;it-pipe-v&quot;,
     it_pipe_ne = &quot;it-pipe-ne&quot;,
     it_magnet_off = &quot;it-magnet-off&quot;,

Modified: trunk/data/api2init.lua
===================================================================
--- trunk/data/api2init.lua	2008-08-31 19:38:31 UTC (rev 1297)
+++ trunk/data/api2init.lua	2008-08-31 21:18:10 UTC (rev 1298)
@@ -124,6 +124,14 @@
 INDISPENSIBLE = 1
 PERKIND       = 2
 
+-- meditation
+MEDITATION_CALDERA = -3
+MEDITATION_HOLLOW  = -2
+MEDITATION_DENT    = -1
+MEDITATION_BUMP    =  1
+MEDITATION_HILL    =  2
+MEDITATION_VOLCANO =  3
+
 -- glasses
 SPOT_NOTHING        =   0
 SPOT_DEATH          =   1

Modified: trunk/data/models-2d.lua
===================================================================
--- trunk/data/models-2d.lua	2008-08-31 19:38:31 UTC (rev 1297)
+++ trunk/data/models-2d.lua	2008-08-31 21:18:10 UTC (rev 1298)
@@ -394,14 +394,11 @@
         &quot;it-booze&quot;,
         &quot;it-booze-broken&quot;,
         &quot;it-cherry&quot;,
-        &quot;it-cross&quot;,
         &quot;it-document&quot;,
         &quot;it-drop&quot;,
         &quot;it-dynamite&quot;,
         &quot;it-flagblack&quot;,
         &quot;it-flagwhite&quot;,
-        &quot;it-hill&quot;,
-        &quot;it-hollow&quot;,
         &quot;it-odometer&quot;,
         &quot;it-pencil&quot;,
         &quot;it-pin&quot;,
@@ -412,8 +409,6 @@
         &quot;it-spring1&quot;,
         &quot;it-spring2&quot;,
         &quot;it-surprise&quot;,
-        &quot;it-tinyhill&quot;,
-        &quot;it-tinyhollow&quot;,
         &quot;it-weight&quot;,
         &quot;it-whitebomb&quot;
     }
@@ -434,6 +429,10 @@
     DefImage(&quot;it_key&quot;, {filename=&quot;it-key&quot;})
     DefImage(&quot;it_landmine&quot;, {filename=&quot;it-landmine&quot;})
     DefImage(&quot;it_magicwand&quot;, {filename=&quot;it-magicwand&quot;})
+    DefImage(&quot;it_meditation_hollow&quot;, {filename=&quot;it-hollow&quot;})
+    DefImage(&quot;it_meditation_hill&quot;, {filename=&quot;it-hill&quot;})
+    DefImage(&quot;it_meditation_dent&quot;, {filename=&quot;it-tinyhollow&quot;})
+    DefImage(&quot;it_meditation_bump&quot;, {filename=&quot;it-tinyhill&quot;})
     DefImage(&quot;it_rubberband&quot;, {filename=&quot;it-rubberband&quot;})
     DefImage(&quot;it_sword&quot;, {filename=&quot;it-sword&quot;})
     DefImage(&quot;it_umbrella&quot;, {filename=&quot;it-umbrella&quot;})

Modified: trunk/data/schemas/objects.xml
===================================================================
--- trunk/data/schemas/objects.xml	2008-08-31 19:38:31 UTC (rev 1297)
+++ trunk/data/schemas/objects.xml	2008-08-31 21:18:10 UTC (rev 1298)
@@ -14,6 +14,7 @@
     &lt;attr name=&quot;counterclock&quot; type=&quot;bool&quot; default=&quot;false&quot; rw=&quot;rw&quot;/&gt;
     &lt;attr name=&quot;checkerboard&quot; type=&quot;int&quot; default=&quot;nil&quot; rw=&quot;rw&quot;/&gt;
     &lt;attr name=&quot;destination&quot; type=&quot;tokens&quot; default=&quot;nil&quot; rw=&quot;rw&quot;/&gt;
+    &lt;attr name=&quot;essential&quot; type=&quot;int&quot; default=&quot;0&quot; min=&quot;0&quot; max=&quot;2&quot; rw=&quot;rw&quot;/&gt;
     &lt;attr name=&quot;faces&quot; type=&quot;string&quot; default=&quot;nil&quot; rw=&quot;rw&quot;/&gt;
     &lt;attr name=&quot;fellows&quot; type=&quot;group&quot; default=&quot;nil&quot; rw=&quot;r&quot;/&gt;
     &lt;attr name=&quot;flavor&quot; type=&quot;string&quot; default=&quot;b&quot; rw=&quot;rw&quot;/&gt;
@@ -72,6 +73,7 @@
     &lt;msg name=&quot;open&quot; type=&quot;nil&quot;/&gt;
     &lt;msg name=&quot;orientate&quot; type=&quot;nil&quot;/&gt;
     &lt;msg name=&quot;shuffle&quot; type=&quot;nil&quot;/&gt;
+    &lt;msg name=&quot;shovel&quot; type=&quot;nil&quot;/&gt;
     &lt;msg name=&quot;signal&quot; type=&quot;int&quot; min=&quot;0&quot; max=&quot;1&quot;/&gt;
     &lt;msg name=&quot;toggle&quot; type=&quot;nil&quot;/&gt;
     &lt;msg name=&quot;turn&quot; type=&quot;nil&quot;/&gt;
@@ -170,6 +172,32 @@
     &lt;object name=&quot;it_magnet_on&quot;&gt;
       &lt;attr name=&quot;state&quot; value=&quot;1&quot;/&gt;
     &lt;/object&gt;
+    &lt;object name=&quot;it_meditation&quot;&gt;
+      &lt;attr name=&quot;state&quot; min=&quot;-3&quot; max=&quot;3&quot; default=&quot;-2&quot;/&gt;
+      &lt;attr name=&quot;essential&quot; max=&quot;1&quot;/&gt;
+      &lt;msg name=&quot;flip&quot;/&gt;
+      &lt;msg name=&quot;shovel&quot;/&gt;
+      &lt;msg name=&quot;signal&quot;/&gt;
+      &lt;msg name=&quot;_init&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;it_meditation_caldera&quot;&gt;
+      &lt;attr name=&quot;state&quot; value=&quot;-3&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;it_meditation_hollow&quot;&gt;
+      &lt;attr name=&quot;state&quot; value=&quot;-2&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;it_meditation_dent&quot;&gt;
+      &lt;attr name=&quot;state&quot; value=&quot;-1&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;it_meditation_bump&quot;&gt;
+      &lt;attr name=&quot;state&quot; value=&quot;1&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;it_meditation_hill&quot;&gt;
+      &lt;attr name=&quot;state&quot; value=&quot;2&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;it_meditation_vulcano&quot;&gt;
+      &lt;attr name=&quot;state&quot; value=&quot;3&quot;/&gt;
+    &lt;/object&gt;
     &lt;object name=&quot;it_pipe&quot;&gt;
       &lt;attr name=&quot;connections&quot;/&gt;
       &lt;msg name=&quot;_explosion&quot;/&gt;

Modified: trunk/src/GridObject.hh
===================================================================
--- trunk/src/GridObject.hh	2008-08-31 19:38:31 UTC (rev 1297)
+++ trunk/src/GridObject.hh	2008-08-31 21:18:10 UTC (rev 1298)
@@ -95,8 +95,8 @@
 
         // GridObject interface
         
-        virtual void actor_enter (Actor *a) {}
-        virtual void actor_leave (Actor *a) {}
+        virtual void actor_enter(Actor *a) {}
+        virtual void actor_leave(Actor *a) {}
 
 
         void warning(const char *format, ...) const;

Modified: trunk/src/Makefile.am
===================================================================
--- trunk/src/Makefile.am	2008-08-31 19:38:31 UTC (rev 1297)
+++ trunk/src/Makefile.am	2008-08-31 21:18:10 UTC (rev 1298)
@@ -205,6 +205,8 @@
 	items/GlassesItem.hh	\
 	items/Magnet.cc		\
 	items/Magnet.hh		\
+	items/Meditation.cc	\
+	items/Meditation.hh	\
 	items/PipeItem.cc	\
 	items/PipeItem.hh	\
 	items/RubberbandItem.cc	\

Modified: trunk/src/WorldProxy.cc
===================================================================
--- trunk/src/WorldProxy.cc	2008-08-31 19:38:31 UTC (rev 1297)
+++ trunk/src/WorldProxy.cc	2008-08-31 21:18:10 UTC (rev 1298)
@@ -86,7 +86,7 @@
             return server::FlatForce;
         } else if (key == &quot;FrictionFactor&quot;) {
             return server::FrictionFactor;
-        } else if (key == &quot;HoleForce&quot;) {
+        } else if (key == &quot;MeditationForce&quot;) {
             return server::HoleForce;
         } else if (key == &quot;IceFriction&quot;) {
             return server::IceFriction;
@@ -172,7 +172,7 @@
             server::FlatForce = val;
         } else if (key == &quot;FrictionFactor&quot;) {
             server::FrictionFactor = val;
-        } else if (key == &quot;HoleForce&quot;) {
+        } else if (key == &quot;MeditationForce&quot;) {
             server::HoleForce = val;
         } else if (key == &quot;IceFriction&quot;) {
             server::IceFriction = val;

Added: trunk/src/items/Meditation.cc
===================================================================
--- trunk/src/items/Meditation.cc	2008-08-31 19:38:31 UTC (rev 1297)
+++ trunk/src/items/Meditation.cc	2008-08-31 21:18:10 UTC (rev 1298)
@@ -0,0 +1,256 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *  
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include &quot;items/Meditation.hh&quot;
+
+//#include &quot;main.hh&quot;
+#include &quot;world.hh&quot;
+
+namespace enigma {
+
+    Meditation::Meditation(int initState) {
+        state = initState;
+    }
+    
+    std::string Meditation::getClass() const {
+        return &quot;it_meditation&quot;;
+    }
+    
+    void Meditation::setAttr(const string&amp; key, const Value &amp;val) {
+        if (key == &quot;essential&quot;) {
+            bool essential = (val == 1);
+            if (essential != (bool)(objFlags &amp; OBJBIT_INDISPENSIBLE)) {
+                if (isDisplayable() /* &amp;&amp; state != HILL &amp;&amp; state != BUMP */) {
+                    if (whiteball != NULL &amp;&amp; enter_time == -1) {   // meditatist is registered
+                        bool indispensable = objFlags &amp; OBJBIT_INDISPENSIBLE;
+                        ChangeMeditation(0, 0, indispensable ? -1 : +1, indispensable ? +1 : -1);
+                    }
+                    ChangeMeditation(0, essential ? +1 : -1 , 0, 0);
+                }
+                objFlags ^= OBJBIT_INDISPENSIBLE;
+            }
+            return;
+        }
+        Item::setAttr(key, val);
+    }
+    
+    Value Meditation::getAttr(const std::string &amp;key) const {
+        if (key == &quot;essential&quot;) {
+            return (objFlags &amp; OBJBIT_INDISPENSIBLE) ? 1 : 0;
+        }
+        return Item::getAttr(key);
+    }
+    
+    Value Meditation::message(const Message &amp;m) {
+        if (m.message == &quot;flip&quot;) {
+            setState(-state);
+            return Value();
+        } else if (m.message == &quot;signal&quot;) {
+            setState(m.value != 0 ? std::abs(state) : -std::abs(state)); 
+            return Value();
+        } else if (m.message == &quot;shovel&quot;) {
+            shovel();
+            return Value();
+        } else if (m.message == &quot;_init&quot;) {
+            checkActors();
+            return Value();
+        } else
+            return Item::message(m);
+    }
+    
+    int Meditation::minState() const {
+        return CALDERA;
+    }
+    int Meditation::maxState() const {
+        return VOLCANO;
+    }
+    
+    void Meditation::toggleState() {
+        setState(-state);
+    }
+    
+    void Meditation::setState(int extState) {
+        if (extState != state &amp;&amp; extState != 0) {
+            if (isDisplayable()) {
+                if (state != HILL &amp;&amp; state != BUMP &amp;&amp; (extState == HILL || extState == BUMP)) {
+                    // a meditation hole is changed to a hill or bump
+                    if (whiteball != NULL)
+                        deregisterWhiteball();
+//                    if (objFlags &amp; OBJBIT_INDISPENSIBLE)
+//                        ChangeMeditation(0, -1, 0, 0);
+                } else if ((state == HILL || state == BUMP) &amp;&amp; extState != HILL &amp;&amp; extState != BUMP) {
+                    // hill or bump is made a meditation hole
+                    if (server::WorldInitialized)
+                        checkActors();
+//                    if (objFlags &amp; OBJBIT_INDISPENSIBLE)
+//                        ChangeMeditation(0, +1, 0, 0);
+                }
+                
+                state = extState;
+                init_model();
+            } else
+                state = extState;
+        }
+    }
+        
+    void Meditation::on_creation(GridPos p) {
+        if (/* state != HILL &amp;&amp; state != BUMP &amp;&amp; */ (objFlags &amp; OBJBIT_INDISPENSIBLE))
+            ChangeMeditation(0, +1, 0, 0);
+        if (server::WorldInitialized)
+            checkActors();
+        Item::on_creation(p);
+    }
+    
+    void Meditation::on_removal(GridPos p) {
+        if (/* state != HILL &amp;&amp; state != BUMP &amp;&amp; */ (objFlags &amp; OBJBIT_INDISPENSIBLE))
+            ChangeMeditation(0, -1, 0, 0);
+        if (whiteball != NULL)
+            deregisterWhiteball();
+        Item::on_removal(p);
+    }
+    
+    void Meditation::actor_leave(Actor *a) {
+        if (whiteball == a)
+            // meditatist left hollow (warp, ...)
+            deregisterWhiteball();
+    }
+    
+    void Meditation::on_stonehit(Stone *) {
+        shovel();
+    }
+    
+    bool Meditation::actor_hit(Actor *a) {
+        static const double MINTIME = 1.0;
+        ItemID id = get_id(this);
+    
+        if (state != HILL &amp;&amp; state != BUMP) {
+            if (whiteball == NULL &amp;&amp; !a-&gt;is_flying() &amp;&amp; get_id(a) == ac_meditation &amp;&amp; isMeditating(a)) {
+                // meditatist entered a free hollow
+                whiteball  = a;
+                enter_time = server::LevelTime;
+            } else if (whiteball == a) {
+                if (a-&gt;is_flying() || !isMeditating(a)) {
+                    // meditatist left hollow
+                    whiteball = NULL;
+                    if (enter_time == -1) {   // meditatist is registered
+                        bool indispensable = objFlags &amp; OBJBIT_INDISPENSIBLE;
+                        ChangeMeditation(0, 0, indispensable ? -1 : 0, indispensable ? 0 : -1);
+                    }
+                } else  if (enter_time != -1 &amp;&amp; (server::LevelTime - enter_time) &gt;= MINTIME) {
+                        // just meditated enough to mark hollow as engaged
+                        bool indispensable = objFlags &amp; OBJBIT_INDISPENSIBLE;
+                        ChangeMeditation(0, 0, indispensable ? +1 : 0, indispensable ? 0 : +1);
+                        enter_time = -1;  // mark as registered
+                }
+            }
+        }
+        return false;  // do not pick up
+    }
+    
+    void Meditation::add_force(Actor *a, V2 &amp;f) {
+        ecl::V2 v = a-&gt;get_pos() - get_pos().center();
+        double dist = ecl::length(v);
+    
+        if (dist &gt; (std::abs(state) &gt; 1 ? 0.5 : 0.3))
+            return;
+    
+        if (dist &lt;= 0) { // exactly on hill-top
+            ActorInfo *ai = a-&gt;get_actorinfo();
+            if (length(ai-&gt;vel) &lt;= 0) { // no velocity
+                // we are never &quot;exactly&quot; on the top!
+                double x = DoubleRand(-0.03, 0.05);
+                double y = DoubleRand(-0.03, 0.05);
+                x = (x &lt; 0.01) ? x - 0.02 : x;
+                y = (y &lt; 0.01) ? y - 0.02 : y;
+                v = ecl::V2(x, y);
+            }
+        }
+    
+        f += (state &lt; 0 ? -1 : 1) * ((std::abs(state) == VOLCANO &amp;&amp; dist &lt; 0.3) ? -1 : 1) 
+                * 90 * server::HoleForce * v; // get the force
+    }
+    
+    bool Meditation::isMeditating(Actor *a) {
+        double dist = ecl::length(a-&gt;get_pos() - get_pos().center());
+        return (state &lt;= HOLLOW) &amp;&amp; dist &lt; 0.4 || (state == DENT || state == VOLCANO) &amp;&amp; dist &lt; 0.24;
+    }
+     
+    void Meditation::shovel() {
+        int newState = (state &gt; 0) ? state - 1 : state + 1;
+        if (newState == 0) {
+            // double register indispensible holes as the kill will subtract one essentialness 
+            if (/* state != HILL &amp;&amp; state != BUMP &amp;&amp; */ (objFlags &amp; OBJBIT_INDISPENSIBLE))
+                ChangeMeditation(0, +1, 0, 0);
+            kill();
+        } else {
+            setState(newState);
+        }
+    }
+    
+    void Meditation::checkActors() {
+        ItemID id = get_id(this);
+        if (state != HILL &amp;&amp; state != BUMP) {
+            std::vector&lt;Actor*&gt; actors;
+            GetActorsInsideField(get_pos(), actors);
+            for (std::vector&lt;Actor*&gt;::iterator itr = actors.begin(); itr != actors.end(); ++itr) {
+//                Log &lt;&lt; &quot;Hollow - initial meditatist  typ &quot; &lt;&lt; get_id(*itr) &lt;&lt; &quot;\n&quot;;
+                if (!(*itr)-&gt;is_flying() &amp;&amp;  whiteball==NULL &amp;&amp; get_id(*itr)==ac_meditation &amp;&amp; isMeditating(*itr)) {
+                     // meditatist entered a free hollow
+                    whiteball  = *itr;
+                    enter_time = server::LevelTime;
+//                    Log &lt;&lt; &quot;Hollow - initial meditatist time &quot; &lt;&lt; enter_time &lt;&lt; &quot;\n&quot;;
+                    break;
+                }
+            }
+        }
+    }
+    
+    void Meditation::deregisterWhiteball() {
+        if (whiteball != NULL &amp;&amp; enter_time == -1) {   // meditatist is registered
+            bool indispensable = objFlags &amp; OBJBIT_INDISPENSIBLE;
+            ChangeMeditation(0, 0, indispensable ? -1 : 0, indispensable ? 0 : -1);
+        }
+        whiteball = NULL;
+    }
+    
+    int Meditation::traitsIdx() const {
+        return state &lt; 0 ? state + 3 : state + 2;
+    }
+
+    ItemTraits Meditation::traits[6] = {
+        {&quot;it_meditation_caldera&quot;,  it_meditation_caldera,  itf_static | itf_fireproof},
+        {&quot;it_meditation_hollow&quot;,  it_meditation_hollow,  itf_static | itf_fireproof},
+        {&quot;it_meditation_dent&quot;,  it_meditation_dent,  itf_static | itf_fireproof},
+        {&quot;it_meditation_bump&quot;,  it_meditation_bump,  itf_static | itf_fireproof},
+        {&quot;it_meditation_hill&quot;,  it_meditation_hill,  itf_static | itf_fireproof},
+        {&quot;it_meditation_vulcano&quot;,  it_meditation_vulcano,  itf_static | itf_fireproof},
+    };
+
+    BOOT_REGISTER_START
+        BootRegister(new Meditation(-2), &quot;it_meditation&quot;);
+        BootRegister(new Meditation(-3), &quot;it_meditation_caldera&quot;);
+        BootRegister(new Meditation(-2), &quot;it_meditation_hollow&quot;);
+        BootRegister(new Meditation(-1), &quot;it_meditation_dent&quot;);
+        BootRegister(new Meditation(1), &quot;it_meditation_bump&quot;);
+        BootRegister(new Meditation(2), &quot;it_meditation_hill&quot;);
+        BootRegister(new Meditation(3), &quot;it_meditation_vulcano&quot;);
+    BOOT_REGISTER_END
+
+} // namespace enigma


Property changes on: trunk/src/items/Meditation.cc
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/items/Meditation.hh
===================================================================
--- trunk/src/items/Meditation.hh	2008-08-31 19:38:31 UTC (rev 1297)
+++ trunk/src/items/Meditation.hh	2008-08-31 21:18:10 UTC (rev 1298)
@@ -0,0 +1,84 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef MEDITATIONITEM_HH
+#define MEDITATIONITEM_HH
+
+#include &quot;items.hh&quot;
+
+#include &quot;actors.hh&quot;
+#include &quot;stones.hh&quot;
+
+namespace enigma {
+    class Meditation : public Item {
+        CLONEOBJ(Meditation);
+        DECL_ITEMTRAITS_ARRAY(6, traitsIdx());
+
+        enum iState {
+            CALDERA = -3,     ///&lt; a large deepening with a small hill in the middle
+            HOLLOW  = -2,     ///&lt; a large deepening
+            DENT    = -1,     ///&lt; a small deepening
+            BUMP    =  1,     ///&lt; a small elevation
+            HILL    =  2,     ///&lt; a large elevation
+            VOLCANO =  3      ///&lt; a large elevation with a small dent in the middle
+        };
+
+        enum ObjectPrivatFlagsBits {
+            OBJBIT_INDISPENSIBLE =   1&lt;&lt;24,   ///&lt; 
+        };
+    public:                
+        Meditation(int initState);
+        
+        // Object interface
+        virtual std::string getClass() const;
+        virtual void setAttr(const string&amp; key, const Value &amp;val);
+        virtual Value getAttr(const std::string &amp;key) const;
+        virtual Value message(const Message &amp;m);
+
+        // StateObject interface
+        virtual int minState() const;
+        virtual int maxState() const;
+        virtual void toggleState();
+        virtual void setState(int extState);
+        
+        // GridObject interface
+        virtual void on_creation(GridPos p);
+        virtual void on_removal(GridPos p);
+        virtual void actor_leave(Actor *a);
+        
+        // Items interface
+        virtual void on_stonehit(Stone *st);
+        virtual bool actor_hit(Actor *a);
+        virtual void add_force(Actor *a, ecl::V2 &amp;f);
+        
+    private:
+        // Variables.
+        Actor *whiteball;   // The small white ball that is currently being tracked
+        double enter_time;  // ... when did it enter the hollow?
+
+        bool isMeditating(Actor *a);
+        void shovel();
+        void checkActors();
+        void deregisterWhiteball();
+        int traitsIdx() const;
+    };
+    
+} // namespace enigma
+
+#endif


Property changes on: trunk/src/items/Meditation.hh
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/src/items.cc
===================================================================
--- trunk/src/items.cc	2008-08-31 19:38:31 UTC (rev 1297)
+++ trunk/src/items.cc	2008-08-31 21:18:10 UTC (rev 1298)
@@ -699,278 +699,6 @@
         {&quot;it_coin_l&quot;,  it_coin4,  itf_none, 0.0},
     };
     
-
-
-/* -------------------- Hills and Hollows -------------------- */
-
-/** \page it-hills Hills and Hollows
-
-Hills and hollows are placed on the floor and can
-make the movement difficult.
-
-\subsection hillsm Messages
-- \b trigger	will convert a hill to a hollow and vice versa
-- \b shovel     decreases the size of the hill/hollow
-
-\image html it-hill.png
-*/
-namespace
-{
-    class HillHollow : public Item {
-    public:
-        // Object interface.
-        virtual Value message(const Message &amp;m);
-    protected:
-        enum Type { HILL, HOLLOW, TINYHILL, TINYHOLLOW };
-
-        HillHollow(Type t);
-
-        void transmute(Type newtype);
-        V2 vec_to_center (V2 v);
-        double get_radius() const { return m_radius[m_type]; }
-
-        Type get_type() const { return m_type; }
-
-    private:
-        double get_forcefac() const {
-            return m_forcefac[m_type] * server::HoleForce;
-        }
-        void shovel();
-
-        // Item interface
-        void add_force(Actor *a, V2 &amp;f);
-        void on_stonehit(Stone *st);
-
-
-        // Variables.
-        static double m_radius[4], m_forcefac[4];
-        Type m_type;
-    };
-
-    class Hill : public HillHollow {
-        CLONEOBJ(Hill);
-        DECL_ITEMTRAITS;
-    public:
-        Hill() : HillHollow(HILL) {}
-    };
-    DEF_ITEMTRAITSF(Hill, &quot;it-hill&quot;, it_hill, itf_static | itf_fireproof);
-
-    class TinyHill : public HillHollow {
-        CLONEOBJ(TinyHill);
-        DECL_ITEMTRAITS;
-    public:
-        TinyHill() : HillHollow(TINYHILL) {}
-    };
-    DEF_ITEMTRAITSF(TinyHill, &quot;it-tinyhill&quot;, it_tinyhill, itf_static | itf_fireproof);
-
-    /*
-     * Hollows are special in that they can end the current level
-     * if they have each a small white marble inside them.
-     */
-    class Hollow : public HillHollow {
-        CLONEOBJ(Hollow);
-        DECL_ITEMTRAITS;
-    public:
-        Hollow(Type t = HOLLOW);
-        // Object interface.
-        virtual Value message(const Message &amp;m);
-        virtual void on_creation(GridPos p);
-        virtual void on_removal(GridPos p);
-    protected:
-        virtual void setup_successor(Item *newitem);
-    private:
-        // Item interface.
-        bool actor_hit(Actor *a);
-        void actor_leave(Actor *a);
-
-        // Functions.
-        bool near_center_p (Actor *a);
-
-        // Variables.
-        Actor *whiteball;   // The small white ball that is currently being tracked
-        double enter_time;  // ... when did it enter the hollow?
-    };
-    DEF_ITEMTRAITSF(Hollow, &quot;it-hollow&quot;, it_hollow, itf_static | itf_fireproof);
-
-
-    class TinyHollow : public Hollow {
-        CLONEOBJ(TinyHollow);
-        DECL_ITEMTRAITS;
-    public:
-        TinyHollow() : Hollow(TINYHOLLOW) {}
-    };
-    DEF_ITEMTRAITSF(TinyHollow, &quot;it-tinyhollow&quot;, it_tinyhollow, itf_static | itf_fireproof);
-
-}
-
-
-/* ---------- HillHollow ---------- */
-
-double HillHollow::m_radius[4] = {0.5, 0.5, 0.3, 0.3};
-double HillHollow::m_forcefac[4] = {90,-90, 90, -90};
-
-
-HillHollow::HillHollow (Type t)
-: m_type(t)
-{}
-
-void HillHollow::on_stonehit(Stone *)
-{
-    shovel();
-}
-
-void HillHollow::shovel() {
-    switch (get_id (this)) {
-    case it_hollow: transmute (TINYHOLLOW); break;
-    case it_hill:   transmute (TINYHILL); break;
-    default:        kill(); break;
-    }
-}
-
-Value HillHollow::message(const Message &amp;m)
-{
-    if (m.message == &quot;flip&quot;) {
-        Type flippedkind[] = {HOLLOW,HILL, TINYHOLLOW,TINYHILL};
-        transmute(flippedkind[m_type]);
-        return Value();
-    } else if (m.message == &quot;signal&quot;) {
-        if (m.value != 0) {
-            Type flippedkind[] = {HILL,HILL, TINYHILL,TINYHILL};
-            transmute(flippedkind[m_type]);
-        } else {
-            Type flippedkind[] = {HOLLOW,HOLLOW, TINYHOLLOW,TINYHOLLOW};
-            transmute(flippedkind[m_type]);
-        }
-        return Value();
-    } else if (m.message == &quot;shovel&quot;) {
-        shovel();
-        return Value();
-    } 
-    return Item::message(m);
-}
-
-V2 HillHollow::vec_to_center (V2 v)
-{
-    return v-get_pos().center();
-}
-
-void HillHollow::add_force(Actor *a, V2 &amp;f)
-{
-    V2     v    = vec_to_center(a-&gt;get_pos());
-    double dist = length(v);
-
-    if (dist &gt; get_radius())
-        return;
-
-    if (dist &lt;= 0) { // exactly on hill-top
-        ActorInfo *ai = a-&gt;get_actorinfo();
-        if (length(ai-&gt;vel) &lt;= 0) { // no velocity
-            // we are never &quot;exactly&quot; on the top!
-            v = ecl::V2(DoubleRand(0.01, 0.05), DoubleRand(0.01, 0.05));
-        }
-    }
-
-    f += get_forcefac()*v; // get the force
-}
-
-void HillHollow::transmute(Type newtype)
-{
-    static char *newmodel[] = { &quot;it-hill&quot;, &quot;it-hollow&quot;, &quot;it-tinyhill&quot;, &quot;it-tinyhollow&quot; };
-    replace(newmodel[newtype]);
-}
-
-
-/* ---------- Hollow ---------- */
-
-// TODO handle set of essential attribute
-
-Hollow::Hollow(Type t) : HillHollow(t), whiteball(0), enter_time (-1) {
-}
-
-Value Hollow::message(const Message &amp;m) {
-    Log &lt;&lt; &quot;Hollow - init time &quot; &lt;&lt; server::LevelTime &lt;&lt; &quot;\n&quot;;
-    if (m.message == &quot;_init&quot;) {
-        vector&lt;Actor*&gt; actors;
-        GetActorsInsideField(get_pos(), actors);
-        for (vector&lt;Actor*&gt;::iterator it = actors.begin(); it != actors.end(); ++it) {
-            Log &lt;&lt; &quot;Hollow - initial meditatist  typ &quot; &lt;&lt; get_id(*it) &lt;&lt; &quot;\n&quot;;
-            if (!(*it)-&gt;is_flying() &amp;&amp;  whiteball==NULL &amp;&amp; get_id(*it)==ac_meditation &amp;&amp; near_center_p(*it)) {
-                 // meditatist entered a free hollow
-                whiteball  = *it;
-                enter_time = server::LevelTime;
-                Log &lt;&lt; &quot;Hollow - initial meditatist time &quot; &lt;&lt; enter_time &lt;&lt; &quot;\n&quot;;
-                break;
-            }
-        }
-        return Value();
-    }
-    return HillHollow::message(m);
-}
-
-void Hollow::on_creation(GridPos p) {
-    if (getDefaultedAttr(&quot;essential&quot;, 0) == 1)
-        ChangeMeditation(0, +1, 0, 0);
-    HillHollow::on_creation(p);
-}
-
-void Hollow::on_removal(GridPos p) {   //TODO a change from Hollow to TinyHollow is critical -&gt; single class with state reengineering
-    if (getDefaultedAttr(&quot;essential&quot;, 0) == 1)
-        ChangeMeditation(0, -1, 0, 0);
-    HillHollow::on_removal(p);
-}
-
-bool Hollow::near_center_p (Actor *a)
-{
-    return (length(vec_to_center(a-&gt;get_pos())) &lt; get_radius()*0.8);
-}
-
-bool Hollow::actor_hit(Actor *a)
-{
-    const double MINTIME = 1.0;
-    ItemID id = get_id (this);
-
-    if (id == it_hollow || id == it_tinyhollow) {
-        if (whiteball==NULL &amp;&amp; get_id(a)==ac_meditation &amp;&amp; near_center_p(a)) {
-            // meditatist entered a free hollow
-            whiteball  = a;
-            enter_time = server::LevelTime;
-        } else if (whiteball == a) {
-            if (!near_center_p(a)) {
-                // meditatist left hollow
-                whiteball = NULL;
-                if (enter_time == -1) {   // meditatist is registered
-                    bool indispensable = (getDefaultedAttr(&quot;essential&quot;, 0) == 1);
-                    ChangeMeditation(0, 0, indispensable ? -1 : 0, indispensable ? 0 : -1);
-                }
-            } else  if (enter_time != -1 &amp;&amp; (server::LevelTime - enter_time) &gt;= MINTIME) {
-                    // just meditated enough to mark hollow as engaged
-                    bool indispensable = (getDefaultedAttr(&quot;essential&quot;, 0) == 1);
-                    ChangeMeditation(0, 0, indispensable ? +1 : 0, indispensable ? 0 : +1);
-                    enter_time = -1;  // mark as registered
-            }
-        }
-    }
-
-    return false;
-}
-
-void Hollow::actor_leave(Actor *a) {
-    if (whiteball == a) {
-        // meditatist left hollow (warp, ...)
-        whiteball = NULL;
-        if (enter_time == -1) {   // meditatist is registered
-            bool indispensable = (getDefaultedAttr(&quot;essential&quot;, 0) == 1);
-            ChangeMeditation(0, 0, indispensable ? -1 : 0, indispensable ? 0 : -1);
-        }
-    }
-}
-
-
-void Hollow::setup_successor(Item *newitem) {
-    newitem-&gt;setAttr(&quot;essential&quot;, getAttr(&quot;essential&quot;));
-}
-
-
 /* -------------------- Springs -------------------- */
 
 /** \page it-spring Spring
@@ -1087,7 +815,7 @@
         void animcb() {
             if (Floor *fl = GetFloor(get_pos()))
                 if (fl-&gt;is_destructible())
-                    replace(&quot;it-hollow&quot;);
+                    replace(&quot;it_meditation_hollow&quot;);
                 else
                     kill();
         }
@@ -2567,8 +2295,6 @@
     RegisterItem (new Floppy);
     RegisterItem (new Hammer(false));
     Register (&quot;it_hammer_new&quot;, new Hammer(true));
-    RegisterItem (new Hill);
-    RegisterItem (new Hollow);
     RegisterItem (new Trap);
     RegisterItem (new Key);
     RegisterItem (new Landmine);
@@ -2590,8 +2316,6 @@
     RegisterItem (new SurpriseItem);
     RegisterItem (new Sword(false));
     Register (&quot;it_sword_new&quot;, new Sword(true));
-    RegisterItem (new TinyHill);
-    RegisterItem (new TinyHollow);
     RegisterItem (new TwoPKillStone);
     RegisterItem (new Umbrella(false));
     Register (&quot;it_umbrella_new&quot;, new Umbrella(true));

Modified: trunk/src/items.hh
===================================================================
--- trunk/src/items.hh	2008-08-31 19:38:31 UTC (rev 1297)
+++ trunk/src/items.hh	2008-08-31 21:18:10 UTC (rev 1298)
@@ -88,6 +88,12 @@
         it_magicwand,
         it_magnet_off,
         it_magnet_on,
+        it_meditation_caldera,
+        it_meditation_hollow,
+        it_meditation_dent,
+        it_meditation_bump,
+        it_meditation_hill,
+        it_meditation_vulcano,
         it_odometer,
         it_pencil,
         it_pin,

Modified: trunk/src/ox_extra.cc
===================================================================
--- trunk/src/ox_extra.cc	2008-08-31 19:38:31 UTC (rev 1297)
+++ trunk/src/ox_extra.cc	2008-08-31 21:18:10 UTC (rev 1298)
@@ -355,11 +355,11 @@
     UNUSED,                  // OxydExtra item 0x2c
     &quot;it_vortex_open&quot;,             // OxydExtra item 0x2d
     UNUSED,                  // OxydExtra item 0x2e
-    &quot;it_wormhole_on&quot;,             // OxydExtra item 0x2f
-    &quot;it-hill&quot;,                    // OxydExtra item 0x30
-    &quot;it-tinyhill&quot;,                // OxydExtra item 0x31
-    &quot;it-hollow&quot;,                  // OxydExtra item 0x32
-    &quot;it-tinyhollow&quot;,              // OxydExtra item 0x33
+    &quot;it_wormhole_on&quot;,        // OxydExtra item 0x2f
+    &quot;it_meditation_hill&quot;,    // OxydExtra item 0x30
+    &quot;it_meditation_bump&quot;,    // OxydExtra item 0x31
+    &quot;it_meditation_hollow&quot;,  // OxydExtra item 0x32
+    &quot;it_meditation_dent&quot;,    // OxydExtra item 0x33
     UNUSED,                  // OxydExtra item 0x34
     UNUSED,                  // OxydExtra item 0x35
     UNUSED,                  // OxydExtra item 0x36

Modified: trunk/src/ox_magnum.cc
===================================================================
--- trunk/src/ox_magnum.cc	2008-08-31 19:38:31 UTC (rev 1297)
+++ trunk/src/ox_magnum.cc	2008-08-31 21:18:10 UTC (rev 1298)
@@ -338,10 +338,10 @@
     &quot;it_vortex_open&quot;,   // OxydMagnum item 0x2d
     &quot;it_vortex_closed&quot;, // OxydMagnum item 0x2e
     &quot;it_wormhole_on&quot;,   // OxydMagnum item 0x2f
-    &quot;it-hill&quot;,          // OxydMagnum item 0x30
-    &quot;it-tinyhill&quot;,      // OxydMagnum item 0x31
-    &quot;it-hollow&quot;,        // OxydMagnum item 0x32
-    &quot;it-tinyhollow&quot;,    // OxydMagnum item 0x33
+    &quot;it_meditation_hill&quot;,   // OxydMagnum item 0x30
+    &quot;it_meditation_bump&quot;,   // OxydMagnum item 0x31
+    &quot;it_meditation_hollow&quot;, // OxydMagnum item 0x32
+    &quot;it_meditation_dent&quot;,   // OxydMagnum item 0x33
     &quot;it_strip_ns&quot;,      // OxydMagnum item 0x34
     &quot;it_strip_ew&quot;,      // OxydMagnum item 0x35
     &quot;it-springboard&quot;,   // OxydMagnum item 0x36

Modified: trunk/src/ox_oxyd1.cc
===================================================================
--- trunk/src/ox_oxyd1.cc	2008-08-31 19:38:31 UTC (rev 1297)
+++ trunk/src/ox_oxyd1.cc	2008-08-31 21:18:10 UTC (rev 1298)
@@ -354,10 +354,10 @@
     &quot;it_vortex_open&quot;,             // 0x2d
     &quot;it_vortex_closed&quot;,           // 0x2e
     &quot;it_wormhole_on&quot;,             // 0x2f
-    &quot;it-hill&quot;,                    // 0x30
-    &quot;it-tinyhill&quot;,                // 0x31
-    &quot;it-hollow&quot;,                  // 0x32
-    &quot;it-tinyhollow&quot;,              // 0x33
+    &quot;it_meditation_hill&quot;,         // 0x30
+    &quot;it_meditation_bump&quot;,         // 0x31
+    &quot;it_meditation_hollow&quot;,       // 0x32
+    &quot;it_meditation_dent&quot;,         // 0x33
     &quot;it_strip_ns&quot;,                // 0x34
     &quot;it_strip_ew&quot;,                // 0x35
     &quot;it-springboard&quot;,             // 0x36

Modified: trunk/src/ox_peroxyd.cc
===================================================================
--- trunk/src/ox_peroxyd.cc	2008-08-31 19:38:31 UTC (rev 1297)
+++ trunk/src/ox_peroxyd.cc	2008-08-31 21:18:10 UTC (rev 1298)
@@ -427,10 +427,10 @@
     &quot;it_vortex_open&quot;,             // 0x2d
     &quot;it_vortex_closed&quot;,           // 0x2e
     &quot;it_wormhole_on&quot;,             // 0x2f XXX
-    &quot;it-hill&quot;,                    // 0x30
-    &quot;it-tinyhill&quot;,                // 0x31
-    &quot;it-hollow&quot;,                  // 0x32
-    &quot;it-tinyhollow&quot;,              // 0x33
+    &quot;it_meditation_hill&quot;,         // 0x30
+    &quot;it_meditation_bump&quot;,         // 0x31
+    &quot;it_meditation_hollow&quot;,       // 0x32
+    &quot;it_meditation_dent&quot;,         // 0x33
     &quot;it_strip_ns&quot;,                // 0x34
     &quot;it_strip_ew&quot;,                // 0x35
     &quot;it-springboard&quot;,             // 0x36


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000727.html">[Enigma-game-svn] r1297 - trunk/doc/reference
</A></li>
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#728">[ date ]</a>
              <a href="thread.html#728">[ thread ]</a>
              <a href="subject.html#728">[ subject ]</a>
              <a href="author.html#728">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/enigma-game-svn">More information about the Enigma-game-svn
mailing list</a><br>
</body></html>
