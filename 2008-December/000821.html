<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Enigma-game-svn] r1392 - in trunk: data data/gfx32 data/gfx40	data/gfx48 data/schemas src src/floors src/stones
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/enigma-game-svn/2008-December/index.html" >
   <LINK REL="made" HREF="mailto:enigma-game-svn%40lists.berlios.de?Subject=Re%3A%20%5BEnigma-game-svn%5D%20r1392%20-%20in%20trunk%3A%20data%20data/gfx32%20data/gfx40%0A%09data/gfx48%20data/schemas%20src%20src/floors%20src/stones&In-Reply-To=%3C200812131414.mBDEEOUm017209%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000820.html">
   <LINK REL="Next"  HREF="000822.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Enigma-game-svn] r1392 - in trunk: data data/gfx32 data/gfx40	data/gfx48 data/schemas src src/floors src/stones</H1>
    <B>ral at BerliOS</B> 
    <A HREF="mailto:enigma-game-svn%40lists.berlios.de?Subject=Re%3A%20%5BEnigma-game-svn%5D%20r1392%20-%20in%20trunk%3A%20data%20data/gfx32%20data/gfx40%0A%09data/gfx48%20data/schemas%20src%20src/floors%20src/stones&In-Reply-To=%3C200812131414.mBDEEOUm017209%40sheep.berlios.de%3E"
       TITLE="[Enigma-game-svn] r1392 - in trunk: data data/gfx32 data/gfx40	data/gfx48 data/schemas src src/floors src/stones">ral at mail.berlios.de
       </A><BR>
    <I>Sat Dec 13 15:14:24 CET 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000820.html">[Enigma-game-svn] r1391 - in trunk
</A></li>
        <LI>Next message: <A HREF="000822.html">[Enigma-game-svn] r1393 - team_levelpacks/team_test_new_api
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#821">[ date ]</a>
              <a href="thread.html#821">[ thread ]</a>
              <a href="subject.html#821">[ subject ]</a>
              <a href="author.html#821">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: ral
Date: 2008-12-13 15:14:22 +0100 (Sat, 13 Dec 2008)
New Revision: 1392

Added:
   trunk/data/gfx32/fl_hay.png
   trunk/data/gfx32/fl_rock.png
   trunk/data/gfx40/fl_hay.png
   trunk/data/gfx40/fl_rock.png
   trunk/data/gfx48/fl_hay.png
   trunk/data/gfx48/fl_rock.png
   trunk/src/floors/FloodStream.cc
   trunk/src/floors/FloodStream.hh
Removed:
   trunk/data/gfx32/fl-hay.png
   trunk/data/gfx32/fl-rock.png
   trunk/data/gfx40/fl-hay.png
   trunk/data/gfx40/fl-rock.png
   trunk/data/gfx48/fl-hay.png
   trunk/data/gfx48/fl-rock.png
Modified:
   trunk/data/api1init.lua
   trunk/data/models-2d.lua
   trunk/data/schemas/objects.xml
   trunk/data/startup.lua
   trunk/src/Makefile.am
   trunk/src/WorldProxy.cc
   trunk/src/enigma-lua.pkg
   trunk/src/floors.cc
   trunk/src/floors.hh
   trunk/src/floors/BridgeFloor.cc
   trunk/src/lua-display.cc
   trunk/src/lua-display.hh
   trunk/src/lua-ecl.cc
   trunk/src/lua-ecl.hh
   trunk/src/lua-editor.cc
   trunk/src/lua-editor.hh
   trunk/src/lua-enigma.cc
   trunk/src/lua-enigma.hh
   trunk/src/lua-global.cc
   trunk/src/lua-global.hh
   trunk/src/ox_extra.cc
   trunk/src/ox_magnum.cc
   trunk/src/ox_oxyd1.cc
   trunk/src/ox_peroxyd.cc
   trunk/src/server.cc
   trunk/src/server.hh
   trunk/src/stones.hh
   trunk/src/stones/Door.cc
   trunk/src/stones/Door.hh
   trunk/src/stones/FloorBuilder.cc
   trunk/src/stones/FloorBuilder.hh
   trunk/src/stones/WindowStone.cc
   trunk/src/stones/WindowStone.hh
Log:
Trunk 1.1: new API reengineering
- floor preparation for declartion in objects.xml instead of startup.lua
- object declarations for floors: swamp, space, abyss, ice, fixes for bridge
- floodstream floors: 
  fl_water, fl_water_source, fl_hay, fl_hay_framed, fl_rock, fl_rock_framed,
  fl_wood, fl_wood_h, fl_wood_v, fl_wood_framed, fl_wood_framed_h and _v
 - water and these framed floors, as created by floorbuilding stones, do
   represent flooded areas
 - all floors do support new attribute &quot;floodable&quot;, default false
 - flood activation by state FLOODING on water or framed floodstream floors
 - fl_water_source is water in state FLOODING
 - attribute &quot;interval&quot; on floodstream floors determines speed
 - flood spreads on floodable areas and over water and framed floodstream floors
 - flood is stopped by stones that deny spreading: all stones besides floating
   onces and open doors and windows on sides without faces
 - floorbuilder stones will fall on flood but will not stop flood
 - flood continues when obstacle is removed, e.g. movable stone pushed away,
   door opened, window face broken or pulled
- remove unused and depreceated global attribute &quot;IceFriction&quot;
- no new API access from Lua to depreceated global attribute &quot;FlatForce&quot;
- fix memory smasher on heating animation


Modified: trunk/data/api1init.lua
===================================================================
--- trunk/data/api1init.lua	2008-12-12 22:16:08 UTC (rev 1391)
+++ trunk/data/api1init.lua	2008-12-13 14:14:22 UTC (rev 1392)
@@ -47,10 +47,18 @@
 RenamingObjectsNew2Old = {
     fl_abyss = &quot;fl-abyss&quot;,
     fl_bridge = &quot;fl-bridge&quot;,
+    fl_hay = &quot;fl-hay&quot;,
     fl_ice = &quot;fl-ice&quot;,
+    fl_rock = &quot;fl-rock&quot;,
     fl_space = &quot;fl-space&quot;,
     fl_swamp = &quot;fl-swamp&quot;,
     fl_water = &quot;fl-water&quot;,
+    fl_wood = &quot;fl-wood&quot;,
+    fl_wood_h = &quot;fl-wood1&quot;,
+    fl_wood_v = &quot;fl-wood2&quot;,
+    fl_wood_framed = &quot;fl-stwood&quot;,
+    fl_wood_framed_h = &quot;fl-stwood1&quot;,
+    fl_wood_framed_v = &quot;fl-stwood2&quot;,
     it_blocker = &quot;it-blocker&quot;,
     it_blocker_new = &quot;it-blocker-new&quot;,
     it_brake = &quot;it-brake&quot;,

Deleted: trunk/data/gfx32/fl-hay.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx32/fl-rock.png
===================================================================
(Binary files differ)

Copied: trunk/data/gfx32/fl_hay.png (from rev 1390, trunk/data/gfx32/fl-hay.png)

Copied: trunk/data/gfx32/fl_rock.png (from rev 1390, trunk/data/gfx32/fl-rock.png)

Deleted: trunk/data/gfx40/fl-hay.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx40/fl-rock.png
===================================================================
(Binary files differ)

Copied: trunk/data/gfx40/fl_hay.png (from rev 1390, trunk/data/gfx40/fl-hay.png)

Copied: trunk/data/gfx40/fl_rock.png (from rev 1390, trunk/data/gfx40/fl-rock.png)

Deleted: trunk/data/gfx48/fl-hay.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx48/fl-rock.png
===================================================================
(Binary files differ)

Copied: trunk/data/gfx48/fl_hay.png (from rev 1390, trunk/data/gfx48/fl-hay.png)

Copied: trunk/data/gfx48/fl_rock.png (from rev 1390, trunk/data/gfx48/fl-rock.png)

Modified: trunk/data/models-2d.lua
===================================================================
--- trunk/data/models-2d.lua	2008-12-12 22:16:08 UTC (rev 1391)
+++ trunk/data/models-2d.lua	2008-12-13 14:14:22 UTC (rev 1392)
@@ -269,14 +269,14 @@
         {&quot;fl-concrete&quot;, 4},
         {&quot;fl-gravel&quot;, 4},
         {&quot;fl-gray&quot;, 5},
-        {&quot;fl-hay&quot;, 4},
+        {&quot;fl_hay&quot;, 4},
         {&quot;fl-himalaya&quot;, 4},
         {&quot;fl-marble&quot;, 4},
         {&quot;fl-metal&quot;, 6},
         {&quot;fl-mortar&quot;, 2, 2},
         {&quot;fl-plank&quot;, 4},
         {&quot;fl-red&quot;, 4},
-        {&quot;fl-rock&quot;, 2},
+        {&quot;fl_rock&quot;, 2},
         {&quot;fl-rough&quot;, 5},
         {&quot;fl-rough-blue&quot;, 4},
         {&quot;fl-rough-red&quot;, 4},
@@ -351,6 +351,13 @@
     DefRandFloor(&quot;fl-wood&quot;, {&quot;fl-woodx1&quot;, &quot;fl-woodx2&quot;, &quot;fl-woodx3&quot;, &quot;fl-woodx4&quot;})
     DefRandFloor(&quot;fl-wood1&quot;, {&quot;fl-woodx3&quot;, &quot;fl-woodx4&quot;})
     DefRandFloor(&quot;fl-wood2&quot;, {&quot;fl-woodx1&quot;, &quot;fl-woodx2&quot;})
+    
+    DefAlias(&quot;fl_wood&quot;, &quot;fl-wood&quot;)
+    DefAlias(&quot;fl_wood1&quot;, &quot;fl-wood1&quot;)
+    DefAlias(&quot;fl_wood2&quot;, &quot;fl-wood2&quot;)
+    DefAlias(&quot;fl_wood_framed&quot;, &quot;fl-stwood&quot;)
+    DefAlias(&quot;fl_wood_framed1&quot;, &quot;fl-stwood1&quot;)
+    DefAlias(&quot;fl_wood_framed2&quot;, &quot;fl-stwood2&quot;)
 end
 
 --------------------------

Modified: trunk/data/schemas/objects.xml
===================================================================
--- trunk/data/schemas/objects.xml	2008-12-12 22:16:08 UTC (rev 1391)
+++ trunk/data/schemas/objects.xml	2008-12-13 14:14:22 UTC (rev 1392)
@@ -7,7 +7,7 @@
     &lt;attr name=&quot;anchor1&quot; type=&quot;tokens&quot; default=&quot;nil&quot; rw=&quot;rw&quot;/&gt;
     &lt;attr name=&quot;anchor2&quot; type=&quot;tokens&quot; default=&quot;nil&quot; rw=&quot;rw&quot;/&gt;
     &lt;attr name=&quot;autoclose&quot; type=&quot;bool&quot; default=&quot;false&quot; rw=&quot;rw&quot;/&gt;
-    &lt;attr name=&quot;burnable&quot; type=&quot;bool&quot; default=&quot;false&quot; rw=&quot;rw&quot;/&gt;
+    &lt;attr name=&quot;burnable&quot; type=&quot;bool&quot; default=&quot;nil&quot; rw=&quot;rw&quot;/&gt;
     &lt;attr name=&quot;cluster&quot; type=&quot;int&quot; default=&quot;nil&quot; min=&quot;0&quot; max=&quot;9&quot; rw=&quot;rw&quot;/&gt;
     &lt;attr name=&quot;code&quot; type=&quot;int&quot; default=&quot;1&quot; rw=&quot;rw&quot;/&gt;
     &lt;attr name=&quot;coin_value&quot; type=&quot;double&quot; default=&quot;1&quot; rw=&quot;rw&quot;/&gt;
@@ -22,6 +22,7 @@
     &lt;attr name=&quot;fastfire&quot; type=&quot;bool&quot; default=&quot;false&quot; rw=&quot;rw&quot;/&gt;
     &lt;attr name=&quot;fellows&quot; type=&quot;group&quot; default=&quot;nil&quot; rw=&quot;r&quot;/&gt;
     &lt;attr name=&quot;flavor&quot; type=&quot;string&quot; default=&quot;b&quot; rw=&quot;rw&quot;/&gt;
+    &lt;attr name=&quot;floodable&quot; type=&quot;bool&quot; default=&quot;false&quot; rw=&quot;rw&quot;/&gt;
     &lt;attr name=&quot;freeze_check&quot; type=&quot;bool&quot; default=&quot;false&quot; rw=&quot;rw&quot;/&gt;
     &lt;attr name=&quot;friction&quot; type=&quot;double&quot; default=&quot;nil&quot; rw=&quot;rw&quot;/&gt;
     &lt;attr name=&quot;gradient&quot; type=&quot;double&quot; default=&quot;nil&quot; rw=&quot;rw&quot;/&gt;
@@ -68,6 +69,8 @@
     &lt;attr name=&quot;transparent&quot; type=&quot;bool&quot; default=&quot;false&quot; rw=&quot;rw&quot;/&gt;
     &lt;attr name=&quot;threshold&quot; type=&quot;double&quot; default=&quot;0&quot; rw=&quot;rw&quot;/&gt;
     &lt;attr name=&quot;wires&quot; type=&quot;group&quot; default=&quot;nil&quot; rw=&quot;r&quot;/&gt;
+    &lt;attr name=&quot;$firetransform&quot; type=&quot;string&quot; default=&quot;&quot; rw=&quot;&quot;/&gt;
+    &lt;attr name=&quot;$heattransform&quot; type=&quot;string&quot; default=&quot;&quot; rw=&quot;&quot;/&gt;
   &lt;/attributes&gt;
   &lt;messages&gt;
     &lt;msg name=&quot;close&quot; type=&quot;nil&quot;/&gt;
@@ -106,6 +109,7 @@
     &lt;msg name=&quot;_bombstone&quot; type=&quot;nil&quot;/&gt;
     &lt;msg name=&quot;_brush&quot; type=&quot;nil&quot;/&gt;
     &lt;msg name=&quot;_capture&quot; type=&quot;nil&quot;/&gt;
+    &lt;msg name=&quot;_checkflood&quot; type=&quot;nil&quot;/&gt;
     &lt;msg name=&quot;_explosion&quot; type=&quot;nil&quot;/&gt;
     &lt;msg name=&quot;_freeze&quot; type=&quot;nil&quot;/&gt;
     &lt;msg name=&quot;_glasses&quot; type=&quot;nil&quot;/&gt;
@@ -143,6 +147,7 @@
       &lt;attr name=&quot;burnable&quot;/&gt;
       &lt;attr name=&quot;eternal&quot;/&gt;
       &lt;attr name=&quot;fastfire&quot;/&gt;
+      &lt;attr name=&quot;floodable&quot;/&gt;
       &lt;attr name=&quot;freeze_check&quot;/&gt;
       &lt;attr name=&quot;friction&quot;/&gt;
       &lt;attr name=&quot;ignitable&quot;/&gt;
@@ -156,8 +161,23 @@
       &lt;msg name=&quot;setfire&quot;/&gt;
       &lt;msg name=&quot;stopfire&quot;/&gt;
     &lt;/object&gt;
+    &lt;object name=&quot;fl_floodstream&quot; abstract=&quot;true&quot;&gt;
+      &lt;attr name=&quot;faces&quot;/&gt;
+      &lt;attr name=&quot;interval&quot; default=&quot;0.5&quot;/&gt;
+      &lt;msg name=&quot;_init&quot;/&gt;
+      &lt;msg name=&quot;_checkflood&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;fl_abyss&quot;&gt;
+      &lt;attr name=&quot;friction&quot; default=&quot;2.0&quot;/&gt;
+      &lt;attr name=&quot;adhesion&quot; default=&quot;1.0&quot;/&gt;
+      &lt;attr name=&quot;noash&quot; default=&quot;true&quot;/&gt;
+    &lt;/object&gt;
     &lt;object name=&quot;fl_bridge&quot;&gt;
       &lt;attr name=&quot;flavor&quot; default=&quot;gc&quot;/&gt;
+      &lt;attr name=&quot;friction&quot; default=&quot;5.0&quot;/&gt;
+      &lt;attr name=&quot;adhesion&quot; default=&quot;1.0&quot;/&gt;
+      &lt;attr name=&quot;noash&quot; default=&quot;true&quot;/&gt;
+      &lt;attr name=&quot;$firetransform&quot; default=&quot;fl_abyss&quot;/&gt;
       &lt;msg name=&quot;close&quot;/&gt;
       &lt;msg name=&quot;open&quot;/&gt;
       &lt;msg name=&quot;signal&quot;/&gt;
@@ -172,6 +192,51 @@
     &lt;object name=&quot;fl_bridge_bn&quot;&gt;
       &lt;attr name=&quot;flavor&quot; value=&quot;bn&quot;/&gt;
     &lt;/object&gt;
+    &lt;object name=&quot;fl_hay&quot; super=&quot;fl_floodstream&quot;&gt;
+      &lt;attr name=&quot;friction&quot; default=&quot;5.0&quot;/&gt;
+      &lt;attr name=&quot;adhesion&quot; default=&quot;1.5&quot;/&gt;
+      &lt;attr name=&quot;burnable&quot; default=&quot;true&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;fl_hay_framed&quot;&gt;
+      &lt;attr name=&quot;faces&quot; value=&quot;nesw&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;fl_ice&quot;&gt;
+      &lt;attr name=&quot;friction&quot; default=&quot;0.1&quot;/&gt;
+      &lt;attr name=&quot;adhesion&quot; default=&quot;0.1&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;fl_rock&quot; super=&quot;fl_floodstream&quot;&gt;
+      &lt;attr name=&quot;friction&quot; default=&quot;6.5&quot;/&gt;
+      &lt;attr name=&quot;adhesion&quot; default=&quot;2.2&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;fl_rock_framed&quot;&gt;
+      &lt;attr name=&quot;faces&quot; value=&quot;nesw&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;fl_space&quot;&gt;
+      &lt;attr name=&quot;friction&quot; default=&quot;0.0&quot;/&gt;
+      &lt;attr name=&quot;adhesion&quot; default=&quot;0.0&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;fl_swamp&quot;&gt;
+      &lt;attr name=&quot;friction&quot; default=&quot;13.0&quot;/&gt;
+      &lt;attr name=&quot;adhesion&quot; default=&quot;1.0&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;fl_water&quot; super=&quot;fl_floodstream&quot;&gt;
+      &lt;attr name=&quot;friction&quot; default=&quot;5.0&quot;/&gt;
+      &lt;attr name=&quot;adhesion&quot; default=&quot;1.0&quot;/&gt;
+      &lt;attr name=&quot;$heattransform&quot; default=&quot;fl_swamp&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;fl_wood&quot; super=&quot;fl_floodstream&quot;&gt;
+      &lt;attr name=&quot;friction&quot; default=&quot;6.4&quot;/&gt;
+      &lt;attr name=&quot;adhesion&quot; default=&quot;2.0&quot;/&gt;
+      &lt;attr name=&quot;burnable&quot; default=&quot;true&quot;/&gt;
+      &lt;attr name=&quot;$firetransform&quot; default=&quot;fl_abyss&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;fl_wood_h&quot; init=&quot;true&quot;/&gt;
+    &lt;object name=&quot;fl_wood_v&quot; init=&quot;true&quot;/&gt;
+    &lt;object name=&quot;fl_wood_framed&quot;&gt;
+      &lt;attr name=&quot;faces&quot; value=&quot;nesw&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;fl_wood_framed_h&quot; init=&quot;true&quot;/&gt;
+    &lt;object name=&quot;fl_wood_framed_v&quot; init=&quot;true&quot;/&gt;
     &lt;object name=&quot;it&quot; abstract=&quot;true&quot;/&gt;
     &lt;object name=&quot;it_blocker&quot;&gt;
       &lt;attr name=&quot;autoclose&quot;/&gt;

Modified: trunk/data/startup.lua
===================================================================
--- trunk/data/startup.lua	2008-12-12 22:16:08 UTC (rev 1391)
+++ trunk/data/startup.lua	2008-12-13 14:14:22 UTC (rev 1392)
@@ -188,10 +188,9 @@
 def_floor(&quot;fl-bumps&quot;,        5.0,   1.2,   false,   &quot;&quot;,         true)
 def_floor(&quot;fl-concrete&quot;,     4.5,   1.3,   false,   &quot;&quot;,         true)
 def_floor(&quot;fl-dunes&quot;,        1.3,   1.0,   false,   &quot;&quot;,         true)
-def_floor(&quot;fl-floor_001&quot;,    1.5,   2.5,    true,   &quot;fl-abyss&quot;, true)
+def_floor(&quot;fl-floor_001&quot;,    1.5,   2.5,    true,   &quot;fl_abyss&quot;, true)
 def_floor(&quot;fl-gravel&quot;,       3.2,   1.5,   false,   &quot;&quot;,         true)
 def_floor(&quot;fl-gray&quot;,         5.0,   3.0,   false,   &quot;&quot;,         true)
-def_floor(&quot;fl-hay&quot;,          5.0,   1.5,    true,   &quot;&quot;,         true)
 def_floor(&quot;fl-himalaya&quot;,     5.0,   2.0,   false,   &quot;&quot;,         true)
 def_floor(&quot;fl-inverse&quot;,      3.0,  -2.0,   false,   &quot;&quot;,         false)
 def_floor(&quot;fl-inverse2&quot;,     3.0,  -2.0,   false,   &quot;&quot;,         false)
@@ -223,29 +222,25 @@
 def_floor(&quot;fl-mortar&quot;,       7.2,   1.8,   false,   &quot;&quot;,         true)
 def_floor(&quot;fl-normal&quot;,       4.0,   2.0,   false,   &quot;&quot;,         true)
 def_floor(&quot;fl-normal_x&quot;,     3.0,   2.0,   false,   &quot;&quot;,         true)
-def_floor(&quot;fl-plank&quot;,        5.5,   2.0,    true,   &quot;fl-abyss&quot;, true)
+def_floor(&quot;fl-plank&quot;,        5.5,   2.0,    true,   &quot;fl_abyss&quot;, true)
 def_floor(&quot;fl-red&quot;,          0.9,   1.0,    true,   &quot;&quot;,         true)
-def_floor(&quot;fl-rock&quot;,         6.5,   2.2,   false,   &quot;&quot;,         true)
 def_floor(&quot;fl-rough&quot;,        7.0,   2.0,    true,   &quot;&quot;,         true)
 def_floor(&quot;fl-rough_medium&quot;, 5.0,   1.2,    true,   &quot;&quot;,         true)
 def_floor(&quot;fl-rough_slow&quot;,   7.0,   0.5,    true,   &quot;&quot;,         true)
 def_floor(&quot;fl-rough-blue&quot;,   7.0,   2.0,    true,   &quot;&quot;,         true)
 def_floor(&quot;fl-rough-red&quot;,    7.0,   2.0,    true,   &quot;&quot;,         true)
 def_floor(&quot;fl-sahara&quot;,       6.4,   2.0,   false,   &quot;&quot;,         true)
-def_floor(&quot;fl-samba&quot;,        6.0,   2.0,    true,   &quot;fl-abyss&quot;, true)
-def_floor(&quot;fl-samba1&quot;,       6.0,   2.0,    true,   &quot;fl-abyss&quot;, true)
-def_floor(&quot;fl-samba2&quot;,       6.0,   2.0,    true,   &quot;fl-abyss&quot;, true)
+def_floor(&quot;fl-samba&quot;,        6.0,   2.0,    true,   &quot;fl_abyss&quot;, true)
+def_floor(&quot;fl-samba1&quot;,       6.0,   2.0,    true,   &quot;fl_abyss&quot;, true)
+def_floor(&quot;fl-samba2&quot;,       6.0,   2.0,    true,   &quot;fl_abyss&quot;, true)
 def_floor(&quot;fl-sand&quot;,         6.0,   2.0,   false,   &quot;&quot;,         true)
 def_floor(&quot;fl_space&quot;,        0.0,   0.0,   false,   &quot;&quot;,         false)
 def_floor(&quot;fl-springboard&quot;,  4.0,   2.0,   false,   &quot;&quot;,         true)
 def_floor(&quot;fl-stone&quot;,        1.4,   1.0,   false,   &quot;&quot;,         true)
-def_floor(&quot;fl-stwood&quot;,       6.4,   2.0,    true,   &quot;fl-abyss&quot;, true)
-def_floor(&quot;fl-stwood1&quot;,      6.4,   2.0,    true,   &quot;fl-abyss&quot;, true)
-def_floor(&quot;fl-stwood2&quot;,      6.4,   2.0,    true,   &quot;fl-abyss&quot;, true)
+def_floor(&quot;fl-stwood&quot;,       6.4,   2.0,    true,   &quot;fl_abyss&quot;, true)
+def_floor(&quot;fl-stwood1&quot;,      6.4,   2.0,    true,   &quot;fl_abyss&quot;, true)
+def_floor(&quot;fl-stwood2&quot;,      6.4,   2.0,    true,   &quot;fl_abyss&quot;, true)
 def_floor(&quot;fl-tigris&quot;,       6.0,   2.0,    true,   &quot;&quot;,         true)
-def_floor(&quot;fl-wood&quot;,         6.4,   2.0,    true,   &quot;fl-abyss&quot;, false)
-def_floor(&quot;fl-wood1&quot;,        6.4,   2.0,    true,   &quot;fl-abyss&quot;, false)
-def_floor(&quot;fl-wood2&quot;,        6.4,   2.0,    true,   &quot;fl-abyss&quot;, false)
 def_floor(&quot;fl-woven&quot;,        6.5,   3.0,    true,   &quot;&quot;,         true)
 def_floor(&quot;fl-nomouse&quot;,      2.5,   0.0,    true,   &quot;&quot;,         false)
 def_floor(&quot;fl-black&quot;,        3.0,   1.5,   false,   &quot;&quot;,         true)

Modified: trunk/src/Makefile.am
===================================================================
--- trunk/src/Makefile.am	2008-12-12 22:16:08 UTC (rev 1391)
+++ trunk/src/Makefile.am	2008-12-13 14:14:22 UTC (rev 1392)
@@ -146,6 +146,8 @@
 	XMLtoUtf8.hh		\
 	floors/BridgeFloor.cc	\
 	floors/BridgeFloor.hh	\
+	floors/FloodStream.cc	\
+	floors/FloodStream.hh	\
 	gui/ErrorMenu.cc	\
 	gui/ErrorMenu.hh	\
 	gui/GameMenu.cc		\

Modified: trunk/src/WorldProxy.cc
===================================================================
--- trunk/src/WorldProxy.cc	2008-12-12 22:16:08 UTC (rev 1391)
+++ trunk/src/WorldProxy.cc	2008-12-13 14:14:22 UTC (rev 1392)
@@ -82,14 +82,10 @@
             return server::ElectricForce;
         } else if (key == &quot;ExtralifeGlasses&quot;) {
             return server::ExtralifeGlasses;
-        } else if (key == &quot;FlatForce&quot;) {
-            return server::FlatForce;
         } else if (key == &quot;FrictionFactor&quot;) {
             return server::FrictionFactor;
         } else if (key == &quot;MeditationStrength&quot;) {
             return server::HoleForce;
-        } else if (key == &quot;IceFriction&quot;) {
-            return server::IceFriction;
         } else if (key == &quot;MagnetStrength&quot;) {
             return server::MagnetForce;
         } else if (key == &quot;MagnetRange&quot;) {
@@ -170,14 +166,10 @@
             server::ElectricForce = val;
         } else if (key == &quot;ExtralifeGlasses&quot;) {
             server::ExtralifeGlasses = val;
-        } else if (key == &quot;FlatForce&quot;) {
-            server::FlatForce = val;
         } else if (key == &quot;FrictionFactor&quot;) {
             server::FrictionFactor = val;
         } else if (key == &quot;MeditationStrength&quot;) {
             server::HoleForce = val;
-        } else if (key == &quot;IceFriction&quot;) {
-            server::IceFriction = val;
         } else if (key == &quot;MagnetStrength&quot;) {
             server::MagnetForce = val;
             BroadcastMessage(&quot;_updateglobals&quot;, &quot;it_magnet&quot;, GRID_ITEMS_BIT);

Modified: trunk/src/enigma-lua.pkg
===================================================================
--- trunk/src/enigma-lua.pkg	2008-12-12 22:16:08 UTC (rev 1391)
+++ trunk/src/enigma-lua.pkg	2008-12-13 14:14:22 UTC (rev 1392)
@@ -57,7 +57,6 @@
     extern double SlopeForce;
     extern double FlatForce;
     extern double FrictionFactor;
-    extern double IceFriction;
     extern double ElectricForce;
     extern double BumperForce;
     extern double MagnetForce;

Modified: trunk/src/floors/BridgeFloor.cc
===================================================================
--- trunk/src/floors/BridgeFloor.cc	2008-12-12 22:16:08 UTC (rev 1391)
+++ trunk/src/floors/BridgeFloor.cc	2008-12-13 14:14:22 UTC (rev 1392)
@@ -26,10 +26,9 @@
 
 namespace enigma {
     
-    BridgeFloor::BridgeFloor(std::string flavor) : Floor(&quot;fl_bridge&quot;, 5, 1,
-        flf_default, flft_noash, &quot;fl_abyss&quot;)
-    {
+    BridgeFloor::BridgeFloor(std::string flavor) : Floor(&quot;fl_bridge&quot;)  {
         Floor::setAttr(&quot;flavor&quot;, flavor);
+        Floor::setAttr(&quot;burnable&quot;, flavor != &quot;gc&quot;);
         state = OPEN;
     }
     

Added: trunk/src/floors/FloodStream.cc
===================================================================
--- trunk/src/floors/FloodStream.cc	2008-12-12 22:16:08 UTC (rev 1391)
+++ trunk/src/floors/FloodStream.cc	2008-12-13 14:14:22 UTC (rev 1392)
@@ -0,0 +1,156 @@
+/*
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *  
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include &quot;floors/FloodStream.hh&quot;
+
+#include &quot;errors.hh&quot;
+#include &quot;main.hh&quot;
+#include &quot;stones.hh&quot;
+#include &quot;world.hh&quot;
+
+namespace enigma {
+    
+    FloodStream::FloodStream(int subtyp, int model, bool framed, FloorFlags flags,  bool isFloodSource) :
+                Floor(&quot;fl_floodstream&quot;, 0.0, 0.0, flags) {
+        objFlags |= (subtyp &lt;&lt; 24) | (model &lt;&lt; 26);
+        state = isFloodSource ? FLOODING : IDLE;
+        Floor::setAttr(&quot;faces&quot;, framed ? &quot;nesw&quot; : &quot;&quot;);
+    }
+    
+    FloodStream::~FloodStream() {
+        GameTimer.remove_alarm(this);
+    }
+    
+    std::string FloodStream::getClass() const {
+        switch (getTyp()) { 
+            case WATER : return &quot;fl_water&quot;;
+            case WOOD :  return &quot;fl_wood&quot;;
+            case HAY :   return &quot;fl_hay&quot;;
+            case ROCK :  return &quot;fl_rock&quot;;
+        }   
+    }
+
+    // temporary hack for backward compatibility during reengineering
+    const char * FloodStream::get_kind() const {
+        return (getClass() + ((getAttr(&quot;faces&quot;).to_string() == &quot;nesw&quot;) ? &quot;_framed&quot; : &quot;&quot;)).c_str();
+    }
+        
+    Value FloodStream::message(const Message &amp;m) {
+        if (m.message == &quot;_checkflood&quot;) {
+            if (state == FLOODING)
+                GameTimer.set_alarm(this, (double)getAttr(&quot;interval&quot;), false);
+            return Value();
+        } else
+            return Floor::message(m);
+    }
+
+    void FloodStream::setState(int extState) {
+        if (isDisplayable() &amp;&amp; extState == FLOODING &amp;&amp; state == IDLE) {
+            if (getTyp() == WATER || getAttr(&quot;faces&quot;).to_string() == &quot;nesw&quot;) {
+                state = FLOODING;
+                GameTimer.set_alarm(this, (double)getAttr(&quot;interval&quot;), false);
+            }
+        } else if (extState == IDLE) {
+            state == IDLE;
+            GameTimer.remove_alarm(this);
+        } else
+            state = extState;
+    }
+    
+    void FloodStream::init_model()  {
+        bool isFramed = (getAttr(&quot;faces&quot;).to_string() == &quot;nesw&quot;);
+        if (getTyp() == WOOD) {
+            int modelnr = (objFlags &amp; OBJBIT_MODEL) &gt;&gt; 26;
+            set_model((std::string)get_kind() + ((modelnr == 0 )? &quot;&quot; : ecl::strf(&quot;%d&quot;, modelnr))); 
+        } else {
+            set_model(get_kind());
+        } 
+    }
+    
+    void FloodStream::on_creation(GridPos p) {
+        Floor::on_creation(p);
+        if (state == FLOODING)
+            GameTimer.set_alarm(this, (double)getAttr(&quot;interval&quot;), false);
+    }
+    
+    bool FloodStream::is_destructible() const {
+        return getTyp() != WATER;  // all flood stream floors besides wood can be destroyed
+    }
+
+    void FloodStream::get_sink_speed (double &amp;sink_speed, double &amp;raise_speed) const { 
+        if (getTyp() == WATER) {
+            sink_speed = server::WaterSinkSpeed;
+            raise_speed = 1000; // always sink in water
+        } else
+            return Floor::get_sink_speed (sink_speed, raise_speed);
+    }
+    
+    void FloodStream::stone_change(Stone *st) {
+        if (getTyp() == WATER || getAttr(&quot;faces&quot;).to_string() == &quot;nesw&quot;) {
+            SendMessage(GetFloor(get_pos()), &quot;_checkflood&quot;);
+            for (Direction d = NORTH; d != NODIR; d = previous(d))
+                SendMessage(GetFloor(move(get_pos(), d)), &quot;_checkflood&quot;);
+        } else
+            Floor::stone_change(st);
+    }
+
+    void FloodStream::alarm() {
+        if (isDisplayable()) {
+            Stone *thisstone = GetStone(get_pos());
+            for (Direction d = NORTH; d != NODIR; d = previous(d)) {
+                if (thisstone == NULL || thisstone-&gt;allowsSpreading(d)) {
+                    GridPos p = move(get_pos(), d);
+                    Floor *f = GetFloor(p);
+                    if (f != NULL &amp;&amp; f-&gt;isKind(&quot;fl_floodstream&quot;) &amp;&amp; 
+                            (f-&gt;getAttr(&quot;faces&quot;).to_string() == &quot;nesw&quot; || f-&gt;isKind(&quot;fl_water&quot;))) {
+                        f-&gt;setAttr(&quot;interval&quot;, getAttr(&quot;interval&quot;));
+                        f-&gt;setAttr(&quot;state&quot;, FLOODING);
+                    } else if (f != NULL &amp;&amp; f-&gt;getAttr(&quot;floodable&quot;).to_bool()) {
+                        Stone *st = GetStone(p);
+                        if (st == NULL || st-&gt;allowsSpreading(reverse(d), true)) {
+                            Floor *newfloor = MakeFloor(&quot;fl_water_source&quot;);
+                            newfloor-&gt;setAttr(&quot;interval&quot;, getAttr(&quot;interval&quot;));
+                            SetFloor(p, newfloor);
+                        }
+                    }
+                }
+            }
+        }
+    }
+    
+    FloodStream::FloodStreamTyp FloodStream::getTyp() const {
+        return (FloodStreamTyp)((objFlags &amp; OBJBIT_SUBTYP) &gt;&gt; 24);
+    } 
+    
+    BOOT_REGISTER_START
+        BootRegister(new FloodStream(0, 0, false, flf_indestructible), &quot;fl_water&quot;);
+        BootRegister(new FloodStream(0, 0, false, flf_indestructible, true), &quot;fl_water_source&quot;);
+        BootRegister(new FloodStream(1, 0, false), &quot;fl_wood&quot;);
+        BootRegister(new FloodStream(1, 1, false), &quot;fl_wood_h&quot;);
+        BootRegister(new FloodStream(1, 2, false), &quot;fl_wood_v&quot;);
+        BootRegister(new FloodStream(1, 0, true), &quot;fl_wood_framed&quot;);
+        BootRegister(new FloodStream(1, 1, true), &quot;fl_wood_framed_h&quot;);
+        BootRegister(new FloodStream(1, 2, true), &quot;fl_wood_framed_v&quot;);
+        BootRegister(new FloodStream(2, 0, false), &quot;fl_hay&quot;);
+        BootRegister(new FloodStream(2, 0, true), &quot;fl_hay_framed&quot;);
+        BootRegister(new FloodStream(3, 0, false), &quot;fl_rock&quot;);
+        BootRegister(new FloodStream(3, 0, true), &quot;fl_rock_framed&quot;);
+    BOOT_REGISTER_END
+
+} // namespace enigma


Property changes on: trunk/src/floors/FloodStream.cc
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/floors/FloodStream.hh
===================================================================
--- trunk/src/floors/FloodStream.hh	2008-12-12 22:16:08 UTC (rev 1391)
+++ trunk/src/floors/FloodStream.hh	2008-12-13 14:14:22 UTC (rev 1392)
@@ -0,0 +1,81 @@
+/*
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef FLOODSTREAM_HH
+#define FLOODSTREAM_HH
+
+#include &quot;floors.hh&quot;
+
+namespace enigma {
+
+    /** 
+     * 
+     */
+    class FloodStream : public Floor, public TimeHandler {
+        CLONEOBJ(FloodStream);
+                
+    private:
+        enum iState {
+            IDLE,       ///&lt; 
+            FLOODING    ///&lt; 
+        };
+
+        enum ObjectPrivatFlagsBits {
+            OBJBIT_SUBTYP    =   3&lt;&lt;24,   ///&lt; the FloodStream typ
+            OBJBIT_MODEL     =   3&lt;&lt;26,   ///&lt; the model typ (h/v for wood)
+        };
+        
+        enum FloodStreamTyp {
+            WATER = 0,
+            WOOD,
+            HAY,
+            ROCK
+        };
+    public:
+        FloodStream(int subtyp, int model, bool framed, 
+                FloorFlags flags = flf_default, bool isFloodSource = false);
+        ~FloodStream();
+
+        // Object interface
+        virtual std::string getClass() const;
+        virtual const char *get_kind() const;
+        virtual Value message(const Message &amp;m);
+        
+        // StateObject interface
+        virtual void setState(int extState);
+
+        // GridObject interface
+        virtual void init_model();
+        virtual void on_creation(GridPos p);
+                
+        // Floor interface
+        virtual bool is_destructible() const;
+        virtual void get_sink_speed (double &amp;sinkspeed, double &amp;raisespeed) const;
+        virtual void stone_change(Stone *st);
+
+        // TimeHandler interface
+        virtual void alarm();
+    
+    private:
+        // Private methods.
+        FloodStreamTyp getTyp() const;
+    };
+
+} // namespace enigma
+
+#endif


Property changes on: trunk/src/floors/FloodStream.hh
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/src/floors.cc
===================================================================
--- trunk/src/floors.cc	2008-12-12 22:16:08 UTC (rev 1391)
+++ trunk/src/floors.cc	2008-12-13 14:14:22 UTC (rev 1392)
@@ -33,12 +33,12 @@
 Floor::Floor(const char *kind, double friction_, double mfactor, FloorFlags flags,
              FloorFireType flft, const char *firetransform_, const char *heattransform_)
 : GridObject (kind),
-  traits (kind, friction_, mfactor, flags, flft, firetransform_, heattransform_),
+  traits (kind, flags, flft, firetransform_, heattransform_),
   heating_animation(false),
   fire_countdown(1),
   var_floorforce(),
-  var_mousefactor(mfactor),
-  var_friction(friction_)
+  adhesion(mfactor),
+  friction(friction_)
 {}
 
 Floor::Floor (const FloorTraits &amp;tr)
@@ -48,6 +48,10 @@
   fire_countdown(1)
 {}
 
+const char * Floor::get_kind() const {
+    return traits.name.c_str();
+}
+
 Floor *Floor::clone() {
     return new Floor(*this);
 }
@@ -80,33 +84,39 @@
 
 ecl::V2 Floor::process_mouseforce (Actor *a, ecl::V2 force) {
     if (a-&gt;controlled_by(player::CurrentPlayer()))
-        return get_mousefactor() * force;
+        return getAdhesion() * force;
     else
         return ecl::V2();
 }
 
-void Floor::setAttr(const string&amp; key, const Value &amp;val)
-{
-    if (key == &quot;adhesion&quot;)
-        var_mousefactor = to_double(val);
-    else if (key == &quot;friction&quot;)
-        var_friction = to_double(val);
-    else if (key == &quot;force_x&quot;)
-        var_floorforce[0] = to_double(val);
-    else if (key == &quot;force_y&quot;)
-        var_floorforce[1] = to_double(val);
-    GridObject::setAttr(key, val);
-}
+    void Floor::setAttr(const string&amp; key, const Value &amp;val) {
+        if (key == &quot;adhesion&quot;)
+            adhesion = val;
+        else if (key == &quot;friction&quot;)
+            friction = val;
+        else if (key == &quot;force_x&quot;)
+            var_floorforce[0] = val;
+        else if (key == &quot;force_y&quot;)
+            var_floorforce[1] = val;
+        GridObject::setAttr(key, val);
+    }
 
     Value Floor::getAttr(const std::string &amp;key) const {
         if (key == &quot;adhesion&quot;) {
-            return var_mousefactor;
+            return adhesion;
         } else if (key == &quot;friction&quot;) {
-            return var_friction;
+            return friction;
         }
         return GridObject::getAttr(key);
-
     }
+    
+    void Floor::on_creation(GridPos p) {
+        if (Value v = GridObject::getAttr(&quot;adhesion&quot;))
+            adhesion = v;
+        if (Value v = GridObject::getAttr(&quot;friction&quot;))
+            friction = v;
+        GridObject::on_creation(p);
+    }
 
 void Floor::get_sink_speed (double &amp;sinkspeed, double &amp;raisespeed) const {
 //     sinkspeed = raisespeed = 0.0;
@@ -114,13 +124,12 @@
 
 double Floor::get_friction() const 
 { 
-    return var_friction; 
+    return friction; 
 }
 
-double Floor::get_mousefactor() const 
-{ 
-    return var_mousefactor; 
-}
+    double Floor::getAdhesion() const { 
+        return adhesion; 
+    }
 
 bool Floor::is_destructible() const 
 {
@@ -153,6 +162,15 @@
     f += var_floorforce;
 }
 
+    void Floor::stone_change(Stone *st) {
+        if (getDefaultedAttr(&quot;floodable&quot;, false).to_bool()) {
+            SendMessage(GetFloor(get_pos()), &quot;_checkflood&quot;);
+            for (Direction d = NORTH; d != NODIR; d = previous(d))
+                SendMessage(GetFloor(move(get_pos(), d)), &quot;_checkflood&quot;);
+        }
+    }
+
+
 /* -------------- Fire Handling -------------- */
 
 /*  The fire system is a confusing tangle of bools and flags.
@@ -193,31 +211,33 @@
  *  Have I forgotten something?
  */
 
-string Floor::get_firetransform() {
-    if(server::GameCompatibility == GAMET_ENIGMA)
-        return traits.firetransform;
-    // In non-Enigma-compatibility-modes, only fl-wood and fl-stwood
-    // transform. Note: This might have been a bug, as fl-stwood1/2
-    // and fl-wood1/2 were not included (at least fl-wood1/2 were of
-    // a newer date). However, we include them here.
-    string model = this-&gt;get_kind();
-    if (   model == &quot;fl-wood&quot;   || model == &quot;fl-wood1&quot;   || model == &quot;fl-wood2&quot;
-        || model == &quot;fl-stwood&quot; || model == &quot;fl-stwood1&quot; || model == &quot;fl-stwood2&quot;)
-        return &quot;fl_abyss&quot;;
-    else
-        return &quot;&quot;;
+std::string Floor::get_firetransform() {
+    if (server::GameCompatibility == GAMET_ENIGMA) {
+        std::string classname = getAttr(&quot;$firetransform&quot;).to_string();
+        return (classname.length() &gt; 0) ? classname : traits.firetransform;
+    } else {
+        // In non-Enigma-compatibility-modes, only fl-wood and fl-stwood
+        // transform. Note: This might have been a bug, as fl-stwood1/2
+        // and fl-wood1/2 were not included (at least fl-wood1/2 were of
+        // a newer date). However, we include them here.
+        return isKind(&quot;fl_wood&quot;) ? &quot;fl_abyss&quot; : &quot;&quot;;
+    }
 }
-string Floor::get_heattransform(bool override_mode) {
+
+std::string Floor::get_heattransform(bool override_mode) {
     // The bool is needed to correctly exit the heating-animation
     // in case the level switched to non-Enigma-mode in between.
-    if(server::GameCompatibility == GAMET_ENIGMA || override_mode)
-        return traits.heattransform;
-    // In non-Enigma-compatibility-modes, there is no heat-transformation.
-    return &quot;&quot;;
+    if (server::GameCompatibility == GAMET_ENIGMA || override_mode) {
+        std::string classname = getAttr(&quot;$heattransform&quot;).to_string();
+        return (classname.length() &gt; 0) ? classname : traits.heattransform;
+    } else {
+        // In non-Enigma-compatibility-modes, there is no heat-transformation.
+        return &quot;&quot;;
+    }
 }
 int Floor::get_fire_countdown() {
-    if(Item *it = GetItem(get_pos()))
-        if(get_id(it) == it_burnable || get_id(it) == it_burnable_oil)
+    if (Item *it = GetItem(get_pos()))
+        if (get_id(it) == it_burnable || get_id(it) == it_burnable_oil)
             return 0;
     return fire_countdown;
 }
@@ -232,7 +252,7 @@
     GridPos p = get_pos();
 
     // Don't disturb heating-transformation
-    if(heating_animation)
+    if (heating_animation)
         return false;
 
     // No or floating stone -&gt; Burn items and replicate.
@@ -248,23 +268,23 @@
             return false;
     }
 
-    if(server::GameCompatibility == GAMET_ENIGMA) {
-        if(has_firetype(flft_burnable)) {
+    if (server::GameCompatibility == GAMET_ENIGMA) {
+        if (has_firetype(flft_burnable)) {
             // has_firetype also checks whether floor is already burning or ignited
             // (via it-burnables), but not which stone is above it.
-            if(Item *it = GetItem(p)) {
+            if (Item *it = GetItem(p)) {
                 // The item didn't respond to the &quot;heat&quot;-message, so we
                 // could assume it's burnable. However, as there might also
                 // be a &quot;setfire&quot;-message from the user or a lazy &quot;message&quot;-
                 // implementation, we still have to check the burnable-flag
                 // of this item:
-                if(!has_flags(it, itf_fireproof))
+                if (!has_flags(it, itf_fireproof))
                     return force_fire();
             } else {
                 // Just spread. Use the fire-countdown to delay fire without
                 // it-burnable, but not in case of a message or a secure+last
                 // call or a fastfire-floor.
-                if(    (get_fire_countdown() == 0) || (flhf == flhf_message)
+                if (   (get_fire_countdown() == 0) || (flhf == flhf_message)
                     || (has_firetype(flft_fastfire))
                     || (((bool) (flhf &amp; flhf_last)) &amp;&amp; has_firetype(flft_secure)))
                     return force_fire();            
@@ -272,7 +292,7 @@
             }        
         }
     } else {  // non-Enigma-mode
-        if(has_firetype(flft_burnable) || flhf == flhf_message) {
+        if (has_firetype(flft_burnable) || flhf == flhf_message) {
             // We only get here when there is a burnable item or the
             // burnable attribute is set (e.g. as part of replication).
             // A fireproof item doesn't allow to get here. (Note: We
@@ -282,11 +302,11 @@
             // This floor doesn't burn by default or by item. But, in
             // non-Enigma-compatibility-mode it should, when its neighbor
             // is of the same kind and burns also.
-            if(Floor *fl = GetFloor(move(p, sourcedir))) {
+            if (Floor *fl = GetFloor(move(p, sourcedir))) {
                 string sourcekind = fl-&gt;get_kind();
                 string mykind = this-&gt;get_kind();
-                if(no_closing_stone &amp;&amp; sourcekind == mykind)
-                    if(has_firetype(flft_fastfire))
+                if (no_closing_stone &amp;&amp; sourcekind == mykind)
+                    if (has_firetype(flft_fastfire))
                         return force_fire();
                     else
                         this-&gt;setAttr(&quot;burnable&quot;, true);
@@ -321,9 +341,9 @@
     bool doIgnite = doItem;
     bool reaction_happened = false;
     // Heat item -&gt; destroy cracks, ignite bombs...
-    if(doItem)
-        if(Item *it = GetItem(get_pos()))
-            if(to_int(SendMessage(it, &quot;heat&quot;, Value(sourcedir))) != 0.0)
+    if (doItem)
+        if (Item *it = GetItem(get_pos()))
+            if (to_int(SendMessage(it, &quot;heat&quot;, Value(sourcedir))) != 0.0)
                 reaction_happened = true;        
     // Maybe also transform floor?
     reaction_happened = on_heattransform(sourcedir, flhf) || reaction_happened;
@@ -335,7 +355,7 @@
     // Not item nor floor nor stone reacted? Then try to ignite the floor!
     // (Note: try_ignite also tests for the heating animation:
     //        No fire during transformation allowed!)
-    if(doIgnite &amp;&amp; !reaction_happened)
+    if (doIgnite &amp;&amp; !reaction_happened)
         return this-&gt;try_ignite(sourcedir, flhf);
     // Else: return reaction_happened from item or heat-transform
     return reaction_happened;
@@ -344,9 +364,9 @@
 bool Floor::on_heattransform(Direction sourcedir, FloorHeatFlags flhf) {
     // return true to forbid fire (message caught)
     bool doHeatTransform = (flhf == flhf_message) || ((bool) (flhf &amp; flhf_first));
-    if(!doHeatTransform || get_heattransform(false) == &quot;&quot;)
+    if (!doHeatTransform || get_heattransform(false) == &quot;&quot;)
         return false;
-    if(doHeatTransform &amp;&amp; get_heattransform(false) != &quot;&quot; &amp;&amp; !heating_animation) {
+    if (doHeatTransform &amp;&amp; get_heattransform(false) != &quot;&quot; &amp;&amp; !heating_animation) {
         set_anim(((string) this-&gt;get_kind()) + &quot;_heating&quot;);
         heating_animation = true;
     }
@@ -354,7 +374,7 @@
 }
 
 void Floor::heat_neighbor(Direction dir, FloorHeatFlags flhf) {
-    if(Floor *fl = GetFloor(move(get_pos(), dir))) {
+    if (Floor *fl = GetFloor(move(get_pos(), dir))) {
         fl-&gt;try_heating(reverse(dir), flhf);
     }
 }
@@ -369,20 +389,20 @@
 
     // is_message indicates use of the stopfire-message,
     // so we have to check if there is fire at all.
-    if(is_message)
-        if(Item *it = GetItem(p)) {
+    if (is_message)
+        if (Item *it = GetItem(p)) {
             ItemID id = get_id(it);
-            if(id != it_burnable_burning &amp;&amp; id != it_burnable_ignited)
+            if (id != it_burnable_burning &amp;&amp; id != it_burnable_ignited)
                 return false;  // no fire
         } else
             return false; // no item == no fire
 
     KillItem(p);
     fire_countdown = 1;
-    if(!is_message &amp;&amp; get_firetransform() != &quot;&quot;)
+    if (!is_message &amp;&amp; get_firetransform() != &quot;&quot;)
         SetFloor(p, MakeFloor(get_firetransform().c_str()));
     // Remember, at this point &quot;this&quot; may be destroyed.
-    if(!GetFloor(p)-&gt;has_firetype(flft_noash))
+    if (!GetFloor(p)-&gt;has_firetype(flft_noash))
         SetItem(p, MakeItem(&quot;it-burnable_ash&quot;));
     return true; // fire extinguished  
 }
@@ -407,7 +427,7 @@
     if (st == NULL || st-&gt;allowsSpreading(WEST))
         heat_neighbor(WEST,  flhf);
 
-    if(cont_fire)
+    if (cont_fire)
         // continue burning
         //   -&gt; put animation
         SetItem(p, MakeItem(&quot;it-burnable_burning&quot;));
@@ -416,17 +436,17 @@
 }
 
 bool Floor::has_firetype(FloorFireType selector) {
-    if(Item *it = GetItem(get_pos())) {
+    if (Item *it = GetItem(get_pos())) {
         ItemID id = get_id(it);
-        if(selector == flft_burnable || selector == flft_ignitable) {
-            if(   id == it_burnable || id == it_burnable_oil )
+        if (selector == flft_burnable || selector == flft_ignitable) {
+            if (  id == it_burnable || id == it_burnable_oil )
                 return true;
-            if(   id == it_burnable_ash     || id == it_burnable_fireproof
+            if (  id == it_burnable_ash     || id == it_burnable_fireproof
                || id == it_burnable_ignited || id == it_burnable_burning )
                 return false;
             // In non-Enigma-compatibility-modes, the item decides about
             // burnability and only it_burnable[_oil] is ignitable:
-            if(server::GameCompatibility != GAMET_ENIGMA)
+            if (server::GameCompatibility != GAMET_ENIGMA)
                 return (selector == flft_burnable) &amp;&amp; !has_flags(it, itf_fireproof);
         }
     }
@@ -454,10 +474,10 @@
 
 void Floor::animcb() {
     // Probably the heating-animation ended.
-    if(heating_animation) {
-        if(this-&gt;get_heattransform(true) != &quot;&quot;)
-            SetFloor(get_pos(), MakeFloor(get_heattransform(true).c_str()));
+    if (heating_animation) {
         heating_animation = false;
+        if (this-&gt;get_heattransform(true) != &quot;&quot;)
+            SetFloor(get_pos(), MakeFloor(get_heattransform(true).c_str()));
     }
 }
 
@@ -486,29 +506,8 @@
         Ice() : Floor (&quot;fl_ice&quot;, 0.1, 0.1, flf_default, flft_default, &quot;&quot;,
             &quot;fl_water&quot;) { }
 
-        virtual double get_friction() const {
-            return 0.1 * server::IceFriction;
-        }
     };
 
-/* -------------------- Water -------------------- */
-
-    class Water : public Floor {
-        CLONEOBJ(Water);
-    public:
-        Water() : Floor(&quot;fl_water&quot;, 5, 1, flf_indestructible, flft_default, &quot;&quot;,
-            &quot;fl_swamp&quot;) {}
-    private:
-
-        bool is_destructible() const {return false;}
-
-        void get_sink_speed (double &amp;sink_speed, double &amp;raise_speed) const { 
-            sink_speed = server::WaterSinkSpeed;
-            raise_speed = 1000; // always sink in water
-        }
-
-    };
-
 /* -------------------- Swamp -------------------- */
 
     class Swamp : public Floor {
@@ -558,7 +557,6 @@
     };
 }
 
-
 /* -------------------- Gradient -------------------- */
 
 /** \page fl-gradient Gradient Floor
@@ -806,7 +804,7 @@
 
         ecl::V2 process_mouseforce (Actor *, ecl::V2 force) {
             if (player::CurrentPlayer() == 0)
-                return get_mousefactor() * force;
+                return getAdhesion() * force;
             else
                 return ecl::V2();
         }
@@ -819,7 +817,7 @@
 
         ecl::V2 process_mouseforce (Actor *, ecl::V2 force) {
             if (player::CurrentPlayer() == 1)
-                return get_mousefactor() * force;
+                return getAdhesion() * force;
             else
                 return ecl::V2();
         }
@@ -832,7 +830,6 @@
     // Floors (most floors are defined in init.lua)
     Register(new Abyss);
     Register(new Ice);
-    Register(new Water);
     Register(new Swamp);
     Register(new DummyFloor);
     Register(new Thief);

Modified: trunk/src/floors.hh
===================================================================
--- trunk/src/floors.hh	2008-12-12 22:16:08 UTC (rev 1391)
+++ trunk/src/floors.hh	2008-12-13 14:14:22 UTC (rev 1392)
@@ -59,19 +59,15 @@
     struct FloorTraits {
         // Variables
         string         name;
-        double         friction;
-        double         mousefactor;
         FloorFlags     flags;
         FloorFireType  firetype;
         string         firetransform;  // fire on the same tile
         string         heattransform;  // fire on neighboring tile
 
         // Constructor
-        FloorTraits (const char *n, double f, double m,
-                     FloorFlags flags_, FloorFireType flft = flft_default,
+        FloorTraits (const char *n, FloorFlags flags_, FloorFireType flft = flft_default,
                      const char *ft = &quot;&quot;, const char *ht = &quot;&quot;)
-            : name(n), friction(f), mousefactor(m),
-              flags(flags_), firetype(flft), firetransform(ft), heattransform(ht)
+            : name(n), flags(flags_), firetype(flft), firetransform(ft), heattransform(ht)
         {}
     };
 
@@ -87,11 +83,12 @@
     class Floor : public GridObject {
     public:
         Floor (const FloorTraits &amp;tr);
-        Floor (const char *kind, double friction_, double mfactor,
+        Floor (const char *kind, double friction_ = 0.0, double adhesion = 0.0,
                FloorFlags flags = flf_default, FloorFireType flft = flft_default,
                const char *firetransform_ = &quot;&quot;, const char *heattransform_ = &quot;&quot;);
 
         // Object interface
+        virtual const char *get_kind() const;
         Floor *clone();
         void dispose();
         virtual Value message(const Message &amp;m);
@@ -105,11 +102,11 @@
         virtual void on_drop (Item *) {}
         virtual void on_pickup (Item *) {}
 
-        virtual void stone_change(Stone *) {}
+        virtual void stone_change(Stone *);
         virtual void actor_contact(Actor *) {}
 
         virtual double get_friction() const;
-        virtual double get_mousefactor() const;
+        virtual double getAdhesion() const;
 
         virtual void get_sink_speed (double &amp;sinkspeed, double &amp;raisespeed) const;
         virtual bool is_destructible() const;
@@ -122,9 +119,11 @@
          virtual Object::ObjectType getObjectType() const {return Object::FLOOR;}
         
         // GridObject interface
-        void set_model (const std::string &amp;mname);
-        display::Model *get_model ();
-        void kill_model (GridPos p);
+        virtual void on_creation(GridPos p);
+        virtual void set_model (const std::string &amp;mname);
+        virtual display::Model *get_model();
+        virtual void kill_model(GridPos p);
+        
         // Fire interface
         virtual bool has_firetype(FloorFireType selector);
         virtual string get_firetransform();
@@ -145,8 +144,8 @@
         FloorTraits traits;
         bool heating_animation;
         int fire_countdown;  // used to delay ignition, default is 1.
-        double var_friction;
-        double var_mousefactor;
+        double friction;
+        double adhesion;
         ecl::V2 var_floorforce;
     };
 

Modified: trunk/src/lua-display.cc
===================================================================
--- trunk/src/lua-display.cc	2008-12-12 22:16:08 UTC (rev 1391)
+++ trunk/src/lua-display.cc	2008-12-13 14:14:22 UTC (rev 1392)
@@ -1,6 +1,6 @@
 /*
 ** Lua binding: display
-** Generated automatically by tolua++-1.0.92 on Fri Apr 18 01:20:21 2008.
+** Generated automatically by tolua++-1.0.92 on Mon Dec  8 13:32:36 2008.
 */
 
 #ifndef __cplusplus

Modified: trunk/src/lua-display.hh
===================================================================
--- trunk/src/lua-display.hh	2008-12-12 22:16:08 UTC (rev 1391)
+++ trunk/src/lua-display.hh	2008-12-13 14:14:22 UTC (rev 1392)
@@ -1,6 +1,6 @@
 /*
 ** Lua binding: display
-** Generated automatically by tolua++-1.0.92 on Fri Apr 18 01:20:21 2008.
+** Generated automatically by tolua++-1.0.92 on Mon Dec  8 13:32:36 2008.
 */
 
 /* Exported function */

Modified: trunk/src/lua-ecl.cc
===================================================================
--- trunk/src/lua-ecl.cc	2008-12-12 22:16:08 UTC (rev 1391)
+++ trunk/src/lua-ecl.cc	2008-12-13 14:14:22 UTC (rev 1392)
@@ -1,6 +1,6 @@
 /*
 ** Lua binding: px
-** Generated automatically by tolua++-1.0.92 on Fri Apr 18 01:20:21 2008.
+** Generated automatically by tolua++-1.0.92 on Mon Dec  8 13:32:36 2008.
 */
 
 #ifndef __cplusplus

Modified: trunk/src/lua-ecl.hh
===================================================================
--- trunk/src/lua-ecl.hh	2008-12-12 22:16:08 UTC (rev 1391)
+++ trunk/src/lua-ecl.hh	2008-12-13 14:14:22 UTC (rev 1392)
@@ -1,6 +1,6 @@
 /*
 ** Lua binding: px
-** Generated automatically by tolua++-1.0.92 on Fri Apr 18 01:20:21 2008.
+** Generated automatically by tolua++-1.0.92 on Mon Dec  8 13:32:36 2008.
 */
 
 /* Exported function */

Modified: trunk/src/lua-editor.cc
===================================================================
--- trunk/src/lua-editor.cc	2008-12-12 22:16:08 UTC (rev 1391)
+++ trunk/src/lua-editor.cc	2008-12-13 14:14:22 UTC (rev 1392)
@@ -1,6 +1,6 @@
 /*
 ** Lua binding: editor
-** Generated automatically by tolua++-1.0.92 on Fri Apr 18 01:20:21 2008.
+** Generated automatically by tolua++-1.0.92 on Mon Dec  8 13:32:36 2008.
 */
 
 #ifndef __cplusplus

Modified: trunk/src/lua-editor.hh
===================================================================
--- trunk/src/lua-editor.hh	2008-12-12 22:16:08 UTC (rev 1391)
+++ trunk/src/lua-editor.hh	2008-12-13 14:14:22 UTC (rev 1392)
@@ -1,6 +1,6 @@
 /*
 ** Lua binding: editor
-** Generated automatically by tolua++-1.0.92 on Fri Apr 18 01:20:21 2008.
+** Generated automatically by tolua++-1.0.92 on Mon Dec  8 13:32:36 2008.
 */
 
 /* Exported function */

Modified: trunk/src/lua-enigma.cc
===================================================================
--- trunk/src/lua-enigma.cc	2008-12-12 22:16:08 UTC (rev 1391)
+++ trunk/src/lua-enigma.cc	2008-12-13 14:14:22 UTC (rev 1392)
@@ -1,6 +1,6 @@
 /*
 ** Lua binding: enigma
-** Generated automatically by tolua++-1.0.92 on Fri Apr 18 01:20:21 2008.
+** Generated automatically by tolua++-1.0.92 on Mon Dec  8 13:32:36 2008.
 */
 
 #ifndef __cplusplus
@@ -429,30 +429,6 @@
 }
 #endif //#ifndef TOLUA_DISABLE
 
-/* get function: IceFriction */
-#ifndef TOLUA_DISABLE_tolua_get_enigma_IceFriction
-static int tolua_get_enigma_IceFriction(lua_State* tolua_S)
-{
-  tolua_pushnumber(tolua_S,(lua_Number)IceFriction);
- return 1;
-}
-#endif //#ifndef TOLUA_DISABLE
-
-/* set function: IceFriction */
-#ifndef TOLUA_DISABLE_tolua_set_enigma_IceFriction
-static int tolua_set_enigma_IceFriction(lua_State* tolua_S)
-{
-#ifndef TOLUA_RELEASE
-  tolua_Error tolua_err;
-  if (!tolua_isnumber(tolua_S,2,0,&amp;tolua_err))
-   tolua_error(tolua_S,&quot;#vinvalid type in variable assignment.&quot;,&amp;tolua_err);
-#endif
-  IceFriction = ((double)  tolua_tonumber(tolua_S,2,0))
-;
- return 0;
-}
-#endif //#ifndef TOLUA_DISABLE
-
 /* get function: ElectricForce */
 #ifndef TOLUA_DISABLE_tolua_get_enigma_ElectricForce
 static int tolua_get_enigma_ElectricForce(lua_State* tolua_S)
@@ -1247,7 +1223,6 @@
    tolua_variable(tolua_S,&quot;SlopeForce&quot;,tolua_get_enigma_SlopeForce,tolua_set_enigma_SlopeForce);
    tolua_variable(tolua_S,&quot;FlatForce&quot;,tolua_get_enigma_FlatForce,tolua_set_enigma_FlatForce);
    tolua_variable(tolua_S,&quot;FrictionFactor&quot;,tolua_get_enigma_FrictionFactor,tolua_set_enigma_FrictionFactor);
-   tolua_variable(tolua_S,&quot;IceFriction&quot;,tolua_get_enigma_IceFriction,tolua_set_enigma_IceFriction);
    tolua_variable(tolua_S,&quot;ElectricForce&quot;,tolua_get_enigma_ElectricForce,tolua_set_enigma_ElectricForce);
    tolua_variable(tolua_S,&quot;BumperForce&quot;,tolua_get_enigma_BumperForce,tolua_set_enigma_BumperForce);
    tolua_variable(tolua_S,&quot;MagnetForce&quot;,tolua_get_enigma_MagnetForce,tolua_set_enigma_MagnetForce);

Modified: trunk/src/lua-enigma.hh
===================================================================
--- trunk/src/lua-enigma.hh	2008-12-12 22:16:08 UTC (rev 1391)
+++ trunk/src/lua-enigma.hh	2008-12-13 14:14:22 UTC (rev 1392)
@@ -1,6 +1,6 @@
 /*
 ** Lua binding: enigma
-** Generated automatically by tolua++-1.0.92 on Fri Apr 18 01:20:21 2008.
+** Generated automatically by tolua++-1.0.92 on Mon Dec  8 13:32:36 2008.
 */
 
 /* Exported function */

Modified: trunk/src/lua-global.cc
===================================================================
--- trunk/src/lua-global.cc	2008-12-12 22:16:08 UTC (rev 1391)
+++ trunk/src/lua-global.cc	2008-12-13 14:14:22 UTC (rev 1392)
@@ -1,6 +1,6 @@
 /*
 ** Lua binding: global
-** Generated automatically by tolua++-1.0.92 on Fri Apr 18 01:20:21 2008.
+** Generated automatically by tolua++-1.0.92 on Mon Dec  8 13:32:36 2008.
 */
 
 #ifndef __cplusplus

Modified: trunk/src/lua-global.hh
===================================================================
--- trunk/src/lua-global.hh	2008-12-12 22:16:08 UTC (rev 1391)
+++ trunk/src/lua-global.hh	2008-12-13 14:14:22 UTC (rev 1392)
@@ -1,6 +1,6 @@
 /*
 ** Lua binding: global
-** Generated automatically by tolua++-1.0.92 on Fri Apr 18 01:20:21 2008.
+** Generated automatically by tolua++-1.0.92 on Mon Dec  8 13:32:36 2008.
 */
 
 /* Exported function */

Modified: trunk/src/ox_extra.cc
===================================================================
--- trunk/src/ox_extra.cc	2008-12-12 22:16:08 UTC (rev 1391)
+++ trunk/src/ox_extra.cc	2008-12-13 14:14:22 UTC (rev 1392)
@@ -106,7 +106,7 @@
     UNUSED,              // OxydExtra floor 0x45
     UNUSED,              // OxydExtra floor 0x46
     &quot;fl-bumps&quot;,          // OxydExtra floor 0x47
-    &quot;fl-rock&quot;,           // OxydExtra floor 0x48
+    &quot;fl_rock&quot;,           // OxydExtra floor 0x48
     UNUSED,              // OxydExtra floor 0x49
     UNUSED,              // OxydExtra floor 0x4a
     UNUSED,              // OxydExtra floor 0x4b

Modified: trunk/src/ox_magnum.cc
===================================================================
--- trunk/src/ox_magnum.cc	2008-12-12 22:16:08 UTC (rev 1391)
+++ trunk/src/ox_magnum.cc	2008-12-13 14:14:22 UTC (rev 1392)
@@ -94,13 +94,13 @@
     UNUSED,                     // OxydMagnum floor 0x39
     UNUSED,                     // OxydMagnum floor 0x3a
     UNUSED,                     // OxydMagnum floor 0x3b
-    &quot;fl-rock&quot;,                  // OxydMagnum floor 0x3c
+    &quot;fl_rock&quot;,                  // OxydMagnum floor 0x3c
     UNUSED,                     // OxydMagnum floor 0x3d
     UNUSED,                     // OxydMagnum floor 0x3e
     0,                          // OxydMagnum floor 0x3f (Level 121 ?)(in normal Oxyd Magnum Levels unused!)
-    &quot;fl-stwood1&quot;,               // OxydMagnum floor 0x40
-    &quot;fl-wood&quot;,                  // OxydMagnum floor 0x41
-    &quot;fl-wood1&quot;,                 // OxydMagnum floor 0x42
+    &quot;fl-wood_framed_h&quot;,         // OxydMagnum floor 0x40
+    &quot;fl_wood&quot;,                  // OxydMagnum floor 0x41
+    &quot;fl_wood_h&quot;,                // OxydMagnum floor 0x42
     UNUSED,                     // OxydMagnum floor 0x43
     UNUSED,                     // OxydMagnum floor 0x44
     UNUSED,                     // OxydMagnum floor 0x45

Modified: trunk/src/ox_oxyd1.cc
===================================================================
--- trunk/src/ox_oxyd1.cc	2008-12-12 22:16:08 UTC (rev 1391)
+++ trunk/src/ox_oxyd1.cc	2008-12-13 14:14:22 UTC (rev 1392)
@@ -127,12 +127,12 @@
     UNUSED,                     // Oxyd1 floor 0x39
     UNUSED,                     // Oxyd1 floor 0x3a
     UNUSED,                     // Oxyd1 floor 0x3b
-    &quot;fl-rock&quot;,                  // Oxyd1 floor 0x3c
+    &quot;fl_rock&quot;,                  // Oxyd1 floor 0x3c
     UNUSED,                     // Oxyd1 floor 0x3d
     UNUSED,                     // Oxyd1 floor 0x3e
     UNUSED,                     // Oxyd1 floor 0x3f
-    &quot;fl-stwood1&quot;,               // Oxyd1 floor 0x40
-    &quot;fl-wood&quot;,                  // Oxyd1 floor 0x41
+    &quot;fl_wood_framed_h&quot;,         // Oxyd1 floor 0x40
+    &quot;fl_wood&quot;,                  // Oxyd1 floor 0x41
     &quot;fl-samba1&quot;,                // Oxyd1 floor 0x42
     UNUSED,                     // Oxyd1 floor 0x43
     UNUSED,                     // Oxyd1 floor 0x44

Modified: trunk/src/ox_peroxyd.cc
===================================================================
--- trunk/src/ox_peroxyd.cc	2008-12-12 22:16:08 UTC (rev 1391)
+++ trunk/src/ox_peroxyd.cc	2008-12-13 14:14:22 UTC (rev 1392)
@@ -163,7 +163,7 @@
     &quot;fl-concrete&quot;,              // PerOxyd floor 0x39 (Tan/green horizontal Grain, same as 0x38)(only level 118)
     UNUSED,                     // PerOxyd floor 0x3a
     UNUSED,                     // PerOxyd floor 0x3b
-    &quot;fl-stwood1&quot;,               // PerOxyd floor 0x3c
+    &quot;fl_wood_framed_h&quot;,         // PerOxyd floor 0x3c
     &quot;fl-samba&quot;,                 // PerOxyd floor 0x3d (common was 'fl-wood', horizontal or vertical slats)(many)
     &quot;fl-samba1&quot;,                // PerOxyd floor 0x3e (common was 'fl-wood', horizontal slats)(only level 32)
     &quot;fl-samba2&quot;,                // PerOxyd floor 0x3f (common was 'fl-wood', vertical slats)(levels: 35, 152)

Modified: trunk/src/server.cc
===================================================================
--- trunk/src/server.cc	2008-12-12 22:16:08 UTC (rev 1391)
+++ trunk/src/server.cc	2008-12-13 14:14:22 UTC (rev 1392)
@@ -108,7 +108,6 @@
 int      server::GlassesVisibility;         // no Lua access
 int      server::ExtralifeGlasses;
 double   server::HoleForce;
-double   server::IceFriction;
 lev::levelStatusType   server::LevelStatus; // no Lua access
 double   server::MagnetForce;
 double   server::MagnetRange;
@@ -266,7 +265,6 @@
     server::FrictionFactor    = 1.0;
     server::GlassesVisibility = 0;     // nothing
     server::ExtralifeGlasses  = 19;  // death + hollow + lightpassenger
-    server::IceFriction       = 1.0;
     server::ElectricForce     = 15.0;
     server::BumperForce       = 200.0;
     server::WaterSinkSpeed    = 1000;

Modified: trunk/src/server.hh
===================================================================
--- trunk/src/server.hh	2008-12-12 22:16:08 UTC (rev 1391)
+++ trunk/src/server.hh	2008-12-13 14:14:22 UTC (rev 1392)
@@ -114,15 +114,12 @@
     // ...for floor tiles that look sloped
     extern double   SlopeForce;
 
-    // ...for floor tiles that DON'T look sloped
+    // depreceated - vertical factor for space floor tiles - used in oxyd emulation only 
     extern double   FlatForce;
 
     // ...for friction on certain floor types
     extern double   FrictionFactor;
 
-    // ...for friction on ice
-    extern double   IceFriction;
-
     // ...for electrostatic forces between actors (default: 15)
     extern double   ElectricForce;
 

Modified: trunk/src/stones/Door.cc
===================================================================
--- trunk/src/stones/Door.cc	2008-12-12 22:16:08 UTC (rev 1391)
+++ trunk/src/stones/Door.cc	2008-12-13 14:14:22 UTC (rev 1392)
@@ -106,7 +106,7 @@
         }
     }
     
-    bool Door::allowsSpreading(Direction dir) const {
+    bool Door::allowsSpreading(Direction dir, bool isFlood) const {
         return state != CLOSED || !has_dir(getFaces(), dir);
     }
     
@@ -161,6 +161,9 @@
                 case OPEN:
                     set_model(basename+&quot;-open&quot;);
                     MaybeRecalcLight(get_pos());
+                    SendMessage(GetFloor(get_pos()), &quot;_checkflood&quot;);
+                    for (Direction d = NORTH; d != NODIR; d = previous(d))
+                        SendMessage(GetFloor(move(get_pos(), d)), &quot;_checkflood&quot;);
                     break;
                 case CLOSED:
                     set_model(basename+&quot;-closed&quot;);

Modified: trunk/src/stones/Door.hh
===================================================================
--- trunk/src/stones/Door.hh	2008-12-12 22:16:08 UTC (rev 1391)
+++ trunk/src/stones/Door.hh	2008-12-13 14:14:22 UTC (rev 1392)
@@ -63,7 +63,7 @@
         // Stone interface
         virtual bool is_floating() const;
         virtual bool is_transparent(Direction d) const;
-        virtual bool allowsSpreading(Direction dir) const;
+        virtual bool allowsSpreading(Direction dir, bool isFlood = false) const;
         virtual StoneResponse collision_response(const StoneContact &amp;sc);
         virtual void actor_hit(const StoneContact &amp;sc);
         virtual const char *collision_sound();

Modified: trunk/src/stones/FloorBuilder.cc
===================================================================
--- trunk/src/stones/FloorBuilder.cc	2008-12-12 22:16:08 UTC (rev 1391)
+++ trunk/src/stones/FloorBuilder.cc	2008-12-13 14:14:22 UTC (rev 1392)
@@ -123,6 +123,10 @@
         maybe_fall_or_stopfire(); // instantly builds a bridge on fl_swamp etc
     }
 
+    bool FloorBuilder::allowsSpreading(Direction dir, bool isFlood) const {
+        return isFlood;
+    }
+    
     void FloorBuilder::actor_hit(const StoneContact &amp;sc) {
         if (state == GROWING)
             SendMessage(sc.actor, &quot;shatter&quot;);
@@ -156,19 +160,23 @@
         GridPos p = get_pos();
         if (server::GameCompatibility != GAMET_ENIGMA &amp;&amp; IsLevelBorder(p))
             return;
-        if (Floor *fl = GetFloor(p)) {
-            const std::string &amp;k = fl-&gt;get_kind();
+        if (Floor *oldfl = GetFloor(p)) {
+            const std::string &amp;k = oldfl-&gt;get_kind();
             if (objFlags &amp; OBJBIT_BLOCKFIRE)
-                SendMessage(fl, &quot;stopfire&quot;);
+                SendMessage(oldfl, &quot;stopfire&quot;);
             if (k == &quot;fl_abyss&quot; || k == &quot;fl_water&quot; || k == &quot;fl_swamp&quot;) {
                 if (onMove)
                     // just mark - can not kill stone yet - this will be done on floor change event
                     state = FALLING;  // keep the stone from moving any longer
                 else if ((server::GameCompatibility != GAMET_OXYD1) || state == FALLING || !onFloorChange) {
                     state = FALLEN;
-                    Floor *fl = MakeFloor((typ == HAY) ? &quot;fl-hay&quot; : ((typ == ROCK) ? &quot;fl-rock&quot; : ((typ == WOOD1) ? &quot;fl-stwood1&quot; : &quot;fl-stwood2&quot;)));
-                    transferIdentity(fl);
-                    SetFloor(p, fl); 
+                    Floor *newfl = MakeFloor((typ == HAY) ? &quot;fl_hay_framed&quot; : ((typ == ROCK) ? &quot;fl_rock_framed&quot; : ((typ == WOOD1) ? &quot;fl_wood_framed_h&quot; : &quot;fl_wood_framed_v&quot;)));
+                    transferIdentity(newfl);
+                    if (k == &quot;fl_water&quot;) {
+                        newfl-&gt;setAttr(&quot;interval&quot;, oldfl-&gt;getAttr(&quot;interval&quot;));
+                        newfl-&gt;setAttr(&quot;state&quot;, oldfl-&gt;getAttr(&quot;state&quot;));
+                    }
+                    SetFloor(p, newfl); 
                     KillStone(p);
                 }
             }

Modified: trunk/src/stones/FloorBuilder.hh
===================================================================
--- trunk/src/stones/FloorBuilder.hh	2008-12-12 22:16:08 UTC (rev 1391)
+++ trunk/src/stones/FloorBuilder.hh	2008-12-13 14:14:22 UTC (rev 1392)
@@ -39,7 +39,6 @@
             FALLEN      ///&lt; a stone that is fallen on floor change notification and is vanishing
         };
         
-    private:
         enum ObjectPrivatFlagsBits {
             OBJBIT_BLOCKFIRE =   1&lt;&lt;24,   ///&lt; stone blocks fire on moves and floor changes beneath
             OBJBIT_SUBTYP    =   7&lt;&lt;25,   ///&lt; the FloorBuilderTyp
@@ -72,6 +71,7 @@
         virtual void animcb();
         
         // Stone interface
+        virtual bool allowsSpreading(Direction dir, bool isFlood = false) const;
         virtual void actor_hit(const StoneContact &amp;sc);
         virtual void actor_inside(Actor *a);
         virtual void actor_contact(Actor *a);

Modified: trunk/src/stones/WindowStone.cc
===================================================================
--- trunk/src/stones/WindowStone.cc	2008-12-12 22:16:08 UTC (rev 1391)
+++ trunk/src/stones/WindowStone.cc	2008-12-13 14:14:22 UTC (rev 1392)
@@ -129,6 +129,7 @@
     }
 
     void WindowStone::animcb() {
+        postFaceChange();
         if (state == FINALBREAK)
             KillStone(get_pos());
         else {
@@ -137,7 +138,7 @@
         }
     }
     
-    bool WindowStone::allowsSpreading(Direction dir) const {
+    bool WindowStone::allowsSpreading(Direction dir, bool isFlood) const {
         return !has_dir(getFaces(), dir);
     }
     
@@ -290,11 +291,19 @@
                     }
                 }
                 TouchStone(get_pos());  // avoid another actor getting below a moved window face
+                postFaceChange();
                 return true;
             }
         }
         return false;
     }
+
+    void WindowStone::postFaceChange() {
+        SendMessage(GetFloor(get_pos()), &quot;_checkflood&quot;);
+        for (Direction d = NORTH; d != NODIR; d = previous(d))
+            SendMessage(GetFloor(move(get_pos(), d)), &quot;_checkflood&quot;);
+    }
+
     
     DEF_TRAITSM(WindowStone, &quot;st_window&quot;, st_window, MOVABLE_BREAKABLE);
 

Modified: trunk/src/stones/WindowStone.hh
===================================================================
--- trunk/src/stones/WindowStone.hh	2008-12-12 22:16:08 UTC (rev 1391)
+++ trunk/src/stones/WindowStone.hh	2008-12-13 14:14:22 UTC (rev 1392)
@@ -66,7 +66,7 @@
         virtual void animcb();
 
         // Stone interface
-        virtual bool allowsSpreading(Direction dir) const;
+        virtual bool allowsSpreading(Direction dir, bool isFlood = false) const;
         virtual void actor_hit(const StoneContact &amp;sc);
         virtual StoneResponse collision_response(const StoneContact &amp;sc);
         virtual const char *collision_sound() {return &quot;glass&quot;;}
@@ -78,6 +78,7 @@
     private:
         void breakFaces(DirectionBits faces);
         bool tryInnerPull(Direction dir, Actor *initiator = NULL);
+        void postFaceChange();
     };
 
 } // namespace enigma

Modified: trunk/src/stones.hh
===================================================================
--- trunk/src/stones.hh	2008-12-12 22:16:08 UTC (rev 1391)
+++ trunk/src/stones.hh	2008-12-13 14:14:22 UTC (rev 1392)
@@ -209,7 +209,7 @@
         }
         
         // Fire and water spreading that is face and state dependent for stones like doors, window
-        virtual bool allowsSpreading(Direction dir) const {
+        virtual bool allowsSpreading(Direction dir, bool isFlood = false) const {
             return is_floating();
         }
         


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000820.html">[Enigma-game-svn] r1391 - in trunk
</A></li>
	<LI>Next message: <A HREF="000822.html">[Enigma-game-svn] r1393 - team_levelpacks/team_test_new_api
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#821">[ date ]</a>
              <a href="thread.html#821">[ thread ]</a>
              <a href="subject.html#821">[ subject ]</a>
              <a href="author.html#821">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/enigma-game-svn">More information about the Enigma-game-svn
mailing list</a><br>
</body></html>
