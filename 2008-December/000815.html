<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Enigma-game-svn] r1386 - in trunk: data data/gfx32 data/gfx40	data/gfx48 data/schemas src src/floors src/items src/stones
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/enigma-game-svn/2008-December/index.html" >
   <LINK REL="made" HREF="mailto:enigma-game-svn%40lists.berlios.de?Subject=Re%3A%20%5BEnigma-game-svn%5D%20r1386%20-%20in%20trunk%3A%20data%20data/gfx32%20data/gfx40%0A%09data/gfx48%20data/schemas%20src%20src/floors%20src/items%20src/stones&In-Reply-To=%3C200812070036.mB70aBIb007592%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000814.html">
   <LINK REL="Next"  HREF="000816.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Enigma-game-svn] r1386 - in trunk: data data/gfx32 data/gfx40	data/gfx48 data/schemas src src/floors src/items src/stones</H1>
    <B>ral at BerliOS</B> 
    <A HREF="mailto:enigma-game-svn%40lists.berlios.de?Subject=Re%3A%20%5BEnigma-game-svn%5D%20r1386%20-%20in%20trunk%3A%20data%20data/gfx32%20data/gfx40%0A%09data/gfx48%20data/schemas%20src%20src/floors%20src/items%20src/stones&In-Reply-To=%3C200812070036.mB70aBIb007592%40sheep.berlios.de%3E"
       TITLE="[Enigma-game-svn] r1386 - in trunk: data data/gfx32 data/gfx40	data/gfx48 data/schemas src src/floors src/items src/stones">ral at mail.berlios.de
       </A><BR>
    <I>Sun Dec  7 01:36:11 CET 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000814.html">[Enigma-game-svn] r1385 - homepage/input/news
</A></li>
        <LI>Next message: <A HREF="000816.html">[Enigma-game-svn] r1387 - team_levelpacks/team_test_new_api
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#815">[ date ]</a>
              <a href="thread.html#815">[ thread ]</a>
              <a href="subject.html#815">[ subject ]</a>
              <a href="author.html#815">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: ral
Date: 2008-12-07 01:36:01 +0100 (Sun, 07 Dec 2008)
New Revision: 1386

Added:
   trunk/data/gfx32/fl_abyss.png
   trunk/data/gfx32/fl_ice.png
   trunk/data/gfx32/fl_ice_heating.png
   trunk/data/gfx32/fl_space.png
   trunk/data/gfx32/fl_swamp.png
   trunk/data/gfx32/fl_swamp_heating.png
   trunk/data/gfx32/fl_water.png
   trunk/data/gfx32/fl_water_heating.png
   trunk/data/gfx40/fl_abyss.png
   trunk/data/gfx40/fl_ice.png
   trunk/data/gfx40/fl_ice_heating.png
   trunk/data/gfx40/fl_space.png
   trunk/data/gfx40/fl_swamp.png
   trunk/data/gfx40/fl_swamp_heating.png
   trunk/data/gfx40/fl_water.png
   trunk/data/gfx40/fl_water_heating.png
   trunk/data/gfx48/fl_abyss.png
   trunk/data/gfx48/fl_ice.png
   trunk/data/gfx48/fl_ice_heating.png
   trunk/data/gfx48/fl_space.png
   trunk/data/gfx48/fl_swamp.png
   trunk/data/gfx48/fl_swamp_heating.png
   trunk/data/gfx48/fl_water.png
   trunk/data/gfx48/fl_water_heating.png
   trunk/src/stones/FloorBuilder.cc
   trunk/src/stones/FloorBuilder.hh
Removed:
   trunk/data/gfx32/fl-abyss.png
   trunk/data/gfx32/fl-ice-heating.png
   trunk/data/gfx32/fl-ice.png
   trunk/data/gfx32/fl-space.png
   trunk/data/gfx32/fl-swamp-heating.png
   trunk/data/gfx32/fl-swamp.png
   trunk/data/gfx32/fl-water-heating.png
   trunk/data/gfx32/fl-water.png
   trunk/data/gfx40/fl-abyss.png
   trunk/data/gfx40/fl-ice-heating.png
   trunk/data/gfx40/fl-ice.png
   trunk/data/gfx40/fl-space.png
   trunk/data/gfx40/fl-swamp-heating.png
   trunk/data/gfx40/fl-swamp.png
   trunk/data/gfx40/fl-water-heating.png
   trunk/data/gfx40/fl-water.png
   trunk/data/gfx48/fl-abyss.png
   trunk/data/gfx48/fl-ice-heating.png
   trunk/data/gfx48/fl-ice.png
   trunk/data/gfx48/fl-space.png
   trunk/data/gfx48/fl-swamp-heating.png
   trunk/data/gfx48/fl-swamp.png
   trunk/data/gfx48/fl-water-heating.png
   trunk/data/gfx48/fl-water.png
Modified:
   trunk/data/api1init.lua
   trunk/data/models-2d.lua
   trunk/data/schemas/objects.xml
   trunk/data/startup.lua
   trunk/src/Makefile.am
   trunk/src/floors.cc
   trunk/src/floors/BridgeFloor.cc
   trunk/src/items.cc
   trunk/src/items/SeedItem.cc
   trunk/src/nls.hh
   trunk/src/ox_extra.cc
   trunk/src/ox_magnum.cc
   trunk/src/ox_oxyd1.cc
   trunk/src/ox_peroxyd.cc
   trunk/src/stones.cc
   trunk/src/stones.hh
   trunk/src/stones/BoulderStone.cc
   trunk/src/stones/ChessStone.cc
   trunk/src/stones/PuzzleStone.cc
   trunk/src/stones/VolcanoStone.cc
   trunk/src/stones_simple.cc
Log:
Trunk 1.1: new API reengineering
-floorbuilding stones:
  - st_wood (random orientation), st_wood_h, st_wood_v, st_wood_growing
  - st_flhay
  - st_flrock
  modified features:
  - keep identity from seed to stone, from stone to floor
  - eliminate stone killing within on_move(), it is done on floor change only
  - let stone fall on first occurence, even if multiple impulses are received
- rename some floors:
  - fl_abyss
  - fl_ice
  - fl_water
  - fl_swamp
  - fl_space
- fix greek language menu


Modified: trunk/data/api1init.lua
===================================================================
--- trunk/data/api1init.lua	2008-12-04 19:43:38 UTC (rev 1385)
+++ trunk/data/api1init.lua	2008-12-07 00:36:01 UTC (rev 1386)
@@ -45,7 +45,12 @@
 }
 
 RenamingObjectsNew2Old = {
+    fl_abyss = &quot;fl-abyss&quot;,
     fl_bridge = &quot;fl-bridge&quot;,
+    fl_ice = &quot;fl-ice&quot;,
+    fl_space = &quot;fl-space&quot;,
+    fl_swamp = &quot;fl-swamp&quot;,
+    fl_water = &quot;fl-water&quot;,
     it_blocker = &quot;it-blocker&quot;,
     it_blocker_new = &quot;it-blocker-new&quot;,
     it_brake = &quot;it-brake&quot;,
@@ -64,6 +69,7 @@
     it_magicwand = &quot;it-magicwand&quot;,
     it_magnet = &quot;it-magnet&quot;,
     it_magnet_on = &quot;it-magnet-on&quot;,
+    it_magnet_off = &quot;it-magnet-off&quot;,
     it_meditation_hollow = &quot;it-hollow&quot;,
     it_meditation_dent = &quot;it-tinyhollow&quot;,
     it_meditation_bump = &quot;it-tinyhill&quot;,
@@ -78,7 +84,6 @@
     it_pipe_nw = &quot;it-pipe-wn&quot;,
     it_pipe_ns = &quot;it-pipe-v&quot;,
     it_pipe_ne = &quot;it-pipe-ne&quot;,
-    it_magnet_off = &quot;it-magnet-off&quot;,
     it_rubberband = &quot;it-rubberband&quot;,
     it_seed = &quot;it-seed&quot;,
     it_seed_fake = &quot;it-seed_nowood&quot;,
@@ -154,6 +159,8 @@
     st_door_c = &quot;st-door_c&quot;,
     st_fart = &quot;st-fart&quot;,
     st_floppy = &quot;st-floppy&quot;,
+    st_flhay = &quot;st-flhay&quot;,
+    st_flrock = &quot;st-flrock&quot;,
     st_fourswitch = &quot;st-fourswitch&quot;,
     st_knight = &quot;st-knight&quot;,
     st_laser_w = &quot;st-laser-w&quot;,
@@ -287,7 +294,11 @@
     st_volcano_new = &quot;st-volcano-growing&quot;,
     st_volcano_active = &quot;st-volcano_active&quot;,
     st_volcano_idle = &quot;st-volcano_inactive&quot;,
-    st_window = &quot;st-window&quot;
+    st_window = &quot;st-window&quot;,
+    st_wood = &quot;st-wood&quot;,
+    st_wood_growing = &quot;st-wood-growing&quot;,
+    st_wood_h = &quot;st-wood1&quot;,
+    st_wood_v = &quot;st-wood2&quot;
 }
 
 for k,v in pairs(RenamingObjectsNew2Old) do

Deleted: trunk/data/gfx32/fl-abyss.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx32/fl-ice-heating.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx32/fl-ice.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx32/fl-space.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx32/fl-swamp-heating.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx32/fl-swamp.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx32/fl-water-heating.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx32/fl-water.png
===================================================================
(Binary files differ)

Copied: trunk/data/gfx32/fl_abyss.png (from rev 1382, trunk/data/gfx32/fl-abyss.png)

Copied: trunk/data/gfx32/fl_ice.png (from rev 1382, trunk/data/gfx32/fl-ice.png)

Copied: trunk/data/gfx32/fl_ice_heating.png (from rev 1382, trunk/data/gfx32/fl-ice-heating.png)

Copied: trunk/data/gfx32/fl_space.png (from rev 1382, trunk/data/gfx32/fl-space.png)

Copied: trunk/data/gfx32/fl_swamp.png (from rev 1382, trunk/data/gfx32/fl-swamp.png)

Copied: trunk/data/gfx32/fl_swamp_heating.png (from rev 1382, trunk/data/gfx32/fl-swamp-heating.png)

Copied: trunk/data/gfx32/fl_water.png (from rev 1382, trunk/data/gfx32/fl-water.png)

Copied: trunk/data/gfx32/fl_water_heating.png (from rev 1382, trunk/data/gfx32/fl-water-heating.png)

Deleted: trunk/data/gfx40/fl-abyss.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx40/fl-ice-heating.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx40/fl-ice.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx40/fl-space.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx40/fl-swamp-heating.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx40/fl-swamp.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx40/fl-water-heating.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx40/fl-water.png
===================================================================
(Binary files differ)

Copied: trunk/data/gfx40/fl_abyss.png (from rev 1382, trunk/data/gfx40/fl-abyss.png)

Copied: trunk/data/gfx40/fl_ice.png (from rev 1382, trunk/data/gfx40/fl-ice.png)

Copied: trunk/data/gfx40/fl_ice_heating.png (from rev 1382, trunk/data/gfx40/fl-ice-heating.png)

Copied: trunk/data/gfx40/fl_space.png (from rev 1382, trunk/data/gfx40/fl-space.png)

Copied: trunk/data/gfx40/fl_swamp.png (from rev 1382, trunk/data/gfx40/fl-swamp.png)

Copied: trunk/data/gfx40/fl_swamp_heating.png (from rev 1382, trunk/data/gfx40/fl-swamp-heating.png)

Copied: trunk/data/gfx40/fl_water.png (from rev 1382, trunk/data/gfx40/fl-water.png)

Copied: trunk/data/gfx40/fl_water_heating.png (from rev 1382, trunk/data/gfx40/fl-water-heating.png)

Deleted: trunk/data/gfx48/fl-abyss.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx48/fl-ice-heating.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx48/fl-ice.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx48/fl-space.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx48/fl-swamp-heating.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx48/fl-swamp.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx48/fl-water-heating.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx48/fl-water.png
===================================================================
(Binary files differ)

Copied: trunk/data/gfx48/fl_abyss.png (from rev 1382, trunk/data/gfx48/fl-abyss.png)

Copied: trunk/data/gfx48/fl_ice.png (from rev 1382, trunk/data/gfx48/fl-ice.png)

Copied: trunk/data/gfx48/fl_ice_heating.png (from rev 1382, trunk/data/gfx48/fl-ice-heating.png)

Copied: trunk/data/gfx48/fl_space.png (from rev 1382, trunk/data/gfx48/fl-space.png)

Copied: trunk/data/gfx48/fl_swamp.png (from rev 1382, trunk/data/gfx48/fl-swamp.png)

Copied: trunk/data/gfx48/fl_swamp_heating.png (from rev 1382, trunk/data/gfx48/fl-swamp-heating.png)

Copied: trunk/data/gfx48/fl_water.png (from rev 1382, trunk/data/gfx48/fl-water.png)

Copied: trunk/data/gfx48/fl_water_heating.png (from rev 1382, trunk/data/gfx48/fl-water-heating.png)

Modified: trunk/data/models-2d.lua
===================================================================
--- trunk/data/models-2d.lua	2008-12-04 19:43:38 UTC (rev 1385)
+++ trunk/data/models-2d.lua	2008-12-07 00:36:01 UTC (rev 1386)
@@ -232,7 +232,7 @@
 ------------------------
 do
     floorlist = {
-        &quot;fl-abyss&quot;,
+        &quot;fl_abyss&quot;,
         &quot;fl-acblack&quot;,
         &quot;fl-acwhite&quot;,
         &quot;fl-black&quot;,
@@ -241,7 +241,7 @@
         &quot;fl-dummy&quot;,
         &quot;fl-dunes&quot;,
         &quot;fl-floor_001&quot;,
-        &quot;fl-ice&quot;,
+        &quot;fl_ice&quot;,
         &quot;fl-inverse&quot;,
         &quot;fl-inverse2&quot;,
         &quot;fl-light&quot;,
@@ -258,6 +258,7 @@
     DefImages(floorlist)
 end
 
+
 -----------------------------------------
 -- Floors with multiple (random) tiles --
 -----------------------------------------
@@ -284,11 +285,11 @@
     DefRandFloorSi(&quot;fl-rough-red&quot;, 4)
     DefRandFloorSi(&quot;fl-sahara&quot;, 4)
     DefRandFloorSi(&quot;fl-samba&quot;, 2)
-    DefRandFloorSi(&quot;fl-space&quot;, 3,2)
+    DefRandFloorSi(&quot;fl_space&quot;, 3,2)
     DefRandFloorSi(&quot;fl-stwood&quot;, 2)
-    DefRandFloorSi(&quot;fl-swamp&quot;, 4)
+    DefRandFloorSi(&quot;fl_swamp&quot;, 4)
     DefRandFloorSi(&quot;fl-tigris&quot;, 4)
-    DefRandFloorSi(&quot;fl-water&quot;, 4)
+    DefRandFloorSi(&quot;fl_water&quot;, 4)
     DefRandFloorSi(&quot;fl-woven&quot;, 5)
 end
 
@@ -367,14 +368,14 @@
 ------------------------
 do
     function heating_animation(basemodel)
-        local images = DefSubimages(basemodel..&quot;-heating&quot;, {h=8});
+        local images = DefSubimages(basemodel..&quot;_heating&quot;, {h=8});
         local frames = BuildFrames(images, 240)
-        DefAnim(basemodel..&quot;-heating&quot;, frames);
+        DefAnim(basemodel..&quot;_heating&quot;, frames);
     end
 
-    heating_animation(&quot;fl-ice&quot;)
-    heating_animation(&quot;fl-water&quot;)
-    heating_animation(&quot;fl-swamp&quot;)
+    heating_animation(&quot;fl_ice&quot;)
+    heating_animation(&quot;fl_water&quot;)
+    heating_animation(&quot;fl_swamp&quot;)
 end
 
 --------------------------------------------------------------------------------

Modified: trunk/data/schemas/objects.xml
===================================================================
--- trunk/data/schemas/objects.xml	2008-12-04 19:43:38 UTC (rev 1385)
+++ trunk/data/schemas/objects.xml	2008-12-07 00:36:01 UTC (rev 1386)
@@ -75,6 +75,8 @@
     &lt;msg name=&quot;darken&quot; type=&quot;nil&quot;/&gt;
     &lt;msg name=&quot;disconnect&quot; type=&quot;nil&quot;/&gt;
     &lt;msg name=&quot;expl&quot; type=&quot;nil&quot;/&gt;
+    &lt;msg name=&quot;fall&quot; type=&quot;nil&quot;/&gt;
+    &lt;msg name=&quot;fire&quot; type=&quot;nil&quot;/&gt;
     &lt;msg name=&quot;flip&quot; type=&quot;nil&quot;/&gt;
     &lt;msg name=&quot;forcefire&quot; type=&quot;nil&quot;/&gt;
     &lt;msg name=&quot;get_adjacents&quot; type=&quot;nil&quot;/&gt;
@@ -670,6 +672,16 @@
       &lt;msg name=&quot;_explosion&quot;/&gt;
       &lt;msg name=&quot;_trigger&quot;/&gt;
     &lt;/object&gt;
+    &lt;object name=&quot;st_flhay&quot;&gt;
+      &lt;msg name=&quot;fire&quot;/&gt;
+      &lt;msg name=&quot;heat&quot;/&gt;
+      &lt;msg name=&quot;fall&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;st_flrock&quot;&gt;
+      &lt;msg name=&quot;fire&quot;/&gt;
+      &lt;msg name=&quot;heat&quot;/&gt;
+      &lt;msg name=&quot;fall&quot;/&gt;
+    &lt;/object&gt;
     &lt;object name=&quot;st_floppy&quot;&gt;
       &lt;msg name=&quot;on&quot;/&gt;
       &lt;msg name=&quot;off&quot;/&gt;
@@ -1081,5 +1093,16 @@
     &lt;object name=&quot;st_window_nesw&quot;&gt;
       &lt;attr name=&quot;faces&quot; value=&quot;nesw&quot;/&gt;
     &lt;/object&gt;
+    &lt;object name=&quot;st_wood&quot;&gt;
+      &lt;msg name=&quot;fire&quot;/&gt;
+      &lt;msg name=&quot;heat&quot;/&gt;
+      &lt;msg name=&quot;fall&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;st_wood_growing&quot; init=&quot;true&quot;&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;st_wood_h&quot; init=&quot;true&quot;&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;st_wood_v&quot; init=&quot;true&quot;&gt;
+    &lt;/object&gt;
   &lt;/zoo&gt;
 &lt;/objects&gt;

Modified: trunk/data/startup.lua
===================================================================
--- trunk/data/startup.lua	2008-12-04 19:43:38 UTC (rev 1385)
+++ trunk/data/startup.lua	2008-12-07 00:36:01 UTC (rev 1386)
@@ -233,7 +233,7 @@
 def_floor(&quot;fl-samba1&quot;,       6.0,   2.0,    true,   &quot;fl-abyss&quot;)
 def_floor(&quot;fl-samba2&quot;,       6.0,   2.0,    true,   &quot;fl-abyss&quot;)
 def_floor(&quot;fl-sand&quot;,         6.0,   2.0,   false,   &quot;&quot;)
-def_floor(&quot;fl-space&quot;,        0.0,   0.0,   false,   &quot;&quot;)
+def_floor(&quot;fl_space&quot;,        0.0,   0.0,   false,   &quot;&quot;)
 def_floor(&quot;fl-springboard&quot;,  4.0,   2.0,   false,   &quot;&quot;)
 def_floor(&quot;fl-stone&quot;,        1.4,   1.0,   false,   &quot;&quot;)
 def_floor(&quot;fl-tigris&quot;,       6.0,   2.0,    true,   &quot;&quot;)

Modified: trunk/src/Makefile.am
===================================================================
--- trunk/src/Makefile.am	2008-12-04 19:43:38 UTC (rev 1385)
+++ trunk/src/Makefile.am	2008-12-07 00:36:01 UTC (rev 1386)
@@ -254,8 +254,10 @@
 	stones/Door.hh		\
 	stones/FartStone.cc	\
 	stones/FartStone.hh	\
-	stones/FloppySwitch.cc   \
-	stones/FloppySwitch.hh   \
+	stones/FloorBuilder.cc	\
+	stones/FloorBuilder.hh	\
+	stones/FloppySwitch.cc	\
+	stones/FloppySwitch.hh	\
 	stones/FourSwitch.cc	\
 	stones/FourSwitch.hh	\
 	stones/KeySwitch.cc	\

Modified: trunk/src/floors/BridgeFloor.cc
===================================================================
--- trunk/src/floors/BridgeFloor.cc	2008-12-04 19:43:38 UTC (rev 1385)
+++ trunk/src/floors/BridgeFloor.cc	2008-12-07 00:36:01 UTC (rev 1386)
@@ -27,7 +27,7 @@
 namespace enigma {
     
     BridgeFloor::BridgeFloor(std::string flavor) : Floor(&quot;fl_bridge&quot;, 5, 1,
-        flf_default, flft_noash, &quot;fl-abyss&quot;)
+        flf_default, flft_noash, &quot;fl_abyss&quot;)
     {
         Floor::setAttr(&quot;flavor&quot;, flavor);
         state = OPEN;

Modified: trunk/src/floors.cc
===================================================================
--- trunk/src/floors.cc	2008-12-04 19:43:38 UTC (rev 1385)
+++ trunk/src/floors.cc	2008-12-07 00:36:01 UTC (rev 1386)
@@ -203,7 +203,7 @@
     string model = this-&gt;get_kind();
     if (   model == &quot;fl-wood&quot;   || model == &quot;fl-wood1&quot;   || model == &quot;fl-wood2&quot;
         || model == &quot;fl-stwood&quot; || model == &quot;fl-stwood1&quot; || model == &quot;fl-stwood2&quot;)
-        return &quot;fl-abyss&quot;;
+        return &quot;fl_abyss&quot;;
     else
         return &quot;&quot;;
 }
@@ -328,9 +328,9 @@
     // Maybe also transform floor?
     reaction_happened = on_heattransform(sourcedir, flhf) || reaction_happened;
     // Maybe transform stone, or stone blocks fire?
-    if(doStone)
-        if(Stone *st = GetStone(get_pos()))
-            if(to_int(SendMessage(st, &quot;heat&quot;, Value(sourcedir))) != 0.0)
+    if (doStone)
+        if (Stone *st = GetStone(get_pos()))
+            if (SendMessage(st, &quot;heat&quot;, Value(sourcedir)).to_bool())
                 reaction_happened = true;
     // Not item nor floor nor stone reacted? Then try to ignite the floor!
     // (Note: try_ignite also tests for the heating animation:
@@ -347,7 +347,7 @@
     if(!doHeatTransform || get_heattransform(false) == &quot;&quot;)
         return false;
     if(doHeatTransform &amp;&amp; get_heattransform(false) != &quot;&quot; &amp;&amp; !heating_animation) {
-        set_anim(((string) this-&gt;get_kind()) + &quot;-heating&quot;);
+        set_anim(((string) this-&gt;get_kind()) + &quot;_heating&quot;);
         heating_animation = true;
     }
     return true;
@@ -471,7 +471,7 @@
     class Abyss : public Floor {
         CLONEOBJ(Abyss);
     public:
-        Abyss() : Floor(&quot;fl-abyss&quot;, 2.0, 1, flf_indestructible, flft_noash) {}
+        Abyss() : Floor(&quot;fl_abyss&quot;, 2.0, 1, flf_indestructible, flft_noash) {}
     private:
 //         void actor_enter(Actor* a) {SendMessage(a, &quot;fall&quot;);}
         void actor_contact (Actor* a) {SendMessage(a, &quot;fall&quot;);}
@@ -483,8 +483,8 @@
     class Ice : public Floor {
         CLONEOBJ (Ice);
     public:
-        Ice() : Floor (&quot;fl-ice&quot;, 0.1, 0.1, flf_default, flft_default, &quot;&quot;,
-            &quot;fl-water&quot;) { }
+        Ice() : Floor (&quot;fl_ice&quot;, 0.1, 0.1, flf_default, flft_default, &quot;&quot;,
+            &quot;fl_water&quot;) { }
 
         virtual double get_friction() const {
             return 0.1 * server::IceFriction;
@@ -496,8 +496,8 @@
     class Water : public Floor {
         CLONEOBJ(Water);
     public:
-        Water() : Floor(&quot;fl-water&quot;, 5, 1, flf_indestructible, flft_default, &quot;&quot;,
-            &quot;fl-swamp&quot;) {}
+        Water() : Floor(&quot;fl_water&quot;, 5, 1, flf_indestructible, flft_default, &quot;&quot;,
+            &quot;fl_swamp&quot;) {}
     private:
 
         bool is_destructible() const {return false;}
@@ -514,7 +514,7 @@
     class Swamp : public Floor {
         CLONEOBJ(Swamp);
     public:
-        Swamp() : Floor(&quot;fl-swamp&quot;, 13, 1.0, flf_indestructible, flft_default,
+        Swamp() : Floor(&quot;fl_swamp&quot;, 13, 1.0, flf_indestructible, flft_default,
             &quot;&quot;, &quot;fl-dunes&quot;) {}
     private:
         bool is_destructible() const {return false;}
@@ -546,7 +546,7 @@
         CLONEOBJ(FallenBox);
     public:
         FallenBox(const char *kind)
-        :  Floor(kind, 6.4, 2.0, flf_default, flft_burnable, &quot;fl-abyss&quot;)
+        :  Floor(kind, 6.4, 2.0, flf_default, flft_burnable, &quot;fl_abyss&quot;)
         // uses same traits as fl-wood
         {}
 

Modified: trunk/src/items/SeedItem.cc
===================================================================
--- trunk/src/items/SeedItem.cc	2008-12-04 19:43:38 UTC (rev 1385)
+++ trunk/src/items/SeedItem.cc	2008-12-07 00:36:01 UTC (rev 1386)
@@ -104,7 +104,7 @@
                 return;
            }
        }
-       Stone *st = MakeStone(flavor == 0 ? &quot;st-wood-growing&quot; : (flavor == 1 ? &quot;st-greenbrown-growing&quot; : &quot;st_volcano_growing&quot;));
+       Stone *st = MakeStone(flavor == 0 ? &quot;st_wood_growing&quot; : (flavor == 1 ? &quot;st-greenbrown-growing&quot; : &quot;st_volcano_growing&quot;));
        transferIdentity(st);
        if (Value v = getAttr(&quot;secure&quot;))
            st-&gt;setAttr(&quot;secure&quot;, v);

Modified: trunk/src/items.cc
===================================================================
--- trunk/src/items.cc	2008-12-04 19:43:38 UTC (rev 1385)
+++ trunk/src/items.cc	2008-12-07 00:36:01 UTC (rev 1386)
@@ -928,12 +928,12 @@
             string model = fl-&gt;get_kind();
             // SetItem(p, it_explosion2) only used by it-dynamite?
             // If Yes, the following block could be places in the explosion class:
-            if (model == &quot;fl-space&quot;) {
+            if (model == &quot;fl_space&quot;) {
                 // In space, an it-dynamite explodes to an it-sherd:
                 // HOT FIX
                 //replace(it_sherd);
                 replace(&quot;it-hollow&quot;);
-            } else if (model == &quot;fl-ice&quot;) {
+            } else if (model == &quot;fl_ice&quot;) {
                 // In ice, an it-dynamite explodes to an it-crack2:
                 replace(&quot;it-crack2&quot;);
             } else {
@@ -1272,7 +1272,7 @@
         void animcb() {
             if (state == CRACKING2) {
                 GridPos p= get_pos();
-                SetFloor(p, MakeFloor(&quot;fl-abyss&quot;));
+                SetFloor(p, MakeFloor(&quot;fl_abyss&quot;));
                 KillItem(p);
             } else {
                 state = CRACKING2;
@@ -1356,7 +1356,7 @@
         }
         void animcb() {
             GridPos p = get_pos();
-            SetFloor(p, MakeFloor(&quot;fl-abyss&quot;));
+            SetFloor(p, MakeFloor(&quot;fl_abyss&quot;));
             KillItem(p);
         }
     public:
@@ -2054,13 +2054,13 @@
                 string model = fl-&gt;get_kind();
 
                 /* do not allow markings on this floortypes:
-                   fl-abyss, fl-water, fl-swamp
+                   fl_abyss, fl_water, fl_swamp
                    fl-bridge[{-closed,-open}]?
-                   markings on fl-ice will result as it-crack1
+                   markings on fl_ice will result as it-crack1
                 */
-                if (model == &quot;fl-abyss&quot; || model == &quot;fl-water&quot; || model == &quot;fl-swamp&quot;) {
+                if (model == &quot;fl_abyss&quot; || model == &quot;fl_water&quot; || model == &quot;fl_swamp&quot;) {
                     return ITEM_KEEP;
-                } else  if (model == &quot;fl-ice&quot;) {
+                } else  if (model == &quot;fl_ice&quot;) {
                     SetItem (p, MakeItem(&quot;it-crack1&quot;));
                 } else {
                     SetItem (p, MakeItem(&quot;it-cross&quot;));

Modified: trunk/src/nls.hh
===================================================================
--- trunk/src/nls.hh	2008-12-04 19:43:38 UTC (rev 1385)
+++ trunk/src/nls.hh	2008-12-07 00:36:01 UTC (rev 1386)
@@ -39,7 +39,7 @@
         { &quot;Suomi&quot;,      &quot;fi_FI&quot;, &quot;flags25x15/fi&quot; },
         { &quot;&#1091;&#1082;&#1088;&#1072;&#1111;&#1085;&#1089;&#1100;&#1082;&#1072;&quot;, &quot;uk_UA&quot;, &quot;flags25x15/ua&quot; },
         { &quot;&#1073;&#1077;&#1083;&#1072;&#1088;&#1091;&#1089;&#1082;&#1072;&#1103;&quot;, &quot;be_BY&quot;, &quot;flags25x15/by&quot; },
-        { &quot;&#925;&#941;&#945; &#917;&#955;&#955;&#951;&#957;&#953;&#954;&#940;&quot;, &quot;el_GR&quot;, &quot;flags25x15/gr&quot; },
+        { &quot;&#917;&#955;&#955;&#951;&#957;&#953;&#954;&#940;&quot;,   &quot;el_GR&quot;, &quot;flags25x15/gr&quot; },
     };
 }
 

Modified: trunk/src/ox_extra.cc
===================================================================
--- trunk/src/ox_extra.cc	2008-12-04 19:43:38 UTC (rev 1385)
+++ trunk/src/ox_extra.cc	2008-12-07 00:36:01 UTC (rev 1386)
@@ -34,7 +34,7 @@
 // only tables following!
 
 const char *oxyd::oxydextra_floor_map[256] = {
-    &quot;fl-abyss&quot;,          // OxydExtra floor 0x00
+    &quot;fl_abyss&quot;,          // OxydExtra floor 0x00
     &quot;fl-gray&quot;,           // OxydExtra floor 0x01
     &quot;fl-metal&quot;,          // OxydExtra floor 0x02
     UNUSED,              // OxydExtra floor 0x03
@@ -53,16 +53,16 @@
     UNUSED,              // OxydExtra floor 0x10
     UNUSED,              // OxydExtra floor 0x11
     UNUSED,              // OxydExtra floor 0x12
-    &quot;fl-water&quot;,          // OxydExtra floor 0x13
+    &quot;fl_water&quot;,          // OxydExtra floor 0x13
     UNUSED,              // OxydExtra floor 0x14
     UNUSED,              // OxydExtra floor 0x15
     UNUSED,              // OxydExtra floor 0x16
-    &quot;fl-ice&quot;,            // OxydExtra floor 0x17
+    &quot;fl_ice&quot;,            // OxydExtra floor 0x17
     UNUSED,              // OxydExtra floor 0x18
     UNUSED,              // OxydExtra floor 0x19
     UNUSED,              // OxydExtra floor 0x1a
     UNUSED,              // OxydExtra floor 0x1b
-    &quot;fl-space&quot;,          // OxydExtra floor 0x1c
+    &quot;fl_space&quot;,          // OxydExtra floor 0x1c
     UNUSED,              // OxydExtra floor 0x1d
     UNUSED,              // OxydExtra floor 0x1e
     UNUSED,              // OxydExtra floor 0x1f
@@ -155,7 +155,7 @@
     &quot;st-plain_break&quot;,    // OxydExtra stone 0x24
     &quot;st-plain_hole&quot;,     // OxydExtra stone 0x25
     &quot;st-plain_move&quot;,     // OxydExtra stone 0x26
-    &quot;st-wood&quot;,           // OxydExtra stone 0x27
+    &quot;st_wood&quot;,           // OxydExtra stone 0x27
     &quot;st_switch_instant&quot;, // OxydExtra stone 0x28
     UNUSED,              // OxydExtra stone 0x29
     UNUSED,              // OxydExtra stone 0x2a

Modified: trunk/src/ox_magnum.cc
===================================================================
--- trunk/src/ox_magnum.cc	2008-12-04 19:43:38 UTC (rev 1385)
+++ trunk/src/ox_magnum.cc	2008-12-07 00:36:01 UTC (rev 1386)
@@ -34,7 +34,7 @@
 // only tables following!
 
 const char *oxyd::oxydmag_floor_map[256] = {
-    &quot;fl-abyss&quot;,                 // OxydMagnum floor 0x00
+    &quot;fl_abyss&quot;,                 // OxydMagnum floor 0x00
     &quot;fl-gray&quot;,                  // OxydMagnum floor 0x01 (common was 'fl-gray')
     &quot;fl-metal&quot;,                 // OxydMagnum floor 0x02 (This should be &quot;fl-stwood&quot; for #112)
     &quot;fl-metal3&quot;,                // OxydMagnum floor 0x03
@@ -49,20 +49,20 @@
     &quot;fl-inverse&quot;,               // OxydMagnum floor 0x0c (common was 'fl-inverse')
     &quot;fl-acblack&quot;,               // OxydMagnum floor 0x0d
     &quot;fl-acwhite&quot;,               // OxydMagnum floor 0x0e
-    &quot;fl-swamp&quot;,                 // OxydMagnum floor 0x0f
+    &quot;fl_swamp&quot;,                 // OxydMagnum floor 0x0f
     UNUSED,                     // OxydMagnum floor 0x10
     UNUSED,                     // OxydMagnum floor 0x11
     UNUSED,                     // OxydMagnum floor 0x12
-    &quot;fl-water&quot;,                 // OxydMagnum floor 0x13
+    &quot;fl_water&quot;,                 // OxydMagnum floor 0x13
     UNUSED,                     // OxydMagnum floor 0x14
     UNUSED,                     // OxydMagnum floor 0x15
     UNUSED,                     // OxydMagnum floor 0x16
-    &quot;fl-ice&quot;,                   // OxydMagnum floor 0x17
+    &quot;fl_ice&quot;,                   // OxydMagnum floor 0x17
     UNUSED,                     // OxydMagnum floor 0x18
     UNUSED,                     // OxydMagnum floor 0x19
     UNUSED,                     // OxydMagnum floor 0x1a
     UNUSED,                     // OxydMagnum floor 0x1b
-    &quot;fl-space&quot;,                 // OxydMagnum floor 0x1c
+    &quot;fl_space&quot;,                 // OxydMagnum floor 0x1c
     UNUSED,                     // OxydMagnum floor 0x1d
     UNUSED,                     // OxydMagnum floor 0x1e
     UNUSED,                     // OxydMagnum floor 0x1f
@@ -159,7 +159,7 @@
     &quot;st-plain_break&quot;,           // OxydMagnum stone 0x28
     &quot;st-plain_hole&quot;,            // OxydMagnum stone 0x29
     &quot;st-plain_move&quot;,            // OxydMagnum stone 0x2a
-    &quot;st-wood&quot;,                  // OxydMagnum stone 0x2b
+    &quot;st_wood&quot;,                  // OxydMagnum stone 0x2b
     &quot;st_switch_instant&quot;,        // OxydMagnum stone 0x2c
     &quot;st_floppy&quot;,                // OxydMagnum stone 0x2d (in normal Oxyd Magnum Levels unused!)
     UNUSED,                     // OxydMagnum stone 0x2e

Modified: trunk/src/ox_oxyd1.cc
===================================================================
--- trunk/src/ox_oxyd1.cc	2008-12-04 19:43:38 UTC (rev 1385)
+++ trunk/src/ox_oxyd1.cc	2008-12-07 00:36:01 UTC (rev 1386)
@@ -67,7 +67,7 @@
 // only tables following!
 
 const char *oxyd::oxyd1_floor_map[256] = {
-    &quot;fl-abyss&quot;,                 // Oxyd1 floor 0x00
+    &quot;fl_abyss&quot;,                 // Oxyd1 floor 0x00
     &quot;fl-gray&quot;,                  // Oxyd1 floor 0x01
     &quot;fl-metal&quot;,                 // Oxyd1 floor 0x02
     &quot;fl-samba&quot;,                 // Oxyd1 floor 0x03 was: checkered floor
@@ -82,26 +82,26 @@
     &quot;fl-inverse2&quot;,              // Oxyd1 floor 0x0c
     &quot;fl-acblack&quot;,               // Oxyd1 floor 0x0d
     &quot;fl-acwhite&quot;,               // Oxyd1 floor 0x0e
-    &quot;fl-swamp&quot;,                 // Oxyd1 floor 0x0f
+    &quot;fl_swamp&quot;,                 // Oxyd1 floor 0x0f
     UNUSED,                     // Oxyd1 floor 0x10
     UNUSED,                     // Oxyd1 floor 0x11
     UNUSED,                     // Oxyd1 floor 0x12
-    &quot;fl-water&quot;,                 // Oxyd1 floor 0x13
+    &quot;fl_water&quot;,                 // Oxyd1 floor 0x13
     UNUSED,                     // Oxyd1 floor 0x14
     UNUSED,                     // Oxyd1 floor 0x15
     UNUSED,                     // Oxyd1 floor 0x16
-    &quot;fl-ice&quot;,                   // Oxyd1 floor 0x17
+    &quot;fl_ice&quot;,                   // Oxyd1 floor 0x17
     UNUSED,                     // Oxyd1 floor 0x18
     UNUSED,                     // Oxyd1 floor 0x19
     UNUSED,                     // Oxyd1 floor 0x1a
     UNUSED,                     // Oxyd1 floor 0x1b
-    &quot;fl-space&quot;,                 // Oxyd1 floor 0x1c
-    &quot;fl-space&quot;,                 // Oxyd1 floor 0x1d
+    &quot;fl_space&quot;,                 // Oxyd1 floor 0x1c
+    &quot;fl_space&quot;,                 // Oxyd1 floor 0x1d
     UNUSED,                     // Oxyd1 floor 0x1e
     UNUSED,                     // Oxyd1 floor 0x1f
-    &quot;fl-space&quot;,                 // Oxyd1 floor 0x20
+    &quot;fl_space&quot;,                 // Oxyd1 floor 0x20
     &quot;fl-space-force&quot;,           // Oxyd1 floor 0x21
-    &quot;fl-space&quot;,                 // Oxyd1 floor 0x22
+    &quot;fl_space&quot;,                 // Oxyd1 floor 0x22
     &quot;fl-gradient1&quot;,             // Oxyd1 floor 0x23
     &quot;fl-gradient2&quot;,             // Oxyd1 floor 0x24
     &quot;fl-gradient3&quot;,             // Oxyd1 floor 0x25
@@ -191,7 +191,7 @@
     &quot;st-plain_break&quot;,           // Oxyd1 stone 0x28 [see Level#12]
     &quot;st-plain_hole&quot;,            // Oxyd1 stone 0x29
     &quot;st-plain_move&quot;,            // Oxyd1 stone 0x2a
-    &quot;st-wood&quot;,                  // Oxyd1 stone 0x2b
+    &quot;st_wood&quot;,                  // Oxyd1 stone 0x2b
     &quot;st_switch_instant&quot;,        // Oxyd1 stone 0x2c
     &quot;st_switch_black_instant&quot;,  // Oxyd1 stone 0x2d
     &quot;st_switch_white_instant&quot;,  // Oxyd1 stone 0x2e

Modified: trunk/src/ox_peroxyd.cc
===================================================================
--- trunk/src/ox_peroxyd.cc	2008-12-04 19:43:38 UTC (rev 1385)
+++ trunk/src/ox_peroxyd.cc	2008-12-07 00:36:01 UTC (rev 1386)
@@ -103,7 +103,7 @@
 // only tables following!
 
 const char *oxyd::peroxyd_floor_map[256] = {
-    &quot;fl-abyss&quot;,                 // PerOxyd floor 0x00
+    &quot;fl_abyss&quot;,                 // PerOxyd floor 0x00
     &quot;fl-gray&quot;,                  // PerOxyd floor 0x01
     &quot;fl-metal&quot;,                 // PerOxyd floor 0x02
     &quot;fl-metal&quot;,                 // PerOxyd floor 0x03
@@ -118,20 +118,20 @@
     &quot;fl-inverse&quot;,               // PerOxyd floor 0x0c
     &quot;fl-acblack&quot;,               // PerOxyd floor 0x0d
     &quot;fl-acwhite&quot;,               // PerOxyd floor 0x0e
-    &quot;fl-swamp&quot;,                 // PerOxyd floor 0x0f
+    &quot;fl_swamp&quot;,                 // PerOxyd floor 0x0f
     UNUSED,                     // PerOxyd floor 0x10
     UNUSED,                     // PerOxyd floor 0x11
     UNUSED,                     // PerOxyd floor 0x12
-    &quot;fl-water&quot;,                 // PerOxyd floor 0x13
-    &quot;fl-water&quot;,                 // PerOxyd floor 0x14
+    &quot;fl_water&quot;,                 // PerOxyd floor 0x13
+    &quot;fl_water&quot;,                 // PerOxyd floor 0x14
     UNUSED,                     // PerOxyd floor 0x15
     UNUSED,                     // PerOxyd floor 0x16
-    &quot;fl-ice&quot;,                   // PerOxyd floor 0x17
+    &quot;fl_ice&quot;,                   // PerOxyd floor 0x17
     UNUSED,                     // PerOxyd floor 0x18
     UNUSED,                     // PerOxyd floor 0x19
     UNUSED,                     // PerOxyd floor 0x1a
     UNUSED,                     // PerOxyd floor 0x1b
-    &quot;fl-space&quot;,                 // PerOxyd floor 0x1c
+    &quot;fl_space&quot;,                 // PerOxyd floor 0x1c
     UNUSED,                     // PerOxyd floor 0x1d
     UNUSED,                     // PerOxyd floor 0x1e
     UNUSED,                     // PerOxyd floor 0x1f
@@ -227,7 +227,7 @@
     &quot;st-plain_break&quot;,           // PerOxyd stone 0x24
     &quot;st-bluegray_hole&quot;,         // PerOxyd stone 0x25
     &quot;st-plain_move&quot;,            // PerOxyd stone 0x26
-    &quot;st-wood&quot;,                  // PerOxyd stone 0x27
+    &quot;st_wood&quot;,                  // PerOxyd stone 0x27
     &quot;st_switch_instant&quot;,        // PerOxyd stone 0x28
     &quot;st_switch_black_instant&quot;,  // PerOxyd stone 0x29
     &quot;st_switch_white_instant&quot;,  // PerOxyd stone 0x2a

Modified: trunk/src/stones/BoulderStone.cc
===================================================================
--- trunk/src/stones/BoulderStone.cc	2008-12-04 19:43:38 UTC (rev 1385)
+++ trunk/src/stones/BoulderStone.cc	2008-12-07 00:36:01 UTC (rev 1386)
@@ -133,7 +133,7 @@
 
     void BoulderStone::on_floor_change() {
         Floor *fl = GetFloor(get_pos());
-        if (fl-&gt;is_kind(&quot;fl-abyss&quot;)) {
+        if (fl-&gt;is_kind(&quot;fl_abyss&quot;)) {
             state = FALLING;
             init_model();
         }

Modified: trunk/src/stones/ChessStone.cc
===================================================================
--- trunk/src/stones/ChessStone.cc	2008-12-04 19:43:38 UTC (rev 1385)
+++ trunk/src/stones/ChessStone.cc	2008-12-07 00:36:01 UTC (rev 1386)
@@ -151,9 +151,9 @@
     void ChessStone::on_floor_change() {
         Floor *fl = GetFloor(get_pos());
         if (fl != NULL) {
-            if (fl-&gt;is_kind(&quot;fl-abyss&quot;))
+            if (fl-&gt;is_kind(&quot;fl_abyss&quot;))
                 try_state(FALLING);
-            if (fl-&gt;is_kind(&quot;fl-swamp&quot;))
+            if (fl-&gt;is_kind(&quot;fl_swamp&quot;))
                 try_state(SINKING);
         }
     }

Added: trunk/src/stones/FloorBuilder.cc
===================================================================
--- trunk/src/stones/FloorBuilder.cc	2008-12-04 19:43:38 UTC (rev 1385)
+++ trunk/src/stones/FloorBuilder.cc	2008-12-07 00:36:01 UTC (rev 1386)
@@ -0,0 +1,196 @@
+/*
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *  
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include &quot;stones/FloorBuilder.hh&quot;
+#include &quot;errors.hh&quot;
+//#include &quot;main.hh&quot;
+
+namespace enigma {
+    FloorBuilder::FloorBuilder(int subtyp, int initState) : Stone() {
+        objFlags |= (subtyp &lt;&lt; 25);
+        if (subtyp == ROCK)
+            objFlags |= OBJBIT_BLOCKFIRE;
+        state = initState;
+    }
+    
+    FloorBuilder* FloorBuilder::clone() {
+        if ((FloorBuilderTyp)((objFlags &amp; OBJBIT_SUBTYP) &gt;&gt; 25) == WOOD) { 
+             // When st_wood is created it randomly becomes st_wood1 or st_wood2.
+             if (IntegerRand(0, 1) == 0)
+                return new FloorBuilder(WOOD1, state);
+            else
+                return new FloorBuilder(WOOD2, state);
+        } else {
+            return new FloorBuilder(*this);
+        }
+    }
+    
+    void FloorBuilder::dispose() {
+        delete this;
+    }
+    
+    std::string FloorBuilder::getClass() const {
+        FloorBuilderTyp typ = (FloorBuilderTyp)((objFlags &amp; OBJBIT_SUBTYP) &gt;&gt; 25);
+        switch (typ) {
+            case WOOD:
+            case WOOD1:
+            case WOOD2:
+                return &quot;st_wood&quot;;
+            case HAY:
+                return &quot;st_flhay&quot;;
+            case ROCK:
+                return &quot;st_flrock&quot;;
+        }
+    }
+    
+    const char *FloorBuilder::get_kind() const {
+        FloorBuilderTyp typ = (FloorBuilderTyp)((objFlags &amp; OBJBIT_SUBTYP) &gt;&gt; 25);
+        switch (typ) {
+            case WOOD:
+                return &quot;st_wood&quot;;
+            case WOOD1:
+                return &quot;st_wood_h&quot;;
+            case WOOD2:
+                return &quot;st_wood_v&quot;;
+            case HAY:
+                return &quot;st_flhay&quot;;
+            case ROCK:
+                return &quot;st_flrock&quot;;
+        }
+    }
+
+    Value FloorBuilder::message(const Message &amp;m) {
+        if (m.message == &quot;fire&quot; &amp;&amp; !(objFlags &amp; OBJBIT_BLOCKFIRE)) {
+            KillStone(get_pos());
+            return true;  // allow fire to spread
+        } else if (m.message == &quot;heat&quot;) {
+            return (objFlags &amp; OBJBIT_BLOCKFIRE) != 0;  // block fire
+        } else if (m.message == &quot;fall&quot;) {
+            maybe_fall_or_stopfire();
+            return Value();
+        }
+        return Stone::message(m);
+    }
+
+    void FloorBuilder::setState(int extState) {
+        // no external states
+    }
+    
+    void FloorBuilder::init_model() {
+        FloorBuilderTyp typ = (FloorBuilderTyp)((objFlags &amp; OBJBIT_SUBTYP) &gt;&gt; 25);
+        switch (typ) {
+            case WOOD:
+                ASSERT(false, XLevelRuntime, &quot;Wood stone init model state error&quot;);
+            case WOOD1:
+                if (state == GROWING)
+                    set_anim(&quot;st-wood-growing&quot;);
+                else
+                    set_model(&quot;st-wood1&quot;);
+                break;
+            case WOOD2:
+                if (state == GROWING)
+                    set_anim(&quot;st-wood-growing&quot;);
+                else
+                    set_model(&quot;st-wood2&quot;);
+                break;
+            case HAY:
+                set_model(&quot;st-flhay&quot;); break;
+                break;
+            case ROCK:
+                set_model(&quot;st-flrock&quot;); break;
+        }
+    }
+    
+    void FloorBuilder::animcb() {
+        state = IDLE;
+        init_model();
+        maybe_fall_or_stopfire(); // instantly builds a bridge on fl_swamp etc
+    }
+
+    void FloorBuilder::actor_hit(const StoneContact &amp;sc) {
+        if (state == GROWING)
+            SendMessage(sc.actor, &quot;shatter&quot;);
+        else
+            Stone::actor_hit(sc);
+    }
+    
+    void FloorBuilder::actor_inside(Actor *a) {
+        if (state == GROWING)
+            SendMessage(a, &quot;shatter&quot;);
+    }
+    
+    void FloorBuilder::actor_contact(Actor *a) {
+        if (state == GROWING)
+            SendMessage(a, &quot;shatter&quot;);
+    }
+    
+    void FloorBuilder::on_move() {
+        // in oxyd1 only fall when moving
+        Stone::on_move();
+        maybe_fall_or_stopfire(true);
+    }
+    
+    void FloorBuilder::on_floor_change() {
+        // other oxyds versions: fall everytime the floor changes
+        maybe_fall_or_stopfire(false, true);
+    }
+    
+    void FloorBuilder::maybe_fall_or_stopfire(bool onMove, bool onFloorChange) {
+        FloorBuilderTyp typ = (FloorBuilderTyp)((objFlags &amp; OBJBIT_SUBTYP) &gt;&gt; 25);
+        GridPos p = get_pos();
+        if (server::GameCompatibility != GAMET_ENIGMA &amp;&amp; IsLevelBorder(p))
+            return;
+        if (Floor *fl = GetFloor(p)) {
+            const std::string &amp;k = fl-&gt;get_kind();
+            if (objFlags &amp; OBJBIT_BLOCKFIRE)
+                SendMessage(fl, &quot;stopfire&quot;);
+            if (k == &quot;fl_abyss&quot; || k == &quot;fl_water&quot; || k == &quot;fl_swamp&quot;) {
+                if (onMove)
+                    // just mark - can not kill stone yet - this will be done on floor change event
+                    state = FALLING;  // keep the stone from moving any longer
+                else if ((server::GameCompatibility != GAMET_OXYD1) || state == FALLING || !onFloorChange) {
+                    state = FALLEN;
+                    Floor *fl = MakeFloor((typ == HAY) ? &quot;fl-hay&quot; : ((typ == ROCK) ? &quot;fl-rock&quot; : ((typ == WOOD1) ? &quot;fl-stwood1&quot; : &quot;fl-stwood2&quot;)));
+                    transferIdentity(fl);
+                    SetFloor(p, fl); 
+                    KillStone(p);
+                }
+            }
+        }
+    }
+    
+    int FloorBuilder::traitsIdx() const {
+        return (state == IDLE) ? 1 : 0;
+    }
+
+    StoneTraits FloorBuilder::traits[2] = {
+        {&quot;st_floorbuilder&quot;, st_floorbuilder, stf_none, material_stone, 1.0, MOVABLE_PERSISTENT},
+        {&quot;st_floorbuilder&quot;, st_floorbuilder, stf_none, material_stone, 1.0, MOVABLE_STANDARD},
+    };
+
+    BOOT_REGISTER_START
+        BootRegister(new FloorBuilder(0), &quot;st_wood&quot;);
+        BootRegister(new FloorBuilder(0, 1), &quot;st_wood_growing&quot;);
+        BootRegister(new FloorBuilder(1), &quot;st_wood_h&quot;);
+        BootRegister(new FloorBuilder(2), &quot;st_wood_v&quot;);
+        BootRegister(new FloorBuilder(3), &quot;st_flhay&quot;);
+        BootRegister(new FloorBuilder(4), &quot;st_flrock&quot;);
+    BOOT_REGISTER_END
+
+} // namespace enigma


Property changes on: trunk/src/stones/FloorBuilder.cc
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/stones/FloorBuilder.hh
===================================================================
--- trunk/src/stones/FloorBuilder.hh	2008-12-04 19:43:38 UTC (rev 1385)
+++ trunk/src/stones/FloorBuilder.hh	2008-12-07 00:36:01 UTC (rev 1386)
@@ -0,0 +1,89 @@
+/*
+ * Copyright (C) 2008 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef FLOORBUILDERSTONE_HH
+#define FLOORBUILDERSTONE_HH
+
+#include &quot;stones.hh&quot;
+
+#include &quot;stones_internal.hh&quot;
+
+namespace enigma {
+
+    /** 
+     * 
+     */
+    class FloorBuilder : public Stone {
+         DECL_TRAITS_ARRAY(2, traitsIdx());
+
+    private:
+        enum iState {
+            IDLE,       ///&lt; standard movable stone
+            GROWING,    ///&lt; a stone growing from a seed
+            FALLING,    ///&lt; a stone moved into water or abyss and marked to fall on floor change notification
+            FALLEN      ///&lt; a stone that is fallen on floor change notification and is vanishing
+        };
+        
+    private:
+        enum ObjectPrivatFlagsBits {
+            OBJBIT_BLOCKFIRE =   1&lt;&lt;24,   ///&lt; stone blocks fire on moves and floor changes beneath
+            OBJBIT_SUBTYP    =   7&lt;&lt;25,   ///&lt; the FloorBuilderTyp
+        };
+        
+        enum FloorBuilderTyp {
+            WOOD = 0,
+            WOOD1,
+            WOOD2,
+            HAY,
+            ROCK
+        };
+    public:
+        FloorBuilder(int subtyp, int initState = IDLE);
+        
+        // Object interface
+        virtual FloorBuilder* clone();
+        virtual void dispose();
+        virtual std::string getClass() const;
+        virtual const char *get_kind() const;  // for backward compatibility
+        virtual Value message(const Message &amp;m);
+        
+        // StateObject interface
+        virtual void setState(int extState);
+        
+        // GridObject interface
+        virtual void init_model();
+        
+        // ModelCallback interface
+        virtual void animcb();
+        
+        // Stone interface
+        virtual void actor_hit(const StoneContact &amp;sc);
+        virtual void actor_inside(Actor *a);
+        virtual void actor_contact(Actor *a);
+        virtual void on_move();
+        virtual void on_floor_change();
+    
+    private:
+        // Private methods.
+        void maybe_fall_or_stopfire(bool onMove = false, bool onFloorChange = false);
+        int traitsIdx() const;
+    };
+
+} // namespace enigma
+
+#endif /*FLOORBUILDERSTONE_HH*/


Property changes on: trunk/src/stones/FloorBuilder.hh
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/src/stones/PuzzleStone.cc
===================================================================
--- trunk/src/stones/PuzzleStone.cc	2008-12-04 19:43:38 UTC (rev 1385)
+++ trunk/src/stones/PuzzleStone.cc	2008-12-07 00:36:01 UTC (rev 1386)
@@ -409,7 +409,7 @@
 
         for (PuzzleList::iterator itr = cluster.begin(); itr != cluster.end(); ++itr) {
             if (Floor *fl = GetFloor(move((*itr)-&gt;get_pos(), dir))) {
-                if (!((fl-&gt;is_kind(&quot;fl-abyss&quot;) &amp;&amp; isComplete) || (fl-&gt;is_kind(&quot;fl-water&quot;) &amp;&amp; (isComplete || waterSink)))) {
+                if (!((fl-&gt;is_kind(&quot;fl_abyss&quot;) &amp;&amp; isComplete) || (fl-&gt;is_kind(&quot;fl_water&quot;) &amp;&amp; (isComplete || waterSink)))) {
                     createBridge = false;
                     break;
                 }

Modified: trunk/src/stones/VolcanoStone.cc
===================================================================
--- trunk/src/stones/VolcanoStone.cc	2008-12-04 19:43:38 UTC (rev 1385)
+++ trunk/src/stones/VolcanoStone.cc	2008-12-07 00:36:01 UTC (rev 1386)
@@ -74,7 +74,7 @@
     }
     
     void VolcanoStone::init_model() {
-        switch( state) {
+        switch (state) {
             case FINISHED:
             case INACTIVE: set_model(&quot;st-plain&quot;); break;
             case ACTIVE:   set_anim(&quot;st-farting&quot;); break;

Modified: trunk/src/stones.cc
===================================================================
--- trunk/src/stones.cc	2008-12-04 19:43:38 UTC (rev 1385)
+++ trunk/src/stones.cc	2008-12-07 00:36:01 UTC (rev 1386)
@@ -746,7 +746,7 @@
 
         void on_floor_change() {
             if (Floor *fl = GetFloor (get_pos()))
-                if (fl-&gt;is_kind(&quot;fl-abyss&quot;))
+                if (fl-&gt;is_kind(&quot;fl_abyss&quot;))
                     ReplaceStone (get_pos(), MakeStone(&quot;st-plain_falling&quot;));
         }
 
@@ -825,10 +825,10 @@
 //            Stone::on_move();
             GridPos p = get_pos();
             if (Floor *fl = GetFloor (p)) {
-                if (fl-&gt;is_kind(&quot;fl-abyss&quot;)) {
+                if (fl-&gt;is_kind(&quot;fl_abyss&quot;)) {
                     ReplaceStone (p, MakeStone(&quot;st-plain_falling&quot;));
                 }
-                else if (fl-&gt;is_kind(&quot;fl-swamp&quot;) || fl-&gt;is_kind(&quot;fl-water&quot;)) {
+                else if (fl-&gt;is_kind(&quot;fl_swamp&quot;) || fl-&gt;is_kind(&quot;fl_water&quot;)) {
                     sound_event (&quot;drown&quot;);
                     client::Msg_Sparkle (p.center());
                     KillStone (p);

Modified: trunk/src/stones.hh
===================================================================
--- trunk/src/stones.hh	2008-12-04 19:43:38 UTC (rev 1385)
+++ trunk/src/stones.hh	2008-12-07 00:36:01 UTC (rev 1386)
@@ -61,6 +61,7 @@
         st_fart,
         st_firebreak,
         st_firebreak_move,
+        st_floorbuilder,
         st_floppy,
         st_fourswitch,
         st_greenbrown_growing,

Modified: trunk/src/stones_simple.cc
===================================================================
--- trunk/src/stones_simple.cc	2008-12-04 19:43:38 UTC (rev 1385)
+++ trunk/src/stones_simple.cc	2008-12-07 00:36:01 UTC (rev 1386)
@@ -392,7 +392,7 @@
         void on_floor_change() {
             if (Floor *fl=GetFloor(get_pos())) {
                 const string &amp;k = fl-&gt;get_kind();
-                if (k==&quot;fl-water&quot; || k==&quot;fl-abyss&quot; || k == &quot;fl-swamp&quot;) {
+                if (k==&quot;fl_water&quot; || k==&quot;fl_abyss&quot; || k == &quot;fl_swamp&quot;) {
                     client::Msg_Sparkle (get_center());
                     KillStone(get_pos());
                 }
@@ -833,123 +833,12 @@
     };
 }
 
-/* -------------------- Wooden stone -------------------- */
 
-/** \page st-wood Wooden Stone
-
-This stone is movable.  If moved into abyss, water or swamp it builds
-a wooden plank.
-
-\subsection woode Example
-\verbatim
-set_stone(&quot;st-wood&quot;, 10,10)
-\endverbatim
-
-Note: There are two flavors of st-wood which may be specified
-by using st-wood1 or st-wood2, and two related kinds: st-flrock,
-which creates the unburnable fl-rock and denies fire under it, and 
-the burnable st-hay, which leaves the burnable but stable fl-hay
-behind.
-
-\image html st-wood.png
-*/
-namespace
-{
-    class WoodenStone : public Stone {
-        CLONEOBJ(WoodenStone);
-        DECL_TRAITS;
-    public:
-        WoodenStone(const char *kind, const char *floorkind_, bool blockfire_ = false) :
-            Stone(kind), floorkind(floorkind_), blockfire(blockfire_) {}
-
-    private:
-        const char *floorkind;
-        bool blockfire;
-
-        void maybe_fall_or_stopfire() {
-            GridPos p = get_pos();
-            if (server::GameCompatibility != GAMET_ENIGMA &amp;&amp; IsLevelBorder(p))
-                return;
-            if (Floor *fl = GetFloor(p)) {
-                const string &amp;k = fl-&gt;get_kind();
-                if(blockfire)
-                    SendMessage(fl, &quot;stopfire&quot;);
-                if (k == &quot;fl-abyss&quot; || k == &quot;fl-water&quot; || k == &quot;fl-swamp&quot;) {
-                    SetFloor(p, MakeFloor(floorkind));
-                    KillStone(p);
-                }
-            }
-        }
-
-        virtual Value message(const Message &amp;m) {
-            if (m.message == &quot;fire&quot; &amp;&amp; !blockfire) {
-                KillStone(get_pos());
-                return true;  // allow fire to spread
-            } else if (m.message == &quot;heat&quot; &amp;&amp; blockfire) {
-                return true;  // block fire
-            } else if (m.message == &quot;fall&quot;) {
-                maybe_fall_or_stopfire();
-                return Value();
-            }
-            return Stone::message(m);
-        }
-
-        // in oxyd1 only fall when moving
-        void on_move() {
-            Stone::on_move();
-            if (server::GameCompatibility == GAMET_OXYD1)
-                maybe_fall_or_stopfire();
-        }
-        
-        // other oxyds versions: fall everytime the floor changes
-        void on_floor_change() {
-            if (server::GameCompatibility != GAMET_OXYD1)
-                maybe_fall_or_stopfire();
-        }
-    };
-    DEF_TRAITSM(WoodenStone, &quot;INVALID&quot;, st_INVALID, MOVABLE_STANDARD);
-
-    /*! When st-wood is created it randomly becomes st-wood1 or
-      st-wood2. */
-    class RandomWoodenStone : public Stone {
-    public:
-        RandomWoodenStone() : Stone(&quot;st-wood&quot;) {}
-    private:
-        Stone *clone() {
-            if(IntegerRand(0, 1) == 0)
-                return new WoodenStone(&quot;st-wood1&quot;, &quot;fl-stwood1&quot;);
-            else
-                return new WoodenStone(&quot;st-wood2&quot;, &quot;fl-stwood2&quot;);
-        }
-        void dispose() {delete this;}
-    };
-}
-
 //----------------------------------------
 // Growing stones used by it-seed
 //----------------------------------------
 namespace
 {
-    class WoodenStone_Growing : public Stone {
-        CLONEOBJ(WoodenStone_Growing);
-        DECL_TRAITS;
-    public:
-        WoodenStone_Growing()
-        {}
-    private:
-        void init_model() { set_anim(&quot;st-wood-growing&quot;); }
-        void animcb() {
-            Stone *st = MakeStone (&quot;st-wood&quot;);
-            ReplaceStone (get_pos(), st);
-            SendMessage(st, &quot;fall&quot;); // instantly builds a bridge on fl-swamp etc
-        }
-        void actor_contact(Actor *a) {SendMessage(a, &quot;shatter&quot;);}
-        void actor_inside(Actor *a) {SendMessage(a, &quot;shatter&quot;);}
-        void actor_hit(const StoneContact &amp;sc) {SendMessage(sc.actor, &quot;shatter&quot;);}
-
-        FreezeStatusBits get_freeze_bits() { return FREEZEBIT_STANDARD; }
-    };
-    DEF_TRAITS(WoodenStone_Growing, &quot;st-wood-growing&quot;, st_wood_growing);
     
     class GreenbrownStone_Growing : public Stone {
         CLONEOBJ(GreenbrownStone_Growing);
@@ -1401,10 +1290,10 @@
         void on_floor_change() {
             GridPos p = get_pos();
             if (Floor *fl = GetFloor (p)) {
-                if (fl-&gt;is_kind(&quot;fl-abyss&quot;)) {
+                if (fl-&gt;is_kind(&quot;fl_abyss&quot;)) {
                     ReplaceStone (p, MakeStone(&quot;st-plain_falling&quot;));
                 }
-                else if (fl-&gt;is_kind(&quot;fl-swamp&quot;) || fl-&gt;is_kind(&quot;fl-water&quot;)) {
+                else if (fl-&gt;is_kind(&quot;fl_swamp&quot;) || fl-&gt;is_kind(&quot;fl_water&quot;)) {
                     sound_event (&quot;drown&quot;);
                     client::Msg_Sparkle (p.center());
                     KillStone (p);
@@ -1473,12 +1362,6 @@
     Register(new Stonebrush);
     Register(new ThiefStone);
 
-    Register(new RandomWoodenStone); // random flavor
-    Register(new WoodenStone(&quot;st-wood1&quot;, &quot;fl-stwood1&quot;)); // horizontal planks
-    Register(new WoodenStone(&quot;st-wood2&quot;, &quot;fl-stwood2&quot;)); // vertical planks
-    Register(new WoodenStone(&quot;st-flrock&quot;, &quot;fl-rock&quot;, true));
-    Register(new WoodenStone(&quot;st-flhay&quot;, &quot;fl-hay&quot;));
-    Register(new WoodenStone_Growing);
     Register(new GreenbrownStone_Growing);
 
     Register(new YinYangStone1);


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000814.html">[Enigma-game-svn] r1385 - homepage/input/news
</A></li>
	<LI>Next message: <A HREF="000816.html">[Enigma-game-svn] r1387 - team_levelpacks/team_test_new_api
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#815">[ date ]</a>
              <a href="thread.html#815">[ thread ]</a>
              <a href="subject.html#815">[ subject ]</a>
              <a href="author.html#815">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/enigma-game-svn">More information about the Enigma-game-svn
mailing list</a><br>
</body></html>
