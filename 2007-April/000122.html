<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Enigma-game-svn] r684 - in branches/eval: . java java/src	java/src/org java/src/org/enigma_game java/src/org/enigma_game/lev	java/src/org/enigma_game/resources	java/src/org/enigma_game/resources/schemas	java/src/org/enigma_game/util
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/enigma-game-svn/2007-April/index.html" >
   <LINK REL="made" HREF="mailto:enigma-game-svn%40lists.berlios.de?Subject=Re%3A%20%5BEnigma-game-svn%5D%20r684%20-%20in%20branches/eval%3A%20.%20java%20java/src%0A%09java/src/org%20java/src/org/enigma_game%20java/src/org/enigma_game/lev%0A%09java/src/org/enigma_game/resources%0A%09java/src/org/enigma_game/resources/schemas%0A%09java/src/org/enigma_game/util&In-Reply-To=%3C200704062058.l36Kwf1Q010777%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000121.html">
   <LINK REL="Next"  HREF="000123.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Enigma-game-svn] r684 - in branches/eval: . java java/src	java/src/org java/src/org/enigma_game java/src/org/enigma_game/lev	java/src/org/enigma_game/resources	java/src/org/enigma_game/resources/schemas	java/src/org/enigma_game/util</H1>
    <B>ral at BerliOS</B> 
    <A HREF="mailto:enigma-game-svn%40lists.berlios.de?Subject=Re%3A%20%5BEnigma-game-svn%5D%20r684%20-%20in%20branches/eval%3A%20.%20java%20java/src%0A%09java/src/org%20java/src/org/enigma_game%20java/src/org/enigma_game/lev%0A%09java/src/org/enigma_game/resources%0A%09java/src/org/enigma_game/resources/schemas%0A%09java/src/org/enigma_game/util&In-Reply-To=%3C200704062058.l36Kwf1Q010777%40sheep.berlios.de%3E"
       TITLE="[Enigma-game-svn] r684 - in branches/eval: . java java/src	java/src/org java/src/org/enigma_game java/src/org/enigma_game/lev	java/src/org/enigma_game/resources	java/src/org/enigma_game/resources/schemas	java/src/org/enigma_game/util">ral at mail.berlios.de
       </A><BR>
    <I>Fri Apr  6 22:58:41 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000121.html">[Enigma-game-svn] r683 - in branches/1.0: data/schemas src/gui	src/lev
</A></li>
        <LI>Next message: <A HREF="000123.html">[Enigma-game-svn] r685 - in branches/1.0/data/levels: enigma_cross	enigma_esprit enigma_ii enigma_iii enigma_iv enigma_v enigma_vi
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#122">[ date ]</a>
              <a href="thread.html#122">[ thread ]</a>
              <a href="subject.html#122">[ subject ]</a>
              <a href="author.html#122">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: ral
Date: 2007-04-06 22:58:39 +0200 (Fri, 06 Apr 2007)
New Revision: 684

Added:
   branches/eval/java/
   branches/eval/java/build.xml
   branches/eval/java/src/
   branches/eval/java/src/org/
   branches/eval/java/src/org/enigma_game/
   branches/eval/java/src/org/enigma_game/EnigmaUtil.java
   branches/eval/java/src/org/enigma_game/Xore5.java
   branches/eval/java/src/org/enigma_game/lev/
   branches/eval/java/src/org/enigma_game/lev/LevelScore.java
   branches/eval/java/src/org/enigma_game/lev/LevelpackManager.java
   branches/eval/java/src/org/enigma_game/lev/RatingManager.java
   branches/eval/java/src/org/enigma_game/lev/ScoreManager.java
   branches/eval/java/src/org/enigma_game/lev/UserManager.java
   branches/eval/java/src/org/enigma_game/resources/
   branches/eval/java/src/org/enigma_game/resources/schemas/
   branches/eval/java/src/org/enigma_game/resources/schemas/users.xsd
   branches/eval/java/src/org/enigma_game/util/
   branches/eval/java/src/org/enigma_game/util/LevelEvaluation.java
   branches/eval/java/src/org/enigma_game/util/RatingDiff.java
   branches/eval/java/src/org/enigma_game/util/ScoreEvaluation.java
   branches/eval/java/src/org/enigma_game/util/ScoreRegistration.java
   branches/eval/java/src/org/enigma_game/util/UserEvaluation.java
   branches/eval/java/src/org/enigma_game/util/UserRename.java
Log:
Branch eval:
- add of evalutation java sources as used for March 2007



Added: branches/eval/java/build.xml
===================================================================
--- branches/eval/java/build.xml	2007-04-06 11:47:23 UTC (rev 683)
+++ branches/eval/java/build.xml	2007-04-06 20:58:39 UTC (rev 684)
@@ -0,0 +1,110 @@
+&lt;?xml version=&quot;1.0&quot;?&gt;
+&lt;project name=&quot;EnigmaUtil&quot; default=&quot;all&quot; basedir=&quot;.&quot;&gt;
+    &lt;description&gt; 
+    Enigma utilities ant main build file
+    &lt;/description&gt;
+        
+    &lt;property name=&quot;src&quot;   value=&quot;src&quot;/&gt;
+    &lt;property name=&quot;build&quot; value=&quot;build&quot;/&gt;
+    &lt;property name=&quot;lib&quot;   value=&quot;lib&quot;/&gt;
+    &lt;property name=&quot;doc&quot;   value=&quot;doc&quot;/&gt;
+    &lt;patternset id=&quot;resources&quot;&gt;
+	&lt;include name=&quot;org/enigma_game/resources/**/*&quot;/&gt;
+    &lt;/patternset&gt;
+    
+
+    &lt;target name=&quot;init&quot;&gt;  
+        &lt;tstamp/&gt;
+        &lt;mkdir dir=&quot;${build}&quot;/&gt;
+        &lt;mkdir dir=&quot;${lib}&quot;/&gt;
+        &lt;mkdir dir=&quot;${doc}&quot;/&gt;
+    &lt;/target&gt;
+
+    &lt;!-- all --&gt;
+    &lt;target name=&quot;all&quot; depends=&quot;init, app, jar, doc&quot; 
+            description=&quot;Build the whole project&quot;&gt;
+    &lt;/target&gt;
+    
+    &lt;!-- classes --&gt;
+    &lt;target name=&quot;classes&quot; depends=&quot;init&quot;
+            description=&quot;Compile modified java sources only&quot;&gt;
+        &lt;javac srcdir=&quot;${src}&quot; destdir=&quot;${build}&quot; source=&quot;5&quot;/&gt;
+    &lt;/target&gt;
+    
+    &lt;!-- app --&gt;
+    &lt;target name=&quot;app&quot; depends=&quot;init&quot;
+            description=&quot;Compile complete application&quot;&gt;
+        &lt;delete&gt;
+	    &lt;fileset dir=&quot;${build}&quot; includes=&quot;**/*.class&quot;/&gt;
+	&lt;/delete&gt;
+        &lt;javac srcdir=&quot;${src}&quot; destdir=&quot;${build}&quot; source=&quot;5&quot; debug=&quot;on&quot;/&gt;
+        &lt;copy todir=&quot;${build}&quot;&gt;
+	    &lt;fileset dir=&quot;${src}&quot;&gt;
+		&lt;patternset refid=&quot;resources&quot;/&gt;
+	    &lt;/fileset&gt;
+	&lt;/copy&gt;
+        &lt;copy todir=&quot;${build}/org/enigma_game/resources/schemas&quot;&gt;
+            &lt;fileset dir=&quot;../data/schemas/&quot;&gt;
+                &lt;include name=&quot;score.xsd&quot;/&gt;
+                &lt;include name=&quot;index.xsd&quot;/&gt;
+                &lt;include name=&quot;ratings.xsd&quot;/&gt;
+                &lt;include name=&quot;ratings.xml&quot;/&gt;
+            &lt;/fileset&gt;
+        &lt;/copy&gt;
+        &lt;copy todir=&quot;${build}/org/enigma_game/resources/levelpacks&quot;&gt;
+            &lt;fileset dir=&quot;../data/levels/enigma_cross&quot;&gt;
+                &lt;include name=&quot;*.xml&quot;/&gt;
+            &lt;/fileset&gt;
+        &lt;/copy&gt;
+        &lt;copy todir=&quot;${build}/org/enigma_game/resources/levelpacks&quot;&gt;
+            &lt;fileset dir=&quot;../data/levels&quot;&gt;
+                &lt;include name=&quot;*/index.xml&quot;/&gt;
+            &lt;/fileset&gt;
+            &lt;mapper type=&quot;glob&quot; from=&quot;*${file.separator}index.xml&quot; to=&quot;*.xml&quot;/&gt;
+        &lt;/copy&gt;
+    &lt;/target&gt;
+    
+    &lt;!-- run --&gt;
+    &lt;target name=&quot;run&quot; 
+            description=&quot;Run application on build directory&quot;&gt;
+        &lt;java classname=&quot;org.enigma_game.EnigmaUtil&quot; fork=&quot;true&quot; dir=&quot;${build}&quot;&gt;
+	    &lt;assertions&gt;
+	      &lt;enable/&gt;
+	    &lt;/assertions&gt;
+	&lt;/java&gt;
+	
+
+    &lt;/target&gt;
+
+    &lt;!-- jar --&gt;
+    &lt;target name=&quot;jar&quot; depends=&quot;init, app&quot;
+            description=&quot;Complile app and generate jar&quot;&gt;
+        &lt;jar destfile=&quot;${lib}/EnigmaUtil.jar&quot; basedir=&quot;${build}&quot;&gt;
+	    &lt;manifest&gt;
+		&lt;attribute name=&quot;Main-Class&quot; value=&quot;org.enigma_game.EnigmaUtil&quot;/&gt;
+	    &lt;/manifest&gt;
+        &lt;/jar&gt;
+    &lt;/target&gt;
+    
+    &lt;!-- doc --&gt;
+    &lt;target name=&quot;doc&quot; depends=&quot;init&quot;
+            description=&quot;Generate javadoc&quot;&gt;
+	&lt;delete&gt;
+	    &lt;fileset dir=&quot;${doc}&quot; includes=&quot;**/*&quot;/&gt;
+	&lt;/delete&gt;
+	&lt;javadoc destdir=&quot;${doc}&quot; source=&quot;5&quot; author=&quot;true&quot; Private=&quot;true&quot;&gt;
+	    &lt;packageset dir=&quot;${src}&quot;/&gt;
+	&lt;/javadoc&gt;
+    &lt;/target&gt;
+
+    &lt;!-- clean --&gt;
+    &lt;target name=&quot;clean&quot; description=&quot;Clean up all&quot;&gt;
+	&lt;delete dir=&quot;${build}&quot;/&gt;
+	&lt;delete dir=&quot;${lib}&quot;/&gt;    
+	&lt;delete dir=&quot;${doc}&quot;/&gt;
+	&lt;delete&gt;
+	    &lt;fileset dir=&quot;${src}&quot; defaultexcludes=&quot;no&quot; includes=&quot;**/*~&quot;/&gt;
+	&lt;/delete&gt;
+    &lt;/target&gt;
+    
+&lt;/project&gt;
\ No newline at end of file


Property changes on: branches/eval/java/build.xml
___________________________________________________________________
Name: svn:eol-style
   + native

Added: branches/eval/java/src/org/enigma_game/EnigmaUtil.java
===================================================================
--- branches/eval/java/src/org/enigma_game/EnigmaUtil.java	2007-04-06 11:47:23 UTC (rev 683)
+++ branches/eval/java/src/org/enigma_game/EnigmaUtil.java	2007-04-06 20:58:39 UTC (rev 684)
@@ -0,0 +1,163 @@
+/*
+ * Copyright (C) 2006, 2007 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+// Xerces-J problems:
+//   pretty printing  needs 2.8.0
+//   class resource urls work on parser but not on Resolver, LSInput?
+//   appendNode - LSSerializer 2.6.2 - fixed XERCES-J-969, o.k. in 2.9.0
+//   doc.createElem -&gt; localName not specified on serialization, doc.createElemNS(null,) is o.k.
+
+// This is just an internal tool that is developed in rapid prototyping manner.
+// Do not expect many comments or a well designed architecture!
+
+package org.enigma_game;
+
+import javax.xml.parsers.*;
+import org.xml.sax.*;
+import java.io.*;
+import java.util.*;
+import org.w3c.dom.*;
+import org.w3c.dom.DOMConfiguration;
+import org.w3c.dom.DOMError;
+import org.w3c.dom.DOMErrorHandler;
+import org.w3c.dom.Document;
+import org.w3c.dom.Element;
+import org.w3c.dom.Node;
+import org.w3c.dom.bootstrap.DOMImplementationRegistry;
+import org.w3c.dom.ls.*;
+import org.apache.xerces.dom.DOMImplementationImpl;
+
+import org.enigma_game.util.LevelEvaluation;
+import org.enigma_game.util.RatingDiff;
+import org.enigma_game.util.ScoreRegistration;
+import org.enigma_game.util.ScoreEvaluation;
+import org.enigma_game.util.UserEvaluation;
+import org.enigma_game.util.UserRename;
+
+public class EnigmaUtil implements DOMErrorHandler, LSResourceResolver {
+    public static EnigmaUtil theApp;
+    public final static String RESOURCES = &quot;/org/enigma_game/resources/&quot;;
+    public final static String W3C_XML_SCHEMA =  &quot;<A HREF="http://www.w3.org/2001/XMLSchema">http://www.w3.org/2001/XMLSchema</A>&quot;;
+
+    public LSParser domParser;
+    public LSSerializer domWriter;
+    public DOMImplementationLS domImpl;
+    
+    private DOMConfiguration parserConfig;
+
+    Document doc;
+
+    public EnigmaUtil(String[] args) {
+        theApp = this;
+        if (args[0].equals(&quot;-?&quot;)) {
+            System.out.println(&quot;EnigmaUtil - a system tool for evaluation of scores.&quot;);
+            System.out.println(&quot;Options: java -jar EnigmaUtil -r oldRating.xml newRating.xml&quot;);
+            System.out.println(&quot;  score registration: -s enigma.score oldRating.xml users.xml&quot;);
+            System.out.println(&quot;  user renaming:      -r oldRating.xml newRating.xml users.xml&quot;);
+            System.out.println(&quot;  new rating eval.:   -e oldRating.xml newRating.xml users.xml *.zip&quot;);
+            System.out.println(&quot;  rating diff:        -d oldRating.xml newRating.xml&quot;);
+            System.out.println(&quot;  user evaluation:    -u newRating.xml users.xml *.zip&quot;);
+            System.out.println(&quot;  level evalustion:   -l rating.xml users.xml key *.zip&quot;);
+            System.exit(1);
+        }
+        try {
+            // get DOM 5.0 internal Implementation using DOM Registry
+            System.setProperty(DOMImplementationRegistry.PROPERTY,
+              //&quot;com.sun.org.apache.xerces.internal.dom.DOMXSImplementationSourceImpl&quot;);
+              &quot;org.apache.xerces.dom.DOMXSImplementationSourceImpl&quot;);
+            DOMImplementationRegistry registry = DOMImplementationRegistry.newInstance();
+            domImpl = (DOMImplementationLS)registry.getDOMImplementation(&quot;LS&quot;);
+    
+            if (domImpl == null)
+                System.out.println(&quot;LS domImpl is null&quot;);
+            else
+                System.out.println(&quot;LS domImpl is valid&quot;);
+            
+            // create DOMBuilder
+            domParser = domImpl.createLSParser(DOMImplementationLS.MODE_SYNCHRONOUS, null);
+            
+            parserConfig = domParser.getDomConfig();
+
+            // set error handler
+            parserConfig.setParameter(&quot;error-handler&quot;, this);
+            
+            // set resource-resolver
+            parserConfig.setParameter(&quot;resource-resolver&quot;, this);
+            
+            // set validation feature
+            parserConfig.setParameter(&quot;validate&quot;,Boolean.TRUE);
+            
+            // namespace by default, datatypenormalization ?
+            
+            // set schema language
+            parserConfig.setParameter(&quot;schema-type&quot;, &quot;<A HREF="http://www.w3.org/2001/XMLSchema">http://www.w3.org/2001/XMLSchema</A>&quot;);
+                        
+            // create DOMWriter
+            domWriter = domImpl.createLSSerializer();
+            
+            DOMConfiguration  config = domWriter.getDomConfig();
+            config.setParameter(&quot;error-handler&quot;, this);
+            //config.setParameter(&quot;discard-default-content&quot;, Boolean.FALSE);
+            config.setParameter(&quot;format-pretty-print&quot;, Boolean.TRUE); // only support by Xerces 2.8.0++
+        } catch ( Exception ex ) {
+            ex.printStackTrace();
+        }
+
+        if (args[0].equals(&quot;-d&quot;)) {
+            new RatingDiff(args[1], args[2]);
+        } else if (args[0].equals(&quot;-s&quot;)) {
+            new ScoreRegistration(args[1], args[2], args[3]);
+        } else if (args[0].equals(&quot;-r&quot;)) {
+            new UserRename(args[1], args[2], args[3]);
+        } else if (args[0].equals(&quot;-e&quot;)) {
+            new ScoreEvaluation(args[1], args[2], args[3], args, 4);
+        } else if (args[0].equals(&quot;-u&quot;)) {
+            new UserEvaluation(args[1], args[2], args, 3);
+        } else if (args[0].equals(&quot;-l&quot;)) {
+            new LevelEvaluation(args[1], args[2],  args[3], args, 4);
+        }
+    }
+
+    public boolean handleError(DOMError error){
+        short severity = error.getSeverity();
+        if (severity == DOMError.SEVERITY_ERROR) {
+            System.out.println(&quot;[dom3-error]: &quot;+error.getMessage());
+        }
+
+        if (severity == DOMError.SEVERITY_WARNING) {
+            System.out.println(&quot;[dom3-warning]: &quot;+error.getMessage());
+        }
+        return true;
+
+    }
+    
+    public LSInput resolveResource(String type, String namespaceURI, String publicId,
+            String systemId, String baseURI) {
+        LSInput input = domImpl.createLSInput();
+        //System.out.println(&quot;resolve: &quot; + systemId);
+        InputStream iStream = EnigmaUtil.class.getResourceAsStream(RESOURCES +
+                &quot;schemas/&quot; + systemId);
+        BufferedInputStream bStream = new BufferedInputStream(iStream);
+        input.setByteStream(bStream);
+        return input;
+    }
+    
+    public static void main(String[] args) {
+        new EnigmaUtil(args);
+    }
+}


Property changes on: branches/eval/java/src/org/enigma_game/EnigmaUtil.java
___________________________________________________________________
Name: svn:eol-style
   + native

Added: branches/eval/java/src/org/enigma_game/Xore5.java
===================================================================
--- branches/eval/java/src/org/enigma_game/Xore5.java	2007-04-06 11:47:23 UTC (rev 683)
+++ branches/eval/java/src/org/enigma_game/Xore5.java	2007-04-06 20:58:39 UTC (rev 684)
@@ -0,0 +1,32 @@
+/*
+ * Copyright (C) 2006, 2007 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+package org.enigma_game;
+
+import java.io.*;
+
+public class Xore5 {
+    public static void main(String args[]) throws IOException {
+        BufferedInputStream in = new BufferedInputStream(new FileInputStream(args[0]));
+        BufferedOutputStream out = new BufferedOutputStream(new FileOutputStream(args[1]));
+        int c;
+        while ((c = in.read()) != -1)
+           out.write(c ^ 0xE5);
+        out.flush();
+    }
+}


Property changes on: branches/eval/java/src/org/enigma_game/Xore5.java
___________________________________________________________________
Name: svn:eol-style
   + native

Added: branches/eval/java/src/org/enigma_game/lev/LevelScore.java
===================================================================
--- branches/eval/java/src/org/enigma_game/lev/LevelScore.java	2007-04-06 11:47:23 UTC (rev 683)
+++ branches/eval/java/src/org/enigma_game/lev/LevelScore.java	2007-04-06 20:58:39 UTC (rev 684)
@@ -0,0 +1,537 @@
+/*
+ * Copyright (C) 2006, 2007 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+package org.enigma_game.lev;
+
+import java.util.*; 
+import org.w3c.dom.*;
+import org.enigma_game.lev.UserManager;
+
+public class LevelScore {
+    Element elem;
+    static String currentRel = &quot;1.00&quot;;
+    boolean isDiffSolved = false;
+    boolean isEasySolved = false;
+    int bsd = -1;
+    String bsdh;
+    Set&lt;String&gt; oldBsdh = new HashSet&lt;String&gt;();      // legacy old scores
+    Set&lt;String&gt; oldConfBsdh = new HashSet&lt;String&gt;();  // confirmed old scores
+    Set&lt;String&gt; newConfBsdh = new HashSet&lt;String&gt;();  // confirmed new scores
+    int bse = -1;
+    String bseh;
+    Set&lt;String&gt; oldBseh = new HashSet&lt;String&gt;();
+    Set&lt;String&gt; oldConfBseh = new HashSet&lt;String&gt;();
+    Set&lt;String&gt; newConfBseh = new HashSet&lt;String&gt;();
+    double pareSum;  // harm average: sum 1/score
+    double pardSum;
+    int numProfE;
+    int numProfD;
+    int solvne;   // num
+    int solvpe;   // percentage * 100
+    int solvnd;
+    int solvpd;
+    int avgurNum;
+    int avgurSum;
+    String title = &quot;&quot;;
+    String author = &quot;&quot;;
+    String relPath = &quot;&quot;;
+    boolean hasEasy = true;
+    boolean partOfCurDist = false;
+    int userScoreDiff;
+    int userScoreEasy;
+    boolean userDiffSolved = false;
+    boolean userEasySolved = false;
+    static Map&lt;String, Integer&gt; wrHolders = new HashMap&lt;String, Integer&gt;();
+    static Map&lt;String, Integer&gt; wrSharers = new HashMap&lt;String, Integer&gt;();
+    boolean fullEval = false;
+    Map&lt;Integer, String&gt; scoresDiff = new TreeMap&lt;Integer, String&gt;();
+    Map&lt;Integer, String&gt; scoresEasy = new TreeMap&lt;Integer, String&gt;();
+    
+    static void printWRStatistics(UserManager userMgr) {
+        Map&lt;String, Integer&gt; wrHoldersTotal = new HashMap&lt;String, Integer&gt;(wrHolders);
+        System.out.println(&quot;Unique Worldrecords:&quot;);
+        for (Map.Entry&lt;String, Integer&gt; entry : wrHolders.entrySet()) {
+            System.out.println(&quot;  &quot; + entry.getValue() + &quot; &quot;+ entry.getKey());
+        }
+        System.out.println(&quot;Shared Worldrecords:&quot;);
+        for (Map.Entry&lt;String, Integer&gt; entry : wrSharers.entrySet()) {
+            System.out.println(&quot;  &quot; + entry.getValue() + &quot; &quot;+ entry.getKey());
+            Integer numUniqueWr = wrHoldersTotal.get(entry.getKey());
+            wrHoldersTotal.put(entry.getKey(), (numUniqueWr == null 
+                        ? entry.getValue()
+                        : numUniqueWr + entry.getValue()));
+        }
+        
+        Map&lt;Integer, String&gt; wrRanking = new TreeMap&lt;Integer, String&gt;();
+        for (Map.Entry&lt;String, Integer&gt; entry : wrHoldersTotal.entrySet()) {
+            String wrHolders = wrRanking.get(entry.getValue());
+            wrRanking.put(entry.getValue(), (wrHolders == null ? entry.getKey()
+                        : wrHolders + &quot; + &quot; + entry.getKey()));
+        }
+        System.out.println(&quot;Worldrecords Total Ranking:&quot;);
+        for (Map.Entry&lt;Integer, String&gt; entry : wrRanking.entrySet()) {
+            if (!entry.getValue().equals(&quot;&quot;))
+                System.out.println(&quot;  &quot; + entry.getKey() + &quot; &quot;+ entry.getValue());
+        }
+        
+        for (String userId : userMgr.getUserIds()) {
+            String name = userMgr.getValue(userId, &quot;name&quot;);
+            Integer wrUnique = wrHolders.get(name);
+            Integer wrShared = wrSharers.get(name);
+            int sharedWRcount = ((wrShared != null) ? wrShared : 0);
+            int totalWRrcount = ((wrUnique != null) ? wrUnique : 0) + sharedWRcount;
+            
+            Formatter formatterWRtotal = new Formatter(Locale.US);
+            formatterWRtotal.format(&quot;%3d&quot;,  totalWRrcount);
+            userMgr.setValue(userId, &quot;wrtotal&quot;, formatterWRtotal.toString());
+            
+            Formatter formatterWRshared = new Formatter(Locale.US);
+            formatterWRshared.format(&quot;%3d&quot;,  sharedWRcount);
+            userMgr.setValue(userId, &quot;wrshared&quot;, formatterWRshared.toString());
+        }
+    }
+    
+    public LevelScore(Element e, String bestScoreDiff, String bestScoreDiffHolder,
+            String bestScoreEasy, String bestScoreEasyHolder) {
+        elem = e;
+        if (bestScoreDiff.length() &gt; 0)
+            bsd = Integer.parseInt(bestScoreDiff);
+        bsdh = bestScoreDiffHolder;
+        oldBsdh.addAll(Arrays.asList(bsdh.split(&quot;\\x2B&quot;))); // &quot;+&quot;
+        if (bestScoreEasy.length() &gt; 0)
+            bse = Integer.parseInt(bestScoreEasy);
+        bseh = bestScoreEasyHolder;
+        oldBseh.addAll(Arrays.asList(bseh.split(&quot;\\x2B&quot;))); // &quot;+&quot;
+    }
+    
+    public void renameUser(String oldname, String newname) {
+        if (oldBsdh.remove(oldname)) {
+            oldBsdh.add(newname);
+            String holders = &quot;&quot;;
+            for(String name : oldBsdh) {
+                holders += name + &quot;+&quot;;
+            }
+            if (holders.endsWith(&quot;+&quot;))
+                holders = holders.substring(0, holders.length() -1);
+            elem.setAttributeNS(null, &quot;bsdh&quot;, holders);
+        }
+        if (oldBseh.remove(oldname)) {
+            oldBseh.add(newname);
+            String holders = &quot;&quot;;
+            for(String name : oldBseh) {
+                holders += name + &quot;+&quot;;
+            }
+            if (holders.endsWith(&quot;+&quot;))
+                holders = holders.substring(0, holders.length() -1);
+            elem.setAttributeNS(null, &quot;bseh&quot;, holders);
+        }
+    }
+    
+    public void addIndexInfo(String levelTitle, String levelAuthor, 
+            String rPath,  String hasEasyMode) {
+        partOfCurDist = true;
+        title = levelTitle;
+        author = levelAuthor;
+        relPath = rPath;
+        if (hasEasyMode.length() &gt; 0)
+            hasEasy = Boolean.parseBoolean(hasEasyMode);
+    }
+    
+    public void setFullEvaluation(String pattern) {
+        if (elem.getAttribute(&quot;id&quot;).contains(pattern) ||
+                author.contains(pattern) || title.contains(pattern) ||
+                relPath.contains(pattern)) {
+            fullEval = true;
+        }
+    }
+    
+    public boolean isPartOfCurDist() {
+        return partOfCurDist;
+    }
+    
+    public String getTitle() {
+        return title;
+    }
+    
+    public boolean hasEasyMode() {
+        return hasEasy;
+    }
+    
+    public boolean isDiffSolved() {
+        return isDiffSolved;
+    }
+    
+    public boolean isEasySolved() {
+        return isEasySolved;
+    }
+    
+    public double getParDiff() {
+        String parStr = elem.getAttribute(&quot;pard&quot;);
+        double par = -1;
+        if (parStr.length() &gt; 0)
+            par = Double.parseDouble(parStr);
+        return par;
+    }
+    
+    public double getParEasy() {
+        String parStr = elem.getAttribute(&quot;pare&quot;);
+        double par = -1;
+        if (parStr.length() &gt; 0)
+            par = Double.parseDouble(parStr);
+        return par;
+    }
+    
+    public int getRatingNum() {
+        return avgurNum;
+    }
+    
+    public double getRatingAvg() {
+        if (avgurNum &gt;  0)
+            return (double)avgurSum/avgurNum;
+        else
+            return -1;
+    }
+    
+    public String getAuthor() {
+        return author;
+    }
+    
+    public String getId() {
+        return elem.getAttribute(&quot;id&quot;);
+    }
+    
+    public boolean hasUserDiffSolved() {
+        return userDiffSolved;
+    }
+    
+    public boolean hasUserEasySolved() {
+        return userEasySolved;
+    }
+    
+    public int getUserScoreDiff() {
+        return userScoreDiff;
+    }
+    
+    public int getUserScoreEasy() {
+        return userScoreEasy;
+    }
+    
+    public boolean isUserWRHolderDiff() {
+        return userScoreDiff &gt;= 0 &amp;&amp; userScoreDiff == bsd;
+    }
+    
+    public boolean isUserWRHolderEasy() {
+        return userScoreEasy &gt;= 0 &amp;&amp; userScoreEasy == bse;
+    }
+    
+    public boolean isUniqueWRDiff() {
+        return oldBsdh.size() + oldConfBsdh.size() + newConfBsdh.size() == 1;
+    }
+    
+    public boolean isUniqueWREasy() {
+        return oldBseh.size() + oldConfBseh.size() + newConfBseh.size() == 1;
+    }
+    
+    public void resetUserSolved() {
+        userScoreDiff = -1;
+        userScoreEasy = -1;
+        userDiffSolved = false;
+        userEasySolved = false;
+    }
+    
+    public void registerSolvage(String userName, String diffStr, String easyStr) {
+        if (diffStr.length() &gt; 0)
+            userScoreDiff = Integer.parseInt(diffStr);
+        if (easyStr.length() &gt; 0)
+            userScoreEasy = Integer.parseInt(easyStr);
+        
+        // user solved ?
+        if (userScoreDiff &gt;= 0) {
+            userDiffSolved = true;
+            if (fullEval) {
+                String tieUsers = scoresDiff.get(userScoreDiff);
+                scoresDiff.put(userScoreDiff, tieUsers == null ? userName :
+                        tieUsers + &quot;+&quot; + userName); 
+            }
+        }
+        if (userScoreEasy &gt;= 0) {
+            userEasySolved = true;
+            if (fullEval) {
+                String tieUsers = scoresEasy.get(userScoreEasy);
+                scoresEasy.put(userScoreEasy, tieUsers == null ? userName :
+                        tieUsers + &quot;+&quot; + userName); 
+            }
+        }
+    }
+    
+    public void printLevelEvaluation() {
+        if( fullEval) {
+            System.out.println(&quot;&quot;);
+            System.out.println(&quot;Level &quot; + elem.getAttribute(&quot;id&quot;)
+                    + &quot;  '&quot; + title + &quot;' by &quot; + author);
+            for (Map.Entry&lt;Integer, String&gt; entry : scoresDiff.entrySet()) {
+                System.out.println(entry.getKey() + &quot;  &quot; +  entry.getValue());
+            }
+            if (hasEasy) {
+                System.out.println(&quot;&quot;);
+                System.out.println(&quot;Easy mode:&quot;);
+                for (Map.Entry&lt;Integer, String&gt; entry : scoresEasy.entrySet()) {
+                    System.out.println(entry.getKey() + &quot;  &quot; +  entry.getValue());
+                }
+            }
+        }
+    }
+    
+    public void registerScore(String user, boolean isProfessional, String rating, 
+            String diffStr, String diffRel, String easyStr, String easyRel,
+            String diff2Str, String diff2Rel, String easy2Str, String easy2Rel) {
+        int usd = -1;
+        int use = -1;
+        int usd2 = -1;
+        int use2 = -1;
+        int urat = -1;
+        if (diffStr.length() &gt; 0)
+            usd = Integer.parseInt(diffStr);
+        if (easyStr.length() &gt; 0)
+            use = Integer.parseInt(easyStr);
+        if (diff2Str.length() &gt; 0)
+            usd2 = Integer.parseInt(diff2Str);
+        if (easy2Str.length() &gt; 0)
+            use2 = Integer.parseInt(easy2Str);
+        if (rating.length() &gt; 0)
+            urat = Integer.parseInt(rating);
+        
+        // solved with current release?
+        if ((usd &gt;= 0 &amp;&amp; diffRel.equals(currentRel)) 
+                || (usd2 &gt;= 0 &amp;&amp; diff2Rel.equals(currentRel))) {
+            isDiffSolved = true;
+        }
+        if ((use &gt;= 0 &amp;&amp; easyRel.equals(currentRel))
+                || (use2 &gt;= 0 &amp;&amp; easy2Rel.equals(currentRel))) {
+            isEasySolved = true;
+        }
+        
+        if (usd &gt;= 0) {
+            if (usd &lt; bsd || bsd == -1) {
+                // new world record
+                bsd = usd;
+                newConfBsdh.clear();
+                newConfBsdh.add(user);
+                oldBsdh.clear();
+                oldConfBsdh.clear();
+            } else if (usd == bsd) {
+                // same as world record
+                if (oldBsdh.contains(user)) {
+                    oldBsdh.remove(user);
+                    oldConfBsdh.add(user);
+                } else {
+                    newConfBsdh.add(user);
+                }
+            }
+            solvnd++;
+            if (usd == 0)
+                usd = 1;
+            if (isProfessional) {
+                pardSum += 1.0/usd;
+                numProfD++;
+            }
+        }
+        if (use &gt;= 0) {
+            if (use &lt; bse || bse == -1) {
+                // new world record
+                bse = use;
+                newConfBseh.clear();
+                newConfBseh.add(user);
+                oldBseh.clear();
+                oldConfBseh.clear();
+            } else if (use == bse) {
+                // same as world record
+                if (oldBseh.contains(user)) {
+                    oldBseh.remove(user);
+                    oldConfBseh.add(user);
+                } else {
+                    newConfBseh.add(user);
+                }
+            }
+            solvne++;
+            if (use == 0)
+                use = 1;
+            if (isProfessional) {
+                pareSum += 1.0/use;
+                numProfE++;
+            }
+        }
+        if (urat &gt;= 0) {
+            avgurNum++;
+            avgurSum += urat;
+        }
+    }
+    
+    public void finish(int numUsers, int numProf) {
+        elem.setAttributeNS(null, &quot;bsd&quot;, Integer.toString(bsd));
+        
+        String holders = &quot;&quot;;
+        if (oldBsdh.isEmpty() &amp;&amp; oldConfBsdh.isEmpty()) {
+            for(String name : newConfBsdh)
+                holders += name + &quot;+&quot;;
+        } else {
+            for(String name : oldConfBsdh)
+                holders += name + &quot;+&quot;;
+            for(String name : newConfBsdh)   // we may omit new record holders
+                holders += name + &quot;+&quot;;       // if there are too many 
+            for(String name : oldBsdh)
+                holders += name + &quot;+&quot;;
+        }
+        if (holders.endsWith(&quot;+&quot;))
+            holders = holders.substring(0, holders.length() -1);
+        elem.setAttributeNS(null, &quot;bsdh&quot;, holders);
+        
+        elem.setAttributeNS(null, &quot;bse&quot;, Integer.toString(bse));
+        
+        holders = &quot;&quot;;
+        if (oldBseh.isEmpty() &amp;&amp; oldConfBseh.isEmpty()) {
+            for(String name : newConfBseh)
+                holders += name + &quot;+&quot;;
+        } else {
+            for(String name : oldConfBseh)
+                holders += name + &quot;+&quot;;
+            for(String name : newConfBseh)   // we may omit new record holders
+                holders += name + &quot;+&quot;;       // if there are too many 
+            for(String name : oldBseh)
+                holders += name + &quot;+&quot;;
+        }
+        if (holders.endsWith(&quot;+&quot;))
+            holders = holders.substring(0, holders.length() -1);
+        elem.setAttributeNS(null, &quot;bseh&quot;, holders);
+        
+        if (solvne == 0) {
+            pareSum = -1;
+        } else {
+            // rate profs that did not solve level as 10 * world record
+            double subScore = 10.0 * Math.max(bse, 1.0);
+            pareSum = (double)numProf / (pareSum + (numProf - numProfE)/subScore) + 0.5;
+            if (pareSum &gt;= (99*60+59.5))
+                pareSum =  -1;
+        }
+        elem.setAttributeNS(null, &quot;pare&quot;, Integer.toString((int)pareSum));
+
+        if (solvnd == 0) {
+            pardSum = -1;
+        } else {
+            // rate profs that did not solve level as 10 * world record
+            double subScore = 10.0 * Math.max(bsd, 1.0);
+            pardSum = (double)numProf / (pardSum + (numProf - numProfD)/subScore) + 0.5;
+            if (pardSum &gt;= (99*60+59.5))
+                pardSum =  -1;
+        }
+        elem.setAttributeNS(null, &quot;pard&quot;, Integer.toString((int)pardSum));
+
+        elem.setAttributeNS(null, &quot;solvne&quot;, Integer.toString(solvne));
+        solvpe = solvne * 10000 / numUsers;
+        elem.setAttributeNS(null, &quot;solvpe&quot;, Integer.toString(solvpe));
+        
+        elem.setAttributeNS(null, &quot;solvnd&quot;, Integer.toString(solvnd));
+        solvpd = solvnd * 10000 / numUsers;
+        elem.setAttributeNS(null, &quot;solvpd&quot;, Integer.toString(solvpd));
+        
+        int avgur = -1;
+        if (avgurNum &gt;  0)
+            avgur = avgurSum * 10 / avgurNum;
+        elem.setAttributeNS(null, &quot;avgur&quot;, Integer.toString(avgur));
+        
+        // worldrecord holder statistics
+        int numWRHolder = oldBsdh.size() + oldConfBsdh.size() + newConfBsdh.size();
+        if (numWRHolder &gt; 1) {
+            for(String name : newConfBsdh) {
+                Integer n = wrSharers.get(name);
+                wrSharers.put(name, (n == null ? 1 : n+1));
+            }
+            for(String name : oldConfBsdh) {
+                Integer n = wrSharers.get(name);
+                wrSharers.put(name, (n == null ? 1 : n+1));
+            }
+            for(String name : oldBsdh) {
+                Integer n = wrSharers.get(name);
+                wrSharers.put(name, (n == null ? 1 : n+1));
+            }
+        } else {
+            for(String name : newConfBsdh) {
+                Integer n = wrHolders.get(name);
+                wrHolders.put(name, (n == null ? 1 : n+1));
+            }
+            for(String name : oldConfBsdh) {
+                Integer n = wrHolders.get(name);
+                wrHolders.put(name, (n == null ? 1 : n+1));
+            }
+            for(String name : oldBsdh) {
+                Integer n = wrHolders.get(name);
+                wrHolders.put(name, (n == null ? 1 : n+1));
+            }
+        }
+        if (hasEasy) {
+            numWRHolder = oldBseh.size() + oldConfBseh.size() + newConfBseh.size();
+            if (numWRHolder &gt; 1) {
+                for(String name : newConfBseh) {
+                    Integer n = wrSharers.get(name);
+                    wrSharers.put(name, (n == null ? 1 : n+1));
+                }
+                for(String name : oldConfBseh) {
+                    Integer n = wrSharers.get(name);
+                    wrSharers.put(name, (n == null ? 1 : n+1));
+                }
+                for(String name : oldBseh) {
+                    Integer n = wrSharers.get(name);
+                    wrSharers.put(name, (n == null ? 1 : n+1));
+                }
+            } else {
+                for(String name : newConfBseh) {
+                    Integer n = wrHolders.get(name);
+                    wrHolders.put(name, (n == null ? 1 : n+1));
+                }
+                for(String name : oldConfBseh) {
+                    Integer n = wrHolders.get(name);
+                    wrHolders.put(name, (n == null ? 1 : n+1));
+                }
+                for(String name : oldBseh) {
+                    Integer n = wrHolders.get(name);
+                    wrHolders.put(name, (n == null ? 1 : n+1));
+                }
+            }
+        }
+    }
+    
+    public static class ComparatorRating implements Comparator&lt;LevelScore&gt; {
+        public ComparatorRating() {
+        }
+        
+        public int compare(LevelScore ls1, LevelScore ls2) {
+            if (ls1.getRatingAvg() &gt; ls2.getRatingAvg())
+                return -1;
+            else if (ls1.getRatingAvg() &lt; ls2.getRatingAvg())
+                return 1;
+            else {
+                if (ls1.getRatingNum() &gt; ls2.getRatingNum())
+                    return -1;
+                else if (ls1.getRatingNum() &lt; ls2.getRatingNum())
+                    return 1;
+                else
+                    return 0;
+            }
+        }
+    }
+}


Property changes on: branches/eval/java/src/org/enigma_game/lev/LevelScore.java
___________________________________________________________________
Name: svn:eol-style
   + native

Added: branches/eval/java/src/org/enigma_game/lev/LevelpackManager.java
===================================================================
--- branches/eval/java/src/org/enigma_game/lev/LevelpackManager.java	2007-04-06 11:47:23 UTC (rev 683)
+++ branches/eval/java/src/org/enigma_game/lev/LevelpackManager.java	2007-04-06 20:58:39 UTC (rev 684)
@@ -0,0 +1,79 @@
+/*
+ * Copyright (C) 2006, 2007 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+package org.enigma_game.lev;
+
+import java.io.*;
+import java.util.*; 
+import org.w3c.dom.*;
+import org.w3c.dom.ls.*;
+
+import org.enigma_game.EnigmaUtil;
+import org.enigma_game.lev.RatingManager;
+import org.enigma_game.lev.LevelScore;
+
+public class LevelpackManager {
+    EnigmaUtil theApp = org.enigma_game.EnigmaUtil.theApp;
+    Document doc;
+    NodeList levelElems;
+    String name;
+    List&lt;LevelScore&gt; levelScores = new ArrayList&lt;LevelScore&gt;();
+    
+    public LevelpackManager(String levelpack) {
+        name = levelpack;
+        LSInput input = theApp.domImpl.createLSInput();
+        InputStream iStream = LevelpackManager.class.getResourceAsStream(
+                EnigmaUtil.RESOURCES +
+                &quot;levelpacks/&quot; + levelpack + &quot;.xml&quot;);
+        BufferedInputStream bStream = new BufferedInputStream(iStream);
+        input.setByteStream(bStream);
+        doc = theApp.domParser.parse(input);
+        
+        DOMConfiguration config = doc.getDomConfig();
+        config.setParameter(&quot;error-handler&quot;, theApp);
+        
+        levelElems = doc.getElementsByTagName(&quot;level&quot;);
+    }
+    
+    public void registerLevels(RatingManager ratingMgr) {
+        for (int i = 0; i &lt; levelElems.getLength(); i++) {
+            Element e = (Element) levelElems.item(i);
+            LevelScore ls = ratingMgr.getLevelScore(e.getAttribute(&quot;id&quot;),
+                    e.getAttribute(&quot;score&quot;));
+            if (ls == null) {
+                ls = ratingMgr.newLevelScore(e.getAttribute(&quot;id&quot;),
+                    e.getAttribute(&quot;score&quot;));
+            }
+            ls.addIndexInfo(e.getAttribute(&quot;_title&quot;), e.getAttribute(&quot;author&quot;),
+                    e.getAttribute(&quot;_xpath&quot;), e.getAttribute(&quot;easy&quot;));
+            levelScores.add(ls);
+        }
+    }
+    
+    public String getName() {
+        return name;
+    }
+    
+    public List&lt;LevelScore&gt; getLevelScores() {
+        return levelScores;
+    }
+    
+    public int size() {
+        return levelScores.size();
+    }
+}


Property changes on: branches/eval/java/src/org/enigma_game/lev/LevelpackManager.java
___________________________________________________________________
Name: svn:eol-style
   + native

Added: branches/eval/java/src/org/enigma_game/lev/RatingManager.java
===================================================================
--- branches/eval/java/src/org/enigma_game/lev/RatingManager.java	2007-04-06 11:47:23 UTC (rev 683)
+++ branches/eval/java/src/org/enigma_game/lev/RatingManager.java	2007-04-06 20:58:39 UTC (rev 684)
@@ -0,0 +1,450 @@
+/*
+ * Copyright (C) 2006, 2007 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+package org.enigma_game.lev;
+
+import java.io.*;
+import java.text.*;
+import java.util.*; 
+import javax.xml.datatype.*;
+import org.w3c.dom.*;
+import org.w3c.dom.ls.*;
+
+import org.enigma_game.EnigmaUtil;
+import org.enigma_game.lev.LevelScore;
+import org.enigma_game.lev.LevelpackManager;
+import org.enigma_game.lev.UserManager;
+
+public class RatingManager {
+    EnigmaUtil theApp = org.enigma_game.EnigmaUtil.theApp;
+    Document doc;
+    Element updateElem;
+    Element levelsElem;
+    NodeList levelElems;
+    Map&lt;String, LevelScore&gt; levelScores = new HashMap&lt;String, LevelScore&gt;();
+    List&lt;LevelpackManager&gt; levelPacks = new ArrayList&lt;LevelpackManager&gt;();
+    int numDifficult;
+    int numEasy;
+    int numProf = 0;
+    static double log_2 = Math.log(2.0);
+    
+    public RatingManager(String url) {
+        doc = theApp.domParser.parseURI(url);
+        
+        DOMConfiguration config = doc.getDomConfig();
+        config.setParameter(&quot;error-handler&quot;, theApp);
+        // set validation feature
+        config.setParameter(&quot;validate&quot;, Boolean.FALSE);
+        config.setParameter(&quot;schema-type&quot;, &quot;<A HREF="http://www.w3.org/2001/XMLSchema">http://www.w3.org/2001/XMLSchema</A>&quot;);
+        //config.setParameter(&quot;schema-location&quot;,&quot;data/personal.xsd&quot;);
+        
+        updateElem = (Element) doc.getElementsByTagName(&quot;update&quot;).item(0);
+        levelsElem = (Element) doc.getElementsByTagName(&quot;levels&quot;).item(0);
+        levelElems = doc.getElementsByTagName(&quot;level&quot;);
+    }
+    
+    public void setUpLevelScores(String levelPattern) {
+        for (int i = 0; i &lt; levelElems.getLength(); i++) {
+            Element e = (Element) levelElems.item(i);
+            String key = e.getAttribute(&quot;id&quot;) + &quot;_&quot; + e.getAttribute(&quot;sv&quot;);
+            LevelScore ls = new LevelScore(e, e.getAttribute(&quot;bsd&quot;),
+                    e.getAttribute(&quot;bsdh&quot;), e.getAttribute(&quot;bse&quot;), e.getAttribute(&quot;bseh&quot;));
+            levelScores.put(key, ls);
+        }
+        LevelpackManager lpmgr;
+        lpmgr = new LevelpackManager(&quot;enigma0_92_1&quot;);
+        lpmgr.registerLevels(this);
+        levelPacks.add(lpmgr);
+        lpmgr = new LevelpackManager(&quot;enigma0_92_2&quot;);
+        lpmgr.registerLevels(this);
+        levelPacks.add(lpmgr);
+        lpmgr = new LevelpackManager(&quot;enigma0_92_3&quot;);
+        lpmgr.registerLevels(this);
+        levelPacks.add(lpmgr);
+        lpmgr = new LevelpackManager(&quot;newlevels&quot;);
+        lpmgr.registerLevels(this);
+        levelPacks.add(lpmgr);
+        lpmgr = new LevelpackManager(&quot;enigma_tutorial&quot;);
+        lpmgr.registerLevels(this);
+        levelPacks.add(lpmgr);
+        lpmgr = new LevelpackManager(&quot;enigma_i&quot;);
+        lpmgr.registerLevels(this);
+        levelPacks.add(lpmgr);
+        lpmgr = new LevelpackManager(&quot;enigma_ii&quot;);
+        lpmgr.registerLevels(this);
+        levelPacks.add(lpmgr);
+        lpmgr = new LevelpackManager(&quot;enigma_iii&quot;);
+        lpmgr.registerLevels(this);
+        levelPacks.add(lpmgr);
+        lpmgr = new LevelpackManager(&quot;enigma_iv&quot;);
+        lpmgr.registerLevels(this);
+        levelPacks.add(lpmgr);
+        lpmgr = new LevelpackManager(&quot;enigma_v&quot;);
+        lpmgr.registerLevels(this);
+        levelPacks.add(lpmgr);
+        lpmgr = new LevelpackManager(&quot;enigma_vi&quot;);
+        lpmgr.registerLevels(this);
+        levelPacks.add(lpmgr);
+        lpmgr = new LevelpackManager(&quot;enigma_esprit&quot;);
+        lpmgr.registerLevels(this);
+        levelPacks.add(lpmgr);
+        lpmgr = new LevelpackManager(&quot;enigma_oxyd&quot;);
+        lpmgr.registerLevels(this);
+        levelPacks.add(lpmgr);
+        lpmgr = new LevelpackManager(&quot;enigma_peroxyd&quot;);
+        lpmgr.registerLevels(this);
+        levelPacks.add(lpmgr);
+        lpmgr = new LevelpackManager(&quot;enigma_oxydextra&quot;);
+        lpmgr.registerLevels(this);
+        levelPacks.add(lpmgr);
+        lpmgr = new LevelpackManager(&quot;enigma_oxydmagnum&quot;);
+        lpmgr.registerLevels(this);
+        levelPacks.add(lpmgr);
+        lpmgr = new LevelpackManager(&quot;enigma_sokoban&quot;);
+        lpmgr.registerLevels(this);
+        levelPacks.add(lpmgr);
+        lpmgr = new LevelpackManager(&quot;enigma_microban&quot;);
+        lpmgr.registerLevels(this);
+        levelPacks.add(lpmgr);
+        lpmgr = new LevelpackManager(&quot;enigma_mas_microban&quot;);
+        lpmgr.registerLevels(this);
+        levelPacks.add(lpmgr);
+        
+        for(Map.Entry&lt;String, LevelScore&gt; entry : levelScores.entrySet()) {
+            if (entry.getValue().isPartOfCurDist()) {
+                numDifficult++;
+                if (entry.getValue().hasEasyMode()) {
+                    numEasy++;
+                }
+            }
+            if (!levelPattern.equals(&quot;&quot;)) {
+                entry.getValue().setFullEvaluation(levelPattern);
+            }
+        }
+    }
+    
+    public LevelScore getLevelScore(String id, String scoreVersion) {
+        return levelScores.get(id + &quot;_&quot; + scoreVersion);
+    }
+    
+    public LevelScore newLevelScore(String id, String scoreVersion) {
+        Element level = doc.createElementNS(null, &quot;level&quot;);
+        level.setAttributeNS(null, &quot;id&quot;, id);
+        level.setAttributeNS(null, &quot;sv&quot;, scoreVersion);
+        levelsElem.appendChild(level);
+        
+        LevelScore ls = new LevelScore(level, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;);
+        String key = id + &quot;_&quot; + scoreVersion;
+        levelScores.put(key, ls);
+        
+        System.out.println(&quot;Missing Rating: id '&quot; + id + &quot;' score version &quot;
+                + scoreVersion);
+        return ls;
+    }
+    
+    public void clearUserScores() {
+        for(Map.Entry&lt;String, LevelScore&gt; entry : levelScores.entrySet()) {
+            if (entry.getValue().isPartOfCurDist()) {
+                entry.getValue().resetUserSolved();
+            }
+        }
+    }
+    
+    public boolean isUserProfessional(UserManager userMgr, String userId) {
+        boolean isProfessional = false;
+        int userDiffCount = 0;
+        int userEasyCount = 0;
+        for(Map.Entry&lt;String, LevelScore&gt; entry : levelScores.entrySet()) {
+            LevelScore ls = entry.getValue();
+            if (ls.isPartOfCurDist()) {
+                if (ls.hasUserDiffSolved())
+                    userDiffCount++;
+//              else
+//                  System.out.println(&quot;Diff &quot; + ls.getTitle() + &quot; by &quot; + ls.getAuthor() + &quot; id &quot; +  ls.getId());
+                if (ls.hasEasyMode()) {
+                    if (ls.hasUserEasySolved())
+                        userEasyCount++;
+//                  else
+//                      System.out.println(&quot;Easy &quot; + ls.getTitle() + &quot; by &quot; + ls.getAuthor() + &quot; id &quot; +  ls.getId());
+                }
+            }
+        }
+        double solvedPercent = 100.0 * (userDiffCount + userEasyCount)/(numDifficult + numEasy);
+        Formatter formatter = new Formatter(Locale.US);
+        formatter.format(&quot;Solved diff %3d/%3d - easy %3d/%3d = %6.2f%%&quot;, userDiffCount,
+                numDifficult, userEasyCount, numEasy, solvedPercent);
+        System.out.println(formatter.toString());
+        if (solvedPercent &gt; 10.0) {
+            isProfessional = true;
+            numProf++;
+        }
+        Formatter formatterTotal = new Formatter(Locale.US);
+        formatterTotal.format(&quot;%6.2f&quot;,  solvedPercent);
+        userMgr.setValue(userId, &quot;solvedtotal&quot;, formatterTotal.toString());
+        
+        Formatter formatterEasy = new Formatter(Locale.US);
+        formatterEasy.format(&quot;%3d/%3d&quot;, userEasyCount, numEasy);
+        userMgr.setValue(userId, &quot;solvede&quot;, formatterEasy.toString());
+        
+        Formatter formatterDiff = new Formatter(Locale.US);
+        formatterDiff.format(&quot;%3d/%3d&quot;, userDiffCount, numDifficult);
+        userMgr.setValue(userId, &quot;solvedd&quot;, formatterDiff.toString());
+        
+        return isProfessional;
+    }
+    
+    public void evaluateUser(UserManager userMgr, String userId) {
+        System.out.println(&quot;Par Evalutation&quot;);
+        StringBuilder sb = new StringBuilder();
+        Formatter formatter = new Formatter(sb, Locale.US);
+        
+        for (LevelpackManager lpm : levelPacks) {
+            double hcpe = 0;
+            double hcpd = 0;
+            for (LevelScore ls : lpm.getLevelScores()) {
+                double dhcpd = levelHcp(ls.getUserScoreDiff(), ls.getParDiff());
+                hcpd += dhcpd;
+                if (ls.hasEasyMode())
+                    hcpe += levelHcp(ls.getUserScoreEasy(), ls.getParEasy());
+                else
+                    hcpe += dhcpd;
+            }
+            hcpd = hcpd * 100.0 / lpm.size();
+            hcpe = hcpe * 100.0 / lpm.size();
+            formatter.format(&quot;%25s  Diff = %6.1f  Easy = %6.1f%n&quot;,
+                    lpm.getName(), hcpd, hcpe);
+        }
+        double hcpsum = 0;
+        int levelsum = 0;
+        double hcpsumsolved = 0;
+        int levelsumsolved = 0;
+        int totalWRrcount = 0;
+        int sharedWRcount = 0;
+        for(Map.Entry&lt;String, LevelScore&gt; entry : levelScores.entrySet()) {
+            LevelScore ls = entry.getValue();
+            if (ls.isPartOfCurDist()) {
+                hcpsum += levelHcp(ls.getUserScoreDiff(), ls.getParDiff());
+                levelsum++;
+                if (ls.hasUserDiffSolved()) {
+                    hcpsumsolved += levelHcp(ls.getUserScoreDiff(), ls.getParDiff());
+                    levelsumsolved++;
+                }
+                if (ls.isUserWRHolderDiff()) {
+                    totalWRrcount++;
+                    if (!ls.isUniqueWRDiff())
+                        sharedWRcount++;
+                }
+                if (ls.hasEasyMode()) {
+                    hcpsum += levelHcp(ls.getUserScoreEasy(), ls.getParEasy());
+                    levelsum++;
+                    if (ls.hasUserEasySolved()) {
+                        hcpsumsolved += levelHcp(ls.getUserScoreEasy(), ls.getParEasy());
+                        levelsumsolved++;
+                    }
+                    if (ls.isUserWRHolderEasy()) {
+                        totalWRrcount++;
+                        if (!ls.isUniqueWREasy())
+                            sharedWRcount++;
+                    }                    
+                }
+            }
+        }
+        hcpsum = hcpsum * 100.0 / levelsum;
+        int unsolved = numDifficult + numEasy - levelsumsolved;
+        hcpsumsolved += unsolved / 10.0;  // add 10% of unsolved levels as unsuccessful attempts
+        levelsumsolved += unsolved / 10;
+        hcpsumsolved = hcpsumsolved  * 100.0 / levelsumsolved;
+        formatter.format(&quot;Enigma Total Hcp = %6.1f, Solved Hcp = %6.1f at %d levels&quot;,
+                hcpsum, hcpsumsolved, levelsum);
+        System.out.println(sb.toString());
+        
+        Formatter formatterHcpTotal = new Formatter(Locale.US);
+        formatterHcpTotal.format(&quot;%6.1f&quot;,  hcpsum);
+        userMgr.setValue(userId, &quot;hcptotal&quot;, formatterHcpTotal.toString());
+        
+        Formatter formatterHcpSolved = new Formatter(Locale.US);
+        formatterHcpSolved.format(&quot;%6.1f&quot;,  hcpsumsolved);
+        userMgr.setValue(userId, &quot;hcpsolved&quot;, formatterHcpSolved.toString());
+        
+        // future direct output of WR based only on registerd scores
+//         Formatter formatterWRtotal = new Formatter(Locale.US);
+//         formatterWRtotal.format(&quot;%3d&quot;,  totalWRrcount);
+//         userMgr.setValue(userId, &quot;wrtotal&quot;, formatterWRtotal.toString());
+//         
+//         Formatter formatterWRshared = new Formatter(Locale.US);
+//         formatterWRshared.format(&quot;%3d&quot;,  sharedWRcount);
+//         userMgr.setValue(userId, &quot;wrshared&quot;, formatterWRshared.toString());
+    }
+    
+    private double levelHcp(int score, double par) {
+        double dhcp = 0;
+        if (score == -1) {
+            dhcp = 1;
+        } else if (score == -2) {
+            dhcp = 0.7;
+        } else if (score &gt;= par &amp;&amp; par &gt; 0) {
+            dhcp = Math.log10(score/par);
+            if (dhcp &gt; 0.7)
+                dhcp = 0.7;
+        } else if (score &lt; par &amp;&amp; par &gt; 0) {
+            dhcp = Math.log(score/par) / log_2;
+            if (dhcp &lt; -3)
+                dhcp = -3;
+        } else { // par &lt;= 0 no par
+            dhcp = -3;
+        }
+        return dhcp;
+    }
+    
+    public void finishLevelScores(int numUsers, UserManager userMgr) {
+        int diffSolved = 0;
+        int diffUnsolved = 0;
+        int easySolved = 0;
+        int easyUnsolved = 0;
+        for (Map.Entry&lt;String, LevelScore&gt; entry : levelScores.entrySet()) {
+            LevelScore ls = entry.getValue();
+            ls.finish(numUsers, numProf);
+            if (ls.isPartOfCurDist()) {
+                if (ls.isDiffSolved()) {
+                    diffSolved++;
+                } else {
+                    diffUnsolved++;
+                    System.out.println(&quot;Diff unsolved: &quot; + entry.getKey()
+                            + &quot; - &quot; + ls.getTitle());
+                }
+                if (ls.hasEasyMode()) {
+                    if (ls.isEasySolved()) {
+                        easySolved++;
+                    } else {
+                        easyUnsolved++;
+                        System.out.println(&quot;Easy unsolved: &quot; + entry.getKey()
+                                + &quot; - &quot; + ls.getTitle());
+                    }
+                }
+            }
+        }
+        System.out.println(&quot;Diff Levels &quot; + numDifficult + &quot; Easy Levels &quot; + numEasy);
+        System.out.println(&quot;Diff Solved &quot; + diffSolved + &quot; / Unsolved &quot; + diffUnsolved);
+        System.out.println(&quot;Easy Solved &quot; + easySolved + &quot; / Unsolved &quot; + easyUnsolved);
+        LevelScore.printWRStatistics(userMgr);
+        
+        
+        try {
+            PrintWriter output = new PrintWriter(new FileWriter(new File(&quot;top_rated_levels.txt&quot;)), true);
+            output.println(&quot;Top Rated Levels (with more than one rating)&quot;);
+            List&lt;LevelScore&gt; topRatedLevel = new ArrayList&lt;LevelScore&gt;(levelScores.values());
+            LevelScore.ComparatorRating compRating = new LevelScore.ComparatorRating();
+            Collections.sort(topRatedLevel, compRating);
+            int topPosition = 1;
+            for (LevelScore ls : topRatedLevel) {
+                if (ls.getRatingNum() &gt; 1) {
+                    Formatter formatterTopRatedLevel = new Formatter(Locale.US);
+                    formatterTopRatedLevel.format(&quot;%5.2f  %d  %-23s by %-18s (%s)&quot;,  ls.getRatingAvg(),
+                            ls.getRatingNum(), ls.getTitle(), ls.getAuthor(), ls.getId());
+                    output.println(formatterTopRatedLevel.toString());
+                    topPosition++;
+                    if (topPosition &gt; 50)
+                        break;
+                }
+            }
+        } catch (Exception e) {
+        }
+        
+    }
+    
+    public void evaluateLevels() {
+        for (Map.Entry&lt;String, LevelScore&gt; entry : levelScores.entrySet()) {
+            LevelScore ls = entry.getValue();
+            ls.printLevelEvaluation();
+        }
+    }
+    
+    public void renameUser(String oldname, String newname) {
+        for(Map.Entry&lt;String, LevelScore&gt; entry : levelScores.entrySet()) {
+            entry.getValue().renameUser(oldname, newname);
+        }
+    }
+    
+    public void save(String url) {
+        //doc.normalizeDocument();
+        System.out.println(&quot;save &quot; + url + &quot; - &quot;+ levelElems.getLength());
+        theApp.domWriter.writeToURI(doc, url);
+    }
+    
+    public String getDate() {
+        return updateElem.getAttribute(&quot;date&quot;);
+    }
+    
+    public void setDate(String date) {
+        if (date.equals(&quot;&quot;)) {
+            GregorianCalendar calendar = new GregorianCalendar(TimeZone.getTimeZone(&quot;GMT&quot;));
+            Date now = new Date();
+            calendar.setTime(now);
+            XMLGregorianCalendar xmlCal;
+            try {
+                xmlCal = DatatypeFactory.newInstance().newXMLGregorianCalendar(calendar);
+                date = xmlCal.toXMLFormat();
+            } catch( Exception ex ) {
+                System.out.println(&quot;Ratings cannot set current update time&quot;);
+                ex.printStackTrace();
+            }
+        }
+        updateElem.setAttribute(&quot;date&quot;, date);
+    }
+    
+    public String getUrlFull() {
+        return updateElem.getAttribute(&quot;urlFull&quot;);
+    }
+    
+    public void setUrlFull(String url) {
+        updateElem.setAttribute(&quot;urlFull&quot;, url);
+    }
+    
+    public String getUrlIncremental() {
+        return updateElem.getAttribute(&quot;urlIncremental&quot;);
+    }
+    
+    public void setUrlIncremental(String url) {
+        updateElem.setAttribute(&quot;urlIncremental&quot;, url);
+    }
+    
+    public Set&lt;Map&lt;String,String&gt;&gt; getRatingData() {
+        Map&lt;String, String&gt; level;
+        Set&lt;Map&lt;String,String&gt;&gt; allData = new HashSet&lt;Map&lt;String,String&gt;&gt;();
+        for (int i = 0; i &lt; levelElems.getLength(); i++) {
+            level = new HashMap&lt;String, String&gt;();
+            NamedNodeMap attributeNodes = levelElems.item(i).getAttributes();
+            for (int j = 0; j &lt; attributeNodes.getLength(); j++) {
+                Attr attr = (Attr)attributeNodes.item(j);
+                level.put(attr.getName(), attr.getValue());
+            }
+            allData.add(level);
+        }
+        return allData;
+    }
+    
+    public void addRatingData(Set&lt;Map&lt;String,String&gt;&gt; additions) {
+        for (Map&lt;String,String&gt; rating : additions) {
+            Element level = doc.createElementNS(null, &quot;level&quot;);
+            for (Map.Entry&lt;String, String&gt; attr : rating.entrySet()) {
+                level.setAttributeNS(null, attr.getKey(), attr.getValue());
+            }
+            levelsElem.appendChild(level);
+        }
+    }
+}


Property changes on: branches/eval/java/src/org/enigma_game/lev/RatingManager.java
___________________________________________________________________
Name: svn:eol-style
   + native

Added: branches/eval/java/src/org/enigma_game/lev/ScoreManager.java
===================================================================
--- branches/eval/java/src/org/enigma_game/lev/ScoreManager.java	2007-04-06 11:47:23 UTC (rev 683)
+++ branches/eval/java/src/org/enigma_game/lev/ScoreManager.java	2007-04-06 20:58:39 UTC (rev 684)
@@ -0,0 +1,259 @@
+/*
+ * Copyright (C) 2006, 2007 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+package org.enigma_game.lev;
+
+import java.io.*;
+import java.util.*; 
+import org.w3c.dom.*;
+import org.w3c.dom.ls.*;
+
+import org.enigma_game.EnigmaUtil;
+import org.enigma_game.lev.RatingManager;
+import org.enigma_game.lev.LevelScore;
+import org.enigma_game.lev.UserManager;
+
+public class ScoreManager {
+    EnigmaUtil theApp = org.enigma_game.EnigmaUtil.theApp;
+    Document doc;
+    NodeList propertyElems;
+    Element levelsElem;
+    NodeList levelElems;
+    boolean isProfessional = false;
+    short[] ctab = new short[256];
+    short pol = 0x1021;
+    
+    public ScoreManager(InputStream bStream) {
+        for (int i = 0; i &lt; 256; i++) {
+            int r = i &lt;&lt; 8;
+            for (int j = 0; j &lt; 8; j++) {
+                boolean bit = (r &amp; 0x8000) != 0;
+                r &lt;&lt;= 1;
+                if (bit)
+                    r ^= pol;
+            }
+            ctab[i] = (short)(r &amp; 0xFFFF);
+        }
+        
+        LSInput input = theApp.domImpl.createLSInput();
+        input.setByteStream(bStream);
+        doc = theApp.domParser.parse(input);
+        
+        DOMConfiguration config = doc.getDomConfig();
+        config.setParameter(&quot;error-handler&quot;, theApp);
+        
+        propertyElems = doc.getElementsByTagName(&quot;property&quot;);
+        levelsElem = (Element) doc.getElementsByTagName(&quot;levels&quot;).item(0);
+        levelElems = doc.getElementsByTagName(&quot;level&quot;);
+    }
+    
+    public void save(OutputStream bStream) {
+        LSOutput dOut = theApp.domImpl.createLSOutput();
+        dOut.setByteStream(bStream);
+        theApp.domWriter.write(doc, dOut);
+    }
+    
+    public int getScoreElemsCount() {
+        return levelElems.getLength();
+    }
+
+    public String getProperty(String key) {
+        for (int i = 0; i &lt; propertyElems.getLength(); i++) {
+            Element e = (Element) propertyElems.item(i);
+            if (e.getAttribute(&quot;key&quot;).equals(key)) {
+                if (key.equals(&quot;UserName&quot;))
+                    return e.getAttribute(&quot;value&quot;).trim();
+                else
+                    return e.getAttribute(&quot;value&quot;);
+            }
+        }
+        return &quot;&quot;;
+    }
+    
+    private String sec(String input) {
+        byte[] target = new byte[0];
+        try {
+            target = input.getBytes(&quot;UTF-8&quot;);
+        } catch (UnsupportedEncodingException e) {
+        }
+        int len = target.length;
+        int r = 0;
+        
+        for (int i = 0; i &lt; len; i++)
+            r = (r&lt;&lt;8 &amp; 0xFFFF) ^ ctab[((r &gt;&gt;&gt; 8) ^ target[i]) &amp; 0xFF];
+        Formatter formatter = new Formatter(Locale.US);
+        formatter.format(&quot;%04X&quot;, r &amp; 0xFFFF);
+        return formatter.toString();
+    }
+    
+    public boolean checkUser(UserManager userMgr) {
+        String id = getProperty(&quot;UserId&quot;);
+        String id_1_00 = getProperty(&quot;UserId1.00&quot;);
+        String userName = userMgr.getValue(id, &quot;name&quot;);
+        boolean result = false;
+        
+        if (getProperty(&quot;UserName&quot;).equals(&quot;&quot;) &amp;&amp; userName.equals(&quot;&quot;)) {
+            System.out.println(&quot;No user name given in score file!&quot;);
+            return false;
+        } else if (getProperty(&quot;UserName&quot;).contains(&quot;+&quot;)) {
+            System.out.println(&quot;User name contains '+'!&quot;);
+            return false;
+        } else if (getProperty(&quot;UserName&quot;).length() &gt; 20) {
+            System.out.println(&quot;User name too long&quot;);
+            return false;
+        }
+        
+        if (!id_1_00.equals(&quot;&quot;)) {
+            if (userMgr.getValue(id_1_00, &quot;name&quot;).equals(getProperty(&quot;UserName&quot;))) {
+                // the user did reId since last score registration - update
+                userMgr.setValue(id_1_00, &quot;id&quot;, id);
+                System.out.println(&quot;User did reId! Old Id = '&quot; + id_1_00 + &quot;'&quot;);
+                userName = userMgr.getValue(id, &quot;name&quot;);
+            } else if (!userMgr.getValue(id_1_00, &quot;id&quot;).equals(&quot;&quot;)) {
+                // a user may have reId and renamed or it is another user
+                // that used the same 1.00 id.
+                System.out.println(&quot;User id 1.00 still in use by another user&quot;);
+                return false;
+            }
+        }
+        
+        if (userName.equals(getProperty(&quot;UserName&quot;))) {
+            // user exists with same id and name
+            if (Integer.parseInt(getProperty(&quot;Count&quot;)) &gt;
+                    Integer.parseInt(userMgr.getValue(id, &quot;savecount&quot;))) {
+                userMgr.setValue(id, &quot;savecount&quot;, getProperty(&quot;Count&quot;));
+                result = true;
+            } else {
+                System.out.println(&quot;Outdated scores not registered!&quot;);
+            }
+        } else if (userName.equals(&quot;&quot;)) {
+            // no user registered with the id
+            if (userMgr.isNameFree(getProperty(&quot;UserName&quot;))) {
+                userMgr.setValue(id, &quot;name&quot;, getProperty(&quot;UserName&quot;));
+                userMgr.setValue(id, &quot;savecount&quot;, getProperty(&quot;Count&quot;));
+                result = true;
+            } else
+                System.out.println(&quot;Error - new user with name in use '&quot;
+                        + getProperty(&quot;UserName&quot;) +&quot;'&quot;);
+        } else {
+            // name mismatch - changed name or second user with same id
+            if (Integer.parseInt(getProperty(&quot;Count&quot;)) &gt;
+                    Integer.parseInt(userMgr.getValue(id, &quot;savecount&quot;))) {
+                // looks like a valid name change
+                if (getProperty(&quot;UserName&quot;).equals(&quot;&quot;)) {
+                    // do not rename to an empty name
+                    userMgr.setValue(id, &quot;savecount&quot;, getProperty(&quot;Count&quot;));
+                    return true;
+                } else if (userMgr.isNameFree(getProperty(&quot;UserName&quot;)) ||
+                    userMgr.getValue(id, &quot;newname&quot;).equals(getProperty(&quot;UserName&quot;))) {
+                    System.out.println(&quot;Warning: user name change from '&quot; 
+                            + userName + &quot;' to '&quot; + getProperty(&quot;UserName&quot;) + &quot;'&quot;);
+                    userMgr.setValue(id, &quot;newname&quot;, getProperty(&quot;UserName&quot;));
+                    userMgr.setValue(id, &quot;savecount&quot;, getProperty(&quot;Count&quot;));
+                    result = true;
+                } else {
+                    // new name in use by another user
+                    System.out.println(&quot;Error: user name change from '&quot; 
+                            + userName + &quot;' to the already used name '&quot;
+                            + getProperty(&quot;UserName&quot;) +&quot;'&quot;);
+                }
+            } else {
+                // must be a second user with the same id
+                System.out.println(&quot;Id mismatch - id already in use!&quot;);
+            }
+        }
+        return result;
+    }
+    
+    public void checkScores(RatingManager ratingMgr, UserManager userMgr, boolean checkSec) {
+        ratingMgr.clearUserScores();
+        String user = getProperty(&quot;UserName&quot;);
+        String userId = getProperty(&quot;UserId&quot;);
+        int numRatings = 0;
+        int sumRatings = 0;
+        for (int i = 0; i &lt; levelElems.getLength(); i++) {
+            Element e = (Element) levelElems.item(i);
+            LevelScore ls = ratingMgr.getLevelScore(e.getAttribute(&quot;id&quot;),
+                    e.getAttribute(&quot;version&quot;));
+            if (ls != null) {
+                String rating = e.getAttribute(&quot;rating&quot;);
+                int urat = -1;
+                if (rating.length() &gt; 0)
+                    urat = Integer.parseInt(rating);
+                if (urat &gt; -1) {
+                    numRatings++;
+                    sumRatings += urat;
+                }
+                ls.registerSolvage(user, e.getAttribute(&quot;diff1&quot;), 
+                        e.getAttribute(&quot;easy1&quot;));
+            }
+            if (checkSec) {
+                NamedNodeMap attrXMap = e.getAttributes();
+                Map&lt;String, String&gt; attrMap = new TreeMap&lt;String, String&gt;(); // sorted Map
+                for (int j = 0, k = attrXMap.getLength(); j &lt; k; j++) {
+                    Attr levelAttr = (Attr)(attrXMap.item(j));
+                    if (!levelAttr.getName().equals(&quot;sec&quot;) &amp;&amp; levelAttr.getSpecified()) 
+                        attrMap.put(levelAttr.getName(), levelAttr.getValue());
+                }
+                String target = &quot;&quot;;
+                for (Map.Entry&lt;String, String&gt; attrEntry : attrMap.entrySet())
+                    target += attrEntry.getValue();
+                target += userId;
+                if (!sec(target).equals(e.getAttribute(&quot;sec&quot;)))
+                    System.out.println(&quot;Faulty score entry!! &quot; + target + &quot; is &quot; 
+                            + sec(target) + &quot;  should be &quot; + e.getAttribute(&quot;sec&quot;));
+            }
+        }
+        double avgRating = -1.0;
+        if (numRatings &gt; 0)
+            avgRating = ((float)sumRatings)/numRatings;
+        Formatter formatter = new Formatter(Locale.US);
+        formatter.format(&quot;Ratings count %d, avg %5.2f&quot;, numRatings, avgRating);
+        System.out.println(formatter.toString());
+        
+        Formatter formatterRatcount = new Formatter(Locale.US);
+        formatterRatcount.format(&quot;%3d&quot;, numRatings);
+        userMgr.setValue(getProperty(&quot;UserId&quot;), &quot;ratcount&quot;, formatterRatcount.toString());
+        
+        Formatter formatterRatAvg = new Formatter(Locale.US);
+        formatterRatAvg.format(&quot;%5.2f&quot;,  avgRating);
+        userMgr.setValue(userId, &quot;ratavg&quot;, formatterRatAvg.toString());
+                
+        isProfessional = ratingMgr.isUserProfessional(userMgr, getProperty(&quot;UserId&quot;));
+    }
+    
+    public void evaluateScores(RatingManager ratingMgr) {
+        String user = getProperty(&quot;UserName&quot;);
+        for (int i = 0; i &lt; levelElems.getLength(); i++) {
+            Element e = (Element) levelElems.item(i);
+            LevelScore ls = ratingMgr.getLevelScore(e.getAttribute(&quot;id&quot;),
+                    e.getAttribute(&quot;version&quot;));
+            if (ls != null) {
+                String rating = e.getAttribute(&quot;rating&quot;);
+                int urat = -1;
+                if (rating.length() &gt; 0)
+                    urat = Integer.parseInt(rating);
+                ls.registerScore(user, isProfessional, rating,
+                        e.getAttribute(&quot;diff1&quot;),  e.getAttribute(&quot;diff1rel&quot;), 
+                        e.getAttribute(&quot;easy1&quot;), e.getAttribute(&quot;easy1rel&quot;),
+                        e.getAttribute(&quot;diff2&quot;),  e.getAttribute(&quot;diff2rel&quot;), 
+                        e.getAttribute(&quot;easy2&quot;), e.getAttribute(&quot;easy2rel&quot;));
+            }
+        }
+    }
+}


Property changes on: branches/eval/java/src/org/enigma_game/lev/ScoreManager.java
___________________________________________________________________
Name: svn:eol-style
   + native

Added: branches/eval/java/src/org/enigma_game/lev/UserManager.java
===================================================================
--- branches/eval/java/src/org/enigma_game/lev/UserManager.java	2007-04-06 11:47:23 UTC (rev 683)
+++ branches/eval/java/src/org/enigma_game/lev/UserManager.java	2007-04-06 20:58:39 UTC (rev 684)
@@ -0,0 +1,171 @@
+/*
+ * Copyright (C) 2006, 2007 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+package org.enigma_game.lev;
+
+import java.io.*;
+import java.text.*;
+import java.util.*; 
+import org.w3c.dom.*;
+import org.w3c.dom.ls.*;
+
+import org.enigma_game.EnigmaUtil;
+
+public class UserManager {
+    EnigmaUtil theApp = org.enigma_game.EnigmaUtil.theApp;
+    Document doc;
+    Element usersElem;
+    NodeList userElems;
+    Map&lt;String, Element&gt; idElementMap = new HashMap&lt;String, Element&gt;();
+    Set&lt;String&gt; nameSet = new HashSet&lt;String&gt;();
+    
+    public UserManager(String url) {
+        doc = theApp.domParser.parseURI(url);
+        
+        DOMConfiguration config = doc.getDomConfig();
+        config.setParameter(&quot;error-handler&quot;, theApp);
+        
+        usersElem = (Element) doc.getElementsByTagName(&quot;users&quot;).item(0);
+        userElems = doc.getElementsByTagName(&quot;user&quot;);
+        
+        for (int i = 0; i &lt; userElems.getLength(); i++) {
+            Element e = (Element) userElems.item(i);
+            idElementMap.put(e.getAttribute(&quot;id&quot;), e);
+            nameSet.add(e.getAttribute(&quot;name&quot;));
+            String newname = e.getAttribute(&quot;newname&quot;);
+            if (!newname.equals(&quot;&quot;)) {
+                nameSet.add(newname);
+            }
+        }
+    }
+    
+    public Set&lt;String&gt; getUserIds() {
+        return idElementMap.keySet();
+    }
+    
+    public boolean isNameFree(String name) {
+        return !nameSet.contains(name);
+    }
+    
+    public String getValue(String id, String key) {
+        Element e = idElementMap.get(id);
+        return e == null ? &quot;&quot; : e.getAttribute(key);
+    }
+    
+    public void setValue(String id, String key, String value) {
+        Element e = idElementMap.get(id);
+        if (e == null &amp;&amp; key.equals(&quot;name&quot;)) {
+            if (isNameFree(value)) {
+                nameSet.add(value);
+                // create element first
+                Element user = doc.createElementNS(null, &quot;user&quot;);
+                user.setAttributeNS(null, &quot;id&quot;, id);
+                user.setAttributeNS(null, &quot;name&quot;, value);
+                usersElem.appendChild(user);
+                idElementMap.put(id, user);
+            }
+        } else if (e != null) {
+            if (key.equals(&quot;newname&quot;) &amp;&amp; !value.equals(&quot;&quot;)) {
+                nameSet.add(value);
+            } else if (key.equals(&quot;id&quot;) &amp;&amp; !value.equals(&quot;&quot;)) {
+                idElementMap.put(value, e);  // add element with new id
+                idElementMap.remove(id);     // remove element with old id
+            }
+            e.setAttributeNS(null, key, value);
+        }
+    }
+    
+    public void save(String url) {
+        //doc.normalizeDocument();
+        System.out.println(&quot;save &quot; + url + &quot; - &quot;+ userElems.getLength());
+        theApp.domWriter.writeToURI(doc, url);
+    }
+    
+    public class ComparatorName implements Comparator&lt;String&gt; {
+        public ComparatorName() {
+        }
+        
+        public int compare(String id1, String id2) {
+            final Collator usCollator = Collator.getInstance(Locale.US);
+            return usCollator.compare(getValue(id1, &quot;name&quot;),getValue(id2, &quot;name&quot;));
+        }
+    }
+    
+    public class ComparatorWRTotal implements Comparator&lt;String&gt; {
+        public ComparatorWRTotal() {
+        }
+        
+        public int compare(String id1, String id2) {
+            String wrtotal1 = getValue(id1, &quot;wrtotal&quot;);
+            int wrTotal1 = (!wrtotal1.equals(&quot;&quot;)) ? Integer.parseInt(wrtotal1.trim()) : 0;
+            String wrtotal2 = getValue(id2, &quot;wrtotal&quot;);
+            int wrTotal2 = (!wrtotal2.equals(&quot;&quot;)) ? Integer.parseInt(wrtotal2.trim()) : 0;
+            String wrshared1 = getValue(id1, &quot;wrshared&quot;);
+            int wrShared1 = (!wrshared1.equals(&quot;&quot;)) ? Integer.parseInt(wrshared1.trim()) : 0;
+            String wrshared2 = getValue(id2, &quot;wrshared&quot;);
+            int wrShared2 = (!wrshared2.equals(&quot;&quot;)) ? Integer.parseInt(wrshared2.trim()) : 0;
+            int result = wrTotal2 - wrTotal1;
+            if (result == 0)
+                result = wrShared1 - wrShared2;
+            return result;
+        }
+    }
+    
+    public class ComparatorSolved implements Comparator&lt;String&gt; {
+        public ComparatorSolved() {
+        }
+        
+        public int compare(String id1, String id2) {
+            String solvedtotal1 = getValue(id1, &quot;solvedtotal&quot;);
+            double solvedTotal1 = (!solvedtotal1.equals(&quot;&quot;)) ? Double.parseDouble(solvedtotal1.trim()) : 0;
+            String solvedtotal2 = getValue(id2, &quot;solvedtotal&quot;);
+            double solvedTotal2 = (!solvedtotal2.equals(&quot;&quot;)) ? Double.parseDouble(solvedtotal2.trim()) : 0;
+            int result = ( solvedTotal1 &lt; solvedTotal2) ? 1 : ((solvedTotal1 == solvedTotal2) ? 0 : -1);
+            return result;
+        }
+    }
+    
+    public class ComparatorHcpTotal implements Comparator&lt;String&gt; {
+        public ComparatorHcpTotal() {
+        }
+        
+        public int compare(String id1, String id2) {
+            String hcptotal1 = getValue(id1, &quot;hcptotal&quot;);
+            double hcpTotal1 = (!hcptotal1.equals(&quot;&quot;)) ? Double.parseDouble(hcptotal1.trim()) : 100;
+            String hcptotal2 = getValue(id2, &quot;hcptotal&quot;);
+            double hcpTotal2 = (!hcptotal2.equals(&quot;&quot;)) ? Double.parseDouble(hcptotal2.trim()) : 100;
+            int result = ( hcpTotal1 &lt; hcpTotal2) ? -1 : ((hcpTotal1 == hcpTotal2) ? 0 : 1);
+            return result;
+        }
+    }
+    
+    public class ComparatorHcpSolved implements Comparator&lt;String&gt; {
+        public ComparatorHcpSolved() {
+        }
+        
+        public int compare(String id1, String id2) {
+            String hcpsolved1 = getValue(id1, &quot;hcpsolved&quot;);
+            double hcpSolved1 = (!hcpsolved1.equals(&quot;&quot;)) ? Double.parseDouble(hcpsolved1.trim()) : 100;
+            String hcpsolved2 = getValue(id2, &quot;hcpsolved&quot;);
+            double hcpSolved2 = (!hcpsolved2.equals(&quot;&quot;)) ? Double.parseDouble(hcpsolved2.trim()) : 100;
+            int result = ( hcpSolved1 &lt; hcpSolved2) ? -1 : ((hcpSolved1 == hcpSolved2) ? 0 : 1);
+            return result;
+        }
+    }
+    
+}


Property changes on: branches/eval/java/src/org/enigma_game/lev/UserManager.java
___________________________________________________________________
Name: svn:eol-style
   + native

Added: branches/eval/java/src/org/enigma_game/resources/schemas/users.xsd
===================================================================
--- branches/eval/java/src/org/enigma_game/resources/schemas/users.xsd	2007-04-06 11:47:23 UTC (rev 683)
+++ branches/eval/java/src/org/enigma_game/resources/schemas/users.xsd	2007-04-06 20:58:39 UTC (rev 684)
@@ -0,0 +1,40 @@
+&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
+&lt;xs:schema xmlns:xs='<A HREF="http://www.w3.org/2001/XMLSchema">http://www.w3.org/2001/XMLSchema</A>' version=&quot;0.1&quot; xml:lang=&quot;en&quot;&gt;
+  &lt;xs:annotation&gt;
+    &lt;xs:documentation&gt;
+      XML schema definitions for Enigma user
+      Copyright &#169; 2007 Ronald Lamprecht
+      GPL2
+    &lt;/xs:documentation&gt;
+  &lt;/xs:annotation&gt;
+  &lt;xs:element name=&quot;users&quot;&gt;
+    &lt;xs:annotation&gt;
+      &lt;xs:documentation&gt;
+        User data:
+        id         - level id
+      &lt;/xs:documentation&gt;
+    &lt;/xs:annotation&gt;
+    &lt;xs:complexType&gt;
+      &lt;xs:sequence&gt;
+        &lt;xs:element name=&quot;user&quot; minOccurs=&quot;0&quot; maxOccurs=&quot;unbounded&quot; &gt;
+          &lt;xs:complexType&gt;
+            &lt;xs:attribute name=&quot;id&quot; type=&quot;xs:string&quot; use=&quot;required&quot;/&gt;
+            &lt;xs:attribute name=&quot;name&quot; type=&quot;xs:string&quot; use=&quot;required&quot;/&gt;
+            &lt;xs:attribute name=&quot;newname&quot; type=&quot;xs:string&quot; use=&quot;optional&quot; default=&quot;&quot;/&gt;
+            &lt;xs:attribute name=&quot;savecount&quot; type=&quot;xs:int&quot; use=&quot;optional&quot; default=&quot;0&quot;/&gt;
+            &lt;xs:attribute name=&quot;ratcount&quot; type=&quot;xs:int&quot; use=&quot;optional&quot; default=&quot;0&quot;/&gt;
+            &lt;xs:attribute name=&quot;ratavg&quot; type=&quot;xs:float&quot; use=&quot;optional&quot; default=&quot;-1&quot;/&gt;
+            &lt;xs:attribute name=&quot;wrtotal&quot; type=&quot;xs:int&quot; use=&quot;optional&quot; default=&quot;0&quot;/&gt;
+            &lt;xs:attribute name=&quot;wrshared&quot; type=&quot;xs:int&quot; use=&quot;optional&quot; default=&quot;0&quot;/&gt;
+            &lt;xs:attribute name=&quot;solvedtotal&quot; type=&quot;xs:float&quot; use=&quot;optional&quot; default=&quot;0&quot;/&gt;
+            &lt;xs:attribute name=&quot;solvede&quot; type=&quot;xs:string&quot; use=&quot;optional&quot; default=&quot;0/0&quot;/&gt;
+            &lt;xs:attribute name=&quot;solvedd&quot; type=&quot;xs:string&quot; use=&quot;optional&quot; default=&quot;0/0&quot;/&gt;
+            &lt;xs:attribute name=&quot;hcptotal&quot; type=&quot;xs:float&quot; use=&quot;optional&quot; default=&quot;100&quot;/&gt;
+            &lt;xs:attribute name=&quot;hcpsolved&quot; type=&quot;xs:float&quot; use=&quot;optional&quot; default=&quot;100&quot;/&gt;
+            &lt;xs:anyAttribute namespace=&quot;##targetNamespace&quot; processContents=&quot;skip&quot;/&gt;
+          &lt;/xs:complexType&gt;
+        &lt;/xs:element&gt; &lt;!-- user --&gt;
+      &lt;/xs:sequence&gt;
+    &lt;/xs:complexType&gt;
+  &lt;/xs:element&gt; &lt;!-- users --&gt;
+&lt;/xs:schema&gt;


Property changes on: branches/eval/java/src/org/enigma_game/resources/schemas/users.xsd
___________________________________________________________________
Name: svn:eol-style
   + native

Added: branches/eval/java/src/org/enigma_game/util/LevelEvaluation.java
===================================================================
--- branches/eval/java/src/org/enigma_game/util/LevelEvaluation.java	2007-04-06 11:47:23 UTC (rev 683)
+++ branches/eval/java/src/org/enigma_game/util/LevelEvaluation.java	2007-04-06 20:58:39 UTC (rev 684)
@@ -0,0 +1,53 @@
+/*
+ * Copyright (C) 2006, 2007 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+package org.enigma_game.util;
+
+import java.io.*;
+import java.util.*; 
+import java.util.zip.*;
+import org.enigma_game.EnigmaUtil;
+import org.enigma_game.lev.RatingManager;
+import org.enigma_game.lev.ScoreManager;
+import org.enigma_game.lev.UserManager;
+
+public class LevelEvaluation {
+    EnigmaUtil theApp = org.enigma_game.EnigmaUtil.theApp;
+    
+    public LevelEvaluation(String rating, String userUrl, String levelPattern,
+            String[] scoreFiles, int firstIndex) {
+        try {
+            System.out.println(&quot;LevelEvaluation&quot;);
+            RatingManager ratingMgr = new RatingManager(rating);
+            ratingMgr.setUpLevelScores(levelPattern);
+            UserManager userMgr = new UserManager(userUrl);
+            
+            for (int i = firstIndex; i &lt; scoreFiles.length; i++) {
+                ZipInputStream zin = new ZipInputStream(new BufferedInputStream(new FileInputStream(scoreFiles[i])));
+                zin.getNextEntry();
+                ScoreManager scm = new ScoreManager(zin);
+                scm.checkScores(ratingMgr, userMgr, false);
+            }
+            ratingMgr.evaluateLevels();
+            
+            System.out.println(&quot;LevelEvaluation finished&quot;);
+        } catch ( Exception ex ) {
+            ex.printStackTrace();
+        }
+    }
+}


Property changes on: branches/eval/java/src/org/enigma_game/util/LevelEvaluation.java
___________________________________________________________________
Name: svn:eol-style
   + native

Added: branches/eval/java/src/org/enigma_game/util/RatingDiff.java
===================================================================
--- branches/eval/java/src/org/enigma_game/util/RatingDiff.java	2007-04-06 11:47:23 UTC (rev 683)
+++ branches/eval/java/src/org/enigma_game/util/RatingDiff.java	2007-04-06 20:58:39 UTC (rev 684)
@@ -0,0 +1,85 @@
+/*
+ * Copyright (C) 2006, 2007 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+package org.enigma_game.util;
+
+import java.util.*; 
+import org.enigma_game.EnigmaUtil;
+import org.enigma_game.lev.RatingManager;
+
+public class RatingDiff {
+    EnigmaUtil theApp = org.enigma_game.EnigmaUtil.theApp;
+    
+    public RatingDiff(String oldRatingUrl, String newRatingUrl) {
+        try {
+            System.out.println(&quot;Start building ratings diff.&quot;);
+            System.out.println(&quot;parse &quot; + oldRatingUrl);
+            RatingManager oldRating = new RatingManager(oldRatingUrl);
+            System.out.println(&quot;parse &quot; + newRatingUrl);
+            RatingManager newRating = new RatingManager(newRatingUrl);
+
+            System.out.println(&quot;parse template for incremental ratings&quot;);
+            RatingManager incRating = new RatingManager(
+                    RatingDiff.class.getResource(theApp.RESOURCES + &quot;schemas/ratings.xml&quot;).toString());
+            System.out.println(&quot;parse template for dummy incremental ratings&quot;);
+            RatingManager incDummyRating = new RatingManager(
+                    RatingDiff.class.getResource(theApp.RESOURCES + &quot;schemas/ratings.xml&quot;).toString());
+            
+            incRating.setDate(newRating.getDate());
+            incDummyRating.setDate(newRating.getDate());
+            
+            newRating.setUrlFull(oldRating.getUrlFull());
+            incRating.setUrlFull(oldRating.getUrlFull());
+            incDummyRating.setUrlFull(oldRating.getUrlFull());
+            
+            String oldUrlIncr = oldRating.getUrlIncremental();
+            String incVersionString = oldUrlIncr.substring(oldUrlIncr.length() - 7,
+                    oldUrlIncr.length() - 4);
+            int incVersion = Integer.parseInt(incVersionString);
+            
+            int incNewVersion = incVersion + 1;
+            String incNewVersionString = Integer.toString(incNewVersion);
+            if (incNewVersionString.length() == 1)
+                incNewVersionString = &quot;00&quot; + incNewVersionString;
+            else if (incVersionString.length() == 2)
+                incNewVersionString = &quot;0&quot; + incNewVersionString;
+            
+            String newUrlIncr = oldUrlIncr.substring(0, oldUrlIncr.length() - 7)
+                    + incNewVersionString + &quot;.xml&quot;;
+            
+            newRating.setUrlIncremental(newUrlIncr);
+            incRating.setUrlIncremental(newUrlIncr);
+            incDummyRating.setUrlIncremental(newUrlIncr);
+            
+            Set&lt;Map&lt;String,String&gt;&gt; oldLevels = oldRating.getRatingData();
+            Set&lt;Map&lt;String,String&gt;&gt; newLevels = newRating.getRatingData();
+            System.out.println(&quot;Level count old &quot; + oldLevels.size() + &quot; - new &quot; + newLevels.size());
+            
+            newLevels.removeAll(oldLevels);
+            System.out.println(&quot;Level count diff &quot; + newLevels.size());
+            incRating.addRatingData(newLevels);
+            
+            newRating.save(&quot;ratings.xml&quot;);
+            incRating.save(&quot;ratings_i&quot; + incVersionString + &quot;.xml&quot;);
+            incDummyRating.save(&quot;ratings_i&quot; + incNewVersionString + &quot;.xml&quot;);
+            System.out.println(&quot;Finished building ratings diff.&quot;);
+        } catch ( Exception ex ) {
+            ex.printStackTrace();
+        }
+    }
+}


Property changes on: branches/eval/java/src/org/enigma_game/util/RatingDiff.java
___________________________________________________________________
Name: svn:eol-style
   + native

Added: branches/eval/java/src/org/enigma_game/util/ScoreEvaluation.java
===================================================================
--- branches/eval/java/src/org/enigma_game/util/ScoreEvaluation.java	2007-04-06 11:47:23 UTC (rev 683)
+++ branches/eval/java/src/org/enigma_game/util/ScoreEvaluation.java	2007-04-06 20:58:39 UTC (rev 684)
@@ -0,0 +1,61 @@
+/*
+ * Copyright (C) 2006, 2007 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+package org.enigma_game.util;
+
+import java.io.*;
+import java.util.*; 
+import java.util.zip.*;
+import org.enigma_game.EnigmaUtil;
+import org.enigma_game.lev.RatingManager;
+import org.enigma_game.lev.ScoreManager;
+import org.enigma_game.lev.UserManager;
+
+public class ScoreEvaluation {
+    EnigmaUtil theApp = org.enigma_game.EnigmaUtil.theApp;
+    
+    public ScoreEvaluation(String ratingIn, String ratingOut, String userUrl,
+            String[] scoreFiles, int firstIndex) {
+        try {
+            System.out.println(&quot;ScoreEvaluation&quot;);
+            RatingManager ratingMgr = new RatingManager(ratingIn);
+            ratingMgr.setUpLevelScores(&quot;&quot;);
+            UserManager userMgr = new UserManager(userUrl);
+            
+            int numUsers = 0;
+            for (int i = firstIndex; i &lt; scoreFiles.length; i++) {
+                ZipInputStream zin = new ZipInputStream(new BufferedInputStream(new FileInputStream(scoreFiles[i])));
+                zin.getNextEntry();
+                ScoreManager scm = new ScoreManager(zin);
+                scm.checkUser(userMgr);
+                scm.checkScores(ratingMgr, userMgr, false);
+                scm.evaluateScores(ratingMgr);
+                numUsers++;
+            }
+            
+            ratingMgr.finishLevelScores(numUsers, userMgr);
+            ratingMgr.setDate(&quot;&quot;);
+            ratingMgr.save(ratingOut);
+            userMgr.save(userUrl);
+            
+            System.out.println(&quot;ScoreEvaluation finished&quot;);
+        } catch ( Exception ex ) {
+            ex.printStackTrace();
+        }
+    }
+}


Property changes on: branches/eval/java/src/org/enigma_game/util/ScoreEvaluation.java
___________________________________________________________________
Name: svn:eol-style
   + native

Added: branches/eval/java/src/org/enigma_game/util/ScoreRegistration.java
===================================================================
--- branches/eval/java/src/org/enigma_game/util/ScoreRegistration.java	2007-04-06 11:47:23 UTC (rev 683)
+++ branches/eval/java/src/org/enigma_game/util/ScoreRegistration.java	2007-04-06 20:58:39 UTC (rev 684)
@@ -0,0 +1,108 @@
+/*
+ * Copyright (C) 2006, 2007 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+package org.enigma_game.util;
+
+import java.io.*;
+import java.util.*; 
+import java.util.zip.*;
+import org.enigma_game.EnigmaUtil;
+import org.enigma_game.lev.RatingManager;
+import org.enigma_game.lev.ScoreManager;
+import org.enigma_game.lev.UserManager;
+
+public class ScoreRegistration {
+    EnigmaUtil theApp = org.enigma_game.EnigmaUtil.theApp;
+    
+    public ScoreRegistration(String url, String ratingUrl, String userUrl) {
+        try {
+            System.out.println(&quot;ScoreRegistration&quot;);
+            
+            RatingManager ratingMgr = new RatingManager(ratingUrl);
+            ratingMgr.setUpLevelScores(&quot;&quot;);
+
+            BufferedInputStream bin = new BufferedInputStream(new FileInputStream(url));
+            ByteArrayOutputStream baout = new ByteArrayOutputStream();
+            int c;
+            while ((c = bin.read()) != -1)
+                baout.write(c ^ 0xE5);
+            byte[] ba = baout.toByteArray();
+            int basize = baout.size();
+            
+            if ((ba[0x06] &amp; 0x08) == 0) {
+                // zipios++ patch needed for 1.00 beta scores:
+                //   1.00 beta did not patch the zips produced by zipios++.
+                //   The zips are malformed and unreadable by most zip 
+                //   programs including java. This is a just a minimum fix
+                //   to get the zips java readable. A more complete fix
+                //   is performed in the 1.00 Enigma sources.
+                ba[0x0E] = ba[basize - 61];  // copy CRC from end to start
+                ba[0x0F] = ba[basize - 60];
+                ba[0x10] = ba[basize - 59];
+                ba[0x11] = ba[basize - 58];
+                int compsize = basize - 77 - 39;
+                ba[0x12] = (byte)((char)(compsize &amp; 0xFF)) ;  // copy compressed size
+                ba[0x13] = (byte)((char)(compsize &amp; 0xFF00) &gt;&gt;&gt; 8);
+                ba[0x14] = (byte)((char)(compsize &amp; 0xFF0000) &gt;&gt;&gt; 16);
+                ba[0x15] = (byte)((char)(compsize &amp; 0xFF000000) &gt;&gt;&gt; 24);
+                ba[0x16] = ba[basize - 53];  // copy orig size
+                ba[0x17] = ba[basize - 52];
+                ba[0x18] = ba[basize - 51];
+                ba[0x19] = ba[basize - 50];
+            }
+            
+//             BufferedOutputStream out = new BufferedOutputStream(new FileOutputStream(&quot;score.zip&quot;));
+//             for (int i = 0; i &lt; basize; i++)
+//                 out.write(ba[i]);
+//             out.flush();
+            
+            ZipInputStream zin = new ZipInputStream(new ByteArrayInputStream(ba));
+            zin.getNextEntry();
+
+//             BufferedOutputStream out = new BufferedOutputStream(new FileOutputStream(&quot;score.xml&quot;));
+//             
+//             int co;
+//             while ((co = zin.read()) != -1)
+//                out.write(co);
+//             out.flush();
+
+            UserManager userMgr = new UserManager(userUrl);
+            
+            ScoreManager scm = new ScoreManager(zin);
+            String userId = scm.getProperty(&quot;UserId&quot;);
+            System.out.println(&quot;User '&quot; + scm.getProperty(&quot;UserName&quot;) +
+                    &quot;' - Id '&quot; + userId + &quot;'&quot;);
+            System.out.println(&quot;Score version = &quot; + scm.getProperty(&quot;Count&quot;)
+                    + &quot;, elements = &quot; + scm.getScoreElemsCount());
+            
+            if (scm.checkUser(userMgr)) {
+                scm.checkScores(ratingMgr, userMgr, true);
+    
+                ZipOutputStream zout = new ZipOutputStream (new BufferedOutputStream(
+                        new FileOutputStream(userId +&quot;.zip&quot;)));
+                ZipEntry ze = new ZipEntry(&quot;score.xml&quot;);
+                zout.putNextEntry(ze);
+                scm.save(zout);
+                zout.close();
+                userMgr.save(userUrl);
+            }
+        } catch ( Exception ex ) {
+            ex.printStackTrace();
+        }
+    }
+}


Property changes on: branches/eval/java/src/org/enigma_game/util/ScoreRegistration.java
___________________________________________________________________
Name: svn:eol-style
   + native

Added: branches/eval/java/src/org/enigma_game/util/UserEvaluation.java
===================================================================
--- branches/eval/java/src/org/enigma_game/util/UserEvaluation.java	2007-04-06 11:47:23 UTC (rev 683)
+++ branches/eval/java/src/org/enigma_game/util/UserEvaluation.java	2007-04-06 20:58:39 UTC (rev 684)
@@ -0,0 +1,176 @@
+/*
+ * Copyright (C) 2006, 2007 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+package org.enigma_game.util;
+
+import java.io.*;
+import java.util.*; 
+import java.util.zip.*;
+import org.enigma_game.EnigmaUtil;
+import org.enigma_game.lev.RatingManager;
+import org.enigma_game.lev.ScoreManager;
+import org.enigma_game.lev.UserManager;
+
+public class UserEvaluation {
+    EnigmaUtil theApp = org.enigma_game.EnigmaUtil.theApp;
+    
+    public UserEvaluation(String rating, String userUrl,
+            String[] scoreFiles, int firstIndex) {
+        try {
+            System.out.println(&quot;UserEvaluation&quot;);
+            RatingManager ratingMgr = new RatingManager(rating);
+            ratingMgr.setUpLevelScores(&quot;&quot;);
+            UserManager userMgr = new UserManager(userUrl);
+            PrintWriter htmlOut;
+            
+            GregorianCalendar calendar = new GregorianCalendar(TimeZone.getTimeZone(&quot;GMT&quot;));
+            Date now = new Date();
+            calendar.setTime(now);
+            calendar.add(Calendar.DATE, -15);  // monthly evaluation within first 2 weeks of next month
+            Formatter formatter = new Formatter(Locale.US);
+            formatter.format(&quot;%1$tB %1$tY&quot;,calendar);
+
+            int numUsers = 0;
+            for (int i = firstIndex; i &lt; scoreFiles.length; i++) {
+                ZipInputStream zin = new ZipInputStream(new BufferedInputStream(new FileInputStream(scoreFiles[i])));
+                zin.getNextEntry();
+                ScoreManager scm = new ScoreManager(zin);
+                System.out.println(&quot;User '&quot; + scm.getProperty(&quot;UserName&quot;) +
+                        &quot;' - Id '&quot; + scm.getProperty(&quot;UserId&quot;) + &quot;'&quot;);
+                scm.checkScores(ratingMgr, userMgr, false);
+                ratingMgr.evaluateUser(userMgr, scm.getProperty(&quot;UserId&quot;));
+                System.out.println(&quot;&quot;);
+                numUsers++;
+            }
+            userMgr.save(userUrl);
+            
+            System.out.println(&quot;&quot;);
+            System.out.println(&quot;User Names:&quot;);
+            htmlOut = new PrintWriter(new FileWriter(new File(&quot;userlist.html&quot;)), true);
+            htmlOut.println(&quot;&lt;div class=\&quot;usernames\&quot;&gt;&quot;);
+            htmlOut.println(&quot;Names in use:&quot;);
+            htmlOut.println(&quot;  &lt;ul&gt;&quot;);
+            List&lt;String&gt; userName = new ArrayList&lt;String&gt;(userMgr.getUserIds());
+            UserManager.ComparatorName compName = userMgr.new ComparatorName();
+            Collections.sort(userName, compName);
+            for (String id : userName) {
+                System.out.println(userMgr.getValue(id, &quot;name&quot;));
+                htmlOut.println(&quot;    &lt;li&gt;&quot; + userMgr.getValue(id, &quot;name&quot;) + &quot;&lt;/li&gt;&quot;);
+            }
+            htmlOut.println(&quot;  &lt;/ul&gt;&quot;);
+            htmlOut.println(&quot;&lt;/div&gt;&quot;);
+            htmlOut.flush();
+            
+            htmlOut = new PrintWriter(new FileWriter(new File(&quot;table-wr.html&quot;)), true);
+            System.out.println(&quot;&quot;);
+            System.out.println(&quot;Worldrecord Statistics:&quot;);
+            System.out.print(&quot;total (shared) - users&quot;);
+            htmlOut.println(&quot;  &lt;table&gt;&quot;);
+            htmlOut.println(&quot;    &lt;caption&gt;Worldrecord Statistics of &quot; + formatter.toString() + &quot;&lt;/caption&gt;&quot;);
+            htmlOut.println(&quot;    &lt;colgroup&gt;&lt;col width=\&quot;80\&quot;&gt;&lt;col width=\&quot;80\&quot;&gt;&lt;col width=\&quot;470\&quot;&gt;&lt;/colgroup&gt;&quot;);
+            htmlOut.print(&quot;    &lt;tr&gt;&lt;th&gt;total&lt;/th&gt;&lt;th&gt;shared&lt;/th&gt;&lt;th class=\&quot;left\&quot;&gt;users&lt;/th&gt;&lt;/tr&gt;&quot;);
+            List&lt;String&gt; userByWR = new ArrayList&lt;String&gt;(userMgr.getUserIds());
+            UserManager.ComparatorWRTotal compWRTotal = userMgr.new ComparatorWRTotal();
+            Collections.sort(userByWR, compWRTotal);
+            String lastId = &quot;&quot;;
+            for (String id : userByWR) {
+                if (compWRTotal.compare(lastId, id) != 0) {
+                    System.out.println(&quot;&quot;);
+                    System.out.print(&quot;  &quot; + userMgr.getValue(id, &quot;wrtotal&quot;) + &quot; (&quot;
+                            + userMgr.getValue(id, &quot;wrshared&quot;) + &quot;) - '&quot;
+                            + userMgr.getValue(id, &quot;name&quot;) + &quot;'&quot;);
+                    if (lastId.equals(&quot;&quot;))
+                        htmlOut.println(&quot;&quot;);
+                    else
+                        htmlOut.println(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);
+                    htmlOut.print(&quot;    &lt;tr&gt;&lt;td class=\&quot;num\&quot;&gt;&quot; + userMgr.getValue(id, &quot;wrtotal&quot;)
+                            + &quot;&lt;/td&gt;&lt;td class=\&quot;num\&quot;&gt;&quot; + userMgr.getValue(id, &quot;wrshared&quot;)
+                            + &quot;&lt;/td&gt;&lt;td class=\&quot;left\&quot;&gt;'&quot; + userMgr.getValue(id, &quot;name&quot;) + &quot;'&quot;);
+                } else {
+                    System.out.print(&quot;+'&quot; + userMgr.getValue(id, &quot;name&quot;) + &quot;'&quot;);
+                    htmlOut.print(&quot; + '&quot; + userMgr.getValue(id, &quot;name&quot;) + &quot;'&quot;);
+                }
+                lastId = id;
+            }
+            System.out.println(&quot;&quot;);
+            htmlOut.println(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);
+            htmlOut.println(&quot;  &lt;/table&gt;&quot;);
+            htmlOut.flush();
+
+            
+            htmlOut = new PrintWriter(new FileWriter(new File(&quot;table-solved.html&quot;)), true);
+            System.out.println(&quot;&quot;);
+            System.out.println(&quot;Solved Statistics:&quot;);
+            System.out.println(&quot;solved difficult - solved easy = total solved - user&quot;);
+            htmlOut.println(&quot;  &lt;table&gt;&quot;);
+            htmlOut.println(&quot;    &lt;caption&gt;Solved Level Statistics of &quot; + formatter.toString() + &quot;&lt;/caption&gt;&quot;);
+            htmlOut.println(&quot;    &lt;colgroup&gt;&lt;col width=\&quot;130\&quot;&gt;&lt;col width=\&quot;130\&quot;&gt;&lt;col width=\&quot;130\&quot;&gt;&lt;col width=\&quot;240\&quot;&gt;&lt;/colgroup&gt;&quot;);
+            htmlOut.println(&quot;    &lt;tr&gt;&lt;th&gt;difficult&lt;/th&gt;&lt;th&gt;easy&lt;/th&gt;&lt;th&gt;total&lt;/th&gt;&lt;th class=\&quot;left\&quot;&gt;user&lt;/th&gt;&lt;/tr&gt;&quot;);
+            List&lt;String&gt; userBySolved = new ArrayList&lt;String&gt;(userMgr.getUserIds());
+            UserManager.ComparatorSolved compSolved = userMgr.new ComparatorSolved();
+            Collections.sort(userBySolved, compSolved);
+            for (String id : userBySolved) {
+                String solvedtotal = userMgr.getValue(id, &quot;solvedtotal&quot;);
+                double solvedTotal = (!solvedtotal.equals(&quot;&quot;)) ? Double.parseDouble(solvedtotal.trim()) : 0;
+                if (solvedTotal &gt; 0) {
+                    System.out.println(&quot;  &quot; + userMgr.getValue(id, &quot;solvedd&quot;)
+                            + &quot; - &quot; + userMgr.getValue(id, &quot;solvede&quot;)        
+                            + &quot; = &quot; + userMgr.getValue(id, &quot;solvedtotal&quot;)        
+                            + &quot;%  - '&quot; + userMgr.getValue(id, &quot;name&quot;) + &quot;'&quot;);
+                    htmlOut.println(&quot;    &lt;tr&gt;&lt;td class=\&quot;num\&quot;&gt;&quot; + userMgr.getValue(id, &quot;solvedd&quot;)
+                            + &quot;&lt;/td&gt;&lt;td class=\&quot;num\&quot;&gt;&quot; + userMgr.getValue(id, &quot;solvede&quot;)
+                            + &quot;&lt;/td&gt;&lt;td class=\&quot;num\&quot;&gt;&quot; + userMgr.getValue(id, &quot;solvedtotal&quot;)
+                            + &quot;%&lt;/td&gt;&lt;td class=\&quot;left\&quot;&gt;'&quot; + userMgr.getValue(id, &quot;name&quot;) + &quot;'&lt;/td&gt;&lt;/tr&gt;&quot;);
+                }
+            }
+            System.out.println(&quot;&quot;);
+            htmlOut.println(&quot;  &lt;/table&gt;&quot;);
+            htmlOut.flush();
+           
+            htmlOut = new PrintWriter(new FileWriter(new File(&quot;table-hcp.html&quot;)), true);
+            System.out.println(&quot;&quot;);
+            System.out.println(&quot;Handicap Statistics:&quot;);
+            System.out.println(&quot;total - solved hcp - user&quot;);
+            htmlOut.println(&quot;  &lt;table&gt;&quot;);
+            htmlOut.println(&quot;    &lt;caption&gt;Handicap Statistics of &quot; + formatter.toString() + &quot;&lt;/caption&gt;&quot;);
+            htmlOut.println(&quot;    &lt;colgroup&gt;&lt;col width=\&quot;130\&quot;&gt;&lt;col width=\&quot;220\&quot;&gt;&lt;/colgroup&gt;&quot;);
+            htmlOut.println(&quot;    &lt;tr&gt;&lt;th&gt;solved hcp&lt;/th&gt;&lt;th class=\&quot;left\&quot;&gt;user&lt;/th&gt;&lt;/tr&gt;&quot;);
+            List&lt;String&gt; userByHCP = new ArrayList&lt;String&gt;(userMgr.getUserIds());
+            UserManager.ComparatorHcpSolved compHCPSolved = userMgr.new ComparatorHcpSolved();
+            Collections.sort(userByHCP, compHCPSolved);
+            for (String id : userByHCP) {
+                String hcptotal = userMgr.getValue(id, &quot;hcptotal&quot;);
+                double hcpTotal = (!hcptotal.equals(&quot;&quot;)) ? Double.parseDouble(hcptotal.trim()) : 100;
+                if (hcpTotal &lt; 100) {
+                    System.out.println(&quot;  &quot; + userMgr.getValue(id, &quot;hcptotal&quot;)
+                            + &quot;   &quot; + userMgr.getValue(id, &quot;hcpsolved&quot;)
+                            + &quot; - '&quot; + userMgr.getValue(id, &quot;name&quot;) + &quot;'&quot;);
+                    htmlOut.println(&quot;     &lt;tr&gt;&lt;td class=\&quot;num\&quot;&gt;&quot; + userMgr.getValue(id, &quot;hcpsolved&quot;)
+                            + &quot;&lt;/td&gt;&lt;td class=\&quot;left\&quot;&gt;'&quot; + userMgr.getValue(id, &quot;name&quot;) + &quot;'&lt;/td&gt;&lt;/tr&gt;&quot;);
+                }
+            }
+            System.out.println(&quot;&quot;);
+            htmlOut.println(&quot;  &lt;/table&gt;&quot;);
+            htmlOut.flush();
+            
+            System.out.println(&quot;UserEvaluation finished&quot;);
+        } catch ( Exception ex ) {
+            ex.printStackTrace();
+        }
+    }
+}


Property changes on: branches/eval/java/src/org/enigma_game/util/UserEvaluation.java
___________________________________________________________________
Name: svn:eol-style
   + native

Added: branches/eval/java/src/org/enigma_game/util/UserRename.java
===================================================================
--- branches/eval/java/src/org/enigma_game/util/UserRename.java	2007-04-06 11:47:23 UTC (rev 683)
+++ branches/eval/java/src/org/enigma_game/util/UserRename.java	2007-04-06 20:58:39 UTC (rev 684)
@@ -0,0 +1,55 @@
+/*
+ * Copyright (C) 2006, 2007 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+package org.enigma_game.util;
+
+import java.io.*;
+import java.util.*; 
+import org.enigma_game.EnigmaUtil;
+import org.enigma_game.lev.RatingManager;
+import org.enigma_game.lev.UserManager;
+
+public class UserRename {
+    EnigmaUtil theApp = org.enigma_game.EnigmaUtil.theApp;
+    
+    public UserRename(String ratingIn, String ratingOut, String userUrl) {
+        try {
+            System.out.println(&quot;User renaming&quot;);
+            RatingManager ratingMgr = new RatingManager(ratingIn);
+            ratingMgr.setUpLevelScores(&quot;&quot;);
+            UserManager userMgr = new UserManager(userUrl);
+            for (String id : userMgr.getUserIds()) {
+                String newname = userMgr.getValue(id, &quot;newname&quot;);
+                if (!newname.equals(&quot;&quot;)) {
+                    String oldname = userMgr.getValue(id, &quot;name&quot;);
+                    System.out.println(&quot;Rename '&quot; + oldname + &quot;' to '&quot; + newname + &quot;'&quot;);
+                    ratingMgr.renameUser(oldname, newname);
+                    userMgr.setValue(id, &quot;name&quot;, newname);
+                    userMgr.setValue(id, &quot;newname&quot;, &quot;&quot;);
+                }
+            }
+            ratingMgr.setDate(&quot;&quot;);
+            ratingMgr.save(ratingOut);
+            userMgr.save(userUrl);
+            
+            System.out.println(&quot;User renaming finished&quot;);
+        } catch ( Exception ex ) {
+            ex.printStackTrace();
+        }
+    }
+}


Property changes on: branches/eval/java/src/org/enigma_game/util/UserRename.java
___________________________________________________________________
Name: svn:eol-style
   + native


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000121.html">[Enigma-game-svn] r683 - in branches/1.0: data/schemas src/gui	src/lev
</A></li>
	<LI>Next message: <A HREF="000123.html">[Enigma-game-svn] r685 - in branches/1.0/data/levels: enigma_cross	enigma_esprit enigma_ii enigma_iii enigma_iv enigma_v enigma_vi
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#122">[ date ]</a>
              <a href="thread.html#122">[ thread ]</a>
              <a href="subject.html#122">[ subject ]</a>
              <a href="author.html#122">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/enigma-game-svn">More information about the Enigma-game-svn
mailing list</a><br>
</body></html>
