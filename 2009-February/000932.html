<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Enigma-game-svn] r1503 - in trunk: data data/gfx32 data/gfx40	data/gfx48 data/schemas src src/items src/others src/stones
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/enigma-game-svn/2009-February/index.html" >
   <LINK REL="made" HREF="mailto:enigma-game-svn%40lists.berlios.de?Subject=Re%3A%20%5BEnigma-game-svn%5D%20r1503%20-%20in%20trunk%3A%20data%20data/gfx32%20data/gfx40%0A%09data/gfx48%20data/schemas%20src%20src/items%20src/others%20src/stones&In-Reply-To=%3C200902022353.n12NrZQN022429%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000931.html">
   <LINK REL="Next"  HREF="000933.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Enigma-game-svn] r1503 - in trunk: data data/gfx32 data/gfx40	data/gfx48 data/schemas src src/items src/others src/stones</H1>
    <B>ral at BerliOS</B> 
    <A HREF="mailto:enigma-game-svn%40lists.berlios.de?Subject=Re%3A%20%5BEnigma-game-svn%5D%20r1503%20-%20in%20trunk%3A%20data%20data/gfx32%20data/gfx40%0A%09data/gfx48%20data/schemas%20src%20src/items%20src/others%20src/stones&In-Reply-To=%3C200902022353.n12NrZQN022429%40sheep.berlios.de%3E"
       TITLE="[Enigma-game-svn] r1503 - in trunk: data data/gfx32 data/gfx40	data/gfx48 data/schemas src src/items src/others src/stones">ral at mail.berlios.de
       </A><BR>
    <I>Tue Feb  3 00:53:35 CET 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="000931.html">[Enigma-game-svn] r1502
</A></li>
        <LI>Next message: <A HREF="000933.html">[Enigma-game-svn] r1504 - in trunk/data/levels: enigma_cross	enigma_iv enigma_vi enigma_vii enigma_viii
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#932">[ date ]</a>
              <a href="thread.html#932">[ thread ]</a>
              <a href="subject.html#932">[ subject ]</a>
              <a href="author.html#932">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: ral
Date: 2009-02-03 00:53:30 +0100 (Tue, 03 Feb 2009)
New Revision: 1503

Added:
   trunk/data/gfx32/it_bottle_broken.png
   trunk/data/gfx32/it_bottle_idle.png
   trunk/data/gfx32/it_drop.png
   trunk/data/gfx32/it_dummy.png
   trunk/data/gfx32/it_odometer.png
   trunk/data/gfx40/it_bottle_broken.png
   trunk/data/gfx40/it_bottle_idle.png
   trunk/data/gfx40/it_drop.png
   trunk/data/gfx40/it_dummy.png
   trunk/data/gfx40/it_odometer.png
   trunk/data/gfx48/it_bottle-broken.png
   trunk/data/gfx48/it_bottle_idle.png
   trunk/data/gfx48/it_drop.png
   trunk/data/gfx48/it_dummy.png
   trunk/data/gfx48/it_odometer.png
   trunk/src/items/Bottle.cc
   trunk/src/items/Bottle.hh
   trunk/src/items/Drop.cc
   trunk/src/items/Drop.hh
Removed:
   trunk/data/gfx32/it-booze-broken.png
   trunk/data/gfx32/it-booze.png
   trunk/data/gfx32/it-drop.png
   trunk/data/gfx32/it-dummy.png
   trunk/data/gfx32/it-odometer.png
   trunk/data/gfx40/it-booze-broken.png
   trunk/data/gfx40/it-booze.png
   trunk/data/gfx40/it-drop.png
   trunk/data/gfx40/it-dummy.png
   trunk/data/gfx40/it-odometer.png
   trunk/data/gfx48/it-booze-broken.png
   trunk/data/gfx48/it-booze.png
   trunk/data/gfx48/it-drop.png
   trunk/data/gfx48/it-dummy.png
   trunk/data/gfx48/it-odometer.png
Modified:
   trunk/data/api1init.lua
   trunk/data/api2init.lua
   trunk/data/models-2d.lua
   trunk/data/schemas/objects.xml
   trunk/src/Makefile.am
   trunk/src/items.cc
   trunk/src/items.hh
   trunk/src/items/CompatibilityItems.cc
   trunk/src/items/CompatibilityItems.hh
   trunk/src/items/SimpleItems.cc
   trunk/src/items/SimpleItems.hh
   trunk/src/others/CounterGadget.cc
   trunk/src/ox_magnum.cc
   trunk/src/ox_oxyd1.cc
   trunk/src/ox_peroxyd.cc
   trunk/src/oxyd.cc
   trunk/src/stones/ShogunStone.cc
Log:
Trunk 1.1: new API reengineering
- gadget counter:
  - react on state dependent action, too
- reengineering booze:
  - new class bottle item
  - it-booze -&gt; it_bottle
  - it-booze-broken -&gt; it_bottle_broken
- renaming drop item:
  - it-drop -&gt; it_drop
- renaming system items:
  - it-debris -&gt; it_debris
  - it-odometer -&gt; it_odometer
  - it-dummy -&gt; it_dummy
Note:
- odometer should not be used in Enigma mode! Use coffee instead.
- bottle, drop features are still incomplete and need to be fixed 

Modified: trunk/data/api1init.lua
===================================================================
--- trunk/data/api1init.lua	2009-02-02 18:49:22 UTC (rev 1502)
+++ trunk/data/api1init.lua	2009-02-02 23:53:30 UTC (rev 1503)
@@ -134,6 +134,8 @@
     it_bag = &quot;it-bag&quot;,
     it_blocker = &quot;it-blocker&quot;,
     it_blocker_new = &quot;it-blocker-new&quot;,
+    it_bottle_idle = &quot;it-booze&quot;,
+    it_bottle_broken = &quot;it-booze-broken&quot;,
     it_brake = &quot;it-brake&quot;,
     it_brush = &quot;it-brush&quot;,
     it_burnable_invisible = &quot;it-burnable&quot;,
@@ -153,6 +155,7 @@
     it_crack_l = &quot;it-crack3&quot;,
     it_cross = &quot;it-cross&quot;,
     it_document = &quot;it-document&quot;,
+    it_drop = &quot;it-drop&quot;,
     it_extinguisher_empty = &quot;it-extinguisher_empty&quot;,
     it_extinguisher_medium = &quot;it-extinguisher_medium&quot;,
     it_extinguisher_full = &quot;it-extinguisher&quot;,

Modified: trunk/data/api2init.lua
===================================================================
--- trunk/data/api2init.lua	2009-02-02 18:49:22 UTC (rev 1502)
+++ trunk/data/api2init.lua	2009-02-02 23:53:30 UTC (rev 1503)
@@ -84,6 +84,7 @@
 YANG      = 1
 EMPTY     = 0
 FULL      = 2
+BROKEN    = 1 
 
 -- color
 BLACK  = 0

Deleted: trunk/data/gfx32/it-booze-broken.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx32/it-booze.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx32/it-drop.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx32/it-dummy.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx32/it-odometer.png
===================================================================
(Binary files differ)

Copied: trunk/data/gfx32/it_bottle_broken.png (from rev 1502, trunk/data/gfx32/it-booze-broken.png)

Copied: trunk/data/gfx32/it_bottle_idle.png (from rev 1502, trunk/data/gfx32/it-booze.png)

Copied: trunk/data/gfx32/it_drop.png (from rev 1502, trunk/data/gfx32/it-drop.png)

Copied: trunk/data/gfx32/it_dummy.png (from rev 1502, trunk/data/gfx32/it-dummy.png)

Copied: trunk/data/gfx32/it_odometer.png (from rev 1502, trunk/data/gfx32/it-odometer.png)

Deleted: trunk/data/gfx40/it-booze-broken.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx40/it-booze.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx40/it-drop.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx40/it-dummy.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx40/it-odometer.png
===================================================================
(Binary files differ)

Copied: trunk/data/gfx40/it_bottle_broken.png (from rev 1502, trunk/data/gfx40/it-booze-broken.png)

Copied: trunk/data/gfx40/it_bottle_idle.png (from rev 1502, trunk/data/gfx40/it-booze.png)

Copied: trunk/data/gfx40/it_drop.png (from rev 1502, trunk/data/gfx40/it-drop.png)

Copied: trunk/data/gfx40/it_dummy.png (from rev 1502, trunk/data/gfx40/it-dummy.png)

Copied: trunk/data/gfx40/it_odometer.png (from rev 1502, trunk/data/gfx40/it-odometer.png)

Deleted: trunk/data/gfx48/it-booze-broken.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx48/it-booze.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx48/it-drop.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx48/it-dummy.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx48/it-odometer.png
===================================================================
(Binary files differ)

Copied: trunk/data/gfx48/it_bottle-broken.png (from rev 1502, trunk/data/gfx48/it-booze-broken.png)

Added: trunk/data/gfx48/it_bottle_idle.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/gfx48/it_bottle_idle.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Copied: trunk/data/gfx48/it_drop.png (from rev 1502, trunk/data/gfx48/it-drop.png)

Copied: trunk/data/gfx48/it_dummy.png (from rev 1502, trunk/data/gfx48/it-dummy.png)

Copied: trunk/data/gfx48/it_odometer.png (from rev 1502, trunk/data/gfx48/it-odometer.png)

Modified: trunk/data/models-2d.lua
===================================================================
--- trunk/data/models-2d.lua	2009-02-02 18:49:22 UTC (rev 1502)
+++ trunk/data/models-2d.lua	2009-02-02 23:53:30 UTC (rev 1503)
@@ -453,14 +453,14 @@
         &quot;it_bag&quot;,
         &quot;it-blackbomb&quot;,
         &quot;it-blocker&quot;,
-        &quot;it-booze&quot;,
-        &quot;it-booze-broken&quot;,
+        &quot;it_bottle_idle&quot;,
+        &quot;it_bottle_broken&quot;,
         &quot;it_document&quot;,
-        &quot;it-drop&quot;,
+        &quot;it_drop&quot;,
         &quot;it-dynamite&quot;,
         &quot;it_flag_black&quot;,
         &quot;it_flag_white&quot;,
-        &quot;it-odometer&quot;,
+        &quot;it_odometer&quot;,
         &quot;it_pencil&quot;,
         &quot;it_pin&quot;,
         &quot;it_ring&quot;,
@@ -528,7 +528,7 @@
 
 -- it-dummy
 do
-    DefTiles(&quot;it-dummy&quot;, {&quot;it-dummy&quot;, &quot;it-dummy_egg&quot;})
+    DefTiles(&quot;it_dummy&quot;, {&quot;it_dummy&quot;, &quot;it_dummy_egg&quot;})
 end
 
 -- Oil --
@@ -614,7 +614,7 @@
 do
     local images = DefSubimages(&quot;it-crack&quot;, {h=8})
     local frames = BuildFrames(images,50)
-    DefAnim(&quot;it-debris&quot;, frames)
+    DefAnim(&quot;it_debris&quot;, frames)
 
     local frames = BuildFrames({&quot;it-crack4&quot;, &quot;it-crack5&quot;, &quot;it-crack6&quot;, &quot;it-crack7&quot;, &quot;it-crack8&quot;},120)
     DefAnim(&quot;it-crack_anim&quot;, frames)

Modified: trunk/data/schemas/objects.xml
===================================================================
--- trunk/data/schemas/objects.xml	2009-02-02 18:49:22 UTC (rev 1502)
+++ trunk/data/schemas/objects.xml	2009-02-02 23:53:30 UTC (rev 1503)
@@ -385,6 +385,15 @@
     &lt;object name=&quot;it_bag&quot;/&gt;
     &lt;object name=&quot;it_blocker_new&quot; init=&quot;true&quot;&gt;
     &lt;/object&gt;
+    &lt;object name=&quot;it_bottle&quot;&gt;
+      &lt;msg name=&quot;_brush&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;it_bottle_idle&quot;&gt;
+      &lt;attr name=&quot;state&quot; value=&quot;0&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;it_bottle_broken&quot;&gt;
+      &lt;attr name=&quot;state&quot; value=&quot;1&quot;/&gt;
+    &lt;/object&gt;
     &lt;object name=&quot;it_brake&quot;/&gt;
     &lt;object name=&quot;it_brush&quot;/&gt;
     &lt;object name=&quot;it_cherry&quot;/&gt;
@@ -455,6 +464,7 @@
     &lt;object name=&quot;it_document&quot;&gt;
       &lt;attr name=&quot;text&quot;/&gt;
     &lt;/object&gt;
+    &lt;object name=&quot;it_drop&quot;/&gt;
     &lt;object name=&quot;it_extinguisher&quot;&gt;
       &lt;attr name=&quot;state&quot; max=&quot;2&quot;/&gt;
     &lt;/object&gt;

Modified: trunk/src/Makefile.am
===================================================================
--- trunk/src/Makefile.am	2009-02-02 18:49:22 UTC (rev 1502)
+++ trunk/src/Makefile.am	2009-02-02 23:53:30 UTC (rev 1503)
@@ -208,6 +208,8 @@
 	items/BrakeItem.hh	\
 	items/BlockerItem.cc	\
 	items/BlockerItem.hh	\
+	items/Bottle.cc		\
+	items/Bottle.hh		\
 	items/BurnableItem.cc	\
 	items/BurnableItem.hh	\
 	items/Coin.cc		\
@@ -220,6 +222,8 @@
 	items/CrossItem.hh	\
 	items/DocumentItem.cc	\
 	items/DocumentItem.hh	\
+	items/Drop.cc		\
+	items/Drop.hh		\
 	items/Extinguisher.cc	\
 	items/Extinguisher.hh	\
 	items/ExtraLife.cc	\

Added: trunk/src/items/Bottle.cc
===================================================================
--- trunk/src/items/Bottle.cc	2009-02-02 18:49:22 UTC (rev 1502)
+++ trunk/src/items/Bottle.cc	2009-02-02 23:53:30 UTC (rev 1503)
@@ -0,0 +1,87 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2009 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *  
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include &quot;items/Bottle.hh&quot;
+//#include &quot;errors.hh&quot;
+//#include &quot;main.hh&quot;
+#include &quot;world.hh&quot;
+
+namespace enigma {
+
+    Bottle::Bottle(int initState) : Item() {
+        state = initState;
+    }
+
+    std::string Bottle::getClass() const {
+        return &quot;it_bottle&quot;;
+    }
+    
+    Value Bottle::message(const Message &amp;m) {
+        if (state == BROKEN &amp;&amp; m.message == &quot;_brush&quot; &amp;&amp; enigma_server::GameCompatibility == GAMET_ENIGMA) {
+            if (isDisplayable()) {
+                KillItem(this-&gt;get_pos());
+                return Value();
+            }
+        }
+        return Item::message(m);
+    }
+    
+    void Bottle::on_stonehit(Stone *) {
+        if (state == IDLE) {
+            sound_event(&quot;shatter&quot;);
+            state = BROKEN;
+            init_model();
+        }
+    }
+    
+    bool Bottle::actor_hit(Actor *a) {
+        if (state == BROKEN) {
+            ActorInfo &amp;ai = * a-&gt;get_actorinfo();
+            if (!ai.grabbed &amp;&amp; a-&gt;is_on_floor()) {
+                SendMessage(a, &quot;_shatter&quot;);
+            }
+            return false;
+        } else
+            return Item::actor_hit(a);
+    }
+    
+    ItemAction Bottle::activate(Actor *a, GridPos) {
+        if (state == IDLE) {
+            SendMessage(a, &quot;_booze&quot;);
+        }
+        return ITEM_DROP;
+    }
+    
+    int Bottle::traitsIdx() const {
+        return state;
+    }
+
+    ItemTraits Bottle::traits[2] = {
+        {&quot;it_bottle_idle&quot;,  it_bottle_idle, itf_none, 0.0},
+        {&quot;it_bottle_broken&quot;,  it_bottle_idle, itf_static | itf_indestructible, 0.0},
+    };
+
+    BOOT_REGISTER_START
+        BootRegister(new Bottle(0), &quot;it_bottle&quot;);
+        BootRegister(new Bottle(0), &quot;it_bottle_idle&quot;);
+        BootRegister(new Bottle(1), &quot;it_bottle_broken&quot;);
+    BOOT_REGISTER_END
+
+} // namespace enigma


Property changes on: trunk/src/items/Bottle.cc
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/items/Bottle.hh
===================================================================
--- trunk/src/items/Bottle.hh	2009-02-02 18:49:22 UTC (rev 1502)
+++ trunk/src/items/Bottle.hh	2009-02-02 23:53:30 UTC (rev 1503)
@@ -0,0 +1,55 @@
+/*
+ * Copyright (C) 2009 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef BOTTLEITEM_HH
+#define BOTTLEITEM_HH
+
+#include &quot;items.hh&quot;
+
+namespace enigma {
+    /**
+     */
+    class Bottle : public Item {
+        CLONEOBJ(Bottle);
+        DECL_ITEMTRAITS_ARRAY(2, traitsIdx());
+
+    private:
+        enum iState {
+            IDLE,       ///&lt; 
+            BROKEN      ///&lt;  
+        };
+
+    public:
+        Bottle(int initState);
+
+        // Object interface
+        virtual std::string getClass() const;
+        virtual Value message(const Message &amp;m);
+        
+        // Item interface
+        virtual void on_stonehit(Stone *st);
+        virtual bool actor_hit(Actor *a);
+        virtual ItemAction activate(Actor* a, GridPos p);
+
+    private:
+        int traitsIdx() const;
+    };
+   
+} // namespace enigma
+
+#endif


Property changes on: trunk/src/items/Bottle.hh
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/src/items/CompatibilityItems.cc
===================================================================
--- trunk/src/items/CompatibilityItems.cc	2009-02-02 18:49:22 UTC (rev 1502)
+++ trunk/src/items/CompatibilityItems.cc	2009-02-02 23:53:30 UTC (rev 1503)
@@ -19,7 +19,7 @@
 
 #include &quot;items/CompatibilityItems.hh&quot;
 //#include &quot;errors.hh&quot;
-//#include &quot;main.hh&quot;
+#include &quot;main.hh&quot;
 #include &quot;server.hh&quot;
 #include &quot;world.hh&quot;
 
@@ -120,6 +120,22 @@
 
     DEF_ITEMTRAITSF(TwoPKillStone, &quot;it-2pkillstone&quot;, it_2pkillstone, itf_invisible | itf_fireproof);
 
+/* -------------------- DummyItem -------------------- */
+
+    Dummyitem::Dummyitem() {
+    }
+
+    void Dummyitem::on_pickup(Actor *) {
+        int code = getAttr(&quot;code&quot;);
+        Log &lt;&lt; ecl::strf(&quot;Picked up item 0x%x\n&quot;, code);
+    }
+    void Dummyitem::on_drop(Actor *) {
+        int code = getAttr(&quot;code&quot;);
+        Log &lt;&lt; ecl::strf(&quot;Dropped up item 0x%x\n&quot;, code);
+    }
+    
+    DEF_ITEMTRAITSF(Dummyitem, &quot;it_dummy&quot;, it_dummy, itf_fireproof);
+
 //----------------------------------------
 // Bridge item (for Oxyd compatibility)
 //
@@ -165,6 +181,7 @@
         BootRegister(new EasyKillStone(), &quot;it-easykillstone&quot;);
         BootRegister(new OnePKillStone(), &quot;it-1pkillstone&quot;);
         BootRegister(new TwoPKillStone(), &quot;it-2pkillstone&quot;);
+        BootRegister(new OxydBridge(), &quot;it_dummy&quot;);
         BootRegister(new OxydBridge(), &quot;it-bridge-oxyd&quot;);
         BootRegister(new OxydBridgeActive(), &quot;it-bridge-oxyd_active&quot;);
     BOOT_REGISTER_END

Modified: trunk/src/items/CompatibilityItems.hh
===================================================================
--- trunk/src/items/CompatibilityItems.hh	2009-02-02 18:49:22 UTC (rev 1502)
+++ trunk/src/items/CompatibilityItems.hh	2009-02-02 23:53:30 UTC (rev 1503)
@@ -77,6 +77,26 @@
     };
 
     /**
+     * DummyItem
+     */
+    class Dummyitem : public Item {
+        CLONEOBJ(Dummyitem);
+        DECL_ITEMTRAITS;
+    public:
+        Dummyitem();
+        
+        // Item interface
+       virtual void on_drop(Actor *a);
+       virtual void on_pickup(Actor *a);
+    };
+
+
+    /**
+     * Odometer
+     */
+    DEF_ITEM(Odometer, &quot;it_odometer&quot;, it_odometer);
+    
+    /**
      * OxydBridge
      */
     class OxydBridge : public Item {

Added: trunk/src/items/Drop.cc
===================================================================
--- trunk/src/items/Drop.cc	2009-02-02 18:49:22 UTC (rev 1502)
+++ trunk/src/items/Drop.cc	2009-02-02 23:53:30 UTC (rev 1503)
@@ -0,0 +1,113 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2009 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *  
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include &quot;items/Drop.hh&quot;
+//#include &quot;errors.hh&quot;
+#include &quot;main.hh&quot;
+#include &quot;player.hh&quot;
+#include &quot;world.hh&quot;
+
+namespace enigma {
+
+    Actor *replace_actor(Actor *olda, Actor *newa) {
+        ActorInfo *info = newa-&gt;get_actorinfo();
+        info-&gt;pos = olda-&gt;get_pos();
+        info-&gt;vel = olda-&gt;get_vel();
+
+        if (Value v = olda-&gt;getAttr(&quot;owner&quot;)) {
+            player::ReplaceActor((int)v, olda, newa);
+        }
+
+        AddActor (newa);
+        if (!YieldActor (olda)) {
+            enigma::Log &lt;&lt; &quot;Strange: could not remove old actor\n&quot;;
+        }
+        olda-&gt;hide();
+        newa-&gt;show();
+        return olda;
+    }
+
+    class DropCallback : public enigma::TimeHandler {
+        Actor *rotor;
+        Actor *old;
+    
+    public:
+        DropCallback (Actor *rotor_, Actor *old_)
+        : rotor (rotor_), old (old_)
+        {}
+
+        // TimerHandler interface
+        virtual void alarm()
+        {
+            replace_actor (rotor, old);
+
+            delete rotor;
+            delete this;
+        }
+    };
+
+/* -------------------- Drop -------------------- */
+
+    Drop::Drop() : Item() {
+    }
+
+    std::string Drop::getClass() const {
+        return &quot;it_drop&quot;;
+    }
+        
+    ItemAction Drop::activate(Actor *a, GridPos) {
+        const double ROTOR_LIFETIME = 5.0;
+
+        int     iplayer = a-&gt;getAttr(&quot;owner&quot;);
+        ActorID id      = get_id (a);
+
+        if (id == ac_marble_black || id == ac_marble_white) {
+            // Kill ALL rubberbands connected with the actor:
+            SendMessage(a, &quot;disconnect&quot;);
+            Actor *rotor = MakeActor(&quot;ac_rotor&quot;);
+            rotor-&gt;setAttr(&quot;adhesion&quot;, 1.0);
+            rotor-&gt;setAttr(&quot;controllers&quot;, iplayer+1);
+            rotor-&gt;setAttr(&quot;owner&quot;, iplayer);
+            rotor-&gt;setAttr(&quot;gohome&quot;, false);
+            rotor-&gt;setAttr(&quot;essential&quot;, a-&gt;getAttr(&quot;essential&quot;));
+            std::string essId;
+            if (Value v = a-&gt;getAttr(&quot;essential_id&quot;)) {
+                essId = v.to_string();
+            } else {
+                essId = a-&gt;get_traits().name;
+            }
+            rotor-&gt;setAttr(&quot;essential_id&quot;, Value(essId));
+
+            replace_actor (a, rotor);
+
+            GameTimer.set_alarm (new DropCallback (rotor, a),
+                                        ROTOR_LIFETIME,
+                                        false);
+        }
+        return ITEM_KILL;          // remove from inventory
+    }
+    
+    DEF_ITEMTRAITS(Drop, &quot;it_drop&quot;, it_drop);
+
+    BOOT_REGISTER_START
+        BootRegister(new Drop(), &quot;it_drop&quot;);
+    BOOT_REGISTER_END
+
+} // namespace enigma


Property changes on: trunk/src/items/Drop.cc
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/items/Drop.hh
===================================================================
--- trunk/src/items/Drop.hh	2009-02-02 18:49:22 UTC (rev 1502)
+++ trunk/src/items/Drop.hh	2009-02-02 23:53:30 UTC (rev 1503)
@@ -0,0 +1,52 @@
+/*
+ * Copyright (C) 2009 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef DROPITEM_HH
+#define DROPITEM_HH
+
+#include &quot;items.hh&quot;
+
+namespace enigma {
+    
+    /**
+     */
+    class Drop : public Item {
+        CLONEOBJ(Drop);
+        DECL_ITEMTRAITS;
+
+    private:
+        enum iState {
+            IDLE,       ///&lt; 
+            BROKEN      ///&lt;  
+        };
+
+    public:
+        Drop();
+
+        // Object interface
+        virtual std::string getClass() const;
+        
+        // Item interface
+        virtual ItemAction activate(Actor* a, GridPos p);
+
+    private:
+    };
+   
+} // namespace enigma
+
+#endif


Property changes on: trunk/src/items/Drop.hh
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/src/items/SimpleItems.cc
===================================================================
--- trunk/src/items/SimpleItems.cc	2009-02-02 18:49:22 UTC (rev 1502)
+++ trunk/src/items/SimpleItems.cc	2009-02-02 23:53:30 UTC (rev 1503)
@@ -98,6 +98,24 @@
     
     DEF_ITEMTRAITSF(DeathItem, &quot;it_death&quot;, it_death, itf_static | itf_indestructible);
 
+/* -------------------- Debris -------------------- */
+
+    Debris::Debris() {
+    }
+    
+    void Debris::animcb() { 
+        SetFloor(get_pos(), MakeFloor(&quot;fl_abyss&quot;));
+        kill();
+     }
+
+    bool Debris::actor_hit(Actor *a) {
+        SendMessage(a, &quot;_fall&quot;);
+        return false;
+    }
+
+    DEF_ITEMTRAITSF(Debris, &quot;it_debris&quot;, it_debris,
+                itf_static | itf_animation | itf_indestructible | itf_fireproof);
+    
 /* -------------------- Flag -------------------- */
 
     FlagItem::FlagItem(int type) {
@@ -360,6 +378,7 @@
         BootRegister(new Cherry(), &quot;it_cherry&quot;);
         BootRegister(new Coffee(), &quot;it_coffee&quot;);
         BootRegister(new DeathItem(), &quot;it_death&quot;);
+        BootRegister(new Debris(), &quot;it_debris&quot;);
         BootRegister(new FlagItem(0), &quot;it_flag&quot;);
         BootRegister(new FlagItem(0), &quot;it_flag_black&quot;);
         BootRegister(new FlagItem(1), &quot;it_flag_white&quot;);

Modified: trunk/src/items/SimpleItems.hh
===================================================================
--- trunk/src/items/SimpleItems.hh	2009-02-02 18:49:22 UTC (rev 1502)
+++ trunk/src/items/SimpleItems.hh	2009-02-02 23:53:30 UTC (rev 1503)
@@ -92,7 +92,23 @@
 
         // Item interface
         virtual bool actor_hit(Actor *a);
+    };
+
+    /**
+     * DeathItem
+     */
+    class Debris : public Item {
+        CLONEOBJ(Debris);
+        DECL_ITEMTRAITS;
+
+    public:
+        Debris();
         
+        // ModelCallback interface
+        virtual void animcb();
+
+        // Item interface
+        virtual bool actor_hit(Actor *a);
     };
 
     /**

Modified: trunk/src/items.cc
===================================================================
--- trunk/src/items.cc	2009-02-02 18:49:22 UTC (rev 1502)
+++ trunk/src/items.cc	2009-02-02 23:53:30 UTC (rev 1503)
@@ -155,86 +155,6 @@
     }
 }
 
-/* -------------------- Various simple items -------------------- */
-
-namespace
-{
-    DEF_ITEM(Odometer,  &quot;it-odometer&quot;, it_odometer);
-}
-
-/* -------------------- DummyItem -------------------- */
-    class Dummyitem : public Item {
-        CLONEOBJ(Dummyitem);
-        DECL_ITEMTRAITS;
-
-        void on_pickup(Actor *) {
-            int code = getAttr(&quot;code&quot;);
-            fprintf(stderr, &quot;Picked up item 0x%x\n&quot;, code);
-        }
-        void on_drop(Actor *) {
-            int code = getAttr(&quot;code&quot;);
-            fprintf(stderr, &quot;Dropped item 0x%x\n&quot;, code);
-        }
-    public:
-        Dummyitem() {}
-    };
-    DEF_ITEMTRAITSF(Dummyitem, &quot;it-dummy&quot;, it_dummy, itf_fireproof);
-
-/* -------------------- Booze -------------------- */
-
-namespace
-{
-    class Booze : public Item {
-	CLONEOBJ(Booze);
-        DECL_ITEMTRAITS;
-    public:
-	Booze() {
-	}
-    private:
-	ItemAction activate(Actor *a, GridPos) {
-	    SendMessage(a, &quot;_booze&quot;);
-	    return ITEM_DROP;
-	}
-    void on_stonehit(Stone *) {
-        sound_event(&quot;shatter&quot;);
-        replace(&quot;it-booze-broken&quot;);
-    }
-    };
-    DEF_ITEMTRAITS(Booze, &quot;it-booze&quot;, it_booze);
-}
-
-/* -------------------- Broken Booze -------------------- */
-namespace
-{
-    class BrokenBooze : public Item {
-        CLONEOBJ(BrokenBooze);
-        DECL_ITEMTRAITS;
-
-        bool actor_hit(Actor *a) {
-            ActorInfo &amp;ai = * a-&gt;get_actorinfo();
-            if (!ai.grabbed &amp;&amp; a-&gt;is_on_floor()) {
-                SendMessage(a, &quot;_shatter&quot;);
-            }
-            return false;
-        }
-
-        virtual Value message (const Message &amp;m) {
-            if (enigma_server::GameCompatibility == GAMET_ENIGMA) {
-                if (m.message == &quot;_brush&quot;) {
-                    KillItem(this-&gt;get_pos());
-                    return Value();
-                }
-            }
-            return Item::message(m);
-        }
-
-    public:
-        BrokenBooze() {}
-    };
-
-    DEF_ITEMTRAITSF(BrokenBooze, &quot;it-booze-broken&quot;, it_booze_broken, itf_static | itf_indestructible);
-}
-
 /* -------------------- Explosion -------------------- */
 namespace
 {
@@ -294,7 +214,7 @@
         void animcb() {
             if (Floor *fl = GetFloor(get_pos()))
                 if (fl-&gt;is_destructible())
-                    replace(&quot;it-debris&quot;);
+                    replace(&quot;it_debris&quot;);
                 else
                     kill();
         }
@@ -517,129 +437,17 @@
                 itf_static | itf_indestructible | itf_fireproof);
 }
 
-/* -------------------- Debris -------------------- */
-namespace
-{
-    class Debris : public Item {
-        CLONEOBJ(Debris);
-        DECL_ITEMTRAITS;
 
-        bool actor_hit(Actor *a) {
-            SendMessage(a, &quot;_fall&quot;);
-            return false;
-        }
-        void animcb() {
-            GridPos p = get_pos();
-            SetFloor(p, MakeFloor(&quot;fl_abyss&quot;));
-            KillItem(p);
-        }
-    public:
-        Debris() {}
-    };
-    DEF_ITEMTRAITSF(Debris, &quot;it-debris&quot;, it_debris,
-                itf_static | itf_animation | itf_indestructible | itf_fireproof);
-}
-
-/* -------------------- Drop -------------------- */
-
-namespace
-{
-    Actor *replace_actor (Actor *olda, Actor *newa)
-    {
-        ActorInfo *info = newa-&gt;get_actorinfo();
-        info-&gt;pos = olda-&gt;get_pos();
-        info-&gt;vel = olda-&gt;get_vel();
-
-        if (Value v = olda-&gt;getAttr(&quot;owner&quot;)) {
-            player::ReplaceActor((int)v, olda, newa);
-        }
-
-        AddActor (newa);
-        if (!YieldActor (olda)) {
-            enigma::Log &lt;&lt; &quot;Strange: could not remove old actor\n&quot;;
-        }
-        olda-&gt;hide();
-        newa-&gt;show();
-        return olda;
-    }
-
-    class DropCallback : public enigma::TimeHandler {
-        Actor *rotor;
-        Actor *old;
-    public:
-        DropCallback (Actor *rotor_, Actor *old_)
-        : rotor (rotor_), old (old_)
-        {}
-
-        // TimerHandler interface
-        virtual void alarm()
-        {
-            replace_actor (rotor, old);
-
-            delete rotor;
-            delete this;
-        }
-    };
-
-    class Drop : public Item {
-        CLONEOBJ (Drop);
-        DECL_ITEMTRAITS;
-
-        ItemAction activate(Actor *a, GridPos)
-        {
-            const double ROTOR_LIFETIME = 5.0;
-
-            int     iplayer = a-&gt;getAttr(&quot;owner&quot;);
-            ActorID id      = get_id (a);
-
-            if (id == ac_marble_black || id == ac_marble_white) {
-                // Kill ALL rubberbands connected with the actor:
-                SendMessage(a, &quot;disconnect&quot;);
-                Actor *rotor = MakeActor(&quot;ac_rotor&quot;);
-                rotor-&gt;setAttr(&quot;adhesion&quot;, 1.0);
-                rotor-&gt;setAttr(&quot;controllers&quot;, iplayer+1);
-                rotor-&gt;setAttr(&quot;owner&quot;, iplayer);
-                rotor-&gt;setAttr(&quot;gohome&quot;, false);
-                rotor-&gt;setAttr(&quot;essential&quot;, a-&gt;getAttr(&quot;essential&quot;));
-                std::string essId;
-                if (Value v = a-&gt;getAttr(&quot;essential_id&quot;)) {
-                    essId = v.to_string();
-                } else {
-                    essId = a-&gt;get_traits().name;
-                }
-                rotor-&gt;setAttr(&quot;essential_id&quot;, Value(essId));
-
-                replace_actor (a, rotor);
-
-                GameTimer.set_alarm (new DropCallback (rotor, a),
-                                            ROTOR_LIFETIME,
-                                            false);
-            }
-            return ITEM_KILL;	       // remove from inventory
-        }
-
-    public:
-        Drop() {}
-    };
-    DEF_ITEMTRAITS(Drop, &quot;it-drop&quot;, it_drop);
-}
-
 /* -------------------- Functions -------------------- */
 
 void InitItems()
 {
     RegisterItem (new BlackBomb);
     RegisterItem (new BlackBombBurning);
-    RegisterItem (new Booze);
-    RegisterItem (new BrokenBooze);
-    RegisterItem (new Debris);
-    RegisterItem (new Drop);
-    RegisterItem (new Dummyitem);
     RegisterItem (new Dynamite);
     RegisterItem (new Explosion1);
     RegisterItem (new Explosion2);
     RegisterItem (new Explosion3);
-    RegisterItem (new Odometer);
     RegisterItem (new WhiteBomb);
 }
 

Modified: trunk/src/items.hh
===================================================================
--- trunk/src/items.hh	2009-02-02 18:49:22 UTC (rev 1502)
+++ trunk/src/items.hh	2009-02-02 23:53:30 UTC (rev 1503)
@@ -34,11 +34,11 @@
         it_blackbomb,
         it_blackbomb_burning,
         it_blocker,
-        it_booze,
+        it_bottle_idle,
+        it_bottle_broken,
         it_brake,
         it_bridge_oxyd,
         it_bridge_oxyd_active,
-        it_booze_broken,
         it_brush,
         it_burnable_invisible,
         it_burnable_fireproof,

Modified: trunk/src/others/CounterGadget.cc
===================================================================
--- trunk/src/others/CounterGadget.cc	2009-02-02 18:49:22 UTC (rev 1502)
+++ trunk/src/others/CounterGadget.cc	2009-02-02 23:53:30 UTC (rev 1503)
@@ -44,7 +44,9 @@
             } else {
                 state--;
             }
-            if (Value stateTarget = getAttr(ecl::strf(&quot;target_%d&quot;, state))) {
+            Value stateTarget = getAttr(ecl::strf(&quot;target_%d&quot;, state));
+            Value stateAction = getAttr(ecl::strf(&quot;action_%d&quot;, state));
+            if (stateTarget || stateAction) {
                 performAction(true);
             }
             return Value();

Modified: trunk/src/ox_magnum.cc
===================================================================
--- trunk/src/ox_magnum.cc	2009-02-02 18:49:22 UTC (rev 1502)
+++ trunk/src/ox_magnum.cc	2009-02-02 23:53:30 UTC (rev 1503)
@@ -386,7 +386,7 @@
     UNUSED,        // OxydMagnum item 0x5d
     UNUSED,        // OxydMagnum item 0x5e
     &quot;it_sensor_filter1&quot;, // OxydMagnum item 0x5f
-    &quot;it-drop&quot;,          // OxydMagnum item 0x60 (drunk)
+    &quot;it_drop&quot;,          // OxydMagnum item 0x60 (drunk)
     UNUSED,        // OxydMagnum item 0x61 (rev. breaking are)
     UNUSED,        // OxydMagnum item 0x62 (player exchange)
     &quot;it_trigger&quot;,       // OxydMagnum item 0x63

Modified: trunk/src/ox_oxyd1.cc
===================================================================
--- trunk/src/ox_oxyd1.cc	2009-02-02 18:49:22 UTC (rev 1502)
+++ trunk/src/ox_oxyd1.cc	2009-02-02 23:53:30 UTC (rev 1503)
@@ -402,6 +402,6 @@
     UNUSED,                  // 0x5d
     UNUSED,                  // 0x5e
     &quot;it_sensor&quot;,                  // 0x5f
-    &quot;it-drop&quot;,                    // 0x60    drop (turns actor into rotor)
+    &quot;it_drop&quot;,                    // 0x60    drop (turns actor into rotor)
     // codes &gt;= 0x61 are unused
 };

Modified: trunk/src/ox_peroxyd.cc
===================================================================
--- trunk/src/ox_peroxyd.cc	2009-02-02 18:49:22 UTC (rev 1502)
+++ trunk/src/ox_peroxyd.cc	2009-02-02 23:53:30 UTC (rev 1503)
@@ -453,7 +453,7 @@
     &quot;it_magicwand&quot;,               // 0x47
     &quot;it_wrench&quot;,                  // 0x48
     UNUSED,                  // 0x49
-    &quot;it-odometer&quot;,                // 0x4a
+    &quot;it_odometer&quot;,                // 0x4a
     &quot;it_puller_n&quot;,                // 0x4b
     &quot;it_puller_s&quot;,                // 0x4c
     &quot;it_puller_w&quot;,                // 0x4d

Modified: trunk/src/oxyd.cc
===================================================================
--- trunk/src/oxyd.cc	2009-02-02 18:49:22 UTC (rev 1502)
+++ trunk/src/oxyd.cc	2009-02-02 23:53:30 UTC (rev 1503)
@@ -399,7 +399,7 @@
             std::string key = config.itemtable[type];
             if (key == IT_INVALID) {
                 Log &lt;&lt; ecl::strf (&quot;Unknown item %X\n&quot;,type);
-                it = MakeItem(&quot;it-dummy&quot;);
+                it = MakeItem(&quot;it_dummy&quot;);
                 it-&gt;setAttr(&quot;code&quot;, type);
             } else if (key == &quot;it_vortex_closed&quot;) {
                 it = MakeItem(key.c_str());

Modified: trunk/src/stones/ShogunStone.cc
===================================================================
--- trunk/src/stones/ShogunStone.cc	2009-02-02 18:49:22 UTC (rev 1502)
+++ trunk/src/stones/ShogunStone.cc	2009-02-02 23:53:30 UTC (rev 1503)
@@ -150,8 +150,6 @@
     }
 
     void ShogunStone::on_impulse(const Impulse&amp; impulse) {
-        static char * soundevent = &quot;movesmall&quot;;
-        
         if (!impulse.byWire &amp;&amp; subShogun != NULL) {
             subShogun-&gt;on_impulse(impulse);
             return;
@@ -171,7 +169,7 @@
             if (!yieldShogun())
                 return;            // being swapped or pulled
             
-            sound_event(soundevent);
+            sound_event(&quot;movesmall&quot;);
             
             // then put to new position
             if (st == NULL) {


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000931.html">[Enigma-game-svn] r1502
</A></li>
	<LI>Next message: <A HREF="000933.html">[Enigma-game-svn] r1504 - in trunk/data/levels: enigma_cross	enigma_iv enigma_vi enigma_vii enigma_viii
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#932">[ date ]</a>
              <a href="thread.html#932">[ thread ]</a>
              <a href="subject.html#932">[ subject ]</a>
              <a href="author.html#932">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/enigma-game-svn">More information about the Enigma-game-svn
mailing list</a><br>
</body></html>
