<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Enigma-game-svn] r1509 - in trunk: data data/gfx32 data/gfx40	data/gfx48 data/schemas src src/items src/stones
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/enigma-game-svn/2009-February/index.html" >
   <LINK REL="made" HREF="mailto:enigma-game-svn%40lists.berlios.de?Subject=Re%3A%20%5BEnigma-game-svn%5D%20r1509%20-%20in%20trunk%3A%20data%20data/gfx32%20data/gfx40%0A%09data/gfx48%20data/schemas%20src%20src/items%20src/stones&In-Reply-To=%3C200902040035.n140ZQbk021522%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000937.html">
   <LINK REL="Next"  HREF="000940.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Enigma-game-svn] r1509 - in trunk: data data/gfx32 data/gfx40	data/gfx48 data/schemas src src/items src/stones</H1>
    <B>ral at BerliOS</B> 
    <A HREF="mailto:enigma-game-svn%40lists.berlios.de?Subject=Re%3A%20%5BEnigma-game-svn%5D%20r1509%20-%20in%20trunk%3A%20data%20data/gfx32%20data/gfx40%0A%09data/gfx48%20data/schemas%20src%20src/items%20src/stones&In-Reply-To=%3C200902040035.n140ZQbk021522%40sheep.berlios.de%3E"
       TITLE="[Enigma-game-svn] r1509 - in trunk: data data/gfx32 data/gfx40	data/gfx48 data/schemas src src/items src/stones">ral at mail.berlios.de
       </A><BR>
    <I>Wed Feb  4 01:35:26 CET 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="000937.html">[Enigma-game-svn] r1508 - in trunk: data data/levels/lib	doc/reference
</A></li>
        <LI>Next message: <A HREF="000940.html">[Enigma-game-svn] r1509 - incomplete commit message
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#938">[ date ]</a>
              <a href="thread.html#938">[ thread ]</a>
              <a href="subject.html#938">[ subject ]</a>
              <a href="author.html#938">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: ral
Date: 2009-02-04 01:35:22 +0100 (Wed, 04 Feb 2009)
New Revision: 1509

Added:
   trunk/data/gfx32/it_bomb_black.png
   trunk/data/gfx32/it_bomb_black_burning.png
   trunk/data/gfx32/it_bomb_white.png
   trunk/data/gfx32/it_dynamite.png
   trunk/data/gfx32/it_dynamite_burning.png
   trunk/data/gfx32/it_white_burning.png
   trunk/data/gfx32/st_dispenser_bombblackpng
   trunk/data/gfx32/st_dispenser_bombwhite.png
   trunk/data/gfx32/st_dispenser_dynamite.png
   trunk/data/gfx40/it_bomb_black.png
   trunk/data/gfx40/it_bomb_black_burning.png
   trunk/data/gfx40/it_bomb_white.png
   trunk/data/gfx40/it_bomb_white_burning.png
   trunk/data/gfx40/it_dynamite.png
   trunk/data/gfx40/it_dynamite_burning.png
   trunk/data/gfx40/st_dispenser_bombblack.png
   trunk/data/gfx40/st_dispenser_bombwhite.png
   trunk/data/gfx40/st_dispenser_dynamite.png
   trunk/data/gfx48/it_bomb_black.png
   trunk/data/gfx48/it_bomb_black_burning.png
   trunk/data/gfx48/it_bomb_white.png
   trunk/data/gfx48/it_bomb_white_burning.png
   trunk/data/gfx48/it_dynamite.png
   trunk/data/gfx48/it_dynamite_burning.png
   trunk/data/gfx48/st_dispenser_bombblack.png
   trunk/data/gfx48/st_dispenser_bombwhite.png
   trunk/data/gfx48/st_dispenser_dynamite.png
   trunk/src/items/Bomb.cc
   trunk/src/items/Bomb.hh
   trunk/src/items/Dynamite.cc
   trunk/src/items/Dynamite.hh
   trunk/src/stones/DispenserStone.cc
   trunk/src/stones/DispenserStone.hh
Removed:
   trunk/data/gfx32/it-blackbomb-burning.png
   trunk/data/gfx32/it-blackbomb.png
   trunk/data/gfx32/it-dynamite-burning.png
   trunk/data/gfx32/it-dynamite.png
   trunk/data/gfx32/it-whitebomb-burning.png
   trunk/data/gfx32/it-whitebomb.png
   trunk/data/gfx32/st-bombs.png
   trunk/data/gfx32/st-dynamite.png
   trunk/data/gfx32/st-whitebombs.png
   trunk/data/gfx40/it-blackbomb-burning.png
   trunk/data/gfx40/it-blackbomb.png
   trunk/data/gfx40/it-dynamite-burning.png
   trunk/data/gfx40/it-dynamite.png
   trunk/data/gfx40/it-whitebomb-burning.png
   trunk/data/gfx40/it-whitebomb.png
   trunk/data/gfx40/st-bombs.png
   trunk/data/gfx40/st-dynamite.png
   trunk/data/gfx40/st-whitebombs.png
   trunk/data/gfx48/it-blackbomb-burning.png
   trunk/data/gfx48/it-blackbomb.png
   trunk/data/gfx48/it-dynamite-burning.png
   trunk/data/gfx48/it-dynamite.png
   trunk/data/gfx48/it-whitebomb-burning.png
   trunk/data/gfx48/it-whitebomb.png
   trunk/data/gfx48/st-bombs.png
   trunk/data/gfx48/st-dynamite.png
   trunk/data/gfx48/st-whitebombs.png
   trunk/src/stones_simple.cc
Modified:
   trunk/data/api1init.lua
   trunk/data/models-2d.lua
   trunk/data/schemas/objects.xml
   trunk/src/Makefile.am
   trunk/src/items.cc
   trunk/src/items.hh
   trunk/src/items/BurnableItem.cc
   trunk/src/items/SimpleItems.cc
   trunk/src/items/SimpleItems.hh
   trunk/src/ox_extra.cc
   trunk/src/ox_magnum.cc
   trunk/src/ox_oxyd1.cc
   trunk/src/ox_peroxyd.cc
   trunk/src/stones.cc
   trunk/src/stones.hh
   trunk/src/stones/ShogunStone.cc
   trunk/src/stones/SimpleStones.cc
   trunk/src/stones/SimpleStones.hh
   trunk/src/stones_internal.hh
   trunk/src/world.cc
Log:
Trunk 1.1: new API reengineering
- reengineering bomb dispenser stone:
  - st-bombs -&gt; st_dispenser, st_dispenser_bombblack
  - add support for white bombs and dynamite:
    - st_dispenser_bombwhite
    - st_dispenser_dynamite
  - attribute flavor identical to suffix
- fix bomb item: set correct inventory model


Modified: trunk/data/api1init.lua
===================================================================
--- trunk/data/api1init.lua	2009-02-03 23:53:51 UTC (rev 1508)
+++ trunk/data/api1init.lua	2009-02-04 00:35:22 UTC (rev 1509)
@@ -134,6 +134,8 @@
     it_bag = &quot;it-bag&quot;,
     it_blocker = &quot;it-blocker&quot;,
     it_blocker_new = &quot;it-blocker-new&quot;,
+    it_bomb_black = &quot;it-blackbomb&quot;,
+    it_bomb_white = &quot;it-whitebomb&quot;,
     it_bottle_idle = &quot;it-booze&quot;,
     it_bottle_broken = &quot;it-booze-broken&quot;,
     it_brake = &quot;it-brake&quot;,
@@ -154,13 +156,17 @@
     it_crack_m = &quot;it-crack2&quot;,
     it_crack_l = &quot;it-crack3&quot;,
     it_cross = &quot;it-cross&quot;,
+    it_death = &quot;it-death&quot;,
     it_document = &quot;it-document&quot;,
     it_drop = &quot;it-drop&quot;,
+    it_dynamite = &quot;it-dynamite&quot;,
+    it_explosion_nil = &quot;it-explosion1&quot;,
+    it_explosion_hollow = &quot;it-explosion2&quot;,
+    it_explosion_debris = &quot;it-explosion3&quot;,    
     it_extinguisher_empty = &quot;it-extinguisher_empty&quot;,
     it_extinguisher_medium = &quot;it-extinguisher_medium&quot;,
     it_extinguisher_full = &quot;it-extinguisher&quot;,
     it_extralife = &quot;it-extralife&quot;,
-    it_death = &quot;it-death&quot;,
     it_flag_black = &quot;it-flagblack&quot;,
     it_flag_white = &quot;it-flagwhite&quot;,
     it_floppy = &quot;it-floppy&quot;,
@@ -309,6 +315,7 @@
     st_disco_light = &quot;st-disco-light&quot;,
     st_disco_medium = &quot;st-disco-medium&quot;,
     st_disco_dark = &quot;st-disco-dark&quot;,
+    st_dispenser_bombblack = &quot;st-bombs&quot;,
     st_door_a = &quot;st-door_a&quot;,
     st_door_b = &quot;st-door_b&quot;,
     st_door_c = &quot;st-door_c&quot;,

Deleted: trunk/data/gfx32/it-blackbomb-burning.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx32/it-blackbomb.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx32/it-dynamite-burning.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx32/it-dynamite.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx32/it-whitebomb-burning.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx32/it-whitebomb.png
===================================================================
(Binary files differ)

Copied: trunk/data/gfx32/it_bomb_black.png (from rev 1502, trunk/data/gfx32/it-blackbomb.png)

Copied: trunk/data/gfx32/it_bomb_black_burning.png (from rev 1502, trunk/data/gfx32/it-blackbomb-burning.png)

Copied: trunk/data/gfx32/it_bomb_white.png (from rev 1502, trunk/data/gfx32/it-whitebomb.png)

Copied: trunk/data/gfx32/it_dynamite.png (from rev 1502, trunk/data/gfx32/it-dynamite.png)

Copied: trunk/data/gfx32/it_dynamite_burning.png (from rev 1502, trunk/data/gfx32/it-dynamite-burning.png)

Copied: trunk/data/gfx32/it_white_burning.png (from rev 1502, trunk/data/gfx32/it-whitebomb-burning.png)

Deleted: trunk/data/gfx32/st-bombs.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx32/st-dynamite.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx32/st-whitebombs.png
===================================================================
(Binary files differ)

Copied: trunk/data/gfx32/st_dispenser_bombblackpng (from rev 1508, trunk/data/gfx32/st-bombs.png)

Copied: trunk/data/gfx32/st_dispenser_bombwhite.png (from rev 1508, trunk/data/gfx32/st-whitebombs.png)

Copied: trunk/data/gfx32/st_dispenser_dynamite.png (from rev 1508, trunk/data/gfx32/st-dynamite.png)

Deleted: trunk/data/gfx40/it-blackbomb-burning.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx40/it-blackbomb.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx40/it-dynamite-burning.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx40/it-dynamite.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx40/it-whitebomb-burning.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx40/it-whitebomb.png
===================================================================
(Binary files differ)

Copied: trunk/data/gfx40/it_bomb_black.png (from rev 1502, trunk/data/gfx40/it-blackbomb.png)

Copied: trunk/data/gfx40/it_bomb_black_burning.png (from rev 1502, trunk/data/gfx40/it-blackbomb-burning.png)

Copied: trunk/data/gfx40/it_bomb_white.png (from rev 1502, trunk/data/gfx40/it-whitebomb.png)

Copied: trunk/data/gfx40/it_bomb_white_burning.png (from rev 1502, trunk/data/gfx40/it-whitebomb-burning.png)

Copied: trunk/data/gfx40/it_dynamite.png (from rev 1502, trunk/data/gfx40/it-dynamite.png)

Copied: trunk/data/gfx40/it_dynamite_burning.png (from rev 1502, trunk/data/gfx40/it-dynamite-burning.png)

Deleted: trunk/data/gfx40/st-bombs.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx40/st-dynamite.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx40/st-whitebombs.png
===================================================================
(Binary files differ)

Copied: trunk/data/gfx40/st_dispenser_bombblack.png (from rev 1508, trunk/data/gfx40/st-bombs.png)

Copied: trunk/data/gfx40/st_dispenser_bombwhite.png (from rev 1508, trunk/data/gfx40/st-whitebombs.png)

Copied: trunk/data/gfx40/st_dispenser_dynamite.png (from rev 1508, trunk/data/gfx40/st-dynamite.png)

Deleted: trunk/data/gfx48/it-blackbomb-burning.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx48/it-blackbomb.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx48/it-dynamite-burning.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx48/it-dynamite.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx48/it-whitebomb-burning.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx48/it-whitebomb.png
===================================================================
(Binary files differ)

Copied: trunk/data/gfx48/it_bomb_black.png (from rev 1502, trunk/data/gfx48/it-blackbomb.png)

Copied: trunk/data/gfx48/it_bomb_black_burning.png (from rev 1502, trunk/data/gfx48/it-blackbomb-burning.png)

Copied: trunk/data/gfx48/it_bomb_white.png (from rev 1502, trunk/data/gfx48/it-whitebomb.png)

Copied: trunk/data/gfx48/it_bomb_white_burning.png (from rev 1502, trunk/data/gfx48/it-whitebomb-burning.png)

Copied: trunk/data/gfx48/it_dynamite.png (from rev 1502, trunk/data/gfx48/it-dynamite.png)

Copied: trunk/data/gfx48/it_dynamite_burning.png (from rev 1502, trunk/data/gfx48/it-dynamite-burning.png)

Deleted: trunk/data/gfx48/st-bombs.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx48/st-dynamite.png
===================================================================
(Binary files differ)

Deleted: trunk/data/gfx48/st-whitebombs.png
===================================================================
(Binary files differ)

Copied: trunk/data/gfx48/st_dispenser_bombblack.png (from rev 1508, trunk/data/gfx48/st-bombs.png)

Copied: trunk/data/gfx48/st_dispenser_bombwhite.png (from rev 1508, trunk/data/gfx48/st-whitebombs.png)

Copied: trunk/data/gfx48/st_dispenser_dynamite.png (from rev 1508, trunk/data/gfx48/st-dynamite.png)

Modified: trunk/data/models-2d.lua
===================================================================
--- trunk/data/models-2d.lua	2009-02-03 23:53:51 UTC (rev 1508)
+++ trunk/data/models-2d.lua	2009-02-04 00:35:22 UTC (rev 1509)
@@ -451,13 +451,13 @@
 do
     itemlist = {
         &quot;it_bag&quot;,
-        &quot;it-blackbomb&quot;,
+        &quot;it_bomb_black&quot;,
         &quot;it-blocker&quot;,
         &quot;it_bottle_idle&quot;,
         &quot;it_bottle_broken&quot;,
         &quot;it_document&quot;,
         &quot;it_drop&quot;,
-        &quot;it-dynamite&quot;,
+        &quot;it_dynamite&quot;,
         &quot;it_flag_black&quot;,
         &quot;it_flag_white&quot;,
         &quot;it_odometer&quot;,
@@ -470,7 +470,7 @@
         &quot;it_spring_drop&quot;,
         &quot;it_surprise&quot;,
         &quot;it_weight&quot;,
-        &quot;it-whitebomb&quot;
+        &quot;it_bomb_white&quot;
     }
 
     DefImages(itemlist)
@@ -569,23 +569,23 @@
 
 -- Burning black bomb --
 do
-    local images = DefSubimages(&quot;it-blackbomb-burning&quot;, {h=9})
+    local images = DefSubimages(&quot;it_bomb_black_burning&quot;, {h=9})
     local frames = BuildFrames(images, 100)
-    DefAnim(&quot;it-blackbomb-burning&quot;, frames)
+    DefAnim(&quot;it_bomb_black_burning&quot;, frames)
 end
 
 -- Burning white bomb --
 do
-    local images = DefSubimages(&quot;it-whitebomb-burning&quot;, {h=9})
+    local images = DefSubimages(&quot;it_bomb_white_burning&quot;, {h=9})
     local frames = BuildFrames(images, 100)
-    DefAnim(&quot;it-whitebomb-burning&quot;, frames)
+    DefAnim(&quot;it_bomb_white_burning&quot;, frames)
 end
 
 -- Burning dynamite --
 do
-    local images = DefSubimages(&quot;it-dynamite-burning&quot;, {h=15})
+    local images = DefSubimages(&quot;it_dynamite_burning&quot;, {h=15})
     local frames = BuildFrames(images, 100)
-    DefAnim(&quot;it-dynamite-burning&quot;, frames)
+    DefAnim(&quot;it_dynamite_burning&quot;, frames)
 end
 
 -- Burning Floor --
@@ -630,9 +630,7 @@
 -- Explosion --
 do
     DefAnimImages(&quot;expl&quot;, {{&quot;expl&quot;, 50}})
-    DefAlias(&quot;it-explosion1&quot;, &quot;expl&quot;)
-    DefAlias(&quot;it-explosion2&quot;, &quot;expl&quot;)
-    DefAlias(&quot;it-explosion3&quot;, &quot;expl&quot;)
+    DefAlias(&quot;it_explosion&quot;, &quot;expl&quot;)
 end
 
 -- it-magnet --
@@ -945,17 +943,22 @@
     DefRoundStoneWithAnim (&quot;st-death&quot;, 3, 140)
 end
 
+-- st_yinyang --
+do
+    DefRoundStoneWithAnim(&quot;st_yinyang&quot;, 6, 140)
+end
+
 -- st-dynamite, st-bombs, st-whitebombs --
 do
     function make_bombstone(name)
         local images = DefSubimages(name, {h=7})
         DefRoundStone(name, name..&quot;1&quot;)
-        DefAnim(name..&quot;-anim&quot;, BuildFrames(images,50))
+        DefAnim(name..&quot;_breaking&quot;, BuildFrames(images,50))
     end
 
-    make_bombstone(&quot;st-bombs&quot;)
-    make_bombstone(&quot;st-dynamite&quot;)
-    make_bombstone(&quot;st-whitebombs&quot;)
+    make_bombstone(&quot;st_dispenser_bombblack&quot;)
+    make_bombstone(&quot;st_dispenser_dynamite&quot;)
+    make_bombstone(&quot;st_dispenser_bombwhite&quot;)
 end
 
 -- st-flash --

Modified: trunk/data/schemas/objects.xml
===================================================================
--- trunk/data/schemas/objects.xml	2009-02-03 23:53:51 UTC (rev 1508)
+++ trunk/data/schemas/objects.xml	2009-02-04 00:35:22 UTC (rev 1509)
@@ -98,7 +98,7 @@
     &lt;msg name=&quot;crack&quot; type=&quot;nil&quot;/&gt;
     &lt;msg name=&quot;darken&quot; type=&quot;nil&quot;/&gt;
     &lt;msg name=&quot;disconnect&quot; type=&quot;nil&quot;/&gt;
-    &lt;msg name=&quot;expl&quot; type=&quot;nil&quot;/&gt;
+    &lt;msg name=&quot;explode&quot; type=&quot;nil&quot;/&gt;
     &lt;msg name=&quot;extinguish&quot; type=&quot;nil&quot;/&gt;
     &lt;msg name=&quot;fire&quot; type=&quot;nil&quot;/&gt;
     &lt;msg name=&quot;flip&quot; type=&quot;nil&quot;/&gt;
@@ -385,6 +385,22 @@
     &lt;object name=&quot;it_bag&quot;/&gt;
     &lt;object name=&quot;it_blocker_new&quot; init=&quot;true&quot;&gt;
     &lt;/object&gt;
+    &lt;object name=&quot;it_bomb&quot;&gt;
+      &lt;attr name=&quot;color&quot;/&gt;
+      &lt;msg name=&quot;ignite&quot;/&gt;
+      &lt;msg name=&quot;heat&quot;/&gt;
+      &lt;msg name=&quot;explode&quot;/&gt;
+      &lt;msg name=&quot;_explosion&quot;/&gt;
+      &lt;msg name=&quot;_bombstone&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;it_bomb_black&quot;&gt;
+      &lt;attr name=&quot;color&quot; value=&quot;0&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;it_bomb_black_burning&quot; init=&quot;true&quot;/&gt;
+    &lt;object name=&quot;it_bomb_white&quot;&gt;
+      &lt;attr name=&quot;color&quot; value=&quot;1&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;it_bomb_white_burning&quot; init=&quot;true&quot;/&gt;
     &lt;object name=&quot;it_bottle&quot;&gt;
       &lt;msg name=&quot;_brush&quot;/&gt;
     &lt;/object&gt;
@@ -468,6 +484,32 @@
     &lt;object name=&quot;it_extinguisher&quot;&gt;
       &lt;attr name=&quot;state&quot; max=&quot;2&quot;/&gt;
     &lt;/object&gt;
+    &lt;object name=&quot;it_dynamite&quot;&gt;
+      &lt;attr name=&quot;state&quot;/&gt;
+      &lt;msg name=&quot;ignite&quot;/&gt;
+      &lt;msg name=&quot;heat&quot;/&gt;
+      &lt;msg name=&quot;explode&quot;/&gt;
+      &lt;msg name=&quot;_explosion&quot;/&gt;
+      &lt;msg name=&quot;_bombstone&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;it_dynamite_burning&quot;&gt;
+      &lt;attr name=&quot;state&quot; value=&quot;1&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;it_explosion&quot;&gt;
+      &lt;attr name=&quot;state&quot; max=&quot;3&quot; rw=&quot;r&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;it_explosion_nil&quot;&gt;
+      &lt;attr name=&quot;state&quot; value=&quot;0&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;it_explosion_hollow&quot;&gt;
+      &lt;attr name=&quot;state&quot; value=&quot;1&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;it_explosion_crack&quot;&gt;
+      &lt;attr name=&quot;state&quot; value=&quot;2&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;it_explosion_debris&quot;&gt;
+      &lt;attr name=&quot;state&quot; value=&quot;3&quot;/&gt;
+    &lt;/object&gt;
     &lt;object name=&quot;it_extinguisher_empty&quot;&gt;
       &lt;attr name=&quot;state&quot; value=&quot;0&quot;/&gt;
     &lt;/object&gt;
@@ -1080,6 +1122,20 @@
     &lt;object name=&quot;st_disco_dark&quot;&gt;
       &lt;attr name=&quot;state&quot; value=&quot;2&quot;/&gt;
     &lt;/object&gt;
+    &lt;object name=&quot;st_dispenser&quot;&gt;
+      &lt;attr name=&quot;flavor&quot; default=&quot;bombblack&quot; rw=&quot;r&quot;/&gt;
+      &lt;msg name=&quot;_explosion&quot;/&gt;
+      &lt;msg name=&quot;_bombstone&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;st_dispenser_bombblack&quot;&gt;
+      &lt;attr name=&quot;flavor&quot; value=&quot;bombblack&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;st_dispenser_bombwhite&quot;&gt;
+      &lt;attr name=&quot;flavor&quot; value=&quot;bombwhite&quot;/&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;st_dispenser_dynamite&quot;&gt;
+      &lt;attr name=&quot;flavor&quot; value=&quot;dynamite&quot;/&gt;
+    &lt;/object&gt;
     &lt;object name=&quot;st_door&quot;&gt;
       &lt;attr name=&quot;faces&quot; default=&quot;nesw&quot;/&gt;
       &lt;attr name=&quot;flavor&quot;/&gt;
@@ -1734,5 +1790,10 @@
     &lt;/object&gt;
     &lt;object name=&quot;st_woven&quot;/&gt;
     &lt;object name=&quot;st_yellow&quot;/&gt;
+    &lt;object name=&quot;st_yinyang&quot;&gt;
+    &lt;/object&gt;
+    &lt;object name=&quot;st_yinyang_active&quot;&gt;
+      &lt;attr name=&quot;state&quot; value=&quot;1&quot;/&gt;
+    &lt;/object&gt;
   &lt;/zoo&gt;
 &lt;/objects&gt;

Modified: trunk/src/Makefile.am
===================================================================
--- trunk/src/Makefile.am	2009-02-03 23:53:51 UTC (rev 1508)
+++ trunk/src/Makefile.am	2009-02-04 00:35:22 UTC (rev 1509)
@@ -124,7 +124,6 @@
 	stones.cc 		\
 	stones.hh 		\
 	stones_internal.hh 	\
-	stones_simple.cc 	\
 	Utf8ToXML.cc		\
 	Utf8ToXML.hh		\
 	util.cc 		\
@@ -208,6 +207,8 @@
 	items/BrakeItem.hh	\
 	items/BlockerItem.cc	\
 	items/BlockerItem.hh	\
+	items/Bomb.cc		\
+	items/Bomb.hh		\
 	items/Bottle.cc		\
 	items/Bottle.hh		\
 	items/BurnableItem.cc	\
@@ -224,6 +225,8 @@
 	items/DocumentItem.hh	\
 	items/Drop.cc		\
 	items/Drop.hh		\
+	items/Dynamite.cc	\
+	items/Dynamite.hh	\
 	items/Extinguisher.cc	\
 	items/Extinguisher.hh	\
 	items/ExtraLife.cc	\
@@ -312,6 +315,8 @@
 	stones/DeathStone.hh	\
 	stones/DiscoStone.cc	\
 	stones/DiscoStone.hh	\
+	stones/DispenserStone.cc	\
+	stones/DispenserStone.hh	\
 	stones/Door.cc		\
 	stones/Door.hh		\
 	stones/FakeStone.cc	\

Added: trunk/src/items/Bomb.cc
===================================================================
--- trunk/src/items/Bomb.cc	2009-02-03 23:53:51 UTC (rev 1508)
+++ trunk/src/items/Bomb.cc	2009-02-04 00:35:22 UTC (rev 1509)
@@ -0,0 +1,134 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2009 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *  
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include &quot;items/Bomb.hh&quot;
+//#include &quot;errors.hh&quot;
+//#include &quot;main.hh&quot;
+#include &quot;server.hh&quot;
+#include &quot;world.hh&quot;
+
+namespace enigma {
+
+    Bomb::Bomb(int color, bool burning) {
+        Item::setAttr(&quot;color&quot;, color);
+        if (burning)
+            state = BURNING;
+    }
+    
+    std::string Bomb::getClass() const {
+        return &quot;it_bomb&quot;;
+    }
+    
+    void Bomb::setAttr(const string&amp; key, const Value &amp;val) {
+        if (key == &quot;color&quot;) {
+            Item::setAttr(&quot;color&quot;, val);
+            if (isDisplayable())
+                init_model();
+            return;
+        }
+        Item::setAttr(key, val);
+    }
+    
+    Value Bomb::message(const Message &amp;m) {
+        if (m.message == &quot;ignite&quot;  || m.message == &quot;_explosion&quot;) {
+            if (isDisplayable())
+                burn();
+            return Value();
+        } else if (m.message == &quot;explode&quot; ) {
+            if (isDisplayable())
+                explode();
+            return Value();
+        } else if (m.message == &quot;heat&quot;) {  // used by fire-system
+            if (isDisplayable())
+                burn();
+            return true;  // caught message -&gt; no fire!
+        }
+        return Item::message(m);
+    }
+    
+    void Bomb::setState(int extState) {
+        if (state == IDLE &amp;&amp; extState == 1) {
+            state = BURNING;
+            if (isDisplayable())
+                init_model();
+        }
+    }
+    
+    void Bomb::init_model() {
+        std::string color = (getAttr(&quot;color&quot;) == BLACK) ? &quot;black&quot; : &quot;white&quot;;
+        if (state == IDLE) {
+            set_model(ecl::strf(&quot;it_bomb_%s&quot;, color.c_str()));
+        } else
+            set_anim(ecl::strf(&quot;it_bomb_%s_burning&quot;, color.c_str()));
+    }
+    
+    void Bomb::processLight(Direction d) {
+        explode();
+    }
+    
+    void Bomb::animcb() {
+        explode();
+    }
+    
+    std::string Bomb::get_inventory_model() {
+        std::string color = (getAttr(&quot;color&quot;) == BLACK) ? &quot;black&quot; : &quot;white&quot;;
+        return ecl::strf(&quot;it_bomb_%s&quot;, color.c_str());        
+    }
+    
+    void Bomb::on_stonehit(Stone *st) {
+        switch (server::GameCompatibility) {
+            case GAMET_OXYD1:
+            case GAMET_OXYDMAGNUM:
+                if (!st-&gt;isKind(&quot;st_box_wood&quot;))
+                    // st-wood does not cause bombs to explode
+                    explode();
+                break;
+            default :
+                explode();
+                break;
+        }
+    }
+    
+    void Bomb::burn() {
+        if (state == IDLE) {
+            state = BURNING;
+            init_model();
+        }
+    }
+    
+    void Bomb::explode() {
+        GridPos p = get_pos();
+        Value vc = getAttr(&quot;color&quot;);
+        sound_event(vc == BLACK ? &quot;blackbomb&quot; : &quot;whitebomb&quot;);
+        SendExplosionEffect(p, vc == BLACK ? EXPLOSION_BLACKBOMB : EXPLOSION_WHITEBOMB);  // may kill the bomb by another explosion1 set by brake
+        replace(&quot;it_explosion_debris&quot;);
+    }
+
+    DEF_ITEMTRAITSF(Bomb, &quot;it_bomb&quot;, it_bomb, itf_static | itf_indestructible | itf_fireproof);
+
+    BOOT_REGISTER_START
+        BootRegister(new Bomb(0), &quot;it_bomb&quot;);
+        BootRegister(new Bomb(0), &quot;it_bomb_black&quot;);
+        BootRegister(new Bomb(0, true), &quot;it_bomb_black_burning&quot;);
+        BootRegister(new Bomb(1), &quot;it_bomb_white&quot;);
+        BootRegister(new Bomb(1, true), &quot;it_bomb_white_burning&quot;);
+    BOOT_REGISTER_END
+
+} // namespace enigma


Property changes on: trunk/src/items/Bomb.cc
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/items/Bomb.hh
===================================================================
--- trunk/src/items/Bomb.hh	2009-02-03 23:53:51 UTC (rev 1508)
+++ trunk/src/items/Bomb.hh	2009-02-04 00:35:22 UTC (rev 1509)
@@ -0,0 +1,70 @@
+/*
+ * Copyright (C) 2009 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef BOMBITEM_HH
+#define BOMBITEM_HH
+
+#include &quot;items.hh&quot;
+
+//#include &quot;enigma.hh&quot;
+
+namespace enigma {
+    /**
+     * 
+     */
+
+    class Bomb : public Item {
+        CLONEOBJ(Bomb);
+        DECL_ITEMTRAITS;
+
+    private:
+        enum iState {
+            IDLE       =  0,       ///&lt; 
+            BURNING    =  1,       ///&lt;  
+        };
+        
+    public:
+        Bomb(int color, bool burning =false);
+        
+        // Object interface
+        virtual std::string getClass() const;
+        virtual void setAttr(const string&amp; key, const Value &amp;val);
+        virtual Value message (const Message &amp;m);
+
+        // StateObject interface
+        virtual void setState(int extState);
+
+        // GridObject interface
+        virtual void init_model();
+        virtual void processLight(Direction d);
+        
+        // ModelCallback interface
+        virtual void animcb();
+        
+        // Item interface
+        virtual std::string get_inventory_model();
+        virtual void on_stonehit(Stone *st);
+        
+    private:
+        void burn();
+        void explode();
+    };
+   
+} // namespace enigma
+
+#endif


Property changes on: trunk/src/items/Bomb.hh
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/src/items/BurnableItem.cc
===================================================================
--- trunk/src/items/BurnableItem.cc	2009-02-03 23:53:51 UTC (rev 1508)
+++ trunk/src/items/BurnableItem.cc	2009-02-04 00:35:22 UTC (rev 1509)
@@ -53,7 +53,7 @@
     }
     
     void BurnableItem::init_model() {
-        if(state == OIL) {
+        if (state == OIL) {
             set_model(ecl::strf(&quot;it_burnable_oil%d&quot;, IntegerRand(1, 4)));  // TODO store and keep model subtyp!
         } else
             Item::init_model();

Added: trunk/src/items/Dynamite.cc
===================================================================
--- trunk/src/items/Dynamite.cc	2009-02-03 23:53:51 UTC (rev 1508)
+++ trunk/src/items/Dynamite.cc	2009-02-04 00:35:22 UTC (rev 1509)
@@ -0,0 +1,113 @@
+/*
+ * Copyright (C) 2002,2003,2004 Daniel Heck
+ * Copyright (C) 2009 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *  
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include &quot;items/Dynamite.hh&quot;
+//#include &quot;errors.hh&quot;
+//#include &quot;main.hh&quot;
+#include &quot;world.hh&quot;
+
+namespace enigma {
+
+    Dynamite::Dynamite(int initState) {
+        state = initState;
+    }
+    
+    std::string Dynamite::getClass() const {
+        return &quot;it_dynamite&quot;;
+    }
+    
+    Value Dynamite::message(const Message &amp;m) {
+        if (m.message == &quot;ignite&quot; || m.message == &quot;_explosion&quot; || m.message == &quot;_bombstone&quot;) {
+            if (isDisplayable())
+                burn();
+            return Value();
+        } else if (m.message == &quot;explode&quot;) { // currently unused in c++ code
+            if (isDisplayable())
+                explode();
+            return Value();
+        } else if (m.message == &quot;heat&quot;) {  // used by fire-system
+            if (isDisplayable())
+                burn();
+            return true;  // caught message -&gt; no fire!
+        }
+        return Item::message(m);
+    }
+    
+    void Dynamite::setState(int extState) {
+        if (state == IDLE &amp;&amp; extState == 1) {
+            state = BURNING;
+            if (isDisplayable())
+                init_model();
+        }
+    }
+    
+    void Dynamite::init_model() {
+        if (state == IDLE) {
+            set_model(&quot;it_dynamite&quot;);
+        } else
+            set_anim(&quot;it_dynamite_burning&quot;);
+    }
+    
+    void Dynamite::processLight(Direction d) {
+        burn();
+    }
+    
+    void Dynamite::animcb() {
+        explode();
+    }
+    
+    bool Dynamite::isStatic() const {
+        return state == BURNING;  // burning dynamite cannot be picked up
+    }
+    
+    void Dynamite::on_drop(Actor *a) {
+        burn();
+    }
+    
+    void Dynamite::burn() {
+        if (state == IDLE) {
+            state = BURNING;
+            init_model();
+        }
+    }
+    
+    void Dynamite::explode() {
+        GridPos p = get_pos();
+        SendExplosionEffect(p, EXPLOSION_DYNAMITE);
+        sound_event (&quot;dynamite&quot;);
+        Floor *fl = GetFloor(p);
+        std::string flclass = fl-&gt;getClass();
+        if (flclass == &quot;fl_space&quot;) {
+            replace(&quot;it_explosion_hollow&quot;);
+        } else if (flclass == &quot;fl_ice&quot;) {
+            replace(&quot;it_explosion_crack&quot;);
+        } else {
+            replace(&quot;it_explosion_hollow&quot;);
+        }
+    }
+    
+    DEF_ITEMTRAITSF(Dynamite, &quot;it_dynamite&quot;, it_dynamite, itf_indestructible | itf_fireproof);
+
+    BOOT_REGISTER_START
+        BootRegister(new Dynamite(0), &quot;it_dynamite&quot;);
+        BootRegister(new Dynamite(1), &quot;it_dynamite_burning&quot;);
+    BOOT_REGISTER_END
+
+} // namespace enigma


Property changes on: trunk/src/items/Dynamite.cc
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/items/Dynamite.hh
===================================================================
--- trunk/src/items/Dynamite.hh	2009-02-03 23:53:51 UTC (rev 1508)
+++ trunk/src/items/Dynamite.hh	2009-02-04 00:35:22 UTC (rev 1509)
@@ -0,0 +1,70 @@
+/*
+ * Copyright (C) 2009 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef DYNAMITEITEM_HH
+#define DYNAMITEITEM_HH
+
+#include &quot;items.hh&quot;
+
+//#include &quot;enigma.hh&quot;
+
+namespace enigma {
+    /**
+     * 
+     */
+
+    class Dynamite : public Item {
+        CLONEOBJ(Dynamite);
+        DECL_ITEMTRAITS;
+
+    private:
+        enum iState {
+            IDLE       =  0,       ///&lt; 
+            BURNING    =  1,       ///&lt;  
+        };
+        
+    public:
+        Dynamite(int initState);
+        
+        // Object interface
+        virtual std::string getClass() const;
+        virtual Value message (const Message &amp;m);
+
+        // StateObject interface
+        virtual void setState(int extState);
+
+        // GridObject interface
+        virtual void init_model();
+        virtual void processLight(Direction d);
+        
+        // ModelCallback interface
+        virtual void animcb();
+        
+        // Item interface
+        virtual bool isStatic() const;
+        virtual void on_drop(Actor *a);
+        
+        
+    private:
+        void burn();
+        void explode();
+    };
+   
+} // namespace enigma
+
+#endif


Property changes on: trunk/src/items/Dynamite.hh
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/src/items/SimpleItems.cc
===================================================================
--- trunk/src/items/SimpleItems.cc	2009-02-03 23:53:51 UTC (rev 1508)
+++ trunk/src/items/SimpleItems.cc	2009-02-04 00:35:22 UTC (rev 1509)
@@ -116,6 +116,32 @@
     DEF_ITEMTRAITSF(Debris, &quot;it_debris&quot;, it_debris,
                 itf_static | itf_animation | itf_indestructible | itf_fireproof);
     
+/* -------------------- Explosion -------------------- */
+
+    Explosion::Explosion(int strength) {
+        state = strength;
+    }
+    
+    void Explosion::setState(int extState) {
+        // no state writes
+    }
+    
+    void Explosion::animcb() { 
+        Floor *fl = GetFloor(get_pos());
+        if (state != 0 &amp;&amp; fl-&gt;is_destructible())
+            if (state == 1)
+                replace(&quot;it_meditation_hollow&quot;);
+            else if (state == 2)
+                replace(&quot;it_crack_m&quot;);
+            else
+                replace(&quot;it_debris&quot;);
+        else
+            kill();
+     }
+     
+    DEF_ITEMTRAITSF(Explosion, &quot;it_explosion&quot;, it_explosion, itf_static |
+                itf_animation | itf_indestructible | itf_norespawn | itf_fireproof);
+
 /* -------------------- Flag -------------------- */
 
     FlagItem::FlagItem(int type) {
@@ -379,6 +405,10 @@
         BootRegister(new Coffee(), &quot;it_coffee&quot;);
         BootRegister(new DeathItem(), &quot;it_death&quot;);
         BootRegister(new Debris(), &quot;it_debris&quot;);
+        BootRegister(new Explosion(0), &quot;it_explosion_nil&quot;);
+        BootRegister(new Explosion(1), &quot;it_explosion_hollow&quot;);
+        BootRegister(new Explosion(2), &quot;it_explosion_crack&quot;);
+        BootRegister(new Explosion(3), &quot;it_explosion_debris&quot;);
         BootRegister(new FlagItem(0), &quot;it_flag&quot;);
         BootRegister(new FlagItem(0), &quot;it_flag_black&quot;);
         BootRegister(new FlagItem(1), &quot;it_flag_white&quot;);

Modified: trunk/src/items/SimpleItems.hh
===================================================================
--- trunk/src/items/SimpleItems.hh	2009-02-03 23:53:51 UTC (rev 1508)
+++ trunk/src/items/SimpleItems.hh	2009-02-04 00:35:22 UTC (rev 1509)
@@ -112,6 +112,23 @@
     };
 
     /**
+     * Explosion
+     */
+    class Explosion : public Item {
+        CLONEOBJ(Explosion);
+        DECL_ITEMTRAITS;
+
+    public:
+        Explosion(int strength);
+        
+        // StateObject interface
+        virtual void setState(int extState);
+        
+        // ModelCallback interface
+        virtual void animcb();
+    };
+    
+    /**
      * FlagItem
      */
     class FlagItem : public Item {

Modified: trunk/src/items.cc
===================================================================
--- trunk/src/items.cc	2009-02-03 23:53:51 UTC (rev 1508)
+++ trunk/src/items.cc	2009-02-04 00:35:22 UTC (rev 1509)
@@ -30,16 +30,9 @@
 #include &quot;world.hh&quot;
 #include &quot;Inventory.hh&quot;
 #include &quot;ItemHolder.hh&quot;
-#include &quot;lev/Proxy.hh&quot;
-#include &quot;items/GlassesItem.hh&quot;
 
 #include &quot;ecl_util.hh&quot;
 
-#include &lt;algorithm&gt;
-#include &lt;cmath&gt;
-#include &lt;iostream&gt;
-
-
 using namespace std;
 
 using enigma::GridPos;
@@ -102,7 +95,7 @@
 
 void Item::processLight(Direction d) {
     if (get_traits().flags &amp; itf_inflammable) {
-        replace(&quot;it-explosion1&quot;);
+        replace(&quot;it_explosion_nil&quot;);
     } else
         GridObject::processLight(d);
 }
@@ -155,300 +148,5 @@
     }
 }
 
-/* -------------------- Explosion -------------------- */
-namespace
-{
-    class Explosion : public Item {
-    public:
-        Explosion ()
-        {}
 
-    private:
-        void init_model() {set_anim(&quot;expl&quot;);}
-        bool actor_hit(Actor *actor) {
-            SendMessage(actor, &quot;_shatter&quot;);
-            return false;
-        }
-    };
-
-    // Explode but do nothing else.
-    class Explosion1 : public Explosion {
-        CLONEOBJ(Explosion1);
-        DECL_ITEMTRAITS;
-
-        void animcb() {
-            kill();
-        }
-    public:
-        Explosion1()
-        {}
-    };
-    DEF_ITEMTRAITSF(Explosion1, &quot;it-explosion1&quot;, it_explosion1, itf_static |
-                itf_animation | itf_indestructible | itf_norespawn | itf_fireproof);
-
-    // Explode and leave a hole in the ground.
-    class Explosion2 : public Explosion {
-        CLONEOBJ(Explosion2);
-        DECL_ITEMTRAITS;
-
-        void animcb() {
-            if (Floor *fl = GetFloor(get_pos()))
-                if (fl-&gt;is_destructible())
-                    replace(&quot;it_meditation_hollow&quot;);
-                else
-                    kill();
-        }
-    public:
-        Explosion2()
-        {}
-    };
-    DEF_ITEMTRAITSF(Explosion2, &quot;it-explosion2&quot;, it_explosion2, itf_static |
-                itf_animation | itf_indestructible | itf_norespawn | itf_fireproof);
-
-
-    // Explode and shatter the floor.
-    class Explosion3 : public Explosion {
-        CLONEOBJ(Explosion3);
-        DECL_ITEMTRAITS;
-
-        void animcb() {
-            if (Floor *fl = GetFloor(get_pos()))
-                if (fl-&gt;is_destructible())
-                    replace(&quot;it_debris&quot;);
-                else
-                    kill();
-        }
-    public:
-        Explosion3()
-        {}
-    };
-    DEF_ITEMTRAITSF(Explosion3, &quot;it-explosion3&quot;, it_explosion3, itf_static |
-                itf_animation | itf_indestructible | itf_norespawn | itf_fireproof);
-}
-
-
-/* -------------------- Dynamite -------------------- */
-namespace
-{
-    class Dynamite : public Item {
-        CLONEOBJ(Dynamite);
-        DECL_ITEMTRAITS;
-    public:
-        Dynamite() : state(IDLE) {}
-    private:
-        enum State { IDLE, BURNING };
-        State state;
-
-        void change_state(State newstate) {
-            if (newstate==BURNING &amp;&amp; state==IDLE) {
-                state = BURNING;
-                set_anim(&quot;it-dynamite-burning&quot;);
-            }
-        }
-
-        virtual bool isStatic() const {
-            return state == BURNING;  // burning dynamite cannot be picked up
-        }
-
-        void explode () {
-            GridPos p = get_pos();
-            SendExplosionEffect(p, EXPLOSION_DYNAMITE);
-            sound_event (&quot;dynamite&quot;);
-            //SetItem(p, it_explosion2);
-            Floor *fl = GetFloor(p);
-            string model = fl-&gt;get_kind();
-            // SetItem(p, it_explosion2) only used by it-dynamite?
-            // If Yes, the following block could be places in the explosion class:
-            if (model == &quot;fl_space&quot;) {
-                // In space, an it-dynamite explodes to an it-sherd:
-                // HOT FIX
-                //replace(it_sherd);
-                replace(&quot;it_meditation_hollow&quot;);
-            } else if (model == &quot;fl_ice&quot;) {
-                // In ice, an it-dynamite explodes to an it-crack2:
-                replace(&quot;it_crack_m&quot;);
-            } else {
-                SetItem(p, MakeItem(&quot;it-explosion2&quot;));
-            }
-        }
-
-        virtual Value message(const Message &amp;m) {
-            if (m.message == &quot;ignite&quot; || m.message == &quot;_explosion&quot; || m.message == &quot;_bombstone&quot;) {
-                change_state(BURNING);
-                return Value();
-            } else if (m.message == &quot;explode&quot;) { // currently unused in c++ code
-                explode();
-                return Value();
-            } else if (m.message == &quot;heat&quot;) {  // used by fire-system
-                change_state(BURNING);
-                return true;  // caught message -&gt; no fire!
-            }
-            return Item::message(m);
-        }
-        void animcb() { explode(); }
-        void processLight(Direction d) {
-            change_state(BURNING);
-        }
-        void on_drop(Actor *) { change_state(BURNING); }
-    };
-    DEF_ITEMTRAITSF(Dynamite, &quot;it-dynamite&quot;, it_dynamite,
-                itf_indestructible | itf_fireproof);
-}
-
-// ----------------------------
-//      BombBase
-// ----------------------------
-// base class for BlackBomb and WhiteBomb
-
-namespace
-{
-    class BombBase : public Item {
-    public:
-        BombBase (bool burning = false)
-        : m_burning(burning)
-        {}
-
-    protected:
-        virtual Value message(const Message &amp;m) {
-            if (m.message == &quot;ignite&quot;  || m.message == &quot;_explosion&quot;) {
-                burn();
-                return Value();
-            } else if (m.message == &quot;explode&quot; ) {
-                explode();
-                return Value();
-            } else if (m.message == &quot;heat&quot;) {  // used by fire-system
-                burn();
-                return true;  // caught message -&gt; no fire!
-            }
-            return Item::message(m);
-        }
-
-    private:
-        // Variables
-        bool m_burning;
-
-        // Private methods
-        virtual void explode() = 0;
-
-        void init_model() {
-            if (m_burning)
-                set_anim(burn_anim());
-            else
-                Item::init_model();
-        }
-
-        void burn() {
-            if (!m_burning) {
-                m_burning = true;
-                init_model();
-            }
-        }
-
-        void animcb() { explode (); }
-
-        void processLight(Direction d) {
-            explode();
-        }
-
-        void on_stonehit(Stone *st) {
-            switch (server::GameCompatibility) {
-            case GAMET_OXYD1:
-            case GAMET_OXYDMAGNUM:
-                if (!st-&gt;is_kind(&quot;st-wood?&quot;))
-                    // st-wood does not cause bombs to explode
-                    explode();
-                break;
-            default :
-                explode();
-                break;
-            }
-        }
-
-        virtual const char *burn_anim() const = 0;
-    };
-}
-
-/* -------------------- Black Bomb -------------------- */
-
-/** \page it-blackbomb Black Bomb
-
-When black bombs explode, they destroy the floor tile underneath them.
-
-\image html it-blackbomb.png
-*/
-
-namespace
-{
-    class BlackBomb : public BombBase  {
-        CLONEOBJ(BlackBomb);
-        DECL_ITEMTRAITS;
-    public:
-        BlackBomb (bool burning=false)
-        : BombBase(burning)
-        {}
-    private:
-        const char *burn_anim() const { return &quot;it-blackbomb-burning&quot;; }
-        void explode() {
-            GridPos p = get_pos();
-            sound_event (&quot;blackbomb&quot;);
-            replace(&quot;it-explosion3&quot;);
-            SendExplosionEffect(p, EXPLOSION_BLACKBOMB);  // may kill the bomb by another explosion1 set by brake
-        }
-    };
-    DEF_ITEMTRAITSF(BlackBomb, &quot;it-blackbomb&quot;, it_blackbomb,
-                itf_static | itf_indestructible | itf_fireproof);
-
-    class BlackBombBurning : public BlackBomb {
-        CLONEOBJ(BlackBombBurning);
-        DECL_ITEMTRAITS;
-    public:
-        BlackBombBurning() : BlackBomb(true) {}
-    };
-    DEF_ITEMTRAITSF(BlackBombBurning, &quot;it-blackbomb_burning&quot;,
-                it_blackbomb_burning,
-                itf_static | itf_indestructible | itf_norespawn | itf_fireproof);
-}
-
-
-/* -------------------- White bomb -------------------- */
-
-/*! When a white bombs explode, they destroy the floor tile underneath
-them and neighboring floors. */
-
-namespace
-{
-    class WhiteBomb : public BombBase  {
-        CLONEOBJ(WhiteBomb);
-        DECL_ITEMTRAITS;
-
-        const char *burn_anim() const { return &quot;it-whitebomb-burning&quot;; }
-        void explode() {
-            GridPos p = get_pos();
-            sound_event (&quot;whitebomb&quot;);
-            replace(&quot;it-explosion3&quot;);
-            SendExplosionEffect(p, EXPLOSION_WHITEBOMB); // may kill the bomb by another explosion1 set by brake
-        }
-
-    public:
-        WhiteBomb()
-        {}
-    };
-    DEF_ITEMTRAITSF(WhiteBomb, &quot;it-whitebomb&quot;, it_whitebomb,
-                itf_static | itf_indestructible | itf_fireproof);
-}
-
-
-/* -------------------- Functions -------------------- */
-
-void InitItems()
-{
-    RegisterItem (new BlackBomb);
-    RegisterItem (new BlackBombBurning);
-    RegisterItem (new Dynamite);
-    RegisterItem (new Explosion1);
-    RegisterItem (new Explosion2);
-    RegisterItem (new Explosion3);
-    RegisterItem (new WhiteBomb);
-}
-
 } // namespace enigma

Modified: trunk/src/items.hh
===================================================================
--- trunk/src/items.hh	2009-02-03 23:53:51 UTC (rev 1508)
+++ trunk/src/items.hh	2009-02-04 00:35:22 UTC (rev 1509)
@@ -31,8 +31,7 @@
         it_2pkillstone,
         it_bag,
         it_banana,
-        it_blackbomb,
-        it_blackbomb_burning,
+        it_bomb,
         it_blocker,
         it_bottle_idle,
         it_bottle_broken,
@@ -65,9 +64,7 @@
         it_dummy,
         it_easykeepstone,
         it_easykillstone,
-        it_explosion1,
-        it_explosion2,
-        it_explosion3,
+        it_explosion,
         it_exitsensor,
         it_extinguisher,
         it_extinguisher_medium,
@@ -148,7 +145,6 @@
         it_vortex_closed,
         it_vstrip,
         it_weight,
-        it_whitebomb,
         it_wormhole_off,
         it_wormhole_on,
         it_wrench,
@@ -280,8 +276,6 @@
     }
 
 /* -------------------- Functions -------------------- */
-
-    void InitItems();
     
     
 /* --------------------  Item Macros -------------------- */

Modified: trunk/src/ox_extra.cc
===================================================================
--- trunk/src/ox_extra.cc	2009-02-03 23:53:51 UTC (rev 1508)
+++ trunk/src/ox_extra.cc	2009-02-04 00:35:22 UTC (rev 1509)
@@ -318,7 +318,7 @@
     &quot;it_umbrella&quot;,                // OxydExtra item 0x07
     IT_MISSING,                 // OxydExtra item 0x08
     UNUSED,                  // OxydExtra item 0x09
-    &quot;it-dynamite&quot;,                // OxydExtra item 0x0a
+    &quot;it_dynamite&quot;,                // OxydExtra item 0x0a
     UNUSED,                  // OxydExtra item 0x0b
     UNUSED,                  // OxydExtra item 0x0c
     &quot;it_crack_i&quot;,                 // OxydExtra item 0x0d

Modified: trunk/src/ox_magnum.cc
===================================================================
--- trunk/src/ox_magnum.cc	2009-02-03 23:53:51 UTC (rev 1508)
+++ trunk/src/ox_magnum.cc	2009-02-04 00:35:22 UTC (rev 1509)
@@ -220,8 +220,8 @@
     UNUSED,                     // OxydMagnum stone 0x65
     UNUSED,                     // OxydMagnum stone 0x66
     UNUSED,                     // OxydMagnum stone 0x67
-    &quot;st-bombs&quot;,                 // OxydMagnum stone 0x68 (common was 'st-shogun-l')
-    &quot;st-flash&quot;,                 // OxydMagnum stone 0x69
+    &quot;st_dispenser_bombblack&quot;,   // OxydMagnum stone 0x68 (common was 'st-shogun-l')
+    &quot;st_flash&quot;,                 // OxydMagnum stone 0x69
     &quot;st_coinslot_instant&quot;,      // OxydMagnum stone 0x6a
     &quot;st_thief&quot;,                 // OxydMagnum stone 0x6b
     &quot;st_shogun_s&quot;,              // OxydMagnum stone 0x6c
@@ -300,9 +300,9 @@
     &quot;it_umbrella&quot;,      // OxydMagnum item 0x07
     &quot;it_glasses&quot;,       // OxydMagnum item 0x08
     &quot;it_glasses_broken&quot;, // OxydMagnum item 0x09
-    &quot;it-dynamite&quot;,      // OxydMagnum item 0x0a
-    &quot;it-blackbomb&quot;,     // OxydMagnum item 0x0b
-    &quot;it-whitebomb&quot;,     // OxydMagnum item 0x0c
+    &quot;it_dynamite&quot;,      // OxydMagnum item 0x0a
+    &quot;it_bomb_black&quot;,    // OxydMagnum item 0x0b
+    &quot;it_bomb_white&quot;,    // OxydMagnum item 0x0c
     &quot;it_crack_i&quot;,        // OxydMagnum item 0x0d
     &quot;it_crack_s&quot;,        // OxydMagnum item 0x0e
     &quot;it_crack_m&quot;,        // OxydMagnum item 0x0f

Modified: trunk/src/ox_oxyd1.cc
===================================================================
--- trunk/src/ox_oxyd1.cc	2009-02-03 23:53:51 UTC (rev 1508)
+++ trunk/src/ox_oxyd1.cc	2009-02-04 00:35:22 UTC (rev 1509)
@@ -252,8 +252,8 @@
     UNUSED,                     // Oxyd1 stone 0x65
     &quot;st_disco_medium&quot;,          // Oxyd1 stone 0x66
     &quot;st_disco_light&quot;,           // Oxyd1 stone 0x67
-    &quot;st-bombs&quot;,                 // Oxyd1 stone 0x68
-    &quot;st-flash&quot;,                 // Oxyd1 stone 0x69
+    &quot;st_dispenser_bombblack&quot;,   // Oxyd1 stone 0x68
+    &quot;st_flash&quot;,                 // Oxyd1 stone 0x69
     &quot;st_coinslot_instant&quot;,      // Oxyd1 stone 0x6a
     &quot;st_thief&quot;,                 // Oxyd1 stone 0x6b
     &quot;st_shogun_s&quot;,              // Oxyd1 stone 0x6c
@@ -316,9 +316,9 @@
     &quot;it_umbrella&quot;,                // 0x07
     &quot;it_glasses&quot;,                 // 0x08
     &quot;it_glasses_broken&quot;,          // 0x09
-    &quot;it-dynamite&quot;,                // 0x0a
-    &quot;it-blackbomb&quot;,               // 0x0b
-    &quot;it-whitebomb&quot;,               // 0x0c
+    &quot;it_dynamite&quot;,                // 0x0a
+    &quot;it_bomb_black&quot;,              // 0x0b
+    &quot;it_bomb_white&quot;,              // 0x0c
     &quot;it_crack_i&quot;,                 // 0x0d
     &quot;it_crack_s&quot;,                 // 0x0e
     &quot;it_crack_m&quot;,                 // 0x0f

Modified: trunk/src/ox_peroxyd.cc
===================================================================
--- trunk/src/ox_peroxyd.cc	2009-02-03 23:53:51 UTC (rev 1508)
+++ trunk/src/ox_peroxyd.cc	2009-02-04 00:35:22 UTC (rev 1509)
@@ -286,7 +286,7 @@
     &quot;st_shogun&quot;,                // PerOxyd stone 0x5f (oxyd with a hole, movable ... strange stone! st-shogun as workaround, only link level 74)
     &quot;st_disco_dark&quot;,            // PerOxyd stone 0x60
     &quot;st_disco_medium&quot;,          // PerOxyd stone 0x61
-    &quot;st-bombs&quot;,                 // PerOxyd stone 0x62
+    &quot;st_dispenser_bombblack&quot;,   // PerOxyd stone 0x62
     &quot;st_flash&quot;,                 // PerOxyd stone 0x63
     &quot;st_coinslot_instant&quot;,      // PerOxyd stone 0x64
     &quot;st_thief&quot;,                 // PerOxyd stone 0x65
@@ -389,9 +389,9 @@
     &quot;it_umbrella&quot;,                // 0x07
     &quot;it_glasses&quot;,                 // 0x08
     &quot;it_glasses_broken&quot;,          // 0x09
-    &quot;it-dynamite&quot;,                // 0x0a
-    &quot;it-blackbomb&quot;,               // 0x0b
-    &quot;it-whitebomb&quot;,               // 0x0c
+    &quot;it_dynamite&quot;,                // 0x0a
+    &quot;it_bomb_black&quot;,              // 0x0b
+    &quot;it_bomb_white&quot;,              // 0x0c
     &quot;it_crack_i&quot;,                 // 0x0d
     &quot;it_crack_s&quot;,                 // 0x0e
     &quot;it_crack_m&quot;,                 // 0x0f
@@ -485,7 +485,7 @@
     UNUSED,                  // 0x67
     UNUSED,                  // 0x68
     UNUSED,                  // 0x69
-    &quot;it-blackbomb-burning&quot;,       // 0x6a
+    &quot;it_bomb_black_burning&quot;, // 0x6a
     UNUSED,                  // 0x6b
     UNUSED,                  // 0x6c
     UNUSED,                  // 0x6d

Added: trunk/src/stones/DispenserStone.cc
===================================================================
--- trunk/src/stones/DispenserStone.cc	2009-02-03 23:53:51 UTC (rev 1508)
+++ trunk/src/stones/DispenserStone.cc	2009-02-04 00:35:22 UTC (rev 1509)
@@ -0,0 +1,128 @@
+/*
+ * Copyright (C) 2009 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *  
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include &quot;stones/DispenserStone.hh&quot;
+#include &quot;errors.hh&quot;
+#include &quot;Inventory.hh&quot;
+//#include &quot;main.hh&quot;
+#include &quot;player.hh&quot;
+#include &quot;world.hh&quot;
+
+namespace enigma {
+    DispenserStone::DispenserStone(int subtyp) : Stone() {
+        objFlags |= (subtyp &lt;&lt; 24);
+    }
+    
+    std::string DispenserStone::getClass() const {
+        return &quot;st_dispenser&quot;;
+    }
+    
+    Value DispenserStone::getAttr(const std::string &amp;key) const {
+        if (key == &quot;flavor&quot;) {
+            DispenserStoneTyp typ = (DispenserStoneTyp)((objFlags &amp; OBJBIT_SUBTYP) &gt;&gt; 24);
+            switch (typ) {
+                case BOMBBLACK:
+                    return &quot;bombblack&quot;;
+                case BOMBWHITE:
+                    return &quot;bombwhite&quot;;
+                case DYNAMITE:
+                    return &quot;dynamite&quot;;
+            }
+        }
+        return Stone::getAttr(key);
+    }
+
+    Value DispenserStone::message(const Message &amp;m) {
+        if (m.message ==&quot;_explosion&quot; || m.message ==&quot;_bombstone&quot;) {
+            if (isDisplayable())
+                doBreak();
+            return Value();
+        }
+        return Stone::message(m);
+    }
+
+    void DispenserStone::setState(int extState) {
+        // no external states
+    }
+    
+    void DispenserStone::init_model() {
+        std::string base = get_traits().name;
+        if (state == BREAKING)
+            set_anim(base + &quot;_breaking&quot;);
+        else
+            set_model(base);
+    }
+    
+    void DispenserStone::animcb() {
+        GridPos p = get_pos();
+        SendExplosionEffect(p, EXPLOSION_BOMBSTONE);
+        if (Item *it = GetItem(get_pos())) {
+            SendMessage(it, &quot;ignite&quot;);
+        } else
+            SetItem(p, MakeItem(&quot;it_explosion_nil&quot;));
+        KillStone(p);
+    }
+
+    void DispenserStone::actor_hit(const StoneContact &amp;sc) {
+        if (enigma::Inventory *inv = player::GetInventory(sc.actor)) {
+            if (!inv-&gt;is_full()) {
+                DispenserStoneTyp typ = (DispenserStoneTyp)((objFlags &amp; OBJBIT_SUBTYP) &gt;&gt; 24);
+                std::string itemkind;
+                switch (typ) {
+                    case BOMBBLACK:
+                        itemkind = &quot;it_bomb_black&quot;; break;
+                    case BOMBWHITE:
+                        itemkind = &quot;it_bomb_white&quot;; break;
+                    case DYNAMITE:
+                        itemkind = &quot;it_dynamite&quot;; break;
+                    default:
+                        ASSERT(false, XLevelRuntime, &quot;Dispenser - unexpected subtyp&quot;);
+                }
+                inv-&gt;add_item(MakeItem(itemkind.c_str()));
+                player::RedrawInventory(inv);
+            }
+        }
+    }
+    
+    void DispenserStone::doBreak() {
+        if (state == IDLE) {
+            state = BREAKING;
+            sound_event (&quot;stonedestroy&quot;);
+            init_model();
+        }
+    }
+    
+    int DispenserStone::traitsIdx() const {
+        return (objFlags &amp; OBJBIT_SUBTYP) &gt;&gt; 24;
+    }
+
+    StoneTraits DispenserStone::traits[3] = {
+        {&quot;st_dispenser_bombblack&quot;, st_INVALID, stf_none, material_stone, 1.0, MOVABLE_BREAKABLE},
+        {&quot;st_dispenser_bombwhite&quot;, st_INVALID, stf_none, material_stone, 1.0, MOVABLE_BREAKABLE},
+        {&quot;st_dispenser_dynamite&quot;, st_INVALID, stf_none, material_stone, 1.0, MOVABLE_BREAKABLE},
+    };
+
+    BOOT_REGISTER_START
+        BootRegister(new DispenserStone(0), &quot;st_dispenser&quot;);
+        BootRegister(new DispenserStone(0), &quot;st_dispenser_bombblack&quot;);
+        BootRegister(new DispenserStone(1), &quot;st_dispenser_bombwhite&quot;);
+        BootRegister(new DispenserStone(2), &quot;st_dispenser_dynamite&quot;);
+    BOOT_REGISTER_END
+
+} // namespace enigma


Property changes on: trunk/src/stones/DispenserStone.cc
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/src/stones/DispenserStone.hh
===================================================================
--- trunk/src/stones/DispenserStone.hh	2009-02-03 23:53:51 UTC (rev 1508)
+++ trunk/src/stones/DispenserStone.hh	2009-02-04 00:35:22 UTC (rev 1509)
@@ -0,0 +1,78 @@
+/*
+ * Copyright (C) 2009 Ronald Lamprecht
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+#ifndef DISPENSERSTONE_HH
+#define DISPENSERSTONE_HH
+
+#include &quot;stones.hh&quot;
+
+#include &quot;stones_internal.hh&quot;
+
+namespace enigma {
+
+    /** 
+     * 
+     */
+    class DispenserStone : public Stone {
+        CLONEOBJ(DispenserStone);
+        DECL_TRAITS_ARRAY(3, traitsIdx());
+
+    private:
+        enum iState {
+            IDLE,       ///&lt; 
+            BREAKING    ///&lt; 
+        };
+        
+        enum ObjectPrivatFlagsBits {
+            OBJBIT_SUBTYP    =   3&lt;&lt;24,   ///&lt; the item typ
+        };
+        
+        enum DispenserStoneTyp {
+            BOMBBLACK,
+            BOMBWHITE,
+            DYNAMITE
+        };
+    public:
+        DispenserStone(int subtyp);
+        
+        // Object interface
+        virtual std::string getClass() const;
+        virtual Value getAttr(const std::string &amp;key) const;
+        virtual Value message(const Message &amp;m);
+        
+        // StateObject interface
+        virtual void setState(int extState);
+        
+        // GridObject interface
+        virtual void init_model();
+        
+        // ModelCallback interface
+        virtual void animcb();
+        
+        // Stone interface
+        virtual void actor_hit(const StoneContact &amp;sc);
+    
+    private:
+        // Private methods.
+        void doBreak();
+        int traitsIdx() const;
+    };
+
+} // namespace enigma
+
+#endif /*DISPENSERSTONE_HH*/


Property changes on: trunk/src/stones/DispenserStone.hh
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/src/stones/ShogunStone.cc
===================================================================
--- trunk/src/stones/ShogunStone.cc	2009-02-03 23:53:51 UTC (rev 1508)
+++ trunk/src/stones/ShogunStone.cc	2009-02-04 00:35:22 UTC (rev 1509)
@@ -196,7 +196,7 @@
                 if (Item *it = GetItem(newPos)) {
                     ItemID id = get_id(it);
                     if ((server::GameCompatibility != GAMET_OXYD1 &amp;&amp; server::GameCompatibility != GAMET_OXYDMAGNUM) ||
-                            (id != it_cherry &amp;&amp; id != it_blackbomb &amp;&amp; id != it_whitebomb))
+                            (id != it_cherry &amp;&amp; id != it_bomb))
                         it-&gt;on_stonehit(this);
                 }
             }

Modified: trunk/src/stones/SimpleStones.cc
===================================================================
--- trunk/src/stones/SimpleStones.cc	2009-02-03 23:53:51 UTC (rev 1508)
+++ trunk/src/stones/SimpleStones.cc	2009-02-04 00:35:22 UTC (rev 1509)
@@ -25,6 +25,7 @@
 //#include &quot;main.hh&quot;
 #include &quot;player.hh&quot;
 #include &quot;server.hh&quot;
+#include &quot;SoundEffectManager.hh&quot;
 #include &quot;world.hh&quot;
 
 namespace enigma {
@@ -218,7 +219,49 @@
     DEF_TRAITSM(PlopStone, &quot;st_plop&quot;, st_plop, MOVABLE_STANDARD);
 
 
+/* -------------------- Yinyang stone -------------------- */
+    YinyangStone::YinyangStone(int initState) : Stone () {
+        state = initState;
+    }
+    
+    std::string YinyangStone::getClass() const {
+        return &quot;st_yinyang&quot;;
+    }
+    
+    void YinyangStone::setState(int extState) {
+        if (!isDisplayable())
+           state = extState;
+        else if (state == IDLE) {
+            state = extState;
+            init_model();
+        }
+    }
+        
+    void YinyangStone::init_model() {
+        if (state == IDLE)
+            set_model(&quot;st_yinyang&quot;);
+        else
+            set_anim(&quot;st_yinyang-anim&quot;);
+    }
+    
+    void YinyangStone::animcb() {
+        // Switch to other marble
+        player::SwapPlayers();
+        sound::EmitSoundEvent(&quot;switchplayer&quot;, get_pos().center());
+        state = IDLE;
+        init_model();
+    }
+    
+    void YinyangStone::actor_hit(const StoneContact &amp;sc) {
+        if (state == IDLE) {
+            state = ACTIVE;
+            init_model();
+        }
+    }
+    
+    DEF_TRAITSM(YinyangStone, &quot;st_yinyang&quot;, st_yinyang, MOVABLE_STANDARD);
 
+
     BOOT_REGISTER_START
         BootRegister(new BlurStone(0), &quot;st_blur&quot;);
         BootRegister(new BlurStone(0), &quot;st_blur_straight&quot;);
@@ -234,6 +277,8 @@
         BootRegister(new GrateStone(1), &quot;st_grate_framed&quot;);
         BootRegister(new PlopStone(), &quot;st_plop&quot;);
         BootRegister(new PlopStone(), &quot;st_plop_slate&quot;);
+        BootRegister(new YinyangStone(0), &quot;st_yinyang&quot;);
+        BootRegister(new YinyangStone(1), &quot;st_yinyang_active&quot;);
     BOOT_REGISTER_END
 
 } // namespace enigma

Modified: trunk/src/stones/SimpleStones.hh
===================================================================
--- trunk/src/stones/SimpleStones.hh	2009-02-03 23:53:51 UTC (rev 1508)
+++ trunk/src/stones/SimpleStones.hh	2009-02-04 00:35:22 UTC (rev 1509)
@@ -130,7 +130,7 @@
     /** 
      * PlopStone
      */
-   class PlopStone : public Stone {
+    class PlopStone : public Stone {
         CLONEOBJ(PlopStone);
         DECL_TRAITS;
     public:
@@ -144,7 +144,37 @@
         
         // Stone interface
         virtual void on_floor_change();
-   };
+    };
+   
+    /** 
+     * Yinyang 
+     */
+    class YinyangStone : public Stone {
+        CLONEOBJ(YinyangStone);
+        DECL_TRAITS;
+    private:
+        enum iState {
+            IDLE,       ///&lt; 
+            ACTIVE      ///&lt; 
+        };
+    public:
+        YinyangStone(int initState);
+        
+         // Object interface
+        virtual std::string getClass() const;        
+        
+        // StateObject interface
+        virtual void setState(int extState);
+
+        // GridObject interface
+        virtual void init_model();
+        
+        // ModelCallback interface  - Animation callback
+        virtual void animcb();
+
+        // Stone interface
+        virtual void actor_hit(const StoneContact &amp;sc);
+    };
 } // namespace enigma
 
 #endif /*SIMPLESTONES_HH*/

Modified: trunk/src/stones.cc
===================================================================
--- trunk/src/stones.cc	2009-02-03 23:53:51 UTC (rev 1508)
+++ trunk/src/stones.cc	2009-02-04 00:35:22 UTC (rev 1509)
@@ -416,7 +416,5 @@
 
     Register (new SpitterStone);
 
-    // Init stones from stones_simple.cc and stones_complex.cc:
-    Init_simple();
 }
 } // namespace enigma

Modified: trunk/src/stones.hh
===================================================================
--- trunk/src/stones.hh	2009-02-03 23:53:51 UTC (rev 1508)
+++ trunk/src/stones.hh	2009-02-04 00:35:22 UTC (rev 1509)
@@ -106,6 +106,7 @@
         st_camouflage,
         st_polarswitch,
         st_volcano_growing,
+        st_yinyang,
 
         st_LAST,
         st_COUNT = st_LAST

Modified: trunk/src/stones_internal.hh
===================================================================
--- trunk/src/stones_internal.hh	2009-02-03 23:53:51 UTC (rev 1508)
+++ trunk/src/stones_internal.hh	2009-02-04 00:35:22 UTC (rev 1509)
@@ -40,9 +40,7 @@
 
 namespace enigma {
 
-    void Init_simple();
 
-
 /* -------------------- Auxiliary Functions -------------------- */
 
     Direction get_push_direction (const StoneContact &amp;sc);

Deleted: trunk/src/stones_simple.cc
===================================================================
--- trunk/src/stones_simple.cc	2009-02-03 23:53:51 UTC (rev 1508)
+++ trunk/src/stones_simple.cc	2009-02-04 00:35:22 UTC (rev 1509)
@@ -1,109 +0,0 @@
-/*
- * Copyright (C) 2002,2003,2004 Daniel Heck
- *
- * This program is free software; you can redistribute it and/or
- * modify it under the terms of the GNU General Public License
- * as published by the Free Software Foundation; either version 2
- * of the License, or (at your option) any later version.
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- * GNU General Public License for more details.
- *
- * You should have received a copy of the GNU General Public License along
- * with this program; if not, write to the Free Software Foundation, Inc.,
- * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
- *
- */
-
-#include &quot;errors.hh&quot;
-#include &quot;laser.hh&quot;
-#include &quot;server.hh&quot;
-#include &quot;player.hh&quot;
-#include &quot;client.hh&quot;
-#include &quot;main.hh&quot;
-#include &quot;Inventory.hh&quot;
-
-#include &quot;stones_internal.hh&quot;
-
-using namespace std;
-
-namespace enigma {
-
-/* -------------------- BombStone -------------------- */
-
-namespace
-{
-    /*! This stone add a bomb to the player's inventory when touched. */
-    class BombStone : public Stone {
-        CLONEOBJ(BombStone);
-        DECL_TRAITS;
-        const char *collision_sound() {return &quot;stone&quot;;}
-    public:
-        BombStone(const char* kind_, const char* itemkind_) :
-            Stone(kind_), state(IDLE), itemkind(itemkind_) {}
-    private:
-        enum State { IDLE, BREAK };
-        State state;
-        const char* itemkind;
-        void actor_hit (const StoneContact &amp;sc);
-        void change_state (State newstate);
-        void animcb();
-        virtual Value message(const Message &amp;m);
-    };
-}
-DEF_TRAITSM(BombStone, &quot;INVALID&quot;, st_INVALID, MOVABLE_BREAKABLE);
-    
-void BombStone::change_state (State newstate) 
-{
-    if (state == IDLE &amp;&amp; newstate==BREAK) {
-        string model = get_kind();
-        state = newstate;
-        sound_event (&quot;stonedestroy&quot;);
-        set_anim(model + &quot;-anim&quot;);
-    }
-}
-
-void BombStone::animcb() 
-{
-    ASSERT(state == BREAK, XLevelRuntime, &quot;BombStone: animcb called with inconsistent state&quot;);
-    GridPos p = get_pos();
-    SendExplosionEffect(p, EXPLOSION_BOMBSTONE);
-    KillStone(p);
-    if(Item *it = GetItem(get_pos())) {
-        SendMessage(it, &quot;ignite&quot;);
-    } else
-        SetItem(p, MakeItem(&quot;it-explosion1&quot;));
-}
-
-Value BombStone::message(const Message &amp;m) 
-{
-    if (m.message ==&quot;_explosion&quot; || m.message ==&quot;_bombstone&quot;) {
-        change_state(BREAK);
-        return Value();
-    }
-    return Stone::message(m);
-}
-
-void BombStone::actor_hit(const StoneContact &amp;sc) 
-{
-    if (enigma::Inventory *inv = player::GetInventory(sc.actor)) {
-        if (!inv-&gt;is_full()) {
-            Item *it = MakeItem(itemkind);
-            inv-&gt;add_item(it);
-            player::RedrawInventory (inv);
-        }
-    }
-}
-
-/* -------------------- Functions -------------------- */
-
-void Init_simple()
-{
-    Register(new BombStone(&quot;st-bombs&quot;, &quot;it-blackbomb&quot;));
-    //Register(new BombStone(&quot;st-dynamite&quot;, &quot;it-dynamite&quot;));
-    //Register(new BombStone(&quot;st-whitebombs&quot;, &quot;it-whitebomb&quot;));
-}
-
-} // namespace enigma

Modified: trunk/src/world.cc
===================================================================
--- trunk/src/world.cc	2009-02-03 23:53:51 UTC (rev 1508)
+++ trunk/src/world.cc	2009-02-04 00:35:22 UTC (rev 1509)
@@ -1983,8 +1983,14 @@
             SendMessage(stone, &quot;_explosion&quot;, source);
         if (source == dest)  // item and floor handling on explosion center is specific
             return;
-        if (Item  *item  = GetItem(dest)) {
-            if (has_flags(item, itf_indestructible))
+        if (Item *item = GetItem(dest)) {
+            if (item-&gt;getClass() == &quot;it_explosion&quot;) {
+                Item *newExplosion = MakeItem(explosion_item);
+                if ((int)(newExplosion-&gt;getAttr(&quot;state&quot;)) &gt; (int)(item-&gt;getAttr(&quot;state&quot;)))
+                    SetItem(dest, newExplosion);
+                else
+                    DisposeObject(newExplosion);
+            } else if (has_flags(item, itf_indestructible))
                 SendMessage(item, &quot;_explosion&quot;, source);
             else
                 SetItem(dest, MakeItem(explosion_item));
@@ -2016,7 +2022,7 @@
 
             case EXPLOSION_BLACKBOMB:
                 if (direct_neighbor) {
-                    explosion(center, dest, &quot;it-explosion1&quot;);
+                    explosion(center, dest, &quot;it_explosion_nil&quot;);
                 } else {
                     // Note: should not ignite in non-enigma-mode!
                     if (stone) SendMessage(stone, &quot;ignite&quot;);
@@ -2028,7 +2034,7 @@
             case EXPLOSION_WHITEBOMB:
                 // Note: at least in oxyd1 only direct neighbors
                 // explode, and the others not even ignite
-                explosion(center, dest, &quot;it-explosion3&quot;);            
+                explosion(center, dest, &quot;it_explosion_debris&quot;);            
                 break;
     
             case EXPLOSION_BOMBSTONE:
@@ -2388,7 +2394,6 @@
     BootRegister(NULL, NULL, false);
     InitActors();
     InitLasers();
-    InitItems();
     InitStones();
     InitFloors();
 }


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000937.html">[Enigma-game-svn] r1508 - in trunk: data data/levels/lib	doc/reference
</A></li>
	<LI>Next message: <A HREF="000940.html">[Enigma-game-svn] r1509 - incomplete commit message
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#938">[ date ]</a>
              <a href="thread.html#938">[ thread ]</a>
              <a href="subject.html#938">[ subject ]</a>
              <a href="author.html#938">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/enigma-game-svn">More information about the Enigma-game-svn
mailing list</a><br>
</body></html>
